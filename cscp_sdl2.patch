diff -ruN source/src/common.cpp src/common.cpp
--- source/src/common.cpp	2022-04-05 20:50:00
+++ src/common.cpp	2025-04-28 22:36:36
@@ -6,33 +6,23 @@
 
 	[ common ]
 */
-
-#if defined(_USE_QT)
-	#include <string.h>
-	#include <fcntl.h>
-	#if !defined(__WIN32) && !defined(__WIN64)
-		#include <unistd.h>
-	#else
-		#include <io.h>
-		#include <direct.h>
-	#endif
-	#include <sys/types.h>
-	#include <sys/stat.h>
-	#include "csp_logger.h"
-	#include <string>
-	#include <algorithm>
-	#include <cctype>
-	#include <QDir>
-	#include <QFileInfo>
-#elif defined(_WIN32)
-	#include <shlwapi.h>
-	#pragma comment(lib, "shlwapi.lib")
-#else
-	#include <time.h>
-#endif
+#include <string.h>
+#include <fcntl.h>
+#include <unistd.h>
+#include <sys/types.h>
+#include <sys/stat.h>
+#include <climits>
+#include <string>
+#include <algorithm>
+#include <cctype>
+#include <cwchar>
 #include <math.h>
+#if defined(__APPLE__)
+#include <mach-o/dyld.h>
+#endif
 #include "common.h"
 #include "fileio.h"
+#include "fileio.h"
 
 #if defined(__MINGW32__) || defined(__MINGW64__)
 	extern DWORD GetLongPathName(LPCTSTR lpszShortPath, LPTSTR lpszLongPath, DWORD cchBuffer);
@@ -47,6 +37,13 @@
 {
 	// get the initial current path when the software starts
 	get_initial_current_path();
+	
+	cur_time_t cur_time;
+	get_host_time(&cur_time);
+	srand((unsigned int)time(NULL));
+	
+	// initialize profile write buffer
+	MyInitProfileWriteBuffer();
 }
 
 uint32_t DLL_PREFIX EndianToLittle_DWORD(uint32_t x)
@@ -356,7 +353,8 @@
 {
 	va_list ap;
 	va_start(ap, format);
-	int result = vswprintf(buffer, format, ap);
+	// C++17Ê∫ñÊã†: vswprintf„ÅØ„Éê„ÉÉ„Éï„Ç°„Çµ„Ç§„Ç∫ÊåáÂÆö„ÅåÂøÖË¶Å
+	int result = vswprintf(buffer, sizeOfBuffer, format, ap);
 	va_end(ap);
 	return result;
 }
@@ -385,9 +383,9 @@
 void DLL_PREFIX *my_memcpy(void *dst, void *src, size_t len)
 {
 	size_t len1;
-	register size_t len2;
-	register uint32_t s_align = (uint32_t)(((size_t)src) & 0x1f);
-	register uint32_t d_align = (uint32_t)(((size_t)dst) & 0x1f);
+	size_t len2;
+	uint32_t s_align = (uint32_t)(((size_t)src) & 0x1f);
+	uint32_t d_align = (uint32_t)(((size_t)dst) & 0x1f);
 	int i;
 	
 	if(len == 0) return dst;
@@ -718,8 +716,8 @@
 	}
 #else
 	// Using SIMD *with* un-aligned instructions.
-	register uint32_t *s32 = (uint32_t *)src;
-	register uint32_t *d32 = (uint32_t *)dst;
+	uint32_t *s32 = (uint32_t *)src;
+	uint32_t *d32 = (uint32_t *)dst;
 	if(((s_align & 0x07) != 0x0) && ((d_align & 0x07) != 0x0)) { // None align.
 		return memcpy(dst, src, len);
 	}
@@ -838,6 +836,472 @@
 	return result;
 }
 
+// „Éê„ÉÉ„Éï„Ç°„Éô„Éº„Çπ„ÅÆ„Éó„É≠„Éï„Ç°„Ç§„É´Êõ∏„ÅçËæº„ÅøÂÆüË£Ö
+static char* profile_read_buffer = NULL;  // Ë™≠„ÅøËæº„ÅøÁî®„Éê„ÉÉ„Éï„Ç°
+static size_t profile_read_buffer_size = 0;
+static size_t profile_read_buffer_position = 0;
+
+static char* profile_write_buffer = NULL; // Êõ∏„ÅçËæº„ÅøÁî®„Éê„ÉÉ„Éï„Ç°
+static size_t profile_write_buffer_size = 0;
+static size_t profile_write_buffer_position = 0;
+static _TCHAR profile_filename[_MAX_PATH] = {0};
+
+// „Çª„ÇØ„Ç∑„Éß„É≥ÊÉÖÂ†±„ÇíÁÆ°ÁêÜ„Åô„ÇãÊßãÈÄ†‰Ωì
+struct SectionInfo {
+    const char* name;
+    size_t start_pos;
+    size_t end_pos;
+};
+
+void DLL_PREFIX MyInitProfileWriteBuffer()
+{
+#if defined(OSD_RPI) && defined(DEBUG_CONFIG_LOG)
+    if (get_logger() != NULL) {
+        get_logger()->Write("CONFIG", LogNotice, "MyInitProfileWriteBuffer: Initializing profile buffers");
+    }
+#endif
+
+    // 64KB„ÅÆ„Éê„ÉÉ„Éï„Ç°„ÇíÁ¢∫‰øù
+    if (profile_read_buffer == NULL) {
+        profile_read_buffer_size = 65536;
+        profile_read_buffer = new char[profile_read_buffer_size];
+#if defined(OSD_RPI) && defined(DEBUG_CONFIG_LOG)
+        if (get_logger() != NULL) {
+            get_logger()->Write("CONFIG", LogNotice, "MyInitProfileWriteBuffer: Created read buffer (%d bytes)", (int)profile_read_buffer_size);
+        }
+#endif
+    }
+    
+    if (profile_write_buffer == NULL) {
+        profile_write_buffer_size = 65536;
+        profile_write_buffer = new char[profile_write_buffer_size];
+#if defined(OSD_RPI) && defined(DEBUG_CONFIG_LOG)
+        if (get_logger() != NULL) {
+            get_logger()->Write("CONFIG", LogNotice, "MyInitProfileWriteBuffer: Created write buffer (%d bytes)", (int)profile_write_buffer_size);
+        }
+#endif
+    }
+    
+    // „Éê„ÉÉ„Éï„Ç°„ÇíÂàùÊúüÂåñ
+    profile_read_buffer_position = 0;
+    profile_read_buffer[0] = '\0';
+    
+    profile_write_buffer_position = 0;
+    profile_write_buffer[0] = '\0';
+    profile_filename[0] = '\0';
+
+#if defined(OSD_RPI) && defined(DEBUG_CONFIG_LOG)
+    if (get_logger() != NULL) {
+        get_logger()->Write("CONFIG", LogNotice, "MyInitProfileWriteBuffer: Buffers initialized successfully");
+    }
+#endif
+}
+
+// ÊåáÂÆö„Åï„Çå„Åü„Éï„Ç°„Ç§„É´„ÅÆÂÜÖÂÆπ„ÇíË™≠„ÅøËæº„ÅøÁî®„Éê„ÉÉ„Éï„Ç°„Å´Ë™≠„ÅøËæº„ÇÄ
+BOOL DLL_PREFIX LoadProfileFile(LPCTSTR lpFileName)
+{
+    FILEIO* fio = new FILEIO();
+    BOOL result = FALSE;
+    
+#if defined(OSD_RPI) && defined(DEBUG_CONFIG_LOG)
+    if (get_logger() != NULL) {
+        get_logger()->Write("CONFIG", LogNotice, "LoadProfileFile: Loading '%s'", lpFileName);
+    }
+#endif
+    
+    if (fio->Fopen(lpFileName, FILEIO_READ_ASCII)) {
+		// „Éï„Ç°„Ç§„É´„Çµ„Ç§„Ç∫„ÇíÂèñÂæó
+		fio->Fseek(0, FILEIO_SEEK_END);
+		size_t fsize = fio->Ftell();
+		fio->Fseek(0, FILEIO_SEEK_SET);
+
+#if defined(OSD_RPI) && defined(DEBUG_CONFIG_LOG)
+        if (get_logger() != NULL) {
+            get_logger()->Write("CONFIG", LogNotice, "LoadProfileFile: File size = %d bytes", (int)fsize);
+        }
+#endif
+
+		// Ë™≠„ÅøËæº„Åø„Éê„ÉÉ„Éï„Ç°„ÅØÊã°Âºµ„Åó„Å¶ËâØ„ÅÑ(„Åå„ÄÅ„Åó„Å™„ÅÑÊñπ„Åå„ÅÑ„ÅÑ)
+		if(profile_read_buffer_size < fsize) {
+			delete[] profile_read_buffer;
+			profile_read_buffer_size = fsize;
+			profile_read_buffer = new char[profile_read_buffer_size];
+#if defined(OSD_RPI) && defined(DEBUG_CONFIG_LOG)
+            if (get_logger() != NULL) {
+                get_logger()->Write("CONFIG", LogNotice, "LoadProfileFile: Resized buffer to %d bytes", (int)profile_read_buffer_size);
+            }
+#endif
+		}
+
+		fio->Fread(profile_read_buffer, 1, fsize);
+		profile_read_buffer[fsize] = '\0';
+        
+        result = TRUE;
+        fio->Fclose();
+        
+#if defined(OSD_RPI) && defined(DEBUG_CONFIG_LOG)
+        if (get_logger() != NULL) {
+            char preview[101] = {0};
+            strncpy(preview, profile_read_buffer, 100);
+            get_logger()->Write("CONFIG", LogNotice, "LoadProfileFile: Loaded successfully, content preview: %s", preview);
+        }
+#endif
+    } else {
+#if defined(OSD_RPI) && defined(DEBUG_CONFIG_LOG)
+        if (get_logger() != NULL) {
+            get_logger()->Write("CONFIG", LogNotice, "LoadProfileFile: Failed to open file '%s'", lpFileName);
+        }
+#endif
+    }
+    
+    delete fio;
+    return result;
+}
+
+
+// „Éê„ÉÉ„Éï„Ç°„Åã„Çâ1Ë°åË™≠„ÅøËæº„ÇÄ
+char* DLL_PREFIX MyProfileGets(char* line, int size)
+{
+#if defined(OSD_RPI) && defined(DEBUG_CONFIG_LOG)
+    if (get_logger() != NULL) {
+        get_logger()->Write("CONFIG", LogNotice, "MyProfileGets: position=%d, buffer_size=%d", 
+            (int)profile_read_buffer_position, (int)profile_read_buffer_size);
+    }
+#endif
+
+	if(profile_read_buffer_size == 0 || profile_read_buffer_position >= profile_read_buffer_size) {
+#if defined(OSD_RPI) && defined(DEBUG_CONFIG_LOG)
+        if (get_logger() != NULL) {
+            get_logger()->Write("CONFIG", LogNotice, "MyProfileGets: End of buffer reached, returning NULL");
+        }
+#endif
+		return nullptr;
+	}
+	int i = 0;
+	while(profile_read_buffer_position < profile_read_buffer_size) {
+		line[i] = profile_read_buffer[profile_read_buffer_position];
+		profile_read_buffer_position++;
+		i++;
+		if(line[i - 1] == '\n' || line[i - 1] == '\r' || line[i - 1] == '\0') {
+			break;
+		}
+	}
+	line[i] = '\0';
+
+#if defined(OSD_RPI) && defined(DEBUG_CONFIG_LOG)
+    if (get_logger() != NULL) {
+        get_logger()->Write("CONFIG", LogNotice, "MyProfileGets: Read line: '%s', length=%d, new position=%d", 
+            line, i, (int)profile_read_buffer_position);
+    }
+#endif
+
+	return line;
+}
+
+// „Éê„ÉÉ„Éï„Ç°„Å´1Ë°åÊõ∏„Åè
+void DLL_PREFIX MyProfilePrintf(const char* format, ...)
+{
+	char buffer[1024];
+	va_list args;
+	va_start(args, format);
+	vsprintf(buffer, format, args);
+	va_end(args);
+
+	// „Éê„ÉÉ„Éï„Ç°„ÅåË∂≥„Çä„Å™„ÅÑÂ†¥Âêà„ÅØÊõ∏„Åã„Åö„Å´ÁµÇ‰∫Ü(ÊâãÊäú„Åç)
+	if(profile_write_buffer_position + strlen(buffer) >= profile_write_buffer_size) {
+		return;
+	}
+
+	memcpy(profile_write_buffer + profile_write_buffer_position, buffer, strlen(buffer));
+	profile_write_buffer_position += strlen(buffer);
+	profile_write_buffer[profile_write_buffer_position] = '\0';
+}
+
+BOOL DLL_PREFIX MyWritePrivateProfileStringToBuffer(LPCTSTR lpAppName, LPCTSTR lpKeyName, LPCTSTR lpString, LPCTSTR lpFileName)
+{
+	BOOL result = FALSE;
+
+    // „Åæ„Å†„Éê„ÉÉ„Éï„Ç°„ÅåÁ¢∫‰øù„Åï„Çå„Å¶„ÅÑ„Å™„ÅÑÂ†¥Âêà„ÅØÂàùÊúüÂåñ
+    if (profile_read_buffer == NULL || profile_write_buffer == NULL) {
+        MyInitProfileWriteBuffer();
+    }
+    
+    // „Éï„Ç°„Ç§„É´Âêç„Çí‰øùÂ≠ò
+    if (profile_filename[0] == '\0') {
+        my_strcpy_s(profile_filename, _MAX_PATH, lpFileName);
+        // Êó¢Â≠ò„ÅÆ„Éï„Ç°„Ç§„É´„Åå„ÅÇ„ÇãÂ†¥Âêà„ÅØË™≠„ÅøËæº„ÇÄ
+        LoadProfileFile(lpFileName);
+    }
+    
+    // Áï∞„Å™„Çã„Éï„Ç°„Ç§„É´„Å´Êõ∏„ÅçËæº„ÇÇ„ÅÜ„Å®„Åó„ÅüÂ†¥Âêà„ÅØ„ÄÅ„ÅÑ„Å£„Åü„Çì„Éï„É©„ÉÉ„Ç∑„É•„Åó„Å¶Êñ∞„Åó„ÅÑ„Éï„Ç°„Ç§„É´„ÇíË™≠„ÅøËæº„ÇÄ
+    if (strcmp(profile_filename, lpFileName) != 0) {
+        MyWritePrivateProfileFlush(profile_filename);
+        my_strcpy_s(profile_filename, _MAX_PATH, lpFileName);
+        LoadProfileFile(lpFileName);
+    }
+
+	// „Éê„ÉÉ„Éï„Ç°‰ΩçÁΩÆ„ÇíÊàª„Åó„Å¶„ÇÑ„Çã
+	profile_read_buffer_position = 0;
+	profile_write_buffer_position = 0;
+
+	// ÂÖÉ„ÅÆMyWritePrivateProfileString„Å®Âêå„Åò„Çà„ÅÜ„Å™Âá¶ÁêÜ„Å´„Åô„Çã
+	bool in_section = false;
+	char section[1024], line[1024], *equal;
+	my_sprintf_s(section, 1024, "[%s]", lpAppName);
+	while(MyProfileGets(line, 1024) != NULL && strlen(line) > 0) {
+		if(line[strlen(line) - 1] == '\n') {
+			line[strlen(line) - 1] = '\0';
+		}
+		if(!result) {
+			if(line[0] == '[') {
+				if(in_section) {
+					MyProfilePrintf("%s=%s\n", lpKeyName, lpString);
+					result = TRUE;
+				} else if(strcmp(line, section) == 0) {
+					in_section = true;
+				}
+			} else if(in_section && (equal = strstr(line, "=")) != NULL) {
+				*equal = '\0';
+				if(strcmp(line, lpKeyName) == 0) {
+					MyProfilePrintf("%s=%s\n", lpKeyName, lpString);
+					result = TRUE;
+					continue;
+				}
+				*equal = '=';
+			}
+		}
+		MyProfilePrintf("%s\n", line);
+	}
+	if(!result) {
+		if(!in_section) {
+			MyProfilePrintf("[%s]\n", lpAppName);
+		}
+		MyProfilePrintf("%s=%s\n", lpKeyName, lpString);
+		result = TRUE;
+	}
+
+	// write buffer „Çí read buffer „Å´„Ç≥„Éî„Éº
+	// ‰∏ÄÂøú„Çµ„Ç§„Ç∫„ÉÅ„Çß„ÉÉ„ÇØ„Åô„Çã
+	if(profile_read_buffer_size < profile_write_buffer_position) {
+		delete[] profile_read_buffer;
+		profile_read_buffer_size = profile_write_buffer_position + 1;
+		profile_read_buffer = new char[profile_read_buffer_size];
+	}
+
+	memcpy(profile_read_buffer, profile_write_buffer, profile_write_buffer_position);
+	profile_read_buffer[profile_write_buffer_position] = '\0';
+	profile_read_buffer_position = profile_write_buffer_position;
+
+    return TRUE;
+}
+
+BOOL DLL_PREFIX MyWritePrivateProfileFlush(LPCTSTR lpFileName)
+{
+	// Ë™≠„ÅøËæº„Åø„Éê„ÉÉ„Éï„Ç°„ÅåÊõ¥Êñ∞„Åï„Çå„Å¶„ÅÑ„Çã„ÅÆ„Åß„Åù„Çå„ÇíÊõ∏„Åè
+	char tmp_path[_MAX_PATH];
+	my_sprintf_s(tmp_path, _MAX_PATH, "%s.$$$", lpFileName);
+	FILEIO* fio = new FILEIO();
+	if(fio->Fopen(tmp_path, FILEIO_WRITE_ASCII)) {
+		fio->Fwrite(profile_read_buffer, 1, profile_read_buffer_position);
+		fio->Fclose();
+	}
+	delete fio;
+
+	// Êõ∏„ÅçËæº„Åø„Éê„ÉÉ„Éï„Ç°„ÇíËß£Êîæ„Åô„Çã
+	delete[] profile_write_buffer;
+	profile_write_buffer = NULL;
+	profile_write_buffer_size = 0;
+	profile_write_buffer_position = 0;
+
+	// Ë™≠„ÅøËæº„Åø„Éê„ÉÉ„Éï„Ç°„ÇíËß£Êîæ„Åô„Çã
+	delete[] profile_read_buffer;
+	profile_read_buffer = NULL;
+	profile_read_buffer_size = 0;
+	profile_read_buffer_position = 0;
+
+	// „Éï„Ç°„Ç§„É´„ÇíÂâäÈô§„Åó„Å¶„É™„Éç„Éº„É†„Åô„Çã
+	if(FILEIO::IsFileExisting(lpFileName)) {
+		FILEIO::RemoveFile(lpFileName);
+	}
+
+	if(!(FILEIO::RenameFile(tmp_path, lpFileName)))
+	{
+		return FALSE;
+	}
+
+	return TRUE;
+}
+
+// „Éê„ÉÉ„Éï„Ç°„Åã„ÇâINI„Éï„Ç°„Ç§„É´„ÅÆË®≠ÂÆö„ÇíË™≠„ÅøËæº„ÇÄ
+DWORD DLL_PREFIX MyGetPrivateProfileStringFromBuffer(LPCTSTR lpAppName, LPCTSTR lpKeyName, LPCTSTR lpDefault, LPTSTR lpReturnedString, DWORD nSize, LPCTSTR lpFileName)
+{
+    _TCHAR *lpp = (_TCHAR *)lpReturnedString;
+    if(lpDefault != NULL) {
+        my_strcpy_s(lpp, nSize, lpDefault);
+    } else {
+        lpp[0] = '\0';
+    }
+    
+    // „Éá„Éê„ÉÉ„Ç∞„É≠„Ç∞ËøΩÂä†
+#if defined(OSD_RPI) && defined(DEBUG_CONFIG_LOG)
+    if (get_logger() != NULL) {
+        get_logger()->Write("CONFIG", LogNotice, "MyGetPrivateProfileStringFromBuffer - App: %s, Key: %s, Default: %s, File: %s", 
+            lpAppName, lpKeyName, lpDefault ? lpDefault : "NULL", lpFileName);
+    }
+#endif
+    
+    // „Åæ„Å†„Éê„ÉÉ„Éï„Ç°„ÅåÁ¢∫‰øù„Åï„Çå„Å¶„ÅÑ„Å™„ÅÑÂ†¥Âêà„ÅØÂàùÊúüÂåñ„Åó„Å¶Ë™≠„ÅøËæº„ÇÄ
+    if (profile_read_buffer == NULL || profile_filename[0] == '\0') {
+        MyInitProfileWriteBuffer();
+        // „Éá„Éê„ÉÉ„Ç∞„É≠„Ç∞ËøΩÂä†
+#if defined(OSD_RPI) && defined(DEBUG_CONFIG_LOG)
+        if (get_logger() != NULL) {
+            get_logger()->Write("CONFIG", LogNotice, "Initializing profile buffer for reading");
+        }
+#endif
+        // Êó¢Â≠ò„ÅÆ„Éï„Ç°„Ç§„É´„Åå„ÅÇ„ÇãÂ†¥Âêà„ÅØË™≠„ÅøËæº„ÇÄ
+        LoadProfileFile(lpFileName);
+    }
+    
+    // Áï∞„Å™„Çã„Éï„Ç°„Ç§„É´„Åã„ÇâË™≠„ÅøËæº„ÇÇ„ÅÜ„Å®„Åó„ÅüÂ†¥Âêà„ÅØ„ÄÅ„ÅÑ„Å£„Åü„Çì„Éï„É©„ÉÉ„Ç∑„É•„Åó„Å¶Êñ∞„Åó„ÅÑ„Éï„Ç°„Ç§„É´„ÇíË™≠„ÅøËæº„ÇÄ
+    if (profile_filename[0] != '\0' && strcmp(profile_filename, lpFileName) != 0) {
+        // „Éá„Éê„ÉÉ„Ç∞„É≠„Ç∞ËøΩÂä†
+#if defined(OSD_RPI) && defined(DEBUG_CONFIG_LOG)
+        if (get_logger() != NULL) {
+            get_logger()->Write("CONFIG", LogNotice, "Different filename detected. Current: %s, New: %s", 
+                profile_filename, lpFileName);
+        }
+#endif
+        if (profile_write_buffer_position > 0) {
+            MyWritePrivateProfileFlush(profile_filename);
+        }
+        my_strcpy_s(profile_filename, _MAX_PATH, lpFileName);
+        LoadProfileFile(lpFileName);
+    }
+
+    // „Éê„ÉÉ„Éï„Ç°‰ΩçÁΩÆ„ÇíÊàª„Åô
+    size_t backup_position = profile_read_buffer_position;
+    profile_read_buffer_position = 0;
+    
+    // „Éá„Éê„ÉÉ„Ç∞„É≠„Ç∞ËøΩÂä†
+#if defined(OSD_RPI) && defined(DEBUG_CONFIG_LOG)
+    if (get_logger() != NULL) {
+        get_logger()->Write("CONFIG", LogNotice, "Buffer position saved: %d, reset to 0", (int)backup_position);
+        // „Éê„ÉÉ„Éï„Ç°„ÅÆÂÜÖÂÆπ„Çí„É≠„Ç∞„Å´Âá∫ÂäõÔºàÊúÄÂàù„ÅÆ100ÊñáÂ≠óÁ®ãÂ∫¶Ôºâ
+        char preview[101] = {0};
+        if (profile_read_buffer) {
+            strncpy(preview, profile_read_buffer, 100);
+            get_logger()->Write("CONFIG", LogNotice, "Buffer content preview: %s", preview);
+        } else {
+            get_logger()->Write("CONFIG", LogNotice, "Buffer is NULL");
+        }
+    }
+#endif
+    
+    bool in_section = false;
+    char section[1024], line[1024], *equal;
+    my_sprintf_s(section, 1024, "[%s]", lpAppName);
+    
+    // „Éá„Éê„ÉÉ„Ç∞„É≠„Ç∞ËøΩÂä†
+#if defined(OSD_RPI) && defined(DEBUG_CONFIG_LOG)
+    if (get_logger() != NULL) {
+        get_logger()->Write("CONFIG", LogNotice, "Looking for section: %s", section);
+    }
+#endif
+    
+    while(MyProfileGets(line, 1024) != NULL && strlen(line) > 0) {
+        if(line[strlen(line) - 1] == '\n') {
+            line[strlen(line) - 1] = '\0';
+        }
+        
+        // „Éá„Éê„ÉÉ„Ç∞„É≠„Ç∞ËøΩÂä†Ôºà„Åô„Åπ„Å¶„ÅÆË°å„Åß„ÅØ„Å™„ÅèÈáçË¶Å„Å™Ë°å„Å†„Åë„É≠„Ç∞„Å´Âá∫ÂäõÔºâ
+#if defined(OSD_RPI) && defined(DEBUG_CONFIG_LOG)
+        if (get_logger() != NULL && (line[0] == '[' || in_section)) {
+            get_logger()->Write("CONFIG", LogNotice, "Reading line: '%s', in_section: %d, pos: %d", 
+                line, in_section ? 1 : 0, (int)profile_read_buffer_position);
+        }
+#endif
+        
+        if(line[0] == '[') {
+            if(in_section) {
+                // „Éá„Éê„ÉÉ„Ç∞„É≠„Ç∞ËøΩÂä†
+#if defined(OSD_RPI) && defined(DEBUG_CONFIG_LOG)
+                if (get_logger() != NULL) {
+                    get_logger()->Write("CONFIG", LogNotice, "Next section found, breaking search");
+                }
+#endif
+                break;
+            } else if(strcmp(line, section) == 0) {
+                in_section = true;
+                // „Éá„Éê„ÉÉ„Ç∞„É≠„Ç∞ËøΩÂä†
+#if defined(OSD_RPI) && defined(DEBUG_CONFIG_LOG)
+                if (get_logger() != NULL) {
+                    get_logger()->Write("CONFIG", LogNotice, "Section found: %s", section);
+                }
+#endif
+            }
+        } else if(in_section && (equal = strstr(line, "=")) != NULL) {
+            *equal = '\0';
+            // „Éá„Éê„ÉÉ„Ç∞„É≠„Ç∞ËøΩÂä†
+#if defined(OSD_RPI) && defined(DEBUG_CONFIG_LOG)
+            if (get_logger() != NULL) {
+                get_logger()->Write("CONFIG", LogNotice, "Checking key: '%s' vs '%s'", line, lpKeyName);
+            }
+#endif
+            if(strcmp(line, lpKeyName) == 0) {
+                my_strcpy_s(lpp, nSize, equal + 1);
+                // „Éá„Éê„ÉÉ„Ç∞„É≠„Ç∞ËøΩÂä†
+#if defined(OSD_RPI) && defined(DEBUG_CONFIG_LOG)
+                if (get_logger() != NULL) {
+                    get_logger()->Write("CONFIG", LogNotice, "Key found! Value: '%s'", equal + 1);
+                }
+#endif
+                break;
+            }
+        }
+    }
+    
+    // „Éê„ÉÉ„Éï„Ç°‰ΩçÁΩÆ„ÇíÂÖÉ„Å´Êàª„Åô
+    profile_read_buffer_position = backup_position;
+    
+    // „Éá„Éê„ÉÉ„Ç∞„É≠„Ç∞ËøΩÂä†
+#if defined(OSD_RPI) && defined(DEBUG_CONFIG_LOG)
+    if (get_logger() != NULL) {
+        get_logger()->Write("CONFIG", LogNotice, "Restored buffer position to %d, returning value: '%s'", 
+            (int)backup_position, lpp);
+    }
+#endif
+    
+    return strlen(lpp);
+}
+
+// „Éê„ÉÉ„Éï„Ç°„Åã„ÇâÊï¥Êï∞ÂÄ§„ÇíË™≠„ÅøËæº„ÇÄ
+UINT DLL_PREFIX MyGetPrivateProfileIntFromBuffer(LPCTSTR lpAppName, LPCTSTR lpKeyName, INT nDefault, LPCTSTR lpFileName)
+{
+    int i;
+    char sstr[128];
+    char sval[128];
+    std::string s;
+    memset(sstr, 0x00, sizeof(sstr));
+    memset(sval, 0x00, sizeof(sval));
+    snprintf(sval, 128, "%d", nDefault);
+    MyGetPrivateProfileStringFromBuffer(lpAppName, lpKeyName, sval, sstr, 128, lpFileName);
+    s = sstr;
+    
+    if(s.empty()) {
+        i = nDefault;
+    } else {
+        i = strtol(s.c_str(), NULL, 10);
+    }
+    return i;
+}
+
+// „Éê„ÉÉ„Éï„Ç°„Åã„Çâ„Éñ„Éº„É´ÂÄ§„ÇíË™≠„ÅøËæº„ÇÄ
+bool DLL_PREFIX MyGetPrivateProfileBoolFromBuffer(LPCTSTR lpAppName, LPCTSTR lpKeyName, bool bDefault, LPCTSTR lpFileName)
+{
+    return (MyGetPrivateProfileIntFromBuffer(lpAppName, lpKeyName, bDefault ? 1 : 0, lpFileName) != 0);
+}
+
 DWORD DLL_PREFIX MyGetPrivateProfileString(LPCTSTR lpAppName, LPCTSTR lpKeyName, LPCTSTR lpDefault, LPTSTR lpReturnedString, DWORD nSize, LPCTSTR lpFileName)
 {
 	_TCHAR *lpp = (_TCHAR *)lpReturnedString;
@@ -1018,19 +1482,53 @@
 			my_tcscpy_s(app_path, _MAX_PATH, _T(".\\"));
 		}
 #else
-#if defined(Q_OS_WIN)
-		std::string delim = "\\";
+#if defined(__APPLE__)
+		char exe_path[PATH_MAX];
+		uint32_t size = sizeof(exe_path);
+		if (_NSGetExecutablePath(exe_path, &size) == 0) {
+			char *dir = strrchr(exe_path, '/');
+			if (dir) *(dir + 1) = '\0';
+			strncpy(app_path, exe_path, _MAX_PATH - 1);
+		} else {
+			if (getcwd(app_path, _MAX_PATH - 2)) {
+				size_t len = strlen(app_path);
+				if (app_path[len - 1] != '/')
+					strcat(app_path, "/");
+			} else {
+				strcpy(app_path, "./");
+			}
+		}
+#elif defined(__linux__)
+		char exe_path[PATH_MAX];
+		ssize_t len = readlink("/proc/self/exe", exe_path, sizeof(exe_path) - 1);
+		if (len != -1) {
+			exe_path[len] = '\0';
+			char *dir = strrchr(exe_path, '/');
+			if (dir) *(dir + 1) = '\0';
+			strncpy(app_path, exe_path, _MAX_PATH - 1);
+		} else {
+			if (getcwd(app_path, _MAX_PATH - 2)) {
+				size_t len2 = strlen(app_path);
+				if (app_path[len2 - 1] != '/')
+					strcat(app_path, "/");
+			} else {
+				strcpy(app_path, "./");
+			}
+		}
+#elif defined(OSD_RPI)
+		// Raspberry Pi / CircleÁí∞Â¢É„Åß„ÅØ/sd„ÅåSD„Ç´„Éº„Éâ„ÅÆ„É´„Éº„Éà
+		strcpy(app_path, "/");
 #else
-		std::string delim = "/";
+		if (getcwd(app_path, _MAX_PATH - 2)) {
+			size_t len = strlen(app_path);
+			if (app_path[len - 1] != '/')
+				strcat(app_path, "/");
+		} else {
+			strcpy(app_path, "./");
+		}
 #endif
-		std::string csppath = cpp_homedir + "CommonSourceCodeProject" + delim ;
-		_my_mkdir(csppath);
-		
-		std::string cpath = csppath + my_procname + delim;
-		_my_mkdir(cpath);
-		strncpy(app_path, cpath.c_str(), _MAX_PATH - 1);
-#endif
 		initialized = true;
+#endif
 	}
 	return (const _TCHAR *)app_path;
 }
diff -ruN source/src/common.h src/common.h
--- source/src/common.h	2025-04-28 16:00:00
+++ src/common.h	2025-04-28 22:36:36
@@ -10,6 +10,12 @@
 #ifndef _COMMON_H_
 #define _COMMON_H_
 
+#if defined(__LP64__) || defined(_WIN64) || (defined(__x86_64__) && !defined(__ILP32__)) || defined(_M_X64) || defined(__aarch64__)
+    #define ENV64BIT
+#else
+    #define ENV32BIT
+#endif
+
 // move shared codes to DLL???
 //#ifdef _USE_QT
 //	#define USE_SHARED_DLL
@@ -39,8 +45,6 @@
 		#if _MSC_VER >= 1400
 			// Microsoft Visual C++ 8.0 (2005) or later
 			#define SUPPORT_SECURE_FUNCTIONS
-			#pragma warning( disable : 4244 )
-			#pragma warning( disable : 4309 )
 			#pragma warning( disable : 4819 )
 			//#pragma warning( disable : 4995 )
 			#pragma warning( disable : 4996 )
@@ -109,7 +113,9 @@
 #include <stdio.h>
 #include <stdlib.h>
 #include <string.h>
+#ifdef _WIN32
 #include <io.h>
+#endif
 #include <math.h>
 #ifdef _MSC_VER
 	#if _MSC_VER < 1920
@@ -119,7 +125,15 @@
 	#endif
 #else
 	#include <typeinfo>
+	#include <strings.h> // for strcasecmp, strncasecmp
 #endif
+
+// ARM aarch64-none-elfÁí∞Â¢É„Åß„ÅØcmath„ÅØ‰ΩøÁî®„Åó„Å™„ÅÑ
+#if !defined(__aarch64__) || !defined(__GNUC__)
+	// Remove cmath include
+	// #include <cmath>
+#endif
+
 #include <assert.h>
 #include <errno.h>
 
@@ -813,7 +827,7 @@
 		#define _fgetts fgets
 	#endif
 	#ifndef _ftprintf
-		#define _ftprintf printf
+		#define _ftprintf fprintf
 	#endif
 	#ifndef _tfopen
 		#define _tfopen fopen
@@ -941,25 +955,45 @@
 	#define my_isfinite _finite
 	#define my_log2(v) (log((double)(v)) / log(2.0))
 #else
-	#include <cmath>
-	#define my_isfinite std::isfinite
-	#define my_log2 log2
+	#ifdef __aarch64__
+		// ARMÁí∞Â¢ÉÁî®„ÅÆmy_isfinite„Å®my_log2„ÅÆÂÆüË£Ö
+		#define my_isfinite(x) (isfinite(x))
+		#define my_log2(v) (log((double)(v)) / log(2.0))
+	#else
+		#include <cmath>
+		#define my_isfinite std::isfinite
+		#define my_log2 log2
+	#endif
 #endif
 
 // win32 api
 #ifndef _WIN32
 	BOOL MyWritePrivateProfileString(LPCTSTR lpAppName, LPCTSTR lpKeyName, LPCTSTR lpString, LPCTSTR lpFileName);
+	void MyInitProfileWriteBuffer();
+	BOOL MyWritePrivateProfileStringToBuffer(LPCTSTR lpAppName, LPCTSTR lpKeyName, LPCTSTR lpString, LPCTSTR lpFileName);
+	BOOL MyWritePrivateProfileFlush(LPCTSTR lpFileName);
 	DWORD MyGetPrivateProfileString(LPCTSTR lpAppName, LPCTSTR lpKeyName, LPCTSTR lpDefault, LPTSTR lpReturnedString, DWORD nSize, LPCTSTR lpFileName);
 	UINT MyGetPrivateProfileInt(LPCTSTR lpAppName, LPCTSTR lpKeyName, INT nDefault, LPCTSTR lpFileName);
+	DWORD MyGetPrivateProfileStringFromBuffer(LPCTSTR lpAppName, LPCTSTR lpKeyName, LPCTSTR lpDefault, LPTSTR lpReturnedString, DWORD nSize, LPCTSTR lpFileName);
+	UINT MyGetPrivateProfileIntFromBuffer(LPCTSTR lpAppName, LPCTSTR lpKeyName, INT nDefault, LPCTSTR lpFileName);
+	bool MyGetPrivateProfileBoolFromBuffer(LPCTSTR lpAppName, LPCTSTR lpKeyName, bool bDefault, LPCTSTR lpFileName);
 	// used only in winmain and win32 osd class
 //	#define ZeroMemory(p,s) memset(p,0x00,s)
 //	#define CopyMemory(t,f,s) memcpy(t,f,s)
 #else
 	#define MyWritePrivateProfileString WritePrivateProfileString
+	#define MyInitProfileWriteBuffer()
+	#define MyWritePrivateProfileStringToBuffer(a,k,s,f) WritePrivateProfileString(a,k,s,f)
+	#define MyWritePrivateProfileFlush(f) TRUE
 	#define MyGetPrivateProfileString GetPrivateProfileString
 	#define MyGetPrivateProfileInt GetPrivateProfileInt
+	#define MyGetPrivateProfileStringFromBuffer GetPrivateProfileString
+	#define MyGetPrivateProfileIntFromBuffer GetPrivateProfileInt
+	#define MyGetPrivateProfileBoolFromBuffer(a,k,d,f) (GetPrivateProfileInt(a,k,(d?1:0),f) != 0)
 #endif
 
+#define _RGB565
+
 // rgb color
 #if !defined(_RGB555) && !defined(_RGB565) && !defined(_RGB888)
 	#define _RGB888
@@ -1072,7 +1106,7 @@
 #define dll_cur_time_t DLL_PREFIX_I struct cur_time_s
 
 typedef DLL_PREFIX struct cur_time_s {
-	int year, month, day, day_of_week, hour, minute, second;
+	int32_t year, month, day, day_of_week, hour, minute, second;
 	bool initialized;
 	cur_time_s()
 	{
@@ -1097,5 +1131,7 @@
 const _TCHAR *DLL_PREFIX get_symbol(symbol_t *first_symbol, uint32_t addr);
 const _TCHAR *DLL_PREFIX get_value_or_symbol(symbol_t *first_symbol, const _TCHAR *format, uint32_t addr);
 const _TCHAR *DLL_PREFIX get_value_and_symbol(symbol_t *first_symbol, const _TCHAR *format, uint32_t addr);
+
+BOOL DLL_PREFIX LoadProfileFile(LPCTSTR lpFileName);
 
 #endif
diff -ruN source/src/config.cpp src/config.cpp
--- source/src/config.cpp	2022-12-31 17:10:00
+++ src/config.cpp	2025-04-28 22:36:36
@@ -18,6 +18,11 @@
 #define CONFIG_NAME "conf"
 #endif
 
+extern "C" config_t* get_config()
+{
+	return &config;
+}
+
 BOOL MyWritePrivateProfileInt(LPCTSTR lpAppName, LPCTSTR lpKeyName, int Value, LPCTSTR lpFileName)
 {
 	return MyWritePrivateProfileString(lpAppName, lpKeyName, create_string(_T("%d"), Value), lpFileName);
@@ -28,11 +33,23 @@
 	return MyWritePrivateProfileString(lpAppName, lpKeyName, create_string(_T("%d"), Value ? 1 : 0), lpFileName);
 }
 
+// ‰ª•‰∏ã„ÅØ„Éê„ÉÉ„Éï„Ç°Áâà„ÅÆÊõ∏„ÅçËæº„ÅøÈñ¢Êï∞
+BOOL MyWritePrivateProfileIntToBuffer(LPCTSTR lpAppName, LPCTSTR lpKeyName, int Value, LPCTSTR lpFileName)
+{
+	return MyWritePrivateProfileStringToBuffer(lpAppName, lpKeyName, create_string(_T("%d"), Value), lpFileName);
+}
+
+BOOL MyWritePrivateProfileBoolToBuffer(LPCTSTR lpAppName, LPCTSTR lpKeyName, bool Value, LPCTSTR lpFileName)
+{
+	return MyWritePrivateProfileStringToBuffer(lpAppName, lpKeyName, create_string(_T("%d"), Value ? 1 : 0), lpFileName);
+}
+
 bool MyGetPrivateProfileBool(LPCTSTR lpAppName, LPCTSTR lpKeyName, bool bDefault, LPCTSTR lpFileName)
 {
 	return (MyGetPrivateProfileInt(lpAppName, lpKeyName, bDefault ? 1 : 0, lpFileName) != 0);
 }
 
+
 void initialize_config()
 {
 	// initial settings
@@ -157,141 +174,150 @@
 		config.render_minor_version = 1;
 		config.rendering_type = CONFIG_RENDER_TYPE_STD;
 	#endif
+
+	#ifdef USE_FLOPPY_DISK
+		for(int drv = 0; drv < USE_FLOPPY_DISK; drv++) {
+			config.current_floppy_disk_path[drv][0] = '\0';
+		}
+	#endif
 }
 
 void load_config(const _TCHAR* config_path)
 {
 	// initial settings
 	initialize_config();
-	
+
+	// Êõ∏„Åã„Å™„ÅÑ„Åë„Å©Âøµ„ÅÆÁÇ∫
+	MyInitProfileWriteBuffer();
+
 	// control
 	#ifdef USE_BOOT_MODE
-		config.boot_mode = MyGetPrivateProfileInt(_T("Control"), _T("BootMode"), config.boot_mode, config_path);
+		config.boot_mode = MyGetPrivateProfileIntFromBuffer(_T("Control"), _T("BootMode"), config.boot_mode, config_path);
 	#endif
 	#ifdef USE_CPU_TYPE
-		config.cpu_type = MyGetPrivateProfileInt(_T("Control"), _T("CPUType"), config.cpu_type, config_path);
+		config.cpu_type = MyGetPrivateProfileIntFromBuffer(_T("Control"), _T("CPUType"), config.cpu_type, config_path);
 	#endif
 	#ifdef USE_DIPSWITCH
-		config.dipswitch = MyGetPrivateProfileInt(_T("Control"), _T("DipSwitch"), config.dipswitch, config_path);
+		config.dipswitch = MyGetPrivateProfileIntFromBuffer(_T("Control"), _T("DipSwitch"), config.dipswitch, config_path);
 	#endif
 	#ifdef USE_DEVICE_TYPE
-		config.device_type = MyGetPrivateProfileInt(_T("Control"), _T("DeviceType"), config.device_type, config_path);
+		config.device_type = MyGetPrivateProfileIntFromBuffer(_T("Control"), _T("DeviceType"), config.device_type, config_path);
 	#endif
 	#ifdef USE_DRIVE_TYPE
-		config.drive_type = MyGetPrivateProfileInt(_T("Control"), _T("DriveType"), config.drive_type, config_path);
+		config.drive_type = MyGetPrivateProfileIntFromBuffer(_T("Control"), _T("DriveType"), config.drive_type, config_path);
 	#endif
 	#ifdef USE_KEYBOARD_TYPE
-		config.keyboard_type = MyGetPrivateProfileInt(_T("Control"), _T("KeyboardType"), config.keyboard_type, config_path);
+		config.keyboard_type = MyGetPrivateProfileIntFromBuffer(_T("Control"), _T("KeyboardType"), config.keyboard_type, config_path);
 	#endif
 	#ifdef USE_MOUSE_TYPE
-		config.mouse_type = MyGetPrivateProfileInt(_T("Control"), _T("MouseType"), config.mouse_type, config_path);
+		config.mouse_type = MyGetPrivateProfileIntFromBuffer(_T("Control"), _T("MouseType"), config.mouse_type, config_path);
 	#endif
 	#ifdef USE_JOYSTICK_TYPE
-		config.joystick_type = MyGetPrivateProfileInt(_T("Control"), _T("JoystickType"), config.joystick_type, config_path);
+		config.joystick_type = MyGetPrivateProfileIntFromBuffer(_T("Control"), _T("JoystickType"), config.joystick_type, config_path);
 	#endif
 	#ifdef USE_SOUND_TYPE
-		config.sound_type = MyGetPrivateProfileInt(_T("Control"), _T("SoundType"), config.sound_type, config_path);
+		config.sound_type = MyGetPrivateProfileIntFromBuffer(_T("Control"), _T("SoundType"), config.sound_type, config_path);
 	#endif
 	#ifdef USE_MONITOR_TYPE
-		config.monitor_type = MyGetPrivateProfileInt(_T("Control"), _T("MonitorType"), config.monitor_type, config_path);
+		config.monitor_type = MyGetPrivateProfileIntFromBuffer(_T("Control"), _T("MonitorType"), config.monitor_type, config_path);
 	#endif
 	#ifdef USE_SCANLINE
-		config.scan_line = MyGetPrivateProfileBool(_T("Control"), _T("ScanLine"), config.scan_line, config_path);
-		config.scan_line_auto = MyGetPrivateProfileBool(_T("Control"), _T("ScanLineAuto"), config.scan_line_auto, config_path);
+		config.scan_line = MyGetPrivateProfileBoolFromBuffer(_T("Control"), _T("ScanLine"), config.scan_line, config_path);
+		config.scan_line_auto = MyGetPrivateProfileBoolFromBuffer(_T("Control"), _T("ScanLineAuto"), config.scan_line_auto, config_path);
 	#endif
 	#ifdef USE_PRINTER_TYPE
-		config.printer_type = MyGetPrivateProfileInt(_T("Control"), _T("PrinterType"), config.printer_type, config_path);
+		config.printer_type = MyGetPrivateProfileIntFromBuffer(_T("Control"), _T("PrinterType"), config.printer_type, config_path);
 	#endif
 	#ifdef USE_SERIAL_TYPE
-		config.serial_type = MyGetPrivateProfileInt(_T("Control"), _T("SerialType"), config.serial_type, config_path);
+		config.serial_type = MyGetPrivateProfileIntFromBuffer(_T("Control"), _T("SerialType"), config.serial_type, config_path);
 	#endif
 	#ifdef USE_FLOPPY_DISK
 		for(int drv = 0; drv < USE_FLOPPY_DISK; drv++) {
-			config.correct_disk_timing[drv] = MyGetPrivateProfileBool(_T("Control"), create_string(_T("CorrectDiskTiming%d"), drv + 1), config.correct_disk_timing[drv], config_path);
-			config.ignore_disk_crc[drv] = MyGetPrivateProfileBool(_T("Control"), create_string(_T("IgnoreDiskCRC%d"), drv + 1), config.ignore_disk_crc[drv], config_path);
+			config.correct_disk_timing[drv] = MyGetPrivateProfileBoolFromBuffer(_T("Control"), create_string(_T("CorrectDiskTiming%d"), drv + 1), config.correct_disk_timing[drv], config_path);
+			config.ignore_disk_crc[drv] = MyGetPrivateProfileBoolFromBuffer(_T("Control"), create_string(_T("IgnoreDiskCRC%d"), drv + 1), config.ignore_disk_crc[drv], config_path);
 		}
 	#endif
 	#ifdef USE_TAPE
 		for(int drv = 0; drv < USE_TAPE; drv++) {
-			config.wave_shaper[drv] = MyGetPrivateProfileBool(_T("Control"), create_string(_T("WaveShaper%d"), drv + 1), config.wave_shaper[drv], config_path);
-			config.direct_load_mzt[drv] = MyGetPrivateProfileBool(_T("Control"), create_string(_T("DirectLoadMZT%d"), drv + 1), config.direct_load_mzt[drv], config_path);
-			config.baud_high[drv] = MyGetPrivateProfileBool(_T("Control"), create_string(_T("BaudHigh%d"), drv + 1), config.baud_high[drv], config_path);
+			config.wave_shaper[drv] = MyGetPrivateProfileBoolFromBuffer(_T("Control"), create_string(_T("WaveShaper%d"), drv + 1), config.wave_shaper[drv], config_path);
+			config.direct_load_mzt[drv] = MyGetPrivateProfileBoolFromBuffer(_T("Control"), create_string(_T("DirectLoadMZT%d"), drv + 1), config.direct_load_mzt[drv], config_path);
+			config.baud_high[drv] = MyGetPrivateProfileBoolFromBuffer(_T("Control"), create_string(_T("BaudHigh%d"), drv + 1), config.baud_high[drv], config_path);
 		}
 	#endif
-	config.compress_state = MyGetPrivateProfileBool(_T("Control"), _T("CompressState"), config.compress_state, config_path);
-	config.drive_vm_in_opecode = MyGetPrivateProfileBool(_T("Control"), _T("DriveVMInOpecode"), config.drive_vm_in_opecode, config_path);
+	config.compress_state = MyGetPrivateProfileBoolFromBuffer(_T("Control"), _T("CompressState"), config.compress_state, config_path);
+	config.drive_vm_in_opecode = MyGetPrivateProfileBoolFromBuffer(_T("Control"), _T("DriveVMInOpecode"), config.drive_vm_in_opecode, config_path);
 	
 	// recent files
 	#ifdef USE_CART
-		MyGetPrivateProfileString(_T("RecentFiles"), _T("InitialCartDir"), _T(""), config.initial_cart_dir, _MAX_PATH, config_path);
+		MyGetPrivateProfileStringFromBuffer(_T("RecentFiles"), _T("InitialCartDir"), _T(""), config.initial_cart_dir, _MAX_PATH, config_path);
 		for(int drv = 0; drv < USE_CART; drv++) {
 			for(int i = 0; i < MAX_HISTORY; i++) {
-				MyGetPrivateProfileString(_T("RecentFiles"), create_string(_T("RecentCartPath%d_%d"), drv + 1, i + 1), _T(""), config.recent_cart_path[drv][i], _MAX_PATH, config_path);
+				MyGetPrivateProfileStringFromBuffer(_T("RecentFiles"), create_string(_T("RecentCartPath%d_%d"), drv + 1, i + 1), _T(""), config.recent_cart_path[drv][i], _MAX_PATH, config_path);
 			}
 		}
 	#endif
 	#ifdef USE_FLOPPY_DISK
-		MyGetPrivateProfileString(_T("RecentFiles"), _T("InitialDiskDir"), _T(""), config.initial_floppy_disk_dir, _MAX_PATH, config_path);
+		MyGetPrivateProfileStringFromBuffer(_T("RecentFiles"), _T("InitialDiskDir"), _T(""), config.initial_floppy_disk_dir, _MAX_PATH, config_path);
 		for(int drv = 0; drv < USE_FLOPPY_DISK; drv++) {
 			for(int i = 0; i < MAX_HISTORY; i++) {
-				MyGetPrivateProfileString(_T("RecentFiles"), create_string(_T("RecentDiskPath%d_%d"), drv + 1, i + 1), _T(""), config.recent_floppy_disk_path[drv][i], _MAX_PATH, config_path);
+				MyGetPrivateProfileStringFromBuffer(_T("RecentFiles"), create_string(_T("RecentDiskPath%d_%d"), drv + 1, i + 1), _T(""), config.recent_floppy_disk_path[drv][i], _MAX_PATH, config_path);
 			}
 		}
 	#endif
 	#ifdef USE_QUICK_DISK
-		MyGetPrivateProfileString(_T("RecentFiles"), _T("InitialQuickDiskDir"), _T(""), config.initial_quick_disk_dir, _MAX_PATH, config_path);
+		MyGetPrivateProfileStringFromBuffer(_T("RecentFiles"), _T("InitialQuickDiskDir"), _T(""), config.initial_quick_disk_dir, _MAX_PATH, config_path);
 		for(int drv = 0; drv < USE_QUICK_DISK; drv++) {
 			for(int i = 0; i < MAX_HISTORY; i++) {
-				MyGetPrivateProfileString(_T("RecentFiles"), create_string(_T("RecentQuickDiskPath%d_%d"), drv + 1, i + 1), _T(""), config.recent_quick_disk_path[drv][i], _MAX_PATH, config_path);
+				MyGetPrivateProfileStringFromBuffer(_T("RecentFiles"), create_string(_T("RecentQuickDiskPath%d_%d"), drv + 1, i + 1), _T(""), config.recent_quick_disk_path[drv][i], _MAX_PATH, config_path);
 			}
 		}
 	#endif
 	#ifdef USE_HARD_DISK
-		MyGetPrivateProfileString(_T("RecentFiles"), _T("InitialHardDiskDir"), _T(""), config.initial_hard_disk_dir, _MAX_PATH, config_path);
+		MyGetPrivateProfileStringFromBuffer(_T("RecentFiles"), _T("InitialHardDiskDir"), _T(""), config.initial_hard_disk_dir, _MAX_PATH, config_path);
 		for(int drv = 0; drv < USE_HARD_DISK; drv++) {
 			for(int i = 0; i < MAX_HISTORY; i++) {
-				MyGetPrivateProfileString(_T("RecentFiles"), create_string(_T("RecentHardDiskPath%d_%d"), drv + 1, i + 1), _T(""), config.recent_hard_disk_path[drv][i], _MAX_PATH, config_path);
+				MyGetPrivateProfileStringFromBuffer(_T("RecentFiles"), create_string(_T("RecentHardDiskPath%d_%d"), drv + 1, i + 1), _T(""), config.recent_hard_disk_path[drv][i], _MAX_PATH, config_path);
 			}
-			MyGetPrivateProfileString(_T("RecentFiles"), create_string(_T("LastHardDiskPath%d"), drv + 1), _T(""), config.last_hard_disk_path[drv], _MAX_PATH, config_path);
+			MyGetPrivateProfileStringFromBuffer(_T("RecentFiles"), create_string(_T("LastHardDiskPath%d"), drv + 1), _T(""), config.last_hard_disk_path[drv], _MAX_PATH, config_path);
 		}
 	#endif
 	#ifdef USE_TAPE
-		MyGetPrivateProfileString(_T("RecentFiles"), _T("InitialTapeDir"), _T(""), config.initial_tape_dir, _MAX_PATH, config_path);
+		MyGetPrivateProfileStringFromBuffer(_T("RecentFiles"), _T("InitialTapeDir"), _T(""), config.initial_tape_dir, _MAX_PATH, config_path);
 		for(int drv = 0; drv < USE_TAPE; drv++) {
 			for(int i = 0; i < MAX_HISTORY; i++) {
-				MyGetPrivateProfileString(_T("RecentFiles"), create_string(_T("RecentTapePath%d_%d"), drv + 1, i + 1), _T(""), config.recent_tape_path[drv][i], _MAX_PATH, config_path);
+				MyGetPrivateProfileStringFromBuffer(_T("RecentFiles"), create_string(_T("RecentTapePath%d_%d"), drv + 1, i + 1), _T(""), config.recent_tape_path[drv][i], _MAX_PATH, config_path);
 			}
 		}
 	#endif
 	#ifdef USE_COMPACT_DISC
-		MyGetPrivateProfileString(_T("RecentFiles"), _T("InitialCompactDiscDir"), _T(""), config.initial_compact_disc_dir, _MAX_PATH, config_path);
+		MyGetPrivateProfileStringFromBuffer(_T("RecentFiles"), _T("InitialCompactDiscDir"), _T(""), config.initial_compact_disc_dir, _MAX_PATH, config_path);
 		for(int drv = 0; drv < USE_COMPACT_DISC; drv++) {
 			for(int i = 0; i < MAX_HISTORY; i++) {
-				MyGetPrivateProfileString(_T("RecentFiles"), create_string(_T("RecentCompactDiscPath%d_%d"), drv + 1, i + 1), _T(""), config.recent_compact_disc_path[drv][i], _MAX_PATH, config_path);
+				MyGetPrivateProfileStringFromBuffer(_T("RecentFiles"), create_string(_T("RecentCompactDiscPath%d_%d"), drv + 1, i + 1), _T(""), config.recent_compact_disc_path[drv][i], _MAX_PATH, config_path);
 			}
 		}
 	#endif
 	#ifdef USE_LASER_DISC
-		MyGetPrivateProfileString(_T("RecentFiles"), _T("InitialLaserDiscDir"), _T(""), config.initial_laser_disc_dir, _MAX_PATH, config_path);
+		MyGetPrivateProfileStringFromBuffer(_T("RecentFiles"), _T("InitialLaserDiscDir"), _T(""), config.initial_laser_disc_dir, _MAX_PATH, config_path);
 		for(int drv = 0; drv < USE_LASER_DISC; drv++) {
 			for(int i = 0; i < MAX_HISTORY; i++) {
-				MyGetPrivateProfileString(_T("RecentFiles"), create_string(_T("RecentLaserDiscPath%d_%d"), drv + 1, i + 1), _T(""), config.recent_laser_disc_path[drv][i], _MAX_PATH, config_path);
+				MyGetPrivateProfileStringFromBuffer(_T("RecentFiles"), create_string(_T("RecentLaserDiscPath%d_%d"), drv + 1, i + 1), _T(""), config.recent_laser_disc_path[drv][i], _MAX_PATH, config_path);
 			}
 		}
 	#endif
 	#ifdef USE_BINARY_FILE
-		MyGetPrivateProfileString(_T("RecentFiles"), _T("InitialBinaryDir"), _T(""), config.initial_binary_dir, _MAX_PATH, config_path);
+		MyGetPrivateProfileStringFromBuffer(_T("RecentFiles"), _T("InitialBinaryDir"), _T(""), config.initial_binary_dir, _MAX_PATH, config_path);
 		for(int drv = 0; drv < USE_BINARY_FILE; drv++) {
 			for(int i = 0; i < MAX_HISTORY; i++) {
-				MyGetPrivateProfileString(_T("RecentFiles"), create_string(_T("RecentBinaryPath%d_%d"), drv + 1, i + 1), _T(""), config.recent_binary_path[drv][i], _MAX_PATH, config_path);
+				MyGetPrivateProfileStringFromBuffer(_T("RecentFiles"), create_string(_T("RecentBinaryPath%d_%d"), drv + 1, i + 1), _T(""), config.recent_binary_path[drv][i], _MAX_PATH, config_path);
 			}
 		}
 	#endif
 	#ifdef USE_BUBBLE
-		MyGetPrivateProfileString(_T("RecentFiles"), _T("InitialBubbleDir"), _T(""), config.initial_bubble_casette_dir, _MAX_PATH, config_path);
+		MyGetPrivateProfileStringFromBuffer(_T("RecentFiles"), _T("InitialBubbleDir"), _T(""), config.initial_bubble_casette_dir, _MAX_PATH, config_path);
 		for(int drv = 0; drv < USE_BUBBLE; drv++) {
 			for(int i = 0; i < MAX_HISTORY; i++) {
-				MyGetPrivateProfileString(_T("RecentFiles"), create_string(_T("RecentBubblePath%d_%d"), drv + 1, i + 1), _T(""), config.recent_bubble_casette_path[drv][i], _MAX_PATH, config_path);
+				MyGetPrivateProfileStringFromBuffer(_T("RecentFiles"), create_string(_T("RecentBubblePath%d_%d"), drv + 1, i + 1), _T(""), config.recent_bubble_casette_path[drv][i], _MAX_PATH, config_path);
 			}
 		}
 	#endif
@@ -331,7 +357,7 @@
 			int tmp_l = MyGetPrivateProfileInt(_T("Sound"), create_string(_T("VolumeLeft%d"), i + 1), config.sound_volume_l[i], config_path);
 			int tmp_r = MyGetPrivateProfileInt(_T("Sound"), create_string(_T("VolumeRight%d"), i + 1), config.sound_volume_r[i], config_path);
 			#ifdef _USE_QT
-				// Note: when using balance , levels are -40Å}20db to 0Å}20db.
+				// Note: when using balance , levels are -40ÔøΩ}20db to 0ÔøΩ}20db.
 				config.sound_volume_l[i] = max(-60, min(20, tmp_l));
 				config.sound_volume_r[i] = max(-60, min(20, tmp_r));
 			#else
@@ -404,224 +430,253 @@
 		if(config.rendering_type < 0) config.rendering_type = 0;
 		if(config.rendering_type >= CONFIG_RENDER_TYPE_END) config.rendering_type = CONFIG_RENDER_TYPE_END - 1;
 	#endif
+
+	#ifdef USE_FLOPPY_DISK
+		MyGetPrivateProfileStringFromBuffer(_T("Drive"), _T("FD0Path"), "",  config.current_floppy_disk_path[0], _MAX_PATH, config_path);
+		MyGetPrivateProfileStringFromBuffer(_T("Drive"), _T("FD1Path"), "",  config.current_floppy_disk_path[1], _MAX_PATH, config_path);
+	#endif
+
+	#ifdef USE_TAPE
+		for(int drv = 0; drv < USE_TAPE; drv++) {
+			MyGetPrivateProfileStringFromBuffer(_T("Drive"), create_string(_T("TapePath%d"), drv + 1), "",  config.current_tape_path[drv], _MAX_PATH, config_path);
+		}
+	#endif
+
 }
 
 void save_config(const _TCHAR* config_path)
 {
+	// ÂàùÊúüÂåñ
+	MyInitProfileWriteBuffer();
+	
 	// control
 	#ifdef USE_BOOT_MODE
-		MyWritePrivateProfileInt(_T("Control"), _T("BootMode"), config.boot_mode, config_path);
+		MyWritePrivateProfileIntToBuffer(_T("Control"), _T("BootMode"), config.boot_mode, config_path);
 	#endif
 	#ifdef USE_CPU_TYPE
-		MyWritePrivateProfileInt(_T("Control"), _T("CPUType"), config.cpu_type, config_path);
+		MyWritePrivateProfileIntToBuffer(_T("Control"), _T("CPUType"), config.cpu_type, config_path);
 	#endif
 	#ifdef USE_DIPSWITCH
-		MyWritePrivateProfileInt(_T("Control"), _T("DipSwitch"), config.dipswitch, config_path);
+		MyWritePrivateProfileIntToBuffer(_T("Control"), _T("DipSwitch"), config.dipswitch, config_path);
 	#endif
 	#ifdef USE_DEVICE_TYPE
-		MyWritePrivateProfileInt(_T("Control"), _T("DeviceType"), config.device_type, config_path);
+		MyWritePrivateProfileIntToBuffer(_T("Control"), _T("DeviceType"), config.device_type, config_path);
 	#endif
 	#ifdef USE_DRIVE_TYPE
-		MyWritePrivateProfileInt(_T("Control"), _T("DriveType"), config.drive_type, config_path);
+		MyWritePrivateProfileIntToBuffer(_T("Control"), _T("DriveType"), config.drive_type, config_path);
 	#endif
 	#ifdef USE_KEYBOARD_TYPE
-		MyWritePrivateProfileInt(_T("Control"), _T("KeyboardType"), config.keyboard_type, config_path);
+		MyWritePrivateProfileIntToBuffer(_T("Control"), _T("KeyboardType"), config.keyboard_type, config_path);
 	#endif
 	#ifdef USE_MOUSE_TYPE
-		MyWritePrivateProfileInt(_T("Control"), _T("MouseType"), config.mouse_type, config_path);
+		MyWritePrivateProfileIntToBuffer(_T("Control"), _T("MouseType"), config.mouse_type, config_path);
 	#endif
 	#ifdef USE_JOYSTICK_TYPE
-		MyWritePrivateProfileInt(_T("Control"), _T("JoystickType"), config.joystick_type, config_path);
+		MyWritePrivateProfileIntToBuffer(_T("Control"), _T("JoystickType"), config.joystick_type, config_path);
 	#endif
 	#ifdef USE_SOUND_TYPE
-		MyWritePrivateProfileInt(_T("Control"), _T("SoundType"), config.sound_type, config_path);
+		MyWritePrivateProfileIntToBuffer(_T("Control"), _T("SoundType"), config.sound_type, config_path);
 	#endif
 	#ifdef USE_MONITOR_TYPE
-		MyWritePrivateProfileInt(_T("Control"), _T("MonitorType"), config.monitor_type, config_path);
+		MyWritePrivateProfileIntToBuffer(_T("Control"), _T("MonitorType"), config.monitor_type, config_path);
 	#endif
 	#ifdef USE_SCANLINE
-		MyWritePrivateProfileBool(_T("Control"), _T("ScanLine"), config.scan_line, config_path);
-		MyWritePrivateProfileBool(_T("Control"), _T("ScanLineAuto"), config.scan_line_auto, config_path);
+		MyWritePrivateProfileBoolToBuffer(_T("Control"), _T("ScanLine"), config.scan_line, config_path);
+		MyWritePrivateProfileBoolToBuffer(_T("Control"), _T("ScanLineAuto"), config.scan_line_auto, config_path);
 	#endif
 	#ifdef USE_PRINTER_TYPE
-		MyWritePrivateProfileInt(_T("Control"), _T("PrinterType"), config.printer_type, config_path);
+		MyWritePrivateProfileIntToBuffer(_T("Control"), _T("PrinterType"), config.printer_type, config_path);
 	#endif
 	#ifdef USE_SERIAL_TYPE
-		MyWritePrivateProfileInt(_T("Control"), _T("SerialType"), config.serial_type, config_path);
+		MyWritePrivateProfileIntToBuffer(_T("Control"), _T("SerialType"), config.serial_type, config_path);
 	#endif
 	#ifdef USE_FLOPPY_DISK
 		for(int drv = 0; drv < USE_FLOPPY_DISK; drv++) {
-			MyWritePrivateProfileBool(_T("Control"), create_string(_T("CorrectDiskTiming%d"), drv + 1), config.correct_disk_timing[drv], config_path);
-			MyWritePrivateProfileBool(_T("Control"), create_string(_T("IgnoreDiskCRC%d"), drv + 1), config.ignore_disk_crc[drv], config_path);
+			MyWritePrivateProfileBoolToBuffer(_T("Control"), create_string(_T("CorrectDiskTiming%d"), drv + 1), config.correct_disk_timing[drv], config_path);
+			MyWritePrivateProfileBoolToBuffer(_T("Control"), create_string(_T("IgnoreDiskCRC%d"), drv + 1), config.ignore_disk_crc[drv], config_path);
 		}
 	#endif
 	#ifdef USE_TAPE
 		for(int drv = 0; drv < USE_TAPE; drv++) {
-			MyWritePrivateProfileBool(_T("Control"), create_string(_T("WaveShaper%d"), drv + 1), config.wave_shaper[drv], config_path);
-			MyWritePrivateProfileBool(_T("Control"), create_string(_T("DirectLoadMZT%d"), drv + 1), config.direct_load_mzt[drv], config_path);
-			MyWritePrivateProfileBool(_T("Control"), create_string(_T("BaudHigh%d"), drv + 1), config.baud_high[drv], config_path);
+			MyWritePrivateProfileBoolToBuffer(_T("Control"), create_string(_T("WaveShaper%d"), drv + 1), config.wave_shaper[drv], config_path);
+			MyWritePrivateProfileBoolToBuffer(_T("Control"), create_string(_T("DirectLoadMZT%d"), drv + 1), config.direct_load_mzt[drv], config_path);
+			MyWritePrivateProfileBoolToBuffer(_T("Control"), create_string(_T("BaudHigh%d"), drv + 1), config.baud_high[drv], config_path);
 		}
 	#endif
-	MyWritePrivateProfileBool(_T("Control"), _T("CompressState"), config.compress_state, config_path);
-	MyWritePrivateProfileBool(_T("Control"), _T("DriveVMInOpecode"), config.drive_vm_in_opecode, config_path);
+	MyWritePrivateProfileBoolToBuffer(_T("Control"), _T("CompressState"), config.compress_state, config_path);
+	MyWritePrivateProfileBoolToBuffer(_T("Control"), _T("DriveVMInOpecode"), config.drive_vm_in_opecode, config_path);
 	
 	// recent files
 	#ifdef USE_CART
-		MyWritePrivateProfileString(_T("RecentFiles"), _T("InitialCartDir"), config.initial_cart_dir, config_path);
+		MyWritePrivateProfileStringToBuffer(_T("RecentFiles"), _T("InitialCartDir"), config.initial_cart_dir, config_path);
 		for(int drv = 0; drv < USE_CART; drv++) {
 			for(int i = 0; i < MAX_HISTORY; i++) {
-				MyWritePrivateProfileString(_T("RecentFiles"), create_string(_T("RecentCartPath%d_%d"), drv + 1, i + 1), config.recent_cart_path[drv][i], config_path);
+				MyWritePrivateProfileStringToBuffer(_T("RecentFiles"), create_string(_T("RecentCartPath%d_%d"), drv + 1, i + 1), config.recent_cart_path[drv][i], config_path);
 			}
 		}
 	#endif
 	#ifdef USE_FLOPPY_DISK
-		MyWritePrivateProfileString(_T("RecentFiles"), _T("InitialDiskDir"), config.initial_floppy_disk_dir, config_path);
+		MyWritePrivateProfileStringToBuffer(_T("RecentFiles"), _T("InitialDiskDir"), config.initial_floppy_disk_dir, config_path);
 		for(int drv = 0; drv < USE_FLOPPY_DISK; drv++) {
 			for(int i = 0; i < MAX_HISTORY; i++) {
-				MyWritePrivateProfileString(_T("RecentFiles"), create_string(_T("RecentDiskPath%d_%d"), drv + 1, i + 1), config.recent_floppy_disk_path[drv][i], config_path);
+				MyWritePrivateProfileStringToBuffer(_T("RecentFiles"), create_string(_T("RecentDiskPath%d_%d"), drv + 1, i + 1), config.recent_floppy_disk_path[drv][i], config_path);
 			}
 		}
 	#endif
 	#ifdef USE_QUICK_DISK
-		MyWritePrivateProfileString(_T("RecentFiles"), _T("InitialQuickDiskDir"), config.initial_quick_disk_dir, config_path);
+		MyWritePrivateProfileStringToBuffer(_T("RecentFiles"), _T("InitialQuickDiskDir"), config.initial_quick_disk_dir, config_path);
 		for(int drv = 0; drv < USE_QUICK_DISK; drv++) {
 			for(int i = 0; i < MAX_HISTORY; i++) {
-				MyWritePrivateProfileString(_T("RecentFiles"), create_string(_T("RecentQuickDiskPath%d_%d"), drv + 1, i + 1), config.recent_quick_disk_path[drv][i], config_path);
+				MyWritePrivateProfileStringToBuffer(_T("RecentFiles"), create_string(_T("RecentQuickDiskPath%d_%d"), drv + 1, i + 1), config.recent_quick_disk_path[drv][i], config_path);
 			}
 		}
 	#endif
 	#ifdef USE_HARD_DISK
-		MyWritePrivateProfileString(_T("RecentFiles"), _T("InitialHardDiskDir"), config.initial_hard_disk_dir, config_path);
+		MyWritePrivateProfileStringToBuffer(_T("RecentFiles"), _T("InitialHardDiskDir"), config.initial_hard_disk_dir, config_path);
 		for(int drv = 0; drv < USE_HARD_DISK; drv++) {
 			for(int i = 0; i < MAX_HISTORY; i++) {
-				MyWritePrivateProfileString(_T("RecentFiles"), create_string(_T("RecentHardDiskPath%d_%d"), drv + 1, i + 1), config.recent_hard_disk_path[drv][i], config_path);
+				MyWritePrivateProfileStringToBuffer(_T("RecentFiles"), create_string(_T("RecentHardDiskPath%d_%d"), drv + 1, i + 1), config.recent_hard_disk_path[drv][i], config_path);
 			}
-			MyWritePrivateProfileString(_T("RecentFiles"), create_string(_T("LastHardDiskPath%d"), drv + 1), config.last_hard_disk_path[drv], config_path);
+			MyWritePrivateProfileStringToBuffer(_T("RecentFiles"), create_string(_T("LastHardDiskPath%d"), drv + 1), config.last_hard_disk_path[drv], config_path);
 		}
 	#endif
 	#ifdef USE_TAPE
-		MyWritePrivateProfileString(_T("RecentFiles"), _T("InitialTapeDir"), config.initial_tape_dir, config_path);
+		MyWritePrivateProfileStringToBuffer(_T("RecentFiles"), _T("InitialTapeDir"), config.initial_tape_dir, config_path);
 		for(int drv = 0; drv < USE_TAPE; drv++) {
 			for(int i = 0; i < MAX_HISTORY; i++) {
-				MyWritePrivateProfileString(_T("RecentFiles"), create_string(_T("RecentTapePath%d_%d"), drv + 1, i + 1), config.recent_tape_path[drv][i], config_path);
+				MyWritePrivateProfileStringToBuffer(_T("RecentFiles"), create_string(_T("RecentTapePath%d_%d"), drv + 1, i + 1), config.recent_tape_path[drv][i], config_path);
 			}
 		}
 	#endif
 	#ifdef USE_COMPACT_DISC
-		MyWritePrivateProfileString(_T("RecentFiles"), _T("InitialCompactDiscDir"), config.initial_compact_disc_dir, config_path);
+		MyWritePrivateProfileStringToBuffer(_T("RecentFiles"), _T("InitialCompactDiscDir"), config.initial_compact_disc_dir, config_path);
 		for(int drv = 0; drv < USE_COMPACT_DISC; drv++) {
 			for(int i = 0; i < MAX_HISTORY; i++) {
-				MyWritePrivateProfileString(_T("RecentFiles"), create_string(_T("RecentCompactDiscPath%d_%d"), drv + 1, i + 1), config.recent_compact_disc_path[drv][i], config_path);
+				MyWritePrivateProfileStringToBuffer(_T("RecentFiles"), create_string(_T("RecentCompactDiscPath%d_%d"), drv + 1, i + 1), config.recent_compact_disc_path[drv][i], config_path);
 			}
 		}
 	#endif
 	#ifdef USE_LASER_DISC
-		MyWritePrivateProfileString(_T("RecentFiles"), _T("InitialLaserDiscDir"), config.initial_laser_disc_dir, config_path);
+		MyWritePrivateProfileStringToBuffer(_T("RecentFiles"), _T("InitialLaserDiscDir"), config.initial_laser_disc_dir, config_path);
 		for(int drv = 0; drv < USE_LASER_DISC; drv++) {
 			for(int i = 0; i < MAX_HISTORY; i++) {
-				MyWritePrivateProfileString(_T("RecentFiles"), create_string(_T("RecentLaserDiscPath%d_%d"), drv + 1, i + 1), config.recent_laser_disc_path[drv][i], config_path);
+				MyWritePrivateProfileStringToBuffer(_T("RecentFiles"), create_string(_T("RecentLaserDiscPath%d_%d"), drv + 1, i + 1), config.recent_laser_disc_path[drv][i], config_path);
 			}
 		}
 	#endif
 	#ifdef USE_BINARY_FILE
-		MyWritePrivateProfileString(_T("RecentFiles"), _T("InitialBinaryDir"), config.initial_binary_dir, config_path);
+		MyWritePrivateProfileStringToBuffer(_T("RecentFiles"), _T("InitialBinaryDir"), config.initial_binary_dir, config_path);
 		for(int drv = 0; drv < USE_BINARY_FILE; drv++) {
 			for(int i = 0; i < MAX_HISTORY; i++) {
-				MyWritePrivateProfileString(_T("RecentFiles"), create_string(_T("RecentBinaryPath%d_%d"), drv + 1, i + 1), config.recent_binary_path[drv][i], config_path);
+				MyWritePrivateProfileStringToBuffer(_T("RecentFiles"), create_string(_T("RecentBinaryPath%d_%d"), drv + 1, i + 1), config.recent_binary_path[drv][i], config_path);
 			}
 		}
 	#endif
 	#ifdef USE_BUBBLE
-		MyWritePrivateProfileString(_T("RecentFiles"), _T("InitialBubbleDir"), config.initial_bubble_casette_dir, config_path);
+		MyWritePrivateProfileStringToBuffer(_T("RecentFiles"), _T("InitialBubbleDir"), config.initial_bubble_casette_dir, config_path);
 		for(int drv = 0; drv < USE_BUBBLE; drv++) {
 			for(int i = 0; i < MAX_HISTORY; i++) {
-				MyWritePrivateProfileString(_T("RecentFiles"), create_string(_T("RecentBubblePath%d_%d"), drv + 1, i + 1), config.recent_bubble_casette_path[drv][i], config_path);
+				MyWritePrivateProfileStringToBuffer(_T("RecentFiles"), create_string(_T("RecentBubblePath%d_%d"), drv + 1, i + 1), config.recent_bubble_casette_path[drv][i], config_path);
 			}
 		}
 	#endif
 	
 	// screen
 	#ifndef ONE_BOARD_MICRO_COMPUTER
-		MyWritePrivateProfileInt(_T("Screen"), _T("WindowMode"), config.window_mode, config_path);
-		MyWritePrivateProfileInt(_T("Screen"), _T("WindowStretchType"), config.window_stretch_type, config_path);
-		MyWritePrivateProfileInt(_T("Screen"), _T("FullScreenStretchType"), config.fullscreen_stretch_type, config_path);
+		MyWritePrivateProfileIntToBuffer(_T("Screen"), _T("WindowMode"), config.window_mode, config_path);
+		MyWritePrivateProfileIntToBuffer(_T("Screen"), _T("WindowStretchType"), config.window_stretch_type, config_path);
+		MyWritePrivateProfileIntToBuffer(_T("Screen"), _T("FullScreenStretchType"), config.fullscreen_stretch_type, config_path);
 //		#ifdef USE_SCREEN_ROTATE
-			MyWritePrivateProfileInt(_T("Screen"), _T("RotateType"), config.rotate_type, config_path);
+			MyWritePrivateProfileIntToBuffer(_T("Screen"), _T("RotateType"), config.rotate_type, config_path);
 //		#endif
 	#endif
 	
 	// filter
 	#ifdef USE_SCREEN_FILTER
-		MyWritePrivateProfileInt(_T("Screen"), _T("FilterType"), config.filter_type, config_path);
+		MyWritePrivateProfileIntToBuffer(_T("Screen"), _T("FilterType"), config.filter_type, config_path);
 	#endif
 	
 	// sound
-	MyWritePrivateProfileInt(_T("Sound"), _T("Frequency"), config.sound_frequency, config_path);
-	MyWritePrivateProfileInt(_T("Sound"), _T("Latency"), config.sound_latency, config_path);
-	MyWritePrivateProfileBool(_T("Sound"), _T("StrictRendering"), config.sound_strict_rendering, config_path);
+	MyWritePrivateProfileIntToBuffer(_T("Sound"), _T("Frequency"), config.sound_frequency, config_path);
+	MyWritePrivateProfileIntToBuffer(_T("Sound"), _T("Latency"), config.sound_latency, config_path);
+	MyWritePrivateProfileBoolToBuffer(_T("Sound"), _T("StrictRendering"), config.sound_strict_rendering, config_path);
 	#ifdef USE_FLOPPY_DISK
-		MyWritePrivateProfileBool(_T("Sound"), _T("NoiseFDD"), config.sound_noise_fdd, config_path);
+		MyWritePrivateProfileBoolToBuffer(_T("Sound"), _T("NoiseFDD"), config.sound_noise_fdd, config_path);
 	#endif
 	#ifdef USE_QUICK_DISK
-		MyWritePrivateProfileBool(_T("Sound"), _T("NoiseQD"), config.sound_noise_qd, config_path);
+		MyWritePrivateProfileBoolToBuffer(_T("Sound"), _T("NoiseQD"), config.sound_noise_qd, config_path);
 	#endif
 	#ifdef USE_TAPE
-		MyWritePrivateProfileBool(_T("Sound"), _T("NoiseCMT"), config.sound_noise_cmt, config_path);
-		MyWritePrivateProfileBool(_T("Sound"), _T("TapeSignal"), config.sound_tape_signal, config_path);
-		MyWritePrivateProfileBool(_T("Sound"), _T("TapeVoice"), config.sound_tape_voice, config_path);
+		MyWritePrivateProfileBoolToBuffer(_T("Sound"), _T("NoiseCMT"), config.sound_noise_cmt, config_path);
+		MyWritePrivateProfileBoolToBuffer(_T("Sound"), _T("TapeSignal"), config.sound_tape_signal, config_path);
+		MyWritePrivateProfileBoolToBuffer(_T("Sound"), _T("TapeVoice"), config.sound_tape_voice, config_path);
 	#endif
 	#ifdef USE_SOUND_VOLUME
 		for(int i = 0; i < USE_SOUND_VOLUME; i++) {
-			MyWritePrivateProfileInt(_T("Sound"), create_string(_T("VolumeLeft%d"), i + 1), config.sound_volume_l[i], config_path);
-			MyWritePrivateProfileInt(_T("Sound"), create_string(_T("VolumeRight%d"), i + 1), config.sound_volume_r[i], config_path);
+			MyWritePrivateProfileIntToBuffer(_T("Sound"), create_string(_T("VolumeLeft%d"), i + 1), config.sound_volume_l[i], config_path);
+			MyWritePrivateProfileIntToBuffer(_T("Sound"), create_string(_T("VolumeRight%d"), i + 1), config.sound_volume_r[i], config_path);
 		}
 	#endif
 	#ifdef _WIN32
-		MyWritePrivateProfileString(_T("Sound"), _T("YM2151GenDll"), config.mame2151_dll_path, config_path);
-		MyWritePrivateProfileString(_T("Sound"), _T("YM2608GenDll"), config.mame2608_dll_path, config_path);
+		MyWritePrivateProfileStringToBuffer(_T("Sound"), _T("YM2151GenDll"), config.mame2151_dll_path, config_path);
+		MyWritePrivateProfileStringToBuffer(_T("Sound"), _T("YM2608GenDll"), config.mame2608_dll_path, config_path);
 	#endif
 	
 	// input
 	#ifdef USE_JOYSTICK
 		for(int i = 0; i < 8; i++) {
 			for(int j = 0; j < 16; j++) {
-				MyWritePrivateProfileInt(_T("Input"), create_string(_T("JoyButtonsEx%d_%d"), i + 1, j + 1), config.joy_buttons[i][j], config_path);
+				MyWritePrivateProfileIntToBuffer(_T("Input"), create_string(_T("JoyButtonsEx%d_%d"), i + 1, j + 1), config.joy_buttons[i][j], config_path);
 			}
 		}
-		MyWritePrivateProfileBool(_T("Input"), _T("UseJoyToKey"), config.use_joy_to_key, config_path);
-		MyWritePrivateProfileInt(_T("Input"), _T("JoyToKeyType"), config.joy_to_key_type, config_path);
-		MyWritePrivateProfileBool(_T("Input"), _T("JoyToKeyNumPad5"), config.joy_to_key_numpad5, config_path);
+		MyWritePrivateProfileBoolToBuffer(_T("Input"), _T("UseJoyToKey"), config.use_joy_to_key, config_path);
+		MyWritePrivateProfileIntToBuffer(_T("Input"), _T("JoyToKeyType"), config.joy_to_key_type, config_path);
+		MyWritePrivateProfileBoolToBuffer(_T("Input"), _T("JoyToKeyNumPad5"), config.joy_to_key_numpad5, config_path);
 		for(int i = 0; i < 16; i++) {
-			MyWritePrivateProfileInt(_T("Input"), create_string(_T("JoyToKeyButtons%d"), i + 1), config.joy_to_key_buttons[i], config_path);
+			MyWritePrivateProfileIntToBuffer(_T("Input"), create_string(_T("JoyToKeyButtons%d"), i + 1), config.joy_to_key_buttons[i], config_path);
 		}
 	#endif
 	
 	// win32
 	#ifdef _WIN32
-		MyWritePrivateProfileBool(_T("Win32"), _T("UseTelnet"), config.use_telnet, config_path);
+		MyWritePrivateProfileBoolToBuffer(_T("Win32"), _T("UseTelnet"), config.use_telnet, config_path);
 		#ifndef ONE_BOARD_MICRO_COMPUTER
-			MyWritePrivateProfileBool(_T("Win32"), _T("UseDirect2D1"), config.use_d2d1, config_path);
-			MyWritePrivateProfileBool(_T("Win32"), _T("UseDirect3D9"), config.use_d3d9, config_path);
-			MyWritePrivateProfileBool(_T("Win32"), _T("WaitVSync"), config.wait_vsync, config_path);
+			MyWritePrivateProfileBoolToBuffer(_T("Win32"), _T("UseDirect2D1"), config.use_d2d1, config_path);
+			MyWritePrivateProfileBoolToBuffer(_T("Win32"), _T("UseDirect3D9"), config.use_d3d9, config_path);
+			MyWritePrivateProfileBoolToBuffer(_T("Win32"), _T("WaitVSync"), config.wait_vsync, config_path);
 		#endif
-		MyWritePrivateProfileBool(_T("Win32"), _T("UseDirectInput"), config.use_dinput, config_path);
-		MyWritePrivateProfileBool(_T("Win32"), _T("DisableDwm"), config.disable_dwm, config_path);
-		MyWritePrivateProfileBool(_T("Win32"), _T("ShowStatusBar"), config.show_status_bar, config_path);
+		MyWritePrivateProfileBoolToBuffer(_T("Win32"), _T("UseDirectInput"), config.use_dinput, config_path);
+		MyWritePrivateProfileBoolToBuffer(_T("Win32"), _T("DisableDwm"), config.disable_dwm, config_path);
+		MyWritePrivateProfileBoolToBuffer(_T("Win32"), _T("ShowStatusBar"), config.show_status_bar, config_path);
 	#endif
 	
 	// qt
 	#ifdef _USE_QT
-		MyWritePrivateProfileBool(_T("Qt"), _T("UseOpenGLScanLine"), config.use_opengl_scanline, config_path);
-		MyWritePrivateProfileBool(_T("Qt"), _T("OpenGLScanLineVert"), config.opengl_scanline_vert, config_path);
-		MyWritePrivateProfileBool(_T("Qt"), _T("OpenGLScanLineHoriz"), config.opengl_scanline_horiz, config_path);
-		MyWritePrivateProfileBool(_T("Qt"), _T("UseOpenGLFilters"), config.use_opengl_filters, config_path);
-		MyWritePrivateProfileInt(_T("Qt"), _T("OpenGLFilterNum"), config.opengl_filter_num, config_path);
-		MyWritePrivateProfileBool(_T("Qt"), _T("SwapKanjiPause"), config.swap_kanji_pause, config_path);
-		MyWritePrivateProfileInt(_T("Qt"), _T("RenderPlatform"), config.render_platform, config_path);
-		MyWritePrivateProfileInt(_T("Qt"), _T("RenderMajorVersion"), config.render_major_version, config_path);
-		MyWritePrivateProfileInt(_T("Qt"), _T("RenderMinorVersion"), config.render_minor_version, config_path);
-		MyWritePrivateProfileInt(_T("Qt"), _T("RenderType"), config.rendering_type, config_path);
+		MyWritePrivateProfileBoolToBuffer(_T("Qt"), _T("UseOpenGLScanLine"), config.use_opengl_scanline, config_path);
+		MyWritePrivateProfileBoolToBuffer(_T("Qt"), _T("OpenGLScanLineVert"), config.opengl_scanline_vert, config_path);
+		MyWritePrivateProfileBoolToBuffer(_T("Qt"), _T("OpenGLScanLineHoriz"), config.opengl_scanline_horiz, config_path);
+		MyWritePrivateProfileBoolToBuffer(_T("Qt"), _T("UseOpenGLFilters"), config.use_opengl_filters, config_path);
+		MyWritePrivateProfileIntToBuffer(_T("Qt"), _T("OpenGLFilterNum"), config.opengl_filter_num, config_path);
+		MyWritePrivateProfileBoolToBuffer(_T("Qt"), _T("SwapKanjiPause"), config.swap_kanji_pause, config_path);
+		MyWritePrivateProfileIntToBuffer(_T("Qt"), _T("RenderPlatform"), config.render_platform, config_path);
+		MyWritePrivateProfileIntToBuffer(_T("Qt"), _T("RenderMajorVersion"), config.render_major_version, config_path);
+		MyWritePrivateProfileIntToBuffer(_T("Qt"), _T("RenderMinorVersion"), config.render_minor_version, config_path);
+		MyWritePrivateProfileIntToBuffer(_T("Qt"), _T("RenderType"), config.rendering_type, config_path);
 	#endif
+
+	#ifdef USE_FLOPPY_DISK
+		MyWritePrivateProfileStringToBuffer(_T("Drive"), _T("FD0Path"), config.current_floppy_disk_path[0], config_path);
+		MyWritePrivateProfileStringToBuffer(_T("Drive"), _T("FD1Path"), config.current_floppy_disk_path[1], config_path);
+	#endif
+
+	#ifdef USE_TAPE
+		for(int drv = 0; drv < USE_TAPE; drv++) {
+			MyWritePrivateProfileStringToBuffer(_T("Drive"), create_string(_T("TapePath%d"), drv + 1), config.current_tape_path[drv], config_path);
+		}
+	#endif
+	
+	// ÊúÄÂæå„Å´„Éï„É©„ÉÉ„Ç∑„É•
+	MyWritePrivateProfileFlush(config_path);
 }
 
 #define STATE_VERSION	7
diff -ruN source/src/config.h src/config.h
--- source/src/config.h	2022-12-31 17:10:00
+++ src/config.h	2025-04-28 22:36:36
@@ -15,6 +15,8 @@
 #endif
 #include "vm/vm.h"
 #include "fileio.h"
+#include <limits.h>
+#include "common.h"
 
 #if defined(_USE_QT)
 	enum {
@@ -130,6 +132,7 @@
 	#if defined(USE_SHARED_DLL) || defined(USE_FLOPPY_DISK)
 		_TCHAR initial_floppy_disk_dir[_MAX_PATH];
 		_TCHAR recent_floppy_disk_path[USE_FLOPPY_DISK_TMP][MAX_HISTORY][_MAX_PATH];
+		_TCHAR current_floppy_disk_path[USE_FLOPPY_DISK_TMP][_MAX_PATH];
 	#endif
 	#if defined(USE_SHARED_DLL) || defined(USE_QUICK_DISK)
 		_TCHAR initial_quick_disk_dir[_MAX_PATH];
@@ -143,6 +146,7 @@
 	#if defined(USE_SHARED_DLL) || defined(USE_TAPE)
 		_TCHAR initial_tape_dir[_MAX_PATH];
 		_TCHAR recent_tape_path[USE_TAPE_TMP][MAX_HISTORY][_MAX_PATH];
+		_TCHAR current_tape_path[USE_TAPE_TMP][_MAX_PATH];
 	#endif
 	#if defined(USE_SHARED_DLL) || defined(USE_COMPACT_DISC)
 		_TCHAR initial_compact_disc_dir[_MAX_PATH];
@@ -257,6 +261,13 @@
 } config_t;
 
 extern DLL_PREFIX config_t config;
+
+BOOL MyWritePrivateProfileInt(LPCTSTR lpAppName, LPCTSTR lpKeyName, int Value, LPCTSTR lpFileName);
+BOOL MyWritePrivateProfileBool(LPCTSTR lpAppName, LPCTSTR lpKeyName, bool Value, LPCTSTR lpFileName);
+BOOL MyWritePrivateProfileIntToBuffer(LPCTSTR lpAppName, LPCTSTR lpKeyName, int Value, LPCTSTR lpFileName);
+BOOL MyWritePrivateProfileBoolToBuffer(LPCTSTR lpAppName, LPCTSTR lpKeyName, bool Value, LPCTSTR lpFileName);
+bool MyGetPrivateProfileBool(LPCTSTR lpAppName, LPCTSTR lpKeyName, bool bDefault, LPCTSTR lpFileName);
+bool MyGetPrivateProfileBoolFromBuffer(LPCTSTR lpAppName, LPCTSTR lpKeyName, bool bDefault, LPCTSTR lpFileName);
 
 #endif
 
diff -ruN source/src/debugger.cpp src/debugger.cpp
--- source/src/debugger.cpp	2025-04-28 16:00:00
+++ src/debugger.cpp	2025-04-28 22:36:36
@@ -8,7 +8,10 @@
 */
 
 #include <stdlib.h>
+#include <pthread.h>
+#ifdef _WIN32
 #include <io.h>
+#endif
 #include <fcntl.h>
 #include "vm/device.h"
 #include "vm/debugger.h"
@@ -270,7 +273,6 @@
 	
 	uint32_t dump_addr = 0;
 	uint32_t dasm_addr = cpu->get_next_pc();
-	uint32_t dasm_eip = cpu->get_next_eip();
 	
 	p->osd->set_console_text_attribute(OSD_CONSOLE_RED | OSD_CONSOLE_GREEN | OSD_CONSOLE_BLUE | OSD_CONSOLE_INTENSITY);
 	if(cpu->get_debug_regs_info(buffer, array_length(buffer))) {
@@ -281,7 +283,7 @@
 	my_printf(p->osd, _T("breaked at %s\n"), my_get_value_and_symbol(cpu, _T("%08X"), cpu->get_next_pc()));
 	
 	p->osd->set_console_text_attribute(OSD_CONSOLE_GREEN | OSD_CONSOLE_BLUE | OSD_CONSOLE_INTENSITY);
-	cpu->debug_dasm(cpu->get_next_pc(), cpu->get_next_eip(), buffer, array_length(buffer));
+	cpu->debug_dasm(cpu->get_next_pc(), buffer, array_length(buffer));
 	my_printf(p->osd, _T("next\t%s  %s\n"), my_get_value_and_symbol(cpu, _T("%08X"), cpu->get_next_pc()), buffer);
 	p->osd->set_console_text_attribute(OSD_CONSOLE_RED | OSD_CONSOLE_GREEN | OSD_CONSOLE_BLUE | OSD_CONSOLE_INTENSITY);
 	
@@ -581,13 +583,12 @@
 				if(num <= 3) {
 					if(num >= 2) {
 						dasm_addr = my_hexatoi(target, params[1]) & target->get_debug_prog_addr_mask();
-						dasm_eip = dasm_addr - (cpu->get_next_pc() - cpu->get_next_eip());
 					}
 					if(num == 3) {
 						uint32_t end_addr = my_hexatoi(target, params[2]) & target->get_debug_prog_addr_mask();
 						while(dasm_addr <= end_addr) {
 							const _TCHAR *name = my_get_symbol(target, dasm_addr & target->get_debug_prog_addr_mask());
-							int len = target->debug_dasm(dasm_addr & target->get_debug_prog_addr_mask(), dasm_eip, buffer, array_length(buffer));
+							int len = target->debug_dasm(dasm_addr & target->get_debug_prog_addr_mask(), buffer, array_length(buffer));
 							if(name != NULL) {
 								my_printf(p->osd, _T("%08X                  "), dasm_addr & target->get_debug_prog_addr_mask());
 								p->osd->set_console_text_attribute(OSD_CONSOLE_GREEN | OSD_CONSOLE_INTENSITY);
@@ -603,12 +604,11 @@
 							}
 							my_printf(p->osd, _T("  %s\n"), buffer);
 							dasm_addr += len;
-							dasm_eip += len;
 						}
 					} else {
 						for(int i = 0; i < 16; i++) {
 							const _TCHAR *name = my_get_symbol(target, dasm_addr & target->get_debug_prog_addr_mask());
-							int len = target->debug_dasm(dasm_addr & target->get_debug_prog_addr_mask(), dasm_eip, buffer, array_length(buffer));
+							int len = target->debug_dasm(dasm_addr & target->get_debug_prog_addr_mask(), buffer, array_length(buffer));
 							if(name != NULL) {
 								my_printf(p->osd, _T("%08X                  "), dasm_addr & target->get_debug_prog_addr_mask());
 								p->osd->set_console_text_attribute(OSD_CONSOLE_GREEN | OSD_CONSOLE_INTENSITY);
@@ -624,7 +624,6 @@
 							}
 							my_printf(p->osd, _T("  %s\n"), buffer);
 							dasm_addr += len;
-							dasm_eip += len;
 						}
 					}
 					prev_command[1] = _T('\0'); // remove parameters to disassemble continuously
@@ -641,19 +640,18 @@
 					}
 					for(int i = MAX_CPU_TRACE - steps; i < MAX_CPU_TRACE; i++) {
 						int index = (target_debugger->cpu_trace_ptr + i) & (MAX_CPU_TRACE - 1);
-						cpu_trace_t *trace = &target_debugger->cpu_trace[index];
-						if(!(trace->pc & ~target->get_debug_prog_addr_mask())) {
-							const _TCHAR *name = my_get_symbol(target, trace->pc & target->get_debug_prog_addr_mask());
-							int len = target->debug_dasm(trace->pc & target->get_debug_prog_addr_mask(), trace->eip, trace->mode, buffer, array_length(buffer));
+						if(!(target_debugger->cpu_trace[index] & ~target->get_debug_prog_addr_mask())) {
+							const _TCHAR *name = my_get_symbol(target, target_debugger->cpu_trace[index] & target->get_debug_prog_addr_mask());
+							int len = target->debug_dasm(target_debugger->cpu_trace[index] & target->get_debug_prog_addr_mask(), buffer, array_length(buffer));
 							if(name != NULL) {
-								my_printf(p->osd, _T("%08X                  "), trace->pc & target->get_debug_prog_addr_mask());
+								my_printf(p->osd, _T("%08X                  "), target_debugger->cpu_trace[index] & target->get_debug_prog_addr_mask());
 								p->osd->set_console_text_attribute(OSD_CONSOLE_GREEN | OSD_CONSOLE_INTENSITY);
 								my_printf(p->osd, _T("%s:\n"), name);
 								p->osd->set_console_text_attribute(OSD_CONSOLE_RED | OSD_CONSOLE_GREEN | OSD_CONSOLE_BLUE | OSD_CONSOLE_INTENSITY);
 							}
-							my_printf(p->osd, _T("%08X  "), trace->pc & target->get_debug_prog_addr_mask());
+							my_printf(p->osd, _T("%08X  "), target_debugger->cpu_trace[index] & target->get_debug_prog_addr_mask());
 							for(int i = 0; i < len; i++) {
-								my_printf(p->osd, _T("%02X"), target->read_debug_data8((trace->pc + i) & target->get_debug_prog_addr_mask()));
+								my_printf(p->osd, _T("%02X"), target->read_debug_data8((target_debugger->cpu_trace[index] + i) & target->get_debug_prog_addr_mask()));
 							}
 							for(int i = len; i < 8; i++) {
 								my_printf(p->osd, _T("  "));
@@ -998,16 +996,14 @@
 					bool break_points_stored = false;
 					if(_tcsicmp(params[0], _T("P")) == 0) {
 						cpu_debugger->store_break_points();
-						int len = cpu->debug_dasm(cpu->get_next_pc(), cpu->get_next_eip(), buffer, array_length(buffer));
-						cpu_debugger->bp.table[0].addr = (cpu->get_next_pc() + len) & cpu->get_debug_prog_addr_mask();
+						cpu_debugger->bp.table[0].addr = (cpu->get_next_pc() + cpu->debug_dasm(cpu->get_next_pc(), buffer, array_length(buffer))) & cpu->get_debug_prog_addr_mask();
 						cpu_debugger->bp.table[0].mask = cpu->get_debug_prog_addr_mask();
 						cpu_debugger->bp.table[0].status = 1;
 						cpu_debugger->bp.table[0].check_point = false;
 						break_points_stored = true;
 					} else if(num >= 2) {
 						cpu_debugger->store_break_points();
-						uint32_t addr = my_hexatoi(cpu, params[1]) & cpu->get_debug_prog_addr_mask();
-						cpu_debugger->bp.table[0].addr = addr;
+						cpu_debugger->bp.table[0].addr = my_hexatoi(cpu, params[1]) & cpu->get_debug_prog_addr_mask();
 						cpu_debugger->bp.table[0].mask = cpu->get_debug_prog_addr_mask();
 						cpu_debugger->bp.table[0].status = 1;
 						cpu_debugger->bp.table[0].check_point = false;
@@ -1044,11 +1040,10 @@
 					}
 					if(target == cpu) {
 						dasm_addr = cpu->get_next_pc();
-						dasm_eip = cpu->get_next_eip();
 					}
 					
 					p->osd->set_console_text_attribute(OSD_CONSOLE_GREEN | OSD_CONSOLE_BLUE | OSD_CONSOLE_INTENSITY);
-					cpu->debug_dasm(cpu->get_pc(), cpu->get_eip(), buffer, array_length(buffer));
+					cpu->debug_dasm(cpu->get_pc(), buffer, array_length(buffer));
 					my_printf(p->osd, _T("done\t%s  %s\n"), my_get_value_and_symbol(cpu, _T("%08X"), cpu->get_pc()), buffer);
 					
 					p->osd->set_console_text_attribute(OSD_CONSOLE_RED | OSD_CONSOLE_GREEN | OSD_CONSOLE_BLUE | OSD_CONSOLE_INTENSITY);
@@ -1058,7 +1053,7 @@
 					
 					if(target != cpu) {
 						p->osd->set_console_text_attribute(OSD_CONSOLE_GREEN | OSD_CONSOLE_INTENSITY);
-						if(target->debug_dasm(target->get_next_pc(), target->get_next_eip(), buffer, array_length(buffer)) != 0) {
+						if(target->debug_dasm(target->get_next_pc(), buffer, array_length(buffer)) != 0) {
 							my_printf(p->osd, _T("next\t%s  %s\n"), my_get_value_and_symbol(target, _T("%08X"), target->get_next_pc()), buffer);
 						}
 						if(target->get_debug_regs_info(buffer, array_length(buffer))) {
@@ -1079,7 +1074,7 @@
 						cpu_debugger->restore_break_points();
 					}
 					p->osd->set_console_text_attribute(OSD_CONSOLE_GREEN | OSD_CONSOLE_BLUE | OSD_CONSOLE_INTENSITY);
-					cpu->debug_dasm(cpu->get_next_pc(), cpu->get_next_eip(), buffer, array_length(buffer));
+					cpu->debug_dasm(cpu->get_next_pc(), buffer, array_length(buffer));
 					my_printf(p->osd, _T("next\t%s  %s\n"), my_get_value_and_symbol(cpu, _T("%08X"), cpu->get_next_pc()), buffer);
 					p->osd->set_console_text_attribute(OSD_CONSOLE_RED | OSD_CONSOLE_GREEN | OSD_CONSOLE_BLUE | OSD_CONSOLE_INTENSITY);
 				} else {
@@ -1104,11 +1099,10 @@
 						}
 						if(target == cpu) {
 							dasm_addr = cpu->get_next_pc();
-							dasm_eip = cpu->get_next_eip();
 						}
 						
 						p->osd->set_console_text_attribute(OSD_CONSOLE_GREEN | OSD_CONSOLE_BLUE | OSD_CONSOLE_INTENSITY);
-						cpu->debug_dasm(cpu->get_pc(), cpu->get_eip(), buffer, array_length(buffer));
+						cpu->debug_dasm(cpu->get_pc(), buffer, array_length(buffer));
 						my_printf(p->osd, _T("done\t%s  %s\n"), my_get_value_and_symbol(cpu, _T("%08X"), cpu->get_pc()), buffer);
 						
 						p->osd->set_console_text_attribute(OSD_CONSOLE_RED | OSD_CONSOLE_GREEN | OSD_CONSOLE_BLUE | OSD_CONSOLE_INTENSITY);
@@ -1118,7 +1112,7 @@
 						
 						if(target != cpu) {
 							p->osd->set_console_text_attribute(OSD_CONSOLE_GREEN | OSD_CONSOLE_INTENSITY);
-							if(target->debug_dasm(target->get_next_pc(), target->get_next_eip(), buffer, array_length(buffer)) != 0) {
+							if(target->debug_dasm(target->get_next_pc(), buffer, array_length(buffer)) != 0) {
 								my_printf(p->osd, _T("next\t%s  %s\n"), my_get_value_and_symbol(target, _T("%08X"), target->get_next_pc()), buffer);
 							}
 							if(target->get_debug_regs_info(buffer, array_length(buffer))) {
@@ -1136,7 +1130,7 @@
 						}
 					}
 					p->osd->set_console_text_attribute(OSD_CONSOLE_GREEN | OSD_CONSOLE_BLUE | OSD_CONSOLE_INTENSITY);
-					cpu->debug_dasm(cpu->get_next_pc(), cpu->get_next_eip(), buffer, array_length(buffer));
+					cpu->debug_dasm(cpu->get_next_pc(), buffer, array_length(buffer));
 					my_printf(p->osd, _T("next\t%s  %s\n"), my_get_value_and_symbol(cpu, _T("%08X"), cpu->get_next_pc()), buffer);
 					p->osd->set_console_text_attribute(OSD_CONSOLE_RED | OSD_CONSOLE_GREEN | OSD_CONSOLE_BLUE | OSD_CONSOLE_INTENSITY);
 				} else {
@@ -1249,7 +1243,6 @@
 								}
 								dump_addr = 0;
 								dasm_addr = target->get_next_pc();
-								dasm_eip = target->get_next_eip();
 							}
 						} else {
 							my_printf(p->osd, _T("device not found\n"));
@@ -1308,7 +1301,6 @@
 								}
 								dump_addr = 0;
 								dasm_addr = cpu->get_next_pc();
-								dasm_eip = cpu->get_next_eip();
 								
 								p->osd->set_console_text_attribute(OSD_CONSOLE_RED | OSD_CONSOLE_GREEN | OSD_CONSOLE_BLUE | OSD_CONSOLE_INTENSITY);
 								if(cpu->get_debug_regs_info(buffer, array_length(buffer))) {
@@ -1319,7 +1311,7 @@
 								my_printf(p->osd, _T("breaked at %s\n"), my_get_value_and_symbol(cpu, _T("%08X"), cpu->get_next_pc()));
 								
 								p->osd->set_console_text_attribute(OSD_CONSOLE_GREEN | OSD_CONSOLE_BLUE | OSD_CONSOLE_INTENSITY);
-								cpu->debug_dasm(cpu->get_next_pc(), cpu->get_next_eip(), buffer, array_length(buffer));
+								cpu->debug_dasm(cpu->get_next_pc(), buffer, array_length(buffer));
 								my_printf(p->osd, _T("next\t%s  %s\n"), my_get_value_and_symbol(cpu, _T("%08X"), cpu->get_next_pc()), buffer);
 								p->osd->set_console_text_attribute(OSD_CONSOLE_RED | OSD_CONSOLE_GREEN | OSD_CONSOLE_BLUE | OSD_CONSOLE_INTENSITY);
 							}
@@ -1377,12 +1369,11 @@
 							}
 							if(target == cpu) {
 								dasm_addr = cpu->get_next_pc();
-								dasm_eip = cpu->get_next_eip();
 							}
 							cpu_debugger->restore_break_points();
 							
 							p->osd->set_console_text_attribute(OSD_CONSOLE_GREEN | OSD_CONSOLE_BLUE | OSD_CONSOLE_INTENSITY);
-							cpu->debug_dasm(cpu->get_pc(), cpu->get_eip(), buffer, array_length(buffer));
+							cpu->debug_dasm(cpu->get_pc(), buffer, array_length(buffer));
 							my_printf(p->osd, _T("done\t%s  %s\n"), my_get_value_and_symbol(cpu, _T("%08X"), cpu->get_pc()), buffer);
 							
 							p->osd->set_console_text_attribute(OSD_CONSOLE_RED | OSD_CONSOLE_GREEN | OSD_CONSOLE_BLUE | OSD_CONSOLE_INTENSITY);
@@ -1392,7 +1383,7 @@
 							
 							if(target != cpu) {
 								p->osd->set_console_text_attribute(OSD_CONSOLE_GREEN | OSD_CONSOLE_INTENSITY);
-								if(target->debug_dasm(target->get_next_pc(), target->get_next_eip(), buffer, array_length(buffer)) != 0) {
+								if(target->debug_dasm(target->get_next_pc(), buffer, array_length(buffer)) != 0) {
 									my_printf(p->osd, _T("next\t%s  %s\n"), my_get_value_and_symbol(target, _T("%08X"), target->get_next_pc()), buffer);
 								}
 								if(target->get_debug_regs_info(buffer, array_length(buffer))) {
@@ -1403,7 +1394,7 @@
 							p->osd->set_console_text_attribute(OSD_CONSOLE_RED | OSD_CONSOLE_INTENSITY);
 							my_printf(p->osd, _T("breaked at %s\n"), my_get_value_and_symbol(cpu, _T("%08X"), cpu->get_next_pc()));
 							p->osd->set_console_text_attribute(OSD_CONSOLE_GREEN | OSD_CONSOLE_BLUE | OSD_CONSOLE_INTENSITY);
-							cpu->debug_dasm(cpu->get_next_pc(), cpu->get_next_eip(), buffer, array_length(buffer));
+							cpu->debug_dasm(cpu->get_next_pc(), buffer, array_length(buffer));
 							my_printf(p->osd, _T("next\t%s  %s\n"), my_get_value_and_symbol(cpu, _T("%08X"), cpu->get_next_pc()), buffer);
 							p->osd->set_console_text_attribute(OSD_CONSOLE_RED | OSD_CONSOLE_GREEN | OSD_CONSOLE_BLUE | OSD_CONSOLE_INTENSITY);
 						} else {
diff -ruN source/src/emu.cpp src/emu.cpp
--- source/src/emu.cpp	2022-12-22 16:30:00
+++ src/emu.cpp	2025-04-28 22:36:36
@@ -201,69 +201,94 @@
 
 int EMU::run()
 {
+    // printf("[EMU::run] --- start ---\n");
 #if defined(USE_DEBUGGER) && defined(USE_STATE)
-	if(request_save_state >= 0 || request_load_state >= 0) {
-		if(request_save_state >= 0) {
-			save_state(state_file_path(request_save_state));
-		} else {
-			load_state(state_file_path(request_load_state));
-		}
-		// NOTE: vm instance may be reinitialized in load_state
-		if(!is_debugger_enabled(debugger_cpu_index)) {
-			for(int i = 0; i < 8; i++) {
-				if(is_debugger_enabled(i)) {
-					debugger_cpu_index = i;
-					debugger_target_id = vm->get_cpu(debugger_cpu_index)->this_device_id;
-					break;
-				}
-			}
-		}
-		if(is_debugger_enabled(debugger_cpu_index)) {
-			if(!(vm->get_device(debugger_target_id) != NULL && vm->get_device(debugger_target_id)->get_debugger() != NULL)) {
-				debugger_target_id = vm->get_cpu(debugger_cpu_index)->this_device_id;
-			}
-			DEBUGGER *cpu_debugger = (DEBUGGER *)vm->get_cpu(debugger_cpu_index)->get_debugger();
-			cpu_debugger->now_going = false;
-			cpu_debugger->now_debugging = true;
-			debugger_thread_param.vm = vm;
-		} else {
-			close_debugger();
-		}
-		request_save_state = request_load_state = -1;
-	}
+    if(request_save_state >= 0 || request_load_state >= 0) {
+        // printf("[EMU::run] request_save_state=%d, request_load_state=%d\n", request_save_state, request_load_state);
+        if(request_save_state >= 0) {
+            // printf("[EMU::run] save_state ÈñãÂßã\n");
+            save_state(state_file_path(request_save_state));
+            // printf("[EMU::run] save_state ÁµÇ‰∫Ü\n");
+        } else {
+            // printf("[EMU::run] load_state ÈñãÂßã\n");
+            load_state(state_file_path(request_load_state));
+            // printf("[EMU::run] load_state ÁµÇ‰∫Ü\n");
+        }
+        // NOTE: vm instance may be reinitialized in load_state
+        if(!is_debugger_enabled(debugger_cpu_index)) {
+            // printf("[EMU::run] debugger_cpu_indexÁÑ°Âäπ„ÄÅÂÜçÊé¢Á¥¢\n");
+            for(int i = 0; i < 8; i++) {
+                if(is_debugger_enabled(i)) {
+                    debugger_cpu_index = i;
+                    debugger_target_id = vm->get_cpu(debugger_cpu_index)->this_device_id;
+                    // printf("[EMU::run] debugger_cpu_index=%d, debugger_target_id=%d\n", debugger_cpu_index, debugger_target_id);
+                    break;
+                }
+            }
+        }
+        if(is_debugger_enabled(debugger_cpu_index)) {
+            if(!(vm->get_device(debugger_target_id) != NULL && vm->get_device(debugger_target_id)->get_debugger() != NULL)) {
+                debugger_target_id = vm->get_cpu(debugger_cpu_index)->this_device_id;
+                // printf("[EMU::run] debugger_target_idÂÜçË®≠ÂÆö=%d\n", debugger_target_id);
+            }
+            DEBUGGER *cpu_debugger = (DEBUGGER *)vm->get_cpu(debugger_cpu_index)->get_debugger();
+            cpu_debugger->now_going = false;
+            cpu_debugger->now_debugging = true;
+            debugger_thread_param.vm = vm;
+            // printf("[EMU::run] „Éá„Éê„ÉÉ„Ç¨ÊúâÂäπÂåñ\n");
+        } else {
+            // printf("[EMU::run] „Éá„Éê„ÉÉ„Ç¨ÁÑ°ÂäπÂåñ\n");
+            close_debugger();
+        }
+        request_save_state = request_load_state = -1;
+        // printf("[EMU::run] „Çπ„ÉÜ„Éº„Éà„É™„ÇØ„Ç®„Çπ„Éà„É™„Çª„ÉÉ„Éà\n");
+    }
 #endif
-	if(now_suspended) {
-		osd->restore();
-		now_suspended = false;
-	}
-	osd->update_input();
+    if(now_suspended) {
+        // printf("[EMU::run] now_suspended: Âæ©Â∏∞Âá¶ÁêÜ\n");
+        osd->restore();
+        now_suspended = false;
+    }
+    // printf("[EMU::run] osd->update_input()\n");
+    osd->update_input();
 #ifdef USE_AUTO_KEY
-	update_auto_key();
+    // printf("[EMU::run] update_auto_key()\n");
+    update_auto_key();
 #endif
 #ifdef USE_JOYSTICK
-	update_joystick();
+    // printf("[EMU::run] update_joystick()\n");
+    update_joystick();
 #endif
-	
+
 #ifdef USE_SOCKET
 #if !defined(_USE_QT) // Temporally
-	osd->update_socket();
+    // printf("[EMU::run] osd->update_socket()\n");
+    osd->update_socket();
 #endif
 #endif
-	update_media();
-	
-	// virtual machine may be driven to fill sound buffer
-	int extra_frames = 0;
-	osd->update_sound(&extra_frames);
-	
-	// drive virtual machine
-	if(extra_frames == 0) {
-		osd->lock_vm();
-		vm->run();
-		extra_frames = 1;
-		osd->unlock_vm();
-	}
-	osd->add_extra_frames(extra_frames);
-	return extra_frames;
+    // printf("[EMU::run] update_media()\n");
+    update_media();
+
+    // virtual machine may be driven to fill sound buffer
+    int extra_frames = 0;
+    // printf("[EMU::run] osd->update_sound()\n");
+    osd->update_sound(&extra_frames);
+
+    // drive virtual machine
+    if(extra_frames == 0) {
+        // printf("[EMU::run] extra_frames==0: VMÈßÜÂãïÈñãÂßã\n");
+        osd->lock_vm();
+        // printf("[EMU::run] vm->run()Âëº„Å≥Âá∫„Åó\n");
+        vm->run();
+        extra_frames = 1;
+        // printf("[EMU::run] vm->run()ÁµÇ‰∫Ü\n");
+        osd->unlock_vm();
+        // printf("[EMU::run] VM„É≠„ÉÉ„ÇØËß£Èô§\n");
+    }
+    // printf("[EMU::run] osd->add_extra_frames(%d)\n", extra_frames);
+    osd->add_extra_frames(extra_frames);
+    // printf("[EMU::run] --- end --- Êàª„ÇäÂÄ§=%d\n", extra_frames);
+    return extra_frames;
 }
 
 void EMU::reset()
@@ -647,136 +672,136 @@
 };
 
 static const int auto_key_table_kana_base[][2] = {
-	{0xa1,	0x300 | 0xbe},	// '°'
-	{0xa2,	0x300 | 0xdb},	// '¢'
-	{0xa3,	0x300 | 0xdd},	// '£'
-	{0xa4,	0x300 | 0xbc},	// '§'
-	{0xa5,	0x300 | 0xbf},	// '•'
-	{0xa6,	0x300 | 0x30},	// '¶'
-	{0xa7,	0x300 | 0x33},	// 'ß'
-	{0xa8,	0x300 | 0x45},	// '®'
-	{0xa9,	0x300 | 0x34},	// '©'
-	{0xaa,	0x300 | 0x35},	// '™'
-	{0xab,	0x300 | 0x36},	// '´'
-	{0xac,	0x300 | 0x37},	// '¨'
-	{0xad,	0x300 | 0x38},	// '≠'
-	{0xae,	0x300 | 0x39},	// 'Æ'
-	{0xaf,	0x300 | 0x5a},	// 'Ø'
-	{0xb0,	0x200 | 0xdc},	// '∞'
-	{0xb1,	0x200 | 0x33},	// '±'
-	{0xb2,	0x200 | 0x45},	// '≤'
-	{0xb3,	0x200 | 0x34},	// '≥'
-	{0xb4,	0x200 | 0x35},	// '¥'
-	{0xb5,	0x200 | 0x36},	// 'µ'
-	{0xb6,	0x200 | 0x54},	// '∂'
-	{0xb7,	0x200 | 0x47},	// '∑'
-	{0xb8,	0x200 | 0x48},	// '∏'
-	{0xb9,	0x200 | 0xba},	// 'π'
-	{0xba,	0x200 | 0x42},	// '∫'
-	{0xbb,	0x200 | 0x58},	// 'ª'
-	{0xbc,	0x200 | 0x44},	// 'º'
-	{0xbd,	0x200 | 0x52},	// 'Ω'
-	{0xbe,	0x200 | 0x50},	// 'æ'
-	{0xbf,	0x200 | 0x43},	// 'ø'
-	{0xc0,	0x200 | 0x51},	// '¿'
-	{0xc1,	0x200 | 0x41},	// '¡'
-	{0xc2,	0x200 | 0x5a},	// '¬'
-	{0xc3,	0x200 | 0x57},	// '√'
-	{0xc4,	0x200 | 0x53},	// 'ƒ'
-	{0xc5,	0x200 | 0x55},	// '≈'
-	{0xc6,	0x200 | 0x49},	// '∆'
-	{0xc7,	0x200 | 0x31},	// '«'
-	{0xc8,	0x200 | 0xbc},	// '»'
-	{0xc9,	0x200 | 0x4b},	// '…'
-	{0xca,	0x200 | 0x46},	// ' '
-	{0xcb,	0x200 | 0x56},	// 'À'
-	{0xcc,	0x200 | 0x32},	// 'Ã'
-	{0xcd,	0x200 | 0xde},	// 'Õ'
-	{0xce,	0x200 | 0xbd},	// 'Œ'
-	{0xcf,	0x200 | 0x4a},	// 'œ'
-	{0xd0,	0x200 | 0x4e},	// '–'
-	{0xd1,	0x200 | 0xdd},	// '—'
-	{0xd2,	0x200 | 0xbf},	// '“'
-	{0xd3,	0x200 | 0x4d},	// '”'
-	{0xd4,	0x200 | 0x37},	// '‘'
-	{0xd5,	0x200 | 0x38},	// '’'
-	{0xd6,	0x200 | 0x39},	// '÷'
-	{0xd7,	0x200 | 0x4f},	// '◊'
-	{0xd8,	0x200 | 0x4c},	// 'ÿ'
-	{0xd9,	0x200 | 0xbe},	// 'Ÿ'
-	{0xda,	0x200 | 0xbb},	// '⁄'
-	{0xdb,	0x200 | 0xe2},	// '€'
-	{0xdc,	0x200 | 0x30},	// '‹'
-	{0xdd,	0x200 | 0x59},	// '›'
-	{0xde,	0x200 | 0xc0},	// 'ﬁ'
-	{0xdf,	0x200 | 0xdb},	// 'ﬂ'
+	{0xa1,	0x300 | 0xbe},	// 'ÔøΩ'
+	{0xa2,	0x300 | 0xdb},	// 'ÔøΩ'
+	{0xa3,	0x300 | 0xdd},	// 'ÔøΩ'
+	{0xa4,	0x300 | 0xbc},	// 'ÔøΩ'
+	{0xa5,	0x300 | 0xbf},	// 'ÔøΩ'
+	{0xa6,	0x300 | 0x30},	// 'ÔøΩ'
+	{0xa7,	0x300 | 0x33},	// 'ÔøΩ'
+	{0xa8,	0x300 | 0x45},	// 'ÔøΩ'
+	{0xa9,	0x300 | 0x34},	// 'ÔøΩ'
+	{0xaa,	0x300 | 0x35},	// 'ÔøΩ'
+	{0xab,	0x300 | 0x36},	// 'ÔøΩ'
+	{0xac,	0x300 | 0x37},	// 'ÔøΩ'
+	{0xad,	0x300 | 0x38},	// 'ÔøΩ'
+	{0xae,	0x300 | 0x39},	// 'ÔøΩ'
+	{0xaf,	0x300 | 0x5a},	// 'ÔøΩ'
+	{0xb0,	0x200 | 0xdc},	// 'ÔøΩ'
+	{0xb1,	0x200 | 0x33},	// 'ÔøΩ'
+	{0xb2,	0x200 | 0x45},	// 'ÔøΩ'
+	{0xb3,	0x200 | 0x34},	// 'ÔøΩ'
+	{0xb4,	0x200 | 0x35},	// 'ÔøΩ'
+	{0xb5,	0x200 | 0x36},	// 'ÔøΩ'
+	{0xb6,	0x200 | 0x54},	// 'ÔøΩ'
+	{0xb7,	0x200 | 0x47},	// 'ÔøΩ'
+	{0xb8,	0x200 | 0x48},	// 'ÔøΩ'
+	{0xb9,	0x200 | 0xba},	// 'ÔøΩ'
+	{0xba,	0x200 | 0x42},	// 'ÔøΩ'
+	{0xbb,	0x200 | 0x58},	// 'ÔøΩ'
+	{0xbc,	0x200 | 0x44},	// 'ÔøΩ'
+	{0xbd,	0x200 | 0x52},	// 'ÔøΩ'
+	{0xbe,	0x200 | 0x50},	// 'ÔøΩ'
+	{0xbf,	0x200 | 0x43},	// 'ÔøΩ'
+	{0xc0,	0x200 | 0x51},	// 'ÔøΩ'
+	{0xc1,	0x200 | 0x41},	// 'ÔøΩ'
+	{0xc2,	0x200 | 0x5a},	// 'ÔøΩ'
+	{0xc3,	0x200 | 0x57},	// 'ÔøΩ'
+	{0xc4,	0x200 | 0x53},	// 'ÔøΩ'
+	{0xc5,	0x200 | 0x55},	// 'ÔøΩ'
+	{0xc6,	0x200 | 0x49},	// 'ÔøΩ'
+	{0xc7,	0x200 | 0x31},	// 'ÔøΩ'
+	{0xc8,	0x200 | 0xbc},	// 'ÔøΩ'
+	{0xc9,	0x200 | 0x4b},	// 'ÔøΩ'
+	{0xca,	0x200 | 0x46},	// 'ÔøΩ'
+	{0xcb,	0x200 | 0x56},	// 'ÔøΩ'
+	{0xcc,	0x200 | 0x32},	// 'ÔøΩ'
+	{0xcd,	0x200 | 0xde},	// 'ÔøΩ'
+	{0xce,	0x200 | 0xbd},	// 'ÔøΩ'
+	{0xcf,	0x200 | 0x4a},	// 'ÔøΩ'
+	{0xd0,	0x200 | 0x4e},	// 'ÔøΩ'
+	{0xd1,	0x200 | 0xdd},	// 'ÔøΩ'
+	{0xd2,	0x200 | 0xbf},	// 'ÔøΩ'
+	{0xd3,	0x200 | 0x4d},	// 'ÔøΩ'
+	{0xd4,	0x200 | 0x37},	// 'ÔøΩ'
+	{0xd5,	0x200 | 0x38},	// 'ÔøΩ'
+	{0xd6,	0x200 | 0x39},	// 'ÔøΩ'
+	{0xd7,	0x200 | 0x4f},	// 'ÔøΩ'
+	{0xd8,	0x200 | 0x4c},	// 'ÔøΩ'
+	{0xd9,	0x200 | 0xbe},	// 'ÔøΩ'
+	{0xda,	0x200 | 0xbb},	// 'ÔøΩ'
+	{0xdb,	0x200 | 0xe2},	// 'ÔøΩ'
+	{0xdc,	0x200 | 0x30},	// 'ÔøΩ'
+	{0xdd,	0x200 | 0x59},	// 'ÔøΩ'
+	{0xde,	0x200 | 0xc0},	// 'ÔøΩ'
+	{0xdf,	0x200 | 0xdb},	// 'ÔøΩ'
 	{-1, -1},
 };
 
 static const int auto_key_table_50on_base[][2] = {
-	{0xa1,	0x300 | 0xbf},	// '°'
-	{0xa2,	0x300 | 0xdb},	// '¢'
-	{0xa3,	0x300 | 0xdd},	// '£'
-	{0xa4,	0x300 | 0xbe},	// '§'
-	{0xa5,	0x300 | 0xe2},	// '•'
-	{0xa6,	0x200 | 0xbf},	// '¶'
-	{0xa7,	0x300 | 0x31},	// 'ß'
-	{0xa8,	0x300 | 0x32},	// '®'
-	{0xa9,	0x300 | 0x33},	// '©'
-	{0xaa,	0x300 | 0x34},	// '™'
-	{0xab,	0x300 | 0x35},	// '´'
-	{0xac,	0x300 | 0x4e},	// '¨'
-	{0xad,	0x300 | 0x4d},	// '≠'
-	{0xae,	0x300 | 0xbc},	// 'Æ'
-	{0xaf,	0x300 | 0x43},	// 'Ø'
-	{0xb0,	0x300 | 0xba},	// '∞'
-	{0xb1,	0x200 | 0x31},	// '±'
-	{0xb2,	0x200 | 0x32},	// '≤'
-	{0xb3,	0x200 | 0x33},	// '≥'
-	{0xb4,	0x200 | 0x34},	// '¥'
-	{0xb5,	0x200 | 0x35},	// 'µ'
-	{0xb6,	0x200 | 0x51},	// '∂'
-	{0xb7,	0x200 | 0x57},	// '∑'
-	{0xb8,	0x200 | 0x45},	// '∏'
-	{0xb9,	0x200 | 0x52},	// 'π'
-	{0xba,	0x200 | 0x54},	// '∫'
-	{0xbb,	0x200 | 0x41},	// 'ª'
-	{0xbc,	0x200 | 0x53},	// 'º'
-	{0xbd,	0x200 | 0x44},	// 'Ω'
-	{0xbe,	0x200 | 0x46},	// 'æ'
-	{0xbf,	0x200 | 0x47},	// 'ø'
-	{0xc0,	0x200 | 0x5a},	// '¿'
-	{0xc1,	0x200 | 0x58},	// '¡'
-	{0xc2,	0x200 | 0x43},	// '¬'
-	{0xc3,	0x200 | 0x56},	// '√'
-	{0xc4,	0x200 | 0x42},	// 'ƒ'
-	{0xc5,	0x200 | 0x36},	// '≈'
-	{0xc6,	0x200 | 0x37},	// '∆'
-	{0xc7,	0x200 | 0x38},	// '«'
-	{0xc8,	0x200 | 0x39},	// '»'
-	{0xc9,	0x200 | 0x30},	// '…'
-	{0xca,	0x200 | 0x59},	// ' '
-	{0xcb,	0x200 | 0x55},	// 'À'
-	{0xcc,	0x200 | 0x49},	// 'Ã'
-	{0xcd,	0x200 | 0x4f},	// 'Õ'
-	{0xce,	0x200 | 0x50},	// 'Œ'
-	{0xcf,	0x200 | 0x48},	// 'œ'
-	{0xd0,	0x200 | 0x4a},	// '–'
-	{0xd1,	0x200 | 0x4b},	// '—'
-	{0xd2,	0x200 | 0x4c},	// '“'
-	{0xd3,	0x200 | 0xbb},	// '”'
-	{0xd4,	0x200 | 0x4e},	// '‘'
-	{0xd5,	0x200 | 0x4d},	// '’'
-	{0xd6,	0x200 | 0xbc},	// '÷'
-	{0xd7,	0x200 | 0xbd},	// '◊'
-	{0xd8,	0x200 | 0xde},	// 'ÿ'
-	{0xd9,	0x200 | 0xdc},	// 'Ÿ'
-	{0xda,	0x200 | 0xc0},	// '⁄'
-	{0xdb,	0x200 | 0xdb},	// '€'
-	{0xdc,	0x200 | 0xbe},	// '‹'
-	{0xdd,	0x200 | 0xe2},	// '›'
-	{0xde,	0x200 | 0xba},	// 'ﬁ'
-	{0xdf,	0x200 | 0xdd},	// 'ﬂ'
+	{0xa1,	0x300 | 0xbf},	// 'ÔøΩ'
+	{0xa2,	0x300 | 0xdb},	// 'ÔøΩ'
+	{0xa3,	0x300 | 0xdd},	// 'ÔøΩ'
+	{0xa4,	0x300 | 0xbe},	// 'ÔøΩ'
+	{0xa5,	0x300 | 0xe2},	// 'ÔøΩ'
+	{0xa6,	0x200 | 0xbf},	// 'ÔøΩ'
+	{0xa7,	0x300 | 0x31},	// 'ÔøΩ'
+	{0xa8,	0x300 | 0x32},	// 'ÔøΩ'
+	{0xa9,	0x300 | 0x33},	// 'ÔøΩ'
+	{0xaa,	0x300 | 0x34},	// 'ÔøΩ'
+	{0xab,	0x300 | 0x35},	// 'ÔøΩ'
+	{0xac,	0x300 | 0x4e},	// 'ÔøΩ'
+	{0xad,	0x300 | 0x4d},	// 'ÔøΩ'
+	{0xae,	0x300 | 0xbc},	// 'ÔøΩ'
+	{0xaf,	0x300 | 0x43},	// 'ÔøΩ'
+	{0xb0,	0x300 | 0xba},	// 'ÔøΩ'
+	{0xb1,	0x200 | 0x31},	// 'ÔøΩ'
+	{0xb2,	0x200 | 0x32},	// 'ÔøΩ'
+	{0xb3,	0x200 | 0x33},	// 'ÔøΩ'
+	{0xb4,	0x200 | 0x34},	// 'ÔøΩ'
+	{0xb5,	0x200 | 0x35},	// 'ÔøΩ'
+	{0xb6,	0x200 | 0x51},	// 'ÔøΩ'
+	{0xb7,	0x200 | 0x57},	// 'ÔøΩ'
+	{0xb8,	0x200 | 0x45},	// 'ÔøΩ'
+	{0xb9,	0x200 | 0x52},	// 'ÔøΩ'
+	{0xba,	0x200 | 0x54},	// 'ÔøΩ'
+	{0xbb,	0x200 | 0x41},	// 'ÔøΩ'
+	{0xbc,	0x200 | 0x53},	// 'ÔøΩ'
+	{0xbd,	0x200 | 0x44},	// 'ÔøΩ'
+	{0xbe,	0x200 | 0x46},	// 'ÔøΩ'
+	{0xbf,	0x200 | 0x47},	// 'ÔøΩ'
+	{0xc0,	0x200 | 0x5a},	// 'ÔøΩ'
+	{0xc1,	0x200 | 0x58},	// 'ÔøΩ'
+	{0xc2,	0x200 | 0x43},	// 'ÔøΩ'
+	{0xc3,	0x200 | 0x56},	// 'ÔøΩ'
+	{0xc4,	0x200 | 0x42},	// 'ÔøΩ'
+	{0xc5,	0x200 | 0x36},	// 'ÔøΩ'
+	{0xc6,	0x200 | 0x37},	// 'ÔøΩ'
+	{0xc7,	0x200 | 0x38},	// 'ÔøΩ'
+	{0xc8,	0x200 | 0x39},	// 'ÔøΩ'
+	{0xc9,	0x200 | 0x30},	// 'ÔøΩ'
+	{0xca,	0x200 | 0x59},	// 'ÔøΩ'
+	{0xcb,	0x200 | 0x55},	// 'ÔøΩ'
+	{0xcc,	0x200 | 0x49},	// 'ÔøΩ'
+	{0xcd,	0x200 | 0x4f},	// 'ÔøΩ'
+	{0xce,	0x200 | 0x50},	// 'ÔøΩ'
+	{0xcf,	0x200 | 0x48},	// 'ÔøΩ'
+	{0xd0,	0x200 | 0x4a},	// 'ÔøΩ'
+	{0xd1,	0x200 | 0x4b},	// 'ÔøΩ'
+	{0xd2,	0x200 | 0x4c},	// 'ÔøΩ'
+	{0xd3,	0x200 | 0xbb},	// 'ÔøΩ'
+	{0xd4,	0x200 | 0x4e},	// 'ÔøΩ'
+	{0xd5,	0x200 | 0x4d},	// 'ÔøΩ'
+	{0xd6,	0x200 | 0xbc},	// 'ÔøΩ'
+	{0xd7,	0x200 | 0xbd},	// 'ÔøΩ'
+	{0xd8,	0x200 | 0xde},	// 'ÔøΩ'
+	{0xd9,	0x200 | 0xdc},	// 'ÔøΩ'
+	{0xda,	0x200 | 0xc0},	// 'ÔøΩ'
+	{0xdb,	0x200 | 0xdb},	// 'ÔøΩ'
+	{0xdc,	0x200 | 0xbe},	// 'ÔøΩ'
+	{0xdd,	0x200 | 0xe2},	// 'ÔøΩ'
+	{0xde,	0x200 | 0xba},	// 'ÔøΩ'
+	{0xdf,	0x200 | 0xdd},	// 'ÔøΩ'
 	{-1, -1},
 };
 
@@ -1251,20 +1276,20 @@
 	} else if(code == 0) {
 		// end
 		if(codes[3] == 'n') {
-			set_auto_key_code(0xdd); // '›'
+			set_auto_key_code(0xdd); // 'ÔøΩ'
 		}
 		set_auto_key_code(0xf2);
 		memset(codes, 0, sizeof(codes));
 	} else if(code == 0x08 || code == 0x09 || code == 0x0d || code == 0x1b || code == 0x20) {
 		if(codes[3] == 'n') {
-			set_auto_key_code(0xdd); // '›'
+			set_auto_key_code(0xdd); // 'ÔøΩ'
 		}
 		set_auto_key_code(code);
 		memset(codes, 0, sizeof(codes));
 #ifdef USE_AUTO_KEY_NUMPAD
 	} else if(code >= 0x30 && code <= 0x39) {
 		if(codes[3] == 'n') {
-			set_auto_key_code(0xdd); // '›'
+			set_auto_key_code(0xdd); // 'ÔøΩ'
 		}
 		set_auto_key_code(code);
 		memset(codes, 0, sizeof(codes));
@@ -1277,13 +1302,13 @@
 		codes[4] = '\0';
 		
 		if(codes[2] == 'n' && !is_vowel(codes[3])) {
-			set_auto_key_code(0xdd); // '›'
+			set_auto_key_code(0xdd); // 'ÔøΩ'
 			if(codes[3] == 'n') {
 				memset(codes, 0, sizeof(codes));
 				return;
 			}
 		} else if(codes[2] == codes[3] && is_consonant(codes[3])) {
-			set_auto_key_code(0xaf); // 'Ø'
+			set_auto_key_code(0xaf); // 'ÔøΩ'
 			return;
 		}
 		for(int i = 0;; i++) {
diff -ruN source/src/emu.h src/emu.h
--- source/src/emu.h	2022-07-08 00:00:00
+++ src/emu.h	2025-04-28 22:36:36
@@ -9,6 +9,7 @@
 
 #ifndef _EMU_H_
 #define _EMU_H_
+#include "platform_types.h"
 
 // for debug
 //#define _DEBUG_LOG
@@ -29,16 +30,15 @@
 #include "config.h"
 #include "vm/vm.h"
 
-#if defined(_USE_QT)
+#if defined(_WIN32)
+#define OSD_WIN32
+#else
 #include <pthread.h>
+#endif
+#if defined(_USE_QT)
 #define OSD_QT
 #elif defined(_USE_SDL)
-#include <pthread.h>
 #define OSD_SDL
-#elif defined(_WIN32)
-#define OSD_WIN32
-#else
-// oops!
 #endif
 
 // OS dependent header files should be included in each osd.h
@@ -50,6 +50,10 @@
 #include "sdl/osd.h"
 #elif defined(OSD_WIN32)
 #include "win32/osd.h"
+#elif defined(OSD_SDL2)
+#include "sdl2/osd.h"
+#elif defined(OSD_RPI)
+#include "rpi/osd.h"
 #endif
 
 #ifdef USE_FLOPPY_DISK
@@ -402,7 +406,7 @@
 #elif defined(OSD_WIN32)
 	HANDLE hDebuggerThread;
 #else
-	int debugger_thread_id;
+	pthread_t debugger_thread_id;
 #endif
 	void start_waiting_in_debugger();
 	void finish_waiting_in_debugger();
@@ -433,7 +437,9 @@
 		_TCHAR disk_name[MAX_D88_BANKS][128];	// may convert to UTF-8
 		int bank_num;
 		int cur_bank;
+#ifdef USE_FLOPPY_DISK
 	} d88_file[USE_FLOPPY_DISK];
+#endif
 	bool create_blank_floppy_disk(const _TCHAR* file_path, uint8_t type);
 	void open_floppy_disk(int drv, const _TCHAR* file_path, int bank);
 	void close_floppy_disk(int drv);
diff -ruN source/src/fifo.cpp src/fifo.cpp
--- source/src/fifo.cpp	2018-10-14 22:30:00
+++ src/fifo.cpp	2025-04-28 22:36:36
@@ -8,14 +8,13 @@
 */
 
 #include <stdlib.h>
-#include <malloc.h> 
 #include "fifo.h"
 #include "fileio.h"
 
-FIFO::FIFO(int s)
+FIFO::FIFO(int32_t s)
 {
 	size = s;
-	buf = (int*)malloc(size * sizeof(int));
+	buf = (int32_t*)malloc(size * sizeof(int32_t));
 	cnt = rpt = wpt = 0;
 }
 
diff -ruN source/src/fifo.h src/fifo.h
--- source/src/fifo.h	2018-10-05 00:00:00
+++ src/fifo.h	2025-04-28 22:36:36
@@ -15,11 +15,11 @@
 class DLL_PREFIX FIFO
 {
 private:
-	int size;
-	int* buf;
-	int cnt, rpt, wpt;
+	int32_t size;
+	int32_t* buf;
+	int32_t cnt, rpt, wpt;
 public:
-	FIFO(int s);
+	FIFO(int32_t s);
 	void release();
 	void clear();
 	void write(int val);
diff -ruN source/src/fileio.cpp src/fileio.cpp
--- source/src/fileio.cpp	2022-04-05 20:50:00
+++ src/fileio.cpp	2025-04-28 22:36:36
@@ -7,6 +7,7 @@
 	[ file i/o ]
 */
 
+#include <unistd.h>
 #if defined(_USE_QT) || defined(_USE_SDL)
 	#include <stdarg.h>
 	#include <fcntl.h>
@@ -96,6 +97,14 @@
 		return false;
 	}
 	return ((attr & FILE_ATTRIBUTE_DIRECTORY) == 0);
+#elif defined(OSD_STUB) || defined(OSD_RPI)
+	// „Éô„Ç¢„É°„Çø„É´Áí∞Â¢ÉÁî®
+	FILE *f = fopen(file_path, "r");
+	if(f != NULL) {
+		fclose(f);
+		return true;
+	}
+	return false;
 #else
 	return (_taccess(file_path, 0) == 0);
 #endif
@@ -117,6 +126,14 @@
 	return false;
 #elif defined(_WIN32)
 	return ((GetFileAttributes(file_path) & FILE_ATTRIBUTE_READONLY) != 0);
+#elif defined(OSD_STUB) || defined(OSD_RPI)
+	// „Éô„Ç¢„É°„Çø„É´Áí∞Â¢ÉÁî®
+	FILE *f = fopen(file_path, "a");
+	if(f == NULL) {
+		return true;
+	}
+	fclose(f);
+	return false;
 #else
 	return (_taccess(file_path, 2) != 0);
 #endif
@@ -1077,6 +1094,16 @@
 	}
 }
 
+// void FILEIO::StateValue(uint &val)
+// {
+// 	if(open_mode == FILEIO_READ_BINARY) {
+// 		val = (uint)FgetUint32_LE();
+// 	} else {
+// 		FputUint32_LE((uint32_t)val);
+// 	}
+// }
+
+
 void FILEIO::StateValue(uint64_t &val)
 {
 	if(open_mode == FILEIO_READ_BINARY) {
@@ -1113,6 +1140,26 @@
 	}
 }
 
+#ifdef ENV32BIT
+void FILEIO::StateValue(int &val)
+{
+	if(open_mode == FILEIO_READ_BINARY) {
+		val = (int)FgetInt32_LE();
+	} else {
+		FputInt32_LE((int32_t)val);
+	}
+}
+
+void FILEIO::StateValue(unsigned int &val)
+{
+	if(open_mode == FILEIO_READ_BINARY) {
+		val = (unsigned int)FgetUint32_LE();
+	} else {
+		FputUint32_LE((uint32_t)val);
+	}
+}
+#endif
+
 void FILEIO::StateValue(int64_t &val)
 {
 	if(open_mode == FILEIO_READ_BINARY) {
@@ -1185,6 +1232,7 @@
 	}
 }
 
+
 void FILEIO::StateArray(bool *buffer, size_t size, size_t count)
 {
 	for(unsigned int i = 0; i < size / sizeof(buffer[0]) * count; i++) {
@@ -1212,6 +1260,22 @@
 		StateValue(buffer[i]);
 	}
 }
+
+#ifdef ENV32BIT
+void FILEIO::StateArray(int *buffer, size_t size, size_t count)
+{
+	for(unsigned int i = 0; i < size / sizeof(buffer[0]) * count; i++) {
+		StateValue(buffer[i]);
+	}
+}
+
+void FILEIO::StateArray(unsigned int *buffer, size_t size, size_t count)
+{
+	for(unsigned int i = 0; i < size / sizeof(buffer[0]) * count; i++) {
+		StateValue(buffer[i]);
+	}
+}
+#endif
 
 void FILEIO::StateArray(uint64_t *buffer, size_t size, size_t count)
 {
diff -ruN source/src/fileio.h src/fileio.h
--- source/src/fileio.h	2022-04-05 20:50:00
+++ src/fileio.h	2025-04-28 22:36:36
@@ -170,6 +170,11 @@
 	void StateValue(double &val);
 	void StateValue(char &val);
 	void StateValue(wchar_t &val);
+#ifdef ENV32BIT
+	void StateValue(int &val);
+	void StateValue(unsigned int &val);
+#endif
+	// void StateValue(uint &val);
 	
 	void StateArray(bool *buffer, size_t size, size_t count);
 	void StateArray(uint8_t *buffer, size_t size, size_t count);
@@ -187,7 +192,11 @@
 	void StateArray(double *buffer, size_t size, size_t count);
 	void StateArray(char *buffer, size_t size, size_t count);
 	void StateArray(wchar_t *buffer, size_t size, size_t count);
-	
+#ifdef ENV32BIT
+	void StateArray(int *buffer, size_t size, size_t count);
+	void StateArray(unsigned int *buffer, size_t size, size_t count);
+#endif
+
 	// obsolete function
 	void StateBuffer(void *buffer, size_t size, size_t count);
 };
diff -ruN source/src/platform_types.h src/platform_types.h
--- source/src/platform_types.h	1970-01-01 09:00:00
+++ src/platform_types.h	2025-04-28 22:36:36
@@ -0,0 +1,124 @@
+#ifndef PLATFORM_TYPES_H
+#define PLATFORM_TYPES_H
+
+/* 
+ * Windows‰æùÂ≠òÂûã„ÅÆ‰∏ÄÂÖÉÁÆ°ÁêÜ„Éò„ÉÉ„ÉÄ
+ * WindowsÁí∞Â¢É„Åß„ÅØ windows.h „Çíinclude
+ * ÈùûWindowsÁí∞Â¢É„Åß„ÅØ„ÉÄ„Éü„ÉºÂÆöÁæ©
+ */
+
+#if defined(_WIN32) || defined(_WIN64)
+  // WindowsÁí∞Â¢É
+  #include <windows.h>
+  // DirectInput, DirectSound, Direct3D „Å™„Å©ÂøÖË¶Å„Å´Âøú„Åò„Å¶ËøΩÂä†
+  #include <dinput.h>
+  #include <dsound.h>
+  #include <d3d9.h>
+  #include <vfw.h>
+  #include <initguid.h>
+  // ÂøÖË¶Å„Å´Âøú„Åò„Å¶‰ªñ„ÅÆCOM„Ç§„É≥„Çø„Éº„Éï„Çß„Éº„Çπ„ÇÇ
+#else
+  // ÈùûWindowsÁí∞Â¢É: „ÉÄ„Éü„ÉºÂûãÂÆöÁæ©
+  #include <stdint.h>
+  #ifndef LONG_PTR
+    typedef intptr_t LONG_PTR;
+  #endif
+  typedef void* HDC;
+  typedef void* HWND;
+  typedef void* HANDLE;
+  typedef void* HBITMAP;
+  typedef void* HFONT;
+  typedef void* HPEN;
+  typedef void* HINSTANCE;
+  typedef void* LPDIRECTINPUT8;
+  typedef void* LPDIRECTINPUTDEVICE8;
+  typedef void* LPDIRECTINPUT;
+  typedef void* LPDIRECTINPUTDEVICE;
+  typedef void* LPDIRECTSOUND;
+  typedef void* LPDIRECTSOUNDBUFFER;
+  typedef void* LPDIRECT3D9;
+  typedef void* LPDIRECT3DDEVICE9;
+  typedef void* LPDIRECT3DSURFACE9;
+  typedef void* LPBITMAPINFO;
+  typedef void* LPBITMAPINFOHEADER;
+  typedef void* PAVIFILE;
+  typedef void* PAVISTREAM;
+  typedef void* IMediaSample;
+  typedef void* IGraphBuilder;
+  typedef void* IBaseFilter;
+  typedef void* ICaptureGraphBuilder2;
+  typedef void* ISampleGrabber;
+  typedef void* IMediaControl;
+  typedef void* IMediaSeeking;
+  typedef void* IMediaPosition;
+  typedef void* IVideoWindow;
+  typedef void* IBasicVideo;
+  typedef void* IBasicAudio;
+  typedef void* LPBYTE;
+  typedef void* LPVOID;
+  typedef void* SOCKET;
+  typedef void* ULONG_PTR;
+  typedef void* ID2D1Factory;
+  typedef void* ID2D1DCRenderTarget;
+  typedef void* ID2D1HwndRenderTarget;
+  typedef void* ID2D1Bitmap;
+   #ifndef CALLBACK
+   #define CALLBACK
+   #endif
+
+
+  typedef struct {} sockaddr_in;
+  typedef struct {} AVICOMPRESSOPTIONS;
+  typedef struct {} CLSID;
+  typedef struct {} IID;
+
+  typedef uint32_t DWORD;
+  typedef int LONG;
+  typedef unsigned int UINT;
+  typedef int BOOL;
+  typedef unsigned char BYTE;
+  typedef unsigned short WORD;
+  typedef char _TCHAR;
+//  #define _MAX_PATH 260
+
+  // --- ËøΩÂä†: WindowsÂõ∫ÊúâÂûã„Éª„Éû„ÇØ„É≠„ÅÆ„ÉÄ„Éü„ÉºÂÆöÁæ© ---
+  typedef int HMENU;
+  typedef int HDROP;
+  typedef int LRESULT;
+  typedef int WPARAM;
+  typedef int LPARAM;
+  #define WINAPI
+// DirectShow/COMÈñ¢ÈÄ£
+#if defined(USE_MOVIE_PLAYER) || defined(USE_VIDEO_CAPTURE)
+typedef struct {} ISampleGrabberCB;
+typedef struct {} ISampleGrabber;
+#endif
+
+// --- ËøΩÂä†: VK_Á≥ª„Ç≠„Éº„Ç≥„Éº„Éâ„ÅÆ„ÉÄ„Éü„ÉºÂÆöÁæ©ÔºàÈùûWindowsÁí∞Â¢ÉÔºâ ---
+#ifndef VK_LSHIFT
+#define VK_LSHIFT 0xA0
+#endif
+#ifndef VK_INSERT
+#define VK_INSERT   0x2D
+#endif
+#ifndef VK_SHIFT
+#define VK_SHIFT    0x10
+#endif
+#ifndef VK_DELETE
+#define VK_DELETE   0x2E
+#endif
+#ifndef VK_BACK
+#define VK_BACK     0x08
+#endif
+#ifndef VK_CAPITAL
+#define VK_CAPITAL  0x14
+#endif
+#ifndef VK_KANA
+#define VK_KANA     0x15
+#endif
+
+#define VK_ESCAPE 0x1B
+
+#endif
+
+#endif // PLATFORM_TYPES_H
\ No newline at end of file
diff -ruN source/src/rpi/osd.cpp src/rpi/osd.cpp
--- source/src/rpi/osd.cpp	1970-01-01 09:00:00
+++ src/rpi/osd.cpp	2025-04-28 22:36:36
@@ -0,0 +1,41 @@
+/*
+    Stub source for osd.cpp
+    This file is auto-generated to avoid Windows dependency.
+*/
+
+#include "osd.h"
+#include <stdarg.h> // ÂèØÂ§âÂºïÊï∞„ÅÆ„Åü„ÇÅ„Å´ËøΩÂä†
+#include "../emu.h"
+
+void OSD::initialize(int rate, int samples)
+{
+    initialize_console();
+    initialize_input();
+    initialize_screen();
+    initialize_sound(rate, samples);
+}
+
+void OSD::release()
+{
+}
+
+void OSD::power_off() {}
+void OSD::suspend() {}
+void OSD::restore() {}
+void OSD::lock_vm() {}
+void OSD::unlock_vm() {}
+void OSD::force_unlock_vm() {}
+void OSD::sleep(uint32_t ms) { 
+    // ‰Ωï„ÇÇ„Åó„Å™„ÅÑ(„Åù„ÅÆ„ÅÜ„Å°„Å©„ÅÜ„Å´„Åã„Åô„Çã)
+}
+void OSD::start_waiting_in_debugger() {}
+void OSD::finish_waiting_in_debugger() {}
+void OSD::process_waiting_in_debugger() {}
+BOOL OSD::is_vm_locked() { return FALSE; }
+void OSD::key_lost_focus() {}
+BOOL WINAPI ctrl_c_handler(DWORD type) { return 0; }
+const _TCHAR *get_ttermpro_path() { return nullptr; }
+const _TCHAR *get_ttermpro_x86_path() { return nullptr; }
+const _TCHAR *get_putty_path() { return nullptr; }
+const _TCHAR *get_putty_x86_path() { return nullptr; }
+const _TCHAR *get_telnet_path() { return nullptr; }
diff -ruN source/src/rpi/osd.h src/rpi/osd.h
--- source/src/rpi/osd.h	1970-01-01 09:00:00
+++ src/rpi/osd.h	2025-04-28 22:36:36
@@ -0,0 +1,469 @@
+/*
+    Based on src/win32/osd.h
+*/
+
+#ifndef _RPI_OSD_H_
+#define _RPI_OSD_H_
+
+#include "../platform_types.h"
+#include "../vm/vm.h"
+//#include "../emu.h"
+#include "../common.h"
+#include "../config.h"
+
+#include <fatfs/ff.h>
+
+/* --- „Éû„ÇØ„É≠„ÉªÂÆöÊï∞ --- */
+#define _WIN32_WINNT        0x500
+#define DIRECTSOUND_VERSION 0x900
+#define DIRECT3D_VERSION    0x900
+#define DIRECTINPUT_VERSION 0x800
+
+#define WM_RESIZE  (0x0400 + 1)
+#define WM_SOCKET0 (0x0400 + 2)
+#define WM_SOCKET1 (0x0400 + 3)
+#define WM_SOCKET2 (0x0400 + 4)
+#define WM_SOCKET3 (0x0400 + 5)
+
+#ifdef USE_SOCKET
+#define SOCKET_MAX 4
+#define SOCKET_BUFFER_MAX 0x100000
+#endif
+
+#ifdef USE_VIDEO_CAPTURE
+#define MAX_CAPTURE_DEVS 8
+#endif
+
+#if defined(_WIN32) && !defined(_M_AMD64)
+#define SUPPORT_WIN32_DLL
+#endif
+
+#define SCREEN_FILTER_NONE 0
+#define SCREEN_FILTER_RGB  1
+#define SCREEN_FILTER_RF   2
+
+#define OSD_CONSOLE_BLUE      1
+#define OSD_CONSOLE_GREEN     2
+#define OSD_CONSOLE_RED       4
+#define OSD_CONSOLE_INTENSITY 8
+
+/* --- bitmap_tÊßãÈÄ†‰Ωì --- */
+typedef struct bitmap_s {
+    int width, height;
+    HDC hdcDib;
+    HBITMAP hBmp, hOldBmp;
+    LPBYTE lpBuf;
+    scrntype_t* lpBmp;
+    LPBITMAPINFO lpDib;
+#ifdef __cplusplus
+    inline bool initialized() const { return false; }
+    inline scrntype_t* get_buffer(int) { return nullptr; }
+#endif
+} bitmap_t;
+
+/* --- font_tÊßãÈÄ†‰Ωì --- */
+typedef struct font_s {
+    _TCHAR family[64];
+    int width, height, rotate;
+    BOOL bold, italic;
+    HFONT hFont;
+#ifdef __cplusplus
+    inline bool initialized() const { return false; }
+#endif
+} font_t;
+
+/* --- pen_tÊßãÈÄ†‰Ωì --- */
+typedef struct pen_s {
+    int width;
+    BYTE r, g, b;
+    HPEN hPen;
+#ifdef __cplusplus
+    inline bool initialized() const { return false; }
+#endif
+} pen_t;
+
+/* --- rec_video_thread_param_tÊßãÈÄ†‰Ωì --- */
+typedef struct {
+    PAVISTREAM pAVICompressed;
+    scrntype_t* lpBmp;
+    LPBITMAPINFOHEADER pbmInfoHeader;
+    DWORD dwAVIFileSize;
+    LONG lAVIFrames;
+    int frames;
+    int result;
+} rec_video_thread_param_t;
+
+#ifdef USE_MIDI
+typedef struct midi_thread_params_s {
+    void* send_buffer;
+    void* recv_buffer;
+    BOOL terminate;
+} midi_thread_params_t;
+#endif
+
+/* --- „ÇØ„É©„ÇπÂÆ£Ë®ÄÔºàÂâçÊñπÂÆ£Ë®ÄÔºâ --- */
+class FIFO;
+class FILEIO;
+class CScheduler;
+class CVCHIQSoundDevice;
+
+/* --- OSD„ÇØ„É©„ÇπÂÆöÁæ© --- */
+class OSD
+{
+private:
+    int lock_count;
+    void initialize_console();
+    void release_console();
+    HANDLE hStdIn, hStdOut;
+    int console_count;
+    void open_telnet(const _TCHAR* title);
+    void close_telnet();
+    void send_telnet(const char* buffer);
+    BOOL use_telnet, telnet_closed;
+    int svr_socket, cli_socket;
+    void initialize_input();
+    void release_input();
+    void initialize_midi();
+    void release_midi();
+    void send_to_midi(uint8_t data);
+    bool recv_from_midi(uint8_t *data);
+
+    BOOL dinput_key_available;
+    BYTE keycode_conv[256];
+    BYTE key_status[256];
+    BYTE key_dik[256];
+    BYTE key_dik_prev[256];
+    BOOL key_shift_pressed, key_shift_released;
+    BOOL key_caps_locked;
+    BOOL lost_focus;
+#ifdef USE_JOYSTICK
+    uint32_t joy_status[4];
+    int joy_num;
+    struct {
+        UINT wNumAxes;
+        DWORD dwXposLo, dwXposHi;
+        DWORD dwYposLo, dwYposHi;
+        DWORD dwZposLo, dwZposHi;
+        DWORD dwRposLo, dwRposHi;
+        DWORD dwUposLo, dwUposHi;
+        DWORD dwVposLo, dwVposHi;
+        DWORD dwButtonsMask;
+    } joy_caps[4];
+
+    BOOL joy_to_key_status[256];
+#endif
+#ifdef USE_MOUSE
+    int mouse_status[3];
+    BOOL mouse_enabled;
+#endif
+    void initialize_screen();
+    void release_screen();
+    void initialize_screen_buffer(bitmap_t *buffer, int width, int height, int mode);
+    void release_screen_buffer(bitmap_t *buffer);
+#ifdef USE_SCREEN_FILTER
+    void apply_rgb_filter_to_screen_buffer(bitmap_t *source, bitmap_t *dest);
+    void apply_rgb_filter_x3_y3(bitmap_t *source, bitmap_t *dest);
+    void apply_rgb_filter_x3_y2(bitmap_t *source, bitmap_t *dest);
+    void apply_rgb_filter_x2_y3(bitmap_t *source, bitmap_t *dest);
+    void apply_rgb_filter_x2_y2(bitmap_t *source, bitmap_t *dest);
+    void apply_rgb_filter_x1_y1(bitmap_t *source, bitmap_t *dest);
+#endif
+    void rotate_screen_buffer(bitmap_t *source, bitmap_t *dest);
+    void stretch_screen_buffer(bitmap_t *source, bitmap_t *dest);
+    int add_video_frames();
+public:
+    bitmap_t vm_screen_buffer;
+#ifdef USE_SCREEN_FILTER
+    bitmap_t filtered_screen_buffer;
+    bitmap_t tmp_filtered_screen_buffer;
+#endif
+    bitmap_t rotated_screen_buffer;
+    bitmap_t stretched_screen_buffer;
+    bitmap_t shrinked_screen_buffer;
+    bitmap_t reversed_screen_buffer;
+    bitmap_t video_screen_buffer;
+    bitmap_t* draw_screen_buffer;
+    int host_window_width, host_window_height;
+    BOOL host_window_mode;
+    int vm_screen_width, vm_screen_height;
+    int vm_window_width, vm_window_height;
+    int vm_window_width_aspect, vm_window_height_aspect;
+private:
+    int draw_screen_width, draw_screen_height;
+    ULONG_PTR gdiToken;
+    _TCHAR video_file_path[_MAX_PATH];
+
+    int rec_video_fps;
+    double rec_video_run_frames;
+    double rec_video_frames;
+    LPBITMAPINFO lpDibRec;
+    PAVIFILE pAVIFile;
+    PAVISTREAM pAVIStream;
+    PAVISTREAM pAVICompressed;
+    AVICOMPRESSOPTIONS AVIOpts;
+    DWORD dwAVIFileSize;
+    LONG lAVIFrames;
+    HANDLE hVideoThread;
+    rec_video_thread_param_t rec_video_thread_param;
+    BOOL first_draw_screen;
+    BOOL first_invalidate;
+    BOOL self_invalidate;
+    void initialize_sound(int rate, int samples);
+    void release_sound();
+    int sound_rate, sound_samples;
+    BOOL sound_available, sound_started, sound_muted;
+    LPDIRECTSOUND lpds;
+    LPDIRECTSOUNDBUFFER lpdsPrimaryBuffer, lpdsSecondaryBuffer;
+    BOOL sound_first_half;
+    _TCHAR sound_file_path[_MAX_PATH];
+    FILEIO* rec_sound_fio;
+    int rec_sound_bytes;
+    int rec_sound_buffer_ptr;
+#if defined(USE_MOVIE_PLAYER) || defined(USE_VIDEO_CAPTURE)
+    void initialize_video();
+    void release_video();
+    IGraphBuilder *pGraphBuilder;
+    IBaseFilter *pVideoBaseFilter;
+    IBaseFilter *pCaptureBaseFilter;
+    ICaptureGraphBuilder2 *pCaptureGraphBuilder2;
+    ISampleGrabber *pVideoSampleGrabber;
+    IBaseFilter *pSoundBaseFilter;
+    ISampleGrabber *pSoundSampleGrabber;
+    void* pSoundCallBack;
+    IMediaControl *pMediaControl;
+    IMediaSeeking *pMediaSeeking;
+    IMediaPosition *pMediaPosition;
+    IVideoWindow *pVideoWindow;
+    IBasicVideo *pBasicVideo;
+    IBasicAudio *pBasicAudio;
+    BOOL bTimeFormatFrame;
+    BOOL bVerticalReversed;
+    bitmap_t direct_show_screen_buffer;
+    bitmap_t direct_show_stretch_buffer;
+    int direct_show_width, direct_show_height;
+    BOOL direct_show_mute[2];
+    void get_video_buffer();
+    void mute_video_dev(bool l, bool r);
+    bool open_movie_file(const _TCHAR* file_path);
+    void close_movie_file();
+    void play_movie();
+    void stop_movie();
+    void pause_movie();
+    void set_cur_movie_frame(int frame, bool relative);
+    uint32_t get_cur_movie_frame();
+#endif
+
+    // --- SDL2ÂàùÊúüÂåñÈõõÂΩ¢ ---
+    // void initialize_sdl2();
+
+    // --- SDL2ÁµÇ‰∫ÜÈõõÂΩ¢ ---
+    // void release_sdl2();
+
+    // --- SDL2„Ç§„Éô„É≥„Éà„É´„Éº„ÉóÈõõÂΩ¢ ---
+    // void event_loop_sdl2();
+#ifdef USE_MOVIE_PLAYER
+    double movie_frame_rate;
+    int movie_sound_rate;
+#endif
+#ifdef USE_VIDEO_CAPTURE
+    void enum_capture_devs();
+    BOOL connect_capture_dev(int index, BOOL pin);
+    int cur_capture_dev_index;
+    int num_capture_devs;
+    _TCHAR capture_dev_name[MAX_CAPTURE_DEVS][256];
+#endif
+#ifdef USE_SOCKET
+    void initialize_socket();
+    void release_socket();
+    SOCKET soc[SOCKET_MAX];
+    BOOL is_tcp[SOCKET_MAX];
+    sockaddr_in udpaddr[SOCKET_MAX];
+    int socket_delay[SOCKET_MAX];
+    char recv_buffer[SOCKET_MAX][SOCKET_BUFFER_MAX];
+    int recv_r_ptr[SOCKET_MAX], recv_w_ptr[SOCKET_MAX];
+#endif
+#ifdef USE_MIDI
+    void initialize_midi();
+    void release_midi();
+    HANDLE hMidiThread;
+    midi_thread_params_t midi_thread_params;
+#endif
+public:
+    // --- „ÇΩ„Ç±„ÉÉ„ÉàÈñ¢ÈÄ£Èñ¢Êï∞Ôºàosd_socket.cppÂÆöÁæ©„Å®‰∏ÄËá¥Ôºâ ---
+    void initialize_socket();
+    void release_socket();
+    void notify_socket_connected(int ch);
+    void notify_socket_disconnected(int ch);
+    void update_socket();
+    bool initialize_socket_tcp(int ch);
+    bool initialize_socket_udp(int ch);
+    bool connect_socket(int ch, uint32_t ipaddr, int port);
+    void disconnect_socket(int ch);
+    bool listen_socket(int ch);
+    void send_socket_data_tcp(int ch);
+    void send_socket_data_udp(int ch, uint32_t ipaddr, int port);
+    void send_socket_data(int ch);
+    void recv_socket_data(int ch);
+    OSD() { lock_count = 0; }
+    ~OSD() {}
+	VM_TEMPLATE* vm;
+    void initialize(int rate, int samples);
+    void release();
+    void power_off();
+    void suspend();
+    void restore();
+    void lock_vm();
+    void unlock_vm();
+    BOOL is_vm_locked();
+    void force_unlock_vm();
+    void sleep(DWORD ms);
+    void start_waiting_in_debugger();
+    void finish_waiting_in_debugger();
+    void process_waiting_in_debugger();
+    void open_console(int width, int height, const _TCHAR* title);
+    void close_console();
+    unsigned int get_console_code_page();
+    void set_console_text_attribute(unsigned short attr);
+    void write_console(const _TCHAR* buffer, unsigned int length);
+    int read_console_input(_TCHAR* buffer, unsigned int length);
+    BOOL is_console_key_pressed(int vk);
+    BOOL is_console_closed();
+    void close_debugger_console();
+    void update_input();
+    void key_down(int code, bool extended, bool repeat);
+    void key_up(int code, bool extended);
+    void key_down_native(int code, bool repeat);
+    void key_up_native(int code);
+    void key_lost_focus();
+    void enable_mouse();
+    void disable_mouse();
+    void toggle_mouse();
+#ifdef USE_MOUSE
+    bool is_mouse_enabled() { return FALSE;}
+#endif
+    uint8_t* get_key_buffer()
+    {
+		return key_status;
+    }
+#ifdef USE_JOYSTICK
+    uint32_t* get_joy_buffer() { return joy_status; }
+#endif
+#ifdef USE_MOUSE
+    int* get_mouse_buffer() { return mouse_status; }
+#endif
+#ifdef USE_AUTO_KEY
+    BOOL now_auto_key;
+#endif
+    double get_window_mode_power(int mode);
+    int get_window_mode_width(int mode);
+    int get_window_mode_height(int mode);
+    void set_host_window_size(int window_width, int window_height, BOOL window_mode);
+    void set_vm_screen_size(int screen_width, int screen_height, int window_width, int window_height, int window_width_aspect, int window_height_aspect);
+    void set_vm_screen_lines(int lines);
+    int get_vm_window_width() { return vm_window_width; }
+    int get_vm_window_height() { return vm_window_height; }
+    int get_vm_window_width_aspect() { return vm_window_width_aspect; }
+    int get_vm_window_height_aspect() { return vm_window_height_aspect; }
+    scrntype_t* get_vm_screen_buffer(int y);
+	int draw_screen();
+#ifdef ONE_BOARD_MICRO_COMPUTER
+	void reload_bitmap()
+	{
+		first_invalidate = true;
+	}
+#endif
+    void capture_screen();
+    BOOL start_record_video(int fps);
+    void stop_record_video();
+    void restart_record_video();
+    void add_extra_frames(int extra_frames);
+    BOOL now_record_video;
+#ifdef USE_SCREEN_FILTER
+    BOOL screen_skip_line;
+#endif
+    void update_sound(int* extra_frames);
+    void mute_sound();
+    void stop_sound();
+    void start_record_sound();
+    void stop_record_sound();
+    void restart_record_sound();
+    BOOL now_record_sound;
+#ifdef _UNITY
+    short* get_sound_buffer();
+#endif
+#if defined(USE_MOVIE_PLAYER) || defined(USE_VIDEO_CAPTURE)
+    void get_video_buffer();
+    void mute_video_dev(BOOL l, BOOL r);
+#endif
+#ifdef USE_MOVIE_PLAYER
+    BOOL open_movie_file(const _TCHAR* file_path);
+    void close_movie_file();
+    void play_movie();
+    void stop_movie();
+    void pause_movie();
+    double get_movie_frame_rate() { return movie_frame_rate; }
+    int get_movie_sound_rate() { return movie_sound_rate; }
+    void set_cur_movie_frame(int frame, BOOL relative);
+    DWORD get_cur_movie_frame();
+    BOOL now_movie_play, now_movie_pause;
+#endif
+#ifdef USE_VIDEO_CAPTURE
+    int get_cur_capture_dev_index() { return cur_capture_dev_index; }
+    int get_num_capture_devs() { return num_capture_devs; }
+    _TCHAR* get_capture_dev_name(int index) { return capture_dev_name[index]; }
+    void open_capture_dev(int index, BOOL pin);
+    void close_capture_dev();
+    void show_capture_dev_filter();
+    void show_capture_dev_pin();
+    void show_capture_dev_source();
+    void set_capture_dev_channel(int ch);
+#endif
+#ifdef USE_PRINTER
+    void create_bitmap(bitmap_t *bitmap, int width, int height);
+    void release_bitmap(bitmap_t *bitmap);
+    void create_font(font_t *font, const _TCHAR *family, int width, int height, int rotate, BOOL bold, BOOL italic);
+    void release_font(font_t *font);
+    void create_pen(pen_t *pen, int width, BYTE r, BYTE g, BYTE b);
+    void release_pen(pen_t *pen);
+    void clear_bitmap(bitmap_t *bitmap, BYTE r, BYTE g, BYTE b);
+    int get_text_width(bitmap_t *bitmap, font_t *font, const char *text);
+    void draw_text_to_bitmap(bitmap_t *bitmap, font_t *font, int x, int y, const char *text, BYTE r, BYTE g, BYTE b);
+    void draw_line_to_bitmap(bitmap_t *bitmap, pen_t *pen, int sx, int sy, int ex, int ey);
+    void draw_rectangle_to_bitmap(bitmap_t *bitmap, int x, int y, int width, int height, BYTE r, BYTE g, BYTE b);
+    void draw_point_to_bitmap(bitmap_t *bitmap, int x, int y, BYTE r, BYTE g, BYTE b);
+    void stretch_bitmap(bitmap_t *dest, int dest_x, int dest_y, int dest_width, int dest_height, bitmap_t *source, int source_x, int source_y, int source_width, int source_height);
+#endif
+    void write_bitmap_to_file(bitmap_t *bitmap, const _TCHAR *file_path);
+#ifdef USE_SOCKET
+    SOCKET get_socket(int ch) { return soc[ch]; }
+    void notify_socket_connected(int ch);
+    void notify_socket_disconnected(int ch);
+    void update_socket();
+    BOOL initialize_socket_tcp(int ch);
+    BOOL initialize_socket_udp(int ch);
+    BOOL connect_socket(int ch, DWORD ipaddr, int port);
+    void disconnect_socket(int ch);
+    BOOL listen_socket(int ch);
+    void send_socket_data_tcp(int ch);
+    void send_socket_data_udp(int ch, DWORD ipaddr, int port);
+    void send_socket_data(int ch);
+    void recv_socket_data(int ch);
+#endif
+#ifdef USE_MIDI
+    void send_to_midi(BYTE data);
+    BOOL recv_from_midi(BYTE *data);
+#endif
+    void invalidate_screen();
+    void update_screen(HDC hdc);
+    HWND main_window_handle;
+    HINSTANCE instance_handle;
+    BOOL vista_or_later;
+};
+
+#if defined(USE_MOVIE_PLAYER) || defined(USE_VIDEO_CAPTURE)
+class CMySampleGrabberCB {};
+#endif
+#include "../platform_types.h"
+
+
+#endif /* _RPI_OSD_H_ */
diff -ruN source/src/rpi/osd_console.cpp src/rpi/osd_console.cpp
--- source/src/rpi/osd_console.cpp	1970-01-01 09:00:00
+++ src/rpi/osd_console.cpp	2025-04-28 22:36:36
@@ -0,0 +1,24 @@
+/*
+    Stub implementation for osd_console.cpp
+    This file is auto-generated to avoid Windows dependency.
+*/
+
+#include "osd.h"
+
+// OSD class member functions (empty implementation)
+void OSD::initialize_console() {}
+void OSD::release_console() {}
+void OSD::open_console(int width, int height, const _TCHAR* title) {}
+void OSD::close_console() {}
+unsigned int OSD::get_console_code_page() { return 0; }
+void OSD::set_console_text_attribute(unsigned short attr) {}
+void OSD::write_console(const _TCHAR* buffer, unsigned int length) {}
+int OSD::read_console_input(_TCHAR* buffer, unsigned int length) { return 0; }
+BOOL OSD::is_console_key_pressed(int vk) { return FALSE; }
+BOOL OSD::is_console_closed() { return FALSE; }
+void OSD::close_debugger_console() {}
+void OSD::open_telnet(const _TCHAR* title) {}
+void OSD::close_telnet() {}
+void OSD::send_telnet(const char* string) {}
+
+// Global functions (empty implementation)
\ No newline at end of file
diff -ruN source/src/rpi/osd_input.cpp src/rpi/osd_input.cpp
--- source/src/rpi/osd_input.cpp	1970-01-01 09:00:00
+++ src/rpi/osd_input.cpp	2025-04-28 22:36:36
@@ -0,0 +1,562 @@
+// Circle-StdLibÁî® osd_input.cpp - „Ç≠„ÉºÂÖ•ÂäõÂá¶ÁêÜÂÆüË£Ö
+#include "osd.h"
+#include "../fifo.h"
+
+extern config_t config;
+
+// „Ç∏„Éß„Ç§„Çπ„ÉÜ„Ç£„ÉÉ„ÇØ„ÅÆÁä∂ÊÖã„Çí‰øùÊåÅ„Åô„Çã„Ç∞„É≠„Éº„Éê„É´Â§âÊï∞
+// „Åì„ÅÆÂ§âÊï∞„ÅØkernel.cpp„ÅÆ„Ç≤„Éº„É†„Éë„ÉÉ„Éâ„Éè„É≥„Éâ„É©„Åã„ÇâÊõ¥Êñ∞„Åï„Çå„Çã
+extern uint32_t rpi_gamepad_status[4];
+
+// Define Windows key constants that we'll use
+#define VK_SHIFT     0x10
+#define VK_CONTROL   0x11
+#define VK_MENU      0x12
+#define VK_CAPITAL   0x14
+#define VK_KANA      0x15
+#define VK_KANJI     0x19
+#define VK_ESCAPE    0x1B
+#define VK_SPACE     0x20
+#define VK_PRIOR     0x21
+#define VK_NEXT      0x22
+#define VK_END       0x23
+#define VK_HOME      0x24
+#define VK_LEFT      0x25
+#define VK_UP        0x26
+#define VK_RIGHT     0x27
+#define VK_DOWN      0x28
+#define VK_INSERT    0x2D
+#define VK_DELETE    0x2E
+#define VK_LSHIFT    0xA0
+#define VK_RSHIFT    0xA1
+#define VK_LCONTROL  0xA2
+#define VK_RCONTROL  0xA3
+#define VK_LMENU     0xA4
+#define VK_RMENU     0xA5
+#define VK_NUMPAD0   0x60
+#define VK_NUMPAD1   0x61
+#define VK_NUMPAD2   0x62
+#define VK_NUMPAD3   0x63
+#define VK_NUMPAD4   0x64
+#define VK_NUMPAD5   0x65
+#define VK_NUMPAD6   0x66
+#define VK_NUMPAD7   0x67
+#define VK_NUMPAD8   0x68
+#define VK_NUMPAD9   0x69
+#define VK_CLEAR     0x0C
+
+// Constants for handling key states (from win32 version)
+#define KEY_KEEP_FRAMES 2
+
+void OSD::initialize_input()
+{
+    // initialize status
+    memset(key_status, 0, sizeof(key_status));
+#ifdef USE_JOYSTICK
+    memset(joy_status, 0, sizeof(joy_status));
+    memset(joy_to_key_status, 0, sizeof(joy_to_key_status));
+#endif
+#ifdef USE_MOUSE
+    memset(mouse_status, 0, sizeof(mouse_status));
+#endif
+    
+    // initialize keycode convert table
+    FILEIO* fio = new FILEIO();
+    if(fio->Fopen(create_local_path(_T("keycode.cfg")), FILEIO_READ_BINARY)) {
+        fio->Fread(keycode_conv, sizeof(keycode_conv), 1);
+        fio->Fclose();
+    } else {
+        for(int i = 0; i < 256; i++) {
+            keycode_conv[i] = i;
+        }
+    }
+    delete fio;
+    
+    key_shift_pressed = key_shift_released = false;
+    key_caps_locked = false; // Caps Lock„ÅÆÂàùÊúüÁä∂ÊÖã
+    
+    lost_focus = false;
+}
+
+void OSD::release_input()
+{
+#ifdef USE_MOUSE
+    // release mouse
+    if(mouse_enabled) {
+        disable_mouse();
+    }
+#endif
+}
+
+void OSD::update_input()
+{
+#ifdef USE_AUTO_KEY
+    if(!now_auto_key && !config.romaji_to_kana) {
+#endif
+        // Win32Áâà„Å®ÂêåÊßò„ÅÆÂá¶ÁêÜ: NumPad„Ç≠„Éº„Å®„Ç∑„Éï„Éà„Ç≠„Éº„ÅÆÈÄ£ÂãïÂá¶ÁêÜ
+        
+        // „Ç≠„ÉºÁä∂ÊÖã„ÅÆÁ¢∫Ë™çÔºàRaspberryPiÁî®„ÅÆÂÆüË£ÖÔºâ
+        uint8_t numpad_keys = 0;
+        
+        // win32Áâà„Å®„ÅÆ‰∫íÊèõÊÄß: NumPad„Ç≠„Éº„ÅåÊäº„Åï„Çå„Å¶„ÅÑ„ÇãÈñì„ÅØ„Ç∑„Éï„Éà„Ç≠„Éº„Çí‰øùÊåÅ
+        if(numpad_keys & 0x80) {
+            // „Ç∑„Éï„Éà„Ç≠„Éº„ÅÆÁä∂ÊÖã„Çí‰øùÊåÅ
+            if(!key_shift_pressed && !key_shift_released && key_status[VK_LSHIFT]) {
+                key_status[VK_LSHIFT] |= 0x80;
+            }
+            if(key_status[VK_RSHIFT]) {
+                key_status[VK_RSHIFT] |= 0x80;
+            }
+        }
+        
+        // win32Áâà„Å®„ÅÆ‰∫íÊèõÊÄß: „Ç∑„Éï„Éà„Ç≠„Éº„ÅÆÊõ¥Êñ∞Âá¶ÁêÜ
+        if(key_shift_pressed && !key_shift_released) {
+            if(key_status[VK_LSHIFT] == 0) {
+                // shift key is newly pressed
+                if(!key_status[VK_RSHIFT]) {
+                    vm->key_down(VK_SHIFT, false);
+                }
+                vm->key_down(VK_LSHIFT, false);
+                key_status[VK_LSHIFT] = key_status[VK_SHIFT] = 0x80;
+            }
+        } else if(!key_shift_pressed && key_shift_released) {
+            if(key_status[VK_LSHIFT] != 0) {
+                // shift key is newly released
+                vm->key_up(VK_LSHIFT);
+                if(!key_status[VK_RSHIFT]) {
+                    vm->key_up(VK_SHIFT);
+                }
+                key_status[VK_LSHIFT] = key_status[VK_SHIFT] = 0;
+            }
+        }
+        key_shift_pressed = key_shift_released = false;
+        
+        // CapsLock„ÅÆÁä∂ÊÖãÊõ¥Êñ∞
+        if(key_caps_locked) {
+            key_down_native(0xf0, false);
+        }
+#ifdef USE_AUTO_KEY
+    }
+#endif
+    
+    // release keys
+#ifdef USE_AUTO_KEY
+    if(lost_focus && !now_auto_key) {
+#else
+    if(lost_focus) {
+#endif
+        // we lost key focus so release all pressed keys
+        for(int i = 0; i < 256; i++) {
+            if(key_status[i] & 0x80) {
+                key_status[i] &= 0x7f;
+                if(!key_status[i]) {
+                    vm->key_up(i);
+                }
+            }
+        }
+    } else {
+        for(int i = 0; i < 256; i++) {
+            if(key_status[i] & 0x7f) {
+                key_status[i] = (key_status[i] & 0x80) | ((key_status[i] & 0x7f) - 1);
+                if(!key_status[i]) {
+                    vm->key_up(i);
+                }
+            }
+        }
+    }
+    lost_focus = false;
+    
+    // VK_$00 should be 0
+    key_status[0] = 0;
+    
+#ifdef USE_JOYSTICK
+    // update joystick status - kernel.cpp„ÅßÊõ¥Êñ∞„Åï„Çå„Åü„Ç≤„Éº„É†„Éë„ÉÉ„Éâ„ÅÆÁä∂ÊÖã„ÇíÂèçÊò†
+    memset(joy_status, 0, sizeof(joy_status));
+    
+    // „Ç≤„Éº„É†„Éë„ÉÉ„Éâ„ÅÆÁä∂ÊÖã„Çí„Ç≥„Éî„Éº
+    // WindowsÁâà„Å®„ÅÆ‰∫íÊèõÊÄß„ÅÆ„Åü„ÇÅ‰ª•‰∏ã„ÅÆ„Éì„ÉÉ„ÉàÈÖçÁΩÆ„Çí‰ΩøÁî®:
+    // - „Éì„ÉÉ„Éà0-3: ÊñπÂêë„Ç≠„Éº (‰∏ä‰∏ãÂ∑¶Âè≥)
+    // - „Éì„ÉÉ„Éà4-19: „Éú„Çø„É≥1-16
+    // - „Éì„ÉÉ„Éà20-21: ZËª∏ (Âè≥„Çπ„ÉÜ„Ç£„ÉÉ„ÇØX)
+    // - „Éì„ÉÉ„Éà22-23: RËª∏ (Âè≥„Çπ„ÉÜ„Ç£„ÉÉ„ÇØY)
+    // - „Éì„ÉÉ„Éà24-25: UËª∏/VËª∏ („Éà„É™„Ç¨„Éº) 
+    // - „Éì„ÉÉ„Éà26-31: POV„Éè„ÉÉ„Éà
+    for(int i = 0; i < 4; i++) {
+        joy_status[i] = rpi_gamepad_status[i];
+    }
+    
+    // joy_to_key„ÅÆÂá¶ÁêÜÔºà„Ç∏„Éß„Ç§„Çπ„ÉÜ„Ç£„ÉÉ„ÇØÂÖ•Âäõ„Çí„Ç≠„Éº„Éú„Éº„ÉâÂÖ•Âäõ„Å´Â§âÊèõÔºâ
+    if(config.use_joy_to_key) {
+        int status[256] = {0};
+        if(config.joy_to_key_type == 0) {
+            // cursor key
+            static const int vk[] = {VK_UP, VK_DOWN, VK_LEFT, VK_RIGHT};
+            for(int i = 0; i < 4; i++) {
+                if(joy_status[0] & (1 << i)) {
+                    status[vk[i]] = 1;
+                }
+            }
+        } else if(config.joy_to_key_type == 1) {
+            // numpad key (4-directions)
+            static const int vk[] = {VK_NUMPAD8, VK_NUMPAD2, VK_NUMPAD4, VK_NUMPAD6};
+            for(int i = 0; i < 4; i++) {
+                if(joy_status[0] & (1 << i)) {
+                    status[vk[i]] = 1;
+                }
+            }
+        } else if(config.joy_to_key_type == 2) {
+            // numpad key (8-directions)
+            switch(joy_status[0] & 0x0f) {
+            case 0x02 + 0x04: status[VK_NUMPAD1] = 1; break; // down-left
+            case 0x02       : status[VK_NUMPAD2] = 1; break; // down
+            case 0x02 + 0x08: status[VK_NUMPAD3] = 1; break; // down-right
+            case 0x00 + 0x04: status[VK_NUMPAD4] = 1; break; // left
+//          case 0x00       : status[VK_NUMPAD5] = 1; break;
+            case 0x00 + 0x08: status[VK_NUMPAD6] = 1; break; // right
+            case 0x01 + 0x04: status[VK_NUMPAD7] = 1; break; // up-left
+            case 0x01       : status[VK_NUMPAD8] = 1; break; // up
+            case 0x01 + 0x08: status[VK_NUMPAD9] = 1; break; // up-right
+            }
+        }
+        if(config.joy_to_key_type == 1 || config.joy_to_key_type == 2) {
+            // numpad key
+            if(config.joy_to_key_numpad5 && !(joy_status[0] & 0x0f)) {
+                status[VK_NUMPAD5] = 1;
+            }
+        }
+        for(int i = 0; i < 16; i++) {
+            if(joy_status[0] & (1 << (i + 4))) {
+                if(config.joy_to_key_buttons[i] < 0 && -config.joy_to_key_buttons[i] < 256) {
+                    status[-config.joy_to_key_buttons[i]] = 1;
+                }
+            }
+        }
+        for(int i = 0; i < 256; i++) {
+            if(status[i]) {
+                if(!joy_to_key_status[i]) {
+                    if(!(key_status[i] & 0x80)) {
+                        key_down_native(i, false);
+                        // do not keep key pressed
+                        if(config.joy_to_key_numpad5 && (i >= VK_NUMPAD1 && i <= VK_NUMPAD9)) {
+                            key_status[i] = KEY_KEEP_FRAMES;
+                        }
+                    }
+                    joy_to_key_status[i] = true;
+                }
+            } else {
+                if(joy_to_key_status[i]) {
+                    if(key_status[i]) {
+                        key_up_native(i);
+                    }
+                    joy_to_key_status[i] = false;
+                }
+            }
+        }
+    }
+#endif
+}
+
+void OSD::key_down(int code, bool extended, bool repeat)
+{
+#ifdef USE_AUTO_KEY
+    if(!now_auto_key && !config.romaji_to_kana) {
+#endif
+        // win32Áâà„Å®„ÅÆ‰∫íÊèõÊÄß„ÅÆ„Åü„ÇÅ„Å´‰øÆÊ≠£
+        if(code == VK_SHIFT) {
+            // „Ç∑„Éï„Éà„Ç≠„Éº„ÅåÊäº„Åï„Çå„ÅüÂ†¥Âêà„ÄÅÂè≥„Ç∑„Éï„Éà„Åå„ÅÇ„Çå„Å∞Âá¶ÁêÜ
+            if(!(key_status[VK_RSHIFT] & 0x80)) {
+                key_down_native(VK_RSHIFT, repeat);
+            }
+            // Â∑¶„Ç∑„Éï„Éà„ÇíÂá¶ÁêÜ
+            key_shift_pressed = true;
+            code = VK_LSHIFT;
+        } else if(code == VK_CONTROL) {
+            // „Ç≥„É≥„Éà„É≠„Éº„É´„Ç≠„Éº„ÅåÊäº„Åï„Çå„ÅüÂ†¥Âêà„ÄÅÂè≥„Ç≥„É≥„Éà„É≠„Éº„É´„Åå„ÅÇ„Çå„Å∞Âá¶ÁêÜ
+            if(!(key_status[VK_RCONTROL] & 0x80)) {
+                key_down_native(VK_RCONTROL, repeat);
+            }
+            code = VK_LCONTROL;
+        } else if(code == VK_MENU) {
+            // ALT„Ç≠„Éº„ÅåÊäº„Åï„Çå„ÅüÂ†¥Âêà„ÄÅÂè≥ALT„Åå„ÅÇ„Çå„Å∞Âá¶ÁêÜ
+            if(!(key_status[VK_RMENU] & 0x80)) {
+                key_down_native(VK_RMENU, repeat);
+            }
+            code = VK_LMENU;
+        }
+        
+        // Â∑¶„Ç∑„Éï„Éà„Ç≠„Éº„ÅÆÁâπÂà•„Å™Âá¶ÁêÜ
+        if(code == VK_LSHIFT) {
+            key_shift_pressed = true;
+            return;
+        }
+        
+        // NumPad„Ç≠„Éº„ÅÆÁâπÂà•Âá¶ÁêÜ
+        if(!extended) {
+            switch(code) {
+            case VK_INSERT:
+                if(key_shift_pressed || key_shift_released || key_status[VK_NUMPAD0]) {
+                    code = VK_NUMPAD0;
+                    key_shift_pressed = true;
+                }
+                break;
+            case VK_END:
+                if(key_shift_pressed || key_shift_released || key_status[VK_NUMPAD1]) {
+                    code = VK_NUMPAD1;
+                    key_shift_pressed = true;
+                }
+                break;
+            case VK_DOWN:
+                if(key_shift_pressed || key_shift_released || key_status[VK_NUMPAD2]) {
+                    code = VK_NUMPAD2;
+                    key_shift_pressed = true;
+                }
+                break;
+            case VK_NEXT:
+                if(key_shift_pressed || key_shift_released || key_status[VK_NUMPAD3]) {
+                    code = VK_NUMPAD3;
+                    key_shift_pressed = true;
+                }
+                break;
+            case VK_LEFT:
+                if(key_shift_pressed || key_shift_released || key_status[VK_NUMPAD4]) {
+                    code = VK_NUMPAD4;
+                    key_shift_pressed = true;
+                }
+                break;
+            case VK_CLEAR:
+                if(key_shift_pressed || key_shift_released || key_status[VK_NUMPAD5]) {
+                    code = VK_NUMPAD5;
+                    key_shift_pressed = true;
+                }
+                break;
+            case VK_RIGHT:
+                if(key_shift_pressed || key_shift_released || key_status[VK_NUMPAD6]) {
+                    code = VK_NUMPAD6;
+                    key_shift_pressed = true;
+                }
+                break;
+            case VK_HOME:
+                if(key_shift_pressed || key_shift_released || key_status[VK_NUMPAD7]) {
+                    code = VK_NUMPAD7;
+                    key_shift_pressed = true;
+                }
+                break;
+            case VK_UP:
+                if(key_shift_pressed || key_shift_released || key_status[VK_NUMPAD8]) {
+                    code = VK_NUMPAD8;
+                    key_shift_pressed = true;
+                }
+                break;
+            case VK_PRIOR:
+                if(key_shift_pressed || key_shift_released || key_status[VK_NUMPAD9]) {
+                    code = VK_NUMPAD9;
+                    key_shift_pressed = true;
+                }
+                break;
+            }
+        }
+        
+        if(!repeat) {
+            if(!(key_status[code] & 0x80)) {
+                key_down_native(code, repeat);
+            }
+        }
+#ifdef USE_AUTO_KEY
+    }
+#endif
+}
+
+void OSD::key_up(int code, bool extended)
+{
+#ifdef USE_AUTO_KEY
+    if(!now_auto_key && !config.romaji_to_kana) {
+#endif
+        // „Ç∑„Éï„Éà„Ç≠„Éº„ÅåÈõ¢„Åï„Çå„Åü„Å®„Åç„ÅÆÂá¶ÁêÜ
+        if(code == VK_SHIFT) {
+            // Âè≥„Ç∑„Éï„Éà„Åå„ÅÇ„Çå„Å∞Âá¶ÁêÜ
+            if((key_status[VK_RSHIFT] & 0x80)) {
+                key_up_native(VK_RSHIFT);
+            }
+            // Â∑¶„Ç∑„Éï„Éà„ÅÆÂá¶ÁêÜ
+            key_shift_released = true;
+            code = VK_LSHIFT;
+        } else if(code == VK_CONTROL) {
+            // Âè≥„Ç≥„É≥„Éà„É≠„Éº„É´„Åå„ÅÇ„Çå„Å∞Âá¶ÁêÜ
+            if((key_status[VK_RCONTROL] & 0x80)) {
+                key_up_native(VK_RCONTROL);
+            }
+            code = VK_LCONTROL;
+        } else if(code == VK_MENU) {
+            // Âè≥ALT„Åå„ÅÇ„Çå„Å∞Âá¶ÁêÜ
+            if((key_status[VK_RMENU] & 0x80)) {
+                key_up_native(VK_RMENU);
+            }
+            code = VK_LMENU;
+        }
+        
+        if(code == VK_LSHIFT) {
+            key_shift_released = true;
+            return;
+        }
+        
+        // NumPad„Ç≠„Éº„ÅÆÂá¶ÁêÜ
+        if(!extended) {
+            switch(code) {
+            case VK_NUMPAD0: case VK_INSERT:
+                key_up_native(VK_NUMPAD0);
+                key_up_native(VK_INSERT);
+                return;
+            case VK_NUMPAD1: case VK_END:
+                key_up_native(VK_NUMPAD1);
+                key_up_native(VK_END);
+                return;
+            case VK_NUMPAD2: case VK_DOWN:
+                key_up_native(VK_NUMPAD2);
+                key_up_native(VK_DOWN);
+                return;
+            case VK_NUMPAD3: case VK_NEXT:
+                key_up_native(VK_NUMPAD3);
+                key_up_native(VK_NEXT);
+                return;
+            case VK_NUMPAD4: case VK_LEFT:
+                key_up_native(VK_NUMPAD4);
+                key_up_native(VK_LEFT);
+                return;
+            case VK_NUMPAD5: case VK_CLEAR:
+                key_up_native(VK_NUMPAD5);
+                key_up_native(VK_CLEAR);
+                return;
+            case VK_NUMPAD6: case VK_RIGHT:
+                key_up_native(VK_NUMPAD6);
+                key_up_native(VK_RIGHT);
+                return;
+            case VK_NUMPAD7: case VK_HOME:
+                key_up_native(VK_NUMPAD7);
+                key_up_native(VK_HOME);
+                return;
+            case VK_NUMPAD8: case VK_UP:
+                key_up_native(VK_NUMPAD8);
+                key_up_native(VK_UP);
+                return;
+            case VK_NUMPAD9: case VK_PRIOR:
+                key_up_native(VK_NUMPAD9);
+                key_up_native(VK_PRIOR);
+                return;
+            }
+        }
+        
+        if(key_status[code] & 0x80) {
+            key_up_native(code);
+        }
+#ifdef USE_AUTO_KEY
+    }
+#endif
+}
+
+void OSD::key_down_native(int code, bool repeat)
+{
+    bool keep_frames = false;
+    
+    if(code == 0xf0) {
+        // CAPS "LOCK" key
+        code = VK_CAPITAL;
+        keep_frames = true;
+    } else if(code == 0xf1 || code == 0xf2) {
+        code = VK_KANA;
+        keep_frames = true;
+    } else if(code == 0xf3 || code == 0xf4) {
+        code = VK_KANJI;
+        keep_frames = true;
+    }
+    
+    // Win32Áâà„Å®ÂêåÊßò„Å´„ÄÅÂ∑¶„Ç∑„Éï„Éà„Å®Âè≥„Ç∑„Éï„Éà„ÅØÁâπÂà•„Å´Êâ±„ÅÜ
+    if(!(code == VK_LSHIFT || code == VK_RSHIFT || code == VK_LCONTROL || code == VK_RCONTROL || code == VK_LMENU || code == VK_RMENU)) {
+        code = keycode_conv[code];
+    }
+    
+    if(key_status[code] == 0 || keep_frames) {
+        repeat = false;
+    }
+    
+#ifdef DONT_KEEEP_KEY_PRESSED
+    if(!(code == VK_LSHIFT || code == VK_RSHIFT || code == VK_LCONTROL || code == VK_RCONTROL || code == VK_LMENU || code == VK_RMENU)) {
+        key_status[code] = KEY_KEEP_FRAMES;
+    } else
+#endif
+    key_status[code] = keep_frames ? KEY_KEEP_FRAMES : 0x80;
+    
+    uint8_t prev_shift = key_status[VK_SHIFT];
+    uint8_t prev_control = key_status[VK_CONTROL];
+    uint8_t prev_menu = key_status[VK_MENU];
+    
+    // ‰øÆÈ£æ„Ç≠„Éº„ÅÆÁä∂ÊÖã„ÇíÊõ¥Êñ∞
+    key_status[VK_SHIFT] = key_status[VK_LSHIFT] | key_status[VK_RSHIFT];
+    key_status[VK_CONTROL] = key_status[VK_LCONTROL] | key_status[VK_RCONTROL];
+    key_status[VK_MENU] = key_status[VK_LMENU] | key_status[VK_RMENU];
+    
+    // ÂêàÊàê„Ç≠„Éº„ÅÆÈÄöÁü•ÔºàWin32Áâà„Å®Âêå„ÅòÂá¶ÁêÜÔºâ
+    if(code == VK_LSHIFT || code == VK_RSHIFT) {
+        if(prev_shift == 0 && key_status[VK_SHIFT] != 0) {
+            vm->key_down(VK_SHIFT, repeat);
+        }
+    } else if(code == VK_LCONTROL|| code == VK_RCONTROL) {
+        if(prev_control == 0 && key_status[VK_CONTROL] != 0) {
+            vm->key_down(VK_CONTROL, repeat);
+        }
+    } else if(code == VK_LMENU|| code == VK_RMENU) {
+        if(prev_menu == 0 && key_status[VK_MENU] != 0) {
+            vm->key_down(VK_MENU, repeat);
+        }
+    }
+    
+    // VK_LSHIFT„ÅÆÂ†¥Âêà„ÅØvm->key_down„ÇíÂëº„Å∞„Å™„ÅÑÔºàWin32Áâà„Å®„ÅÆ‰∫íÊèõÊÄß„ÅÆ„Åü„ÇÅÔºâ
+    if(code != VK_LSHIFT) {
+        vm->key_down(code, repeat);
+    }
+}
+
+void OSD::key_up_native(int code) {
+    if(!(code == VK_LSHIFT || code == VK_RSHIFT || code == VK_LCONTROL || code == VK_RCONTROL || code == VK_LMENU || code == VK_RMENU)) {
+        code = keycode_conv[code];
+    }
+    if(key_status[code] == 0) {
+        return;
+    }
+    
+    // „Ç≠„ÉºËß£ÊîæÂá¶ÁêÜ„ÅÆÊîπÂñÑ - ‰øÆÈ£æ„Ç≠„Éº„ÅÆÂ†¥Âêà„ÅØÁâπÂà•Âá¶ÁêÜ
+    if(code == VK_LSHIFT || code == VK_RSHIFT || code == VK_LCONTROL || code == VK_RCONTROL || code == VK_LMENU || code == VK_RMENU) {
+        key_status[code] = 0; // ÂÆåÂÖ®„Å´Ëß£Êîæ
+    } else {
+        if((key_status[code] &= 0x7f) != 0) {
+            return;
+        }
+    }
+    
+    vm->key_up(code);
+    
+    uint8_t prev_shift = key_status[VK_SHIFT];
+    uint8_t prev_control = key_status[VK_CONTROL];
+    uint8_t prev_menu = key_status[VK_MENU];
+    
+    key_status[VK_SHIFT] = key_status[VK_LSHIFT] | key_status[VK_RSHIFT];
+    key_status[VK_CONTROL] = key_status[VK_LCONTROL] | key_status[VK_RCONTROL];
+    key_status[VK_MENU] = key_status[VK_LMENU] | key_status[VK_RMENU];
+    
+    if(code == VK_LSHIFT || code == VK_RSHIFT) {
+        if(prev_shift != 0 && key_status[VK_SHIFT] == 0) {
+            vm->key_up(VK_SHIFT);
+        }
+    } else if(code == VK_LCONTROL|| code == VK_RCONTROL) {
+        if(prev_control != 0 && key_status[VK_CONTROL] == 0) {
+            vm->key_up(VK_CONTROL);
+        }
+    } else if(code == VK_LMENU || code == VK_RMENU) {
+        if(prev_menu != 0 && key_status[VK_MENU] == 0) {
+            vm->key_up(VK_MENU);
+        }
+    }
+}
+
+void OSD::enable_mouse() {}
+void OSD::disable_mouse() {}
+void OSD::toggle_mouse() {}
diff -ruN source/src/rpi/osd_midi.cpp src/rpi/osd_midi.cpp
--- source/src/rpi/osd_midi.cpp	1970-01-01 09:00:00
+++ src/rpi/osd_midi.cpp	2025-04-28 22:36:36
@@ -0,0 +1,15 @@
+/*
+    Stub implementation for osd_midi.cpp
+    This file is auto-generated to avoid Windows dependency.
+*/
+
+#include "osd.h"
+
+// OSD class member functions (empty implementation)
+void OSD::initialize_midi() {}
+void OSD::release_midi() {}
+void OSD::send_to_midi(uint8_t data) {}
+bool OSD::recv_from_midi(uint8_t *data) { return false; }
+
+// Global function (empty implementation)
+unsigned __stdcall midi_thread(void *lpx) { return 0; }
\ No newline at end of file
diff -ruN source/src/rpi/osd_screen.cpp src/rpi/osd_screen.cpp
--- source/src/rpi/osd_screen.cpp	1970-01-01 09:00:00
+++ src/rpi/osd_screen.cpp	2025-04-28 22:36:36
@@ -0,0 +1,122 @@
+/*
+    Circle-StdLibÁî®„ÅÆÁîªÈù¢ÊèèÁîª
+*/
+
+#include "osd.h"
+#include <cstring>
+
+#include "PlatformScreen.h"
+
+extern PlatformScreen* g_platform_screen;
+
+// VMÁîªÈù¢„Éê„ÉÉ„Éï„Ç°„ÅÆÂàùÊúüÂåñ
+void OSD::initialize_screen()
+{
+    host_window_width = WINDOW_WIDTH;
+    host_window_height = WINDOW_HEIGHT;
+    host_window_mode = true;
+
+    vm_screen_width = SCREEN_WIDTH;
+    vm_screen_height = SCREEN_HEIGHT;
+    vm_window_width = WINDOW_WIDTH;
+    vm_window_height = WINDOW_HEIGHT;
+    vm_window_width_aspect = WINDOW_WIDTH_ASPECT;
+    vm_window_height_aspect = WINDOW_HEIGHT_ASPECT;
+
+    g_platform_screen->set_screen_size(vm_screen_width, vm_screen_height);
+}
+
+// ÁîªÈù¢„Éê„ÉÉ„Éï„Ç°ÂàùÊúüÂåñ
+void OSD::initialize_screen_buffer(bitmap_t* buffer, int width, int height, int mode)
+{
+    g_platform_screen->initialize_screen_buffer((ScreenBitmap_t*)buffer, width, height, mode);
+}
+
+// ÁîªÈù¢„Éê„ÉÉ„Éï„Ç°Ëß£Êîæ
+void OSD::release_screen_buffer(bitmap_t* buffer)
+{
+    g_platform_screen->release_screen_buffer((ScreenBitmap_t*)buffer);
+}
+
+// „É™„ÇΩ„Éº„ÇπËß£Êîæ
+void OSD::release_screen()
+{
+    g_platform_screen->release_screen();
+}
+
+// „Ç¶„Ç£„É≥„Éâ„Ç¶„É¢„Éº„ÉâÂÄçÁéá
+double OSD::get_window_mode_power(int mode) { return 1.0; }
+int OSD::get_window_mode_width(int mode) { return vm_window_width; }
+int OSD::get_window_mode_height(int mode) { return vm_window_height; }
+
+// „Ç¶„Ç£„É≥„Éâ„Ç¶„Çµ„Ç§„Ç∫Ë®≠ÂÆö
+void OSD::set_host_window_size(int window_width, int window_height, BOOL window_mode)
+{
+    host_window_width = window_width;
+    host_window_height = window_height;
+    host_window_mode = window_mode;
+}
+
+// VMÁîªÈù¢„Çµ„Ç§„Ç∫Ë®≠ÂÆö
+void OSD::set_vm_screen_size(int screen_width, int screen_height, int window_width, int window_height, int window_width_aspect, int window_height_aspect)
+{
+    if (vm_screen_width != screen_width || vm_screen_height != screen_height) {
+        vm_screen_width = screen_width;
+        vm_screen_height = screen_height;
+        vm_window_width = window_width;
+        vm_window_height = window_height;
+        vm_window_width_aspect = window_width_aspect;
+        vm_window_height_aspect = window_height_aspect;
+
+        g_platform_screen->set_screen_size(vm_screen_width, vm_screen_height);
+    }
+}
+
+// VMÁîªÈù¢„Éê„ÉÉ„Éï„Ç°„ÅÆyË°åÁõÆÂÖàÈ†≠„Ç¢„Éâ„É¨„Çπ
+scrntype_t* OSD::get_vm_screen_buffer(int y)
+{
+    return (scrntype_t*)g_platform_screen->get_screen_buffer(y);
+}
+
+// ÁîªÈù¢ÊèèÁîª
+int OSD::draw_screen()
+{
+    g_platform_screen->draw_screen();
+    return 1;
+}
+
+// VMÁîªÈù¢„É©„Ç§„É≥Êï∞Ë®≠ÂÆö
+void OSD::set_vm_screen_lines(int lines)
+{
+    // ÂøÖË¶Å„Å´Âøú„Åò„Å¶ÂÆüË£Ö
+}
+
+// ÁîªÈù¢„Ç≠„É£„Éó„ÉÅ„É£
+void OSD::capture_screen()
+{
+    // ÂøÖË¶Å„Å´Âøú„Åò„Å¶ÂÆüË£Ö
+}
+
+// „Éì„Éá„Ç™Èå≤ÁîªÔºàÂøÖË¶Å„Å´Âøú„Åò„Å¶ÂÆüË£ÖÔºâ
+BOOL OSD::start_record_video(int fps) { return FALSE; }
+void OSD::stop_record_video() {}
+void OSD::restart_record_video() {}
+void OSD::add_extra_frames(int extra_frames) {}
+
+// ‰ª•‰∏ã„ÅØÂü∫Êú¨ÁöÑ„Å´„Çπ„Çø„ÉñÂÆüË£ÖÔºàÂøÖË¶Å„Å™„ÇâÂÆüË£ÖÔºâ
+void OSD::create_pen(pen_t *pen, int width, uint8_t r, uint8_t g, uint8_t b) {}
+void OSD::release_pen(pen_t *pen) {}
+void OSD::create_font(font_t* font, const char* family, int width, int height, int rotate, int bold, int italic) {}
+void OSD::release_font(font_t* font) {}
+void OSD::create_bitmap(bitmap_t* bitmap, int width, int height) {}
+void OSD::release_bitmap(bitmap_t* bitmap) {}
+void OSD::clear_bitmap(bitmap_t* bitmap, BYTE r, BYTE g, BYTE b) {}
+int OSD::get_text_width(bitmap_t* bitmap, font_t* font, const char* text) { return 0; }
+void OSD::draw_text_to_bitmap(bitmap_t* bitmap, font_t* font, int x, int y, const char* text, BYTE r, BYTE g, BYTE b) {}
+void OSD::draw_line_to_bitmap(bitmap_t* bitmap, pen_t* pen, int sx, int sy, int ex, int ey) {}
+void OSD::draw_rectangle_to_bitmap(bitmap_t* bitmap, int x, int y, int width, int height, BYTE r, BYTE g, BYTE b) {}
+void OSD::draw_point_to_bitmap(bitmap_t* bitmap, int x, int y, BYTE r, BYTE g, BYTE b) {}
+void OSD::stretch_bitmap(bitmap_t* dest, int dest_x, int dest_y, int dest_width, int dest_height, bitmap_t* source, int source_x, int source_y, int source_width, int source_height) {}
+void OSD::write_bitmap_to_file(bitmap_t* bitmap, const _TCHAR* file_path) {}
+void OSD::invalidate_screen() {}
+void OSD::update_screen(HDC hdc) {}
diff -ruN source/src/rpi/osd_socket.cpp src/rpi/osd_socket.cpp
--- source/src/rpi/osd_socket.cpp	1970-01-01 09:00:00
+++ src/rpi/osd_socket.cpp	2025-04-28 22:36:36
@@ -0,0 +1,22 @@
+/*
+    Stub implementation for osd_socket.cpp
+    This file is auto-generated to avoid Windows dependency.
+*/
+
+#include "osd.h"
+
+// OSD class member functions (empty implementation)
+void OSD::initialize_socket() {}
+void OSD::release_socket() {}
+void OSD::notify_socket_connected(int ch) {}
+void OSD::notify_socket_disconnected(int ch) {}
+void OSD::update_socket() {}
+bool OSD::initialize_socket_tcp(int ch) { return false; }
+bool OSD::initialize_socket_udp(int ch) { return false; }
+bool OSD::connect_socket(int ch, uint32_t ipaddr, int port) { return false; }
+void OSD::disconnect_socket(int ch) {}
+bool OSD::listen_socket(int ch) { return false; }
+void OSD::send_socket_data_tcp(int ch) {}
+void OSD::send_socket_data_udp(int ch, uint32_t ipaddr, int port) {}
+void OSD::send_socket_data(int ch) {}
+void OSD::recv_socket_data(int ch) {}
\ No newline at end of file
diff -ruN source/src/rpi/osd_sound.cpp src/rpi/osd_sound.cpp
--- source/src/rpi/osd_sound.cpp	1970-01-01 09:00:00
+++ src/rpi/osd_sound.cpp	2025-04-28 22:36:36
@@ -0,0 +1,39 @@
+/*
+    „Çµ„Ç¶„É≥„ÉâÂá∫ÂäõÂá¶ÁêÜ
+*/
+
+#include "osd.h"
+#include <cstring>
+#include "PlatformSound.h"
+
+extern PlatformSound* g_platform_sound;
+
+void OSD::initialize_sound(int rate, int samples)
+{
+    g_platform_sound->initialize(rate, samples);
+}
+
+void OSD::release_sound()
+{
+    g_platform_sound->release();
+}
+
+void OSD::update_sound(int* extra_frames)
+{
+    g_platform_sound->update(extra_frames);
+}
+
+void OSD::mute_sound()
+{
+    g_platform_sound->mute_sound();
+}
+
+void OSD::stop_sound()
+{
+    g_platform_sound->stop_sound();
+}
+
+// Èå≤Èü≥Ê©üËÉΩ„ÅØ‰ªä„ÅÆ„Å®„Åì„ÇçÂÆüË£Ö„Åó„Å™„ÅÑ
+void OSD::start_record_sound() {}
+void OSD::stop_record_sound() {}
+void OSD::restart_record_sound() {}
diff -ruN source/src/rpi/osd_timer.cpp src/rpi/osd_timer.cpp
--- source/src/rpi/osd_timer.cpp	1970-01-01 09:00:00
+++ src/rpi/osd_timer.cpp	2025-04-28 22:36:36
@@ -0,0 +1,7 @@
+// SDL2Áî®ÈõõÂΩ¢
+/*
+    Stub implementation for osd_timer.cpp
+    This file is auto-generated to avoid Windows dependency.
+*/
+
+// ÂøÖË¶Å„Å´Âøú„Åò„Å¶Èñ¢Êï∞„ÇíËøΩÂä†„Åó„Å¶„Åè„Å†„Åï„ÅÑ
\ No newline at end of file
diff -ruN source/src/rpi/readme.md src/rpi/readme.md
--- source/src/rpi/readme.md	1970-01-01 09:00:00
+++ src/rpi/readme.md	2025-04-28 22:36:36
@@ -0,0 +1,4 @@
+## rpi„Éï„Ç©„É´„ÉÄ„Å´„Å§„ÅÑ„Å¶
+
+„Åì„ÅÆ„Éï„Ç©„É´„ÉÄ„ÅÆ„ÇΩ„Éº„Çπ„ÅØRaspberry Pi„Å´ÂØæÂøú„Åï„Åõ„Çà„ÅÜ„Å®„Åó„ÅüÊôÇ„ÅÆÊÆãÈ™∏„Åß„Åô„ÄÇÂèÇËÄÉ„Å®„Åó„Å¶ÊÆã„Åó„Å¶„Åä„Åç„Åæ„Åô„ÄÇ
+
diff -ruN source/src/sdl2/osd.cpp src/sdl2/osd.cpp
--- source/src/sdl2/osd.cpp	1970-01-01 09:00:00
+++ src/sdl2/osd.cpp	2025-04-28 22:36:36
@@ -0,0 +1,50 @@
+/*
+    SDL2 source for osd.cpp
+    This file is auto-generated to avoid Windows dependency.
+*/
+
+#include "osd.h"
+
+void OSD::set_renderer(SDL_Renderer* renderer)
+{
+    this->sdl_renderer = renderer;
+}
+
+void OSD::initialize(int rate, int samples)
+{
+    initialize_console();
+    initialize_input();
+    initialize_screen();
+    initialize_sound(rate, samples);
+    // SDL2Áâà„Åß„ÅØWin32Âõ∫ÊúâÂá¶ÁêÜ„ÇÑCOMÂàùÊúüÂåñ„ÅØ‰∏çË¶Å
+    // ÂøÖË¶Å„Å´Âøú„Åò„Å¶initialize_video(), initialize_socket(), initialize_midi()„ÇÇËøΩÂä†
+}
+void OSD::release() {}
+void OSD::power_off() {}
+void OSD::suspend() {}
+void OSD::restore() {}
+void OSD::lock_vm() {}
+void OSD::unlock_vm() {}
+void OSD::force_unlock_vm() {}
+void OSD::sleep(uint32_t ms) { SDL_Delay(ms); }
+void OSD::start_waiting_in_debugger() {}
+void OSD::finish_waiting_in_debugger() {}
+void OSD::process_waiting_in_debugger() {}
+// --- ËøΩÂä†„Ç∞„É≠„Éº„Éê„É´Èñ¢Êï∞„ÅÆÁ©∫ÂÆüË£Ö ---
+
+// --- OSD„ÇØ„É©„ÇπËøΩÂä†„É°„É≥„ÉêÈñ¢Êï∞„ÅÆÁ©∫ÂÆüË£Ö ---
+BOOL OSD::is_vm_locked() { return FALSE; }
+void OSD::key_lost_focus() {}
+
+
+LRESULT CALLBACK MyWndProc(HWND hWnd, UINT iMsg, WPARAM wParam, LPARAM lParam)
+{
+    return 0;
+}
+
+BOOL WINAPI ctrl_c_handler(DWORD type) { return 0; }
+const _TCHAR *get_ttermpro_path() { return nullptr; }
+const _TCHAR *get_ttermpro_x86_path() { return nullptr; }
+const _TCHAR *get_putty_path() { return nullptr; }
+const _TCHAR *get_putty_x86_path() { return nullptr; }
+const _TCHAR *get_telnet_path() { return nullptr; }
\ No newline at end of file
diff -ruN source/src/sdl2/osd.h src/sdl2/osd.h
--- source/src/sdl2/osd.h	1970-01-01 09:00:00
+++ src/sdl2/osd.h	2025-04-28 22:36:36
@@ -0,0 +1,517 @@
+/*
+    SDL2 header for osd.h
+    This file is auto-generated to avoid Windows dependency.
+    DO NOT EDIT MANUALLY.
+    Based on src/win32/osd.h
+*/
+
+#ifndef _WIN32_OSD_H_
+#define _WIN32_OSD_H_
+
+#include <SDL.h>
+#include "../platform_types.h"
+#include "../vm/vm.h"
+//#include "../emu.h"
+#include "../common.h"
+#include "../config.h"
+
+
+/* --- „Éó„É≠„Ç∏„Çß„ÇØ„Éà‰æùÂ≠òÂûã --- */
+
+/* --- „Éû„ÇØ„É≠„ÉªÂÆöÊï∞ --- */
+#define _WIN32_WINNT        0x500
+#define DIRECTSOUND_VERSION 0x900
+#define DIRECT3D_VERSION    0x900
+#define DIRECTINPUT_VERSION 0x800
+
+#define WM_RESIZE  (0x0400 + 1)
+#define WM_SOCKET0 (0x0400 + 2)
+#define WM_SOCKET1 (0x0400 + 3)
+#define WM_SOCKET2 (0x0400 + 4)
+#define WM_SOCKET3 (0x0400 + 5)
+
+#ifdef USE_SOCKET
+#define SOCKET_MAX 4
+#define SOCKET_BUFFER_MAX 0x100000
+#endif
+
+#ifdef USE_VIDEO_CAPTURE
+#define MAX_CAPTURE_DEVS 8
+#endif
+
+#if defined(_WIN32) && !defined(_M_AMD64)
+#define SUPPORT_WIN32_DLL
+#endif
+
+#define SCREEN_FILTER_NONE 0
+#define SCREEN_FILTER_RGB  1
+#define SCREEN_FILTER_RF   2
+
+#define OSD_CONSOLE_BLUE      1
+#define OSD_CONSOLE_GREEN     2
+#define OSD_CONSOLE_RED       4
+#define OSD_CONSOLE_INTENSITY 8
+
+/* --- bitmap_tÊßãÈÄ†‰Ωì --- */
+typedef struct bitmap_s {
+    int width, height;
+    HDC hdcDib;
+    HBITMAP hBmp, hOldBmp;
+    LPBYTE lpBuf;
+    scrntype_t* lpBmp;
+    LPBITMAPINFO lpDib;
+#ifdef __cplusplus
+    inline bool initialized() const { return false; }
+    inline scrntype_t* get_buffer(int) { return nullptr; }
+#endif
+} bitmap_t;
+
+/* --- font_tÊßãÈÄ†‰Ωì --- */
+typedef struct font_s {
+    _TCHAR family[64];
+    int width, height, rotate;
+    BOOL bold, italic;
+    HFONT hFont;
+#ifdef __cplusplus
+    inline bool initialized() const { return false; }
+#endif
+} font_t;
+
+/* --- pen_tÊßãÈÄ†‰Ωì --- */
+typedef struct pen_s {
+    int width;
+    BYTE r, g, b;
+    HPEN hPen;
+#ifdef __cplusplus
+    inline bool initialized() const { return false; }
+#endif
+} pen_t;
+
+/* --- rec_video_thread_param_tÊßãÈÄ†‰Ωì --- */
+typedef struct {
+    PAVISTREAM pAVICompressed;
+    scrntype_t* lpBmp;
+    LPBITMAPINFOHEADER pbmInfoHeader;
+    DWORD dwAVIFileSize;
+    LONG lAVIFrames;
+    int frames;
+    int result;
+} rec_video_thread_param_t;
+
+#ifdef USE_MIDI
+typedef struct midi_thread_params_s {
+    void* send_buffer;
+    void* recv_buffer;
+    BOOL terminate;
+} midi_thread_params_t;
+#endif
+
+/* --- „ÇØ„É©„ÇπÂÆ£Ë®ÄÔºàÂâçÊñπÂÆ£Ë®ÄÔºâ --- */
+class FIFO;
+class FILEIO;
+
+/* --- OSD„ÇØ„É©„ÇπÂÆöÁæ© --- */
+class OSD
+{
+public:
+    void set_renderer(SDL_Renderer* renderer);
+private:
+    int lock_count;
+    void initialize_console();
+    void release_console();
+    HANDLE hStdIn, hStdOut;
+    int console_count;
+    void open_telnet(const _TCHAR* title);
+    void close_telnet();
+    void send_telnet(const char* buffer);
+    BOOL use_telnet, telnet_closed;
+    int svr_socket, cli_socket;
+    void initialize_input();
+    void release_input();
+    void initialize_midi();
+    void release_midi();
+    void send_to_midi(uint8_t data);
+    bool recv_from_midi(uint8_t *data);
+#if DIRECTINPUT_VERSION >= 0x0800
+    LPDIRECTINPUT8 lpdi;
+    LPDIRECTINPUTDEVICE8 lpdikey;
+#else
+    LPDIRECTINPUT lpdi;
+    LPDIRECTINPUTDEVICE lpdikey;
+#endif
+    BOOL dinput_key_available;
+    BYTE keycode_conv[256];
+    BYTE key_status[256];
+    BYTE key_dik[256];
+    BYTE key_dik_prev[256];
+    BOOL key_shift_pressed, key_shift_released;
+    BOOL key_caps_locked;
+    BOOL lost_focus;
+#ifdef USE_JOYSTICK
+    unsigned int joy_status[4];
+    int joy_num;
+    struct {
+        UINT wNumAxes;
+        DWORD dwXposLo, dwXposHi;
+        DWORD dwYposLo, dwYposHi;
+        DWORD dwZposLo, dwZposHi;
+        DWORD dwRposLo, dwRposHi;
+        DWORD dwUposLo, dwUposHi;
+        DWORD dwVposLo, dwVposHi;
+        DWORD dwButtonsMask;
+    } joy_caps[4];
+
+    // SDL2Áî®
+    SDL_Window* sdl_window;
+    SDL_Renderer* sdl_renderer;
+    SDL_Texture* sdl_texture;
+    BOOL joy_to_key_status[256];
+#endif
+#ifdef USE_MOUSE
+    int mouse_status[3];
+    BOOL mouse_enabled;
+#endif
+    void initialize_screen();
+    void release_screen();
+    void initialize_screen_buffer(bitmap_t *buffer, int width, int height, int mode);
+    void release_screen_buffer(bitmap_t *buffer);
+#ifdef USE_SCREEN_FILTER
+    void apply_rgb_filter_to_screen_buffer(bitmap_t *source, bitmap_t *dest);
+    void apply_rgb_filter_x3_y3(bitmap_t *source, bitmap_t *dest);
+    void apply_rgb_filter_x3_y2(bitmap_t *source, bitmap_t *dest);
+    void apply_rgb_filter_x2_y3(bitmap_t *source, bitmap_t *dest);
+    void apply_rgb_filter_x2_y2(bitmap_t *source, bitmap_t *dest);
+    void apply_rgb_filter_x1_y1(bitmap_t *source, bitmap_t *dest);
+#endif
+    void rotate_screen_buffer(bitmap_t *source, bitmap_t *dest);
+    void stretch_screen_buffer(bitmap_t *source, bitmap_t *dest);
+#ifdef SUPPORT_D2D1
+    BOOL initialize_d2d1();
+    BOOL initialize_d2d1_surface(bitmap_t *buffer);
+    void release_d2d1();
+    void release_d2d1_surface();
+    void copy_to_d2d1_surface(bitmap_t *buffer);
+    void update_d2d1_screen(int dest_x, int dest_y);
+#endif
+#ifdef SUPPORT_D3D9
+    BOOL initialize_d3d9();
+    BOOL initialize_d3d9_surface(bitmap_t *buffer);
+    void release_d3d9();
+    void release_d3d9_surface();
+    void copy_to_d3d9_surface(bitmap_t *buffer);
+    void update_d3d9_screen(int dest_x, int dest_y);
+#endif
+    int add_video_frames();
+    bitmap_t vm_screen_buffer;
+#ifdef USE_SCREEN_FILTER
+    bitmap_t filtered_screen_buffer;
+    bitmap_t tmp_filtered_screen_buffer;
+#endif
+    bitmap_t rotated_screen_buffer;
+    bitmap_t stretched_screen_buffer;
+    bitmap_t shrinked_screen_buffer;
+    bitmap_t reversed_screen_buffer;
+    bitmap_t video_screen_buffer;
+    bitmap_t* draw_screen_buffer;
+    int host_window_width, host_window_height;
+    BOOL host_window_mode;
+    int vm_screen_width, vm_screen_height;
+    int vm_window_width, vm_window_height;
+    int vm_window_width_aspect, vm_window_height_aspect;
+    int draw_screen_width, draw_screen_height;
+    ULONG_PTR gdiToken;
+#ifdef SUPPORT_D2D1
+    ID2D1Factory* pD2d1Factory;
+    ID2D1DCRenderTarget *pD2d1DCRenderTarget;
+    ID2D1HwndRenderTarget* pD2d1HwndRenderTarget;
+    ID2D1Bitmap* pD2d1Bitmap;
+#endif
+#ifdef SUPPORT_D3D9
+    LPDIRECT3D9 lpd3d9;
+    LPDIRECT3DDEVICE9 lpd3d9Device;
+    LPDIRECT3DSURFACE9 lpd3d9Surface;
+    LPDIRECT3DSURFACE9 lpd3d9OffscreenSurface;
+    BOOL d3d9_device_lost;
+#endif
+    _TCHAR video_file_path[_MAX_PATH];
+    int rec_video_fps;
+    double rec_video_run_frames;
+    double rec_video_frames;
+    LPBITMAPINFO lpDibRec;
+    PAVIFILE pAVIFile;
+    PAVISTREAM pAVIStream;
+    PAVISTREAM pAVICompressed;
+    AVICOMPRESSOPTIONS AVIOpts;
+    DWORD dwAVIFileSize;
+    LONG lAVIFrames;
+    HANDLE hVideoThread;
+    rec_video_thread_param_t rec_video_thread_param;
+    BOOL first_draw_screen;
+    BOOL first_invalidate;
+    BOOL self_invalidate;
+    void initialize_sound(int rate, int samples);
+    void release_sound();
+    int sound_rate, sound_samples;
+    BOOL sound_available, sound_started, sound_muted;
+    LPDIRECTSOUND lpds;
+    LPDIRECTSOUNDBUFFER lpdsPrimaryBuffer, lpdsSecondaryBuffer;
+    BOOL sound_first_half;
+    _TCHAR sound_file_path[_MAX_PATH];
+    FILEIO* rec_sound_fio;
+    int rec_sound_bytes;
+    int rec_sound_buffer_ptr;
+#if defined(USE_MOVIE_PLAYER) || defined(USE_VIDEO_CAPTURE)
+    void initialize_video();
+    void release_video();
+    IGraphBuilder *pGraphBuilder;
+    IBaseFilter *pVideoBaseFilter;
+    IBaseFilter *pCaptureBaseFilter;
+    ICaptureGraphBuilder2 *pCaptureGraphBuilder2;
+    ISampleGrabber *pVideoSampleGrabber;
+    IBaseFilter *pSoundBaseFilter;
+    ISampleGrabber *pSoundSampleGrabber;
+    void* pSoundCallBack;
+    IMediaControl *pMediaControl;
+    IMediaSeeking *pMediaSeeking;
+    IMediaPosition *pMediaPosition;
+    IVideoWindow *pVideoWindow;
+    IBasicVideo *pBasicVideo;
+    IBasicAudio *pBasicAudio;
+    BOOL bTimeFormatFrame;
+    BOOL bVerticalReversed;
+    bitmap_t direct_show_screen_buffer;
+    bitmap_t direct_show_stretch_buffer;
+    int direct_show_width, direct_show_height;
+    BOOL direct_show_mute[2];
+    void get_video_buffer();
+    void mute_video_dev(bool l, bool r);
+    bool open_movie_file(const _TCHAR* file_path);
+    void close_movie_file();
+    void play_movie();
+    void stop_movie();
+    void pause_movie();
+    void set_cur_movie_frame(int frame, bool relative);
+    uint32_t get_cur_movie_frame();
+#endif
+
+    // --- SDL2ÂàùÊúüÂåñÈõõÂΩ¢ ---
+    void initialize_sdl2();
+
+    // --- SDL2ÁµÇ‰∫ÜÈõõÂΩ¢ ---
+    void release_sdl2();
+
+    // --- SDL2„Ç§„Éô„É≥„Éà„É´„Éº„ÉóÈõõÂΩ¢ ---
+    void event_loop_sdl2();
+#ifdef USE_MOVIE_PLAYER
+    double movie_frame_rate;
+    int movie_sound_rate;
+#endif
+#ifdef USE_VIDEO_CAPTURE
+    void enum_capture_devs();
+    BOOL connect_capture_dev(int index, BOOL pin);
+    int cur_capture_dev_index;
+    int num_capture_devs;
+    _TCHAR capture_dev_name[MAX_CAPTURE_DEVS][256];
+#endif
+#ifdef USE_SOCKET
+    void initialize_socket();
+    void release_socket();
+    SOCKET soc[SOCKET_MAX];
+    BOOL is_tcp[SOCKET_MAX];
+    sockaddr_in udpaddr[SOCKET_MAX];
+    int socket_delay[SOCKET_MAX];
+    char recv_buffer[SOCKET_MAX][SOCKET_BUFFER_MAX];
+    int recv_r_ptr[SOCKET_MAX], recv_w_ptr[SOCKET_MAX];
+#endif
+#ifdef USE_MIDI
+    void initialize_midi();
+    void release_midi();
+    HANDLE hMidiThread;
+    midi_thread_params_t midi_thread_params;
+#endif
+
+public:
+    // --- SDL2„Ç¶„Ç£„É≥„Éâ„Ç¶„Å´Ëâ≤‰ªò„ÅçÂõõËßí„ÇíÊèèÁîª„Åô„ÇãÈñ¢Êï∞ ---
+    void draw_sdl2_window(SDL_Window* window);
+
+    // --- „ÇΩ„Ç±„ÉÉ„ÉàÈñ¢ÈÄ£Èñ¢Êï∞Ôºàosd_socket.cppÂÆöÁæ©„Å®‰∏ÄËá¥Ôºâ ---
+    void initialize_socket();
+    void release_socket();
+    void notify_socket_connected(int ch);
+    void notify_socket_disconnected(int ch);
+    void update_socket();
+    bool initialize_socket_tcp(int ch);
+    bool initialize_socket_udp(int ch);
+    bool connect_socket(int ch, uint32_t ipaddr, int port);
+    void disconnect_socket(int ch);
+    bool listen_socket(int ch);
+    void send_socket_data_tcp(int ch);
+    void send_socket_data_udp(int ch, uint32_t ipaddr, int port);
+    void send_socket_data(int ch);
+    void recv_socket_data(int ch);
+    OSD() { lock_count = 0; }
+    ~OSD() {}
+	VM_TEMPLATE* vm;
+    void initialize(int rate, int samples);
+    void release();
+    void power_off();
+    void suspend();
+    void restore();
+    void lock_vm();
+    void unlock_vm();
+    BOOL is_vm_locked();
+    void force_unlock_vm();
+    void sleep(DWORD ms);
+    void start_waiting_in_debugger();
+    void finish_waiting_in_debugger();
+    void process_waiting_in_debugger();
+    void open_console(int width, int height, const _TCHAR* title);
+    void close_console();
+    unsigned int get_console_code_page();
+    void set_console_text_attribute(unsigned short attr);
+    void write_console(const _TCHAR* buffer, unsigned int length);
+    int read_console_input(_TCHAR* buffer, unsigned int length);
+    BOOL is_console_key_pressed(int vk);
+    BOOL is_console_closed();
+    void close_debugger_console();
+    void update_input();
+    void key_down(int code, bool extended, bool repeat);
+    void key_up(int code, bool extended);
+    void key_down_native(int code, bool repeat);
+    void key_up_native(int code);
+    void key_lost_focus();
+    void enable_mouse();
+    void disable_mouse();
+    void toggle_mouse();
+#ifdef USE_MOUSE
+    bool is_mouse_enabled() { return FALSE;}
+#endif
+    uint8_t* get_key_buffer()
+    {
+		return key_status;
+    }
+#ifdef USE_JOYSTICK
+    unsigned int* get_joy_buffer() { return joy_status; }
+#endif
+#ifdef USE_MOUSE
+    int* get_mouse_buffer() { return mouse_status; }
+#endif
+#ifdef USE_AUTO_KEY
+    BOOL now_auto_key;
+#endif
+    double get_window_mode_power(int mode);
+    int get_window_mode_width(int mode);
+    int get_window_mode_height(int mode);
+    void set_host_window_size(int window_width, int window_height, BOOL window_mode);
+    void set_vm_screen_size(int screen_width, int screen_height, int window_width, int window_height, int window_width_aspect, int window_height_aspect);
+    void set_vm_screen_lines(int lines);
+    int get_vm_window_width() { return vm_window_width; }
+    int get_vm_window_height() { return vm_window_height; }
+    int get_vm_window_width_aspect() { return vm_window_width_aspect; }
+    int get_vm_window_height_aspect() { return vm_window_height_aspect; }
+    scrntype_t* get_vm_screen_buffer(int y);
+	int draw_screen();
+#ifdef ONE_BOARD_MICRO_COMPUTER
+	void reload_bitmap()
+	{
+		first_invalidate = true;
+	}
+#endif
+    void capture_screen();
+    BOOL start_record_video(int fps);
+    void stop_record_video();
+    void restart_record_video();
+    void add_extra_frames(int extra_frames);
+    BOOL now_record_video;
+#ifdef USE_SCREEN_FILTER
+    BOOL screen_skip_line;
+#endif
+    void update_sound(int* extra_frames);
+    void mute_sound();
+    void stop_sound();
+    void start_record_sound();
+    void stop_record_sound();
+    void restart_record_sound();
+    BOOL now_record_sound;
+#ifdef _UNITY
+    short* get_sound_buffer();
+#endif
+#if defined(USE_MOVIE_PLAYER) || defined(USE_VIDEO_CAPTURE)
+    void get_video_buffer();
+    void mute_video_dev(BOOL l, BOOL r);
+#endif
+#ifdef USE_MOVIE_PLAYER
+    BOOL open_movie_file(const _TCHAR* file_path);
+    void close_movie_file();
+    void play_movie();
+    void stop_movie();
+    void pause_movie();
+    double get_movie_frame_rate() { return movie_frame_rate; }
+    int get_movie_sound_rate() { return movie_sound_rate; }
+    void set_cur_movie_frame(int frame, BOOL relative);
+    DWORD get_cur_movie_frame();
+    BOOL now_movie_play, now_movie_pause;
+#endif
+#ifdef USE_VIDEO_CAPTURE
+    int get_cur_capture_dev_index() { return cur_capture_dev_index; }
+    int get_num_capture_devs() { return num_capture_devs; }
+    _TCHAR* get_capture_dev_name(int index) { return capture_dev_name[index]; }
+    void open_capture_dev(int index, BOOL pin);
+    void close_capture_dev();
+    void show_capture_dev_filter();
+    void show_capture_dev_pin();
+    void show_capture_dev_source();
+    void set_capture_dev_channel(int ch);
+#endif
+#ifdef USE_PRINTER
+    void create_bitmap(bitmap_t *bitmap, int width, int height);
+    void release_bitmap(bitmap_t *bitmap);
+    void create_font(font_t *font, const _TCHAR *family, int width, int height, int rotate, BOOL bold, BOOL italic);
+    void release_font(font_t *font);
+    void create_pen(pen_t *pen, int width, BYTE r, BYTE g, BYTE b);
+    void release_pen(pen_t *pen);
+    void clear_bitmap(bitmap_t *bitmap, BYTE r, BYTE g, BYTE b);
+    int get_text_width(bitmap_t *bitmap, font_t *font, const char *text);
+    void draw_text_to_bitmap(bitmap_t *bitmap, font_t *font, int x, int y, const char *text, BYTE r, BYTE g, BYTE b);
+    void draw_line_to_bitmap(bitmap_t *bitmap, pen_t *pen, int sx, int sy, int ex, int ey);
+    void draw_rectangle_to_bitmap(bitmap_t *bitmap, int x, int y, int width, int height, BYTE r, BYTE g, BYTE b);
+    void draw_point_to_bitmap(bitmap_t *bitmap, int x, int y, BYTE r, BYTE g, BYTE b);
+    void stretch_bitmap(bitmap_t *dest, int dest_x, int dest_y, int dest_width, int dest_height, bitmap_t *source, int source_x, int source_y, int source_width, int source_height);
+#endif
+    void write_bitmap_to_file(bitmap_t *bitmap, const _TCHAR *file_path);
+#ifdef USE_SOCKET
+    SOCKET get_socket(int ch) { return soc[ch]; }
+    void notify_socket_connected(int ch);
+    void notify_socket_disconnected(int ch);
+    void update_socket();
+    BOOL initialize_socket_tcp(int ch);
+    BOOL initialize_socket_udp(int ch);
+    BOOL connect_socket(int ch, DWORD ipaddr, int port);
+    void disconnect_socket(int ch);
+    BOOL listen_socket(int ch);
+    void send_socket_data_tcp(int ch);
+    void send_socket_data_udp(int ch, DWORD ipaddr, int port);
+    void send_socket_data(int ch);
+    void recv_socket_data(int ch);
+#endif
+#ifdef USE_MIDI
+    void send_to_midi(BYTE data);
+    BOOL recv_from_midi(BYTE *data);
+#endif
+    void invalidate_screen();
+    void update_screen(HDC hdc);
+    HWND main_window_handle;
+    HINSTANCE instance_handle;
+    BOOL vista_or_later;
+    // --- „ÉÄ„Éü„ÉºÊèèÁîª„Éª„É™„ÇΩ„Éº„ÇπÈñ¢ÈÄ£Èñ¢Êï∞ÂÆ£Ë®ÄÔºàstubÁî®Ôºâ ---
+};
+
+#if defined(USE_MOVIE_PLAYER) || defined(USE_VIDEO_CAPTURE)
+class CMySampleGrabberCB {};
+#endif
+#include "../platform_types.h"
+
+
+LRESULT CALLBACK MyWndProc(HWND hWnd, UINT iMsg, WPARAM wParam, LPARAM lParam);
+
+#endif /* _WIN32_OSD_H_ */
diff -ruN source/src/sdl2/osd_console.cpp src/sdl2/osd_console.cpp
--- source/src/sdl2/osd_console.cpp	1970-01-01 09:00:00
+++ src/sdl2/osd_console.cpp	2025-04-28 22:36:36
@@ -0,0 +1,24 @@
+/*
+    Stub implementation for osd_console.cpp
+    This file is auto-generated to avoid Windows dependency.
+*/
+
+#include "osd.h"
+
+// OSD class member functions (empty implementation)
+void OSD::initialize_console() {}
+void OSD::release_console() {}
+void OSD::open_console(int width, int height, const _TCHAR* title) {}
+void OSD::close_console() {}
+unsigned int OSD::get_console_code_page() { return 0; }
+void OSD::set_console_text_attribute(unsigned short attr) {}
+void OSD::write_console(const _TCHAR* buffer, unsigned int length) {}
+int OSD::read_console_input(_TCHAR* buffer, unsigned int length) { return 0; }
+BOOL OSD::is_console_key_pressed(int vk) { return FALSE; }
+BOOL OSD::is_console_closed() { return FALSE; }
+void OSD::close_debugger_console() {}
+void OSD::open_telnet(const _TCHAR* title) {}
+void OSD::close_telnet() {}
+void OSD::send_telnet(const char* string) {}
+
+// Global functions (empty implementation)
\ No newline at end of file
diff -ruN source/src/sdl2/osd_input.cpp src/sdl2/osd_input.cpp
--- source/src/sdl2/osd_input.cpp	1970-01-01 09:00:00
+++ src/sdl2/osd_input.cpp	2025-04-28 22:36:36
@@ -0,0 +1,668 @@
+// SDL2Áî® osd_input.cpp - Win32Áâà„É≠„Ç∏„ÉÉ„ÇØÊ∫ñÊã† key_down/key_up + key_down_native/key_up_nativeÂÆüË£Ö
+#include "osd.h"
+#include "../fifo.h"
+#include <SDL.h>
+#include <cstring>
+
+// Define Windows key constants that we'll use
+#define VK_SHIFT     0x10
+#define VK_CONTROL   0x11
+#define VK_MENU      0x12
+#define VK_CAPITAL   0x14
+#define VK_KANA      0x15
+#define VK_KANJI     0x19
+#define VK_ESCAPE    0x1B
+#define VK_SPACE     0x20
+#define VK_PRIOR     0x21
+#define VK_NEXT      0x22
+#define VK_END       0x23
+#define VK_HOME      0x24
+#define VK_LEFT      0x25
+#define VK_UP        0x26
+#define VK_RIGHT     0x27
+#define VK_DOWN      0x28
+#define VK_INSERT    0x2D
+#define VK_DELETE    0x2E
+#define VK_LSHIFT    0xA0
+#define VK_RSHIFT    0xA1
+#define VK_LCONTROL  0xA2
+#define VK_RCONTROL  0xA3
+#define VK_LMENU     0xA4
+#define VK_RMENU     0xA5
+#define VK_NUMPAD0   0x60
+#define VK_NUMPAD1   0x61
+#define VK_NUMPAD2   0x62
+#define VK_NUMPAD3   0x63
+#define VK_NUMPAD4   0x64
+#define VK_NUMPAD5   0x65
+#define VK_NUMPAD6   0x66
+#define VK_NUMPAD7   0x67
+#define VK_NUMPAD8   0x68
+#define VK_NUMPAD9   0x69
+#define VK_CLEAR     0x0C
+
+// --- SDL scancode to Windows virtual key (VK_*) mapping ---
+static uint8_t sdl_scancode_to_vk[SDL_NUM_SCANCODES]; // ÈùôÁöÑÂàùÊúüÂåñ„Çí„ÇÑ„ÇÅ„Çã
+
+// ÂàùÊúüÂåñÈñ¢Êï∞„ÇíËøΩÂä†
+static void initialize_sdl_scancode_to_vk()
+{
+    memset(sdl_scancode_to_vk, 0, sizeof(sdl_scancode_to_vk));
+    sdl_scancode_to_vk[SDL_SCANCODE_A] = 0x41;
+    sdl_scancode_to_vk[SDL_SCANCODE_B] = 0x42;
+    sdl_scancode_to_vk[SDL_SCANCODE_C] = 0x43;
+    sdl_scancode_to_vk[SDL_SCANCODE_D] = 0x44;
+    sdl_scancode_to_vk[SDL_SCANCODE_E] = 0x45;
+    sdl_scancode_to_vk[SDL_SCANCODE_F] = 0x46;
+    sdl_scancode_to_vk[SDL_SCANCODE_G] = 0x47;
+    sdl_scancode_to_vk[SDL_SCANCODE_H] = 0x48;
+    sdl_scancode_to_vk[SDL_SCANCODE_I] = 0x49;
+    sdl_scancode_to_vk[SDL_SCANCODE_J] = 0x4A;
+    sdl_scancode_to_vk[SDL_SCANCODE_K] = 0x4B;
+    sdl_scancode_to_vk[SDL_SCANCODE_L] = 0x4C;
+    sdl_scancode_to_vk[SDL_SCANCODE_M] = 0x4D;
+    sdl_scancode_to_vk[SDL_SCANCODE_N] = 0x4E;
+    sdl_scancode_to_vk[SDL_SCANCODE_O] = 0x4F;
+    sdl_scancode_to_vk[SDL_SCANCODE_P] = 0x50;
+    sdl_scancode_to_vk[SDL_SCANCODE_Q] = 0x51;
+    sdl_scancode_to_vk[SDL_SCANCODE_R] = 0x52;
+    sdl_scancode_to_vk[SDL_SCANCODE_S] = 0x53;
+    sdl_scancode_to_vk[SDL_SCANCODE_T] = 0x54;
+    sdl_scancode_to_vk[SDL_SCANCODE_U] = 0x55;
+    sdl_scancode_to_vk[SDL_SCANCODE_V] = 0x56;
+    sdl_scancode_to_vk[SDL_SCANCODE_W] = 0x57;
+    sdl_scancode_to_vk[SDL_SCANCODE_X] = 0x58;
+    sdl_scancode_to_vk[SDL_SCANCODE_Y] = 0x59;
+    sdl_scancode_to_vk[SDL_SCANCODE_Z] = 0x5A;
+    sdl_scancode_to_vk[SDL_SCANCODE_0] = 0x30;
+    sdl_scancode_to_vk[SDL_SCANCODE_1] = 0x31;
+    sdl_scancode_to_vk[SDL_SCANCODE_2] = 0x32;
+    sdl_scancode_to_vk[SDL_SCANCODE_3] = 0x33;
+    sdl_scancode_to_vk[SDL_SCANCODE_4] = 0x34;
+    sdl_scancode_to_vk[SDL_SCANCODE_5] = 0x35;
+    sdl_scancode_to_vk[SDL_SCANCODE_6] = 0x36;
+    sdl_scancode_to_vk[SDL_SCANCODE_7] = 0x37;
+    sdl_scancode_to_vk[SDL_SCANCODE_8] = 0x38;
+    sdl_scancode_to_vk[SDL_SCANCODE_9] = 0x39;
+    sdl_scancode_to_vk[SDL_SCANCODE_RETURN] = 0x0D;
+    sdl_scancode_to_vk[SDL_SCANCODE_ESCAPE] = VK_ESCAPE;
+    sdl_scancode_to_vk[SDL_SCANCODE_BACKSPACE] = 0x08;
+    sdl_scancode_to_vk[SDL_SCANCODE_TAB] = 0x09;
+    sdl_scancode_to_vk[SDL_SCANCODE_SPACE] = VK_SPACE;
+    sdl_scancode_to_vk[SDL_SCANCODE_MINUS] = 0xBD;
+    sdl_scancode_to_vk[SDL_SCANCODE_EQUALS] = 0xBB;
+    sdl_scancode_to_vk[SDL_SCANCODE_LEFTBRACKET] = 0xDB;
+    sdl_scancode_to_vk[SDL_SCANCODE_RIGHTBRACKET] = 0xDD;
+    sdl_scancode_to_vk[SDL_SCANCODE_BACKSLASH] = 0xDC;
+    sdl_scancode_to_vk[SDL_SCANCODE_SEMICOLON] = 0xBA;
+    sdl_scancode_to_vk[SDL_SCANCODE_APOSTROPHE] = 0xDE;
+    sdl_scancode_to_vk[SDL_SCANCODE_GRAVE] = 0xC0;
+    sdl_scancode_to_vk[SDL_SCANCODE_COMMA] = 0xBC;
+    sdl_scancode_to_vk[SDL_SCANCODE_PERIOD] = 0xBE;
+    sdl_scancode_to_vk[SDL_SCANCODE_SLASH] = 0xBF;
+    sdl_scancode_to_vk[SDL_SCANCODE_LSHIFT] = VK_LSHIFT;
+    sdl_scancode_to_vk[SDL_SCANCODE_RSHIFT] = VK_RSHIFT;
+    sdl_scancode_to_vk[SDL_SCANCODE_LCTRL] = VK_LCONTROL;
+    sdl_scancode_to_vk[SDL_SCANCODE_RCTRL] = VK_RCONTROL;
+    sdl_scancode_to_vk[SDL_SCANCODE_LALT] = VK_LMENU;
+    sdl_scancode_to_vk[SDL_SCANCODE_RALT] = VK_RMENU;
+    sdl_scancode_to_vk[SDL_SCANCODE_CAPSLOCK] = VK_CAPITAL;
+    sdl_scancode_to_vk[SDL_SCANCODE_F1] = 0x70;
+    sdl_scancode_to_vk[SDL_SCANCODE_F2] = 0x71;
+    sdl_scancode_to_vk[SDL_SCANCODE_F3] = 0x72;
+    sdl_scancode_to_vk[SDL_SCANCODE_F4] = 0x73;
+    sdl_scancode_to_vk[SDL_SCANCODE_F5] = 0x74;
+    sdl_scancode_to_vk[SDL_SCANCODE_F6] = 0x75;
+    sdl_scancode_to_vk[SDL_SCANCODE_F7] = 0x76;
+    sdl_scancode_to_vk[SDL_SCANCODE_F8] = 0x77;
+    sdl_scancode_to_vk[SDL_SCANCODE_F9] = 0x78;
+    sdl_scancode_to_vk[SDL_SCANCODE_F10] = 0x79;
+    sdl_scancode_to_vk[SDL_SCANCODE_F11] = 0x7A;
+    sdl_scancode_to_vk[SDL_SCANCODE_F12] = 0x7B;
+    sdl_scancode_to_vk[SDL_SCANCODE_PRINTSCREEN] = 0x2C;
+    sdl_scancode_to_vk[SDL_SCANCODE_SCROLLLOCK] = 0x91;
+    sdl_scancode_to_vk[SDL_SCANCODE_PAUSE] = 0x13;
+    sdl_scancode_to_vk[SDL_SCANCODE_INSERT] = VK_INSERT;
+    sdl_scancode_to_vk[SDL_SCANCODE_HOME] = VK_HOME;
+    sdl_scancode_to_vk[SDL_SCANCODE_PAGEUP] = VK_PRIOR;
+    sdl_scancode_to_vk[SDL_SCANCODE_DELETE] = VK_DELETE;
+    sdl_scancode_to_vk[SDL_SCANCODE_END] = VK_END;
+    sdl_scancode_to_vk[SDL_SCANCODE_PAGEDOWN] = VK_NEXT;
+    sdl_scancode_to_vk[SDL_SCANCODE_RIGHT] = VK_RIGHT;
+    sdl_scancode_to_vk[SDL_SCANCODE_LEFT] = VK_LEFT;
+    sdl_scancode_to_vk[SDL_SCANCODE_DOWN] = VK_DOWN;
+    sdl_scancode_to_vk[SDL_SCANCODE_UP] = VK_UP;
+    sdl_scancode_to_vk[SDL_SCANCODE_NUMLOCKCLEAR] = 0x90;
+    sdl_scancode_to_vk[SDL_SCANCODE_KP_DIVIDE] = 0x6F;
+    sdl_scancode_to_vk[SDL_SCANCODE_KP_MULTIPLY] = 0x6A;
+    sdl_scancode_to_vk[SDL_SCANCODE_KP_MINUS] = 0x6D;
+    sdl_scancode_to_vk[SDL_SCANCODE_KP_PLUS] = 0x6B;
+    sdl_scancode_to_vk[SDL_SCANCODE_KP_ENTER] = 0x0D;
+    sdl_scancode_to_vk[SDL_SCANCODE_KP_1] = VK_NUMPAD1;
+    sdl_scancode_to_vk[SDL_SCANCODE_KP_2] = VK_NUMPAD2;
+    sdl_scancode_to_vk[SDL_SCANCODE_KP_3] = VK_NUMPAD3;
+    sdl_scancode_to_vk[SDL_SCANCODE_KP_4] = VK_NUMPAD4;
+    sdl_scancode_to_vk[SDL_SCANCODE_KP_5] = VK_NUMPAD5;
+    sdl_scancode_to_vk[SDL_SCANCODE_KP_6] = VK_NUMPAD6;
+    sdl_scancode_to_vk[SDL_SCANCODE_KP_7] = VK_NUMPAD7;
+    sdl_scancode_to_vk[SDL_SCANCODE_KP_8] = VK_NUMPAD8;
+    sdl_scancode_to_vk[SDL_SCANCODE_KP_9] = VK_NUMPAD9;
+    sdl_scancode_to_vk[SDL_SCANCODE_KP_0] = VK_NUMPAD0;
+    sdl_scancode_to_vk[SDL_SCANCODE_KP_PERIOD] = 0x6E;
+    sdl_scancode_to_vk[SDL_SCANCODE_INTERNATIONAL1] = 0xC1;
+    sdl_scancode_to_vk[SDL_SCANCODE_INTERNATIONAL2] = VK_KANA;
+    sdl_scancode_to_vk[SDL_SCANCODE_INTERNATIONAL3] = 0xD2;
+    sdl_scancode_to_vk[SDL_SCANCODE_INTERNATIONAL4] = 0xDB;
+    sdl_scancode_to_vk[SDL_SCANCODE_INTERNATIONAL5] = VK_KANJI;
+}
+
+// Constants for handling key states (from win32 version)
+#define KEY_KEEP_FRAMES 2 // minimum key press frames
+
+void OSD::initialize_input()
+{
+    initialize_sdl_scancode_to_vk(); // ËøΩÂä†
+    // initialize status
+    memset(key_status, 0, sizeof(key_status));
+#ifdef USE_JOYSTICK
+    memset(joy_status, 0, sizeof(joy_status));
+    memset(joy_to_key_status, 0, sizeof(joy_to_key_status));
+#endif
+#ifdef USE_MOUSE
+    memset(mouse_status, 0, sizeof(mouse_status));
+#endif
+    
+    // In SDL2 we manage keyboard input directly, no need for DirectInput
+    
+    // initialize keycode convert table
+    FILEIO* fio = new FILEIO();
+    if(fio->Fopen(create_local_path(_T("keycode.cfg")), FILEIO_READ_BINARY)) {
+        fio->Fread(keycode_conv, sizeof(keycode_conv), 1);
+        fio->Fclose();
+    } else {
+        for(int i = 0; i < 256; i++) {
+            keycode_conv[i] = i;
+        }
+    }
+    delete fio;
+    
+    key_shift_pressed = key_shift_released = false;
+    key_caps_locked = (SDL_GetModState() & KMOD_CAPS) != 0;
+    
+    lost_focus = false;
+}
+
+void OSD::release_input()
+{
+#ifdef USE_MOUSE
+    // release mouse
+    if(mouse_enabled) {
+        disable_mouse();
+    }
+#endif
+    
+    // No DirectInput to release in SDL2
+}
+
+void OSD::update_input()
+{
+#ifdef USE_AUTO_KEY
+    if(!now_auto_key && !config.romaji_to_kana) {
+#endif
+        // Win32Áâà„Å®ÂêåÊßò„ÅÆÂá¶ÁêÜ: NumPad„Ç≠„Éº„Å®„Ç∑„Éï„Éà„Ç≠„Éº„ÅÆÈÄ£ÂãïÂá¶ÁêÜ
+        
+        // „Åì„ÅÆÈÉ®ÂàÜ„ÅØWin32Áâà„ÅÆDirectInput„Åß„ÅÆ„Ç≠„ÉºÁä∂ÊÖãÂèñÂæó„Å´Áõ∏ÂΩì
+        const uint8_t* keyboard_state = SDL_GetKeyboardState(NULL);
+        
+        // NumPad„Ç≠„Éº„ÅÆÁä∂ÊÖã„ÇíÁ¢∫Ë™ç
+        uint8_t numpad_keys = 0;
+        numpad_keys |= keyboard_state[SDL_SCANCODE_KP_0] ? 0x80 : 0;
+        numpad_keys |= keyboard_state[SDL_SCANCODE_KP_1] ? 0x80 : 0;
+        numpad_keys |= keyboard_state[SDL_SCANCODE_KP_2] ? 0x80 : 0;
+        numpad_keys |= keyboard_state[SDL_SCANCODE_KP_3] ? 0x80 : 0;
+        numpad_keys |= keyboard_state[SDL_SCANCODE_KP_4] ? 0x80 : 0;
+        numpad_keys |= keyboard_state[SDL_SCANCODE_KP_5] ? 0x80 : 0;
+        numpad_keys |= keyboard_state[SDL_SCANCODE_KP_6] ? 0x80 : 0;
+        numpad_keys |= keyboard_state[SDL_SCANCODE_KP_7] ? 0x80 : 0;
+        numpad_keys |= keyboard_state[SDL_SCANCODE_KP_8] ? 0x80 : 0;
+        numpad_keys |= keyboard_state[SDL_SCANCODE_KP_9] ? 0x80 : 0;
+        
+        // win32Áâà„Å®„ÅÆ‰∫íÊèõÊÄß: NumPad„Ç≠„Éº„ÅåÊäº„Åï„Çå„Å¶„ÅÑ„ÇãÈñì„ÅØ„Ç∑„Éï„Éà„Ç≠„Éº„Çí‰øùÊåÅ
+        if(numpad_keys & 0x80) {
+            // „Ç∑„Éï„Éà„Ç≠„Éº„ÅÆÁä∂ÊÖã„Çí‰øùÊåÅÔºàWin32Áâà„ÅÆDIK_LSHIFT/DIK_RSHIFT„Å´Áõ∏ÂΩìÔºâ
+            if(!key_shift_pressed && !key_shift_released && key_status[VK_LSHIFT]) {
+                key_status[VK_LSHIFT] |= 0x80;
+            }
+            if(key_status[VK_RSHIFT]) {
+                key_status[VK_RSHIFT] |= 0x80;
+            }
+        }
+        
+        // win32Áâà„Å®„ÅÆ‰∫íÊèõÊÄß: „Ç∑„Éï„Éà„Ç≠„Éº„ÅÆÊõ¥Êñ∞Âá¶ÁêÜ
+        if(key_shift_pressed && !key_shift_released) {
+            if(key_status[VK_LSHIFT] == 0) {
+                // shift key is newly pressed
+                if(!key_status[VK_RSHIFT]) {
+                    vm->key_down(VK_SHIFT, false);
+                }
+                vm->key_down(VK_LSHIFT, false);
+                key_status[VK_LSHIFT] = key_status[VK_SHIFT] = 0x80;
+            }
+        } else if(!key_shift_pressed && key_shift_released) {
+            if(key_status[VK_LSHIFT] != 0) {
+                // shift key is newly released
+                vm->key_up(VK_LSHIFT);
+                if(!key_status[VK_RSHIFT]) {
+                    vm->key_up(VK_SHIFT);
+                }
+                key_status[VK_LSHIFT] = key_status[VK_SHIFT] = 0;
+            }
+        }
+        key_shift_pressed = key_shift_released = false;
+        
+        // update shift + caps lock
+        bool caps_locked = (SDL_GetModState() & KMOD_CAPS) != 0;
+        if(key_caps_locked != caps_locked) {
+            key_down_native(0xf0, false);
+            key_caps_locked = caps_locked;
+        }
+#ifdef USE_AUTO_KEY
+    }
+#endif
+    
+    // release keys
+#ifdef USE_AUTO_KEY
+    if(lost_focus && !now_auto_key) {
+#else
+    if(lost_focus) {
+#endif
+        // we lost key focus so release all pressed keys
+        for(int i = 0; i < 256; i++) {
+            if(key_status[i] & 0x80) {
+                key_status[i] &= 0x7f;
+                if(!key_status[i]) {
+                    vm->key_up(i);
+                }
+            }
+        }
+    } else {
+        for(int i = 0; i < 256; i++) {
+            if(key_status[i] & 0x7f) {
+                key_status[i] = (key_status[i] & 0x80) | ((key_status[i] & 0x7f) - 1);
+                if(!key_status[i]) {
+                    vm->key_up(i);
+                }
+            }
+        }
+    }
+    lost_focus = false;
+    
+    // VK_$00 should be 0
+    key_status[0] = 0;
+    
+#ifdef USE_JOYSTICK
+    // For joystick support, implement SDL_GameController logic here
+    // SDL_GameController is preferred over SDL_Joystick for modern applications
+#endif
+    
+#ifdef USE_MOUSE
+    // Update mouse status using SDL_GetMouseState
+    // Implement this section if mouse support is needed
+#endif
+}
+
+void OSD::key_down(int code, bool extended, bool repeat)
+{
+#ifdef USE_AUTO_KEY
+    if(!now_auto_key && !config.romaji_to_kana) {
+#endif
+        // win32Áâà„Å®„ÅÆ‰∫íÊèõÊÄß„ÅÆ„Åü„ÇÅ„Å´‰øÆÊ≠£
+        if(code == VK_SHIFT) {
+            // „Ç∑„Éï„Éà„Ç≠„Éº„ÅåÊäº„Åï„Çå„ÅüÂ†¥Âêà„ÄÅÂ∑¶Âè≥„Å©„Å°„Çâ„ÅÆ„Ç∑„Éï„Éà„Ç≠„Éº„Åã„ÇíÁâπÂÆö
+            if(!(key_status[VK_RSHIFT] & 0x80) && (SDL_GetKeyboardState(NULL)[SDL_SCANCODE_RSHIFT])) {
+                key_down_native(VK_RSHIFT, repeat);
+            }
+            if(!(key_status[VK_LSHIFT] & 0x80) && (SDL_GetKeyboardState(NULL)[SDL_SCANCODE_LSHIFT])) {
+                code = VK_LSHIFT;
+            } else {
+                return;
+            }
+        } else if(code == VK_CONTROL) {
+            // „Ç≥„É≥„Éà„É≠„Éº„É´„Ç≠„Éº„ÅåÊäº„Åï„Çå„ÅüÂ†¥Âêà„ÄÅÂ∑¶Âè≥„Å©„Å°„Çâ„Åã„ÇíÁâπÂÆö
+            if(!(key_status[VK_RCONTROL] & 0x80) && (SDL_GetKeyboardState(NULL)[SDL_SCANCODE_RCTRL])) {
+                key_down_native(VK_RCONTROL, repeat);
+            }
+            if(!(key_status[VK_LCONTROL] & 0x80) && (SDL_GetKeyboardState(NULL)[SDL_SCANCODE_LCTRL])) {
+                code = VK_LCONTROL;
+            } else {
+                return;
+            }
+        } else if(code == VK_MENU) {
+            // ALT„Ç≠„Éº„ÅåÊäº„Åï„Çå„ÅüÂ†¥Âêà„ÄÅÂ∑¶Âè≥„Å©„Å°„Çâ„Åã„ÇíÁâπÂÆö
+            if(!(key_status[VK_RMENU] & 0x80) && (SDL_GetKeyboardState(NULL)[SDL_SCANCODE_RALT])) {
+                key_down_native(VK_RMENU, repeat);
+            }
+            if(!(key_status[VK_LMENU] & 0x80) && (SDL_GetKeyboardState(NULL)[SDL_SCANCODE_LALT])) {
+                code = VK_LMENU;
+            } else {
+                return;
+            }
+        }
+        
+        // Â∑¶„Ç∑„Éï„Éà„Ç≠„Éº„ÅÆÁâπÂà•„Å™Âá¶ÁêÜ
+        if(code == VK_LSHIFT) {
+            key_shift_pressed = true;
+            return;
+        }
+        
+        // NumPad„Ç≠„Éº„ÅÆÁâπÂà•Âá¶ÁêÜ
+        if(!extended) {
+            switch(code) {
+            case VK_INSERT:
+                if(key_shift_pressed || key_shift_released || key_status[VK_NUMPAD0]) {
+                    code = VK_NUMPAD0;
+                    key_shift_pressed = true;
+                }
+                break;
+            case VK_END:
+                if(key_shift_pressed || key_shift_released || key_status[VK_NUMPAD1]) {
+                    code = VK_NUMPAD1;
+                    key_shift_pressed = true;
+                }
+                break;
+            case VK_DOWN:
+                if(key_shift_pressed || key_shift_released || key_status[VK_NUMPAD2]) {
+                    code = VK_NUMPAD2;
+                    key_shift_pressed = true;
+                }
+                break;
+            case VK_NEXT:
+                if(key_shift_pressed || key_shift_released || key_status[VK_NUMPAD3]) {
+                    code = VK_NUMPAD3;
+                    key_shift_pressed = true;
+                }
+                break;
+            case VK_LEFT:
+                if(key_shift_pressed || key_shift_released || key_status[VK_NUMPAD4]) {
+                    code = VK_NUMPAD4;
+                    key_shift_pressed = true;
+                }
+                break;
+            case VK_CLEAR:
+                if(key_shift_pressed || key_shift_released || key_status[VK_NUMPAD5]) {
+                    code = VK_NUMPAD5;
+                    key_shift_pressed = true;
+                }
+                break;
+            case VK_RIGHT:
+                if(key_shift_pressed || key_shift_released || key_status[VK_NUMPAD6]) {
+                    code = VK_NUMPAD6;
+                    key_shift_pressed = true;
+                }
+                break;
+            case VK_HOME:
+                if(key_shift_pressed || key_shift_released || key_status[VK_NUMPAD7]) {
+                    code = VK_NUMPAD7;
+                    key_shift_pressed = true;
+                }
+                break;
+            case VK_UP:
+                if(key_shift_pressed || key_shift_released || key_status[VK_NUMPAD8]) {
+                    code = VK_NUMPAD8;
+                    key_shift_pressed = true;
+                }
+                break;
+            case VK_PRIOR:
+                if(key_shift_pressed || key_shift_released || key_status[VK_NUMPAD9]) {
+                    code = VK_NUMPAD9;
+                    key_shift_pressed = true;
+                }
+                break;
+            }
+        }
+        key_down_native(code, repeat);
+#ifdef USE_AUTO_KEY
+    }
+#endif
+}
+
+void OSD::key_up(int code, bool extended)
+{
+#ifdef USE_AUTO_KEY
+    if(!now_auto_key && !config.romaji_to_kana) {
+#endif
+        // For SDL2, we need to handle shift key state
+        if(code == VK_SHIFT) {
+            // Check left and right shift states
+            if((key_status[VK_RSHIFT] & 0x80) && !(SDL_GetKeyboardState(NULL)[SDL_SCANCODE_RSHIFT])) {
+                key_up_native(VK_RSHIFT);
+            }
+            if((key_status[VK_LSHIFT] & 0x80) && !(SDL_GetKeyboardState(NULL)[SDL_SCANCODE_LSHIFT])) {
+                code = VK_LSHIFT;
+            } else {
+                return;
+            }
+        } else if(code == VK_CONTROL) {
+            // Check left and right control states
+            if((key_status[VK_RCONTROL] & 0x80) && !(SDL_GetKeyboardState(NULL)[SDL_SCANCODE_RCTRL])) {
+                key_up_native(VK_RCONTROL);
+            }
+            if((key_status[VK_LCONTROL] & 0x80) && !(SDL_GetKeyboardState(NULL)[SDL_SCANCODE_LCTRL])) {
+                code = VK_LCONTROL;
+            } else {
+                return;
+            }
+        } else if(code == VK_MENU) {
+            // Check left and right alt (menu) states
+            if((key_status[VK_RMENU] & 0x80) && !(SDL_GetKeyboardState(NULL)[SDL_SCANCODE_RALT])) {
+                key_up_native(VK_RMENU);
+            }
+            if((key_status[VK_LMENU] & 0x80) && !(SDL_GetKeyboardState(NULL)[SDL_SCANCODE_LALT])) {
+                code = VK_LMENU;
+            } else {
+                return;
+            }
+        }
+        
+        if(code == VK_LSHIFT) {
+            key_shift_pressed = false;
+            key_shift_released = true;
+            return;
+        }
+        
+        if(!extended) {
+            // Handle number pad keys just like the win32 version
+            switch(code) {
+            case VK_NUMPAD0: case VK_INSERT:
+                key_up_native(VK_NUMPAD0);
+                key_up_native(VK_INSERT);
+                return;
+            case VK_NUMPAD1: case VK_END:
+                key_up_native(VK_NUMPAD1);
+                key_up_native(VK_END);
+                return;
+            case VK_NUMPAD2: case VK_DOWN:
+                key_up_native(VK_NUMPAD2);
+                key_up_native(VK_DOWN);
+                return;
+            case VK_NUMPAD3: case VK_NEXT:
+                key_up_native(VK_NUMPAD3);
+                key_up_native(VK_NEXT);
+                return;
+            case VK_NUMPAD4: case VK_LEFT:
+                key_up_native(VK_NUMPAD4);
+                key_up_native(VK_LEFT);
+                return;
+            case VK_NUMPAD5: case VK_CLEAR:
+                key_up_native(VK_NUMPAD5);
+                key_up_native(VK_CLEAR);
+                return;
+            case VK_NUMPAD6: case VK_RIGHT:
+                key_up_native(VK_NUMPAD6);
+                key_up_native(VK_RIGHT);
+                return;
+            case VK_NUMPAD7: case VK_HOME:
+                key_up_native(VK_NUMPAD7);
+                key_up_native(VK_HOME);
+                return;
+            case VK_NUMPAD8: case VK_UP:
+                key_up_native(VK_NUMPAD8);
+                key_up_native(VK_UP);
+                return;
+            case VK_NUMPAD9: case VK_PRIOR:
+                key_up_native(VK_NUMPAD9);
+                key_up_native(VK_PRIOR);
+                return;
+            }
+        }
+        key_up_native(code);
+#ifdef USE_AUTO_KEY
+    }
+#endif
+}
+
+// --- SDL2Áî®: key_down_native ---
+void OSD::key_down_native(int code, bool repeat)
+{
+    bool keep_frames = false;
+    
+    if(code == 0xf0) {
+        code = VK_CAPITAL;
+        keep_frames = true;
+    } else if(code == 0xf1 || code == 0xf2) {
+        code = VK_KANA;
+        keep_frames = true;
+    } else if(code == 0xf3 || code == 0xf4) {
+        code = VK_KANJI;
+        keep_frames = true;
+    }
+    
+    // Win32Áâà„Å®ÂêåÊßò„Å´„ÄÅÂ∑¶„Ç∑„Éï„Éà„Å®Âè≥„Ç∑„Éï„Éà„ÅØÁâπÂà•„Å´Êâ±„ÅÜ
+    if(!(code == VK_LSHIFT || code == VK_RSHIFT || code == VK_LCONTROL || code == VK_RCONTROL || code == VK_LMENU || code == VK_RMENU)) {
+        code = keycode_conv[code];
+    }
+    
+    if(key_status[code] == 0 || keep_frames) {
+        repeat = false;
+    }
+    
+#ifdef DONT_KEEEP_KEY_PRESSED
+    if(!(code == VK_LSHIFT || code == VK_RSHIFT || code == VK_LCONTROL || code == VK_RCONTROL || code == VK_LMENU || code == VK_RMENU)) {
+        key_status[code] = KEY_KEEP_FRAMES;
+    } else
+#endif
+    key_status[code] = keep_frames ? KEY_KEEP_FRAMES : 0x80;
+    
+    uint8_t prev_shift = key_status[VK_SHIFT];
+    uint8_t prev_control = key_status[VK_CONTROL];
+    uint8_t prev_menu = key_status[VK_MENU];
+    
+    // ‰øÆÈ£æ„Ç≠„Éº„ÅÆÁä∂ÊÖã„ÇíÊõ¥Êñ∞
+    key_status[VK_SHIFT] = key_status[VK_LSHIFT] | key_status[VK_RSHIFT];
+    key_status[VK_CONTROL] = key_status[VK_LCONTROL] | key_status[VK_RCONTROL];
+    key_status[VK_MENU] = key_status[VK_LMENU] | key_status[VK_RMENU];
+    
+    // ÂêàÊàê„Ç≠„Éº„ÅÆÈÄöÁü•ÔºàWin32Áâà„Å®Âêå„ÅòÂá¶ÁêÜÔºâ
+    if(code == VK_LSHIFT || code == VK_RSHIFT) {
+        if(prev_shift == 0 && key_status[VK_SHIFT] != 0) {
+            vm->key_down(VK_SHIFT, repeat);
+        }
+    } else if(code == VK_LCONTROL|| code == VK_RCONTROL) {
+        if(prev_control == 0 && key_status[VK_CONTROL] != 0) {
+            vm->key_down(VK_CONTROL, repeat);
+        }
+    } else if(code == VK_LMENU|| code == VK_RMENU) {
+        if(prev_menu == 0 && key_status[VK_MENU] != 0) {
+            vm->key_down(VK_MENU, repeat);
+        }
+    }
+    
+    // VK_LSHIFT„ÅÆÂ†¥Âêà„ÅØvm->key_down„ÇíÂëº„Å∞„Å™„ÅÑÔºàWin32Áâà„Å®„ÅÆ‰∫íÊèõÊÄß„ÅÆ„Åü„ÇÅÔºâ
+    if(code != VK_LSHIFT) {
+        vm->key_down(code, repeat);
+    }
+}
+
+// --- SDL2Áî®: key_up_native ---
+void OSD::key_up_native(int code) {
+    if(!(code == VK_LSHIFT || code == VK_RSHIFT || code == VK_LCONTROL || code == VK_RCONTROL || code == VK_LMENU || code == VK_RMENU)) {
+        code = keycode_conv[code];
+    }
+    if(key_status[code] == 0) {
+        return;
+    }
+    
+    // „Ç≠„ÉºËß£ÊîæÂá¶ÁêÜ„ÅÆÊîπÂñÑ - ‰øÆÈ£æ„Ç≠„Éº„ÅÆÂ†¥Âêà„ÅØÁâπÂà•Âá¶ÁêÜ
+    if(code == VK_LSHIFT || code == VK_RSHIFT || code == VK_LCONTROL || code == VK_RCONTROL || code == VK_LMENU || code == VK_RMENU) {
+        key_status[code] = 0; // ÂÆåÂÖ®„Å´Ëß£Êîæ
+    } else {
+        if((key_status[code] &= 0x7f) != 0) {
+            return;
+        }
+    }
+    
+    vm->key_up(code);
+    
+    uint8_t prev_shift = key_status[VK_SHIFT];
+    uint8_t prev_control = key_status[VK_CONTROL];
+    uint8_t prev_menu = key_status[VK_MENU];
+    
+    key_status[VK_SHIFT] = key_status[VK_LSHIFT] | key_status[VK_RSHIFT];
+    key_status[VK_CONTROL] = key_status[VK_LCONTROL] | key_status[VK_RCONTROL];
+    key_status[VK_MENU] = key_status[VK_LMENU] | key_status[VK_RMENU];
+    
+    if(code == VK_LSHIFT || code == VK_RSHIFT) {
+        if(prev_shift != 0 && key_status[VK_SHIFT] == 0) {
+            vm->key_up(VK_SHIFT);
+        }
+    } else if(code == VK_LCONTROL|| code == VK_RCONTROL) {
+        if(prev_control != 0 && key_status[VK_CONTROL] == 0) {
+            vm->key_up(VK_CONTROL);
+        }
+    } else if(code == VK_LMENU || code == VK_RMENU) {
+        if(prev_menu != 0 && key_status[VK_MENU] == 0) {
+            vm->key_up(VK_MENU);
+        }
+    }
+}
+
+// Helper function for SDL scancode to virtual key conversion
+extern "C" int sdl_scancode_to_vkcode(int scancode)
+{
+    if (scancode < 0 || scancode >= SDL_NUM_SCANCODES) return 0;
+    return sdl_scancode_to_vk[scancode];
+}
+
+#ifdef USE_MOUSE
+void OSD::enable_mouse()
+{
+    // enable mouse emulation using SDL2
+    if(!mouse_enabled) {
+        // hide mouse cursor
+        SDL_ShowCursor(SDL_DISABLE);
+        // set relative mouse mode
+        SDL_SetRelativeMouseMode(SDL_TRUE);
+    }
+    mouse_enabled = true;
+}
+
+void OSD::disable_mouse()
+{
+    // disable mouse emulation
+    if(mouse_enabled) {
+        SDL_ShowCursor(SDL_ENABLE);
+        SDL_SetRelativeMouseMode(SDL_FALSE);
+    }
+    mouse_enabled = false;
+}
+
+void OSD::toggle_mouse()
+{
+    // toggle mouse enable / disable
+    if(mouse_enabled) {
+        disable_mouse();
+    } else {
+        enable_mouse();
+    }
+}
+#endif
\ No newline at end of file
diff -ruN source/src/sdl2/osd_midi.cpp src/sdl2/osd_midi.cpp
--- source/src/sdl2/osd_midi.cpp	1970-01-01 09:00:00
+++ src/sdl2/osd_midi.cpp	2025-04-28 22:36:36
@@ -0,0 +1,15 @@
+/*
+    Stub implementation for osd_midi.cpp
+    This file is auto-generated to avoid Windows dependency.
+*/
+
+#include "osd.h"
+
+// OSD class member functions (empty implementation)
+void OSD::initialize_midi() {}
+void OSD::release_midi() {}
+void OSD::send_to_midi(uint8_t data) {}
+bool OSD::recv_from_midi(uint8_t *data) { return false; }
+
+// Global function (empty implementation)
+unsigned __stdcall midi_thread(void *lpx) { return 0; }
\ No newline at end of file
diff -ruN source/src/sdl2/osd_screen.cpp src/sdl2/osd_screen.cpp
--- source/src/sdl2/osd_screen.cpp	1970-01-01 09:00:00
+++ src/sdl2/osd_screen.cpp	2025-04-28 22:36:36
@@ -0,0 +1,326 @@
+/*
+    SDL2 implementation for osd_screen.cpp
+    Windows‰æùÂ≠ò„ÇíÊéíÈô§„Åó„ÄÅSDL2„ÅßÁîªÈù¢ÊèèÁîª„ÇíË°å„ÅÜ
+    ÂèÇËÄÉ: src/win32/osd_screen.cpp
+*/
+
+#include "osd.h"
+#include <SDL.h>
+#include <cstring>
+
+static SDL_Window* sdl_window = nullptr;
+// SDL_Renderer*„Å®SDL_Texture*„ÅØOSD„ÇØ„É©„Çπ„ÅÆ„É°„É≥„Éê„Å®„Åó„Å¶ÁÆ°ÁêÜ
+
+// SDL2Áî®„ÅÆÁîªÈù¢„Éê„ÉÉ„Éï„Ç°ÊÉÖÂ†±
+static int sdl_tex_width = 0;
+static int sdl_tex_height = 0;
+
+// VMÁîªÈù¢„Éê„ÉÉ„Éï„Ç°„ÅÆÂàùÊúüÂåñ
+void OSD::initialize_screen()
+{
+    host_window_width = WINDOW_WIDTH;
+    host_window_height = WINDOW_HEIGHT;
+    host_window_mode = true;
+
+    vm_screen_width = SCREEN_WIDTH;
+    vm_screen_height = SCREEN_HEIGHT;
+    vm_window_width = WINDOW_WIDTH;
+    vm_window_height = WINDOW_HEIGHT;
+    vm_window_width_aspect = WINDOW_WIDTH_ASPECT;
+    vm_window_height_aspect = WINDOW_HEIGHT_ASPECT;
+
+    // ÁîªÈù¢„Éê„ÉÉ„Éï„Ç°ÊßãÈÄ†‰Ωì„Çí„ÇØ„É™„Ç¢
+    memset(&vm_screen_buffer, 0, sizeof(bitmap_t));
+    // „Éê„ÉÉ„Éï„Ç°„ÇíÁ¢∫‰øù
+    initialize_screen_buffer(&vm_screen_buffer, vm_screen_width, vm_screen_height, 0);
+
+    printf("[initialize_screen] called\n");
+    printf("[initialize_screen] vm_screen_width=%d, vm_screen_height=%d\n", vm_screen_width, vm_screen_height);
+
+
+    // SDL2ÂàùÊúüÂåñÔºàÂøÖË¶Å„Å™„ÇâÔºâ
+    if (SDL_WasInit(SDL_INIT_VIDEO) == 0) {
+        int ret = SDL_Init(SDL_INIT_VIDEO);
+        printf("[initialize_screen] SDL_Init(SDL_INIT_VIDEO) ret=%d\n", ret);
+    } else {
+        printf("[initialize_screen] SDL already initialized\n");
+    }
+
+    // „Ç¶„Ç£„É≥„Éâ„Ç¶ÁîüÊàê
+    this->sdl_window = SDL_CreateWindow(
+        "Emulator",
+        SDL_WINDOWPOS_CENTERED, SDL_WINDOWPOS_CENTERED,
+        vm_screen_width > 0 ? vm_screen_width : 640,
+        vm_screen_height > 0 ? vm_screen_height : 480,
+        SDL_WINDOW_SHOWN
+    );
+    printf("[initialize_screen] SDL_CreateWindow: %p (err=%s)\n", this->sdl_window, SDL_GetError());
+    if (!this->sdl_window) {
+        printf("SDL_CreateWindow failed: %s\n", SDL_GetError());
+        return;
+    }
+
+    // „É¨„É≥„ÉÄ„É©„ÉºÁîüÊàê
+    this->sdl_renderer = SDL_CreateRenderer(this->sdl_window, -1, SDL_RENDERER_ACCELERATED | SDL_RENDERER_PRESENTVSYNC);
+    printf("[initialize_screen] SDL_CreateRenderer: %p (err=%s)\n", this->sdl_renderer, SDL_GetError());
+    if (!this->sdl_renderer) {
+        printf("SDL_CreateRenderer failed: %s\n", SDL_GetError());
+        SDL_DestroyWindow(this->sdl_window);
+        this->sdl_window = nullptr;
+        return;
+    }
+
+    // „ÉÜ„ÇØ„Çπ„ÉÅ„É£ÁîüÊàê
+    this->sdl_texture = SDL_CreateTexture(
+        this->sdl_renderer,
+        SDL_PIXELFORMAT_RGB888,
+        SDL_TEXTUREACCESS_STREAMING,
+        vm_screen_width > 0 ? vm_screen_width : 640,
+        vm_screen_height > 0 ? vm_screen_height : 480
+    );
+    printf("[initialize_screen] SDL_CreateTexture: %p (err=%s)\n", this->sdl_texture, SDL_GetError());
+    if (!this->sdl_texture) {
+        printf("SDL_CreateTexture failed: %s\n", SDL_GetError());
+        SDL_DestroyRenderer(this->sdl_renderer);
+        SDL_DestroyWindow(this->sdl_window);
+        this->sdl_renderer = nullptr;
+        this->sdl_window = nullptr;
+        return;
+    }
+
+    printf("[initialize_screen] vm_screen_buffer.lpBmp=%p\n", vm_screen_buffer.lpBmp);
+}
+
+// SDL2Áî® ÁîªÈù¢„Éê„ÉÉ„Éï„Ç°ÂàùÊúüÂåñ
+void OSD::initialize_screen_buffer(bitmap_t* buffer, int width, int height, int mode)
+{
+    release_screen_buffer(buffer);
+    buffer->width = width;
+    buffer->height = height;
+    // scrntype_t = uint32_tÂâçÊèê
+    buffer->lpBmp = (scrntype_t*)malloc(width * height * sizeof(uint32_t));
+}
+
+// SDL2Áî® ÁîªÈù¢„Éê„ÉÉ„Éï„Ç°Ëß£Êîæ
+void OSD::release_screen_buffer(bitmap_t* buffer)
+{
+    if (buffer->lpBmp) {
+        free(buffer->lpBmp);
+        buffer->lpBmp = nullptr;
+    }
+    buffer->width = 0;
+    buffer->height = 0;
+}
+
+// „É™„ÇΩ„Éº„ÇπËß£Êîæ
+void OSD::release_screen()
+{
+    if (this->sdl_texture) {
+        SDL_DestroyTexture(this->sdl_texture);
+        this->sdl_texture = nullptr;
+    }
+    if (this->sdl_renderer) {
+        SDL_DestroyRenderer(this->sdl_renderer);
+        this->sdl_renderer = nullptr;
+    }
+    if (this->sdl_window) {
+        SDL_DestroyWindow(this->sdl_window);
+        this->sdl_window = nullptr;
+        this->sdl_texture = nullptr;
+    }
+    if (this->sdl_renderer) {
+        SDL_DestroyRenderer(this->sdl_renderer);
+        this->sdl_renderer = nullptr;
+    }
+    if (this->sdl_window) {
+        SDL_DestroyWindow(this->sdl_window);
+        this->sdl_window = nullptr;
+    }
+}
+
+// „Ç¶„Ç£„É≥„Éâ„Ç¶„É¢„Éº„ÉâÂÄçÁéá
+double OSD::get_window_mode_power(int mode) { return 1.0; }
+int OSD::get_window_mode_width(int mode) { return vm_window_width; }
+int OSD::get_window_mode_height(int mode) { return vm_window_height; }
+
+// „Ç¶„Ç£„É≥„Éâ„Ç¶„Çµ„Ç§„Ç∫Ë®≠ÂÆö
+void OSD::set_host_window_size(int window_width, int window_height, BOOL window_mode)
+{
+    host_window_width = window_width;
+    host_window_height = window_height;
+    host_window_mode = window_mode;
+}
+
+// VMÁîªÈù¢„Çµ„Ç§„Ç∫Ë®≠ÂÆö
+void OSD::set_vm_screen_size(int screen_width, int screen_height, int window_width, int window_height, int window_width_aspect, int window_height_aspect)
+{
+    if (vm_screen_width != screen_width || vm_screen_height != screen_height) {
+        vm_screen_width = screen_width;
+        vm_screen_height = screen_height;
+        vm_window_width = window_width;
+        vm_window_height = window_height;
+        vm_window_width_aspect = window_width_aspect;
+        vm_window_height_aspect = window_height_aspect;
+
+        // ÁîªÈù¢„Éê„ÉÉ„Éï„Ç°„ÇíÂÜçÂàùÊúüÂåñ
+        initialize_screen_buffer(&vm_screen_buffer, vm_screen_width, vm_screen_height, 0);
+
+        // SDL_TextureÂÜçÁîüÊàê
+        if (this->sdl_renderer) {
+            if (this->sdl_texture) {
+                SDL_DestroyTexture(sdl_texture);
+            }
+            sdl_texture = SDL_CreateTexture(
+                sdl_renderer,
+                SDL_PIXELFORMAT_RGB888,
+                SDL_TEXTUREACCESS_STREAMING,
+                vm_screen_width,
+                vm_screen_height
+            );
+            sdl_tex_width = vm_screen_width;
+            sdl_tex_height = vm_screen_height;
+        }
+    }
+}
+
+// VMÁîªÈù¢„Éê„ÉÉ„Éï„Ç°„ÅÆyË°åÁõÆÂÖàÈ†≠„Ç¢„Éâ„É¨„Çπ
+scrntype_t* OSD::get_vm_screen_buffer(int y)
+{
+    static int print_count = 0;
+    if (y < 0 || y >= vm_screen_height) return nullptr;
+    if (!vm_screen_buffer.lpBmp) return nullptr;
+    scrntype_t* addr = vm_screen_buffer.lpBmp + y * vm_screen_buffer.width;
+    if (print_count < 3) {
+        printf("[get_vm_screen_buffer] y=%d, width=%d, addr=%p\n", y, vm_screen_buffer.width, addr);
+        print_count++;
+    }
+    return addr;
+}
+
+// ÁîªÈù¢ÊèèÁîª
+int OSD::draw_screen()
+{
+    // „Éá„Éê„ÉÉ„Ç∞„É≠„Ç∞: Èñ¢Êï∞Âëº„Å≥Âá∫„Åó„Å®„Éù„Ç§„É≥„ÇøÂÄ§
+    // printf("[draw_screen] called: sdl_renderer=%p, sdl_texture=%p, vm_screen_buffer.lpBmp=%p\n",
+    //     sdl_renderer, sdl_texture, vm_screen_buffer.lpBmp);
+
+    if (!this->sdl_renderer || !this->sdl_texture || !vm_screen_buffer.lpBmp) {
+        printf("[draw_screen] pointer null: sdl_renderer=%p, sdl_texture=%p, vm_screen_buffer.lpBmp=%p\n",
+            this->sdl_renderer, this->sdl_texture, vm_screen_buffer.lpBmp);
+        return 0;
+    }
+
+    // VM„Éê„ÉÉ„Éï„Ç°„ÇíSDL_Texture„Å∏Ëª¢ÈÄÅ
+    void* pixels;
+    int pitch;
+    if (SDL_LockTexture(this->sdl_texture, nullptr, &pixels, &pitch) == 0) {
+        // scrntype_t = uint32_t (RGB888)ÂâçÊèê
+        static int print_count = 0;
+        if (print_count < 1) {
+            printf("[draw_screen] vm_screen_buffer.lpBmp=%p, first4=[%08x %08x %08x %08x]\n",
+                vm_screen_buffer.lpBmp,
+                ((uint32_t*)vm_screen_buffer.lpBmp)[0],
+                ((uint32_t*)vm_screen_buffer.lpBmp)[1],
+                ((uint32_t*)vm_screen_buffer.lpBmp)[2],
+                ((uint32_t*)vm_screen_buffer.lpBmp)[3]);
+            print_count++;
+        }
+#if false
+        for (int y = 0; y < vm_screen_height; ++y) {
+            std::memcpy(
+                (uint8_t*)pixels + y * pitch,
+                vm_screen_buffer.lpBmp + y * vm_screen_buffer.width,
+                vm_screen_buffer.width * sizeof(scrntype_t)
+            );
+        }
+#else
+        // RGB565„Åã„ÇâRGB888„Å∏„ÅÆÂ§âÊèõ
+        for (int y = 0; y < vm_screen_height; ++y) {
+            uint16_t* src = (uint16_t*)(vm_screen_buffer.lpBmp + y * vm_screen_buffer.width);
+            uint32_t* dst = (uint32_t*)((uint8_t*)pixels + y * pitch);
+            
+            for (int x = 0; x < vm_screen_buffer.width; ++x) {
+                uint16_t rgb565 = src[x];
+                
+                // RGB565„Åã„ÇâRGB888„Å´Â±ïÈñã
+                uint8_t r = (rgb565 >> 11) & 0x1F;
+                uint8_t g = (rgb565 >> 5) & 0x3F; 
+                uint8_t b = rgb565 & 0x1F;
+                
+                // 5/6„Éì„ÉÉ„Éà„Åã„Çâ8„Éì„ÉÉ„Éà„Å´Êã°Âºµ
+                r = (r << 3) | (r >> 2);
+                g = (g << 2) | (g >> 4);
+                b = (b << 3) | (b >> 2);
+                
+                dst[x] = (r << 16) | (g << 8) | b;
+            }
+        }
+#endif
+        SDL_UnlockTexture(this->sdl_texture);
+    } else {
+        printf("[draw_screen] SDL_LockTexture failed\n");
+    }
+	vm->draw_screen();
+
+    SDL_RenderClear(this->sdl_renderer);
+    SDL_RenderCopy(this->sdl_renderer, this->sdl_texture, nullptr, nullptr);
+
+    // // „Éá„Éê„ÉÉ„Ç∞Áî®ÔºöËµ§„ÅÑÂõõËßí„ÇíÊèèÁîª
+    // SDL_SetRenderDrawColor(sdl_renderer, 255, 0, 0, 255);
+    // SDL_Rect rect = {10, 10, 100, 100};
+    // SDL_RenderFillRect(sdl_renderer, &rect);
+
+    SDL_RenderPresent(sdl_renderer);
+
+    // printf("[draw_screen] finished\n");
+
+    return 1;
+}
+
+// --- set_vm_screen_lines: Á©∫ÂÆüË£ÖÔºàwin32Ê∫ñÊã†Ôºâ ---
+void OSD::set_vm_screen_lines(int lines)
+{
+}
+
+// ÁÑ°ÂäπÂåñÔºàÂÜçÊèèÁîªË¶ÅÊ±ÇÔºâ
+void OSD::invalidate_screen()
+{
+    // SDL2„Åß„ÅØÁâπ„Å´‰Ωï„ÇÇ„Åó„Å™„Åè„Å¶„ÇÇËâØ„ÅÑ
+}
+
+// HDC„Çí‰Ωø„Å£„ÅüÁîªÈù¢Êõ¥Êñ∞ÔºàSDL2„Åß„ÅØÊú™‰ΩøÁî®Ôºâ
+void OSD::update_screen(HDC)
+{
+    // SDL2„Åß„ÅØÊú™‰ΩøÁî®
+}
+
+// „Çπ„ÇØ„É™„Éº„É≥„Ç≠„É£„Éó„ÉÅ„É£ÔºàÊú™ÂÆüË£ÖÔºâ
+void capture_screen() {}
+
+// „Éï„É¨„Éº„É†ËøΩÂä†ÔºàÊú™ÂÆüË£ÖÔºâ
+void OSD::add_extra_frames(int) {}
+int OSD::add_video_frames() { return 0; }
+
+void OSD::create_pen(pen_t *pen, int width, uint8_t r, uint8_t g, uint8_t b)
+{
+}
+
+void OSD::release_pen(pen_t* pen) {}
+
+void OSD::create_font(font_t* font, const char* family, int width, int height, int rotate, int bold, int italic) {}
+void OSD::release_font(font_t* font) {}
+void OSD::create_bitmap(bitmap_t* bitmap, int width, int height) {}
+void OSD::release_bitmap(bitmap_t* bitmap) {}
+void OSD::clear_bitmap(bitmap_t* bitmap, BYTE r, BYTE g, BYTE b) {}
+int OSD::get_text_width(bitmap_t* bitmap, font_t* font, const char* text) { return 0; }
+void OSD::draw_text_to_bitmap(bitmap_t* bitmap, font_t* font, int x, int y, const char* text, BYTE r, BYTE g, BYTE b) {}
+void OSD::draw_line_to_bitmap(bitmap_t* bitmap, pen_t* pen, int sx, int sy, int ex, int ey) {}
+void OSD::draw_rectangle_to_bitmap(bitmap_t* bitmap, int x, int y, int width, int height, BYTE r, BYTE g, BYTE b) {}
+void OSD::draw_point_to_bitmap(bitmap_t* bitmap, int x, int y, BYTE r, BYTE g, BYTE b) {}
+void OSD::stretch_bitmap(bitmap_t* dest, int dest_x, int dest_y, int dest_width, int dest_height, bitmap_t* source, int source_x, int source_y, int source_width, int source_height) {}
+void OSD::write_bitmap_to_file(bitmap_t* bitmap, const char* file_path) {}
+void OSD::capture_screen() {}
+
+int OSD::start_record_video(int) { return 0; }
+void OSD::stop_record_video() {}
+void OSD::restart_record_video() {}
diff -ruN source/src/sdl2/osd_socket.cpp src/sdl2/osd_socket.cpp
--- source/src/sdl2/osd_socket.cpp	1970-01-01 09:00:00
+++ src/sdl2/osd_socket.cpp	2025-04-28 22:36:36
@@ -0,0 +1,22 @@
+/*
+    Stub implementation for osd_socket.cpp
+    This file is auto-generated to avoid Windows dependency.
+*/
+
+#include "osd.h"
+
+// OSD class member functions (empty implementation)
+void OSD::initialize_socket() {}
+void OSD::release_socket() {}
+void OSD::notify_socket_connected(int ch) {}
+void OSD::notify_socket_disconnected(int ch) {}
+void OSD::update_socket() {}
+bool OSD::initialize_socket_tcp(int ch) { return false; }
+bool OSD::initialize_socket_udp(int ch) { return false; }
+bool OSD::connect_socket(int ch, uint32_t ipaddr, int port) { return false; }
+void OSD::disconnect_socket(int ch) {}
+bool OSD::listen_socket(int ch) { return false; }
+void OSD::send_socket_data_tcp(int ch) {}
+void OSD::send_socket_data_udp(int ch, uint32_t ipaddr, int port) {}
+void OSD::send_socket_data(int ch) {}
+void OSD::recv_socket_data(int ch) {}
\ No newline at end of file
diff -ruN source/src/sdl2/osd_sound.cpp src/sdl2/osd_sound.cpp
--- source/src/sdl2/osd_sound.cpp	1970-01-01 09:00:00
+++ src/sdl2/osd_sound.cpp	2025-04-28 22:36:36
@@ -0,0 +1,196 @@
+#include "osd.h"
+#include <SDL.h>
+#include <cstring>
+
+// „Éê„ÉÉ„Éï„Ç°„Çµ„Ç§„Ç∫„ÅÆÂÆöÁæ©
+#define SOUND_BUFFER_SIZE (sound_samples * 8)
+#define SOUND_BUFFER_HALF (sound_samples * 4)
+
+static SDL_AudioDeviceID audio_device = 0;
+static SDL_AudioSpec want, have;
+static int sound_rate = 44100;
+static int sound_samples = 1024;
+static bool sound_available = false;
+static bool sound_started = false;
+static bool sound_muted = false;
+static uint16_t* mix_buffer = nullptr;
+static int buffer_position = 0;
+static int buffer_length = 0;
+
+// update_sound„ÅÆÂëº„Å≥Âá∫„ÅóÂõûÊï∞„Çí„Ç´„Ç¶„É≥„Éà„Åô„Çã„Ç∞„É≠„Éº„Éê„É´Â§âÊï∞
+int g_update_sound_count = 0;
+
+// OSD„Ç§„É≥„Çπ„Çø„É≥„Çπ„Å∏„ÅÆ„Éù„Ç§„É≥„Çø
+static OSD* g_osd = nullptr;
+
+// SDL2„Ç™„Éº„Éá„Ç£„Ç™„Ç≥„Éº„É´„Éê„ÉÉ„ÇØ
+static void sdl_audio_callback(void* userdata, Uint8* stream, int len)
+{
+    if (!mix_buffer || sound_muted) {
+        memset(stream, 0, len);
+        return;
+    }
+    
+    // „Çπ„Éà„É™„Éº„É†„Éê„ÉÉ„Éï„Ç°„Çí„ÇØ„É™„Ç¢ÔºàÂøÖË¶Å„Å´Âøú„Åò„Å¶Ôºâ
+    memset(stream, 0, len);
+    
+    // „Éê„ÉÉ„Éï„Ç°„Åã„Çâ„Éá„Éº„Çø„Çí„Ç≥„Éî„Éº
+    if (buffer_length > 0) {
+        int copy_len = (buffer_length > len) ? len : buffer_length;
+        memcpy(stream, (uint8_t*)mix_buffer, copy_len);
+        
+        // ÊÆã„Çä„ÅÆ„Éê„ÉÉ„Éï„Ç°„Åå„ÅÇ„ÇãÂ†¥Âêà„ÅØÁßªÂãï
+        if (copy_len < buffer_length) {
+            memmove(mix_buffer, (uint8_t*)mix_buffer + copy_len, buffer_length - copy_len);
+        }
+        
+        buffer_length -= copy_len;
+    }
+}
+
+void OSD::initialize_sound(int rate, int samples)
+{
+    fprintf(stderr, "OSD::initialize_sound: rate=%d, samples=%d\n", rate, samples);
+    
+    sound_rate = rate;
+    sound_samples = samples;
+    sound_available = false;
+    sound_started = false;
+    sound_muted = false;
+    buffer_position = 0;
+    buffer_length = 0;
+    
+    if (mix_buffer) {
+        delete[] mix_buffer;
+        mix_buffer = nullptr;
+    }
+    
+    // „Éê„ÉÉ„Éï„Ç°„ÇíÁ¢∫‰øù
+    mix_buffer = new uint16_t[SOUND_BUFFER_SIZE / sizeof(uint16_t)];
+    memset(mix_buffer, 0, SOUND_BUFFER_SIZE);
+    g_osd = this;
+
+    if (SDL_InitSubSystem(SDL_INIT_AUDIO) < 0) {
+        fprintf(stderr, "SDL audio initialization failed: %s\n", SDL_GetError());
+        return;
+    }
+    
+    SDL_zero(want);
+    want.freq = sound_rate;
+    want.format = AUDIO_S16SYS;
+    want.channels = 2;  // „Çπ„ÉÜ„É¨„Ç™
+    want.samples = sound_samples;
+    want.callback = sdl_audio_callback;
+    want.userdata = nullptr;
+
+    // „Ç™„Éº„Éá„Ç£„Ç™„Éá„Éê„Ç§„Çπ„Çí„Ç™„Éº„Éó„É≥
+    audio_device = SDL_OpenAudioDevice(nullptr, 0, &want, &have, 
+                                    SDL_AUDIO_ALLOW_FREQUENCY_CHANGE);
+    if (audio_device == 0) {
+        fprintf(stderr, "Failed to open audio device: %s\n", SDL_GetError());
+        return;
+    }
+    
+    // ÂÆüÈöõ„Å´ÂèñÂæó„Åß„Åç„Åü„Ç™„Éº„Éá„Ç£„Ç™‰ªïÊßò„ÇíÁ¢∫Ë™ç
+    fprintf(stderr, "Audio: requested rate=%d, received rate=%d\n", sound_rate, have.freq);
+    fprintf(stderr, "Audio: requested channels=%d, received channels=%d\n", want.channels, have.channels);
+    fprintf(stderr, "Audio: requested samples=%d, received samples=%d\n", sound_samples, have.samples);
+    fprintf(stderr, "Audio: requested format=%d, received format=%d\n", want.format, have.format);
+    
+    // VM„Å´Ê≠£Á¢∫„Å™„Çµ„É≥„Éó„É´„É¨„Éº„Éà„Çí‰ºù„Åà„Çã
+    if (have.freq != sound_rate) {
+        fprintf(stderr, "Warning: Using different sample rate than requested (%d vs %d)\n", 
+                have.freq, sound_rate);
+        sound_rate = have.freq;
+    }
+    
+    // „Çµ„É≥„Éó„É´Êï∞„ÇíSDL„Éá„Éê„Ç§„Çπ„ÅÆË¶ÅÊ±Ç„Å´Âêà„Çè„Åõ„Çã
+    sound_samples = have.samples;
+    
+    // ÂÜçÁîüÈñãÂßã
+    SDL_PauseAudioDevice(audio_device, 0);
+    sound_available = true;
+    sound_started = true;
+}
+
+void OSD::release_sound()
+{
+    if (audio_device) {
+        SDL_CloseAudioDevice(audio_device);
+        audio_device = 0;
+    }
+    if (mix_buffer) {
+        delete[] mix_buffer;
+        mix_buffer = nullptr;
+    }
+    sound_available = false;
+    sound_started = false;
+    sound_muted = false;
+}
+
+void OSD::update_sound(int* extra_frames)
+{
+    if (!vm || !sound_available) return;
+    
+    int dummy = 0;
+    if (!extra_frames) extra_frames = &dummy;
+    
+    *extra_frames = 0;
+    sound_muted = false;
+
+    if (sound_available) {
+        // „Éê„ÉÉ„Éï„Ç°„Åå„ÅÑ„Å£„Å±„ÅÑ„ÅÆÂ†¥Âêà„ÅØ‰Ωï„ÇÇ„Åó„Å™„ÅÑ
+        if (buffer_length >= SOUND_BUFFER_SIZE) {
+            // printf("OSD::update_sound: buffer_length >= SOUND_BUFFER_SIZE\n");
+            return;
+        }
+        
+        // „Çµ„Ç¶„É≥„Éâ„Éê„ÉÉ„Éï„Ç°„ÇíÂèñÂæó„ÅóÊõ¥Êñ∞
+        SDL_LockAudioDevice(audio_device);
+        
+        // Âëº„Å≥Âá∫„ÅóÂõûÊï∞„Çí„Ç§„É≥„ÇØ„É™„É°„É≥„Éà
+        g_update_sound_count++;
+
+        uint16_t* sound_buffer = vm->create_sound(extra_frames);
+        // printf("OSD::update_sound: sound_buffer=%p extra_frames=%d\n", sound_buffer, *extra_frames);
+        if (sound_buffer) {
+            // „Åæ„Å†„Éê„ÉÉ„Éï„Ç°„Å´‰ΩôË£ï„Åå„ÅÇ„ÇãÂ†¥Âêà„ÅÆ„Åø„Ç≥„Éî„Éº
+            int copy_len = sound_samples * 4; // „Çπ„ÉÜ„É¨„Ç™16bit = 4„Éê„Ç§„Éà/„Çµ„É≥„Éó„É´
+
+            // ÂÆüÈ®ì
+            // buffer_length = 0;
+
+            if (buffer_length + copy_len <= SOUND_BUFFER_SIZE) {
+                uint8_t* dst = (uint8_t*)mix_buffer + buffer_length;
+                memcpy(dst, sound_buffer, copy_len);
+                buffer_length += copy_len;
+            }
+        }
+        
+        SDL_UnlockAudioDevice(audio_device);
+    }
+}
+
+void OSD::mute_sound()
+{
+    if (sound_available && !sound_muted) {
+        SDL_LockAudioDevice(audio_device);
+        memset(mix_buffer, 0, SOUND_BUFFER_SIZE);
+        buffer_length = 0;
+        SDL_UnlockAudioDevice(audio_device);
+    }
+    sound_muted = true;
+}
+
+void OSD::stop_sound()
+{
+    if (audio_device && sound_started) {
+        SDL_PauseAudioDevice(audio_device, 1);
+        sound_started = false;
+    }
+}
+
+// Èå≤Èü≥Ê©üËÉΩ„ÅØ‰ªä„ÅÆ„Å®„Åì„ÇçÂÆüË£Ö„Åó„Å™„ÅÑ
+void OSD::start_record_sound() {}
+void OSD::stop_record_sound() {}
+void OSD::restart_record_sound() {}
\ No newline at end of file
diff -ruN source/src/sdl2/osd_timer.cpp src/sdl2/osd_timer.cpp
--- source/src/sdl2/osd_timer.cpp	1970-01-01 09:00:00
+++ src/sdl2/osd_timer.cpp	2025-04-28 22:36:36
@@ -0,0 +1,7 @@
+// SDL2Áî®ÈõõÂΩ¢
+/*
+    Stub implementation for osd_timer.cpp
+    This file is auto-generated to avoid Windows dependency.
+*/
+
+// ÂøÖË¶Å„Å´Âøú„Åò„Å¶Èñ¢Êï∞„ÇíËøΩÂä†„Åó„Å¶„Åè„Å†„Åï„ÅÑ
\ No newline at end of file
diff -ruN source/src/sdl2/sdl2main.cpp src/sdl2/sdl2main.cpp
--- source/src/sdl2/sdl2main.cpp	1970-01-01 09:00:00
+++ src/sdl2/sdl2main.cpp	2025-05-01 10:06:08
@@ -0,0 +1,182 @@
+/*
+    SDL2Áî®„É°„Ç§„É≥
+    This file is a stub for SDL2 main loop.
+*/
+
+#include "osd.h"
+#include <SDL.h>
+#include "../platform_types.h"
+#include "../emu.h"
+
+extern "C" int sdl_scancode_to_vkcode(int scancode);
+
+// „Ç®„É≥„Éà„É™„Éù„Ç§„É≥„ÉàÔºàSDL2Áî®ÈõõÂΩ¢Ôºâ
+int main(int argc, char* argv[])
+{
+    // SDL2ÂàùÊúüÂåñ
+    if (SDL_Init(SDL_INIT_VIDEO | SDL_INIT_AUDIO) != 0) {
+        printf("SDL_Init failed: %s\n", SDL_GetError());
+        return 1;
+    }
+
+	// load config
+	load_config(create_local_path(_T("%s.ini"), _T(CONFIG_NAME)));
+
+    // OSD/EMU„Ç§„É≥„Çπ„Çø„É≥„ÇπÁîüÊàê
+    // ‰ΩéËß£ÂÉèÂ∫¶„Å´„Åó„Å¶„Åä„Åè(„Åì„ÅÆ„ÅÇ„Åü„Çä„ÅØ‰ªÆ„ÅÆÊ±∫„ÇÅÊâì„Å°Á≥ª„ÄÇÂâäÈô§„Åó„Å¶„ÇÇËâØ„ÅÑ)
+    config.full_speed = 0;
+    config.monitor_type = 1;
+    config.sound_frequency = 5; // 44.1kHz
+    config.sound_latency = 0;
+    // config.keyboard_type = 0;
+    config.sound_noise_fdd = true;
+    config.sound_noise_cmt = true;
+
+    EMU* emu = new EMU();
+    emu->update_config();
+
+    // ‰ªÆ„Åß„Éá„Ç£„Çπ„ÇØ„Ç§„É°„Éº„Ç∏„ÇíÂÖ•„Çå„Å¶„ÇÑ„ÇãÂ†¥Âêà„ÅØ„Åì„Åì„ÅßÂÖ•„Çå„Å¶„Åè„Å†„Åï„ÅÑ(„Ç™„Éó„Ç∑„Éß„É≥ÊåáÂÆö„Å®„Åã„Å´„Åó„ÅüÊñπ„ÅåËâØ„ÅÑ„Åß„Åô„Å≠‚Ä¶‚Ä¶)
+    // emu->open_floppy_disk(0, "BASIC.D88", 0);
+
+    bool running = true;
+    SDL_Event event;
+    int total_frames = 0, skip_frames = 0;
+    Uint32 next_time = 0;
+    bool prev_skip = false;
+
+    while (running) {
+        Uint32 start_time = SDL_GetTicks();
+        Uint32 end_time = start_time;
+
+        // „É°„ÉÉ„Çª„Éº„Ç∏Âá¶ÁêÜ
+        while (1) {
+            if (SDL_PollEvent(&event)) {
+                if (event.type == SDL_QUIT) {
+                    running = false;
+                }
+                // --- Win32Áâà„É≠„Ç∏„ÉÉ„ÇØÂø†ÂÆüÁßªÊ§ç: „Ç≠„Éº„Éú„Éº„ÉâÂÖ•ÂäõÂá¶ÁêÜ ---
+                else if (event.type == SDL_KEYDOWN || event.type == SDL_KEYUP) {
+                    int vkcode = sdl_scancode_to_vkcode(event.key.keysym.scancode);
+                    bool repeat = (event.key.repeat != 0);
+                    
+                    // Êã°Âºµ„Ç≠„ÉºÂà§ÂÆö - NumPad„Ç≠„Éº„ÇÑÁâπÊÆä„Ç≠„Éº„ÅÆÂà§Âà•„Å´ÂøÖË¶Å
+                    bool extended = false;
+                    // Insert, Delete, Home, End, PageUp, PageDown, ÊñπÂêë„Ç≠„Éº„ÄÅÂè≥Ctrl„Å™„Å©„ÅØÊã°Âºµ„Ç≠„Éº
+                    switch(event.key.keysym.scancode) {
+                        case SDL_SCANCODE_INSERT:
+                        case SDL_SCANCODE_DELETE:
+                        case SDL_SCANCODE_HOME:
+                        case SDL_SCANCODE_END:
+                        case SDL_SCANCODE_PAGEUP:
+                        case SDL_SCANCODE_PAGEDOWN:
+                        case SDL_SCANCODE_UP:
+                        case SDL_SCANCODE_DOWN:
+                        case SDL_SCANCODE_LEFT:
+                        case SDL_SCANCODE_RIGHT:
+                        case SDL_SCANCODE_RCTRL:
+                        case SDL_SCANCODE_RALT:
+                        case SDL_SCANCODE_APPLICATION: // Menu key
+                        case SDL_SCANCODE_PRINTSCREEN:
+                            extended = true;
+                            break;
+                        // NumPad„Ç≠„Éº„ÅØÊã°Âºµ„Ç≠„Éº„Åß„ÅØ„Å™„ÅÑ
+                        case SDL_SCANCODE_KP_0:
+                        case SDL_SCANCODE_KP_1:
+                        case SDL_SCANCODE_KP_2:
+                        case SDL_SCANCODE_KP_3:
+                        case SDL_SCANCODE_KP_4:
+                        case SDL_SCANCODE_KP_5:
+                        case SDL_SCANCODE_KP_6:
+                        case SDL_SCANCODE_KP_7:
+                        case SDL_SCANCODE_KP_8:
+                        case SDL_SCANCODE_KP_9:
+                        case SDL_SCANCODE_KP_PERIOD:
+                        case SDL_SCANCODE_KP_DIVIDE:
+                        case SDL_SCANCODE_KP_MULTIPLY:
+                        case SDL_SCANCODE_KP_MINUS:
+                        case SDL_SCANCODE_KP_PLUS:
+                        case SDL_SCANCODE_KP_ENTER:
+                        case SDL_SCANCODE_KP_EQUALS:
+                        case SDL_SCANCODE_NUMLOCKCLEAR:
+                            extended = false;
+                            break;
+                    }
+
+                    if (vkcode != 0) {
+                        if (event.type == SDL_KEYDOWN) {
+                            emu->key_down(vkcode, extended, repeat);
+                        } else {
+                            emu->key_up(vkcode, extended);
+                        }
+                    }
+                }
+                // --- Win32ÁâàWM_CHARÁõ∏ÂΩì: ÊñáÂ≠óÂÖ•ÂäõÂá¶ÁêÜ ---
+                else if (event.type == SDL_TEXTINPUT) {
+                    // UTF-8‚ÜíUnicode32Â§âÊèõ
+                    const char* text = event.text.text;
+                    uint32_t unicode = 0;
+                    if ((unsigned char)text[0] < 0x80) {
+                        unicode = (unsigned char)text[0];
+                    } else if ((unsigned char)text[0] < 0xE0) {
+                        unicode = ((text[0] & 0x1F) << 6) | (text[1] & 0x3F);
+                    } else if ((unsigned char)text[0] < 0xF0) {
+                        unicode = ((text[0] & 0x0F) << 12) | ((text[1] & 0x3F) << 6) | (text[2] & 0x3F);
+                    }
+                    emu->key_char(unicode);
+                }
+            } else if (end_time == start_time || end_time <= SDL_GetTicks()) {
+                break;
+            }
+        }
+
+        if (emu && running) {
+            // drive machine
+            int run_frames = emu->run();
+            total_frames += run_frames;
+
+            // timing controls
+            int sleep_period = 0;
+            bool now_skip = (config.full_speed || emu->is_frame_skippable()) && !emu->is_video_recording() && !emu->is_sound_recording();
+
+            if ((prev_skip && !now_skip) || next_time == 0) {
+                next_time = SDL_GetTicks();
+            }
+            if (!now_skip) {
+                static int accum = 0;
+                accum += emu->get_frame_interval();
+                int interval = accum >> 10;
+                accum -= interval << 10;
+                next_time += interval;
+            }
+            prev_skip = now_skip;
+
+            if (next_time > SDL_GetTicks()) {
+                // update window if enough time
+                emu->draw_screen();
+                skip_frames = 0;
+
+                // sleep 1 frame period if need
+                Uint32 current_time = SDL_GetTicks();
+                if ((int)(next_time - current_time) >= 10) {
+                    sleep_period = next_time - current_time;
+                }
+            } else if (++skip_frames > (int)emu->get_frame_rate()) {
+                // update window at least once per 1 sec in virtual machine time
+                emu->draw_screen();
+                next_time = SDL_GetTicks();
+            } else {
+                // „Éï„É¨„Éº„É†„Çπ„Ç≠„ÉÉ„Éó‰∏≠
+            }
+
+            if (sleep_period > 0) {
+                SDL_Delay(sleep_period);
+            }
+        }
+    }
+
+    // ÁµÇ‰∫ÜÂá¶ÁêÜ
+    delete emu;
+    SDL_Quit();
+
+    return 0;
+}
diff -ruN source/src/stub/osd.cpp src/stub/osd.cpp
--- source/src/stub/osd.cpp	1970-01-01 09:00:00
+++ src/stub/osd.cpp	2025-04-28 22:36:36
@@ -0,0 +1,66 @@
+/*
+    Stub source for osd.cpp
+    This file is auto-generated to avoid Windows dependency.
+*/
+
+#include "osd.h"
+
+void OSD::initialize(int rate, int samples) {}
+void OSD::release() {}
+void OSD::power_off() {}
+void OSD::suspend() {}
+void OSD::restore() {}
+void OSD::lock_vm() {}
+void OSD::unlock_vm() {}
+void OSD::force_unlock_vm() {}
+void OSD::sleep(uint32_t ms) {}
+void OSD::start_waiting_in_debugger() {}
+void OSD::finish_waiting_in_debugger() {}
+void OSD::process_waiting_in_debugger() {}
+// --- ËøΩÂä†„Ç∞„É≠„Éº„Éê„É´Èñ¢Êï∞„ÅÆÁ©∫ÂÆüË£Ö ---
+
+// --- OSD„ÇØ„É©„ÇπËøΩÂä†„É°„É≥„ÉêÈñ¢Êï∞„ÅÆÁ©∫ÂÆüË£Ö ---
+void OSD::restart_record_video() {}
+BOOL OSD::is_vm_locked() { return FALSE; }
+void OSD::key_lost_focus() {}
+#ifdef USE_MOUSE
+BOOL OSD::is_mouse_enabled() { return FALSE; }
+#endif
+
+
+LRESULT CALLBACK MyWndProc(HWND hWnd, UINT iMsg, WPARAM wParam, LPARAM lParam)
+{
+    return 0;
+}
+
+BOOL WINAPI ctrl_c_handler(DWORD type) { return 0; }
+const _TCHAR *get_ttermpro_path() { return nullptr; }
+const _TCHAR *get_ttermpro_x86_path() { return nullptr; }
+const _TCHAR *get_putty_path() { return nullptr; }
+const _TCHAR *get_putty_x86_path() { return nullptr; }
+const _TCHAR *get_telnet_path() { return nullptr; }
+/* --- „ÉÄ„Éü„ÉºÂÆüË£Ö: OSDÊèèÁîª„Éª„É™„ÇΩ„Éº„ÇπÈñ¢ÈÄ£ --- */
+void OSD::create_pen(pen_t*, int, BYTE, BYTE, BYTE) {}
+void OSD::release_pen(pen_t*) {}
+void OSD::create_font(font_t*, const _TCHAR*, int, int, int, BOOL, BOOL) {}
+void OSD::release_font(font_t*) {}
+void OSD::create_bitmap(bitmap_t*, int, int) {}
+void OSD::release_bitmap(bitmap_t*) {}
+void OSD::clear_bitmap(bitmap_t*, BYTE, BYTE, BYTE) {}
+int OSD::get_text_width(bitmap_t*, font_t*, const char*) { return 0; }
+void OSD::draw_text_to_bitmap(bitmap_t*, font_t*, int, int, const char*, BYTE, BYTE, BYTE) {}
+void OSD::draw_line_to_bitmap(bitmap_t*, pen_t*, int, int, int, int) {}
+void OSD::draw_rectangle_to_bitmap(bitmap_t*, int, int, int, int, BYTE, BYTE, BYTE) {}
+void OSD::draw_point_to_bitmap(bitmap_t*, int, int, BYTE, BYTE, BYTE) {}
+void OSD::stretch_bitmap(bitmap_t*, int, int, int, int, bitmap_t*, int, int, int, int) {}
+void OSD::write_bitmap_to_file(bitmap_t*, const _TCHAR*) {}
+void OSD::capture_screen() {}
+BOOL OSD::start_record_video(int) { return FALSE; }
+/* --- „ÉÄ„Éü„Éº: get_key_buffer --- */
+BYTE dummy_key_status[256];
+BYTE* OSD::get_key_buffer() { return dummy_key_status; }
+
+/* --- „ÉÄ„Éü„Éº: mainÈñ¢Êï∞ --- */
+int main(int argc, char** argv) { return 0; }
+void OSD::stop_record_video() {}
+const _TCHAR *get_telnet_x86_path() { return nullptr; }
\ No newline at end of file
diff -ruN source/src/stub/osd.h src/stub/osd.h
--- source/src/stub/osd.h	1970-01-01 09:00:00
+++ src/stub/osd.h	2025-04-28 22:36:36
@@ -0,0 +1,505 @@
+/*
+    Stub header for osd.h
+    This file is auto-generated to avoid Windows dependency.
+    DO NOT EDIT MANUALLY.
+    Based on src/win32/osd.h
+*/
+
+#ifndef _WIN32_OSD_H_
+#define _WIN32_OSD_H_
+
+
+#include "../platform_types.h"
+#include "../common.h"
+
+
+/* --- „Éó„É≠„Ç∏„Çß„ÇØ„Éà‰æùÂ≠òÂûã --- */
+
+/* --- „Éû„ÇØ„É≠„ÉªÂÆöÊï∞ --- */
+#define _WIN32_WINNT        0x500
+#define DIRECTSOUND_VERSION 0x900
+#define DIRECT3D_VERSION    0x900
+#define DIRECTINPUT_VERSION 0x800
+
+#define WM_RESIZE  (0x0400 + 1)
+#define WM_SOCKET0 (0x0400 + 2)
+#define WM_SOCKET1 (0x0400 + 3)
+#define WM_SOCKET2 (0x0400 + 4)
+#define WM_SOCKET3 (0x0400 + 5)
+
+#ifdef USE_SOCKET
+#define SOCKET_MAX 4
+#define SOCKET_BUFFER_MAX 0x100000
+#endif
+
+#ifdef USE_VIDEO_CAPTURE
+#define MAX_CAPTURE_DEVS 8
+#endif
+
+#if defined(_WIN32) && !defined(_M_AMD64)
+#define SUPPORT_WIN32_DLL
+#endif
+
+#define SCREEN_FILTER_NONE 0
+#define SCREEN_FILTER_RGB  1
+#define SCREEN_FILTER_RF   2
+
+#define OSD_CONSOLE_BLUE      1
+#define OSD_CONSOLE_GREEN     2
+#define OSD_CONSOLE_RED       4
+#define OSD_CONSOLE_INTENSITY 8
+
+/* --- bitmap_tÊßãÈÄ†‰Ωì --- */
+typedef struct bitmap_s {
+    int width, height;
+    HDC hdcDib;
+    HBITMAP hBmp, hOldBmp;
+    LPBYTE lpBuf;
+    scrntype_t* lpBmp;
+    LPBITMAPINFO lpDib;
+#ifdef __cplusplus
+    inline bool initialized() const { return false; }
+    inline scrntype_t* get_buffer(int) { return nullptr; }
+#endif
+} bitmap_t;
+
+/* --- font_tÊßãÈÄ†‰Ωì --- */
+typedef struct font_s {
+    _TCHAR family[64];
+    int width, height, rotate;
+    BOOL bold, italic;
+    HFONT hFont;
+#ifdef __cplusplus
+    inline bool initialized() const { return false; }
+#endif
+} font_t;
+
+/* --- pen_tÊßãÈÄ†‰Ωì --- */
+typedef struct pen_s {
+    int width;
+    BYTE r, g, b;
+    HPEN hPen;
+#ifdef __cplusplus
+    inline bool initialized() const { return false; }
+#endif
+} pen_t;
+
+/* --- rec_video_thread_param_tÊßãÈÄ†‰Ωì --- */
+typedef struct {
+    PAVISTREAM pAVICompressed;
+    scrntype_t* lpBmp;
+    LPBITMAPINFOHEADER pbmInfoHeader;
+    DWORD dwAVIFileSize;
+    LONG lAVIFrames;
+    int frames;
+    int result;
+} rec_video_thread_param_t;
+
+#ifdef USE_MIDI
+typedef struct midi_thread_params_s {
+    void* send_buffer;
+    void* recv_buffer;
+    BOOL terminate;
+} midi_thread_params_t;
+#endif
+
+/* --- „ÇØ„É©„ÇπÂÆ£Ë®ÄÔºàÂâçÊñπÂÆ£Ë®ÄÔºâ --- */
+class FIFO;
+class FILEIO;
+
+/* --- OSD„ÇØ„É©„ÇπÂÆöÁæ© --- */
+class OSD
+{
+private:
+    int lock_count;
+    void initialize_console();
+    void release_console();
+    HANDLE hStdIn, hStdOut;
+    int console_count;
+    void open_telnet(const _TCHAR* title);
+    void close_telnet();
+    void send_telnet(const char* buffer);
+    BOOL use_telnet, telnet_closed;
+    int svr_socket, cli_socket;
+    void initialize_input();
+    void release_input();
+    void initialize_midi();
+    void release_midi();
+    void send_to_midi(uint8_t data);
+    bool recv_from_midi(uint8_t *data);
+#if DIRECTINPUT_VERSION >= 0x0800
+    LPDIRECTINPUT8 lpdi;
+    LPDIRECTINPUTDEVICE8 lpdikey;
+#else
+    LPDIRECTINPUT lpdi;
+    LPDIRECTINPUTDEVICE lpdikey;
+#endif
+    BOOL dinput_key_available;
+    BYTE keycode_conv[256];
+    BYTE key_status[256];
+    BYTE key_dik[256];
+    BYTE key_dik_prev[256];
+    BOOL key_shift_pressed, key_shift_released;
+    BOOL key_caps_locked;
+    BOOL lost_focus;
+#ifdef USE_JOYSTICK
+    unsigned int joy_status[4];
+    int joy_num;
+    struct {
+        UINT wNumAxes;
+        DWORD dwXposLo, dwXposHi;
+        DWORD dwYposLo, dwYposHi;
+        DWORD dwZposLo, dwZposHi;
+        DWORD dwRposLo, dwRposHi;
+        DWORD dwUposLo, dwUposHi;
+        DWORD dwVposLo, dwVposHi;
+        DWORD dwButtonsMask;
+    } joy_caps[4];
+    BOOL joy_to_key_status[256];
+#endif
+#ifdef USE_MOUSE
+    int mouse_status[3];
+    BOOL mouse_enabled;
+#endif
+    void initialize_screen();
+    void release_screen();
+    void initialize_screen_buffer(bitmap_t *buffer, int width, int height, int mode);
+    void release_screen_buffer(bitmap_t *buffer);
+#ifdef USE_SCREEN_FILTER
+    void apply_rgb_filter_to_screen_buffer(bitmap_t *source, bitmap_t *dest);
+    void apply_rgb_filter_x3_y3(bitmap_t *source, bitmap_t *dest);
+    void apply_rgb_filter_x3_y2(bitmap_t *source, bitmap_t *dest);
+    void apply_rgb_filter_x2_y3(bitmap_t *source, bitmap_t *dest);
+    void apply_rgb_filter_x2_y2(bitmap_t *source, bitmap_t *dest);
+    void apply_rgb_filter_x1_y1(bitmap_t *source, bitmap_t *dest);
+#endif
+    void rotate_screen_buffer(bitmap_t *source, bitmap_t *dest);
+    void stretch_screen_buffer(bitmap_t *source, bitmap_t *dest);
+#ifdef SUPPORT_D2D1
+    BOOL initialize_d2d1();
+    BOOL initialize_d2d1_surface(bitmap_t *buffer);
+    void release_d2d1();
+    void release_d2d1_surface();
+    void copy_to_d2d1_surface(bitmap_t *buffer);
+    void update_d2d1_screen(int dest_x, int dest_y);
+#endif
+#ifdef SUPPORT_D3D9
+    BOOL initialize_d3d9();
+    BOOL initialize_d3d9_surface(bitmap_t *buffer);
+    void release_d3d9();
+    void release_d3d9_surface();
+    void copy_to_d3d9_surface(bitmap_t *buffer);
+    void update_d3d9_screen(int dest_x, int dest_y);
+#endif
+    int add_video_frames();
+    bitmap_t vm_screen_buffer;
+#ifdef USE_SCREEN_FILTER
+    bitmap_t filtered_screen_buffer;
+    bitmap_t tmp_filtered_screen_buffer;
+#endif
+    bitmap_t rotated_screen_buffer;
+    bitmap_t stretched_screen_buffer;
+    bitmap_t shrinked_screen_buffer;
+    bitmap_t reversed_screen_buffer;
+    bitmap_t video_screen_buffer;
+    bitmap_t* draw_screen_buffer;
+    int host_window_width, host_window_height;
+    BOOL host_window_mode;
+    int vm_screen_width, vm_screen_height;
+    int vm_window_width, vm_window_height;
+    int vm_window_width_aspect, vm_window_height_aspect;
+    int draw_screen_width, draw_screen_height;
+    ULONG_PTR gdiToken;
+#ifdef SUPPORT_D2D1
+    ID2D1Factory* pD2d1Factory;
+    ID2D1DCRenderTarget *pD2d1DCRenderTarget;
+    ID2D1HwndRenderTarget* pD2d1HwndRenderTarget;
+    ID2D1Bitmap* pD2d1Bitmap;
+#endif
+#ifdef SUPPORT_D3D9
+    LPDIRECT3D9 lpd3d9;
+    LPDIRECT3DDEVICE9 lpd3d9Device;
+    LPDIRECT3DSURFACE9 lpd3d9Surface;
+    LPDIRECT3DSURFACE9 lpd3d9OffscreenSurface;
+    BOOL d3d9_device_lost;
+#endif
+    _TCHAR video_file_path[_MAX_PATH];
+    int rec_video_fps;
+    double rec_video_run_frames;
+    double rec_video_frames;
+    LPBITMAPINFO lpDibRec;
+    PAVIFILE pAVIFile;
+    PAVISTREAM pAVIStream;
+    PAVISTREAM pAVICompressed;
+    AVICOMPRESSOPTIONS AVIOpts;
+    DWORD dwAVIFileSize;
+    LONG lAVIFrames;
+    HANDLE hVideoThread;
+    rec_video_thread_param_t rec_video_thread_param;
+    BOOL first_draw_screen;
+    BOOL first_invalidate;
+    BOOL self_invalidate;
+    void initialize_sound(int rate, int samples);
+    void release_sound();
+    int sound_rate, sound_samples;
+    BOOL sound_available, sound_started, sound_muted;
+    LPDIRECTSOUND lpds;
+    LPDIRECTSOUNDBUFFER lpdsPrimaryBuffer, lpdsSecondaryBuffer;
+    BOOL sound_first_half;
+    _TCHAR sound_file_path[_MAX_PATH];
+    FILEIO* rec_sound_fio;
+    int rec_sound_bytes;
+    int rec_sound_buffer_ptr;
+#if defined(USE_MOVIE_PLAYER) || defined(USE_VIDEO_CAPTURE)
+    void initialize_video();
+    void release_video();
+    IGraphBuilder *pGraphBuilder;
+    IBaseFilter *pVideoBaseFilter;
+    IBaseFilter *pCaptureBaseFilter;
+    ICaptureGraphBuilder2 *pCaptureGraphBuilder2;
+    ISampleGrabber *pVideoSampleGrabber;
+    IBaseFilter *pSoundBaseFilter;
+    ISampleGrabber *pSoundSampleGrabber;
+    void* pSoundCallBack;
+    IMediaControl *pMediaControl;
+    IMediaSeeking *pMediaSeeking;
+    IMediaPosition *pMediaPosition;
+    IVideoWindow *pVideoWindow;
+    IBasicVideo *pBasicVideo;
+    IBasicAudio *pBasicAudio;
+    BOOL bTimeFormatFrame;
+    BOOL bVerticalReversed;
+    bitmap_t direct_show_screen_buffer;
+    bitmap_t direct_show_stretch_buffer;
+    int direct_show_width, direct_show_height;
+    BOOL direct_show_mute[2];
+    void get_video_buffer();
+    void mute_video_dev(bool l, bool r);
+    bool open_movie_file(const _TCHAR* file_path);
+    void close_movie_file();
+    void play_movie();
+    void stop_movie();
+    void pause_movie();
+    void set_cur_movie_frame(int frame, bool relative);
+    uint32_t get_cur_movie_frame();
+#endif
+#ifdef USE_MOVIE_PLAYER
+    double movie_frame_rate;
+    int movie_sound_rate;
+#endif
+#ifdef USE_VIDEO_CAPTURE
+    void enum_capture_devs();
+    BOOL connect_capture_dev(int index, BOOL pin);
+    int cur_capture_dev_index;
+    int num_capture_devs;
+    _TCHAR capture_dev_name[MAX_CAPTURE_DEVS][256];
+#endif
+#ifdef USE_SOCKET
+    void initialize_socket();
+    void release_socket();
+    SOCKET soc[SOCKET_MAX];
+    BOOL is_tcp[SOCKET_MAX];
+    sockaddr_in udpaddr[SOCKET_MAX];
+    int socket_delay[SOCKET_MAX];
+    char recv_buffer[SOCKET_MAX][SOCKET_BUFFER_MAX];
+    int recv_r_ptr[SOCKET_MAX], recv_w_ptr[SOCKET_MAX];
+#endif
+#ifdef USE_MIDI
+    void initialize_midi();
+    void release_midi();
+    HANDLE hMidiThread;
+    midi_thread_params_t midi_thread_params;
+#endif
+
+public:
+    // --- „ÇΩ„Ç±„ÉÉ„ÉàÈñ¢ÈÄ£Èñ¢Êï∞Ôºàosd_socket.cppÂÆöÁæ©„Å®‰∏ÄËá¥Ôºâ ---
+    void initialize_socket();
+    void release_socket();
+    void notify_socket_connected(int ch);
+    void notify_socket_disconnected(int ch);
+    void update_socket();
+    bool initialize_socket_tcp(int ch);
+    bool initialize_socket_udp(int ch);
+    bool connect_socket(int ch, uint32_t ipaddr, int port);
+    void disconnect_socket(int ch);
+    bool listen_socket(int ch);
+    void send_socket_data_tcp(int ch);
+    void send_socket_data_udp(int ch, uint32_t ipaddr, int port);
+    void send_socket_data(int ch);
+    void recv_socket_data(int ch);
+    OSD() { lock_count = 0; }
+    ~OSD() {}
+    void* vm;
+    void initialize(int rate, int samples);
+    void release();
+    void power_off();
+    void suspend();
+    void restore();
+    void lock_vm();
+    void unlock_vm();
+    BOOL is_vm_locked();
+    void force_unlock_vm();
+    void sleep(DWORD ms);
+    void start_waiting_in_debugger();
+    void finish_waiting_in_debugger();
+    void process_waiting_in_debugger();
+    void open_console(int width, int height, const _TCHAR* title);
+    void close_console();
+    unsigned int get_console_code_page();
+    void set_console_text_attribute(unsigned short attr);
+    void write_console(const _TCHAR* buffer, unsigned int length);
+    int read_console_input(_TCHAR* buffer, unsigned int length);
+    BOOL is_console_key_pressed(int vk);
+    BOOL is_console_closed();
+    void close_debugger_console();
+    void update_input();
+    void key_down(int code, BOOL extended, BOOL repeat);
+    void key_up(int code, BOOL extended);
+    void key_down_native(int code, BOOL repeat);
+    void key_up_native(int code);
+    void key_lost_focus();
+    void enable_mouse();
+    void disable_mouse();
+    void toggle_mouse();
+#ifdef USE_MOUSE
+    void enable_mouse();
+    void disable_mouse();
+    void toggle_mouse();
+    BOOL is_mouse_enabled();
+#endif
+    BYTE* get_key_buffer();
+#ifdef USE_JOYSTICK
+    unsigned int* get_joy_buffer() { return joy_status; }
+#endif
+#ifdef USE_MOUSE
+    int* get_mouse_buffer() { return mouse_status; }
+#endif
+#ifdef USE_AUTO_KEY
+    BOOL now_auto_key;
+#endif
+    double get_window_mode_power(int mode);
+    int get_window_mode_width(int mode);
+    int get_window_mode_height(int mode);
+    void set_host_window_size(int window_width, int window_height, BOOL window_mode);
+    void set_vm_screen_size(int screen_width, int screen_height, int window_width, int window_height, int window_width_aspect, int window_height_aspect);
+    void set_vm_screen_lines(int lines);
+    int get_vm_window_width() { return vm_window_width; }
+    int get_vm_window_height() { return vm_window_height; }
+    int get_vm_window_width_aspect() { return vm_window_width_aspect; }
+    int get_vm_window_height_aspect() { return vm_window_height_aspect; }
+    scrntype_t* get_vm_screen_buffer(int y);
+    int draw_screen();
+#ifdef ONE_BOARD_MICRO_COMPUTER
+    void reload_bitmap() { first_invalidate = 1; }
+#endif
+    void capture_screen();
+    BOOL start_record_video(int fps);
+    void stop_record_video();
+    void restart_record_video();
+    void add_extra_frames(int extra_frames);
+    BOOL now_record_video;
+#ifdef USE_SCREEN_FILTER
+    BOOL screen_skip_line;
+#endif
+    void update_sound(int* extra_frames);
+    void mute_sound();
+    void stop_sound();
+    void start_record_sound();
+    void stop_record_sound();
+    void restart_record_sound();
+    BOOL now_record_sound;
+#ifdef _UNITY
+    short* get_sound_buffer();
+#endif
+#if defined(USE_MOVIE_PLAYER) || defined(USE_VIDEO_CAPTURE)
+    void get_video_buffer();
+    void mute_video_dev(BOOL l, BOOL r);
+#endif
+#ifdef USE_MOVIE_PLAYER
+    BOOL open_movie_file(const _TCHAR* file_path);
+    void close_movie_file();
+    void play_movie();
+    void stop_movie();
+    void pause_movie();
+    double get_movie_frame_rate() { return movie_frame_rate; }
+    int get_movie_sound_rate() { return movie_sound_rate; }
+    void set_cur_movie_frame(int frame, BOOL relative);
+    DWORD get_cur_movie_frame();
+    BOOL now_movie_play, now_movie_pause;
+#endif
+#ifdef USE_VIDEO_CAPTURE
+    int get_cur_capture_dev_index() { return cur_capture_dev_index; }
+    int get_num_capture_devs() { return num_capture_devs; }
+    _TCHAR* get_capture_dev_name(int index) { return capture_dev_name[index]; }
+    void open_capture_dev(int index, BOOL pin);
+    void close_capture_dev();
+    void show_capture_dev_filter();
+    void show_capture_dev_pin();
+    void show_capture_dev_source();
+    void set_capture_dev_channel(int ch);
+#endif
+#ifdef USE_PRINTER
+    void create_bitmap(bitmap_t *bitmap, int width, int height);
+    void release_bitmap(bitmap_t *bitmap);
+    void create_font(font_t *font, const _TCHAR *family, int width, int height, int rotate, BOOL bold, BOOL italic);
+    void release_font(font_t *font);
+    void create_pen(pen_t *pen, int width, BYTE r, BYTE g, BYTE b);
+    void release_pen(pen_t *pen);
+    void clear_bitmap(bitmap_t *bitmap, BYTE r, BYTE g, BYTE b);
+    int get_text_width(bitmap_t *bitmap, font_t *font, const char *text);
+    void draw_text_to_bitmap(bitmap_t *bitmap, font_t *font, int x, int y, const char *text, BYTE r, BYTE g, BYTE b);
+    void draw_line_to_bitmap(bitmap_t *bitmap, pen_t *pen, int sx, int sy, int ex, int ey);
+    void draw_rectangle_to_bitmap(bitmap_t *bitmap, int x, int y, int width, int height, BYTE r, BYTE g, BYTE b);
+    void draw_point_to_bitmap(bitmap_t *bitmap, int x, int y, BYTE r, BYTE g, BYTE b);
+    void stretch_bitmap(bitmap_t *dest, int dest_x, int dest_y, int dest_width, int dest_height, bitmap_t *source, int source_x, int source_y, int source_width, int source_height);
+#endif
+    void write_bitmap_to_file(bitmap_t *bitmap, const _TCHAR *file_path);
+#ifdef USE_SOCKET
+    SOCKET get_socket(int ch) { return soc[ch]; }
+    void notify_socket_connected(int ch);
+    void notify_socket_disconnected(int ch);
+    void update_socket();
+    BOOL initialize_socket_tcp(int ch);
+    BOOL initialize_socket_udp(int ch);
+    BOOL connect_socket(int ch, DWORD ipaddr, int port);
+    void disconnect_socket(int ch);
+    BOOL listen_socket(int ch);
+    void send_socket_data_tcp(int ch);
+    void send_socket_data_udp(int ch, DWORD ipaddr, int port);
+    void send_socket_data(int ch);
+    void recv_socket_data(int ch);
+#endif
+#ifdef USE_MIDI
+    void send_to_midi(BYTE data);
+    BOOL recv_from_midi(BYTE *data);
+#endif
+    void invalidate_screen();
+    void update_screen(HDC hdc);
+    HWND main_window_handle;
+    HINSTANCE instance_handle;
+    BOOL vista_or_later;
+    // --- „ÉÄ„Éü„ÉºÊèèÁîª„Éª„É™„ÇΩ„Éº„ÇπÈñ¢ÈÄ£Èñ¢Êï∞ÂÆ£Ë®ÄÔºàstubÁî®Ôºâ ---
+    void create_pen(pen_t*, int, BYTE, BYTE, BYTE);
+    void release_pen(pen_t*);
+    void create_font(font_t*, const _TCHAR*, int, int, int, BOOL, BOOL);
+    void release_font(font_t*);
+    void create_bitmap(bitmap_t*, int, int);
+    void release_bitmap(bitmap_t*);
+    void clear_bitmap(bitmap_t*, BYTE, BYTE, BYTE);
+    int get_text_width(bitmap_t*, font_t*, const char*);
+    void draw_text_to_bitmap(bitmap_t*, font_t*, int, int, const char*, BYTE, BYTE, BYTE);
+    void draw_line_to_bitmap(bitmap_t*, pen_t*, int, int, int, int);
+    void draw_rectangle_to_bitmap(bitmap_t*, int, int, int, int, BYTE, BYTE, BYTE);
+    void draw_point_to_bitmap(bitmap_t*, int, int, BYTE, BYTE, BYTE);
+    void stretch_bitmap(bitmap_t*, int, int, int, int, bitmap_t*, int, int, int, int);
+};
+
+#if defined(USE_MOVIE_PLAYER) || defined(USE_VIDEO_CAPTURE)
+class CMySampleGrabberCB {};
+#endif
+#include "../platform_types.h"
+
+
+LRESULT CALLBACK MyWndProc(HWND hWnd, UINT iMsg, WPARAM wParam, LPARAM lParam);
+
+#endif /* _WIN32_OSD_H_ */
diff -ruN source/src/stub/osd_console.cpp src/stub/osd_console.cpp
--- source/src/stub/osd_console.cpp	1970-01-01 09:00:00
+++ src/stub/osd_console.cpp	2025-04-28 22:36:36
@@ -0,0 +1,24 @@
+/*
+    Stub implementation for osd_console.cpp
+    This file is auto-generated to avoid Windows dependency.
+*/
+
+#include "osd.h"
+
+// OSD class member functions (empty implementation)
+void OSD::initialize_console() {}
+void OSD::release_console() {}
+void OSD::open_console(int width, int height, const _TCHAR* title) {}
+void OSD::close_console() {}
+unsigned int OSD::get_console_code_page() { return 0; }
+void OSD::set_console_text_attribute(unsigned short attr) {}
+void OSD::write_console(const _TCHAR* buffer, unsigned int length) {}
+int OSD::read_console_input(_TCHAR* buffer, unsigned int length) { return 0; }
+BOOL OSD::is_console_key_pressed(int vk) { return FALSE; }
+BOOL OSD::is_console_closed() { return FALSE; }
+void OSD::close_debugger_console() {}
+void OSD::open_telnet(const _TCHAR* title) {}
+void OSD::close_telnet() {}
+void OSD::send_telnet(const char* string) {}
+
+// Global functions (empty implementation)
\ No newline at end of file
diff -ruN source/src/stub/osd_input.cpp src/stub/osd_input.cpp
--- source/src/stub/osd_input.cpp	1970-01-01 09:00:00
+++ src/stub/osd_input.cpp	2025-04-28 22:36:36
@@ -0,0 +1,18 @@
+/*
+    Stub implementation for osd_input.cpp
+    This file is auto-generated to avoid Windows dependency.
+*/
+
+#include "osd.h"
+
+// OSD class member functions (empty implementation)
+void OSD::initialize_input() {}
+void OSD::release_input() {}
+void OSD::update_input() {}
+void OSD::key_down(int code, BOOL extended, BOOL repeat) {}
+void OSD::key_up(int code, BOOL extended) {}
+void OSD::key_down_native(int code, BOOL repeat) {}
+void OSD::key_up_native(int code) {}
+void OSD::enable_mouse() {}
+void OSD::disable_mouse() {}
+void OSD::toggle_mouse() {}
\ No newline at end of file
diff -ruN source/src/stub/osd_midi.cpp src/stub/osd_midi.cpp
--- source/src/stub/osd_midi.cpp	1970-01-01 09:00:00
+++ src/stub/osd_midi.cpp	2025-04-28 22:36:36
@@ -0,0 +1,15 @@
+/*
+    Stub implementation for osd_midi.cpp
+    This file is auto-generated to avoid Windows dependency.
+*/
+
+#include "osd.h"
+
+// OSD class member functions (empty implementation)
+void OSD::initialize_midi() {}
+void OSD::release_midi() {}
+void OSD::send_to_midi(uint8_t data) {}
+bool OSD::recv_from_midi(uint8_t *data) { return false; }
+
+// Global function (empty implementation)
+unsigned __stdcall midi_thread(void *lpx) { return 0; }
\ No newline at end of file
diff -ruN source/src/stub/osd_screen.cpp src/stub/osd_screen.cpp
--- source/src/stub/osd_screen.cpp	1970-01-01 09:00:00
+++ src/stub/osd_screen.cpp	2025-04-28 22:36:36
@@ -0,0 +1,26 @@
+/*
+    Stub implementation for osd_screen.cpp
+    This file is auto-generated to avoid Windows dependency.
+*/
+
+#include "osd.h"
+// OSD class member functions (empty implementation)
+void OSD::initialize_screen() {}
+void OSD::release_screen() {}
+double OSD::get_window_mode_power(int mode) { return 1.0; }
+int OSD::get_window_mode_width(int mode) { return 0; }
+int OSD::get_window_mode_height(int mode) { return 0; }
+void OSD::set_host_window_size(int window_width, int window_height, BOOL window_mode) {}
+void OSD::set_vm_screen_size(int screen_width, int screen_height, int window_width, int window_height, int window_width_aspect, int window_height_aspect) {}
+void OSD::set_vm_screen_lines(int lines) {}
+scrntype_t* OSD::get_vm_screen_buffer(int y) { return nullptr; }
+int OSD::draw_screen() { return 0; }
+void OSD::invalidate_screen() {}
+void OSD::update_screen(HDC hdc) {}
+// ...Ôºà‰ªñ„ÅÆÈñ¢Êï∞„ÇÇÂêåÊßò„Å´stubÂåñ„ÅåÂøÖË¶Å„Å†„Åå„ÄÅ‰∏ªË¶Å„Å™„ÇÇ„ÅÆ„ÇíË®òËºâÔºâ
+
+// --- ËøΩÂä†„Ç∞„É≠„Éº„Éê„É´Èñ¢Êï∞„ÅÆÁ©∫ÂÆüË£Ö ---
+void capture_screen() {}
+
+void OSD::add_extra_frames(int extra_frames) {}
+int OSD::add_video_frames() { return 0; }
\ No newline at end of file
diff -ruN source/src/stub/osd_socket.cpp src/stub/osd_socket.cpp
--- source/src/stub/osd_socket.cpp	1970-01-01 09:00:00
+++ src/stub/osd_socket.cpp	2025-04-28 22:36:36
@@ -0,0 +1,22 @@
+/*
+    Stub implementation for osd_socket.cpp
+    This file is auto-generated to avoid Windows dependency.
+*/
+
+#include "osd.h"
+
+// OSD class member functions (empty implementation)
+void OSD::initialize_socket() {}
+void OSD::release_socket() {}
+void OSD::notify_socket_connected(int ch) {}
+void OSD::notify_socket_disconnected(int ch) {}
+void OSD::update_socket() {}
+bool OSD::initialize_socket_tcp(int ch) { return false; }
+bool OSD::initialize_socket_udp(int ch) { return false; }
+bool OSD::connect_socket(int ch, uint32_t ipaddr, int port) { return false; }
+void OSD::disconnect_socket(int ch) {}
+bool OSD::listen_socket(int ch) { return false; }
+void OSD::send_socket_data_tcp(int ch) {}
+void OSD::send_socket_data_udp(int ch, uint32_t ipaddr, int port) {}
+void OSD::send_socket_data(int ch) {}
+void OSD::recv_socket_data(int ch) {}
\ No newline at end of file
diff -ruN source/src/stub/osd_sound.cpp src/stub/osd_sound.cpp
--- source/src/stub/osd_sound.cpp	1970-01-01 09:00:00
+++ src/stub/osd_sound.cpp	2025-04-28 22:36:36
@@ -0,0 +1,16 @@
+/*
+    Stub implementation for osd_sound.cpp
+    This file is auto-generated to avoid Windows dependency.
+*/
+
+#include "osd.h"
+
+// OSD class member functions (empty implementation)
+void OSD::initialize_sound(int rate, int samples) {}
+void OSD::release_sound() {}
+void OSD::update_sound(int* extra_frames) {}
+void OSD::mute_sound() {}
+void OSD::stop_sound() {}
+void OSD::start_record_sound() {}
+void OSD::stop_record_sound() {}
+void OSD::restart_record_sound() {}
\ No newline at end of file
diff -ruN source/src/stub/osd_video.cpp src/stub/osd_video.cpp
--- source/src/stub/osd_video.cpp	1970-01-01 09:00:00
+++ src/stub/osd_video.cpp	2025-04-28 22:36:36
@@ -0,0 +1,19 @@
+/*
+    Stub implementation for osd_video.cpp
+    This file is auto-generated to avoid Windows dependency.
+*/
+
+#include "osd.h"
+
+// OSD class member functions (empty implementation)
+void OSD::initialize_video() {}
+void OSD::release_video() {}
+void OSD::get_video_buffer() {}
+void OSD::mute_video_dev(bool l, bool r) {}
+bool OSD::open_movie_file(const _TCHAR* file_path) { return false; }
+void OSD::close_movie_file() {}
+void OSD::play_movie() {}
+void OSD::stop_movie() {}
+void OSD::pause_movie() {}
+void OSD::set_cur_movie_frame(int frame, bool relative) {}
+uint32_t OSD::get_cur_movie_frame() { return 0; }
\ No newline at end of file
diff -ruN source/src/stub/winmain.cpp src/stub/winmain.cpp
--- source/src/stub/winmain.cpp	1970-01-01 09:00:00
+++ src/stub/winmain.cpp	2025-04-28 22:36:36
@@ -0,0 +1,15 @@
+/*
+    Stub implementation for winmain.cpp
+    This file is auto-generated to avoid Windows dependency.
+*/
+
+#include "osd.h"
+
+// ÂûãÂÆöÁæ©ÔºàÊúÄ‰ΩéÈôê„ÅÆ„ÉÄ„Éü„ÉºÂÆöÁæ©Ôºâ
+#include "../platform_types.h"
+
+// „Ç®„É≥„Éà„É™„Éù„Ç§„É≥„Éà
+int WINAPI _tWinMain(HINSTANCE hInstance, HINSTANCE hPrevInstance, _TCHAR* szCmdLine, int iCmdShow) { return 0; }
+
+// „É°„Ç§„É≥„Ç¶„Ç£„É≥„Éâ„Ç¶„Éó„É≠„Ç∑„Éº„Ç∏„É£
+LRESULT CALLBACK WndProc(HWND hWnd, UINT iMsg, WPARAM wParam, LPARAM lParam) { return 0; }
\ No newline at end of file
diff -ruN source/src/vm/ay_3_891x.cpp src/vm/ay_3_891x.cpp
--- source/src/vm/ay_3_891x.cpp	2019-02-16 00:30:00
+++ src/vm/ay_3_891x.cpp	2025-04-28 22:36:36
@@ -197,7 +197,7 @@
 void AY_3_891X::mix(int32_t* buffer, int cnt)
 {
 	if(cnt > 0 && !mute) {
-		opn->Mix(buffer, cnt);
+		opn->Mix((FM::Sample*)buffer, cnt);
 	}
 }
 
diff -ruN source/src/vm/datarec.h src/vm/datarec.h
--- source/src/vm/datarec.h	2018-12-05 22:30:00
+++ src/vm/datarec.h	2025-04-28 22:36:36
@@ -115,7 +115,7 @@
 #ifdef DATAREC_SOUND
 		sound_volume_l = sound_volume_r = 1024;
 #endif
-		my_tcscpy_s(message, _T("Stop"));
+		my_tcscpy_s(message, 1024, _T("Stop"));
 		drive_num = 0;
 		set_device_name(_T("Data Recorder"));
 	}
diff -ruN source/src/vm/debugger.h src/vm/debugger.h
--- source/src/vm/debugger.h	2025-04-28 16:00:00
+++ src/vm/debugger.h	2025-04-28 22:36:36
@@ -31,12 +31,6 @@
 	uint32_t hit_addr;
 } break_point_t;
 
-typedef struct {
-	uint32_t pc;
-	uint32_t eip;
-	bool mode;	// 32bit protected mode in i386, or 8080 mode in NEC V30
-} cpu_trace_t;
-
 class DEBUGGER : public DEVICE
 {
 private:
@@ -494,19 +488,13 @@
 		}
 		first_symbol = last_symbol = NULL;
 	}
-	void add_cpu_trace(uint32_t pc, uint32_t eip, bool mode)
+	void add_cpu_trace(uint32_t pc)
 	{
 		if(prev_cpu_trace != pc) {
-			cpu_trace[cpu_trace_ptr].pc = prev_cpu_trace = pc;
-			cpu_trace[cpu_trace_ptr].eip = eip;
-			cpu_trace[cpu_trace_ptr].mode = mode;
-			cpu_trace_ptr = (cpu_trace_ptr + 1) & (MAX_CPU_TRACE - 1);
+			cpu_trace[cpu_trace_ptr++] = prev_cpu_trace = pc;
+			cpu_trace_ptr &= (MAX_CPU_TRACE - 1);
 		}
 	}
-	void add_cpu_trace(uint32_t pc)
-	{
-		add_cpu_trace(pc, 0, false);
-	}
 	break_point_t bp, rbp, wbp, ibp, obp;
 	symbol_t *first_symbol, *last_symbol;
 	_TCHAR file_path[_MAX_PATH];
@@ -514,9 +502,8 @@
 	bool now_device_debugging; // for non-cpu devices
 	_TCHAR history[MAX_COMMAND_HISTORY][MAX_COMMAND_LENGTH + 1];
 	int history_ptr;
-	cpu_trace_t cpu_trace[MAX_CPU_TRACE];
+	uint32_t cpu_trace[MAX_CPU_TRACE], prev_cpu_trace;
 	int cpu_trace_ptr;
-	uint32_t prev_cpu_trace;
 };
 
 #endif
diff -ruN source/src/vm/device.h src/vm/device.h
--- source/src/vm/device.h	2025-04-28 16:00:00
+++ src/vm/device.h	2025-04-28 22:36:36
@@ -950,23 +950,7 @@
 	{
 		return false;
 	}
-	virtual int debug_dasm(uint32_t pc, uint32_t eip, bool mode, _TCHAR *buffer, size_t buffer_len)
-	{
-		return debug_dasm(pc, buffer, buffer_len);
-	}
-	virtual int debug_dasm(uint32_t pc, uint32_t eip, _TCHAR *buffer, size_t buffer_len)
-	{
-		return debug_dasm(pc, buffer, buffer_len);
-	}
 	virtual int debug_dasm(uint32_t pc, _TCHAR *buffer, size_t buffer_len)
-	{
-		return 0;
-	}
-	virtual uint32_t get_eip()
-	{
-		return 0;
-	}
-	virtual uint32_t get_next_eip()
 	{
 		return 0;
 	}
diff -ruN source/src/vm/disk.cpp src/vm/disk.cpp
--- source/src/vm/disk.cpp	2024-01-01 00:00:00
+++ src/vm/disk.cpp	2025-04-28 22:36:36
@@ -40,8 +40,11 @@
 	128, 256, 512, 1024, 2048, 4096, 8192, 16384
 };
 
-static uint8_t tmp_buffer[DISK_BUFFER_SIZE];
 
+// static uint8_t tmp_buffer[DISK_BUFFER_SIZE];
+// static uint8_t* tmp_buffer = nullptr;
+uint8_t* DISK::tmp_buffer = nullptr;
+
 // physical format table for solid image
 typedef struct {
 	int type;
@@ -105,7 +108,7 @@
 	{ -1, 0, 0, 0, 0 },
 };
 
-#define IS_VALID_TRACK(offset) ((offset) >= 0x20 && (offset) < sizeof(buffer))
+#define IS_VALID_TRACK(offset) ((offset) >= 0x20 && (offset) < (DISK_BUFFER_SIZE + TRACK_BUFFER_SIZE))
 
 void DISK::open(const _TCHAR* file_path, int bank)
 {
@@ -119,7 +122,7 @@
 	if(bank < 0) {
 		return;
 	}
-	memset(buffer, 0, sizeof(buffer));
+	memset(buffer, 0, DISK_BUFFER_SIZE + TRACK_BUFFER_SIZE);
 	file_bank = 0;
 	write_protected = false;
 	media_type = MEDIA_TYPE_UNK;
@@ -1226,7 +1229,8 @@
 			offset.read_4bytes_le_from(buffer + 0x20 + track * 4);
 			if(offset.sd != 0) {
 				if(offset.sd < 0x2b0) {
-					max_tracks = min((offset.sd - 0x20) >> 2, 164);
+					int temp_val = (int)((offset.sd - 0x20) >> 2);
+					max_tracks = (temp_val < 164) ? temp_val : 164;
 				}
 				break;
 			}
@@ -1435,7 +1439,7 @@
 		trim_buffer();
 		trim_required = false;
 	}
-	memset(buffer + DISK_BUFFER_SIZE, 0, sizeof(buffer) - DISK_BUFFER_SIZE);
+	memset(buffer + DISK_BUFFER_SIZE, 0, TRACK_BUFFER_SIZE);
 	pair32_t offset;
 	offset.d = DISK_BUFFER_SIZE;
 	offset.write_4bytes_le_to(buffer + 0x20 + trkside * 4);
@@ -1560,8 +1564,8 @@
 	file_size.d = dest_offset;
 	file_size.write_4bytes_le_to(tmp_buffer + 0x1c);
 	
-	memset(buffer, 0, sizeof(buffer));
-	memcpy(buffer, tmp_buffer, min(sizeof(buffer), file_size.d));
+	memset(buffer, 0, DISK_BUFFER_SIZE + TRACK_BUFFER_SIZE);
+	memcpy(buffer, tmp_buffer, min((unsigned int)(DISK_BUFFER_SIZE + TRACK_BUFFER_SIZE), (unsigned int)file_size.d));
 }
 
 int DISK::get_max_tracks()
@@ -2475,76 +2479,76 @@
 
 // nfd r0/r1 image decoder
 
-// from NFD r0å`éÆÉtÉ@ÉCÉãç\ë¢édól 2001/01/22 LED
+// from NFD r0ÔøΩ`ÔøΩÔøΩÔøΩtÔøΩ@ÔøΩCÔøΩÔøΩÔøΩ\ÔøΩÔøΩÔøΩdÔøΩl 2001/01/22 LED
 typedef struct {
-    BYTE  C;                            // C Åi0xFFÇÃéûÉZÉNÉ^ñ≥ÇµÅj
+    BYTE  C;                            // C ÔøΩi0xFFÔøΩÃéÔøΩÔøΩZÔøΩNÔøΩ^ÔøΩÔøΩÔøΩÔøΩÔøΩj
     BYTE  H;                            // H
     BYTE  R;                            // R
     BYTE  N;                            // N
     BYTE  flMFM;                        // 0:FM / 1:MFM
     BYTE  flDDAM;                       // 0:DAM / 1:DDAM
-    BYTE  byStatus;                     // READ DATA(FDDBIOS)ÇÃåãâ 
-    BYTE  byST0;                        // READ DATA(FDDBIOS)ÇÃåãâ  ST0
-    BYTE  byST1;                        // READ DATA(FDDBIOS)ÇÃåãâ  ST1
-    BYTE  byST2;                        // READ DATA(FDDBIOS)ÇÃåãâ  ST2
-    BYTE  byPDA;                        // FDDBIOSÇ≈égópÇ∑ÇÈÉAÉhÉåÉX
-    char Reserve1[5];                   // ó\ñÒ
+    BYTE  byStatus;                     // READ DATA(FDDBIOS)ÔøΩÃåÔøΩÔøΩÔøΩ
+    BYTE  byST0;                        // READ DATA(FDDBIOS)ÔøΩÃåÔøΩÔøΩÔøΩ ST0
+    BYTE  byST1;                        // READ DATA(FDDBIOS)ÔøΩÃåÔøΩÔøΩÔøΩ ST1
+    BYTE  byST2;                        // READ DATA(FDDBIOS)ÔøΩÃåÔøΩÔøΩÔøΩ ST2
+    BYTE  byPDA;                        // FDDBIOSÔøΩ≈égÔøΩpÔøΩÔøΩÔøΩÔøΩAÔøΩhÔøΩÔøΩÔøΩX
+    char Reserve1[5];                   // ÔøΩ\ÔøΩÔøΩ
 }NFD_SECT_ID,*LP_NFD_SECT_ID;
 
 typedef struct {
-    char  szFileID[15];                 // éØï ID "T98FDDIMAGE.R0"
-    char  Reserve1[1];                  // ó\ñÒ
-    char  szComment[0x100];             // ÉCÉÅÅ[ÉWÉRÉÅÉìÉg(ASCIIz)
-    DWORD dwHeadSize()                  // ÉwÉbÉ_ïîÇÃÉTÉCÉY
+    char  szFileID[15];                 // ÔøΩÔøΩÔøΩÔøΩID "T98FDDIMAGE.R0"
+    char  Reserve1[1];                  // ÔøΩ\ÔøΩÔøΩ
+    char  szComment[0x100];             // ÔøΩCÔøΩÔøΩÔøΩ[ÔøΩWÔøΩRÔøΩÔøΩÔøΩÔøΩÔøΩg(ASCIIz)
+    DWORD dwHeadSize()                  // ÔøΩwÔøΩbÔøΩ_ÔøΩÔøΩÔøΩÃÉTÔøΩCÔøΩY
     {
       return byHeadSize[0] | (byHeadSize[1] << 8) | (byHeadSize[2] << 16) | (byHeadSize[3] << 24);
     }
     BYTE  byHeadSize[4];
-    BYTE  flProtect;                    // 0à»äO : ÉâÉCÉgÉvÉçÉeÉNÉg
-    BYTE  byHead;                       // ÉwÉbÉhêî
-    char  Reserve2[10];                 // ó\ñÒ
-    NFD_SECT_ID si[163][26];            // ÉZÉNÉ^ID(å„èq)
-    char  Reserve3[0x10];               // ó\ñÒ
+    BYTE  flProtect;                    // 0ÔøΩ»äO : ÔøΩÔøΩÔøΩCÔøΩgÔøΩvÔøΩÔøΩÔøΩeÔøΩNÔøΩg
+    BYTE  byHead;                       // ÔøΩwÔøΩbÔøΩhÔøΩÔøΩ
+    char  Reserve2[10];                 // ÔøΩ\ÔøΩÔøΩ
+    NFD_SECT_ID si[163][26];            // ÔøΩZÔøΩNÔøΩ^ID(ÔøΩÔøΩq)
+    char  Reserve3[0x10];               // ÔøΩ\ÔøΩÔøΩ
 }NFD_FILE_HEAD,*LP_NFD_FILE_HEAD;
 
-// from NFD r1å`éÆÉtÉ@ÉCÉãç\ë¢édól 2001/09/14 LED
+// from NFD r1ÔøΩ`ÔøΩÔøΩÔøΩtÔøΩ@ÔøΩCÔøΩÔøΩÔøΩ\ÔøΩÔøΩÔøΩdÔøΩl 2001/09/14 LED
 typedef struct {
-    char  szFileID[15];                         /* éØï ID "T98FDDIMAGE.R1"  */
-    char  Reserve1[1];                          /* ó\ñÒ                     */
-    char szComment[0x100];                      /* ÉRÉÅÉìÉg                 */
-    DWORD dwHeadSize()                          /* ÉwÉbÉ_ÇÃÉTÉCÉY           */
+    char  szFileID[15];                         /* ÔøΩÔøΩÔøΩÔøΩID "T98FDDIMAGE.R1"  */
+    char  Reserve1[1];                          /* ÔøΩ\ÔøΩÔøΩ                     */
+    char szComment[0x100];                      /* ÔøΩRÔøΩÔøΩÔøΩÔøΩÔøΩg                 */
+    DWORD dwHeadSize()                          /* ÔøΩwÔøΩbÔøΩ_ÔøΩÃÉTÔøΩCÔøΩY           */
     {
       return byHeadSize[0] | (byHeadSize[1] << 8) | (byHeadSize[2] << 16) | (byHeadSize[3] << 24);
     }
     BYTE byHeadSize[4];
-    BYTE flProtect;                             /* ÉâÉCÉgÉvÉçÉeÉNÉg0à»äO    */
-    BYTE byHead;                                /* ÉwÉbÉhêî 1-2             */
-    char Reserv2[0x10-4-1-1];                   /* ó\îı                     */
-    DWORD dwTrackHead(int trk)                  /* ÉgÉâÉbÉNIDà íu           */
+    BYTE flProtect;                             /* ÔøΩÔøΩÔøΩCÔøΩgÔøΩvÔøΩÔøΩÔøΩeÔøΩNÔøΩg0ÔøΩ»äO    */
+    BYTE byHead;                                /* ÔøΩwÔøΩbÔøΩhÔøΩÔøΩ 1-2             */
+    char Reserv2[0x10-4-1-1];                   /* ÔøΩ\ÔøΩÔøΩ                     */
+    DWORD dwTrackHead(int trk)                  /* ÔøΩgÔøΩÔøΩÔøΩbÔøΩNIDÔøΩ íu           */
     {
       return byTrackHead[trk][0] | (byTrackHead[trk][1] << 8) | (byTrackHead[trk][2] << 16) | (byTrackHead[trk][3] << 24);
     }
     BYTE byTrackHead[164][4];
-    DWORD dwAddInfo()                           /* í«â¡èÓïÒÉwÉbÉ_ÇÃÉAÉhÉåÉX */
+    DWORD dwAddInfo()                           /* ÔøΩ«âÔøΩÔøΩÔøΩÔøΩwÔøΩbÔøΩ_ÔøΩÃÉAÔøΩhÔøΩÔøΩÔøΩX */
     {
       return byAddInfo[0] | (byAddInfo[1] << 8) | (byAddInfo[2] << 16) | (byAddInfo[3] << 24);
     }
     BYTE byAddInfo[4];
-    char Reserv3[0x10-4];                       /* ó\îı                     */
+    char Reserv3[0x10-4];                       /* ÔøΩ\ÔøΩÔøΩ                     */
 }NFD_FILE_HEAD1,*LP_NFD_FILE_HEAD1;
 
 typedef struct {
-    WORD wSector()                              /* ÉZÉNÉ^IDêî               */
+    WORD wSector()                              /* ÔøΩZÔøΩNÔøΩ^IDÔøΩÔøΩ               */
     {
       return bySector[0] | (bySector[1] << 8);
     }
     BYTE bySector[2];
-    WORD wDiag()                                /* ì¡éÍ IDêî                */
+    WORD wDiag()                                /* ÔøΩÔøΩÔøΩÔøΩ IDÔøΩÔøΩ                */
     {
       return byDiag[0] | (byDiag[1] << 8);
     }
     BYTE byDiag[2];
-    char Reserv1[0x10-4];                       /* ó\îı                     */
+    char Reserv1[0x10-4];                       /* ÔøΩ\ÔøΩÔøΩ                     */
 }NFD_TRACK_ID1,*LP_NFD_TRACK_ID1;
 
 typedef struct {
@@ -2558,9 +2562,9 @@
     BYTE    bySTS0;                             /* ST0                      */
     BYTE    bySTS1;                             /* ST1                      */
     BYTE    bySTS2;                             /* ST2                      */
-    BYTE    byRetry;                            /* RetryDataÇ»Çµ(0)Ç†ÇË(1-) */
+    BYTE    byRetry;                            /* RetryDataÔøΩ»ÇÔøΩ(0)ÔøΩÔøΩÔøΩÔøΩ(1-) */
     BYTE    byPDA;                              /* PDA                      */
-    char Reserv1[0x10-12];                      /* ó\îı                     */
+    char Reserv1[0x10-12];                      /* ÔøΩ\ÔøΩÔøΩ                     */
 }NFD_SECT_ID1,*LP_NFD_SECT_ID1;
 
 typedef struct {
@@ -2573,14 +2577,14 @@
     BYTE    bySTS0;                             /* ST0                      */
     BYTE    bySTS1;                             /* ST1                      */
     BYTE    bySTS2;                             /* ST2                      */
-    BYTE    byRetry;                            /* RetryDataÇ»Çµ(0)Ç†ÇË(1-) */
+    BYTE    byRetry;                            /* RetryDataÔøΩ»ÇÔøΩ(0)ÔøΩÔøΩÔøΩÔøΩ(1-) */
     DWORD   dwDataLen()
     {
       return byDataLen[0] | (byDataLen[1] << 8) | (byDataLen[2] << 16) | (byDataLen[3] << 24);
     }
     BYTE    byDataLen[4];
     BYTE    byPDA;                              /* PDA                      */
-    char Reserv1[0x10-15];                      /* ó\îı                     */
+    char Reserv1[0x10-15];                      /* ÔøΩ\ÔøΩÔøΩ                     */
 }NFD_DIAG_ID1,*LP_NFD_DIAG_ID1;
 
 bool DISK::nfdr0_to_d88(FILEIO *fio)
@@ -2900,7 +2904,7 @@
 	if(!state_fio->StateCheckUint32(STATE_VERSION)) {
 		return false;
 	}
-	state_fio->StateArray(buffer, sizeof(buffer), 1);
+	state_fio->StateArray(buffer, DISK_BUFFER_SIZE + TRACK_BUFFER_SIZE, 1);
 	state_fio->StateArray(orig_path, sizeof(orig_path), 1);
 	state_fio->StateArray(dest_path, sizeof(dest_path), 1);
 	state_fio->StateValue(file_size.d);
diff -ruN source/src/vm/disk.h src/vm/disk.h
--- source/src/vm/disk.h	2023-05-29 00:00:00
+++ src/vm/disk.h	2025-04-28 22:36:36
@@ -56,7 +56,8 @@
 	EMU* emu;
 #endif
 private:
-	uint8_t buffer[DISK_BUFFER_SIZE + TRACK_BUFFER_SIZE];
+	uint8_t* buffer;
+	static uint8_t* tmp_buffer;
 	_TCHAR orig_path[_MAX_PATH];
 	_TCHAR dest_path[_MAX_PATH];
 	pair32_t file_size;
@@ -111,6 +112,10 @@
 	DISK()
 #endif
 	{
+		if(tmp_buffer == nullptr) {
+			tmp_buffer = new uint8_t[DISK_BUFFER_SIZE];
+		}
+		buffer = new uint8_t[DISK_BUFFER_SIZE + TRACK_BUFFER_SIZE];
 		inserted = ejected = write_protected = changed = false;
 		is_special_disk = 0;
 		file_size.d = 0;
@@ -131,6 +136,14 @@
 			close();
 		}
 #endif
+		if(buffer) {
+			delete[] buffer;
+			buffer = nullptr;
+		}
+		if(tmp_buffer) {
+			delete[] tmp_buffer;
+			tmp_buffer = nullptr;
+		}
 	}
 	
 	void open(const _TCHAR* file_path, int bank);
@@ -234,13 +247,13 @@
 	{
 		if(format != NULL) {
 			va_list ap;
-			_TCHAR buffer[1024];
+			_TCHAR buffer2[1024];
 			
 			va_start(ap, format);
-			my_vstprintf_s(buffer, 1024, format, ap);
+			my_vstprintf_s(buffer2, 1024, format, ap);
 			va_end(ap);
 			
-			my_tcscpy_s(this_device_name, 128, buffer);
+			my_tcscpy_s(this_device_name, 128, buffer2);
 #ifdef _USE_QT
 //			emu->get_osd()->set_vm_node(this_device_id, buffer);
 #endif
diff -ruN source/src/vm/fmdll/fmdll.h src/vm/fmdll/fmdll.h
--- source/src/vm/fmdll/fmdll.h	2017-06-22 01:00:00
+++ src/vm/fmdll/fmdll.h	2025-04-28 22:36:36
@@ -4,7 +4,9 @@
 //
 #pragma	once
 
+#ifdef _WIN32
 #include <windows.h>
+#endif
 
 //#include "fmdll.h"
 
@@ -18,7 +20,7 @@
 #define	SUPPORT_FM_8		0x00000080
 #define	SUPPORT_FM_A		0x00000007
 #define	SUPPORT_FM_B		0x00000038
-#define	SUPPORT_FM_C		0x000000c0	// OPMóp
+#define	SUPPORT_FM_C		0x000000c0	// OPMÔøΩp
 #define	SUPPORT_FM			(SUPPORT_FM_A+SUPPORT_FM_B+SUPPORT_FM_C)
 #define	SUPPORT_PSG_1		0x00000100
 #define	SUPPORT_PSG_2		0x00000200
@@ -37,12 +39,12 @@
 #define	SUPPORT_PSGPCM		0x00100000
 #define	SUPPORT_BEEPPCM		0x00200000
 
-#define	SUPPORT_CSM			0x00800000	// DLLì‡Ç≈CSMÇèàóùÇ∑ÇÈÇ©
-#define	SUPPORT_TIMER		0x01000000	// É^ÉCÉ}Å[A/B
+#define	SUPPORT_CSM			0x00800000	// DLLÔøΩÔøΩÔøΩÔøΩCSMÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÈÇ©
+#define	SUPPORT_TIMER		0x01000000	// ÔøΩ^ÔøΩCÔøΩ}ÔøΩ[A/B
 #define	SUPPORT_STATUS		0x02000000	// BUSY/TIMER/ID
 #define	SUPPORT_REG			0x04000000	// GetReg
-#define	SUPPORT_INFO		0x08000000	// fm_getver/fm_getauthorìô
-#define	SUPPORT_MULTIPLE	0x10000000	// ï°êîchip
+#define	SUPPORT_INFO		0x08000000	// fm_getver/fm_getauthorÔøΩÔøΩ
+#define	SUPPORT_MULTIPLE	0x10000000	// ÔøΩÔøΩÔøΩÔøΩchip
 
 
 #define	SUPPORT_FAILED		0x80000000
@@ -66,7 +68,7 @@
 typedef	DWORD (__cdecl *DLLFUNC2)(LPVOID, DWORD);
 typedef	DWORD (__cdecl *DLLFUNC3)(LPVOID, DWORD, DWORD);
 
-//	DLLì‡Ç≈Ç‡CriticalSectionÇµÇƒÇ¢ÇÈ
+//	DLLÔøΩÔøΩÔøΩ≈ÇÔøΩCriticalSectionÔøΩÔøΩÔøΩƒÇÔøΩÔøΩÔøΩ
 //	#define USE_CS
 #ifdef USE_CS
 #define	CLI()	EnterCriticalSection(&cs)
@@ -131,7 +133,7 @@
 			fm_getcaps = (DLLFUNC1) GetProcAddress(hDll, "fm_getcaps");
 			fm_getdllver = (DLLFUNC1) GetProcAddress(hDll, "fm_getdllver");
 			
-			//	Ç±ÇÃä÷êîÇ™Ç†ÇÈÇÃÇÕV1à»ç~
+			//	ÔøΩÔøΩÔøΩÃä÷êÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÃÇÔøΩV1ÔøΩ»ç~
 			if (fm_getdllver == NULL) {
 				FreeLibrary(hDll);
 				hDll = NULL;
@@ -154,13 +156,13 @@
 		}
 	}
 
-	//	DLLÇÃë∂ç›ÉtÉâÉO
+	//	DLLÔøΩÃëÔøΩÔøΩ›ÉtÔøΩÔøΩÔøΩO
 	BOOL IsDll(void) {
 		return (hDll != NULL ? TRUE : FALSE);
 	}
 
-	//	âπåπçÏê¨(&chipÇ»ÇÃÇ…íçà”)
-	//	chipÇ…ÇÕNULLÇì¸ÇÍÇƒÇ®Ç≠éñ
+	//	ÔøΩÔøΩÔøΩÔøΩÔøΩÏê¨(&chipÔøΩ»ÇÃÇ…íÔøΩÔøΩÔøΩ)
+	//	chipÔøΩ…ÇÔøΩNULLÔøΩÔøΩÔøΩÔøΩÔøΩƒÇÔøΩÔøΩÔøΩÔøΩÔøΩ
 	BOOL Create(LPVOID *chip, int clock, int rate) {
 		BOOL	bRet = FALSE;
 		if (hDll != NULL && fm_create != NULL) {
@@ -170,7 +172,7 @@
 //			bRet = fm_create(&lpv, clock, rate);
 //			*chip = lpv;
 #if 0
-			//	chipÇÃì‡óeÇ≈îªíf
+			//	chipÔøΩÃìÔøΩÔøΩeÔøΩ≈îÔøΩÔøΩf
 			if (!bRet) {
 				FreeLibrary(hDll);
 				hDll = NULL;
@@ -181,7 +183,7 @@
 		return bRet;
 	}
 		
-	//	âπåπÉäÉZÉbÉg
+	//	ÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩZÔøΩbÔøΩg
 	void Reset(LPVOID chip) {
 		if (hDll != NULL && fm_reset != NULL) {
 			CLI();
@@ -190,7 +192,7 @@
 		}
 	}
 	
-	//	çáê¨ÉåÅ[Égê›íË
+	//	ÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩ[ÔøΩgÔøΩ›íÔøΩ
 	void SetRate(LPVOID chip, int clock, int rate) {
 		if (hDll != NULL && fm_setrate != NULL) {
 			CLI();
@@ -199,7 +201,7 @@
 		}
 	}
 	
-	//	ÉåÉWÉXÉ^ê›íË
+	//	ÔøΩÔøΩÔøΩWÔøΩXÔøΩ^ÔøΩ›íÔøΩ
 	void SetReg(LPVOID chip, UINT adr, BYTE data) {
 		if (hDll != NULL && fm_setreg != NULL) {
 			CLI();
@@ -208,7 +210,7 @@
 		}
 	}
 	
-	//	ÉåÉWÉXÉ^ê›íË
+	//	ÔøΩÔøΩÔøΩWÔøΩXÔøΩ^ÔøΩ›íÔøΩ
 	DWORD GetReg(LPVOID chip, UINT adr) {
 		DWORD	dwRet = 0;
 		if (hDll != NULL && fm_getreg != NULL) {
@@ -219,7 +221,7 @@
 		return dwRet;
 	}
 	
-	//	FMâπåπÉ{ÉäÉÖÅ[ÉÄê›íË(fmgenå›ä∑)
+	//	FMÔøΩÔøΩÔøΩÔøΩÔøΩ{ÔøΩÔøΩÔøΩÔøΩÔøΩ[ÔøΩÔøΩÔøΩ›íÔøΩ(fmgenÔøΩ›äÔøΩ)
 	void SetVolumeFM(LPVOID chip, int vol) {
 		if (hDll != NULL && fm_setvolfm != NULL) {
 			CLI();
@@ -228,7 +230,7 @@
 		}
 	}
 	
-	//	PSGâπåπÉ{ÉäÉÖÅ[ÉÄê›íË(fmgenå›ä∑)
+	//	PSGÔøΩÔøΩÔøΩÔøΩÔøΩ{ÔøΩÔøΩÔøΩÔøΩÔøΩ[ÔøΩÔøΩÔøΩ›íÔøΩ(fmgenÔøΩ›äÔøΩ)
 	void SetVolumePSG(LPVOID chip, int vol) {
 		if (hDll != NULL && fm_setvolpsg != NULL) {
 			CLI();
@@ -237,7 +239,7 @@
 		}
 	}
 	
-	//	ÉäÉYÉÄâπåπëSëÃÉ{ÉäÉÖÅ[ÉÄê›íË(fmgenå›ä∑)
+	//	ÔøΩÔøΩÔøΩYÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩSÔøΩÃÉ{ÔøΩÔøΩÔøΩÔøΩÔøΩ[ÔøΩÔøΩÔøΩ›íÔøΩ(fmgenÔøΩ›äÔøΩ)
 	void SetVolumeRhythmTotal(LPVOID chip, int vol) {
 		if (hDll != NULL && fm_setvolrhythmtotal != NULL) {
 			CLI();
@@ -246,7 +248,7 @@
 		}
 	}
 	
-	//	äeÉäÉYÉÄâπåπÉ{ÉäÉÖÅ[ÉÄê›íË(fmgenå›ä∑)
+	//	ÔøΩeÔøΩÔøΩÔøΩYÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩ{ÔøΩÔøΩÔøΩÔøΩÔøΩ[ÔøΩÔøΩÔøΩ›íÔøΩ(fmgenÔøΩ›äÔøΩ)
 	void SetVolumeRhythm(LPVOID chip, int no, int vol) {
 		if (hDll != NULL && fm_setvolrhythm != NULL) {
 			CLI();
@@ -255,7 +257,7 @@
 		}
 	}
 
-	//	ADPCMÉ{ÉäÉÖÅ[ÉÄê›íË(fmgenå›ä∑)
+	//	ADPCMÔøΩ{ÔøΩÔøΩÔøΩÔøΩÔøΩ[ÔøΩÔøΩÔøΩ›íÔøΩ(fmgenÔøΩ›äÔøΩ)
 	void SetVolumeADPCM(LPVOID chip, int vol) {
 		if (hDll != NULL && fm_setvoladpcm != NULL) {
 			CLI();
@@ -264,7 +266,7 @@
 		}
 	}
 	
-	//	É`ÉÉÉìÉlÉãÉ}ÉXÉN(fmgenå›ä∑)
+	//	ÔøΩ`ÔøΩÔøΩÔøΩÔøΩÔøΩlÔøΩÔøΩÔøΩ}ÔøΩXÔøΩN(fmgenÔøΩ›äÔøΩ)
 	void SetChannelMask(LPVOID chip, int mask) {
 		if (hDll != NULL && fm_setchannelmask != NULL) {
 			CLI();
@@ -273,7 +275,7 @@
 		}
 	}
 	
-	//	É^ÉCÉ}çXêV(fmgenå›ä∑)
+	//	ÔøΩ^ÔøΩCÔøΩ}ÔøΩXÔøΩV(fmgenÔøΩ›äÔøΩ)
 	void Count(LPVOID chip, DWORD us) {
 		if (hDll != NULL && fm_updatetimer != NULL) {
 			CLI();
@@ -282,7 +284,7 @@
 		}
 	}
 	
-	//	éüÉ^ÉCÉ}Å[ÉCÉxÉìÉgÇ‹Ç≈ÇÃéûä‘éÊìæ(fmgenå›ä∑)
+	//	ÔøΩÔøΩÔøΩ^ÔøΩCÔøΩ}ÔøΩ[ÔøΩCÔøΩxÔøΩÔøΩÔøΩgÔøΩ‹Ç≈ÇÃéÔøΩÔøΩ‘éÊìæ(fmgenÔøΩ›äÔøΩ)
 	DWORD GetNextEvent(LPVOID chip) {
 		DWORD	dwRet = 0xffffffff;
 		if (hDll != NULL && fm_getnextevent != NULL) {
@@ -293,7 +295,7 @@
 		return dwRet;
 	}
 	
-	//	çáê¨
+	//	ÔøΩÔøΩÔøΩÔøΩ
 	void Mix(LPVOID chip, int *pcm, int samples) {
 		if (hDll != NULL && fm_getpcm != NULL) {
 			CLI();
@@ -302,7 +304,7 @@
 		}
 	}
 #if 0
-	//	äeÉ`ÉÉÉìÉlÉãPCMÉfÅ[É^éÊìæ(ÉÇÉmÉâÉã)
+	//	ÔøΩeÔøΩ`ÔøΩÔøΩÔøΩÔøΩÔøΩlÔøΩÔøΩPCMÔøΩfÔøΩ[ÔøΩ^ÔøΩÊìæ(ÔøΩÔøΩÔøΩmÔøΩÔøΩÔøΩÔøΩ)
 	int* GetBuffer(LPVOID chip, int no) {
 		int	*p = NULL;
 		if (hDll != NULL && fm_getpcmbuf != NULL) {
@@ -313,8 +315,8 @@
 		return p;
 	}
 #endif
-	//	ADPCMÉoÉbÉtÉ@(256KB)
-	//	bufÇ∆bufferÇ™ç¨ç›ÇµÇƒÇÈÅc
+	//	ADPCMÔøΩoÔøΩbÔøΩtÔøΩ@(256KB)
+	//	bufÔøΩÔøΩbufferÔøΩÔøΩÔøΩÔøΩÔøΩ›ÇÔøΩÔøΩƒÇÔøΩc
 	LPBYTE GetADPCMBuffer(LPVOID chip) {
 		LPBYTE	p = NULL;
 		if (hDll != NULL && fm_getadpcmbuf != NULL) {
@@ -324,7 +326,7 @@
 		}
 		return p;
 	}
-	//	äJï˙
+	//	ÔøΩJÔøΩÔøΩ
 	void Release(LPVOID chip) {
 		if (hDll != NULL && fm_release != NULL) {
 			CLI();
@@ -344,7 +346,7 @@
 		return dwRet;
 	}
 	
-	//	ÉTÉ|Å[ÉgÇµÇƒÇ¢ÇÈã@î\Çï‘Ç∑
+	//	ÔøΩTÔøΩ|ÔøΩ[ÔøΩgÔøΩÔøΩÔøΩƒÇÔøΩÔøΩÔøΩ@ÔøΩ\ÔøΩÔøΩ‘ÇÔøΩ
 	DWORD GetCaps(LPVOID chip) {
 		DWORD	dwRet = 0;
 		if (hDll != NULL && fm_getcaps != NULL) {
diff -ruN source/src/vm/i286.cpp src/vm/i286.cpp
--- source/src/vm/i286.cpp	2025-04-28 16:00:00
+++ src/vm/i286.cpp	2025-04-28 22:36:36
@@ -296,24 +296,6 @@
 		cpustate->regs.b[DL] = data;
 	} else if(_tcsicmp(reg, _T("DH")) == 0) {
 		cpustate->regs.b[DH] = data;
-	} else if(_tcsicmp(reg, _T("CF")) == 0) {
-		cpustate->CarryVal = (data != 0);
-	} else if(_tcsicmp(reg, _T("PF")) == 0) {
-		cpustate->ParityVal = (data != 0) ? 0 : 1;
-	} else if(_tcsicmp(reg, _T("AF")) == 0) {
-		cpustate->AuxVal = (data != 0);
-	} else if(_tcsicmp(reg, _T("ZF")) == 0) {
-		cpustate->ZeroVal = (data != 0) ? 0 : 1;
-	} else if(_tcsicmp(reg, _T("SF")) == 0) {
-		cpustate->SignVal = (data != 0) ? -1 : 0;
-	} else if(_tcsicmp(reg, _T("TF")) == 0) {
-		cpustate->TF = (data != 0);
-	} else if(_tcsicmp(reg, _T("IF")) == 0) {
-		cpustate->IF = (data != 0);
-	} else if(_tcsicmp(reg, _T("DF")) == 0) {
-		cpustate->DirVal = (data != 0) ? -1 : 0;
-	} else if(_tcsicmp(reg, _T("OF")) == 0) {
-		cpustate->OverVal = (data != 0);
 	} else {
 		return false;
 	}
@@ -357,24 +339,6 @@
 		return cpustate->regs.b[DL];
 	} else if(_tcsicmp(reg, _T("DH")) == 0) {
 		return cpustate->regs.b[DH];
-	} else if(_tcsicmp(reg, _T("CF")) == 0) {
-		return (cpustate->CarryVal != 0);
-	} else if(_tcsicmp(reg, _T("PF")) == 0) {
-		return (cpustate->ParityVal == 0);
-	} else if(_tcsicmp(reg, _T("AF")) == 0) {
-		return (cpustate->AuxVal != 0);
-	} else if(_tcsicmp(reg, _T("ZF")) == 0) {
-		return (cpustate->ZeroVal == 0);
-	} else if(_tcsicmp(reg, _T("SF")) == 0) {
-		return (cpustate->SignVal < 0);
-	} else if(_tcsicmp(reg, _T("TF")) == 0) {
-		return (cpustate->TF != 0);
-	} else if(_tcsicmp(reg, _T("IF")) == 0) {
-		return (cpustate->IF != 0);
-	} else if(_tcsicmp(reg, _T("DF")) == 0) {
-		return (cpustate->DirVal < 0);
-	} else if(_tcsicmp(reg, _T("OF")) == 0) {
-		return (cpustate->OverVal != 0);
 	}
 	return 0;
 }
diff -ruN source/src/vm/i286_np21.cpp src/vm/i286_np21.cpp
--- source/src/vm/i286_np21.cpp	2025-04-28 16:00:00
+++ src/vm/i286_np21.cpp	2025-04-28 22:36:36
@@ -12,6 +12,7 @@
 #ifdef USE_DEBUGGER
 #include "debugger.h"
 #include "i386_dasm.h"
+#include "v30_dasm.h"
 #endif
 #include "np21/i286c/cpucore.h"
 #include "np21/i286c/v30patch.h"
@@ -298,60 +299,6 @@
 		CPU_DL = data;
 	} else if(_tcsicmp(reg, _T("DH")) == 0) {
 		CPU_DH = data;
-	} else if(_tcsicmp(reg, _T("CF")) == 0) {
-		if(data) {
-			CPU_FLAG |=  C_FLAG;
-		} else {
-			CPU_FLAG &= ~C_FLAG;
-		}
-	} else if(_tcsicmp(reg, _T("PF")) == 0) {
-		if(data) {
-			CPU_FLAG |=  P_FLAG;
-		} else {
-			CPU_FLAG &= ~P_FLAG;
-		}
-	} else if(_tcsicmp(reg, _T("AF")) == 0) {
-		if(data) {
-			CPU_FLAG |=  A_FLAG;
-		} else {
-			CPU_FLAG &= ~A_FLAG;
-		}
-	} else if(_tcsicmp(reg, _T("ZF")) == 0) {
-		if(data) {
-			CPU_FLAG |=  Z_FLAG;
-		} else {
-			CPU_FLAG &= ~Z_FLAG;
-		}
-	} else if(_tcsicmp(reg, _T("SF")) == 0) {
-		if(data) {
-			CPU_FLAG |=  S_FLAG;
-		} else {
-			CPU_FLAG &= ~S_FLAG;
-		}
-	} else if(_tcsicmp(reg, _T("TF")) == 0) {
-		if(data) {
-			CPU_FLAG |=  T_FLAG;
-		} else {
-			CPU_FLAG &= ~T_FLAG;
-		}
-	} else if(_tcsicmp(reg, _T("IF")) == 0) {
-		if(data) {
-			CPU_FLAG |=  I_FLAG;
-		} else {
-			CPU_FLAG &= ~I_FLAG;
-		}
-	} else if(_tcsicmp(reg, _T("DF")) == 0) {
-		if(data) {
-			CPU_FLAG |=  D_FLAG;
-		} else {
-			CPU_FLAG &= ~D_FLAG;
-		}
-	} else if(_tcsicmp(reg, _T("OF")) == 0) {
-		if(data) {
-			CPU_FLAG |=  O_FLAG;
-		} else {
-			CPU_FLAG &= ~O_FLAG;
-		}
 	} else {
 		return false;
 	}
@@ -394,24 +341,6 @@
 		return CPU_DL;
 	} else if(_tcsicmp(reg, _T("DH")) == 0) {
 		return CPU_DH;
-	} else if(_tcsicmp(reg, _T("CF")) == 0) {
-		return ((CPU_FLAG & C_FLAG) != 0);
-	} else if(_tcsicmp(reg, _T("PF")) == 0) {
-		return ((CPU_FLAG & P_FLAG) != 0);
-	} else if(_tcsicmp(reg, _T("AF")) == 0) {
-		return ((CPU_FLAG & A_FLAG) != 0);
-	} else if(_tcsicmp(reg, _T("ZF")) == 0) {
-		return ((CPU_FLAG & Z_FLAG) != 0);
-	} else if(_tcsicmp(reg, _T("SF")) == 0) {
-		return ((CPU_FLAG & S_FLAG) != 0);
-	} else if(_tcsicmp(reg, _T("TF")) == 0) {
-		return ((CPU_FLAG & T_FLAG) != 0);
-	} else if(_tcsicmp(reg, _T("IF")) == 0) {
-		return ((CPU_FLAG & I_FLAG) != 0);
-	} else if(_tcsicmp(reg, _T("DF")) == 0) {
-		return ((CPU_FLAG & D_FLAG) != 0);
-	} else if(_tcsicmp(reg, _T("OF")) == 0) {
-		return ((CPU_FLAG & O_FLAG) != 0);
 	}
 	return 0;
 }
diff -ruN source/src/vm/i386.cpp src/vm/i386.cpp
--- source/src/vm/i386.cpp	2025-04-28 16:00:00
+++ src/vm/i386.cpp	2025-04-28 22:36:36
@@ -210,48 +210,7 @@
 
 void I386::initialize()
 {
-	switch(device_model) {
-	case INTEL_80386:
-		opaque = CPU_INIT_CALL(i386);
-		set_device_name(_T("80386 CPU"));
-		break;
-	case INTEL_I486DX:
-		opaque = CPU_INIT_CALL(i486);
-		set_device_name(_T("80486DX CPU"));
-		break;
-	case INTEL_PENTIUM:
-		opaque = CPU_INIT_CALL(pentium);
-		set_device_name(_T("Pentium CPU"));
-		break;
-	case INTEL_MMX_PENTIUM:
-		opaque = CPU_INIT_CALL(pentium_mmx);
-		set_device_name(_T("MMX Pentium CPU"));
-		break;
-	case INTEL_PENTIUM_PRO:
-		opaque = CPU_INIT_CALL(pentium_pro);
-		set_device_name(_T("Pentium Pro CPU"));
-		break;
-	case INTEL_PENTIUM_II:
-		opaque = CPU_INIT_CALL(pentium2);
-		set_device_name(_T("Pentium II CPU"));
-		break;
-	case INTEL_PENTIUM_III:
-		opaque = CPU_INIT_CALL(pentium3);
-		set_device_name(_T("Pentium III CPU"));
-		break;
-	case INTEL_PENTIUM_4:
-		opaque = CPU_INIT_CALL(pentium4);
-		set_device_name(_T("Pentium 4 CPU"));
-		break;
-	case CYRIX_MEDIA_GX:
-		opaque = CPU_INIT_CALL(mediagx);
-		set_device_name(_T("MediaGX CPU"));
-		break;
-	default:
-		opaque = CPU_INIT_CALL(i386);
-		set_device_name(_T("80386 CPU"));
-		break;
-	}
+	opaque = CPU_INIT_CALL(CPU_MODEL);
 	
 	i386_state *cpustate = (i386_state *)opaque;
 	cpustate->pic = d_pic;
@@ -336,24 +295,10 @@
 uint32_t I386::get_next_pc()
 {
 	i386_state *cpustate = (i386_state *)opaque;
-	uint32_t addr = cpustate->pc;
-	translate_address(cpustate, cpustate->CPL, TRANSLATE_FETCH, &addr, NULL);
-	return addr;
+	return cpustate->pc;
 }
 
 #ifdef USE_DEBUGGER
-uint32_t I386::get_eip()
-{
-	i386_state *cpustate = (i386_state *)opaque;
-	return cpustate->prev_eip;
-}
-
-uint32_t I386::get_next_eip()
-{
-	i386_state *cpustate = (i386_state *)opaque;
-	return cpustate->eip;
-}
-
 void I386::write_debug_data8(uint32_t addr, uint32_t data)
 {
 	int wait;
@@ -464,24 +409,6 @@
 		REG8(DL) = data;
 	} else if(_tcsicmp(reg, _T("DH")) == 0) {
 		REG8(DH) = data;
-	} else if(_tcsicmp(reg, _T("CF")) == 0) {
-		cpustate->CF = (data != 0);
-	} else if(_tcsicmp(reg, _T("PF")) == 0) {
-		cpustate->PF = (data != 0);
-	} else if(_tcsicmp(reg, _T("AF")) == 0) {
-		cpustate->AF = (data != 0);
-	} else if(_tcsicmp(reg, _T("ZF")) == 0) {
-		cpustate->ZF = (data != 0);
-	} else if(_tcsicmp(reg, _T("SF")) == 0) {
-		cpustate->SF = (data != 0);
-	} else if(_tcsicmp(reg, _T("TF")) == 0) {
-		cpustate->TF = (data != 0);
-	} else if(_tcsicmp(reg, _T("IF")) == 0) {
-		cpustate->IF = (data != 0);
-	} else if(_tcsicmp(reg, _T("DF")) == 0) {
-		cpustate->DF = (data != 0);
-	} else if(_tcsicmp(reg, _T("OF")) == 0) {
-		cpustate->OF = (data != 0);
 	} else {
 		return false;
 	}
@@ -525,24 +452,6 @@
 		return REG8(DL);
 	} else if(_tcsicmp(reg, _T("DH")) == 0) {
 		return REG8(DH);
-	} else if(_tcsicmp(reg, _T("CF")) == 0) {
-		return (cpustate->CF != 0);
-	} else if(_tcsicmp(reg, _T("PF")) == 0) {
-		return (cpustate->PF != 0);
-	} else if(_tcsicmp(reg, _T("AF")) == 0) {
-		return (cpustate->AF != 0);
-	} else if(_tcsicmp(reg, _T("ZF")) == 0) {
-		return (cpustate->ZF != 0);
-	} else if(_tcsicmp(reg, _T("SF")) == 0) {
-		return (cpustate->SF != 0);
-	} else if(_tcsicmp(reg, _T("TF")) == 0) {
-		return (cpustate->TF != 0);
-	} else if(_tcsicmp(reg, _T("IF")) == 0) {
-		return (cpustate->IF != 0);
-	} else if(_tcsicmp(reg, _T("DF")) == 0) {
-		return (cpustate->DF != 0);
-	} else if(_tcsicmp(reg, _T("OF")) == 0) {
-		return (cpustate->OF != 0);
 	}
 	return 0;
 }
@@ -564,23 +473,21 @@
 	return true;
 }
 
-int I386::debug_dasm(uint32_t pc, uint32_t eip, bool mode, _TCHAR *buffer, size_t buffer_len)
+int I386::debug_dasm(uint32_t pc, _TCHAR *buffer, size_t buffer_len)
 {
 	i386_state *cpustate = (i386_state *)opaque;
+	UINT64 eip = pc - cpustate->sreg[CS].base;
 	UINT8 oprom[16];
 	
 	for(int i = 0; i < 16; i++) {
 		int wait;
 		oprom[i] = d_mem->read_data8w((pc + i) & cpustate->a20_mask, &wait);
 	}
-	return i386_dasm(oprom, eip, mode, buffer, buffer_len);
-}
-
-int I386::debug_dasm(uint32_t pc, uint32_t eip, _TCHAR *buffer, size_t buffer_len)
-{
-	i386_state *cpustate = (i386_state *)opaque;
-	
-	return debug_dasm(pc, eip, (cpustate->operand_size != 0),  buffer, buffer_len);
+	if(cpustate->operand_size) {
+		return i386_dasm(oprom, eip, true,  buffer, buffer_len);
+	} else {
+		return i386_dasm(oprom, eip, false, buffer, buffer_len);
+	}
 }
 #endif
 
diff -ruN source/src/vm/i386.h src/vm/i386.h
--- source/src/vm/i386.h	2025-04-28 16:00:00
+++ src/vm/i386.h	2025-04-28 22:36:36
@@ -17,19 +17,6 @@
 
 #define SIG_I386_A20	1
 
-enum {
-	DEFAULT = -1,
-	INTEL_80386 = 0,
-	INTEL_I486DX,
-	INTEL_PENTIUM,
-	INTEL_MMX_PENTIUM,
-	INTEL_PENTIUM_PRO,
-	INTEL_PENTIUM_II,
-	INTEL_PENTIUM_III,
-	INTEL_PENTIUM_4,
-	CYRIX_MEDIA_GX,
-};
-
 #ifdef USE_DEBUGGER
 class DEBUGGER;
 #endif
@@ -58,7 +45,25 @@
 #ifdef SINGLE_MODE_DMA
 		d_dma = NULL;
 #endif
-		device_model = DEFAULT;
+#if defined(HAS_I386)
+		set_device_name(_T("80386 CPU"));
+#elif defined(HAS_I486)
+		set_device_name(_T("80486 CPU"));
+#elif defined(HAS_PENTIUM)
+		set_device_name(_T("Pentium CPU"));
+#elif defined(HAS_MEDIAGX)
+		set_device_name(_T("Media GX CPU"));
+#elif defined(HAS_PENTIUM_PRO)
+		set_device_name(_T("Pentium Pro CPU"));
+#elif defined(HAS_PENTIUM_MMX)
+		set_device_name(_T("Pentium MMX CPU"));
+#elif defined(HAS_PENTIUM2)
+		set_device_name(_T("Pentium2 CPU"));
+#elif defined(HAS_PENTIUM3)
+		set_device_name(_T("Pentium3 CPU"));
+#elif defined(HAS_PENTIUM4)
+		set_device_name(_T("Pentium4 CPU"));
+#endif
 	}
 	~I386() {}
 	
@@ -109,10 +114,7 @@
 	bool write_debug_reg(const _TCHAR *reg, uint32_t data);
 	uint32_t read_debug_reg(const _TCHAR *reg);
 	bool get_debug_regs_info(_TCHAR *buffer, size_t buffer_len);
-	int debug_dasm(uint32_t pc, uint32_t eip, bool mode, _TCHAR *buffer, size_t buffer_len);
-	int debug_dasm(uint32_t pc, uint32_t eip, _TCHAR *buffer, size_t buffer_len);
-	uint32_t get_eip();
-	uint32_t get_next_eip();
+	int debug_dasm(uint32_t pc, _TCHAR *buffer, size_t buffer_len);
 #endif
 	bool process_state(FILEIO* state_fio, bool loading);
 	
@@ -151,7 +153,6 @@
 	uint32_t get_address_mask();
 	void set_shutdown_flag(int shutdown);
 	int get_shutdown_flag();
-	int device_model;
 };
 
 #endif
diff -ruN source/src/vm/i386_dasm.cpp src/vm/i386_dasm.cpp
--- source/src/vm/i386_dasm.cpp	2025-04-28 16:00:00
+++ src/vm/i386_dasm.cpp	2025-04-28 22:36:36
@@ -9,7 +9,6 @@
 */
 
 #include "i386_dasm.h"
-#include "debugger.h"
 
 #if defined(_MSC_VER) && (_MSC_VER >= 1400)
 #pragma warning( disable : 4146 )
@@ -57,281 +56,4 @@
 	} else {
 		return CPU_DISASSEMBLE_CALL(x86_16) & DASMFLAG_LENGTHMASK;
 	}
-}
-
-int v30_dasm(DEBUGGER *debugger, uint8_t *oprom, uint32_t eip, bool emulation_mode, _TCHAR *buffer, size_t buffer_len)
-{
-	if(!emulation_mode) {
-		return CPU_DISASSEMBLE_CALL(nec_generic) & DASMFLAG_LENGTHMASK;
-	}
-	int ptr = 0;
-	
-	switch(oprom[ptr++]) {
-		case 0x00: my_stprintf_s(buffer, buffer_len, _T("nop")); break;
-		case 0x01: my_stprintf_s(buffer, buffer_len, _T("lxi  b,%s"), get_value_or_symbol(debugger->first_symbol, _T("$%04x"), oprom[ptr] | (oprom[ptr + 1] << 8))); ptr += 2; break;
-		case 0x02: my_stprintf_s(buffer, buffer_len, _T("stax b")); break;
-		case 0x03: my_stprintf_s(buffer, buffer_len, _T("inx  b")); break;
-		case 0x04: my_stprintf_s(buffer, buffer_len, _T("inr  b")); break;
-		case 0x05: my_stprintf_s(buffer, buffer_len, _T("dcr  b")); break;
-		case 0x06: my_stprintf_s(buffer, buffer_len, _T("mvi  b,$%02x"), oprom[ptr++]); break;
-		case 0x07: my_stprintf_s(buffer, buffer_len, _T("rlc")); break;
-		case 0x08: my_stprintf_s(buffer, buffer_len, _T("nop")); break;
-		case 0x09: my_stprintf_s(buffer, buffer_len, _T("dad  b")); break;
-		case 0x0a: my_stprintf_s(buffer, buffer_len, _T("ldax b")); break;
-		case 0x0b: my_stprintf_s(buffer, buffer_len, _T("dcx  b")); break;
-		case 0x0c: my_stprintf_s(buffer, buffer_len, _T("inr  c")); break;
-		case 0x0d: my_stprintf_s(buffer, buffer_len, _T("dcr  c")); break;
-		case 0x0e: my_stprintf_s(buffer, buffer_len, _T("mvi  c,$%02x"), oprom[ptr++]); break;
-		case 0x0f: my_stprintf_s(buffer, buffer_len, _T("rrc")); break;
-		case 0x10: my_stprintf_s(buffer, buffer_len, _T("nop")); break;
-		case 0x11: my_stprintf_s(buffer, buffer_len, _T("lxi  d,%s"), get_value_or_symbol(debugger->first_symbol, _T("$%04x"), oprom[ptr] | (oprom[ptr + 1] << 8))); ptr += 2; break;
-		case 0x12: my_stprintf_s(buffer, buffer_len, _T("stax d")); break;
-		case 0x13: my_stprintf_s(buffer, buffer_len, _T("inx  d")); break;
-		case 0x14: my_stprintf_s(buffer, buffer_len, _T("inr  d")); break;
-		case 0x15: my_stprintf_s(buffer, buffer_len, _T("dcr  d")); break;
-		case 0x16: my_stprintf_s(buffer, buffer_len, _T("mvi  d,$%02x"), oprom[ptr++]); break;
-		case 0x17: my_stprintf_s(buffer, buffer_len, _T("ral")); break;
-		case 0x18: my_stprintf_s(buffer, buffer_len, _T("nop")); break;
-		case 0x19: my_stprintf_s(buffer, buffer_len, _T("dad  d")); break;
-		case 0x1a: my_stprintf_s(buffer, buffer_len, _T("ldax d")); break;
-		case 0x1b: my_stprintf_s(buffer, buffer_len, _T("dcx  d")); break;
-		case 0x1c: my_stprintf_s(buffer, buffer_len, _T("inr  e")); break;
-		case 0x1d: my_stprintf_s(buffer, buffer_len, _T("dcr  e")); break;
-		case 0x1e: my_stprintf_s(buffer, buffer_len, _T("mvi  e,$%02x"), oprom[ptr++]); break;
-		case 0x1f: my_stprintf_s(buffer, buffer_len, _T("rar")); break;
-		case 0x20: my_stprintf_s(buffer, buffer_len, _T("rim")); break;
-		case 0x21: my_stprintf_s(buffer, buffer_len, _T("lxi  h,%s"), get_value_or_symbol(debugger->first_symbol, _T("$%04x"), oprom[ptr] | (oprom[ptr + 1] << 8))); ptr += 2; break;
-		case 0x22: my_stprintf_s(buffer, buffer_len, _T("shld %s"), get_value_or_symbol(debugger->first_symbol, _T("$%04x"), oprom[ptr] | (oprom[ptr + 1] << 8))); ptr += 2; break;
-		case 0x23: my_stprintf_s(buffer, buffer_len, _T("inx  h")); break;
-		case 0x24: my_stprintf_s(buffer, buffer_len, _T("inr  h")); break;
-		case 0x25: my_stprintf_s(buffer, buffer_len, _T("dcr  h")); break;
-		case 0x26: my_stprintf_s(buffer, buffer_len, _T("mvi  h,$%02x"), oprom[ptr++]); break;
-		case 0x27: my_stprintf_s(buffer, buffer_len, _T("daa")); break;
-		case 0x28: my_stprintf_s(buffer, buffer_len, _T("nop")); break;
-		case 0x29: my_stprintf_s(buffer, buffer_len, _T("dad  h")); break;
-		case 0x2a: my_stprintf_s(buffer, buffer_len, _T("lhld %s"), get_value_or_symbol(debugger->first_symbol, _T("$%04x"), oprom[ptr] | (oprom[ptr + 1] << 8))); ptr += 2; break;
-		case 0x2b: my_stprintf_s(buffer, buffer_len, _T("dcx  h")); break;
-		case 0x2c: my_stprintf_s(buffer, buffer_len, _T("inr  l")); break;
-		case 0x2d: my_stprintf_s(buffer, buffer_len, _T("dcr  l")); break;
-		case 0x2e: my_stprintf_s(buffer, buffer_len, _T("mvi  l,$%02x"), oprom[ptr++]); break;
-		case 0x2f: my_stprintf_s(buffer, buffer_len, _T("cma")); break;
-		case 0x30: my_stprintf_s(buffer, buffer_len, _T("sim")); break;
-		case 0x31: my_stprintf_s(buffer, buffer_len, _T("lxi  sp,%s"), get_value_or_symbol(debugger->first_symbol, _T("$%04x"), oprom[ptr] | (oprom[ptr + 1] << 8))); ptr += 2; break;
-		case 0x32: my_stprintf_s(buffer, buffer_len, _T("stax %s"), get_value_or_symbol(debugger->first_symbol, _T("$%04x"), oprom[ptr] | (oprom[ptr + 1] << 8))); ptr += 2; break;
-		case 0x33: my_stprintf_s(buffer, buffer_len, _T("inx  sp")); break;
-		case 0x34: my_stprintf_s(buffer, buffer_len, _T("inr  m")); break;
-		case 0x35: my_stprintf_s(buffer, buffer_len, _T("dcr  m")); break;
-		case 0x36: my_stprintf_s(buffer, buffer_len, _T("mvi  m,$%02x"), oprom[ptr++]); break;
-		case 0x37: my_stprintf_s(buffer, buffer_len, _T("stc")); break;
-		case 0x38: my_stprintf_s(buffer, buffer_len, _T("ldes $%02x"), oprom[ptr++]); break;
-		case 0x39: my_stprintf_s(buffer, buffer_len, _T("dad sp")); break;
-		case 0x3a: my_stprintf_s(buffer, buffer_len, _T("ldax %s"), get_value_or_symbol(debugger->first_symbol, _T("$%04x"), oprom[ptr] | (oprom[ptr + 1] << 8))); ptr += 2; break;
-		case 0x3b: my_stprintf_s(buffer, buffer_len, _T("dcx  sp")); break;
-		case 0x3c: my_stprintf_s(buffer, buffer_len, _T("inr  a")); break;
-		case 0x3d: my_stprintf_s(buffer, buffer_len, _T("dcr  a")); break;
-		case 0x3e: my_stprintf_s(buffer, buffer_len, _T("mvi  a,$%02x"), oprom[ptr++]); break;
-		case 0x3f: my_stprintf_s(buffer, buffer_len, _T("cmf")); break;
-		case 0x40: my_stprintf_s(buffer, buffer_len, _T("mov  b,b")); break;
-		case 0x41: my_stprintf_s(buffer, buffer_len, _T("mov  b,c")); break;
-		case 0x42: my_stprintf_s(buffer, buffer_len, _T("mov  b,d")); break;
-		case 0x43: my_stprintf_s(buffer, buffer_len, _T("mov  b,e")); break;
-		case 0x44: my_stprintf_s(buffer, buffer_len, _T("mov  b,h")); break;
-		case 0x45: my_stprintf_s(buffer, buffer_len, _T("mov  b,l")); break;
-		case 0x46: my_stprintf_s(buffer, buffer_len, _T("mov  b,m")); break;
-		case 0x47: my_stprintf_s(buffer, buffer_len, _T("mov  b,a")); break;
-		case 0x48: my_stprintf_s(buffer, buffer_len, _T("mov  c,b")); break;
-		case 0x49: my_stprintf_s(buffer, buffer_len, _T("mov  c,c")); break;
-		case 0x4a: my_stprintf_s(buffer, buffer_len, _T("mov  c,d")); break;
-		case 0x4b: my_stprintf_s(buffer, buffer_len, _T("mov  c,e")); break;
-		case 0x4c: my_stprintf_s(buffer, buffer_len, _T("mov  c,h")); break;
-		case 0x4d: my_stprintf_s(buffer, buffer_len, _T("mov  c,l")); break;
-		case 0x4e: my_stprintf_s(buffer, buffer_len, _T("mov  c,m")); break;
-		case 0x4f: my_stprintf_s(buffer, buffer_len, _T("mov  c,a")); break;
-		case 0x50: my_stprintf_s(buffer, buffer_len, _T("mov  d,b")); break;
-		case 0x51: my_stprintf_s(buffer, buffer_len, _T("mov  d,c")); break;
-		case 0x52: my_stprintf_s(buffer, buffer_len, _T("mov  d,d")); break;
-		case 0x53: my_stprintf_s(buffer, buffer_len, _T("mov  d,e")); break;
-		case 0x54: my_stprintf_s(buffer, buffer_len, _T("mov  d,h")); break;
-		case 0x55: my_stprintf_s(buffer, buffer_len, _T("mov  d,l")); break;
-		case 0x56: my_stprintf_s(buffer, buffer_len, _T("mov  d,m")); break;
-		case 0x57: my_stprintf_s(buffer, buffer_len, _T("mov  d,a")); break;
-		case 0x58: my_stprintf_s(buffer, buffer_len, _T("mov  e,b")); break;
-		case 0x59: my_stprintf_s(buffer, buffer_len, _T("mov  e,c")); break;
-		case 0x5a: my_stprintf_s(buffer, buffer_len, _T("mov  e,d")); break;
-		case 0x5b: my_stprintf_s(buffer, buffer_len, _T("mov  e,e")); break;
-		case 0x5c: my_stprintf_s(buffer, buffer_len, _T("mov  e,h")); break;
-		case 0x5d: my_stprintf_s(buffer, buffer_len, _T("mov  e,l")); break;
-		case 0x5e: my_stprintf_s(buffer, buffer_len, _T("mov  e,m")); break;
-		case 0x5f: my_stprintf_s(buffer, buffer_len, _T("mov  e,a")); break;
-		case 0x60: my_stprintf_s(buffer, buffer_len, _T("mov  h,b")); break;
-		case 0x61: my_stprintf_s(buffer, buffer_len, _T("mov  h,c")); break;
-		case 0x62: my_stprintf_s(buffer, buffer_len, _T("mov  h,d")); break;
-		case 0x63: my_stprintf_s(buffer, buffer_len, _T("mov  h,e")); break;
-		case 0x64: my_stprintf_s(buffer, buffer_len, _T("mov  h,h")); break;
-		case 0x65: my_stprintf_s(buffer, buffer_len, _T("mov  h,l")); break;
-		case 0x66: my_stprintf_s(buffer, buffer_len, _T("mov  h,m")); break;
-		case 0x67: my_stprintf_s(buffer, buffer_len, _T("mov  h,a")); break;
-		case 0x68: my_stprintf_s(buffer, buffer_len, _T("mov  l,b")); break;
-		case 0x69: my_stprintf_s(buffer, buffer_len, _T("mov  l,c")); break;
-		case 0x6a: my_stprintf_s(buffer, buffer_len, _T("mov  l,d")); break;
-		case 0x6b: my_stprintf_s(buffer, buffer_len, _T("mov  l,e")); break;
-		case 0x6c: my_stprintf_s(buffer, buffer_len, _T("mov  l,h")); break;
-		case 0x6d: my_stprintf_s(buffer, buffer_len, _T("mov  l,l")); break;
-		case 0x6e: my_stprintf_s(buffer, buffer_len, _T("mov  l,m")); break;
-		case 0x6f: my_stprintf_s(buffer, buffer_len, _T("mov  l,a")); break;
-		case 0x70: my_stprintf_s(buffer, buffer_len, _T("mov  m,b")); break;
-		case 0x71: my_stprintf_s(buffer, buffer_len, _T("mov  m,c")); break;
-		case 0x72: my_stprintf_s(buffer, buffer_len, _T("mov  m,d")); break;
-		case 0x73: my_stprintf_s(buffer, buffer_len, _T("mov  m,e")); break;
-		case 0x74: my_stprintf_s(buffer, buffer_len, _T("mov  m,h")); break;
-		case 0x75: my_stprintf_s(buffer, buffer_len, _T("mov  m,l")); break;
-		case 0x76: my_stprintf_s(buffer, buffer_len, _T("hlt")); break;
-		case 0x77: my_stprintf_s(buffer, buffer_len, _T("mov  m,a")); break;
-		case 0x78: my_stprintf_s(buffer, buffer_len, _T("mov  a,b")); break;
-		case 0x79: my_stprintf_s(buffer, buffer_len, _T("mov  a,c")); break;
-		case 0x7a: my_stprintf_s(buffer, buffer_len, _T("mov  a,d")); break;
-		case 0x7b: my_stprintf_s(buffer, buffer_len, _T("mov  a,e")); break;
-		case 0x7c: my_stprintf_s(buffer, buffer_len, _T("mov  a,h")); break;
-		case 0x7d: my_stprintf_s(buffer, buffer_len, _T("mov  a,l")); break;
-		case 0x7e: my_stprintf_s(buffer, buffer_len, _T("mov  a,m")); break;
-		case 0x7f: my_stprintf_s(buffer, buffer_len, _T("mov  a,a")); break;
-		case 0x80: my_stprintf_s(buffer, buffer_len, _T("add  b")); break;
-		case 0x81: my_stprintf_s(buffer, buffer_len, _T("add  c")); break;
-		case 0x82: my_stprintf_s(buffer, buffer_len, _T("add  d")); break;
-		case 0x83: my_stprintf_s(buffer, buffer_len, _T("add  e")); break;
-		case 0x84: my_stprintf_s(buffer, buffer_len, _T("add  h")); break;
-		case 0x85: my_stprintf_s(buffer, buffer_len, _T("add  l")); break;
-		case 0x86: my_stprintf_s(buffer, buffer_len, _T("add  m")); break;
-		case 0x87: my_stprintf_s(buffer, buffer_len, _T("add  a")); break;
-		case 0x88: my_stprintf_s(buffer, buffer_len, _T("adc  b")); break;
-		case 0x89: my_stprintf_s(buffer, buffer_len, _T("adc  c")); break;
-		case 0x8a: my_stprintf_s(buffer, buffer_len, _T("adc  d")); break;
-		case 0x8b: my_stprintf_s(buffer, buffer_len, _T("adc  e")); break;
-		case 0x8c: my_stprintf_s(buffer, buffer_len, _T("adc  h")); break;
-		case 0x8d: my_stprintf_s(buffer, buffer_len, _T("adc  l")); break;
-		case 0x8e: my_stprintf_s(buffer, buffer_len, _T("adc  m")); break;
-		case 0x8f: my_stprintf_s(buffer, buffer_len, _T("adc  a")); break;
-		case 0x90: my_stprintf_s(buffer, buffer_len, _T("sub  b")); break;
-		case 0x91: my_stprintf_s(buffer, buffer_len, _T("sub  c")); break;
-		case 0x92: my_stprintf_s(buffer, buffer_len, _T("sub  d")); break;
-		case 0x93: my_stprintf_s(buffer, buffer_len, _T("sub  e")); break;
-		case 0x94: my_stprintf_s(buffer, buffer_len, _T("sub  h")); break;
-		case 0x95: my_stprintf_s(buffer, buffer_len, _T("sub  l")); break;
-		case 0x96: my_stprintf_s(buffer, buffer_len, _T("sub  m")); break;
-		case 0x97: my_stprintf_s(buffer, buffer_len, _T("sub  a")); break;
-		case 0x98: my_stprintf_s(buffer, buffer_len, _T("sbb  b")); break;
-		case 0x99: my_stprintf_s(buffer, buffer_len, _T("sbb  c")); break;
-		case 0x9a: my_stprintf_s(buffer, buffer_len, _T("sbb  d")); break;
-		case 0x9b: my_stprintf_s(buffer, buffer_len, _T("sbb  e")); break;
-		case 0x9c: my_stprintf_s(buffer, buffer_len, _T("sbb  h")); break;
-		case 0x9d: my_stprintf_s(buffer, buffer_len, _T("sbb  l")); break;
-		case 0x9e: my_stprintf_s(buffer, buffer_len, _T("sbb  m")); break;
-		case 0x9f: my_stprintf_s(buffer, buffer_len, _T("sbb  a")); break;
-		case 0xa0: my_stprintf_s(buffer, buffer_len, _T("ana  b")); break;
-		case 0xa1: my_stprintf_s(buffer, buffer_len, _T("ana  c")); break;
-		case 0xa2: my_stprintf_s(buffer, buffer_len, _T("ana  d")); break;
-		case 0xa3: my_stprintf_s(buffer, buffer_len, _T("ana  e")); break;
-		case 0xa4: my_stprintf_s(buffer, buffer_len, _T("ana  h")); break;
-		case 0xa5: my_stprintf_s(buffer, buffer_len, _T("ana  l")); break;
-		case 0xa6: my_stprintf_s(buffer, buffer_len, _T("ana  m")); break;
-		case 0xa7: my_stprintf_s(buffer, buffer_len, _T("ana  a")); break;
-		case 0xa8: my_stprintf_s(buffer, buffer_len, _T("xra  b")); break;
-		case 0xa9: my_stprintf_s(buffer, buffer_len, _T("xra  c")); break;
-		case 0xaa: my_stprintf_s(buffer, buffer_len, _T("xra  d")); break;
-		case 0xab: my_stprintf_s(buffer, buffer_len, _T("xra  e")); break;
-		case 0xac: my_stprintf_s(buffer, buffer_len, _T("xra  h")); break;
-		case 0xad: my_stprintf_s(buffer, buffer_len, _T("xra  l")); break;
-		case 0xae: my_stprintf_s(buffer, buffer_len, _T("xra  m")); break;
-		case 0xaf: my_stprintf_s(buffer, buffer_len, _T("xra  a")); break;
-		case 0xb0: my_stprintf_s(buffer, buffer_len, _T("ora  b")); break;
-		case 0xb1: my_stprintf_s(buffer, buffer_len, _T("ora  c")); break;
-		case 0xb2: my_stprintf_s(buffer, buffer_len, _T("ora  d")); break;
-		case 0xb3: my_stprintf_s(buffer, buffer_len, _T("ora  e")); break;
-		case 0xb4: my_stprintf_s(buffer, buffer_len, _T("ora  h")); break;
-		case 0xb5: my_stprintf_s(buffer, buffer_len, _T("ora  l")); break;
-		case 0xb6: my_stprintf_s(buffer, buffer_len, _T("ora  m")); break;
-		case 0xb7: my_stprintf_s(buffer, buffer_len, _T("ora  a")); break;
-		case 0xb8: my_stprintf_s(buffer, buffer_len, _T("cmp  b")); break;
-		case 0xb9: my_stprintf_s(buffer, buffer_len, _T("cmp  c")); break;
-		case 0xba: my_stprintf_s(buffer, buffer_len, _T("cmp  d")); break;
-		case 0xbb: my_stprintf_s(buffer, buffer_len, _T("cmp  e")); break;
-		case 0xbc: my_stprintf_s(buffer, buffer_len, _T("cmp  h")); break;
-		case 0xbd: my_stprintf_s(buffer, buffer_len, _T("cmp  l")); break;
-		case 0xbe: my_stprintf_s(buffer, buffer_len, _T("cmp  m")); break;
-		case 0xbf: my_stprintf_s(buffer, buffer_len, _T("cmp  a")); break;
-		case 0xc0: my_stprintf_s(buffer, buffer_len, _T("rnz")); break;
-		case 0xc1: my_stprintf_s(buffer, buffer_len, _T("pop  b")); break;
-		case 0xc2: my_stprintf_s(buffer, buffer_len, _T("jnz  %s"), get_value_or_symbol(debugger->first_symbol, _T("$%04x"), oprom[ptr] | (oprom[ptr + 1] << 8))); ptr += 2; break;
-		case 0xc3: my_stprintf_s(buffer, buffer_len, _T("jmp  %s"), get_value_or_symbol(debugger->first_symbol, _T("$%04x"), oprom[ptr] | (oprom[ptr + 1] << 8))); ptr += 2; break;
-		case 0xc4: my_stprintf_s(buffer, buffer_len, _T("cnz  %s"), get_value_or_symbol(debugger->first_symbol, _T("$%04x"), oprom[ptr] | (oprom[ptr + 1] << 8))); ptr += 2; break;
-		case 0xc5: my_stprintf_s(buffer, buffer_len, _T("push b")); break;
-		case 0xc6: my_stprintf_s(buffer, buffer_len, _T("adi  $%02x"), oprom[ptr++]); break;
-		case 0xc7: my_stprintf_s(buffer, buffer_len, _T("rst  0")); break;
-		case 0xc8: my_stprintf_s(buffer, buffer_len, _T("rz")); break;
-		case 0xc9: my_stprintf_s(buffer, buffer_len, _T("ret")); break;
-		case 0xca: my_stprintf_s(buffer, buffer_len, _T("jz   %s"), get_value_or_symbol(debugger->first_symbol, _T("$%04x"), oprom[ptr] | (oprom[ptr + 1] << 8))); ptr += 2; break;
-		case 0xcb: my_stprintf_s(buffer, buffer_len, _T("jmp  %s"), get_value_or_symbol(debugger->first_symbol, _T("$%04x"), oprom[ptr] | (oprom[ptr + 1] << 8))); ptr += 2; break;
-		case 0xcc: my_stprintf_s(buffer, buffer_len, _T("cz   %s"), get_value_or_symbol(debugger->first_symbol, _T("$%04x"), oprom[ptr] | (oprom[ptr + 1] << 8))); ptr += 2; break;
-		case 0xcd: my_stprintf_s(buffer, buffer_len, _T("call %s"), get_value_or_symbol(debugger->first_symbol, _T("$%04x"), oprom[ptr] | (oprom[ptr + 1] << 8))); ptr += 2; break;
-		case 0xce: my_stprintf_s(buffer, buffer_len, _T("aci  $%02x"), oprom[ptr++]); break;
-		case 0xcf: my_stprintf_s(buffer, buffer_len, _T("rst  1")); break;
-		case 0xd0: my_stprintf_s(buffer, buffer_len, _T("rnc")); break;
-		case 0xd1: my_stprintf_s(buffer, buffer_len, _T("pop  d")); break;
-		case 0xd2: my_stprintf_s(buffer, buffer_len, _T("jnc  %s"), get_value_or_symbol(debugger->first_symbol, _T("$%04x"), oprom[ptr] | (oprom[ptr + 1] << 8))); ptr += 2; break;
-		case 0xd3: my_stprintf_s(buffer, buffer_len, _T("out  $%02x"), oprom[ptr++]); break;
-		case 0xd4: my_stprintf_s(buffer, buffer_len, _T("cnc  %s"), get_value_or_symbol(debugger->first_symbol, _T("$%04x"), oprom[ptr] | (oprom[ptr + 1] << 8))); ptr += 2; break;
-		case 0xd5: my_stprintf_s(buffer, buffer_len, _T("push d")); break;
-		case 0xd6: my_stprintf_s(buffer, buffer_len, _T("sui  $%02x"), oprom[ptr++]); break;
-		case 0xd7: my_stprintf_s(buffer, buffer_len, _T("rst  2")); break;
-		case 0xd8: my_stprintf_s(buffer, buffer_len, _T("rc")); break;
-		case 0xd9: my_stprintf_s(buffer, buffer_len, _T("ret")); break;
-		case 0xda: my_stprintf_s(buffer, buffer_len, _T("jc   %s"), get_value_or_symbol(debugger->first_symbol, _T("$%04x"), oprom[ptr] | (oprom[ptr + 1] << 8))); ptr += 2; break;
-		case 0xdb: my_stprintf_s(buffer, buffer_len, _T("in   $%02x"), oprom[ptr++]); break;
-		case 0xdc: my_stprintf_s(buffer, buffer_len, _T("cc   %s"), get_value_or_symbol(debugger->first_symbol, _T("$%04x"), oprom[ptr] | (oprom[ptr + 1] << 8))); ptr += 2; break;
-		case 0xdd: my_stprintf_s(buffer, buffer_len, _T("call %s"), get_value_or_symbol(debugger->first_symbol, _T("$%04x"), oprom[ptr] | (oprom[ptr + 1] << 8))); ptr += 2; break;
-		case 0xde: my_stprintf_s(buffer, buffer_len, _T("sbi  $%02x"), oprom[ptr++]); break;
-		case 0xdf: my_stprintf_s(buffer, buffer_len, _T("rst  3")); break;
-		case 0xe0: my_stprintf_s(buffer, buffer_len, _T("rpo")); break;
-		case 0xe1: my_stprintf_s(buffer, buffer_len, _T("pop  h")); break;
-		case 0xe2: my_stprintf_s(buffer, buffer_len, _T("jpo  %s"), get_value_or_symbol(debugger->first_symbol, _T("$%04x"), oprom[ptr] | (oprom[ptr + 1] << 8))); ptr += 2; break;
-		case 0xe3: my_stprintf_s(buffer, buffer_len, _T("xthl")); break;
-		case 0xe4: my_stprintf_s(buffer, buffer_len, _T("cpo  %s"), get_value_or_symbol(debugger->first_symbol, _T("$%04x"), oprom[ptr] | (oprom[ptr + 1] << 8))); ptr += 2; break;
-		case 0xe5: my_stprintf_s(buffer, buffer_len, _T("push h")); break;
-		case 0xe6: my_stprintf_s(buffer, buffer_len, _T("ani  $%02x"), oprom[ptr++]); break;
-		case 0xe7: my_stprintf_s(buffer, buffer_len, _T("rst  4")); break;
-		case 0xe8: my_stprintf_s(buffer, buffer_len, _T("rpe")); break;
-		case 0xe9: my_stprintf_s(buffer, buffer_len, _T("PChl")); break;
-		case 0xea: my_stprintf_s(buffer, buffer_len, _T("jpe  %s"), get_value_or_symbol(debugger->first_symbol, _T("$%04x"), oprom[ptr] | (oprom[ptr + 1] << 8))); ptr += 2; break;
-		case 0xeb: my_stprintf_s(buffer, buffer_len, _T("xchg")); break;
-		case 0xec: my_stprintf_s(buffer, buffer_len, _T("cpe  %s"), get_value_or_symbol(debugger->first_symbol, _T("$%04x"), oprom[ptr] | (oprom[ptr + 1] << 8))); ptr += 2; break;
-		case 0xed: 
-			if(oprom[ptr] == 0xed) {
-				my_stprintf_s(buffer, buffer_len, _T("calln $%02x"), oprom[ptr + 1]);
-			} else if(oprom[ptr] == 0xfd) {
-				my_stprintf_s(buffer, buffer_len, _T("retem"));
-			} else {
-				my_stprintf_s(buffer, buffer_len, _T("call %s"), get_value_or_symbol(debugger->first_symbol, _T("$%04x"), oprom[ptr] | (oprom[ptr + 1] << 8)));
-			}
-			 ptr += 2;
-			 break;
-		case 0xee: my_stprintf_s(buffer, buffer_len, _T("xri  $%02x"), oprom[ptr++]); break;
-		case 0xef: my_stprintf_s(buffer, buffer_len, _T("rst  5")); break;
-		case 0xf0: my_stprintf_s(buffer, buffer_len, _T("rp")); break;
-		case 0xf1: my_stprintf_s(buffer, buffer_len, _T("pop  a")); break;
-		case 0xf2: my_stprintf_s(buffer, buffer_len, _T("jp   %s"), get_value_or_symbol(debugger->first_symbol, _T("$%04x"), oprom[ptr] | (oprom[ptr + 1] << 8))); ptr += 2; break;
-		case 0xf3: my_stprintf_s(buffer, buffer_len, _T("di")); break;
-		case 0xf4: my_stprintf_s(buffer, buffer_len, _T("cp   %s"), get_value_or_symbol(debugger->first_symbol, _T("$%04x"), oprom[ptr] | (oprom[ptr + 1] << 8))); ptr += 2; break;
-		case 0xf5: my_stprintf_s(buffer, buffer_len, _T("push a")); break;
-		case 0xf6: my_stprintf_s(buffer, buffer_len, _T("ori  $%02x"), oprom[ptr++]); break;
-		case 0xf7: my_stprintf_s(buffer, buffer_len, _T("rst  6")); break;
-		case 0xf8: my_stprintf_s(buffer, buffer_len, _T("rm")); break;
-		case 0xf9: my_stprintf_s(buffer, buffer_len, _T("sphl")); break;
-		case 0xfa: my_stprintf_s(buffer, buffer_len, _T("jm   %s"), get_value_or_symbol(debugger->first_symbol, _T("$%04x"), oprom[ptr] | (oprom[ptr + 1] << 8))); ptr += 2; break;
-		case 0xfb: my_stprintf_s(buffer, buffer_len, _T("ei")); break;
-		case 0xfc: my_stprintf_s(buffer, buffer_len, _T("cm   %s"), get_value_or_symbol(debugger->first_symbol, _T("$%04x"), oprom[ptr] | (oprom[ptr + 1] << 8))); ptr += 2; break;
-		case 0xfd: my_stprintf_s(buffer, buffer_len, _T("cm   %s"), get_value_or_symbol(debugger->first_symbol, _T("$%04x"), oprom[ptr] | (oprom[ptr + 1] << 8))); ptr += 2; break;
-		case 0xfe: my_stprintf_s(buffer, buffer_len, _T("cpi  $%02x"), oprom[ptr++]); break;
-		case 0xff: my_stprintf_s(buffer, buffer_len, _T("rst  7")); break;
-	}
-	return ptr;
 }
diff -ruN source/src/vm/i386_dasm.h src/vm/i386_dasm.h
--- source/src/vm/i386_dasm.h	2025-04-28 16:00:00
+++ src/vm/i386_dasm.h	2025-04-28 22:36:36
@@ -13,9 +13,6 @@
 
 #include "../common.h"
 
-class DEBUGGER;
-
 int i386_dasm(uint8_t *oprom, uint32_t eip, bool is_ia32, _TCHAR *buffer, size_t buffer_len);
-int v30_dasm(DEBUGGER *debugger, uint8_t *oprom, uint32_t eip, bool emulation_mode, _TCHAR *buffer, size_t buffer_len);
 
 #endif
diff -ruN source/src/vm/i386_np21.cpp src/vm/i386_np21.cpp
--- source/src/vm/i386_np21.cpp	2025-04-28 16:00:00
+++ src/vm/i386_np21.cpp	2025-04-28 22:36:36
@@ -539,60 +539,6 @@
 		CPU_DL = data;
 	} else if(_tcsicmp(reg, _T("DH")) == 0) {
 		CPU_DH = data;
-	} else if(_tcsicmp(reg, _T("CF")) == 0) {
-		if(data) {
-			CPU_FLAG |=  C_FLAG;
-		} else {
-			CPU_FLAG &= ~C_FLAG;
-		}
-	} else if(_tcsicmp(reg, _T("PF")) == 0) {
-		if(data) {
-			CPU_FLAG |=  P_FLAG;
-		} else {
-			CPU_FLAG &= ~P_FLAG;
-		}
-	} else if(_tcsicmp(reg, _T("AF")) == 0) {
-		if(data) {
-			CPU_FLAG |=  A_FLAG;
-		} else {
-			CPU_FLAG &= ~A_FLAG;
-		}
-	} else if(_tcsicmp(reg, _T("ZF")) == 0) {
-		if(data) {
-			CPU_FLAG |=  Z_FLAG;
-		} else {
-			CPU_FLAG &= ~Z_FLAG;
-		}
-	} else if(_tcsicmp(reg, _T("SF")) == 0) {
-		if(data) {
-			CPU_FLAG |=  S_FLAG;
-		} else {
-			CPU_FLAG &= ~S_FLAG;
-		}
-	} else if(_tcsicmp(reg, _T("TF")) == 0) {
-		if(data) {
-			CPU_FLAG |=  T_FLAG;
-		} else {
-			CPU_FLAG &= ~T_FLAG;
-		}
-	} else if(_tcsicmp(reg, _T("IF")) == 0) {
-		if(data) {
-			CPU_FLAG |=  I_FLAG;
-		} else {
-			CPU_FLAG &= ~I_FLAG;
-		}
-	} else if(_tcsicmp(reg, _T("DF")) == 0) {
-		if(data) {
-			CPU_FLAG |=  D_FLAG;
-		} else {
-			CPU_FLAG &= ~D_FLAG;
-		}
-	} else if(_tcsicmp(reg, _T("OF")) == 0) {
-		if(data) {
-			CPU_FLAG |=  O_FLAG;
-		} else {
-			CPU_FLAG &= ~O_FLAG;
-		}
 	} else {
 		return false;
 	}
@@ -653,24 +599,6 @@
 		return CPU_DL;
 	} else if(_tcsicmp(reg, _T("DH")) == 0) {
 		return CPU_DH;
-	} else if(_tcsicmp(reg, _T("CF")) == 0) {
-		return ((CPU_FLAG & C_FLAG) != 0);
-	} else if(_tcsicmp(reg, _T("PF")) == 0) {
-		return ((CPU_FLAG & P_FLAG) != 0);
-	} else if(_tcsicmp(reg, _T("AF")) == 0) {
-		return ((CPU_FLAG & A_FLAG) != 0);
-	} else if(_tcsicmp(reg, _T("ZF")) == 0) {
-		return ((CPU_FLAG & Z_FLAG) != 0);
-	} else if(_tcsicmp(reg, _T("SF")) == 0) {
-		return ((CPU_FLAG & S_FLAG) != 0);
-	} else if(_tcsicmp(reg, _T("TF")) == 0) {
-		return ((CPU_FLAG & T_FLAG) != 0);
-	} else if(_tcsicmp(reg, _T("IF")) == 0) {
-		return ((CPU_FLAG & I_FLAG) != 0);
-	} else if(_tcsicmp(reg, _T("DF")) == 0) {
-		return ((CPU_FLAG & D_FLAG) != 0);
-	} else if(_tcsicmp(reg, _T("OF")) == 0) {
-		return ((CPU_FLAG & O_FLAG) != 0);
 	}
 	return 0;
 }
@@ -705,20 +633,20 @@
 	return true;
 }
 
-int I386::debug_dasm(uint32_t pc, uint32_t eip, bool mode, _TCHAR *buffer, size_t buffer_len)
+int I386::debug_dasm(uint32_t pc, _TCHAR *buffer, size_t buffer_len)
 {
+	uint32_t eip = pc - (CPU_CS << 4);
 	uint8_t oprom[16];
 	
 	for(int i = 0; i < 16; i++) {
 		int wait;
 		oprom[i] = device_mem->read_data8w((pc + i) & CPU_ADRSMASK, &wait);
 	}
-	return i386_dasm(oprom, eip, mode, buffer, buffer_len);
-}
-
-int I386::debug_dasm(uint32_t pc, uint32_t eip, _TCHAR *buffer, size_t buffer_len)
-{
-	return debug_dasm(pc, eip, (CPU_INST_OP32 != 0), buffer, buffer_len);
+	if(CPU_INST_OP32) {
+		return i386_dasm(oprom, eip, true,  buffer, buffer_len);
+	} else {
+		return i386_dasm(oprom, eip, false, buffer, buffer_len);
+	}
 }
 #endif
 
diff -ruN source/src/vm/i386_np21.h src/vm/i386_np21.h
--- source/src/vm/i386_np21.h	2025-04-28 16:00:00
+++ src/vm/i386_np21.h	2025-04-28 22:36:36
@@ -115,8 +115,7 @@
 	bool write_debug_reg(const _TCHAR *reg, uint32_t data);
 	uint32_t read_debug_reg(const _TCHAR *reg);
 	bool get_debug_regs_info(_TCHAR *buffer, size_t buffer_len);
-	int debug_dasm(uint32_t pc, uint32_t eip, bool mode, _TCHAR *buffer, size_t buffer_len);
-	int debug_dasm(uint32_t pc, uint32_t eip, _TCHAR *buffer, size_t buffer_len);
+	int debug_dasm(uint32_t pc, _TCHAR *buffer, size_t buffer_len);
 #endif
 	bool process_state(FILEIO* state_fio, bool loading);
 	
diff -ruN source/src/vm/i86.cpp src/vm/i86.cpp
--- source/src/vm/i86.cpp	2025-04-28 16:00:00
+++ src/vm/i86.cpp	2025-04-28 22:36:36
@@ -12,6 +12,7 @@
 #ifdef USE_DEBUGGER
 #include "debugger.h"
 #include "i386_dasm.h"
+#include "v30_dasm.h"
 #endif
 
 /* ----------------------------------------------------------------------------
@@ -333,24 +334,6 @@
 		cpustate->regs.b[DL] = data;
 	} else if(_tcsicmp(reg, _T("DH")) == 0) {
 		cpustate->regs.b[DH] = data;
-	} else if(_tcsicmp(reg, _T("CF")) == 0) {
-		cpustate->CarryVal = (data != 0);
-	} else if(_tcsicmp(reg, _T("PF")) == 0) {
-		cpustate->ParityVal = (data != 0) ? 0 : 1;
-	} else if(_tcsicmp(reg, _T("AF")) == 0) {
-		cpustate->AuxVal = (data != 0);
-	} else if(_tcsicmp(reg, _T("ZF")) == 0) {
-		cpustate->ZeroVal = (data != 0) ? 0 : 1;
-	} else if(_tcsicmp(reg, _T("SF")) == 0) {
-		cpustate->SignVal = (data != 0) ? -1 : 0;
-	} else if(_tcsicmp(reg, _T("TF")) == 0) {
-		cpustate->TF = (data != 0);
-	} else if(_tcsicmp(reg, _T("IF")) == 0) {
-		cpustate->IF = (data != 0);
-	} else if(_tcsicmp(reg, _T("DF")) == 0) {
-		cpustate->DirVal = (data != 0) ? -1 : 0;
-	} else if(_tcsicmp(reg, _T("OF")) == 0) {
-		cpustate->OverVal = (data != 0);
 	} else {
 		return false;
 	}
@@ -394,24 +377,6 @@
 		return cpustate->regs.b[DL];
 	} else if(_tcsicmp(reg, _T("DH")) == 0) {
 		return cpustate->regs.b[DH];
-	} else if(_tcsicmp(reg, _T("CF")) == 0) {
-		return (cpustate->CarryVal != 0);
-	} else if(_tcsicmp(reg, _T("PF")) == 0) {
-		return (cpustate->ParityVal == 0);
-	} else if(_tcsicmp(reg, _T("AF")) == 0) {
-		return (cpustate->AuxVal != 0);
-	} else if(_tcsicmp(reg, _T("ZF")) == 0) {
-		return (cpustate->ZeroVal == 0);
-	} else if(_tcsicmp(reg, _T("SF")) == 0) {
-		return (cpustate->SignVal < 0);
-	} else if(_tcsicmp(reg, _T("TF")) == 0) {
-		return (cpustate->TF != 0);
-	} else if(_tcsicmp(reg, _T("IF")) == 0) {
-		return (cpustate->IF != 0);
-	} else if(_tcsicmp(reg, _T("DF")) == 0) {
-		return (cpustate->DirVal < 0);
-	} else if(_tcsicmp(reg, _T("OF")) == 0) {
-		return (cpustate->OverVal != 0);
 	}
 	return 0;
 }
@@ -433,7 +398,7 @@
 	return true;
 }
 
-int I86::debug_dasm(uint32_t pc, bool mode, _TCHAR *buffer, size_t buffer_len)
+int I86::debug_dasm(uint32_t pc, _TCHAR *buffer, size_t buffer_len)
 {
 	cpu_state *cpustate = (cpu_state *)opaque;
 	uint32_t eip = pc - cpustate->base[CS];
@@ -445,21 +410,9 @@
 	}
 	switch(device_model) {
 	case NEC_V30:
-		return v30_dasm(cpustate->debugger, oprom, eip, mode, buffer, buffer_len);
+		return v30_dasm(cpustate->debugger, oprom, eip, (cpustate->MF == 0), buffer, buffer_len);
 	default:
 		return i386_dasm(oprom, eip, false, buffer, buffer_len);
-	}
-}
-
-int I86::debug_dasm(uint32_t pc, _TCHAR *buffer, size_t buffer_len)
-{
-	cpu_state *cpustate = (cpu_state *)opaque;
-	
-	switch(device_model) {
-	case NEC_V30:
-		return debug_dasm(pc, (cpustate->MF == 0), buffer, buffer_len);
-	default:
-		return debug_dasm(pc, false, buffer, buffer_len);
 	}
 }
 #endif
diff -ruN source/src/vm/i86.h src/vm/i86.h
--- source/src/vm/i86.h	2025-04-28 16:00:00
+++ src/vm/i86.h	2025-04-28 22:36:36
@@ -98,7 +98,6 @@
 	bool write_debug_reg(const _TCHAR *reg, uint32_t data);
 	uint32_t read_debug_reg(const _TCHAR *reg);
 	bool get_debug_regs_info(_TCHAR *buffer, size_t buffer_len);
-	int debug_dasm(uint32_t pc, bool mode, _TCHAR *buffer, size_t buffer_len);
 	int debug_dasm(uint32_t pc, _TCHAR *buffer, size_t buffer_len);
 #endif
 	bool process_state(FILEIO* state_fio, bool loading);
diff -ruN source/src/vm/jx/i86.cpp src/vm/jx/i86.cpp
--- source/src/vm/jx/i86.cpp	2025-04-28 16:00:00
+++ src/vm/jx/i86.cpp	2025-04-28 22:36:36
@@ -12,6 +12,7 @@
 #ifdef USE_DEBUGGER
 #include "../debugger.h"
 #include "../i386_dasm.h"
+//#include "../v30_dasm.h"
 #endif
 
 /* ----------------------------------------------------------------------------
@@ -343,24 +344,6 @@
 		cpustate->regs.b[DL] = data;
 	} else if(_tcsicmp(reg, _T("DH")) == 0) {
 		cpustate->regs.b[DH] = data;
-	} else if(_tcsicmp(reg, _T("CF")) == 0) {
-		cpustate->CarryVal = (data != 0);
-	} else if(_tcsicmp(reg, _T("PF")) == 0) {
-		cpustate->ParityVal = (data != 0) ? 0 : 1;
-	} else if(_tcsicmp(reg, _T("AF")) == 0) {
-		cpustate->AuxVal = (data != 0);
-	} else if(_tcsicmp(reg, _T("ZF")) == 0) {
-		cpustate->ZeroVal = (data != 0) ? 0 : 1;
-	} else if(_tcsicmp(reg, _T("SF")) == 0) {
-		cpustate->SignVal = (data != 0) ? -1 : 0;
-	} else if(_tcsicmp(reg, _T("TF")) == 0) {
-		cpustate->TF = (data != 0);
-	} else if(_tcsicmp(reg, _T("IF")) == 0) {
-		cpustate->IF = (data != 0);
-	} else if(_tcsicmp(reg, _T("DF")) == 0) {
-		cpustate->DirVal = (data != 0) ? -1 : 0;
-	} else if(_tcsicmp(reg, _T("OF")) == 0) {
-		cpustate->OverVal = (data != 0);
 	} else {
 		return false;
 	}
@@ -404,24 +387,6 @@
 		return cpustate->regs.b[DL];
 	} else if(_tcsicmp(reg, _T("DH")) == 0) {
 		return cpustate->regs.b[DH];
-	} else if(_tcsicmp(reg, _T("CF")) == 0) {
-		return (cpustate->CarryVal != 0);
-	} else if(_tcsicmp(reg, _T("PF")) == 0) {
-		return (cpustate->ParityVal == 0);
-	} else if(_tcsicmp(reg, _T("AF")) == 0) {
-		return (cpustate->AuxVal != 0);
-	} else if(_tcsicmp(reg, _T("ZF")) == 0) {
-		return (cpustate->ZeroVal == 0);
-	} else if(_tcsicmp(reg, _T("SF")) == 0) {
-		return (cpustate->SignVal < 0);
-	} else if(_tcsicmp(reg, _T("TF")) == 0) {
-		return (cpustate->TF != 0);
-	} else if(_tcsicmp(reg, _T("IF")) == 0) {
-		return (cpustate->IF != 0);
-	} else if(_tcsicmp(reg, _T("DF")) == 0) {
-		return (cpustate->DirVal < 0);
-	} else if(_tcsicmp(reg, _T("OF")) == 0) {
-		return (cpustate->OverVal != 0);
 	}
 	return 0;
 }
diff -ruN source/src/vm/mame/emu/cpu/i386/i386.c src/vm/mame/emu/cpu/i386/i386.c
--- source/src/vm/mame/emu/cpu/i386/i386.c	2025-04-28 16:00:00
+++ src/vm/mame/emu/cpu/i386/i386.c	2025-04-28 22:36:36
@@ -158,8 +158,7 @@
 		{
 			cpustate->sreg[segment].base = cpustate->sreg[segment].selector << 4;
 			cpustate->sreg[segment].limit = 0xffff;
-//			cpustate->sreg[segment].flags = (segment == CS) ? 0x00fb : 0x00f3;
-			cpustate->sreg[segment].flags = 0x00f3;
+			cpustate->sreg[segment].flags = (segment == CS) ? 0x00fb : 0x00f3;
 			cpustate->sreg[segment].d = 0;
 			cpustate->sreg[segment].valid = true;
 		}
@@ -2116,9 +2115,9 @@
 			}
 		}
 		if(STACK_32BIT)
-			REG32(ESP) += (operand32 ? 8 : 4) + count;
+			REG16(SP) += (4+count);
 		else
-			REG16(SP) += (operand32 ? 8 : 4) + count;
+			REG32(ESP) += (8+count);
 	}
 	else if(RPL > CPL)
 	{
@@ -2806,7 +2805,6 @@
 }
 
 /* Forward declarations */
-static void I386OP(decode_first_opcode)(i386_state *cpustate, UINT32 address);
 static void I386OP(decode_opcode)(i386_state *cpustate);
 static void I386OP(decode_two_byte)(i386_state *cpustate);
 static void I386OP(decode_three_byte38)(i386_state *cpustate);
@@ -2830,29 +2828,12 @@
 #include "x87ops.c"
 #include "i386ops.h"
 
-static void I386OP(decode_first_opcode)(i386_state *cpustate, UINT32 address)
-{
-	cpustate->opcode = FETCH_FIRST_OP(cpustate, address);
-
-	if(cpustate->lock && !cpustate->lock_table[0][cpustate->opcode]) {
-		I386OP(invalid)(cpustate);
-		return;
-	}
-
-	if( cpustate->operand_size )
-		cpustate->opcode_table1_32[cpustate->opcode](cpustate);
-	else
-		cpustate->opcode_table1_16[cpustate->opcode](cpustate);
-}
-
 static void I386OP(decode_opcode)(i386_state *cpustate)
 {
 	cpustate->opcode = FETCH(cpustate);
 
-	if(cpustate->lock && !cpustate->lock_table[0][cpustate->opcode]) {
-		I386OP(invalid)(cpustate);
-		return;
-	}
+	if(cpustate->lock && !cpustate->lock_table[0][cpustate->opcode])
+		return I386OP(invalid)(cpustate);
 
 	if( cpustate->operand_size )
 		cpustate->opcode_table1_32[cpustate->opcode](cpustate);
@@ -2865,10 +2846,8 @@
 {
 	cpustate->opcode = FETCH(cpustate);
 
-	if(cpustate->lock && !cpustate->lock_table[1][cpustate->opcode]) {
-		I386OP(invalid)(cpustate);
-		return;
-	}
+	if(cpustate->lock && !cpustate->lock_table[1][cpustate->opcode])
+		return I386OP(invalid)(cpustate);
 
 	if( cpustate->operand_size )
 		cpustate->opcode_table2_32[cpustate->opcode](cpustate);
@@ -3145,7 +3124,6 @@
 	cpustate->eip = 0;
 	cpustate->pc = 0;
 	cpustate->prev_eip = 0;
-	cpustate->prev_pc = 0;
 	cpustate->eflags = 0;
 	cpustate->eflags_mask = 0;
 	cpustate->CF = 0;
@@ -3258,7 +3236,6 @@
 	// Family 3 (386), Model 0 (DX), Stepping 8 (D1)
 	REG32(EAX) = 0;
 	REG32(EDX) = (3 << 8) | (0 << 4) | (8);
-	cpustate->cpu_version = REG32(EDX);
 
 	cpustate->CPL = 0;
 
@@ -3455,48 +3432,100 @@
 	{
 #ifdef USE_DEBUGGER
 		bool now_debugging = cpustate->debugger->now_debugging;
-		int first_cycles = cpustate->cycles;
-#endif
-		i386_check_irq_line(cpustate);
-		cpustate->operand_size = cpustate->sreg[CS].d;
-		cpustate->xmm_operand_size = 0;
-		cpustate->address_size = cpustate->sreg[CS].d;
-		cpustate->operand_prefix = 0;
-		cpustate->address_prefix = 0;
+		if(now_debugging) {
+			cpustate->debugger->check_break_points(cpustate->pc);
+			if(cpustate->debugger->now_suspended) {
+				cpustate->debugger->now_waiting = true;
+				cpustate->emu->start_waiting_in_debugger();
+				while(cpustate->debugger->now_debugging && cpustate->debugger->now_suspended) {
+					cpustate->emu->process_waiting_in_debugger();
+				}
+				cpustate->emu->finish_waiting_in_debugger();
+				cpustate->debugger->now_waiting = false;
+			}
+			if(cpustate->debugger->now_debugging) {
+				cpustate->program = cpustate->io = cpustate->debugger;
+			} else {
+				now_debugging = false;
+			}
+			int first_cycles = cpustate->cycles;
+			i386_check_irq_line(cpustate);
+			cpustate->operand_size = cpustate->sreg[CS].d;
+			cpustate->xmm_operand_size = 0;
+			cpustate->address_size = cpustate->sreg[CS].d;
+			cpustate->operand_prefix = 0;
+			cpustate->address_prefix = 0;
 
-		cpustate->ext = 1;
-		int old_tf = cpustate->TF;
+			cpustate->ext = 1;
+			int old_tf = cpustate->TF;
 
-		cpustate->segment_prefix = 0;
+			cpustate->debugger->add_cpu_trace(cpustate->pc);
+			cpustate->segment_prefix = 0;
+			cpustate->prev_eip = cpustate->eip;
+			cpustate->prev_pc = cpustate->pc;
 
-		try
-		{
-			UINT32 address = cpustate->pc, error;
-
-			if(!translate_address(cpustate,cpustate->CPL,TRANSLATE_FETCH,&address,&error))
-				PF_THROW(error);
-#ifdef USE_DEBUGGER
+			if(cpustate->delayed_interrupt_enable != 0)
+			{
+				cpustate->IF = 1;
+				cpustate->delayed_interrupt_enable = 0;
+			}
+#ifdef DEBUG_MISSING_OPCODE
+			cpustate->opcode_bytes_length = 0;
+			cpustate->opcode_pc = cpustate->pc;
+#endif
+			try
+			{
+				I386OP(decode_opcode)(cpustate);
+				if(cpustate->TF && old_tf)
+				{
+					cpustate->prev_eip = cpustate->eip;
+					cpustate->ext = 1;
+					i386_trap(cpustate,1,0,0);
+				}
+				if(cpustate->lock && (cpustate->opcode != 0xf0))
+					cpustate->lock = false;
+			}
+			catch(UINT64 e)
+			{
+				cpustate->ext = 1;
+				i386_trap_with_error(cpustate,e&0xffffffff,0,0,e>>32);
+			}
+#ifdef SINGLE_MODE_DMA
+			if(cpustate->dma != NULL) {
+				cpustate->dma->do_dma();
+			}
+#endif
+			/* adjust for any interrupts that came in */
+			cpustate->cycles -= cpustate->extra_cycles;
+			cpustate->extra_cycles = 0;
+			cpustate->total_cycles += first_cycles - cpustate->cycles;
+			
 			if(now_debugging) {
-				cpustate->debugger->check_break_points(address);
-				if(cpustate->debugger->now_suspended) {
-					cpustate->debugger->now_waiting = true;
-					cpustate->emu->start_waiting_in_debugger();
-					while(cpustate->debugger->now_debugging && cpustate->debugger->now_suspended) {
-						cpustate->emu->process_waiting_in_debugger();
-					}
-					cpustate->emu->finish_waiting_in_debugger();
-					cpustate->debugger->now_waiting = false;
+				if(!cpustate->debugger->now_going) {
+					cpustate->debugger->now_suspended = true;
 				}
-				if(cpustate->debugger->now_debugging) {
-					cpustate->program = cpustate->io = cpustate->debugger;
-				} else {
-					now_debugging = false;
-				}
+				cpustate->program = cpustate->program_stored;
+				cpustate->io = cpustate->io_stored;
 			}
-			cpustate->debugger->add_cpu_trace(address, cpustate->eip, (cpustate->operand_size != 0));
+		} else {
+			int first_cycles = cpustate->cycles;
 #endif
+			i386_check_irq_line(cpustate);
+			cpustate->operand_size = cpustate->sreg[CS].d;
+			cpustate->xmm_operand_size = 0;
+			cpustate->address_size = cpustate->sreg[CS].d;
+			cpustate->operand_prefix = 0;
+			cpustate->address_prefix = 0;
+
+			cpustate->ext = 1;
+			int old_tf = cpustate->TF;
+
+#ifdef USE_DEBUGGER
+			cpustate->debugger->add_cpu_trace(cpustate->pc);
+#endif
+			cpustate->segment_prefix = 0;
 			cpustate->prev_eip = cpustate->eip;
-			cpustate->prev_pc = address;
+			cpustate->prev_pc = cpustate->pc;
 
 			if(cpustate->delayed_interrupt_enable != 0)
 			{
@@ -3507,38 +3536,33 @@
 			cpustate->opcode_bytes_length = 0;
 			cpustate->opcode_pc = cpustate->pc;
 #endif
-			I386OP(decode_first_opcode)(cpustate, address);
-			if(cpustate->TF && old_tf)
+			try
 			{
-				cpustate->prev_eip = cpustate->eip;
+				I386OP(decode_opcode)(cpustate);
+				if(cpustate->TF && old_tf)
+				{
+					cpustate->prev_eip = cpustate->eip;
+					cpustate->ext = 1;
+					i386_trap(cpustate,1,0,0);
+				}
+				if(cpustate->lock && (cpustate->opcode != 0xf0))
+					cpustate->lock = false;
+			}
+			catch(UINT64 e)
+			{
 				cpustate->ext = 1;
-				i386_trap(cpustate,1,0,0);
+				i386_trap_with_error(cpustate,e&0xffffffff,0,0,e>>32);
 			}
-			if(cpustate->lock && (cpustate->opcode != 0xf0))
-				cpustate->lock = false;
-		}
-		catch(UINT64 e)
-		{
-			cpustate->ext = 1;
-			i386_trap_with_error(cpustate,e&0xffffffff,0,0,e>>32);
-		}
 #ifdef SINGLE_MODE_DMA
-		if(cpustate->dma != NULL) {
-			cpustate->dma->do_dma();
-		}
+			if(cpustate->dma != NULL) {
+				cpustate->dma->do_dma();
+			}
 #endif
-		/* adjust for any interrupts that came in */
-		cpustate->cycles -= cpustate->extra_cycles;
-		cpustate->extra_cycles = 0;
+			/* adjust for any interrupts that came in */
+			cpustate->cycles -= cpustate->extra_cycles;
+			cpustate->extra_cycles = 0;
 #ifdef USE_DEBUGGER
-		cpustate->total_cycles += first_cycles - cpustate->cycles;
-
-		if(now_debugging) {
-			if(!cpustate->debugger->now_going) {
-				cpustate->debugger->now_suspended = true;
-			}
-			cpustate->program = cpustate->program_stored;
-			cpustate->io = cpustate->io_stored;
+			cpustate->total_cycles += first_cycles - cpustate->cycles;
 		}
 #endif
 	}
@@ -3617,7 +3641,6 @@
 	// Family 4 (486), Model 0/1 (DX), Stepping 3
 	REG32(EAX) = 0;
 	REG32(EDX) = (4 << 8) | (0 << 4) | (3);
-	cpustate->cpu_version = REG32(EDX);
 
 	CHANGE_PC(cpustate,cpustate->eip);
 }
diff -ruN source/src/vm/mame/emu/cpu/i386/i386dasm.c src/vm/mame/emu/cpu/i386/i386dasm.c
--- source/src/vm/mame/emu/cpu/i386/i386dasm.c	2025-04-28 16:00:00
+++ src/vm/mame/emu/cpu/i386/i386dasm.c	2025-04-28 22:36:36
@@ -13,8 +13,6 @@
 	PARAM_REG = 1,      /* 16 or 32-bit register */
 	PARAM_REG8,         /* 8-bit register */
 	PARAM_REG16,        /* 16-bit register */
-	PARAM_REG2_8,       /* 8-bit register */
-	PARAM_REG2_16,      /* 16-bit register */
 	PARAM_REG32,        /* 32-bit register */
 	PARAM_REG3264,      /* 32-bit or 64-bit register */
 	PARAM_REG2_32,      /* 32-bit register */
@@ -35,7 +33,6 @@
 	PARAM_M64PTR,       /* 64-bit memory */
 	PARAM_MMXM,         /* 64-bit memory or MMX register */
 	PARAM_XMMM,         /* 128-bit memory or XMM register */
-	PARAM_I3,           /* 3-bit immediate */
 	PARAM_I4,           /* 4-bit signed immediate */
 	PARAM_I8,           /* 8-bit signed immediate */
 	PARAM_I16,          /* 16-bit signed immediate */
@@ -49,7 +46,6 @@
 	PARAM_MEM_OFFS,     /* 16 or 32-bit mem offset */
 	PARAM_PREIMP,       /* prefix with implicit register */
 	PARAM_SREG,         /* segment register */
-	PARAM_SFREG,        /* V25/V35 special function register */
 	PARAM_CREG,         /* control register */
 	PARAM_DREG,         /* debug register */
 	PARAM_TREG,         /* test register */
@@ -277,7 +273,7 @@
 	{_T("mov"),             MODRM,          PARAM_SREG,         PARAM_RM,           0               },
 	{_T("pop"),             MODRM,          PARAM_RM,           0,                  0               },
 	// 0x90
-	{_T("nop\0???\0???\0pause"), VAR_NAME4, 0,                  0,                  0               },
+	{_T("nop\0???\0???\0pause"),    VAR_NAME4,          0,                  0,                  0               },
 	{_T("xchg"),            0,              PARAM_EAX,          PARAM_ECX,          0               },
 	{_T("xchg"),            0,              PARAM_EAX,          PARAM_EDX,          0               },
 	{_T("xchg"),            0,              PARAM_EAX,          PARAM_EBX,          0               },
@@ -418,44 +414,47 @@
 	{_T("???"),             0,              0,                  0,                  0               },
 	{_T("ud2"),             0,              0,                  0,                  0               },
 	{_T("???"),             0,              0,                  0,                  0               },
-	{_T("group0F0D"),       GROUP,          0,                  0,                  0               }, //AMD only
+	{_T("group0F0D"),           GROUP,              0,                  0,                  0               }, //AMD only
 	{_T("???"),             0,              0,                  0,                  0               },
 	{_T("???"),             0,              0,                  0,                  0               },
 	// 0x10
 	{_T("movups\0")
-	 _T("movupd\0")
-	 _T("movsd\0")
-	 _T("movss"),           MODRM|VAR_NAME4,PARAM_XMM,          PARAM_XMMM,         0               },
+		_T("movupd\0")
+		_T("movsd\0")
+		_T("movss"),            MODRM|VAR_NAME4,PARAM_XMM,          PARAM_XMMM,         0               },
 	{_T("movups\0")
-	 _T("movupd\0")
-	 _T("movsd\0")
-	 _T("movss"),           MODRM|VAR_NAME4,PARAM_XMMM,         PARAM_XMM,          0               },
-	{_T("group0F12"),       GROUP|GROUP_MOD,0,                  0,                  0               },
+		_T("movupd\0")
+		_T("movsd\0")
+		_T("movss"),            MODRM|VAR_NAME4,PARAM_XMMM,         PARAM_XMM,          0               },
 	{_T("movlps\0")
-	 _T("movlpd\0")
-	 _T("???\0")
-	 _T("???"),             MODRM|VAR_NAME4,PARAM_XMMM,         PARAM_XMM,          0               },
+		_T("movlpd\0")
+		_T("movddup\0")
+		_T("movsldup"),     MODRM|VAR_NAME4,PARAM_XMM,          PARAM_XMMM,         0               },
+	{_T("movlps\0")
+		_T("movlpd\0")
+		_T("???\0")
+		_T("???"),              MODRM|VAR_NAME4,PARAM_XMMM,         PARAM_XMM,          0               },
 	{_T("unpcklps\0")
-	 _T("unpcklpd\0")
-	 _T("???\0")
-	 _T("???"),             MODRM|VAR_NAME4,PARAM_XMM,          PARAM_XMMM,         0               },
+		_T("unpcklpd\0")
+		_T("???\0")
+		_T("???"),              MODRM|VAR_NAME4,PARAM_XMM,          PARAM_XMMM,         0               },
 	{_T("unpckhps\0")
-	 _T("unpckhpd\0")
-	 _T("???\0")
-	 _T("???"),             MODRM|VAR_NAME4,PARAM_XMM,          PARAM_XMMM,         0               },
-	{_T("group0F16"),       GROUP|GROUP_MOD,0,                  0,                  0               },
+		_T("unpckhpd\0")
+		_T("???\0")
+		_T("???"),              MODRM|VAR_NAME4,PARAM_XMM,          PARAM_XMMM,         0               },
+	{_T("group0F16"),     GROUP|GROUP_MOD, 0,                  0,                  0                   },
 	{_T("movhps\0")
-	 _T("movhpd\0")
-	 _T("???\0")
-	 _T("???"),             MODRM|VAR_NAME4,PARAM_XMMM,         PARAM_XMM,          0               },
+		_T("movhpd\0")
+		_T("???\0")
+		_T("???"),              MODRM|VAR_NAME4,PARAM_XMMM,          PARAM_XMM,         0               },
 	{_T("group0F18"),       GROUP,          0,                  0,                  0               },
-	{_T("nop_hint"),        0,              PARAM_RMPTR8,       0,                  0               },
-	{_T("nop_hint"),        0,              PARAM_RMPTR8,       0,                  0               },
-	{_T("nop_hint"),        0,              PARAM_RMPTR8,       0,                  0               },
-	{_T("nop_hint"),        0,              PARAM_RMPTR8,       0,                  0               },
-	{_T("nop_hint"),        0,              PARAM_RMPTR8,       0,                  0               },
-	{_T("nop_hint"),        0,              PARAM_RMPTR8,       0,                  0               },
-	{_T("nop_hint"),        0,              PARAM_RMPTR8,       0,                  0               },
+	{_T("nop_hint"),        0,              PARAM_RMPTR8,               0,                  0               },
+	{_T("nop_hint"),        0,              PARAM_RMPTR8,               0,                  0               },
+	{_T("nop_hint"),        0,              PARAM_RMPTR8,               0,                  0               },
+	{_T("nop_hint"),        0,              PARAM_RMPTR8,               0,                  0               },
+	{_T("nop_hint"),        0,              PARAM_RMPTR8,               0,                  0               },
+	{_T("nop_hint"),        0,              PARAM_RMPTR8,               0,                  0               },
+	{_T("nop_hint"),        0,              PARAM_RMPTR8,               0,                  0               },
 	// 0x20
 	{_T("mov"),             MODRM,          PARAM_REG2_32,      PARAM_CREG,         0               },
 	{_T("mov"),             MODRM,          PARAM_REG2_32,      PARAM_DREG,         0               },
@@ -466,37 +465,37 @@
 	{_T("mov"),             MODRM,          PARAM_TREG,         PARAM_REG2_32,      0               },
 	{_T("???"),             0,              0,                  0,                  0               },
 	{_T("movaps\0")
-	 _T("movapd\0")
-	 _T("???\0")
-	 _T("???"),             MODRM|VAR_NAME4,PARAM_XMM,          PARAM_XMMM,         0               },
+		_T("movapd\0")
+		_T("???\0")
+		_T("???"),              MODRM|VAR_NAME4,PARAM_XMM,          PARAM_XMMM,         0               },
 	{_T("movaps\0")
-	 _T("movapd\0")
-	 _T("???\0")
-	 _T("???"),             MODRM|VAR_NAME4,PARAM_XMMM,         PARAM_XMM,          0               },
+		_T("movapd\0")
+		_T("???\0")
+		_T("???"),              MODRM|VAR_NAME4,PARAM_XMMM,         PARAM_XMM,          0               },
 	{_T("cvtpi2ps\0")
-	 _T("cvtpi2pd\0")
-	 _T("cvtsi2sd\0")
-	 _T("cvtsi2ss"),        MODRM|VAR_NAME4,PARAM_XMM,          PARAM_RMXMM,        0               },
+		_T("cvtpi2pd\0")
+		_T("cvtsi2sd\0")
+		_T("cvtsi2ss"),     MODRM|VAR_NAME4,PARAM_XMM,          PARAM_RMXMM,        0               },
 	{_T("movntps\0")
-	 _T("movntpd\0")
-	 _T("???\0")
-	 _T("???"),             MODRM|VAR_NAME4,PARAM_XMMM,         PARAM_XMM,          0               },
+		_T("movntpd\0")
+		_T("???\0")
+		_T("???"),              MODRM|VAR_NAME4,PARAM_XMMM,         PARAM_XMM,          0               },
 	{_T("cvttps2pi\0")
-	 _T("cvttpd2pi\0")
-	 _T("cvttsd2si\0")
-	 _T("cvttss2si"),       MODRM|VAR_NAME4,PARAM_REGORXMM,     PARAM_XMMM,         0               },
+		_T("cvttpd2pi\0")
+		_T("cvttsd2si\0")
+		_T("cvttss2si"),        MODRM|VAR_NAME4,PARAM_REGORXMM,     PARAM_XMMM,         0               },
 	{_T("cvtps2pi\0")
-	 _T("cvtpd2pi\0")
-	 _T("cvtsd2si\0")
-	 _T("cvtss2si"),        MODRM|VAR_NAME4,PARAM_REGORXMM,     PARAM_XMMM,         0               },
+		_T("cvtpd2pi\0")
+		_T("cvtsd2si\0")
+		_T("cvtss2si"),     MODRM|VAR_NAME4,PARAM_REGORXMM,     PARAM_XMMM,         0               },
 	{_T("ucomiss\0")
-	 _T("ucomisd\0")
-	 _T("???\0")
-	 _T("???"),             MODRM|VAR_NAME4,PARAM_XMM,          PARAM_XMMM,         0               },
+		_T("ucomisd\0")
+		_T("???\0")
+		_T("???"),              MODRM|VAR_NAME4,PARAM_XMM,          PARAM_XMMM,         0               },
 	{_T("comiss\0")
-	 _T("comisd\0")
-	 _T("???\0")
-	 _T("???"),             MODRM|VAR_NAME4,PARAM_XMM,          PARAM_XMMM,         0               },
+		_T("comisd\0")
+		_T("???\0")
+		_T("???"),              MODRM|VAR_NAME4,PARAM_XMM,          PARAM_XMMM,         0               },
 	// 0x30
 	{_T("wrmsr"),           0,              0,                  0,                  0               },
 	{_T("rdtsc"),           0,              0,                  0,                  0               },
@@ -506,9 +505,9 @@
 	{_T("sysexit"),         0,              0,                  0,                  0               },
 	{_T("???"),             0,              0,                  0,                  0               },
 	{_T("???"),             0,              0,                  0,                  0               },
-	{_T("three_byte"),      THREE_BYTE,     0,                  0,                  0               },
+	{_T("three_byte"),          THREE_BYTE,         0,                  0,                  0               },
 	{_T("???"),             0,              0,                  0,                  0               },
-	{_T("three_byte"),      THREE_BYTE,     0,                  0,                  0               },
+	{_T("three_byte"),          THREE_BYTE,         0,                  0,                  0               },
 	{_T("???"),             0,              0,                  0,                  0               },
 	{_T("???"),             0,              0,                  0,                  0               },
 	{_T("???"),             0,              0,                  0,                  0               },
@@ -533,69 +532,69 @@
 	{_T("cmovg"),           MODRM,          PARAM_REG,          PARAM_RM,           0               },
 	// 0x50
 	{_T("movmskps\0")
-	 _T("movmskpd\0")
-	 _T("???\0")
-	 _T("???"),             MODRM|VAR_NAME4,PARAM_REG3264,      PARAM_XMMM,         0               },
+		_T("movmskpd\0")
+		_T("???\0")
+		_T("???"),              MODRM|VAR_NAME4,PARAM_REG3264,      PARAM_XMMM,         0               },
 	{_T("sqrtps\0")
-	 _T("sqrtpd\0")
-	 _T("sqrtsd\0")
-	 _T("sqrtss"),          MODRM|VAR_NAME4,PARAM_XMM,          PARAM_XMMM,         0               },
+		_T("sqrtpd\0")
+		_T("sqrtsd\0")
+		_T("sqrtss"),           MODRM|VAR_NAME4,PARAM_XMM,          PARAM_XMMM,         0               },
 	{_T("rsqrtps\0")
-	 _T("???\0")
-	 _T("???\0")
-	 _T("rsqrtss"),         MODRM|VAR_NAME4,PARAM_XMM,          PARAM_XMMM,         0               },
+		_T("???\0")
+		_T("???\0")
+		_T("rsqrtss"),          MODRM|VAR_NAME4,PARAM_XMM,          PARAM_XMMM,         0               },
 	{_T("rcpps\0")
-	 _T("???\0")
-	 _T("???\0")
-	 _T("rcpss"),           MODRM|VAR_NAME4,PARAM_XMM,          PARAM_XMMM,         0               },
+		_T("???\0")
+		_T("???\0")
+		_T("rcpss"),            MODRM|VAR_NAME4,PARAM_XMM,          PARAM_XMMM,         0               },
 	{_T("andps\0")
-	 _T("andpd\0")
-	 _T("???\0")
-	 _T("???"),             MODRM|VAR_NAME4,PARAM_XMM,          PARAM_XMMM,         0               },
+		_T("andpd\0")
+		_T("???\0")
+		_T("???"),              MODRM|VAR_NAME4,PARAM_XMM,          PARAM_XMMM,         0               },
 	{_T("andnps\0")
-	 _T("andnpd\0")
-	 _T("???\0")
-	 _T("???"),             MODRM|VAR_NAME4,PARAM_XMM,          PARAM_XMMM,         0               },
+		_T("andnpd\0")
+		_T("???\0")
+		_T("???"),              MODRM|VAR_NAME4,PARAM_XMM,          PARAM_XMMM,         0               },
 	{_T("orps\0")
-	 _T("orpd\0")
-	 _T("???\0")
-	 _T("???"),             MODRM|VAR_NAME4,PARAM_XMM,          PARAM_XMMM,         0               },
+		_T("orpd\0")
+		_T("???\0")
+		_T("???"),              MODRM|VAR_NAME4,PARAM_XMM,          PARAM_XMMM,         0               },
 	{_T("xorps\0")
-	 _T("xorpd\0")
-	 _T("???\0")
-	 _T("???"),             MODRM|VAR_NAME4,PARAM_XMM,          PARAM_XMMM,         0               },
+		_T("xorpd\0")
+		_T("???\0")
+		_T("???"),              MODRM|VAR_NAME4,PARAM_XMM,          PARAM_XMMM,         0               },
 	{_T("addps\0")
-	 _T("addpd\0")
-	 _T("addsd\0")
-	 _T("addss"),           MODRM|VAR_NAME4,PARAM_XMM,          PARAM_XMMM,         0               },
+		_T("addpd\0")
+		_T("addsd\0")
+		_T("addss"),            MODRM|VAR_NAME4,PARAM_XMM,          PARAM_XMMM,         0               },
 	{_T("mulps\0")
-	 _T("mulpd\0")
-	 _T("mulsd\0")
-	 _T("mulss"),           MODRM|VAR_NAME4,PARAM_XMM,          PARAM_XMMM,         0               },
+		_T("mulpd\0")
+		_T("mulsd\0")
+		_T("mulss"),            MODRM|VAR_NAME4,PARAM_XMM,          PARAM_XMMM,         0               },
 	{_T("cvtps2pd\0")
-	 _T("cvtpd2ps\0")
-	 _T("cvtsd2ss\0")
-	 _T("cvtss2sd"),        MODRM|VAR_NAME4,PARAM_XMM,          PARAM_XMMM,         0               },
+		_T("cvtpd2ps\0")
+		_T("cvtsd2ss\0")
+		_T("cvtss2sd"),     MODRM|VAR_NAME4,PARAM_XMM,          PARAM_XMMM,         0               },
 	{_T("cvtdq2ps\0")
-	 _T("cvtps2dq\0")
-	 _T("???\0")
-	 _T("cvttps2dq"),       MODRM|VAR_NAME4,PARAM_XMM,          PARAM_XMMM,         0               },
+		_T("cvtps2dq\0")
+		_T("???\0")
+		_T("cvttps2dq"),        MODRM|VAR_NAME4,PARAM_XMM,          PARAM_XMMM,         0               },
 	{_T("subps\0")
-	 _T("subpd\0")
-	 _T("subsd\0")
-	 _T("subss"),           MODRM|VAR_NAME4,PARAM_XMM,          PARAM_XMMM,         0               },
+		_T("subpd\0")
+		_T("subsd\0")
+		_T("subss"),            MODRM|VAR_NAME4,PARAM_XMM,          PARAM_XMMM,         0               },
 	{_T("minps\0")
-	 _T("minpd\0")
-	 _T("minsd\0")
-	 _T("minss"),           MODRM|VAR_NAME4,PARAM_XMM,          PARAM_XMMM,         0               },
+		_T("minpd\0")
+		_T("minsd\0")
+		_T("minss"),            MODRM|VAR_NAME4,PARAM_XMM,          PARAM_XMMM,         0               },
 	{_T("divps\0")
-	 _T("divpd\0")
-	 _T("divsd\0")
-	 _T("divss"),           MODRM|VAR_NAME4,PARAM_XMM,          PARAM_XMMM,         0               },
+		_T("divpd\0")
+		_T("divsd\0")
+		_T("divss"),            MODRM|VAR_NAME4,PARAM_XMM,          PARAM_XMMM,         0               },
 	{_T("maxps\0")
-	 _T("maxpd\0")
-	 _T("maxsd\0")
-	 _T("maxss"),           MODRM|VAR_NAME4,PARAM_XMM,          PARAM_XMMM,         0               },
+		_T("maxpd\0")
+		_T("maxsd\0")
+		_T("maxss"),            MODRM|VAR_NAME4,PARAM_XMM,          PARAM_XMMM,         0               },
 	// 0x60
 	{_T("punpcklbw"),       MODRM,          PARAM_MMX,          PARAM_MMXM,         0               },
 	{_T("punpcklwd"),       MODRM,          PARAM_MMX,          PARAM_MMXM,         0               },
@@ -610,23 +609,23 @@
 	{_T("punpckhdq"),       MODRM,          PARAM_MMX,          PARAM_MMXM,         0               },
 	{_T("packssdw"),        MODRM,          PARAM_MMX,          PARAM_MMXM,         0               },
 	{_T("???\0")
-	 _T("punpcklqdq\0")
-	 _T("???\0")
-	 _T("???\0"),           MODRM|VAR_NAME4,PARAM_XMM,          PARAM_XMMM,         0               },
+		_T("punpcklqdq\0")
+		_T("???\0")
+		_T("???\0"),        MODRM|VAR_NAME4,            PARAM_XMM,          PARAM_XMMM,         0               },
 	{_T("???\0")
-	 _T("punpckhqdq\0")
-	 _T("???\0")
-	 _T("???\0"),           MODRM|VAR_NAME4,PARAM_XMM,          PARAM_XMMM,         0               },
+		_T("punpckhqdq\0")
+		_T("???\0")
+		_T("???\0"),        MODRM|VAR_NAME4,            PARAM_XMM,          PARAM_XMMM,         0               },
 	{_T("movd"),            MODRM,          PARAM_MMX,          PARAM_RM,           0               },
 	{_T("movq\0")
-	 _T("movdqa\0")
-	 _T("???\0")
-	 _T("movdqu"),          MODRM|VAR_NAME4,PARAM_MMX,          PARAM_MMXM,         0               },
+		_T("movdqa\0")
+		_T("???\0")
+		_T("movdqu"),           MODRM|VAR_NAME4,PARAM_MMX,          PARAM_MMXM,         0               },
 	// 0x70
 	{_T("pshufw\0")
-	 _T("pshufd\0")
-	 _T("pshuflw\0")
-	 _T("pshufhw"),         MODRM|VAR_NAME4,PARAM_MMX,          PARAM_MMXM,         PARAM_UI8       },
+		_T("pshufd\0")
+		_T("pshuflw\0")
+		_T("pshufhw"),          MODRM|VAR_NAME4,PARAM_MMX,          PARAM_MMXM,         PARAM_UI8       },
 	{_T("group0F71"),       GROUP,          0,                  0,                  0               },
 	{_T("group0F72"),       GROUP,          0,                  0,                  0               },
 	{_T("group0F73"),       GROUP,          0,                  0,                  0               },
@@ -634,26 +633,26 @@
 	{_T("pcmpeqw"),         MODRM,          PARAM_MMX,          PARAM_MMXM,         0               },
 	{_T("pcmpeqd"),         MODRM,          PARAM_MMX,          PARAM_MMXM,         0               },
 	{_T("emms"),            0,              0,                  0,                  0               },
-	{_T("vmread"),          MODRM,          PARAM_RM,           PARAM_REG,          0               },
-	{_T("vmwrite"),         MODRM,          PARAM_RM,           PARAM_REG,          0               },
+	{_T("vmread"),          MODRM,              PARAM_RM,               PARAM_REG,              0               },
+	{_T("vmwrite"),         MODRM,              PARAM_RM,               PARAM_REG,              0               },
 	{_T("???"),             0,              0,                  0,                  0               },
 	{_T("???"),             0,              0,                  0,                  0               },
 	{_T("???\0")
-	 _T("haddpd\0")
-	 _T("haddps\0")
-	 _T("???"),             MODRM|VAR_NAME4,PARAM_MMX,          PARAM_MMXM,         0               },
+		_T("haddpd\0")
+		_T("haddps\0")
+		_T("???"),              MODRM|VAR_NAME4,PARAM_MMX,          PARAM_MMXM,         0               },
 	{_T("???\0")
-	 _T("hsubpd\0")
-	 _T("hsubps\0")
-	 _T("???"),             MODRM|VAR_NAME4,PARAM_MMX,          PARAM_MMXM,         0               },
+		_T("hsubpd\0")
+		_T("hsubps\0")
+		_T("???"),              MODRM|VAR_NAME4,PARAM_MMX,          PARAM_MMXM,         0               },
 	{_T("movd\0")
-	 _T("movd\0")
-	 _T("???\0")
-	 _T("movq"),            MODRM|VAR_NAME4,PARAM_RM,           PARAM_MMX,          0               },
+		_T("movd\0")
+		_T("???\0")
+		_T("movq"),         MODRM|VAR_NAME4,PARAM_RM,           PARAM_MMX,          0               },
 	{_T("movq\0")
-	 _T("movdqa\0")
-	 _T("???\0")
-	 _T("movdqu"),          MODRM|VAR_NAME4,PARAM_MMXM,         PARAM_MMX,          0               },
+		_T("movdqa\0")
+		_T("???\0")
+		_T("movdqu"),           MODRM|VAR_NAME4,PARAM_MMXM,         PARAM_MMX,          0               },
 	// 0x80
 	{_T("jo"),              0,              PARAM_REL,          0,                  0               },
 	{_T("jno"),             0,              PARAM_REL,          0,                  0               },
@@ -715,37 +714,37 @@
 	{_T("movzx"),           MODRM,          PARAM_REG,          PARAM_RMPTR8,       0               },
 	{_T("movzx"),           MODRM,          PARAM_REG,          PARAM_RMPTR16,      0               },
 	{_T("???\0")
-	 _T("???\0")
-	 _T("???\0")
-	 _T("popcnt"),          MODRM|VAR_NAME4,PARAM_REG,          PARAM_RM16,         0               },
+		_T("???\0")
+		_T("???\0")
+		_T("popcnt"),           MODRM|VAR_NAME4,        PARAM_REG,              PARAM_RM16,             0               },
 	{_T("ud2"),             0,              0,                  0,                  0               },
 	{_T("group0FBA"),       GROUP,          0,                  0,                  0               },
 	{_T("btc"),             MODRM,          PARAM_RM,           PARAM_REG,          0               },
 	{_T("bsf\0")
-	 _T("???\0")
-	 _T("???\0")
-	 _T("tzcnt"),           MODRM|VAR_NAME4,PARAM_REG,          PARAM_RM,           0               },
+		_T("???\0")
+		_T("???\0")
+		_T("tzcnt"),            MODRM|VAR_NAME4,    PARAM_REG,          PARAM_RM,           0               },
 	{_T("bsr\0")
-	 _T("???\0")
-	 _T("???\0")
-	 _T("lzcnt"),           MODRM|VAR_NAME4,PARAM_REG,          PARAM_RM,           0,              DASMFLAG_STEP_OVER},
+		_T("???\0")
+		_T("???\0")
+		_T("lzcnt"),            MODRM|VAR_NAME4,    PARAM_REG,          PARAM_RM,           0,              DASMFLAG_STEP_OVER},
 	{_T("movsx"),           MODRM,          PARAM_REG,          PARAM_RMPTR8,       0               },
 	{_T("movsx"),           MODRM,          PARAM_REG,          PARAM_RMPTR16,      0               },
 	// 0xc0
 	{_T("xadd"),            MODRM,          PARAM_RM8,          PARAM_REG,          0               },
 	{_T("xadd"),            MODRM,          PARAM_RM,           PARAM_REG,          0               },
 	{_T("cmpps\0")
-	 _T("cmppd\0")
-	 _T("cmpsd\0")
-	 _T("cmpss"),           MODRM|VAR_NAME4,PARAM_XMM,          PARAM_XMMM,         0               },
+		_T("cmppd\0")
+		_T("cmpsd\0")
+		_T("cmpss"),            MODRM|VAR_NAME4,PARAM_XMM,          PARAM_XMMM,         0               },
 	{_T("movnti"),          MODRM,          PARAM_RM,           PARAM_REG,          0               },
 	{_T("pinsrw"),          MODRM,          PARAM_MMX,          PARAM_RM,           PARAM_UI8       },
 	{_T("pextrw"),          MODRM,          PARAM_MMX,          PARAM_RM,           PARAM_UI8       },
 	{_T("shufps\0")
-	 _T("shufpd\0")
-	 _T("???\0")
-	 _T("???"),             MODRM|VAR_NAME4,PARAM_XMM,          PARAM_XMMM,         PARAM_UI8       },
-	{_T("group0FC7"),       GROUP,          0,                  0,                  0               },
+		_T("shufpd\0")
+		_T("???\0")
+		_T("???"),              MODRM|VAR_NAME4,PARAM_XMM,          PARAM_XMMM,         PARAM_UI8       },
+	{_T("group0FC7"),           GROUP,          0,          0,                  0               },
 	{_T("bswap"),           0,              PARAM_EAX,          0,                  0               },
 	{_T("bswap"),           0,              PARAM_ECX,          0,                  0               },
 	{_T("bswap"),           0,              PARAM_EDX,          0,                  0               },
@@ -756,18 +755,18 @@
 	{_T("bswap"),           0,              PARAM_EDI,          0,                  0               },
 	// 0xd0
 	{_T("???\0")
-	 _T("addsubpd\0")
-	 _T("addsubps\0")
-	 _T("???\0"),           MODRM|VAR_NAME4,PARAM_XMM,          PARAM_XMMM,         0               },
+		_T("addsubpd\0")
+		_T("addsubps\0")
+		_T("???\0"),            MODRM|VAR_NAME4,PARAM_XMM,          PARAM_XMMM,         0               },
 	{_T("psrlw"),           MODRM,          PARAM_MMX,          PARAM_MMXM,         0               },
 	{_T("psrld"),           MODRM,          PARAM_MMX,          PARAM_MMXM,         0               },
 	{_T("psrlq"),           MODRM,          PARAM_MMX,          PARAM_MMXM,         0               },
 	{_T("paddq"),           MODRM,          PARAM_MMX,          PARAM_MMXM,         0               },
 	{_T("pmullw"),          MODRM,          PARAM_MMX,          PARAM_MMXM,         0               },
 	{_T("???\0")
-	 _T("movq\0")
-	 _T("movdq2q\0")
-	 _T("movq2dq"),         MODRM|VAR_NAME4,PARAM_MMX,          PARAM_MMXM,         0               },
+		_T("movq\0")
+		_T("movdq2q\0")
+		_T("movq2dq"),          MODRM|VAR_NAME4,PARAM_MMX,          PARAM_MMXM,         0               },
 	{_T("pmovmskb"),        MODRM,          PARAM_REG3264,      PARAM_MMXM,         0               },
 	{_T("psubusb"),         MODRM,          PARAM_MMX,          PARAM_MMXM,         0               },
 	{_T("psubusw"),         MODRM,          PARAM_MMX,          PARAM_MMXM,         0               },
@@ -785,13 +784,13 @@
 	{_T("pmulhuw"),         MODRM,          PARAM_MMX,          PARAM_MMXM,         0               },
 	{_T("pmulhw"),          MODRM,          PARAM_MMX,          PARAM_MMXM,         0               },
 	{_T("???\0")
-	 _T("cvttpd2dq\0")
-	 _T("cvtpd2dq\0")
-	 _T("cvtdq2pd"),        MODRM|VAR_NAME4,PARAM_XMM,          PARAM_XMMM,         0               },
+		_T("cvttpd2dq\0")
+		_T("cvtpd2dq\0")
+		_T("cvtdq2pd"),     MODRM|VAR_NAME4,PARAM_XMM,          PARAM_XMMM,         0               },
 	{_T("movntq\0")
-	 _T("movntdq\0")
-	 _T("???\0")
-	 _T("???\0"),           MODRM|VAR_NAME4,PARAM_M64,          PARAM_MMX,          0               },
+		_T("movntdq\0")
+		_T("???\0")
+		_T("???\0"),            MODRM|VAR_NAME4,    PARAM_M64,          PARAM_MMX,          0               },
 	{_T("psubsb"),          MODRM,          PARAM_MMX,          PARAM_MMXM,         0               },
 	{_T("psubsw"),          MODRM,          PARAM_MMX,          PARAM_MMXM,         0               },
 	{_T("pminsw"),          MODRM,          PARAM_MMX,          PARAM_MMXM,         0               },
@@ -802,9 +801,9 @@
 	{_T("pxor"),            MODRM,          PARAM_MMX,          PARAM_MMXM,         0               },
 	// 0xf0
 	{_T("???\0")
-	 _T("???\0")
-	 _T("lddqu\0")
-	 _T("???"),             MODRM|VAR_NAME4,PARAM_XMM,          PARAM_XMMM,         0               },
+		_T("???\0")
+		_T("lddqu\0")
+		_T("???"),              MODRM|VAR_NAME4,PARAM_XMM,          PARAM_XMMM,         0               },
 	{_T("psllw"),           MODRM,          PARAM_MMX,          PARAM_MMXM,         0               },
 	{_T("pslld"),           MODRM,          PARAM_MMX,          PARAM_MMXM,         0               },
 	{_T("psllq"),           MODRM,          PARAM_MMX,          PARAM_MMXM,         0               },
@@ -812,9 +811,9 @@
 	{_T("pmaddwd"),         MODRM,          PARAM_MMX,          PARAM_MMXM,         0               },
 	{_T("psadbw"),          MODRM,          PARAM_MMX,          PARAM_MMXM,         0               },
 	{_T("maskmovq\0")
-	 _T("maskmovdqu\0")
-	 _T("???\0")
-	 _T("???"),             MODRM|VAR_NAME4,PARAM_MMX,          PARAM_MMXM,         0               },
+		_T("maskmovdqu\0")
+		_T("???\0")
+		_T("???"),              MODRM|VAR_NAME4,PARAM_MMX,          PARAM_MMXM,         0               },
 	{_T("psubb"),           MODRM,          PARAM_MMX,          PARAM_MMXM,         0               },
 	{_T("psubw"),           MODRM,          PARAM_MMX,          PARAM_MMXM,         0               },
 	{_T("psubd"),           MODRM,          PARAM_MMX,          PARAM_MMXM,         0               },
@@ -829,792 +828,792 @@
 {
 	// 0x00
 	{_T("pshufb\0")
-	 _T("pshufb\0")
-	 _T("???\0")
-	 _T("???"),             MODRM|VAR_NAME4,PARAM_XMM,          PARAM_XMMM,         0               },
+		_T("pshufb\0")
+		_T("???\0")
+		_T("???"),              MODRM|VAR_NAME4,    PARAM_XMM,          PARAM_XMMM,         0               },
 	{_T("phaddw\0")
-	 _T("phaddw\0")
-	 _T("???\0")
-	 _T("???"),             MODRM|VAR_NAME4,PARAM_XMM,          PARAM_XMMM,         0               },
+		_T("phaddw\0")
+		_T("???\0")
+		_T("???"),              MODRM|VAR_NAME4,    PARAM_XMM,          PARAM_XMMM,         0               },
 	{_T("phaddd\0")
-	 _T("phadd\0")
-	 _T("???\0")
-	 _T("???"),             MODRM|VAR_NAME4,PARAM_XMM,          PARAM_XMMM,         0               },
+		_T("phadd\0")
+		_T("???\0")
+		_T("???"),              MODRM|VAR_NAME4,    PARAM_XMM,          PARAM_XMMM,         0               },
 	{_T("phaddsw\0")
-	 _T("phaddsw\0")
-	 _T("???\0")
-	 _T("???"),             MODRM|VAR_NAME4,PARAM_XMM,          PARAM_XMMM,         0               },
+		_T("phaddsw\0")
+		_T("???\0")
+		_T("???"),              MODRM|VAR_NAME4,    PARAM_XMM,          PARAM_XMMM,         0               },
 	{_T("pmaddubsw\0")
-	 _T("pmaddubsw\0")
-	 _T("???\0")
-	 _T("???"),             MODRM|VAR_NAME4,PARAM_XMM,          PARAM_XMMM,         0               },
+		_T("pmaddubsw\0")
+		_T("???\0")
+		_T("???"),              MODRM|VAR_NAME4,    PARAM_XMM,          PARAM_XMMM,         0               },
 	{_T("phsubw\0")
-	 _T("phsubw\0")
-	 _T("???\0")
-	 _T("???"),             MODRM|VAR_NAME4,PARAM_XMM,          PARAM_XMMM,         0               },
+		_T("phsubw\0")
+		_T("???\0")
+		_T("???"),              MODRM|VAR_NAME4,    PARAM_XMM,          PARAM_XMMM,         0               },
 	{_T("phsubd\0")
-	 _T("phsubd\0")
-	 _T("???\0")
-	 _T("???"),             MODRM|VAR_NAME4,PARAM_XMM,          PARAM_XMMM,         0               },
+		_T("phsubd\0")
+		_T("???\0")
+		_T("???"),              MODRM|VAR_NAME4,    PARAM_XMM,          PARAM_XMMM,         0               },
 	{_T("phsubsw\0")
-	 _T("phsubsw\0")
-	 _T("???\0")
-	 _T("???"),             MODRM|VAR_NAME4,PARAM_XMM,          PARAM_XMMM,         0               },
+		_T("phsubsw\0")
+		_T("???\0")
+		_T("???"),              MODRM|VAR_NAME4,    PARAM_XMM,          PARAM_XMMM,         0               },
 	{_T("psignb\0")
-	 _T("psignb\0")
-	 _T("???\0")
-	 _T("???"),             MODRM|VAR_NAME4,PARAM_XMM,          PARAM_XMMM,         0               },
+		_T("psignb\0")
+		_T("???\0")
+		_T("???"),              MODRM|VAR_NAME4,    PARAM_XMM,          PARAM_XMMM,         0               },
 	{_T("psignw\0")
-	 _T("psignw\0")
-	 _T("???\0")
-	 _T("???"),             MODRM|VAR_NAME4,PARAM_XMM,          PARAM_XMMM,         0               },
+		_T("psignw\0")
+		_T("???\0")
+		_T("???"),              MODRM|VAR_NAME4,    PARAM_XMM,          PARAM_XMMM,         0               },
 	{_T("psignd\0")
-	 _T("psignd\0")
-	 _T("???\0")
-	 _T("???"),             MODRM|VAR_NAME4,PARAM_XMM,          PARAM_XMMM,         0               },
+		_T("psignd\0")
+		_T("???\0")
+		_T("???"),              MODRM|VAR_NAME4,    PARAM_XMM,          PARAM_XMMM,         0               },
 	{_T("pmulhrsw\0")
-	 _T("pmulhrsw\0")
-	 _T("???\0")
-	 _T("???"),             MODRM|VAR_NAME4,PARAM_XMM,          PARAM_XMMM,         0               },
-	{_T("???"),             0,              0,                  0,                  0               },
-	{_T("???"),             0,              0,                  0,                  0               },
-	{_T("???"),             0,              0,                  0,                  0               },
-	{_T("???"),             0,              0,                  0,                  0               },
+		_T("pmulhrsw\0")
+		_T("???\0")
+		_T("???"),              MODRM|VAR_NAME4,    PARAM_XMM,          PARAM_XMMM,         0               },
+	{_T("???"),             0,              0,          0,              0               },
+	{_T("???"),             0,              0,          0,              0               },
+	{_T("???"),             0,              0,          0,              0               },
+	{_T("???"),             0,              0,          0,              0               },
 	// 0x10
 	{_T("???\0")
-	 _T("pblendvb\0")
-	 _T("???\0")
-	 _T("???"),             MODRM|VAR_NAME4,PARAM_XMM,          PARAM_XMMM,         PARAM_XMM0      },
-	{_T("???"),             0,              0,                  0,                  0               },
-	{_T("???"),             0,              0,                  0,                  0               },
-	{_T("???"),             0,              0,                  0,                  0               },
+		_T("pblendvb\0")
+		_T("???\0")
+		_T("???"),              MODRM|VAR_NAME4,    PARAM_XMM,          PARAM_XMMM,         PARAM_XMM0          },
+	{_T("???"),             0,              0,          0,              0               },
+	{_T("???"),             0,              0,          0,              0               },
+	{_T("???"),             0,              0,          0,              0               },
 	{_T("???\0")
-	 _T("blendvps\0")
-	 _T("???\0")
-	 _T("???"),             MODRM|VAR_NAME4,PARAM_XMM,          PARAM_XMMM,         PARAM_XMM0      },
+		_T("blendvps\0")
+		_T("???\0")
+		_T("???"),              MODRM|VAR_NAME4,    PARAM_XMM,          PARAM_XMMM,         PARAM_XMM0          },
 	{_T("???\0")
-	 _T("blendvpd\0")
-	 _T("???\0")
-	 _T("???"),             MODRM|VAR_NAME4,PARAM_XMM,          PARAM_XMMM,         PARAM_XMM0      },
-	{_T("???"),             0,              0,                  0,                  0               },
+		_T("blendvpd\0")
+		_T("???\0")
+		_T("???"),              MODRM|VAR_NAME4,    PARAM_XMM,          PARAM_XMMM,         PARAM_XMM0          },
+	{_T("???"),             0,              0,          0,              0               },
 	{_T("???\0")
-	 _T("ptest\0")
-	 _T("???\0")
-	 _T("???"),             MODRM|VAR_NAME4,PARAM_XMM,          PARAM_XMMM,         0               },
-	{_T("???"),             0,              0,                  0,                  0               },
-	{_T("???"),             0,              0,                  0,                  0               },
-	{_T("???"),             0,              0,                  0,                  0               },
-	{_T("???"),             0,              0,                  0,                  0               },
+		_T("ptest\0")
+		_T("???\0")
+		_T("???"),              MODRM|VAR_NAME4,    PARAM_XMM,          PARAM_XMMM,         0               },
+	{_T("???"),             0,              0,          0,              0               },
+	{_T("???"),             0,              0,          0,              0               },
+	{_T("???"),             0,              0,          0,              0               },
+	{_T("???"),             0,              0,          0,              0               },
 	{_T("pabsb\0")
-	 _T("pabsb\0")
-	 _T("???\0")
-	 _T("???"),             MODRM|VAR_NAME4,PARAM_XMM,          PARAM_XMMM,         0               },
+		_T("pabsb\0")
+		_T("???\0")
+		_T("???"),              MODRM|VAR_NAME4,    PARAM_XMM,          PARAM_XMMM,         0               },
 	{_T("pabsw\0")
-	 _T("pabsw\0")
-	 _T("???\0")
-	 _T("???"),             MODRM|VAR_NAME4,PARAM_XMM,          PARAM_XMMM,         0               },
+		_T("pabsw\0")
+		_T("???\0")
+		_T("???"),              MODRM|VAR_NAME4,    PARAM_XMM,          PARAM_XMMM,         0               },
 	{_T("pabsd\0")
-	 _T("pabsd\0")
-	 _T("???\0")
-	 _T("???"),             MODRM|VAR_NAME4,PARAM_XMM,          PARAM_XMMM,         0               },
-	{_T("???"),             0,              0,                  0,                  0               },
+		_T("pabsd\0")
+		_T("???\0")
+		_T("???"),              MODRM|VAR_NAME4,    PARAM_XMM,          PARAM_XMMM,         0               },
+	{_T("???"),             0,              0,          0,              0               },
 	// 0x20
 	{_T("???\0")
-	 _T("pmovsxbw\0")
-	 _T("???\0")
-	 _T("???"),             MODRM|VAR_NAME4,PARAM_XMM,          PARAM_XMM64,        0               },
+		_T("pmovsxbw\0")
+		_T("???\0")
+		_T("???"),              MODRM|VAR_NAME4,    PARAM_XMM,          PARAM_XMM64,            0               },
 	{_T("???\0")
-	 _T("pmovsxbd\0")
-	 _T("???\0")
-	 _T("???"),             MODRM|VAR_NAME4,PARAM_XMM,          PARAM_XMM32,        0               },
+		_T("pmovsxbd\0")
+		_T("???\0")
+		_T("???"),              MODRM|VAR_NAME4,    PARAM_XMM,          PARAM_XMM32,            0               },
 	{_T("???\0")
-	 _T("pmovsxbq\0")
-	 _T("???\0")
-	 _T("???"),             MODRM|VAR_NAME4,PARAM_XMM,          PARAM_XMM16,        0               },
+		_T("pmovsxbq\0")
+		_T("???\0")
+		_T("???"),              MODRM|VAR_NAME4,    PARAM_XMM,          PARAM_XMM16,            0               },
 	{_T("???\0")
-	 _T("pmovsxwd\0")
-	 _T("???\0")
-	 _T("???"),             MODRM|VAR_NAME4,PARAM_XMM,          PARAM_XMM64,        0               },
+		_T("pmovsxwd\0")
+		_T("???\0")
+		_T("???"),              MODRM|VAR_NAME4,    PARAM_XMM,          PARAM_XMM64,            0               },
 	{_T("???\0")
-	 _T("pmovsxwq\0")
-	 _T("???\0")
-	 _T("???"),             MODRM|VAR_NAME4,PARAM_XMM,          PARAM_XMM32,        0               },
+		_T("pmovsxwq\0")
+		_T("???\0")
+		_T("???"),              MODRM|VAR_NAME4,    PARAM_XMM,          PARAM_XMM32,            0               },
 	{_T("???\0")
-	 _T("pmovsxdq\0")
-	 _T("???\0")
-	 _T("???"),             MODRM|VAR_NAME4,PARAM_XMM,          PARAM_XMM64,        0               },
-	{_T("???"),             0,              0,                  0,                  0               },
-	{_T("???"),             0,              0,                  0,                  0               },
+		_T("pmovsxdq\0")
+		_T("???\0")
+		_T("???"),              MODRM|VAR_NAME4,    PARAM_XMM,          PARAM_XMM64,            0               },
+	{_T("???"),             0,              0,          0,              0               },
+	{_T("???"),             0,              0,          0,              0               },
 	{_T("???\0")
-	 _T("pmuldq\0")
-	 _T("???\0")
-	 _T("???"),             MODRM|VAR_NAME4,PARAM_XMM,          PARAM_XMMM,         0               },
+		_T("pmuldq\0")
+		_T("???\0")
+		_T("???"),              MODRM|VAR_NAME4,    PARAM_XMM,          PARAM_XMMM,         0               },
 	{_T("???\0")
-	 _T("pcmpeqq\0")
-	 _T("???\0")
-	 _T("???"),              MODRM|VAR_NAME4,PARAM_XMM,         PARAM_XMMM,         0               },
+		_T("pcmpeqq\0")
+		_T("???\0")
+		_T("???"),              MODRM|VAR_NAME4,    PARAM_XMM,          PARAM_XMMM,         0               },
 	{_T("???\0")
-	 _T("movntdqa\0")
-	 _T("???\0")
-	 _T("???"),             MODRM|VAR_NAME4,PARAM_XMM,          PARAM_XMMM,         0               },
+		_T("movntdqa\0")
+		_T("???\0")
+		_T("???"),              MODRM|VAR_NAME4,    PARAM_XMM,          PARAM_XMMM,         0               },
 	{_T("???\0")
-	 _T("packusdw\0")
-	 _T("???\0")
-	 _T("???"),             MODRM|VAR_NAME4,PARAM_XMM,          PARAM_XMMM,         0               },
-	{_T("???"),             0,              0,                  0,                  0               },
-	{_T("???"),             0,              0,                  0,                  0               },
-	{_T("???"),             0,              0,                  0,                  0               },
-	{_T("???"),             0,              0,                  0,                  0               },
+		_T("packusdw\0")
+		_T("???\0")
+		_T("???"),              MODRM|VAR_NAME4,    PARAM_XMM,          PARAM_XMMM,         0               },
+	{_T("???"),             0,              0,          0,              0               },
+	{_T("???"),             0,              0,          0,              0               },
+	{_T("???"),             0,              0,          0,              0               },
+	{_T("???"),             0,              0,          0,              0               },
 	// 0x30
 	{_T("???\0")
-	 _T("pmovzxbw\0")
-	 _T("???\0")
-	 _T("???"),             MODRM|VAR_NAME4,PARAM_XMM,          PARAM_XMM64,        0               },
+		_T("pmovzxbw\0")
+		_T("???\0")
+		_T("???"),              MODRM|VAR_NAME4,    PARAM_XMM,          PARAM_XMM64,            0               },
 	{_T("???\0")
-	 _T("pmovzxbd\0")
-	 _T("???\0")
-	 _T("???"),             MODRM|VAR_NAME4,PARAM_XMM,          PARAM_XMM32,        0               },
+		_T("pmovzxbd\0")
+		_T("???\0")
+		_T("???"),              MODRM|VAR_NAME4,    PARAM_XMM,          PARAM_XMM32,            0               },
 	{_T("???\0")
-	 _T("pmovzxbq\0")
-	 _T("???\0")
-	 _T("???"),             MODRM|VAR_NAME4,PARAM_XMM,          PARAM_XMM16,        0               },
+		_T("pmovzxbq\0")
+		_T("???\0")
+		_T("???"),              MODRM|VAR_NAME4,    PARAM_XMM,          PARAM_XMM16,            0               },
 	{_T("???\0")
-	 _T("pmovzxwd\0")
-	 _T("???\0")
-	 _T("???"),             MODRM|VAR_NAME4,PARAM_XMM,          PARAM_XMM64,        0               },
+		_T("pmovzxwd\0")
+		_T("???\0")
+		_T("???"),              MODRM|VAR_NAME4,    PARAM_XMM,          PARAM_XMM64,            0               },
 	{_T("???\0")
-	 _T("pmovzxwq\0")
-	 _T("???\0")
-	 _T("???"),             MODRM|VAR_NAME4,PARAM_XMM,          PARAM_XMM32,        0               },
+		_T("pmovzxwq\0")
+		_T("???\0")
+		_T("???"),              MODRM|VAR_NAME4,    PARAM_XMM,          PARAM_XMM32,            0               },
 	{_T("???\0")
-	 _T("pmovzxdq\0")
-	 _T("???\0")
-	 _T("???"),             MODRM|VAR_NAME4,PARAM_XMM,          PARAM_XMM64,        0               },
-	{_T("???"),             0,              0,                  0,                  0               },
+		_T("pmovzxdq\0")
+		_T("???\0")
+		_T("???"),              MODRM|VAR_NAME4,    PARAM_XMM,          PARAM_XMM64,            0               },
+	{_T("???"),             0,              0,          0,              0               },
 	{_T("???\0")
-	 _T("pcmpgtq\0")
-	 _T("???\0")
-	 _T("???"),             MODRM|VAR_NAME4,PARAM_XMM,          PARAM_XMMM,         0               },
+		_T("pcmpgtq\0")
+		_T("???\0")
+		_T("???"),              MODRM|VAR_NAME4,    PARAM_XMM,          PARAM_XMMM,         0               },
 	{_T("???\0")
-	 _T("pminsb\0")
-	 _T("???\0")
-	 _T("???"),             MODRM|VAR_NAME4,PARAM_XMM,          PARAM_XMMM,         0               },
+		_T("pminsb\0")
+		_T("???\0")
+		_T("???"),              MODRM|VAR_NAME4,    PARAM_XMM,          PARAM_XMMM,         0               },
 	{_T("???\0")
-	 _T("pminsd\0")
-	 _T("???\0")
-	 _T("???"),             MODRM|VAR_NAME4,PARAM_XMM,          PARAM_XMMM,         0               },
+		_T("pminsd\0")
+		_T("???\0")
+		_T("???"),              MODRM|VAR_NAME4,    PARAM_XMM,          PARAM_XMMM,         0               },
 	{_T("???\0")
-	 _T("pminuw\0")
-	 _T("???\0")
-	 _T("???"),             MODRM|VAR_NAME4,PARAM_XMM,          PARAM_XMMM,         0               },
+		_T("pminuw\0")
+		_T("???\0")
+		_T("???"),              MODRM|VAR_NAME4,    PARAM_XMM,          PARAM_XMMM,         0               },
 	{_T("???\0")
-	 _T("pminud\0")
-	 _T("???\0")
-	 _T("???"),             MODRM|VAR_NAME4,PARAM_XMM,          PARAM_XMMM,         0               },
+		_T("pminud\0")
+		_T("???\0")
+		_T("???"),              MODRM|VAR_NAME4,    PARAM_XMM,          PARAM_XMMM,         0               },
 	{_T("???\0")
-	 _T("pmaxsb\0")
-	 _T("???\0")
-	 _T("???"),             MODRM|VAR_NAME4,PARAM_XMM,          PARAM_XMMM,         0               },
+		_T("pmaxsb\0")
+		_T("???\0")
+		_T("???"),              MODRM|VAR_NAME4,    PARAM_XMM,          PARAM_XMMM,         0               },
 	{_T("???\0")
-	 _T("pmaxsd\0")
-	 _T("???\0")
-	 _T("???"),             MODRM|VAR_NAME4,PARAM_XMM,          PARAM_XMMM,         0               },
+		_T("pmaxsd\0")
+		_T("???\0")
+		_T("???"),              MODRM|VAR_NAME4,    PARAM_XMM,          PARAM_XMMM,         0               },
 	{_T("???\0")
-	 _T("pmaxuw\0")
-	 _T("???\0")
-	 _T("???"),             MODRM|VAR_NAME4,PARAM_XMM,          PARAM_XMMM,         0               },
+		_T("pmaxuw\0")
+		_T("???\0")
+		_T("???"),              MODRM|VAR_NAME4,    PARAM_XMM,          PARAM_XMMM,         0               },
 	{_T("???\0")
-	 _T("pmaxud\0")
-	 _T("???\0")
-	 _T("???"),             MODRM|VAR_NAME4,PARAM_XMM,          PARAM_XMMM,         0               },
+		_T("pmaxud\0")
+		_T("???\0")
+		_T("???"),              MODRM|VAR_NAME4,    PARAM_XMM,          PARAM_XMMM,         0               },
 	// 0x40
 	{_T("???\0")
-	 _T("pmulld\0")
-	 _T("???\0")
-	 _T("???"),             MODRM|VAR_NAME4,PARAM_XMM,          PARAM_XMMM,         0               },
+		_T("pmulld\0")
+		_T("???\0")
+		_T("???"),              MODRM|VAR_NAME4,    PARAM_XMM,          PARAM_XMMM,         0               },
 	{_T("???\0")
-	 _T("phminposuw\0")
-	 _T("???\0")
-	 _T("???"),             MODRM|VAR_NAME4,PARAM_XMM,          PARAM_XMMM,         0               },
-	{_T("???"),             0,              0,                  0,                  0               },
-	{_T("???"),             0,              0,                  0,                  0               },
-	{_T("???"),             0,              0,                  0,                  0               },
-	{_T("???"),             0,              0,                  0,                  0               },
-	{_T("???"),             0,              0,                  0,                  0               },
-	{_T("???"),             0,              0,                  0,                  0               },
-	{_T("???"),             0,              0,                  0,                  0               },
-	{_T("???"),             0,              0,                  0,                  0               },
-	{_T("???"),             0,              0,                  0,                  0               },
-	{_T("???"),             0,              0,                  0,                  0               },
-	{_T("???"),             0,              0,                  0,                  0               },
-	{_T("???"),             0,              0,                  0,                  0               },
-	{_T("???"),             0,              0,                  0,                  0               },
-	{_T("???"),             0,              0,                  0,                  0               },
+		_T("phminposuw\0")
+		_T("???\0")
+		_T("???"),              MODRM|VAR_NAME4,    PARAM_XMM,          PARAM_XMMM,         0               },
+	{_T("???"),             0,              0,          0,              0               },
+	{_T("???"),             0,              0,          0,              0               },
+	{_T("???"),             0,              0,          0,              0               },
+	{_T("???"),             0,              0,          0,              0               },
+	{_T("???"),             0,              0,          0,              0               },
+	{_T("???"),             0,              0,          0,              0               },
+	{_T("???"),             0,              0,          0,              0               },
+	{_T("???"),             0,              0,          0,              0               },
+	{_T("???"),             0,              0,          0,              0               },
+	{_T("???"),             0,              0,          0,              0               },
+	{_T("???"),             0,              0,          0,              0               },
+	{_T("???"),             0,              0,          0,              0               },
+	{_T("???"),             0,              0,          0,              0               },
+	{_T("???"),             0,              0,          0,              0               },
 	// 0x50
-	{_T("???"),             0,              0,                  0,                  0               },
-	{_T("???"),             0,              0,                  0,                  0               },
-	{_T("???"),             0,              0,                  0,                  0               },
-	{_T("???"),             0,              0,                  0,                  0               },
-	{_T("???"),             0,              0,                  0,                  0               },
-	{_T("???"),             0,              0,                  0,                  0               },
-	{_T("???"),             0,              0,                  0,                  0               },
-	{_T("???"),             0,              0,                  0,                  0               },
-	{_T("???"),             0,              0,                  0,                  0               },
-	{_T("???"),             0,              0,                  0,                  0               },
-	{_T("???"),             0,              0,                  0,                  0               },
-	{_T("???"),             0,              0,                  0,                  0               },
-	{_T("???"),             0,              0,                  0,                  0               },
-	{_T("???"),             0,              0,                  0,                  0               },
-	{_T("???"),             0,              0,                  0,                  0               },
-	{_T("???"),             0,              0,                  0,                  0               },
+	{_T("???"),             0,              0,          0,              0               },
+	{_T("???"),             0,              0,          0,              0               },
+	{_T("???"),             0,              0,          0,              0               },
+	{_T("???"),             0,              0,          0,              0               },
+	{_T("???"),             0,              0,          0,              0               },
+	{_T("???"),             0,              0,          0,              0               },
+	{_T("???"),             0,              0,          0,              0               },
+	{_T("???"),             0,              0,          0,              0               },
+	{_T("???"),             0,              0,          0,              0               },
+	{_T("???"),             0,              0,          0,              0               },
+	{_T("???"),             0,              0,          0,              0               },
+	{_T("???"),             0,              0,          0,              0               },
+	{_T("???"),             0,              0,          0,              0               },
+	{_T("???"),             0,              0,          0,              0               },
+	{_T("???"),             0,              0,          0,              0               },
+	{_T("???"),             0,              0,          0,              0               },
 	// 0x60
-	{_T("???"),             0,              0,                  0,                  0               },
-	{_T("???"),             0,              0,                  0,                  0               },
-	{_T("???"),             0,              0,                  0,                  0               },
-	{_T("???"),             0,              0,                  0,                  0               },
-	{_T("???"),             0,              0,                  0,                  0               },
-	{_T("???"),             0,              0,                  0,                  0               },
-	{_T("???"),             0,              0,                  0,                  0               },
-	{_T("???"),             0,              0,                  0,                  0               },
-	{_T("???"),             0,              0,                  0,                  0               },
-	{_T("???"),             0,              0,                  0,                  0               },
-	{_T("???"),             0,              0,                  0,                  0               },
-	{_T("???"),             0,              0,                  0,                  0               },
-	{_T("???"),             0,              0,                  0,                  0               },
-	{_T("???"),             0,              0,                  0,                  0               },
-	{_T("???"),             0,              0,                  0,                  0               },
-	{_T("???"),             0,              0,                  0,                  0               },
+	{_T("???"),             0,              0,          0,              0               },
+	{_T("???"),             0,              0,          0,              0               },
+	{_T("???"),             0,              0,          0,              0               },
+	{_T("???"),             0,              0,          0,              0               },
+	{_T("???"),             0,              0,          0,              0               },
+	{_T("???"),             0,              0,          0,              0               },
+	{_T("???"),             0,              0,          0,              0               },
+	{_T("???"),             0,              0,          0,              0               },
+	{_T("???"),             0,              0,          0,              0               },
+	{_T("???"),             0,              0,          0,              0               },
+	{_T("???"),             0,              0,          0,              0               },
+	{_T("???"),             0,              0,          0,              0               },
+	{_T("???"),             0,              0,          0,              0               },
+	{_T("???"),             0,              0,          0,              0               },
+	{_T("???"),             0,              0,          0,              0               },
+	{_T("???"),             0,              0,          0,              0               },
 	// 0x70
-	{_T("???"),             0,              0,                  0,                  0               },
-	{_T("???"),             0,              0,                  0,                  0               },
-	{_T("???"),             0,              0,                  0,                  0               },
-	{_T("???"),             0,              0,                  0,                  0               },
-	{_T("???"),             0,              0,                  0,                  0               },
-	{_T("???"),             0,              0,                  0,                  0               },
-	{_T("???"),             0,              0,                  0,                  0               },
-	{_T("???"),             0,              0,                  0,                  0               },
-	{_T("???"),             0,              0,                  0,                  0               },
-	{_T("???"),             0,              0,                  0,                  0               },
-	{_T("???"),             0,              0,                  0,                  0               },
-	{_T("???"),             0,              0,                  0,                  0               },
-	{_T("???"),             0,              0,                  0,                  0               },
-	{_T("???"),             0,              0,                  0,                  0               },
-	{_T("???"),             0,              0,                  0,                  0               },
-	{_T("???"),             0,              0,                  0,                  0               },
+	{_T("???"),             0,              0,          0,              0               },
+	{_T("???"),             0,              0,          0,              0               },
+	{_T("???"),             0,              0,          0,              0               },
+	{_T("???"),             0,              0,          0,              0               },
+	{_T("???"),             0,              0,          0,              0               },
+	{_T("???"),             0,              0,          0,              0               },
+	{_T("???"),             0,              0,          0,              0               },
+	{_T("???"),             0,              0,          0,              0               },
+	{_T("???"),             0,              0,          0,              0               },
+	{_T("???"),             0,              0,          0,              0               },
+	{_T("???"),             0,              0,          0,              0               },
+	{_T("???"),             0,              0,          0,              0               },
+	{_T("???"),             0,              0,          0,              0               },
+	{_T("???"),             0,              0,          0,              0               },
+	{_T("???"),             0,              0,          0,              0               },
+	{_T("???"),             0,              0,          0,              0               },
 	// 0x80
 	{_T("???\0")
-	 _T("invept\0")
-	 _T("???\0")
-	 _T("???"),             MODRM|VAR_NAME4,PARAM_REG32,        PARAM_XMMM,         0               },
+		_T("invept\0")
+		_T("???\0")
+		_T("???"),              MODRM|VAR_NAME4,    PARAM_REG32,            PARAM_XMMM,         0               },
 	{_T("???\0")
-	 _T("invvpid\0")
-	 _T("???\0")
-	 _T("???"),             MODRM|VAR_NAME4,PARAM_REG32,        PARAM_XMMM,         0               },
+		_T("invvpid\0")
+		_T("???\0")
+		_T("???"),              MODRM|VAR_NAME4,    PARAM_REG32,            PARAM_XMMM,         0               },
 	{_T("???\0")
-	 _T("invpcid\0")
-	 _T("???\0")
-	 _T("???"),             MODRM|VAR_NAME4,PARAM_REG32,        PARAM_XMMM,         0               },
-	{_T("???"),             0,              0,                  0,                  0               },
-	{_T("???"),             0,              0,                  0,                  0               },
-	{_T("???"),             0,              0,                  0,                  0               },
-	{_T("???"),             0,              0,                  0,                  0               },
-	{_T("???"),             0,              0,                  0,                  0               },
-	{_T("???"),             0,              0,                  0,                  0               },
-	{_T("???"),             0,              0,                  0,                  0               },
-	{_T("???"),             0,              0,                  0,                  0               },
-	{_T("???"),             0,              0,                  0,                  0               },
-	{_T("???"),             0,              0,                  0,                  0               },
-	{_T("???"),             0,              0,                  0,                  0               },
-	{_T("???"),             0,              0,                  0,                  0               },
-	{_T("???"),             0,              0,                  0,                  0               },
+		_T("invpcid\0")
+		_T("???\0")
+		_T("???"),              MODRM|VAR_NAME4,    PARAM_REG32,            PARAM_XMMM,         0               },
+	{_T("???"),             0,              0,          0,              0               },
+	{_T("???"),             0,              0,          0,              0               },
+	{_T("???"),             0,              0,          0,              0               },
+	{_T("???"),             0,              0,          0,              0               },
+	{_T("???"),             0,              0,          0,              0               },
+	{_T("???"),             0,              0,          0,              0               },
+	{_T("???"),             0,              0,          0,              0               },
+	{_T("???"),             0,              0,          0,              0               },
+	{_T("???"),             0,              0,          0,              0               },
+	{_T("???"),             0,              0,          0,              0               },
+	{_T("???"),             0,              0,          0,              0               },
+	{_T("???"),             0,              0,          0,              0               },
+	{_T("???"),             0,              0,          0,              0               },
 	// 0x90
-	{_T("???"),             0,              0,                  0,                  0               },
-	{_T("???"),             0,              0,                  0,                  0               },
-	{_T("???"),             0,              0,                  0,                  0               },
-	{_T("???"),             0,              0,                  0,                  0               },
-	{_T("???"),             0,              0,                  0,                  0               },
-	{_T("???"),             0,              0,                  0,                  0               },
-	{_T("???"),             0,              0,                  0,                  0               },
-	{_T("???"),             0,              0,                  0,                  0               },
-	{_T("???"),             0,              0,                  0,                  0               },
-	{_T("???"),             0,              0,                  0,                  0               },
-	{_T("???"),             0,              0,                  0,                  0               },
-	{_T("???"),             0,              0,                  0,                  0               },
-	{_T("???"),             0,              0,                  0,                  0               },
-	{_T("???"),             0,              0,                  0,                  0               },
-	{_T("???"),             0,              0,                  0,                  0               },
-	{_T("???"),             0,              0,                  0,                  0               },
+	{_T("???"),             0,              0,          0,              0               },
+	{_T("???"),             0,              0,          0,              0               },
+	{_T("???"),             0,              0,          0,              0               },
+	{_T("???"),             0,              0,          0,              0               },
+	{_T("???"),             0,              0,          0,              0               },
+	{_T("???"),             0,              0,          0,              0               },
+	{_T("???"),             0,              0,          0,              0               },
+	{_T("???"),             0,              0,          0,              0               },
+	{_T("???"),             0,              0,          0,              0               },
+	{_T("???"),             0,              0,          0,              0               },
+	{_T("???"),             0,              0,          0,              0               },
+	{_T("???"),             0,              0,          0,              0               },
+	{_T("???"),             0,              0,          0,              0               },
+	{_T("???"),             0,              0,          0,              0               },
+	{_T("???"),             0,              0,          0,              0               },
+	{_T("???"),             0,              0,          0,              0               },
 	// 0xa0
-	{_T("???"),             0,              0,                  0,                  0               },
-	{_T("???"),             0,              0,                  0,                  0               },
-	{_T("???"),             0,              0,                  0,                  0               },
-	{_T("???"),             0,              0,                  0,                  0               },
-	{_T("???"),             0,              0,                  0,                  0               },
-	{_T("???"),             0,              0,                  0,                  0               },
-	{_T("???"),             0,              0,                  0,                  0               },
-	{_T("???"),             0,              0,                  0,                  0               },
-	{_T("???"),             0,              0,                  0,                  0               },
-	{_T("???"),             0,              0,                  0,                  0               },
-	{_T("???"),             0,              0,                  0,                  0               },
-	{_T("???"),             0,              0,                  0,                  0               },
-	{_T("???"),             0,              0,                  0,                  0               },
-	{_T("???"),             0,              0,                  0,                  0               },
-	{_T("???"),             0,              0,                  0,                  0               },
-	{_T("???"),             0,              0,                  0,                  0               },
+	{_T("???"),             0,              0,          0,              0               },
+	{_T("???"),             0,              0,          0,              0               },
+	{_T("???"),             0,              0,          0,              0               },
+	{_T("???"),             0,              0,          0,              0               },
+	{_T("???"),             0,              0,          0,              0               },
+	{_T("???"),             0,              0,          0,              0               },
+	{_T("???"),             0,              0,          0,              0               },
+	{_T("???"),             0,              0,          0,              0               },
+	{_T("???"),             0,              0,          0,              0               },
+	{_T("???"),             0,              0,          0,              0               },
+	{_T("???"),             0,              0,          0,              0               },
+	{_T("???"),             0,              0,          0,              0               },
+	{_T("???"),             0,              0,          0,              0               },
+	{_T("???"),             0,              0,          0,              0               },
+	{_T("???"),             0,              0,          0,              0               },
+	{_T("???"),             0,              0,          0,              0               },
 	// 0xb0
-	{_T("???"),             0,              0,                  0,                  0               },
-	{_T("???"),             0,              0,                  0,                  0               },
-	{_T("???"),             0,              0,                  0,                  0               },
-	{_T("???"),             0,              0,                  0,                  0               },
-	{_T("???"),             0,              0,                  0,                  0               },
-	{_T("???"),             0,              0,                  0,                  0               },
-	{_T("???"),             0,              0,                  0,                  0               },
-	{_T("???"),             0,              0,                  0,                  0               },
-	{_T("???"),             0,              0,                  0,                  0               },
-	{_T("???"),             0,              0,                  0,                  0               },
-	{_T("???"),             0,              0,                  0,                  0               },
-	{_T("???"),             0,              0,                  0,                  0               },
-	{_T("???"),             0,              0,                  0,                  0               },
-	{_T("???"),             0,              0,                  0,                  0               },
-	{_T("???"),             0,              0,                  0,                  0               },
-	{_T("???"),             0,              0,                  0,                  0               },
+	{_T("???"),             0,              0,          0,              0               },
+	{_T("???"),             0,              0,          0,              0               },
+	{_T("???"),             0,              0,          0,              0               },
+	{_T("???"),             0,              0,          0,              0               },
+	{_T("???"),             0,              0,          0,              0               },
+	{_T("???"),             0,              0,          0,              0               },
+	{_T("???"),             0,              0,          0,              0               },
+	{_T("???"),             0,              0,          0,              0               },
+	{_T("???"),             0,              0,          0,              0               },
+	{_T("???"),             0,              0,          0,              0               },
+	{_T("???"),             0,              0,          0,              0               },
+	{_T("???"),             0,              0,          0,              0               },
+	{_T("???"),             0,              0,          0,              0               },
+	{_T("???"),             0,              0,          0,              0               },
+	{_T("???"),             0,              0,          0,              0               },
+	{_T("???"),             0,              0,          0,              0               },
 	// 0xc0
-	{_T("???"),             0,              0,                  0,                  0               },
-	{_T("???"),             0,              0,                  0,                  0               },
-	{_T("???"),             0,              0,                  0,                  0               },
-	{_T("???"),             0,              0,                  0,                  0               },
-	{_T("???"),             0,              0,                  0,                  0               },
-	{_T("???"),             0,              0,                  0,                  0               },
-	{_T("???"),             0,              0,                  0,                  0               },
-	{_T("???"),             0,              0,                  0,                  0               },
-	{_T("???"),             0,              0,                  0,                  0               },
-	{_T("???"),             0,              0,                  0,                  0               },
-	{_T("???"),             0,              0,                  0,                  0               },
-	{_T("???"),             0,              0,                  0,                  0               },
-	{_T("???"),             0,              0,                  0,                  0               },
-	{_T("???"),             0,              0,                  0,                  0               },
-	{_T("???"),             0,              0,                  0,                  0               },
-	{_T("???"),             0,              0,                  0,                  0               },
+	{_T("???"),             0,              0,          0,              0               },
+	{_T("???"),             0,              0,          0,              0               },
+	{_T("???"),             0,              0,          0,              0               },
+	{_T("???"),             0,              0,          0,              0               },
+	{_T("???"),             0,              0,          0,              0               },
+	{_T("???"),             0,              0,          0,              0               },
+	{_T("???"),             0,              0,          0,              0               },
+	{_T("???"),             0,              0,          0,              0               },
+	{_T("???"),             0,              0,          0,              0               },
+	{_T("???"),             0,              0,          0,              0               },
+	{_T("???"),             0,              0,          0,              0               },
+	{_T("???"),             0,              0,          0,              0               },
+	{_T("???"),             0,              0,          0,              0               },
+	{_T("???"),             0,              0,          0,              0               },
+	{_T("???"),             0,              0,          0,              0               },
+	{_T("???"),             0,              0,          0,              0               },
 	// 0xd0
-	{_T("???"),             0,              0,                  0,                  0               },
-	{_T("???"),             0,              0,                  0,                  0               },
-	{_T("???"),             0,              0,                  0,                  0               },
-	{_T("???"),             0,              0,                  0,                  0               },
-	{_T("???"),             0,              0,                  0,                  0               },
-	{_T("???"),             0,              0,                  0,                  0               },
-	{_T("???"),             0,              0,                  0,                  0               },
-	{_T("???"),             0,              0,                  0,                  0               },
-	{_T("???"),             0,              0,                  0,                  0               },
-	{_T("???"),             0,              0,                  0,                  0               },
-	{_T("???"),             0,              0,                  0,                  0               },
+	{_T("???"),             0,              0,          0,              0               },
+	{_T("???"),             0,              0,          0,              0               },
+	{_T("???"),             0,              0,          0,              0               },
+	{_T("???"),             0,              0,          0,              0               },
+	{_T("???"),             0,              0,          0,              0               },
+	{_T("???"),             0,              0,          0,              0               },
+	{_T("???"),             0,              0,          0,              0               },
+	{_T("???"),             0,              0,          0,              0               },
+	{_T("???"),             0,              0,          0,              0               },
+	{_T("???"),             0,              0,          0,              0               },
+	{_T("???"),             0,              0,          0,              0               },
 	{_T("???\0")
-	 _T("aesimc\0")
-	 _T("???\0")
-	 _T("???"),             MODRM|VAR_NAME4,PARAM_XMM,          PARAM_XMMM,         0               },
+		_T("aesimc\0")
+		_T("???\0")
+		_T("???"),              MODRM|VAR_NAME4,    PARAM_XMM,          PARAM_XMMM,         0               },
 	{_T("???\0")
-	 _T("aesenc\0")
-	 _T("???\0")
-	 _T("???"),             MODRM|VAR_NAME4,PARAM_XMM,          PARAM_XMMM,         0               },
+		_T("aesenc\0")
+		_T("???\0")
+		_T("???"),              MODRM|VAR_NAME4,    PARAM_XMM,          PARAM_XMMM,         0               },
 	{_T("???\0")
-	 _T("aesenclast\0")
-	 _T("???\0")
-	 _T("???"),             MODRM|VAR_NAME4,PARAM_XMM,          PARAM_XMMM,         0               },
+		_T("aesenclast\0")
+		_T("???\0")
+		_T("???"),              MODRM|VAR_NAME4,    PARAM_XMM,          PARAM_XMMM,         0               },
 	{_T("???\0")
-	 _T("aesdec\0")
-	 _T("???\0")
-	 _T("???"),             MODRM|VAR_NAME4,PARAM_XMM,          PARAM_XMMM,         0               },
+		_T("aesdec\0")
+		_T("???\0")
+		_T("???"),              MODRM|VAR_NAME4,    PARAM_XMM,          PARAM_XMMM,         0               },
 	{_T("???\0")
-	 _T("aesdeclast\0")
-	 _T("???\0")
-	 _T("???"),             MODRM|VAR_NAME4,PARAM_XMM,          PARAM_XMMM,         0               },
+		_T("aesdeclast\0")
+		_T("???\0")
+		_T("???"),              MODRM|VAR_NAME4,    PARAM_XMM,          PARAM_XMMM,         0               },
 	// 0xe0
-	{_T("???"),             0,              0,                  0,                  0               },
-	{_T("???"),             0,              0,                  0,                  0               },
-	{_T("???"),             0,              0,                  0,                  0               },
-	{_T("???"),             0,              0,                  0,                  0               },
-	{_T("???"),             0,              0,                  0,                  0               },
-	{_T("???"),             0,              0,                  0,                  0               },
-	{_T("???"),             0,              0,                  0,                  0               },
-	{_T("???"),             0,              0,                  0,                  0               },
-	{_T("???"),             0,              0,                  0,                  0               },
-	{_T("???"),             0,              0,                  0,                  0               },
-	{_T("???"),             0,              0,                  0,                  0               },
-	{_T("???"),             0,              0,                  0,                  0               },
-	{_T("???"),             0,              0,                  0,                  0               },
-	{_T("???"),             0,              0,                  0,                  0               },
-	{_T("???"),             0,              0,                  0,                  0               },
-	{_T("???"),             0,              0,                  0,                  0               },
+	{_T("???"),             0,              0,          0,              0               },
+	{_T("???"),             0,              0,          0,              0               },
+	{_T("???"),             0,              0,          0,              0               },
+	{_T("???"),             0,              0,          0,              0               },
+	{_T("???"),             0,              0,          0,              0               },
+	{_T("???"),             0,              0,          0,              0               },
+	{_T("???"),             0,              0,          0,              0               },
+	{_T("???"),             0,              0,          0,              0               },
+	{_T("???"),             0,              0,          0,              0               },
+	{_T("???"),             0,              0,          0,              0               },
+	{_T("???"),             0,              0,          0,              0               },
+	{_T("???"),             0,              0,          0,              0               },
+	{_T("???"),             0,              0,          0,              0               },
+	{_T("???"),             0,              0,          0,              0               },
+	{_T("???"),             0,              0,          0,              0               },
+	{_T("???"),             0,              0,          0,              0               },
 	// 0xf0
 	{_T("movbe\0")
-	 _T("???\0")
-	 _T("crc32\0")
-	 _T("???"),             MODRM|VAR_NAME4,PARAM_REG32,        PARAM_RMPTR,        0               }, // not quite correct
+		_T("???\0")
+		_T("crc32\0")
+		_T("???"),              MODRM|VAR_NAME4,    PARAM_REG32,            PARAM_RMPTR,            0               }, // not quite correct
 	{_T("movbe\0")
-	 _T("???\0")
-	 _T("crc32\0")
-	 _T("???"),             MODRM|VAR_NAME4,PARAM_RMPTR,        PARAM_REG32,        0               }, // not quite correct
-	{_T("???"),             0,              0,                  0,                  0               },
-	{_T("???"),             0,              0,                  0,                  0               },
-	{_T("???"),             0,              0,                  0,                  0               },
-	{_T("???"),             0,              0,                  0,                  0               },
-	{_T("???"),             0,              0,                  0,                  0               },
-	{_T("???"),             0,              0,                  0,                  0               },
-	{_T("???"),             0,              0,                  0,                  0               },
-	{_T("???"),             0,              0,                  0,                  0               },
-	{_T("???"),             0,              0,                  0,                  0               },
-	{_T("???"),             0,              0,                  0,                  0               },
-	{_T("???"),             0,              0,                  0,                  0               },
-	{_T("???"),             0,              0,                  0,                  0               },
-	{_T("???"),             0,              0,                  0,                  0               },
-	{_T("???"),             0,              0,                  0,                  0               },
+		_T("???\0")
+		_T("crc32\0")
+		_T("???"),              MODRM|VAR_NAME4,    PARAM_RMPTR,            PARAM_REG32,            0               }, // not quite correct
+	{_T("???"),             0,              0,          0,              0               },
+	{_T("???"),             0,              0,          0,              0               },
+	{_T("???"),             0,              0,          0,              0               },
+	{_T("???"),             0,              0,          0,              0               },
+	{_T("???"),             0,              0,          0,              0               },
+	{_T("???"),             0,              0,          0,              0               },
+	{_T("???"),             0,              0,          0,              0               },
+	{_T("???"),             0,              0,          0,              0               },
+	{_T("???"),             0,              0,          0,              0               },
+	{_T("???"),             0,              0,          0,              0               },
+	{_T("???"),             0,              0,          0,              0               },
+	{_T("???"),             0,              0,          0,              0               },
+	{_T("???"),             0,              0,          0,              0               },
+	{_T("???"),             0,              0,          0,              0               },
 };
 
 static const I386_OPCODE i386_opcode_table0F3A[256] =
 {
 	// 0x00
-	{_T("???"),             0,              0,                  0,                  0               },
-	{_T("???"),             0,              0,                  0,                  0               },
-	{_T("???"),             0,              0,                  0,                  0               },
-	{_T("???"),             0,              0,                  0,                  0               },
-	{_T("???"),             0,              0,                  0,                  0               },
-	{_T("???"),             0,              0,                  0,                  0               },
-	{_T("???"),             0,              0,                  0,                  0               },
-	{_T("???"),             0,              0,                  0,                  0               },
+	{_T("???"),             0,              0,          0,              0               },
+	{_T("???"),             0,              0,          0,              0               },
+	{_T("???"),             0,              0,          0,              0               },
+	{_T("???"),             0,              0,          0,              0               },
+	{_T("???"),             0,              0,          0,              0               },
+	{_T("???"),             0,              0,          0,              0               },
+	{_T("???"),             0,              0,          0,              0               },
+	{_T("???"),             0,              0,          0,              0               },
 	{_T("???\0")
-	 _T("roundps\0")
-	 _T("???\0")
-	 _T("???"),             MODRM|VAR_NAME4,PARAM_XMM,          PARAM_XMMM,         PARAM_UI8       },
+		_T("roundps\0")
+		_T("???\0")
+		_T("???"),              MODRM|VAR_NAME4,    PARAM_XMM,          PARAM_XMMM,         PARAM_UI8           },
 	{_T("???\0")
-	 _T("roundpd\0")
-	 _T("???\0")
-	 _T("???"),             MODRM|VAR_NAME4,PARAM_XMM,          PARAM_XMMM,         PARAM_UI8       },
+		_T("roundpd\0")
+		_T("???\0")
+		_T("???"),              MODRM|VAR_NAME4,    PARAM_XMM,          PARAM_XMMM,         PARAM_UI8           },
 	{_T("???\0")
-	 _T("roundss\0")
-	 _T("???\0")
-	 _T("???"),             MODRM|VAR_NAME4,PARAM_XMM,          PARAM_XMMM,         PARAM_UI8       },
+		_T("roundss\0")
+		_T("???\0")
+		_T("???"),              MODRM|VAR_NAME4,    PARAM_XMM,          PARAM_XMMM,         PARAM_UI8           },
 	{_T("???\0")
-	 _T("roundsd\0")
-	 _T("???\0")
-	 _T("???"),             MODRM|VAR_NAME4,PARAM_XMM,          PARAM_XMMM,         PARAM_UI8       },
+		_T("roundsd\0")
+		_T("???\0")
+		_T("???"),              MODRM|VAR_NAME4,    PARAM_XMM,          PARAM_XMMM,         PARAM_UI8           },
 	{_T("???\0")
-	 _T("blendps\0")
-	 _T("???\0")
-	 _T("???"),             MODRM|VAR_NAME4,PARAM_XMM,          PARAM_XMMM,         PARAM_UI8       },
+		_T("blendps\0")
+		_T("???\0")
+		_T("???"),              MODRM|VAR_NAME4,    PARAM_XMM,          PARAM_XMMM,         PARAM_UI8           },
 	{_T("???\0")
-	 _T("blendpd\0")
-	 _T("???\0")
-	 _T("???"),             MODRM|VAR_NAME4,PARAM_XMM,          PARAM_XMMM,         PARAM_UI8       },
+		_T("blendpd\0")
+		_T("???\0")
+		_T("???"),              MODRM|VAR_NAME4,    PARAM_XMM,          PARAM_XMMM,         PARAM_UI8           },
 	{_T("???\0")
-	 _T("pblendw\0")
-	 _T("???\0")
-	 _T("???"),             MODRM|VAR_NAME4,PARAM_XMM,          PARAM_XMMM,         PARAM_UI8       },
+		_T("pblendw\0")
+		_T("???\0")
+		_T("???"),              MODRM|VAR_NAME4,    PARAM_XMM,          PARAM_XMMM,         PARAM_UI8           },
 	{_T("palignr\0")
-	 _T("palignr\0")
-	 _T("???\0")
-	 _T("???"),             MODRM|VAR_NAME4,PARAM_XMM,          PARAM_XMMM,         PARAM_UI8       },
+		_T("palignr\0")
+		_T("???\0")
+		_T("???"),              MODRM|VAR_NAME4,    PARAM_XMM,          PARAM_XMMM,         PARAM_UI8           },
 	// 0x10
-	{_T("???"),             0,              0,                  0,                  0               },
-	{_T("???"),             0,              0,                  0,                  0               },
-	{_T("???"),             0,              0,                  0,                  0               },
-	{_T("???"),             0,              0,                  0,                  0               },
+	{_T("???"),             0,              0,          0,              0               },
+	{_T("???"),             0,              0,          0,              0               },
+	{_T("???"),             0,              0,          0,              0               },
+	{_T("???"),             0,              0,          0,              0               },
 	{_T("???\0")
-	 _T("pextrb\0")
-	 _T("???\0")
-	 _T("???"),             MODRM|VAR_NAME4,PARAM_RM8,          PARAM_XMM,          PARAM_UI8       },
+		_T("pextrb\0")
+		_T("???\0")
+		_T("???"),              MODRM|VAR_NAME4,    PARAM_RM8,          PARAM_XMM,          PARAM_UI8           },
 	{_T("???\0")
-	 _T("pextrw\0")
-	 _T("???\0")
-	 _T("???"),             MODRM|VAR_NAME4,PARAM_RM16,         PARAM_XMM,          PARAM_UI8       },
+		_T("pextrw\0")
+		_T("???\0")
+		_T("???"),              MODRM|VAR_NAME4,    PARAM_RM16,         PARAM_XMM,          PARAM_UI8           },
 	{_T("???\0")
-	 _T("pextrd\0")
-	 _T("???\0")
-	 _T("???"),             MODRM|VAR_NAME4,PARAM_RM8,          PARAM_XMM,          PARAM_UI8       },
+		_T("pextrd\0")
+		_T("???\0")
+		_T("???"),              MODRM|VAR_NAME4,    PARAM_RM8,          PARAM_XMM,          PARAM_UI8           },
 	{_T("???\0")
-	 _T("extractps\0")
-	 _T("???\0")
-	 _T("???"),             MODRM|VAR_NAME4,PARAM_RM32,         PARAM_XMM,          PARAM_UI8       },
-	{_T("???"),             0,              0,                  0,                  0               },
-	{_T("???"),             0,              0,                  0,                  0               },
-	{_T("???"),             0,              0,                  0,                  0               },
-	{_T("???"),             0,              0,                  0,                  0               },
-	{_T("???"),             0,              0,                  0,                  0               },
-	{_T("???"),             0,              0,                  0,                  0               },
-	{_T("???"),             0,              0,                  0,                  0               },
-	{_T("???"),             0,              0,                  0,                  0               },
+		_T("extractps\0")
+		_T("???\0")
+		_T("???"),              MODRM|VAR_NAME4,    PARAM_RM32,         PARAM_XMM,          PARAM_UI8           },
+	{_T("???"),             0,              0,          0,              0               },
+	{_T("???"),             0,              0,          0,              0               },
+	{_T("???"),             0,              0,          0,              0               },
+	{_T("???"),             0,              0,          0,              0               },
+	{_T("???"),             0,              0,          0,              0               },
+	{_T("???"),             0,              0,          0,              0               },
+	{_T("???"),             0,              0,          0,              0               },
+	{_T("???"),             0,              0,          0,              0               },
 	// 0x20
 	{_T("???\0")
-	 _T("pinsrb\0")
-	 _T("???\0")
-	 _T("???"),             MODRM|VAR_NAME4,PARAM_XMM,          PARAM_RM8,          PARAM_UI8       },
+		_T("pinsrb\0")
+		_T("???\0")
+		_T("???"),              MODRM|VAR_NAME4,    PARAM_XMM,          PARAM_RM8,          PARAM_UI8           },
 	{_T("???\0")
-	 _T("insertps\0")
-	 _T("???\0")
-	 _T("???"),             MODRM|VAR_NAME4,PARAM_XMM,          PARAM_RM8,          PARAM_UI8       },
+		_T("insertps\0")
+		_T("???\0")
+		_T("???"),              MODRM|VAR_NAME4,    PARAM_XMM,          PARAM_RM8,          PARAM_UI8           },
 	{_T("???\0")
-	 _T("pinsrd\0")
-	 _T("???\0")
-	 _T("???"),             MODRM|VAR_NAME4,PARAM_XMM,          PARAM_RM32,         PARAM_UI8       },
-	{_T("???"),             0,              0,                  0,                  0               },
-	{_T("???"),             0,              0,                  0,                  0               },
-	{_T("???"),             0,              0,                  0,                  0               },
-	{_T("???"),             0,              0,                  0,                  0               },
-	{_T("???"),             0,              0,                  0,                  0               },
-	{_T("???"),             0,              0,                  0,                  0               },
-	{_T("???"),             0,              0,                  0,                  0               },
-	{_T("???"),             0,              0,                  0,                  0               },
-	{_T("???"),             0,              0,                  0,                  0               },
-	{_T("???"),             0,              0,                  0,                  0               },
-	{_T("???"),             0,              0,                  0,                  0               },
-	{_T("???"),             0,              0,                  0,                  0               },
-	{_T("???"),             0,              0,                  0,                  0               },
+		_T("pinsrd\0")
+		_T("???\0")
+		_T("???"),              MODRM|VAR_NAME4,    PARAM_XMM,          PARAM_RM32,         PARAM_UI8           },
+	{_T("???"),             0,              0,          0,              0               },
+	{_T("???"),             0,              0,          0,              0               },
+	{_T("???"),             0,              0,          0,              0               },
+	{_T("???"),             0,              0,          0,              0               },
+	{_T("???"),             0,              0,          0,              0               },
+	{_T("???"),             0,              0,          0,              0               },
+	{_T("???"),             0,              0,          0,              0               },
+	{_T("???"),             0,              0,          0,              0               },
+	{_T("???"),             0,              0,          0,              0               },
+	{_T("???"),             0,              0,          0,              0               },
+	{_T("???"),             0,              0,          0,              0               },
+	{_T("???"),             0,              0,          0,              0               },
+	{_T("???"),             0,              0,          0,              0               },
 	// 0x30
-	{_T("???"),             0,              0,                  0,                  0               },
-	{_T("???"),             0,              0,                  0,                  0               },
-	{_T("???"),             0,              0,                  0,                  0               },
-	{_T("???"),             0,              0,                  0,                  0               },
-	{_T("???"),             0,              0,                  0,                  0               },
-	{_T("???"),             0,              0,                  0,                  0               },
-	{_T("???"),             0,              0,                  0,                  0               },
-	{_T("???"),             0,              0,                  0,                  0               },
-	{_T("???"),             0,              0,                  0,                  0               },
-	{_T("???"),             0,              0,                  0,                  0               },
-	{_T("???"),             0,              0,                  0,                  0               },
-	{_T("???"),             0,              0,                  0,                  0               },
-	{_T("???"),             0,              0,                  0,                  0               },
-	{_T("???"),             0,              0,                  0,                  0               },
-	{_T("???"),             0,              0,                  0,                  0               },
-	{_T("???"),             0,              0,                  0,                  0               },
+	{_T("???"),             0,              0,          0,              0               },
+	{_T("???"),             0,              0,          0,              0               },
+	{_T("???"),             0,              0,          0,              0               },
+	{_T("???"),             0,              0,          0,              0               },
+	{_T("???"),             0,              0,          0,              0               },
+	{_T("???"),             0,              0,          0,              0               },
+	{_T("???"),             0,              0,          0,              0               },
+	{_T("???"),             0,              0,          0,              0               },
+	{_T("???"),             0,              0,          0,              0               },
+	{_T("???"),             0,              0,          0,              0               },
+	{_T("???"),             0,              0,          0,              0               },
+	{_T("???"),             0,              0,          0,              0               },
+	{_T("???"),             0,              0,          0,              0               },
+	{_T("???"),             0,              0,          0,              0               },
+	{_T("???"),             0,              0,          0,              0               },
+	{_T("???"),             0,              0,          0,              0               },
 	// 0x40
 	{_T("???\0")
-	 _T("dpps\0")
-	 _T("???\0")
-	 _T("???"),             MODRM|VAR_NAME4,PARAM_XMM,          PARAM_XMMM,         PARAM_UI8       },
+		_T("dpps\0")
+		_T("???\0")
+		_T("???"),              MODRM|VAR_NAME4,    PARAM_XMM,          PARAM_XMMM,         PARAM_UI8           },
 	{_T("???\0")
-	 _T("dppd\0")
-	 _T("???\0")
-	 _T("???"),             MODRM|VAR_NAME4,PARAM_XMM,          PARAM_XMMM,         PARAM_UI8       },
+		_T("dppd\0")
+		_T("???\0")
+		_T("???"),              MODRM|VAR_NAME4,    PARAM_XMM,          PARAM_XMMM,         PARAM_UI8           },
 	{_T("???\0")
-	 _T("mpsadbw\0")
-	 _T("???\0")
-	 _T("???"),             MODRM|VAR_NAME4,PARAM_XMM,          PARAM_XMMM,         PARAM_UI8       },
-	{_T("???"),             0,              0,                  0,                  0               },
+		_T("mpsadbw\0")
+		_T("???\0")
+		_T("???"),              MODRM|VAR_NAME4,    PARAM_XMM,          PARAM_XMMM,         PARAM_UI8           },
+	{_T("???"),             0,              0,          0,              0               },
 	{_T("???\0")
-	 _T("pclmulqdq\0")
-	 _T("???\0")
-	 _T("???"),             MODRM|VAR_NAME4,PARAM_XMM,          PARAM_XMMM,         PARAM_UI8       },
-	{_T("???"),             0,              0,                  0,                  0               },
-	{_T("???"),             0,              0,                  0,                  0               },
-	{_T("???"),             0,              0,                  0,                  0               },
-	{_T("???"),             0,              0,                  0,                  0               },
-	{_T("???"),             0,              0,                  0,                  0               },
-	{_T("???"),             0,              0,                  0,                  0               },
-	{_T("???"),             0,              0,                  0,                  0               },
-	{_T("???"),             0,              0,                  0,                  0               },
-	{_T("???"),             0,              0,                  0,                  0               },
-	{_T("???"),             0,              0,                  0,                  0               },
-	{_T("???"),             0,              0,                  0,                  0               },
+		_T("pclmulqdq\0")
+		_T("???\0")
+		_T("???"),              MODRM|VAR_NAME4,    PARAM_XMM,          PARAM_XMMM,         PARAM_UI8           },
+	{_T("???"),             0,              0,          0,              0               },
+	{_T("???"),             0,              0,          0,              0               },
+	{_T("???"),             0,              0,          0,              0               },
+	{_T("???"),             0,              0,          0,              0               },
+	{_T("???"),             0,              0,          0,              0               },
+	{_T("???"),             0,              0,          0,              0               },
+	{_T("???"),             0,              0,          0,              0               },
+	{_T("???"),             0,              0,          0,              0               },
+	{_T("???"),             0,              0,          0,              0               },
+	{_T("???"),             0,              0,          0,              0               },
+	{_T("???"),             0,              0,          0,              0               },
 	// 0x50
-	{_T("???"),             0,              0,                  0,                  0               },
-	{_T("???"),             0,              0,                  0,                  0               },
-	{_T("???"),             0,              0,                  0,                  0               },
-	{_T("???"),             0,              0,                  0,                  0               },
-	{_T("???"),             0,              0,                  0,                  0               },
-	{_T("???"),             0,              0,                  0,                  0               },
-	{_T("???"),             0,              0,                  0,                  0               },
-	{_T("???"),             0,              0,                  0,                  0               },
-	{_T("???"),             0,              0,                  0,                  0               },
-	{_T("???"),             0,              0,                  0,                  0               },
-	{_T("???"),             0,              0,                  0,                  0               },
-	{_T("???"),             0,              0,                  0,                  0               },
-	{_T("???"),             0,              0,                  0,                  0               },
-	{_T("???"),             0,              0,                  0,                  0               },
-	{_T("???"),             0,              0,                  0,                  0               },
-	{_T("???"),             0,              0,                  0,                  0               },
+	{_T("???"),             0,              0,          0,              0               },
+	{_T("???"),             0,              0,          0,              0               },
+	{_T("???"),             0,              0,          0,              0               },
+	{_T("???"),             0,              0,          0,              0               },
+	{_T("???"),             0,              0,          0,              0               },
+	{_T("???"),             0,              0,          0,              0               },
+	{_T("???"),             0,              0,          0,              0               },
+	{_T("???"),             0,              0,          0,              0               },
+	{_T("???"),             0,              0,          0,              0               },
+	{_T("???"),             0,              0,          0,              0               },
+	{_T("???"),             0,              0,          0,              0               },
+	{_T("???"),             0,              0,          0,              0               },
+	{_T("???"),             0,              0,          0,              0               },
+	{_T("???"),             0,              0,          0,              0               },
+	{_T("???"),             0,              0,          0,              0               },
+	{_T("???"),             0,              0,          0,              0               },
 	// 0x60
 	{_T("???\0")
-	 _T("pcmestrm\0")
-	 _T("???\0")
-	 _T("???"),             MODRM|VAR_NAME4,PARAM_XMM,          PARAM_XMMM,         PARAM_UI8       },
+		_T("pcmestrm\0")
+		_T("???\0")
+		_T("???"),              MODRM|VAR_NAME4,    PARAM_XMM,          PARAM_XMMM,         PARAM_UI8           },
 	{_T("???\0")
-	 _T("pcmestri\0")
-	 _T("???\0")
-	 _T("???"),             MODRM|VAR_NAME4,PARAM_XMM,          PARAM_XMMM,         PARAM_UI8       },
+		_T("pcmestri\0")
+		_T("???\0")
+		_T("???"),              MODRM|VAR_NAME4,    PARAM_XMM,          PARAM_XMMM,         PARAM_UI8           },
 	{_T("???\0")
-	 _T("pcmistrm\0")
-	 _T("???\0")
-	 _T("???"),             MODRM|VAR_NAME4,PARAM_XMM,          PARAM_XMMM,         PARAM_UI8       },
+		_T("pcmistrm\0")
+		_T("???\0")
+		_T("???"),              MODRM|VAR_NAME4,    PARAM_XMM,          PARAM_XMMM,         PARAM_UI8           },
 	{_T("???\0")
-	 _T("pcmistri\0")
-	 _T("???\0")
-	 _T("???"),             MODRM|VAR_NAME4,PARAM_XMM,          PARAM_XMMM,         PARAM_UI8       },
-	{_T("???"),             0,              0,                  0,                  0               },
-	{_T("???"),             0,              0,                  0,                  0               },
-	{_T("???"),             0,              0,                  0,                  0               },
-	{_T("???"),             0,              0,                  0,                  0               },
-	{_T("???"),             0,              0,                  0,                  0               },
-	{_T("???"),             0,              0,                  0,                  0               },
-	{_T("???"),             0,              0,                  0,                  0               },
-	{_T("???"),             0,              0,                  0,                  0               },
-	{_T("???"),             0,              0,                  0,                  0               },
-	{_T("???"),             0,              0,                  0,                  0               },
-	{_T("???"),             0,              0,                  0,                  0               },
-	{_T("???"),             0,              0,                  0,                  0               },
+		_T("pcmistri\0")
+		_T("???\0")
+		_T("???"),              MODRM|VAR_NAME4,    PARAM_XMM,          PARAM_XMMM,         PARAM_UI8           },
+	{_T("???"),             0,              0,          0,              0               },
+	{_T("???"),             0,              0,          0,              0               },
+	{_T("???"),             0,              0,          0,              0               },
+	{_T("???"),             0,              0,          0,              0               },
+	{_T("???"),             0,              0,          0,              0               },
+	{_T("???"),             0,              0,          0,              0               },
+	{_T("???"),             0,              0,          0,              0               },
+	{_T("???"),             0,              0,          0,              0               },
+	{_T("???"),             0,              0,          0,              0               },
+	{_T("???"),             0,              0,          0,              0               },
+	{_T("???"),             0,              0,          0,              0               },
+	{_T("???"),             0,              0,          0,              0               },
 	// 0x70
-	{_T("???"),             0,              0,                  0,                  0               },
-	{_T("???"),             0,              0,                  0,                  0               },
-	{_T("???"),             0,              0,                  0,                  0               },
-	{_T("???"),             0,              0,                  0,                  0               },
-	{_T("???"),             0,              0,                  0,                  0               },
-	{_T("???"),             0,              0,                  0,                  0               },
-	{_T("???"),             0,              0,                  0,                  0               },
-	{_T("???"),             0,              0,                  0,                  0               },
-	{_T("???"),             0,              0,                  0,                  0               },
-	{_T("???"),             0,              0,                  0,                  0               },
-	{_T("???"),             0,              0,                  0,                  0               },
-	{_T("???"),             0,              0,                  0,                  0               },
-	{_T("???"),             0,              0,                  0,                  0               },
-	{_T("???"),             0,              0,                  0,                  0               },
-	{_T("???"),             0,              0,                  0,                  0               },
-	{_T("???"),             0,              0,                  0,                  0               },
+	{_T("???"),             0,              0,          0,              0               },
+	{_T("???"),             0,              0,          0,              0               },
+	{_T("???"),             0,              0,          0,              0               },
+	{_T("???"),             0,              0,          0,              0               },
+	{_T("???"),             0,              0,          0,              0               },
+	{_T("???"),             0,              0,          0,              0               },
+	{_T("???"),             0,              0,          0,              0               },
+	{_T("???"),             0,              0,          0,              0               },
+	{_T("???"),             0,              0,          0,              0               },
+	{_T("???"),             0,              0,          0,              0               },
+	{_T("???"),             0,              0,          0,              0               },
+	{_T("???"),             0,              0,          0,              0               },
+	{_T("???"),             0,              0,          0,              0               },
+	{_T("???"),             0,              0,          0,              0               },
+	{_T("???"),             0,              0,          0,              0               },
+	{_T("???"),             0,              0,          0,              0               },
 	// 0x80
-	{_T("???"),             0,              0,                  0,                  0               },
-	{_T("???"),             0,              0,                  0,                  0               },
-	{_T("???"),             0,              0,                  0,                  0               },
-	{_T("???"),             0,              0,                  0,                  0               },
-	{_T("???"),             0,              0,                  0,                  0               },
-	{_T("???"),             0,              0,                  0,                  0               },
-	{_T("???"),             0,              0,                  0,                  0               },
-	{_T("???"),             0,              0,                  0,                  0               },
-	{_T("???"),             0,              0,                  0,                  0               },
-	{_T("???"),             0,              0,                  0,                  0               },
-	{_T("???"),             0,              0,                  0,                  0               },
-	{_T("???"),             0,              0,                  0,                  0               },
-	{_T("???"),             0,              0,                  0,                  0               },
-	{_T("???"),             0,              0,                  0,                  0               },
-	{_T("???"),             0,              0,                  0,                  0               },
-	{_T("???"),             0,              0,                  0,                  0               },
+	{_T("???"),             0,              0,          0,              0               },
+	{_T("???"),             0,              0,          0,              0               },
+	{_T("???"),             0,              0,          0,              0               },
+	{_T("???"),             0,              0,          0,              0               },
+	{_T("???"),             0,              0,          0,              0               },
+	{_T("???"),             0,              0,          0,              0               },
+	{_T("???"),             0,              0,          0,              0               },
+	{_T("???"),             0,              0,          0,              0               },
+	{_T("???"),             0,              0,          0,              0               },
+	{_T("???"),             0,              0,          0,              0               },
+	{_T("???"),             0,              0,          0,              0               },
+	{_T("???"),             0,              0,          0,              0               },
+	{_T("???"),             0,              0,          0,              0               },
+	{_T("???"),             0,              0,          0,              0               },
+	{_T("???"),             0,              0,          0,              0               },
+	{_T("???"),             0,              0,          0,              0               },
 	// 0x90
-	{_T("???"),             0,              0,                  0,                  0               },
-	{_T("???"),             0,              0,                  0,                  0               },
-	{_T("???"),             0,              0,                  0,                  0               },
-	{_T("???"),             0,              0,                  0,                  0               },
-	{_T("???"),             0,              0,                  0,                  0               },
-	{_T("???"),             0,              0,                  0,                  0               },
-	{_T("???"),             0,              0,                  0,                  0               },
-	{_T("???"),             0,              0,                  0,                  0               },
-	{_T("???"),             0,              0,                  0,                  0               },
-	{_T("???"),             0,              0,                  0,                  0               },
-	{_T("???"),             0,              0,                  0,                  0               },
-	{_T("???"),             0,              0,                  0,                  0               },
-	{_T("???"),             0,              0,                  0,                  0               },
-	{_T("???"),             0,              0,                  0,                  0               },
-	{_T("???"),             0,              0,                  0,                  0               },
-	{_T("???"),             0,              0,                  0,                  0               },
+	{_T("???"),             0,              0,          0,              0               },
+	{_T("???"),             0,              0,          0,              0               },
+	{_T("???"),             0,              0,          0,              0               },
+	{_T("???"),             0,              0,          0,              0               },
+	{_T("???"),             0,              0,          0,              0               },
+	{_T("???"),             0,              0,          0,              0               },
+	{_T("???"),             0,              0,          0,              0               },
+	{_T("???"),             0,              0,          0,              0               },
+	{_T("???"),             0,              0,          0,              0               },
+	{_T("???"),             0,              0,          0,              0               },
+	{_T("???"),             0,              0,          0,              0               },
+	{_T("???"),             0,              0,          0,              0               },
+	{_T("???"),             0,              0,          0,              0               },
+	{_T("???"),             0,              0,          0,              0               },
+	{_T("???"),             0,              0,          0,              0               },
+	{_T("???"),             0,              0,          0,              0               },
 	// 0xa0
-	{_T("???"),             0,              0,                  0,                  0               },
-	{_T("???"),             0,              0,                  0,                  0               },
-	{_T("???"),             0,              0,                  0,                  0               },
-	{_T("???"),             0,              0,                  0,                  0               },
-	{_T("???"),             0,              0,                  0,                  0               },
-	{_T("???"),             0,              0,                  0,                  0               },
-	{_T("???"),             0,              0,                  0,                  0               },
-	{_T("???"),             0,              0,                  0,                  0               },
-	{_T("???"),             0,              0,                  0,                  0               },
-	{_T("???"),             0,              0,                  0,                  0               },
-	{_T("???"),             0,              0,                  0,                  0               },
-	{_T("???"),             0,              0,                  0,                  0               },
-	{_T("???"),             0,              0,                  0,                  0               },
-	{_T("???"),             0,              0,                  0,                  0               },
-	{_T("???"),             0,              0,                  0,                  0               },
-	{_T("???"),             0,              0,                  0,                  0               },
+	{_T("???"),             0,              0,          0,              0               },
+	{_T("???"),             0,              0,          0,              0               },
+	{_T("???"),             0,              0,          0,              0               },
+	{_T("???"),             0,              0,          0,              0               },
+	{_T("???"),             0,              0,          0,              0               },
+	{_T("???"),             0,              0,          0,              0               },
+	{_T("???"),             0,              0,          0,              0               },
+	{_T("???"),             0,              0,          0,              0               },
+	{_T("???"),             0,              0,          0,              0               },
+	{_T("???"),             0,              0,          0,              0               },
+	{_T("???"),             0,              0,          0,              0               },
+	{_T("???"),             0,              0,          0,              0               },
+	{_T("???"),             0,              0,          0,              0               },
+	{_T("???"),             0,              0,          0,              0               },
+	{_T("???"),             0,              0,          0,              0               },
+	{_T("???"),             0,              0,          0,              0               },
 	// 0xb0
-	{_T("???"),             0,              0,                  0,                  0               },
-	{_T("???"),             0,              0,                  0,                  0               },
-	{_T("???"),             0,              0,                  0,                  0               },
-	{_T("???"),             0,              0,                  0,                  0               },
-	{_T("???"),             0,              0,                  0,                  0               },
-	{_T("???"),             0,              0,                  0,                  0               },
-	{_T("???"),             0,              0,                  0,                  0               },
-	{_T("???"),             0,              0,                  0,                  0               },
-	{_T("???"),             0,              0,                  0,                  0               },
-	{_T("???"),             0,              0,                  0,                  0               },
-	{_T("???"),             0,              0,                  0,                  0               },
-	{_T("???"),             0,              0,                  0,                  0               },
-	{_T("???"),             0,              0,                  0,                  0               },
-	{_T("???"),             0,              0,                  0,                  0               },
-	{_T("???"),             0,              0,                  0,                  0               },
-	{_T("???"),             0,              0,                  0,                  0               },
+	{_T("???"),             0,              0,          0,              0               },
+	{_T("???"),             0,              0,          0,              0               },
+	{_T("???"),             0,              0,          0,              0               },
+	{_T("???"),             0,              0,          0,              0               },
+	{_T("???"),             0,              0,          0,              0               },
+	{_T("???"),             0,              0,          0,              0               },
+	{_T("???"),             0,              0,          0,              0               },
+	{_T("???"),             0,              0,          0,              0               },
+	{_T("???"),             0,              0,          0,              0               },
+	{_T("???"),             0,              0,          0,              0               },
+	{_T("???"),             0,              0,          0,              0               },
+	{_T("???"),             0,              0,          0,              0               },
+	{_T("???"),             0,              0,          0,              0               },
+	{_T("???"),             0,              0,          0,              0               },
+	{_T("???"),             0,              0,          0,              0               },
+	{_T("???"),             0,              0,          0,              0               },
 	// 0xc0
-	{_T("???"),             0,              0,                  0,                  0               },
-	{_T("???"),             0,              0,                  0,                  0               },
-	{_T("???"),             0,              0,                  0,                  0               },
-	{_T("???"),             0,              0,                  0,                  0               },
-	{_T("???"),             0,              0,                  0,                  0               },
-	{_T("???"),             0,              0,                  0,                  0               },
-	{_T("???"),             0,              0,                  0,                  0               },
-	{_T("???"),             0,              0,                  0,                  0               },
-	{_T("???"),             0,              0,                  0,                  0               },
-	{_T("???"),             0,              0,                  0,                  0               },
-	{_T("???"),             0,              0,                  0,                  0               },
-	{_T("???"),             0,              0,                  0,                  0               },
-	{_T("???"),             0,              0,                  0,                  0               },
-	{_T("???"),             0,              0,                  0,                  0               },
-	{_T("???"),             0,              0,                  0,                  0               },
-	{_T("???"),             0,              0,                  0,                  0               },
+	{_T("???"),             0,              0,          0,              0               },
+	{_T("???"),             0,              0,          0,              0               },
+	{_T("???"),             0,              0,          0,              0               },
+	{_T("???"),             0,              0,          0,              0               },
+	{_T("???"),             0,              0,          0,              0               },
+	{_T("???"),             0,              0,          0,              0               },
+	{_T("???"),             0,              0,          0,              0               },
+	{_T("???"),             0,              0,          0,              0               },
+	{_T("???"),             0,              0,          0,              0               },
+	{_T("???"),             0,              0,          0,              0               },
+	{_T("???"),             0,              0,          0,              0               },
+	{_T("???"),             0,              0,          0,              0               },
+	{_T("???"),             0,              0,          0,              0               },
+	{_T("???"),             0,              0,          0,              0               },
+	{_T("???"),             0,              0,          0,              0               },
+	{_T("???"),             0,              0,          0,              0               },
 	// 0xd0
-	{_T("???"),             0,              0,                  0,                  0               },
-	{_T("???"),             0,              0,                  0,                  0               },
-	{_T("???"),             0,              0,                  0,                  0               },
-	{_T("???"),             0,              0,                  0,                  0               },
-	{_T("???"),             0,              0,                  0,                  0               },
-	{_T("???"),             0,              0,                  0,                  0               },
-	{_T("???"),             0,              0,                  0,                  0               },
-	{_T("???"),             0,              0,                  0,                  0               },
-	{_T("???"),             0,              0,                  0,                  0               },
-	{_T("???"),             0,              0,                  0,                  0               },
-	{_T("???"),             0,              0,                  0,                  0               },
-	{_T("???"),             0,              0,                  0,                  0               },
-	{_T("???"),             0,              0,                  0,                  0               },
-	{_T("???"),             0,              0,                  0,                  0               },
-	{_T("???"),             0,              0,                  0,                  0               },
+	{_T("???"),             0,              0,          0,              0               },
+	{_T("???"),             0,              0,          0,              0               },
+	{_T("???"),             0,              0,          0,              0               },
+	{_T("???"),             0,              0,          0,              0               },
+	{_T("???"),             0,              0,          0,              0               },
+	{_T("???"),             0,              0,          0,              0               },
+	{_T("???"),             0,              0,          0,              0               },
+	{_T("???"),             0,              0,          0,              0               },
+	{_T("???"),             0,              0,          0,              0               },
+	{_T("???"),             0,              0,          0,              0               },
+	{_T("???"),             0,              0,          0,              0               },
+	{_T("???"),             0,              0,          0,              0               },
+	{_T("???"),             0,              0,          0,              0               },
+	{_T("???"),             0,              0,          0,              0               },
+	{_T("???"),             0,              0,          0,              0               },
 	{_T("???\0")
-	 _T("aeskeygenassist\0")
-	 _T("???\0")
-	 _T("???"),             MODRM|VAR_NAME4,PARAM_XMM,          PARAM_XMMM,         PARAM_UI8       },
+		_T("aeskeygenassist\0")
+		_T("???\0")
+		_T("???"),              MODRM|VAR_NAME4,    PARAM_XMM,          PARAM_XMMM,         PARAM_UI8           },
 	// 0xe0
-	{_T("???"),             0,              0,                  0,                  0               },
-	{_T("???"),             0,              0,                  0,                  0               },
-	{_T("???"),             0,              0,                  0,                  0               },
-	{_T("???"),             0,              0,                  0,                  0               },
-	{_T("???"),             0,              0,                  0,                  0               },
-	{_T("???"),             0,              0,                  0,                  0               },
-	{_T("???"),             0,              0,                  0,                  0               },
-	{_T("???"),             0,              0,                  0,                  0               },
-	{_T("???"),             0,              0,                  0,                  0               },
-	{_T("???"),             0,              0,                  0,                  0               },
-	{_T("???"),             0,              0,                  0,                  0               },
-	{_T("???"),             0,              0,                  0,                  0               },
-	{_T("???"),             0,              0,                  0,                  0               },
-	{_T("???"),             0,              0,                  0,                  0               },
-	{_T("???"),             0,              0,                  0,                  0               },
-	{_T("???"),             0,              0,                  0,                  0               },
+	{_T("???"),             0,              0,          0,              0               },
+	{_T("???"),             0,              0,          0,              0               },
+	{_T("???"),             0,              0,          0,              0               },
+	{_T("???"),             0,              0,          0,              0               },
+	{_T("???"),             0,              0,          0,              0               },
+	{_T("???"),             0,              0,          0,              0               },
+	{_T("???"),             0,              0,          0,              0               },
+	{_T("???"),             0,              0,          0,              0               },
+	{_T("???"),             0,              0,          0,              0               },
+	{_T("???"),             0,              0,          0,              0               },
+	{_T("???"),             0,              0,          0,              0               },
+	{_T("???"),             0,              0,          0,              0               },
+	{_T("???"),             0,              0,          0,              0               },
+	{_T("???"),             0,              0,          0,              0               },
+	{_T("???"),             0,              0,          0,              0               },
+	{_T("???"),             0,              0,          0,              0               },
 	// 0xf0
-	{_T("???"),             0,              0,                  0,                  0               },
-	{_T("???"),             0,              0,                  0,                  0               },
-	{_T("???"),             0,              0,                  0,                  0               },
-	{_T("???"),             0,              0,                  0,                  0               },
-	{_T("???"),             0,              0,                  0,                  0               },
-	{_T("???"),             0,              0,                  0,                  0               },
-	{_T("???"),             0,              0,                  0,                  0               },
-	{_T("???"),             0,              0,                  0,                  0               },
-	{_T("???"),             0,              0,                  0,                  0               },
-	{_T("???"),             0,              0,                  0,                  0               },
-	{_T("???"),             0,              0,                  0,                  0               },
-	{_T("???"),             0,              0,                  0,                  0               },
-	{_T("???"),             0,              0,                  0,                  0               },
-	{_T("???"),             0,              0,                  0,                  0               },
-	{_T("???"),             0,              0,                  0,                  0               },
-	{_T("???"),             0,              0,                  0,                  0               },
+	{_T("???"),             0,              0,          0,              0               },
+	{_T("???"),             0,              0,          0,              0               },
+	{_T("???"),             0,              0,          0,              0               },
+	{_T("???"),             0,              0,          0,              0               },
+	{_T("???"),             0,              0,          0,              0               },
+	{_T("???"),             0,              0,          0,              0               },
+	{_T("???"),             0,              0,          0,              0               },
+	{_T("???"),             0,              0,          0,              0               },
+	{_T("???"),             0,              0,          0,              0               },
+	{_T("???"),             0,              0,          0,              0               },
+	{_T("???"),             0,              0,          0,              0               },
+	{_T("???"),             0,              0,          0,              0               },
+	{_T("???"),             0,              0,          0,              0               },
+	{_T("???"),             0,              0,          0,              0               },
+	{_T("???"),             0,              0,          0,              0               },
+	{_T("???"),             0,              0,          0,              0               },
 };
 
 static const I386_OPCODE group80_table[8] =
@@ -1812,41 +1811,41 @@
 static const I386_OPCODE group0F12_table[4] =
 {
 	{_T("movlps\0")
-	 _T("movlpd\0")
-	 _T("movddup\0")
-	 _T("movsldup"),        VAR_NAME4,      PARAM_XMM,          PARAM_XMMM,         0               },
+		_T("movlpd\0")
+		_T("movddup\0")
+		_T("movsldup"),     VAR_NAME4,PARAM_XMM,          PARAM_XMMM,         0               },
 	{_T("movlps\0")
-	 _T("movlpd\0")
-	 _T("movddup\0")
-	 _T("movsldup"),        VAR_NAME4,      PARAM_XMM,          PARAM_XMMM,         0               },
+		_T("movlpd\0")
+		_T("movddup\0")
+		_T("movsldup"),     VAR_NAME4,PARAM_XMM,          PARAM_XMMM,         0               },
 	{_T("movlps\0")
-	 _T("movlpd\0")
-	 _T("movddup\0")
-	 _T("movsldup"),        VAR_NAME4,      PARAM_XMM,          PARAM_XMMM,         0               },
+		_T("movlpd\0")
+		_T("movddup\0")
+		_T("movsldup"),     VAR_NAME4,PARAM_XMM,          PARAM_XMMM,         0               },
 	{_T("movhlps\0")
-	 _T("???\0")
-	 _T("movddup\0")
-	 _T("movsldup"),        VAR_NAME4,      PARAM_XMM,          PARAM_XMMM,         0               }
+		_T("???\0")
+		_T("movddup\0")
+		_T("movsldup"),     VAR_NAME4,PARAM_XMM,          PARAM_XMMM,         0               }
 };
 
 static const I386_OPCODE group0F16_table[4] =
 {
 	{_T("movhps\0")
-	 _T("movhpd\0")
-	 _T("???\0")
-	 _T("movshdup"),        VAR_NAME4,      PARAM_XMM,          PARAM_XMMM,         0               },
+		_T("movhpd\0")
+		_T("???\0")
+		_T("movshdup"),     VAR_NAME4,PARAM_XMM,         PARAM_XMMM,          0               },
 	{_T("movhps\0")
-	 _T("movhpd\0")
-	 _T("???\0")
-	 _T("movshdup"),        VAR_NAME4,      PARAM_XMM,          PARAM_XMMM,         0               },
+		_T("movhpd\0")
+		_T("???\0")
+		_T("movshdup"),     VAR_NAME4,PARAM_XMM,         PARAM_XMMM,          0               },
 	{_T("movhps\0")
-	 _T("movhpd\0")
-	 _T("???\0")
-	 _T("movshdup"),        VAR_NAME4,      PARAM_XMM,          PARAM_XMMM,         0               },
+		_T("movhpd\0")
+		_T("???\0")
+		_T("movshdup"),     VAR_NAME4,PARAM_XMM,         PARAM_XMMM,          0               },
 	{_T("movlhps\0")
-	 _T("movhpd\0")
-	 _T("???\0")
-	 _T("movshdup"),        VAR_NAME4,      PARAM_XMM,          PARAM_XMMM,         0               }
+		_T("movhpd\0")
+		_T("???\0")
+		_T("movshdup"),     VAR_NAME4,PARAM_XMM,         PARAM_XMMM,          0               }
 };
 
 static const I386_OPCODE group0F18_table[8] =
@@ -1909,6 +1908,7 @@
 	{_T("sfence"),          0,              0,                  0,                  0               }
 };
 
+
 static const I386_OPCODE group0FBA_table[8] =
 {
 	{_T("???"),             0,              0,                  0,                  0               },
@@ -1924,687 +1924,18 @@
 static const I386_OPCODE group0FC7_table[8] =
 {
 	{_T("???"),             0,              0,                  0,                  0               },
-	{_T("cmpxchg8b"),       MODRM,          PARAM_M64PTR,       0,                  0               },
+	{_T("cmpxchg8b"),           MODRM,              PARAM_M64PTR,               0,                  0               },
 	{_T("???"),             0,              0,                  0,                  0               },
 	{_T("???"),             0,              0,                  0,                  0               },
 	{_T("???"),             0,              0,                  0,                  0               },
 	{_T("???"),             0,              0,                  0,                  0               },
 	{_T("vmptrld\0")
-	 _T("vmclear\0")
-	 _T("???\0")
-	 _T("vmxon"),           MODRM|VAR_NAME4,PARAM_M64PTR,       0,                  0               },
-	{_T("vmptrtst"),        MODRM,          PARAM_M64PTR,       0,                  0               }
+		_T("vmclear\0")
+		_T("???\0")
+		_T("vmxon"),            MODRM|VAR_NAME4,        PARAM_M64PTR,               0,                  0               },
+	{_T("vmptrtst"),            MODRM,              PARAM_M64PTR,               0,                  0               }
 };
 
-static const I386_OPCODE necv_opcode_table1[256] =
-{
-	// 0x00
-	{_T("add"),             MODRM,          PARAM_RM8,          PARAM_REG8,         0               },
-	{_T("add"),             MODRM,          PARAM_RM,           PARAM_REG,          0               },
-	{_T("add"),             MODRM,          PARAM_REG8,         PARAM_RM8,          0               },
-	{_T("add"),             MODRM,          PARAM_REG,          PARAM_RM,           0               },
-	{_T("add"),             0,              PARAM_AL,           PARAM_UI8,          0               },
-	{_T("add"),             0,              PARAM_EAX,          PARAM_IMM,          0               },
-	{_T("push    es"),      0,              0,                  0,                  0               },
-	{_T("pop     es"),      0,              0,                  0,                  0               },
-	{_T("or"),              MODRM,          PARAM_RM8,          PARAM_REG8,         0               },
-	{_T("or"),              MODRM,          PARAM_RM,           PARAM_REG,          0               },
-	{_T("or"),              MODRM,          PARAM_REG8,         PARAM_RM8,          0               },
-	{_T("or"),              MODRM,          PARAM_REG,          PARAM_RM,           0               },
-	{_T("or"),              0,              PARAM_AL,           PARAM_UI8,          0               },
-	{_T("or"),              0,              PARAM_EAX,          PARAM_IMM,          0               },
-	{_T("push    cs"),      0,              0,                  0,                  0               },
-	{_T("two_byte"),        TWO_BYTE,       0,                  0,                  0               },
-	// 0x10
-	{_T("adc"),             MODRM,          PARAM_RM8,          PARAM_REG8,         0               },
-	{_T("adc"),             MODRM,          PARAM_RM,           PARAM_REG,          0               },
-	{_T("adc"),             MODRM,          PARAM_REG8,         PARAM_RM8,          0               },
-	{_T("adc"),             MODRM,          PARAM_REG,          PARAM_RM,           0               },
-	{_T("adc"),             0,              PARAM_AL,           PARAM_UI8,          0               },
-	{_T("adc"),             0,              PARAM_EAX,          PARAM_IMM,          0               },
-	{_T("push    ss"),      0,              0,                  0,                  0               },
-	{_T("pop     ss"),      0,              0,                  0,                  0               },
-	{_T("sbb"),             MODRM,          PARAM_RM8,          PARAM_REG8,         0               },
-	{_T("sbb"),             MODRM,          PARAM_RM,           PARAM_REG,          0               },
-	{_T("sbb"),             MODRM,          PARAM_REG8,         PARAM_RM8,          0               },
-	{_T("sbb"),             MODRM,          PARAM_REG,          PARAM_RM,           0               },
-	{_T("sbb"),             0,              PARAM_AL,           PARAM_UI8,          0               },
-	{_T("sbb"),             0,              PARAM_EAX,          PARAM_IMM,          0               },
-	{_T("push    ds"),      0,              0,                  0,                  0               },
-	{_T("pop     ds"),      0,              0,                  0,                  0               },
-	// 0x20
-	{_T("and"),             MODRM,          PARAM_RM8,          PARAM_REG8,         0               },
-	{_T("and"),             MODRM,          PARAM_RM,           PARAM_REG,          0               },
-	{_T("and"),             MODRM,          PARAM_REG8,         PARAM_RM8,          0               },
-	{_T("and"),             MODRM,          PARAM_REG,          PARAM_RM,           0               },
-	{_T("and"),             0,              PARAM_AL,           PARAM_UI8,          0               },
-	{_T("and"),             0,              PARAM_EAX,          PARAM_IMM,          0               },
-	{_T("seg_es"),          SEG_ES,         0,                  0,                  0               },
-	{_T("daa"),             0,              0,                  0,                  0               },
-	{_T("sub"),             MODRM,          PARAM_RM8,          PARAM_REG8,         0               },
-	{_T("sub"),             MODRM,          PARAM_RM,           PARAM_REG,          0               },
-	{_T("sub"),             MODRM,          PARAM_REG8,         PARAM_RM8,          0               },
-	{_T("sub"),             MODRM,          PARAM_REG,          PARAM_RM,           0               },
-	{_T("sub"),             0,              PARAM_AL,           PARAM_UI8,          0               },
-	{_T("sub"),             0,              PARAM_EAX,          PARAM_IMM,          0               },
-	{_T("seg_cs"),          SEG_CS,         0,                  0,                  0               },
-	{_T("das"),             0,              0,                  0,                  0               },
-	// 0x30
-	{_T("xor"),             MODRM,          PARAM_RM8,          PARAM_REG8,         0               },
-	{_T("xor"),             MODRM,          PARAM_RM,           PARAM_REG,          0               },
-	{_T("xor"),             MODRM,          PARAM_REG8,         PARAM_RM8,          0               },
-	{_T("xor"),             MODRM,          PARAM_REG,          PARAM_RM,           0               },
-	{_T("xor"),             0,              PARAM_AL,           PARAM_UI8,          0               },
-	{_T("xor"),             0,              PARAM_EAX,          PARAM_IMM,          0               },
-	{_T("seg_ss"),          SEG_SS,         0,                  0,                  0               },
-	{_T("aaa"),             0,              0,                  0,                  0               },
-	{_T("cmp"),             MODRM,          PARAM_RM8,          PARAM_REG8,         0               },
-	{_T("cmp"),             MODRM,          PARAM_RM,           PARAM_REG,          0               },
-	{_T("cmp"),             MODRM,          PARAM_REG8,         PARAM_RM8,          0               },
-	{_T("cmp"),             MODRM,          PARAM_REG,          PARAM_RM,           0               },
-	{_T("cmp"),             0,              PARAM_AL,           PARAM_UI8,          0               },
-	{_T("cmp"),             0,              PARAM_EAX,          PARAM_IMM,          0               },
-	{_T("seg_ds"),          SEG_DS,         0,                  0,                  0               },
-	{_T("aas"),             0,              0,                  0,                  0               },
-	// 0x40
-	{_T("inc"),             ISREX,          PARAM_EAX,          0,                  0               },
-	{_T("inc"),             ISREX,          PARAM_ECX,          0,                  0               },
-	{_T("inc"),             ISREX,          PARAM_EDX,          0,                  0               },
-	{_T("inc"),             ISREX,          PARAM_EBX,          0,                  0               },
-	{_T("inc"),             ISREX,          PARAM_ESP,          0,                  0               },
-	{_T("inc"),             ISREX,          PARAM_EBP,          0,                  0               },
-	{_T("inc"),             ISREX,          PARAM_ESI,          0,                  0               },
-	{_T("inc"),             ISREX,          PARAM_EDI,          0,                  0               },
-	{_T("dec"),             ISREX,          PARAM_EAX,          0,                  0               },
-	{_T("dec"),             ISREX,          PARAM_ECX,          0,                  0               },
-	{_T("dec"),             ISREX,          PARAM_EDX,          0,                  0               },
-	{_T("dec"),             ISREX,          PARAM_EBX,          0,                  0               },
-	{_T("dec"),             ISREX,          PARAM_ESP,          0,                  0               },
-	{_T("dec"),             ISREX,          PARAM_EBP,          0,                  0               },
-	{_T("dec"),             ISREX,          PARAM_ESI,          0,                  0               },
-	{_T("dec"),             ISREX,          PARAM_EDI,          0,                  0               },
-	// 0x50
-	{_T("push"),            ALWAYS64,       PARAM_EAX,          0,                  0               },
-	{_T("push"),            ALWAYS64,       PARAM_ECX,          0,                  0               },
-	{_T("push"),            ALWAYS64,       PARAM_EDX,          0,                  0               },
-	{_T("push"),            ALWAYS64,       PARAM_EBX,          0,                  0               },
-	{_T("push"),            ALWAYS64,       PARAM_ESP,          0,                  0               },
-	{_T("push"),            ALWAYS64,       PARAM_EBP,          0,                  0               },
-	{_T("push"),            ALWAYS64,       PARAM_ESI,          0,                  0               },
-	{_T("push"),            ALWAYS64,       PARAM_EDI,          0,                  0               },
-	{_T("pop"),             ALWAYS64,       PARAM_EAX,          0,                  0               },
-	{_T("pop"),             ALWAYS64,       PARAM_ECX,          0,                  0               },
-	{_T("pop"),             ALWAYS64,       PARAM_EDX,          0,                  0               },
-	{_T("pop"),             ALWAYS64,       PARAM_EBX,          0,                  0               },
-	{_T("pop"),             ALWAYS64,       PARAM_ESP,          0,                  0               },
-	{_T("pop"),             ALWAYS64,       PARAM_EBP,          0,                  0               },
-	{_T("pop"),             ALWAYS64,       PARAM_ESI,          0,                  0               },
-	{_T("pop"),             ALWAYS64,       PARAM_EDI,          0,                  0               },
-	// 0x60
-	{_T("pusha\0pushad\0<invalid>"),VAR_NAME,0,                 0,                  0               },
-	{_T("popa\0popad\0<invalid>"),  VAR_NAME,0,                 0,                  0               },
-	{_T("bound"),           MODRM,          PARAM_REG,          PARAM_RM,           0               },
-	{_T("brkn"),            0,              PARAM_UI8,          0,                  0,              DASMFLAG_STEP_OVER}, /* V25S/V35S only */
-	{_T("repnc"),           PREFIX,         0,                  0,                  0               }, /* V20/V30 */
-	{_T("repc"),            PREFIX,         0,                  0,                  0               }, /* V20/V30 */
-	{_T("fpo2 0"),          0,              PARAM_UI8,          0,                  0               }, /* V20/V30 */
-	{_T("fpo2 1"),          0,              PARAM_UI8,          0,                  0               }, /* V20/V30 */
-	{_T("push"),            0,              PARAM_IMM,          0,                  0               },
-	{_T("imul"),            MODRM,          PARAM_REG,          PARAM_RM,           PARAM_IMM       },
-	{_T("push"),            0,              PARAM_I8,           0,                  0               },
-	{_T("imul"),            MODRM,          PARAM_REG,          PARAM_RM,           PARAM_I8        },
-	{_T("insb"),            0,              0,                  0,                  0               },
-	{_T("insw\0insd\0insd"),VAR_NAME,       0,                  0,                  0               },
-	{_T("outsb"),           0,              PARAM_PREIMP,       0,                  0               },
-	{_T("outsw\0outsd\0outsd"),VAR_NAME,    PARAM_PREIMP,       0,                  0               },
-	// 0x70
-	{_T("jo"),              0,              PARAM_REL8,         0,                  0               },
-	{_T("jno"),             0,              PARAM_REL8,         0,                  0               },
-	{_T("jb"),              0,              PARAM_REL8,         0,                  0               },
-	{_T("jae"),             0,              PARAM_REL8,         0,                  0               },
-	{_T("je"),              0,              PARAM_REL8,         0,                  0               },
-	{_T("jne"),             0,              PARAM_REL8,         0,                  0               },
-	{_T("jbe"),             0,              PARAM_REL8,         0,                  0               },
-	{_T("ja"),              0,              PARAM_REL8,         0,                  0               },
-	{_T("js"),              0,              PARAM_REL8,         0,                  0               },
-	{_T("jns"),             0,              PARAM_REL8,         0,                  0               },
-	{_T("jp"),              0,              PARAM_REL8,         0,                  0               },
-	{_T("jnp"),             0,              PARAM_REL8,         0,                  0               },
-	{_T("jl"),              0,              PARAM_REL8,         0,                  0               },
-	{_T("jge"),             0,              PARAM_REL8,         0,                  0               },
-	{_T("jle"),             0,              PARAM_REL8,         0,                  0               },
-	{_T("jg"),              0,              PARAM_REL8,         0,                  0               },
-	// 0x80
-	{_T("group80"),         GROUP,          0,                  0,                  0               },
-	{_T("group81"),         GROUP,          0,                  0,                  0               },
-	{_T("group80"),         GROUP,          0,                  0,                  0               },
-	{_T("group83"),         GROUP,          0,                  0,                  0               },
-	{_T("test"),            MODRM,          PARAM_RM8,          PARAM_REG8,         0               },
-	{_T("test"),            MODRM,          PARAM_RM,           PARAM_REG,          0               },
-	{_T("xchg"),            MODRM,          PARAM_REG8,         PARAM_RM8,          0               },
-	{_T("xchg"),            MODRM,          PARAM_REG,          PARAM_RM,           0               },
-	{_T("mov"),             MODRM,          PARAM_RM8,          PARAM_REG8,         0               },
-	{_T("mov"),             MODRM,          PARAM_RM,           PARAM_REG,          0               },
-	{_T("mov"),             MODRM,          PARAM_REG8,         PARAM_RM8,          0               },
-	{_T("mov"),             MODRM,          PARAM_REG,          PARAM_RM,           0               },
-	{_T("mov"),             MODRM,          PARAM_RM,           PARAM_SREG,         0               },
-	{_T("lea"),             MODRM,          PARAM_REG,          PARAM_RM,           0               },
-	{_T("mov"),             MODRM,          PARAM_SREG,         PARAM_RM,           0               },
-	{_T("pop"),             MODRM,          PARAM_RM,           0,                  0               },
-	// 0x90
-	{_T("nop\0???\0???\0pause"), VAR_NAME4, 0,                  0,                  0               },
-	{_T("xchg"),            0,              PARAM_EAX,          PARAM_ECX,          0               },
-	{_T("xchg"),            0,              PARAM_EAX,          PARAM_EDX,          0               },
-	{_T("xchg"),            0,              PARAM_EAX,          PARAM_EBX,          0               },
-	{_T("xchg"),            0,              PARAM_EAX,          PARAM_ESP,          0               },
-	{_T("xchg"),            0,              PARAM_EAX,          PARAM_EBP,          0               },
-	{_T("xchg"),            0,              PARAM_EAX,          PARAM_ESI,          0               },
-	{_T("xchg"),            0,              PARAM_EAX,          PARAM_EDI,          0               },
-	{_T("cbw\0cwde\0cdqe"), VAR_NAME,       0,                  0,                  0               },
-	{_T("cwd\0cdq\0cqo"),   VAR_NAME,       0,                  0,                  0               },
-	{_T("call"),            ALWAYS64,       PARAM_ADDR,         0,                  0,              DASMFLAG_STEP_OVER},
-	{_T("wait"),            0,              0,                  0,                  0               },
-	{_T("pushf\0pushfd\0pushfq"),VAR_NAME,  0,                  0,                  0               },
-	{_T("popf\0popfd\0popfq"),VAR_NAME,     0,                  0,                  0               },
-	{_T("sahf"),            0,              0,                  0,                  0               },
-	{_T("lahf"),            0,              0,                  0,                  0               },
-	// 0xa0
-	{_T("mov"),             0,              PARAM_AL,           PARAM_MEM_OFFS,     0               },
-	{_T("mov"),             0,              PARAM_EAX,          PARAM_MEM_OFFS,     0               },
-	{_T("mov"),             0,              PARAM_MEM_OFFS,     PARAM_AL,           0               },
-	{_T("mov"),             0,              PARAM_MEM_OFFS,     PARAM_EAX,          0               },
-	{_T("movsb"),           0,              PARAM_PREIMP,       0,                  0               },
-	{_T("movsw\0movsd\0movsq"),VAR_NAME,    PARAM_PREIMP,       0,                  0               },
-	{_T("cmpsb"),           0,              PARAM_PREIMP,       0,                  0               },
-	{_T("cmpsw\0cmpsd\0cmpsq"),VAR_NAME,    PARAM_PREIMP,       0,                  0               },
-	{_T("test"),            0,              PARAM_AL,           PARAM_UI8,          0               },
-	{_T("test"),            0,              PARAM_EAX,          PARAM_IMM,          0               },
-	{_T("stosb"),           0,              0,                  0,                  0               },
-	{_T("stosw\0stosd\0stosq"),VAR_NAME,    0,                  0,                  0               },
-	{_T("lodsb"),           0,              PARAM_PREIMP,       0,                  0               },
-	{_T("lodsw\0lodsd\0lodsq"),VAR_NAME,    PARAM_PREIMP,       0,                  0               },
-	{_T("scasb"),           0,              0,                  0,                  0               },
-	{_T("scasw\0scasd\0scasq"),VAR_NAME,    0,                  0,                  0               },
-	// 0xb0
-	{_T("mov"),             0,              PARAM_AL,           PARAM_UI8,          0               },
-	{_T("mov"),             0,              PARAM_CL,           PARAM_UI8,          0               },
-	{_T("mov"),             0,              PARAM_DL,           PARAM_UI8,          0               },
-	{_T("mov"),             0,              PARAM_BL,           PARAM_UI8,          0               },
-	{_T("mov"),             0,              PARAM_AH,           PARAM_UI8,          0               },
-	{_T("mov"),             0,              PARAM_CH,           PARAM_UI8,          0               },
-	{_T("mov"),             0,              PARAM_DH,           PARAM_UI8,          0               },
-	{_T("mov"),             0,              PARAM_BH,           PARAM_UI8,          0               },
-	{_T("mov"),             0,              PARAM_EAX,          PARAM_IMM64,        0               },
-	{_T("mov"),             0,              PARAM_ECX,          PARAM_IMM64,        0               },
-	{_T("mov"),             0,              PARAM_EDX,          PARAM_IMM64,        0               },
-	{_T("mov"),             0,              PARAM_EBX,          PARAM_IMM64,        0               },
-	{_T("mov"),             0,              PARAM_ESP,          PARAM_IMM64,        0               },
-	{_T("mov"),             0,              PARAM_EBP,          PARAM_IMM64,        0               },
-	{_T("mov"),             0,              PARAM_ESI,          PARAM_IMM64,        0               },
-	{_T("mov"),             0,              PARAM_EDI,          PARAM_IMM64,        0               },
-	// 0xc0
-	{_T("groupC0"),         GROUP,          0,                  0,                  0               },
-	{_T("groupC1"),         GROUP,          0,                  0,                  0               },
-	{_T("ret"),             0,              PARAM_UI16,         0,                  0,              DASMFLAG_STEP_OUT},
-	{_T("ret"),             0,              0,                  0,                  0,              DASMFLAG_STEP_OUT},
-	{_T("les"),             MODRM,          PARAM_REG,          PARAM_RM,           0               },
-	{_T("lds"),             MODRM,          PARAM_REG,          PARAM_RM,           0               },
-	{_T("mov"),             MODRM,          PARAM_RMPTR8,       PARAM_UI8,          0               },
-	{_T("mov"),             MODRM,          PARAM_RMPTR,        PARAM_IMM,          0               },
-	{_T("enter"),           0,              PARAM_UI16,         PARAM_UI8,          0               },
-	{_T("leave"),           0,              0,                  0,                  0               },
-	{_T("retf"),            0,              PARAM_UI16,         0,                  0,              DASMFLAG_STEP_OUT},
-	{_T("retf"),            0,              0,                  0,                  0,              DASMFLAG_STEP_OUT},
-	{_T("int 3"),           0,              0,                  0,                  0,              DASMFLAG_STEP_OVER},
-	{_T("int"),             0,              PARAM_UI8,          0,                  0,              DASMFLAG_STEP_OVER},
-	{_T("into"),            0,              0,                  0,                  0               },
-	{_T("iret"),            0,              0,                  0,                  0,              DASMFLAG_STEP_OUT},
-	// 0xd0
-	{_T("groupD0"),         GROUP,          0,                  0,                  0               },
-	{_T("groupD1"),         GROUP,          0,                  0,                  0               },
-	{_T("groupD2"),         GROUP,          0,                  0,                  0               },
-	{_T("groupD3"),         GROUP,          0,                  0,                  0               },
-	{_T("aam"),             0,              PARAM_UI8,          0,                  0               },
-	{_T("aad"),             0,              PARAM_UI8,          0,                  0               },
-	{_T("salc"),            0,              0,                  0,                  0               }, //AMD docs name it
-	{_T("xlat"),            0,              0,                  0,                  0               },
-	{_T("fpo1"),            FPU,            0,                  0,                  0               },
-	{_T("fpo1"),            FPU,            0,                  0,                  0               },
-	{_T("fpo1"),            FPU,            0,                  0,                  0               },
-	{_T("fpo1"),            FPU,            0,                  0,                  0               },
-	{_T("fpo1"),            FPU,            0,                  0,                  0               },
-	{_T("fpo1"),            FPU,            0,                  0,                  0               },
-	{_T("fpo1"),            FPU,            0,                  0,                  0               },
-	{_T("fpo1"),            FPU,            0,                  0,                  0               },
-	// 0xe0
-	{_T("loopne"),          0,              PARAM_REL8,         0,                  0,              DASMFLAG_STEP_OVER},
-	{_T("loopz"),           0,              PARAM_REL8,         0,                  0,              DASMFLAG_STEP_OVER},
-	{_T("loop"),            0,              PARAM_REL8,         0,                  0,              DASMFLAG_STEP_OVER},
-	{_T("jcxz\0jecxz\0jrcxz"),VAR_NAME,     PARAM_REL8,         0,                  0               },
-	{_T("in"),              0,              PARAM_AL,           PARAM_UI8,          0               },
-	{_T("in"),              0,              PARAM_EAX,          PARAM_UI8,          0               },
-	{_T("out"),             0,              PARAM_UI8,          PARAM_AL,           0               },
-	{_T("out"),             0,              PARAM_UI8,          PARAM_EAX,          0               },
-	{_T("call"),            0,              PARAM_REL,          0,                  0,              DASMFLAG_STEP_OVER},
-	{_T("jmp"),             0,              PARAM_REL,          0,                  0               },
-	{_T("jmp"),             0,              PARAM_ADDR,         0,                  0               },
-	{_T("jmp"),             0,              PARAM_REL8,         0,                  0               },
-	{_T("in"),              0,              PARAM_AL,           PARAM_DX,           0               },
-	{_T("in"),              0,              PARAM_EAX,          PARAM_DX,           0               },
-	{_T("out"),             0,              PARAM_DX,           PARAM_AL,           0               },
-	{_T("out"),             0,              PARAM_DX,           PARAM_EAX,          0               },
-	// 0xf0
-	{_T("lock"),            0,              0,                  0,                  0               },
-	{_T("brks"),            0,              PARAM_UI8,          0,                  0,              DASMFLAG_STEP_OVER}, /* V25S/V35S only */
-	{_T("repne"),           PREFIX,         0,                  0,                  0               },
-	{_T("rep"),             PREFIX,         0,                  0,                  0               },
-	{_T("hlt"),             0,              0,                  0,                  0               },
-	{_T("cmc"),             0,              0,                  0,                  0               },
-	{_T("groupF6"),         GROUP,          0,                  0,                  0               },
-	{_T("groupF7"),         GROUP,          0,                  0,                  0               },
-	{_T("clc"),             0,              0,                  0,                  0               },
-	{_T("stc"),             0,              0,                  0,                  0               },
-	{_T("cli"),             0,              0,                  0,                  0               },
-	{_T("sti"),             0,              0,                  0,                  0               },
-	{_T("cld"),             0,              0,                  0,                  0               },
-	{_T("std"),             0,              0,                  0,                  0               },
-	{_T("groupFE"),         GROUP,          0,                  0,                  0               },
-	{_T("groupFF"),         GROUP,          0,                  0,                  0               }
-};
-
-static const I386_OPCODE necv_opcode_table2[256] =
-{
-	// 0x00
-	{_T("group0F00"),       GROUP,          0,                  0,                  0               },
-	{_T("group0F01"),       GROUP,          0,                  0,                  0               },
-	{_T("lar"),             MODRM,          PARAM_REG,          PARAM_RM,           0               },
-	{_T("lsl"),             MODRM,          PARAM_REG,          PARAM_RM,           0               },
-	{_T("???"),             0,              0,                  0,                  0               },
-	{_T("syscall"),         0,              0,                  0,                  0               },
-	{_T("clts"),            0,              0,                  0,                  0               },
-	{_T("sysret"),          0,              0,                  0,                  0               },
-	{_T("invd"),            0,              0,                  0,                  0               },
-	{_T("wbinvd"),          0,              0,                  0,                  0               },
-	{_T("???"),             0,              0,                  0,                  0               },
-	{_T("ud2"),             0,              0,                  0,                  0               },
-	{_T("???"),             0,              0,                  0,                  0               },
-	{_T("group0F0D"),       GROUP,          0,                  0,                  0               }, //AMD only
-	{_T("???"),             0,              0,                  0,                  0               },
-	{_T("???"),             0,              0,                  0,                  0               },
-	// 0x10
-	{_T("test1"),           MODRM,          PARAM_RMPTR8,       PARAM_CL,           0               }, /* V20/V30 */
-	{_T("test1"),           MODRM,          PARAM_RMPTR16,      PARAM_CL,           0               }, /* V20/V30 */
-	{_T("clr1"),            MODRM,          PARAM_RMPTR8,       PARAM_CL,           0               }, /* V20/V30 */
-	{_T("clr1"),            MODRM,          PARAM_RMPTR16,      PARAM_CL,           0               }, /* V20/V30 */
-	{_T("set1"),            MODRM,          PARAM_RMPTR8,       PARAM_CL,           0               }, /* V20/V30 */
-	{_T("set1"),            MODRM,          PARAM_RMPTR16,      PARAM_CL,           0               }, /* V20/V30 */
-	{_T("not1"),            MODRM,          PARAM_RMPTR8,       PARAM_CL,           0               }, /* V20/V30 */
-	{_T("not1"),            MODRM,          PARAM_RMPTR16,      PARAM_CL,           0               }, /* V20/V30 */
-	{_T("test1"),           MODRM,          PARAM_RMPTR8,       PARAM_I3,           0               }, /* V20/V30 */
-	{_T("test1"),           MODRM,          PARAM_RMPTR16,      PARAM_I4,           0               }, /* V20/V30 */
-	{_T("clr1"),            MODRM,          PARAM_RMPTR8,       PARAM_I3,           0               }, /* V20/V30 */
-	{_T("clr1"),            MODRM,          PARAM_RMPTR16,      PARAM_I4,           0               }, /* V20/V30 */
-	{_T("set1"),            MODRM,          PARAM_RMPTR8,       PARAM_I3,           0               }, /* V20/V30 */
-	{_T("set1"),            MODRM,          PARAM_RMPTR16,      PARAM_I4,           0               }, /* V20/V30 */
-	{_T("not1"),            MODRM,          PARAM_RMPTR8,       PARAM_I3,           0               }, /* V20/V30 */
-	{_T("not1"),            MODRM,          PARAM_RMPTR16,      PARAM_I4,           0               }, /* V20/V30 */
-	// 0x20
-	{_T("add4s"),           0,              0,                  0,                  0               }, /* V20/V30 */
-	{_T("mov"),             MODRM,          PARAM_REG2_32,      PARAM_DREG,         0               },
-	{_T("sub4s"),           0,              0,                  0,                  0               }, /* V20/V30 */
-	{_T("mov"),             MODRM,          PARAM_DREG,         PARAM_REG2_32,      0               },
-	{_T("mov"),             MODRM,          PARAM_REG2_32,      PARAM_TREG,         0               },
-	{_T("movspa"),          0,              0,                  0,                  0               }, /* V25/V35 only */
-	{_T("cmp4s"),           0,              0,                  0,                  0               }, /* V20/V30 */
-	{_T("???"),             0,              0,                  0,                  0               },
-	{_T("rol4"),            MODRM,          PARAM_RMPTR8,       0,                  0               }, /* V20/V30 */
-	{_T("movaps\0")
-	 _T("movapd\0")
-	 _T("???\0")
-	 _T("???"),             MODRM|VAR_NAME4,PARAM_XMMM,         PARAM_XMM,          0               },
-	{_T("ror4"),            MODRM,          PARAM_RMPTR8,       0,                  0               }, /* V20/V30 */
-	{_T("movntps\0")
-	 _T("movntpd\0")
-	 _T("???\0")
-	 _T("???"),             MODRM|VAR_NAME4,PARAM_XMMM,         PARAM_XMM,          0               },
-	{_T("cvttps2pi\0")
-	 _T("cvttpd2pi\0")
-	 _T("cvttsd2si\0")
-	 _T("cvttss2si"),       MODRM|VAR_NAME4,PARAM_REGORXMM,     PARAM_XMMM,         0               },
-	{_T("brkcs"),           MODRM,          PARAM_REG2_16,      0,                  0,              DASMFLAG_STEP_OVER}, /* V25/V35 only */
-	{_T("ucomiss\0")
-	 _T("ucomisd\0")
-	 _T("???\0")
-	 _T("???"),             MODRM|VAR_NAME4,PARAM_XMM,          PARAM_XMMM,         0               },
-	{_T("comiss\0")
-	 _T("comisd\0")
-	 _T("???\0")
-	 _T("???"),             MODRM|VAR_NAME4,PARAM_XMM,          PARAM_XMMM,         0               },
-	// 0x30
-	{_T("wrmsr"),           0,              0,                  0,                  0               },
-	{_T("ins"),             MODRM,          PARAM_REG2_8,       PARAM_REG8,         0               }, /* V20/V30 */
-	{_T("rdmsr"),           0,              0,                  0,                  0               },
-	{_T("ext"),             MODRM,          PARAM_REG2_8,       PARAM_REG8,         0               }, /* V20/V30 */
-	{_T("sysenter"),        0,              0,                  0,                  0               },
-	{_T("sysexit"),         0,              0,                  0,                  0               },
-	{_T("???"),             0,              0,                  0,                  0               },
-	{_T("???"),             0,              0,                  0,                  0               },
-	{_T("three_byte"),      THREE_BYTE,     0,                  0,                  0               },
-	{_T("ins"),             MODRM,          PARAM_REG2_8,       PARAM_I4,           0               }, /* V20/V30 */
-	{_T("three_byte"),      THREE_BYTE,     0,                  0,                  0               },
-	{_T("ext"),             MODRM,          PARAM_REG2_8,       PARAM_I4,           0               }, /* V20/V30 */
-	{_T("???"),             0,              0,                  0,                  0               },
-	{_T("???"),             0,              0,                  0,                  0               },
-	{_T("???"),             0,              0,                  0,                  0               },
-	{_T("???"),             0,              0,                  0,                  0               },
-	// 0x40
-	{_T("cmovo"),           MODRM,          PARAM_REG,          PARAM_RM,           0               },
-	{_T("cmovno"),          MODRM,          PARAM_REG,          PARAM_RM,           0               },
-	{_T("cmovb"),           MODRM,          PARAM_REG,          PARAM_RM,           0               },
-	{_T("cmovae"),          MODRM,          PARAM_REG,          PARAM_RM,           0               },
-	{_T("cmove"),           MODRM,          PARAM_REG,          PARAM_RM,           0               },
-	{_T("cmovne"),          MODRM,          PARAM_REG,          PARAM_RM,           0               },
-	{_T("cmovbe"),          MODRM,          PARAM_REG,          PARAM_RM,           0               },
-	{_T("cmova"),           MODRM,          PARAM_REG,          PARAM_RM,           0               },
-	{_T("cmovs"),           MODRM,          PARAM_REG,          PARAM_RM,           0               },
-	{_T("cmovns"),          MODRM,          PARAM_REG,          PARAM_RM,           0               },
-	{_T("cmovpe"),          MODRM,          PARAM_REG,          PARAM_RM,           0               },
-	{_T("cmovpo"),          MODRM,          PARAM_REG,          PARAM_RM,           0               },
-	{_T("cmovl"),           MODRM,          PARAM_REG,          PARAM_RM,           0               },
-	{_T("cmovge"),          MODRM,          PARAM_REG,          PARAM_RM,           0               },
-	{_T("cmovle"),          MODRM,          PARAM_REG,          PARAM_RM,           0               },
-	{_T("cmovg"),           MODRM,          PARAM_REG,          PARAM_RM,           0               },
-	// 0x50
-	{_T("movmskps\0")
-	 _T("movmskpd\0")
-	 _T("???\0")
-	 _T("???"),             MODRM|VAR_NAME4,PARAM_REG3264,      PARAM_XMMM,         0               },
-	{_T("sqrtps\0")
-	 _T("sqrtpd\0")
-	 _T("sqrtsd\0")
-	 _T("sqrtss"),          MODRM|VAR_NAME4,PARAM_XMM,          PARAM_XMMM,         0               },
-	{_T("rsqrtps\0")
-	 _T("???\0")
-	 _T("???\0")
-	 _T("rsqrtss"),         MODRM|VAR_NAME4,PARAM_XMM,          PARAM_XMMM,         0               },
-	{_T("rcpps\0")
-	 _T("???\0")
-	 _T("???\0")
-	 _T("rcpss"),           MODRM|VAR_NAME4,PARAM_XMM,          PARAM_XMMM,         0               },
-	{_T("andps\0")
-	 _T("andpd\0")
-	 _T("???\0")
-	 _T("???"),             MODRM|VAR_NAME4,PARAM_XMM,          PARAM_XMMM,         0               },
-	{_T("andnps\0")
-	 _T("andnpd\0")
-	 _T("???\0")
-	 _T("???"),             MODRM|VAR_NAME4,PARAM_XMM,          PARAM_XMMM,         0               },
-	{_T("orps\0")
-	 _T("orpd\0")
-	 _T("???\0")
-	 _T("???"),             MODRM|VAR_NAME4,PARAM_XMM,          PARAM_XMMM,         0               },
-	{_T("xorps\0")
-	 _T("xorpd\0")
-	 _T("???\0")
-	 _T("???"),             MODRM|VAR_NAME4,PARAM_XMM,          PARAM_XMMM,         0               },
-	{_T("addps\0")
-	 _T("addpd\0")
-	 _T("addsd\0")
-	 _T("addss"),           MODRM|VAR_NAME4,PARAM_XMM,          PARAM_XMMM,         0               },
-	{_T("mulps\0")
-	 _T("mulpd\0")
-	 _T("mulsd\0")
-	 _T("mulss"),           MODRM|VAR_NAME4,PARAM_XMM,          PARAM_XMMM,         0               },
-	{_T("cvtps2pd\0")
-	 _T("cvtpd2ps\0")
-	 _T("cvtsd2ss\0")
-	 _T("cvtss2sd"),        MODRM|VAR_NAME4,PARAM_XMM,          PARAM_XMMM,         0               },
-	{_T("cvtdq2ps\0")
-	 _T("cvtps2dq\0")
-	 _T("???\0")
-	 _T("cvttps2dq"),       MODRM|VAR_NAME4,PARAM_XMM,          PARAM_XMMM,         0               },
-	{_T("subps\0")
-	 _T("subpd\0")
-	 _T("subsd\0")
-	 _T("subss"),           MODRM|VAR_NAME4,PARAM_XMM,          PARAM_XMMM,         0               },
-	{_T("minps\0")
-	 _T("minpd\0")
-	 _T("minsd\0")
-	 _T("minss"),           MODRM|VAR_NAME4,PARAM_XMM,          PARAM_XMMM,         0               },
-	{_T("divps\0")
-	 _T("divpd\0")
-	 _T("divsd\0")
-	 _T("divss"),           MODRM|VAR_NAME4,PARAM_XMM,          PARAM_XMMM,         0               },
-	{_T("maxps\0")
-	 _T("maxpd\0")
-	 _T("maxsd\0")
-	 _T("maxss"),           MODRM|VAR_NAME4,PARAM_XMM,          PARAM_XMMM,         0               },
-	// 0x60
-	{_T("punpcklbw"),       MODRM,          PARAM_MMX,          PARAM_MMXM,         0               },
-	{_T("punpcklwd"),       MODRM,          PARAM_MMX,          PARAM_MMXM,         0               },
-	{_T("punpckldq"),       MODRM,          PARAM_MMX,          PARAM_MMXM,         0               },
-	{_T("packsswb"),        MODRM,          PARAM_MMX,          PARAM_MMXM,         0               },
-	{_T("pcmpgtb"),         MODRM,          PARAM_MMX,          PARAM_MMXM,         0               },
-	{_T("pcmpgtw"),         MODRM,          PARAM_MMX,          PARAM_MMXM,         0               },
-	{_T("pcmpgtd"),         MODRM,          PARAM_MMX,          PARAM_MMXM,         0               },
-	{_T("packuswb"),        MODRM,          PARAM_MMX,          PARAM_MMXM,         0               },
-	{_T("punpckhbw"),       MODRM,          PARAM_MMX,          PARAM_MMXM,         0               },
-	{_T("punpckhwd"),       MODRM,          PARAM_MMX,          PARAM_MMXM,         0               },
-	{_T("punpckhdq"),       MODRM,          PARAM_MMX,          PARAM_MMXM,         0               },
-	{_T("packssdw"),        MODRM,          PARAM_MMX,          PARAM_MMXM,         0               },
-	{_T("???\0")
-	 _T("punpcklqdq\0")
-	 _T("???\0")
-	 _T("???\0"),           MODRM|VAR_NAME4,PARAM_XMM,          PARAM_XMMM,         0               },
-	{_T("???\0")
-	 _T("punpckhqdq\0")
-	 _T("???\0")
-	 _T("???\0"),           MODRM|VAR_NAME4,PARAM_XMM,          PARAM_XMMM,         0               },
-	{_T("movd"),            MODRM,          PARAM_MMX,          PARAM_RM,           0               },
-	{_T("movq\0")
-	 _T("movdqa\0")
-	 _T("???\0")
-	 _T("movdqu"),          MODRM|VAR_NAME4,PARAM_MMX,          PARAM_MMXM,         0               },
-	// 0x70
-	{_T("pshufw\0")
-	 _T("pshufd\0")
-	 _T("pshuflw\0")
-	 _T("pshufhw"),         MODRM|VAR_NAME4,PARAM_MMX,          PARAM_MMXM,         PARAM_UI8       },
-	{_T("group0F71"),       GROUP,          0,                  0,                  0               },
-	{_T("group0F72"),       GROUP,          0,                  0,                  0               },
-	{_T("group0F73"),       GROUP,          0,                  0,                  0               },
-	{_T("pcmpeqb"),         MODRM,          PARAM_MMX,          PARAM_MMXM,         0               },
-	{_T("pcmpeqw"),         MODRM,          PARAM_MMX,          PARAM_MMXM,         0               },
-	{_T("pcmpeqd"),         MODRM,          PARAM_MMX,          PARAM_MMXM,         0               },
-	{_T("emms"),            0,              0,                  0,                  0               },
-	{_T("vmread"),          MODRM,          PARAM_RM,           PARAM_REG,          0               },
-	{_T("vmwrite"),         MODRM,          PARAM_RM,           PARAM_REG,          0               },
-	{_T("???"),             0,              0,                  0,                  0               },
-	{_T("???"),             0,              0,                  0,                  0               },
-	{_T("???\0")
-	 _T("haddpd\0")
-	 _T("haddps\0")
-	 _T("???"),             MODRM|VAR_NAME4,PARAM_MMX,          PARAM_MMXM,         0               },
-	{_T("???\0")
-	 _T("hsubpd\0")
-	 _T("hsubps\0")
-	 _T("???"),             MODRM|VAR_NAME4,PARAM_MMX,          PARAM_MMXM,         0               },
-	{_T("movd\0")
-	 _T("movd\0")
-	 _T("???\0")
-	 _T("movq"),            MODRM|VAR_NAME4,PARAM_RM,           PARAM_MMX,          0               },
-	{_T("movq\0")
-	 _T("movdqa\0")
-	 _T("???\0")
-	 _T("movdqu"),          MODRM|VAR_NAME4,PARAM_MMXM,         PARAM_MMX,          0               },
-	// 0x80
-	{_T("jo"),              0,              PARAM_REL,          0,                  0               },
-	{_T("jno"),             0,              PARAM_REL,          0,                  0               },
-	{_T("jb"),              0,              PARAM_REL,          0,                  0               },
-	{_T("jae"),             0,              PARAM_REL,          0,                  0               },
-	{_T("je"),              0,              PARAM_REL,          0,                  0               },
-	{_T("jne"),             0,              PARAM_REL,          0,                  0               },
-	{_T("jbe"),             0,              PARAM_REL,          0,                  0               },
-	{_T("ja"),              0,              PARAM_REL,          0,                  0               },
-	{_T("js"),              0,              PARAM_REL,          0,                  0               },
-	{_T("jns"),             0,              PARAM_REL,          0,                  0               },
-	{_T("jp"),              0,              PARAM_REL,          0,                  0               },
-	{_T("jnp"),             0,              PARAM_REL,          0,                  0               },
-	{_T("jl"),              0,              PARAM_REL,          0,                  0               },
-	{_T("jge"),             0,              PARAM_REL,          0,                  0               },
-	{_T("jle"),             0,              PARAM_REL,          0,                  0               },
-	{_T("jg"),              0,              PARAM_REL,          0,                  0               },
-	// 0x90
-	{_T("seto"),            MODRM,          PARAM_RMPTR8,       0,                  0               },
-	{_T("retrbi"),          0,              0,                  0,                  0               }, /* V25/V35 only */
-	{_T("fint"),            0,              0,                  0,                  0               }, /* V25/V35 only */
-	{_T("setae"),           MODRM,          PARAM_RMPTR8,       0,                  0               },
-	{_T("tsksw"),           MODRM,          PARAM_REG2_16,      0,                  0               }, /* V25/V35 only */
-	{_T("movspb"),          MODRM,          PARAM_REG2_16,      0,                  0               }, /* V25/V35 only */
-	{_T("setbe"),           MODRM,          PARAM_RMPTR8,       0,                  0               },
-	{_T("seta"),            MODRM,          PARAM_RMPTR8,       0,                  0               },
-	{_T("sets"),            MODRM,          PARAM_RMPTR8,       0,                  0               },
-	{_T("setns"),           MODRM,          PARAM_RMPTR8,       0,                  0               },
-	{_T("setp"),            MODRM,          PARAM_RMPTR8,       0,                  0               },
-	{_T("setnp"),           MODRM,          PARAM_RMPTR8,       0,                  0               },
-	{_T("btclr"),           0,              PARAM_SFREG,        PARAM_I3,           PARAM_REL8      }, /* V25/V35 only */
-	{_T("setge"),           MODRM,          PARAM_RMPTR8,       0,                  0               },
-	{_T("stop"),            0,              0,                  0,                  0               }, /* V25/V35 only */
-	{_T("setg"),            MODRM,          PARAM_RMPTR8,       0,                  0               },
-	// 0xa0
-	{_T("push    fs"),      0,              0,                  0,                  0               },
-	{_T("pop     fs"),      0,              0,                  0,                  0               },
-	{_T("cpuid"),           0,              0,                  0,                  0               },
-	{_T("bt"),              MODRM,          PARAM_RM,           PARAM_REG,          0               },
-	{_T("shld"),            MODRM,          PARAM_RM,           PARAM_REG,          PARAM_UI8       },
-	{_T("shld"),            MODRM,          PARAM_RM,           PARAM_REG,          PARAM_CL        },
-	{_T("???"),             0,              0,                  0,                  0               },
-	{_T("???"),             0,              0,                  0,                  0               },
-	{_T("push    gs"),      0,              0,                  0,                  0               },
-	{_T("pop     gs"),      0,              0,                  0,                  0               },
-	{_T("rsm"),             0,              0,                  0,                  0               },
-	{_T("bts"),             MODRM,          PARAM_RM,           PARAM_REG,          0               },
-	{_T("shrd"),            MODRM,          PARAM_RM,           PARAM_REG,          PARAM_UI8       },
-	{_T("shrd"),            MODRM,          PARAM_RM,           PARAM_REG,          PARAM_CL        },
-	{_T("group0FAE"),       GROUP,          0,                  0,                  0               },
-	{_T("imul"),            MODRM,          PARAM_REG,          PARAM_RM,           0               },
-	// 0xb0
-	{_T("cmpxchg"),         MODRM,          PARAM_RM8,          PARAM_REG,          0               },
-	{_T("cmpxchg"),         MODRM,          PARAM_RM,           PARAM_REG,          0               },
-	{_T("lss"),             MODRM,          PARAM_REG,          PARAM_RM,           0               },
-	{_T("btr"),             MODRM,          PARAM_RM,           PARAM_REG,          0               },
-	{_T("lfs"),             MODRM,          PARAM_REG,          PARAM_RM,           0               },
-	{_T("lgs"),             MODRM,          PARAM_REG,          PARAM_RM,           0               },
-	{_T("movzx"),           MODRM,          PARAM_REG,          PARAM_RMPTR8,       0               },
-	{_T("movzx"),           MODRM,          PARAM_REG,          PARAM_RMPTR16,      0               },
-	{_T("???\0")
-	 _T("???\0")
-	 _T("???\0")
-	 _T("popcnt"),          MODRM|VAR_NAME4,PARAM_REG,          PARAM_RM16,         0               },
-	{_T("ud2"),             0,              0,                  0,                  0               },
-	{_T("group0FBA"),       GROUP,          0,                  0,                  0               },
-	{_T("btc"),             MODRM,          PARAM_RM,           PARAM_REG,          0               },
-	{_T("bsf\0")
-	 _T("???\0")
-	 _T("???\0")
-	 _T("tzcnt"),           MODRM|VAR_NAME4,PARAM_REG,          PARAM_RM,           0               },
-	{_T("bsr\0")
-	 _T("???\0")
-	 _T("???\0")
-	 _T("lzcnt"),           MODRM|VAR_NAME4,PARAM_REG,          PARAM_RM,           0,              DASMFLAG_STEP_OVER},
-	{_T("movsx"),           MODRM,          PARAM_REG,          PARAM_RMPTR8,       0               },
-	{_T("movsx"),           MODRM,          PARAM_REG,          PARAM_RMPTR16,      0               },
-	// 0xc0
-	{_T("xadd"),            MODRM,          PARAM_RM8,          PARAM_REG,          0               },
-	{_T("xadd"),            MODRM,          PARAM_RM,           PARAM_REG,          0               },
-	{_T("cmpps\0")
-	 _T("cmppd\0")
-	 _T("cmpsd\0")
-	 _T("cmpss"),           MODRM|VAR_NAME4,PARAM_XMM,          PARAM_XMMM,         0               },
-	{_T("movnti"),          MODRM,          PARAM_RM,           PARAM_REG,          0               },
-	{_T("pinsrw"),          MODRM,          PARAM_MMX,          PARAM_RM,           PARAM_UI8       },
-	{_T("pextrw"),          MODRM,          PARAM_MMX,          PARAM_RM,           PARAM_UI8       },
-	{_T("shufps\0")
-	 _T("shufpd\0")
-	 _T("???\0")
-	 _T("???"),             MODRM|VAR_NAME4,PARAM_XMM,          PARAM_XMMM,         PARAM_UI8       },
-	{_T("group0FC7"),       GROUP,          0,                  0,                  0               },
-	{_T("bswap"),           0,              PARAM_EAX,          0,                  0               },
-	{_T("bswap"),           0,              PARAM_ECX,          0,                  0               },
-	{_T("bswap"),           0,              PARAM_EDX,          0,                  0               },
-	{_T("bswap"),           0,              PARAM_EBX,          0,                  0               },
-	{_T("bswap"),           0,              PARAM_ESP,          0,                  0               },
-	{_T("bswap"),           0,              PARAM_EBP,          0,                  0               },
-	{_T("bswap"),           0,              PARAM_ESI,          0,                  0               },
-	{_T("bswap"),           0,              PARAM_EDI,          0,                  0               },
-	// 0xd0
-	{_T("???\0")
-	 _T("addsubpd\0")
-	 _T("addsubps\0")
-	 _T("???\0"),           MODRM|VAR_NAME4,PARAM_XMM,          PARAM_XMMM,         0               },
-	{_T("psrlw"),           MODRM,          PARAM_MMX,          PARAM_MMXM,         0               },
-	{_T("psrld"),           MODRM,          PARAM_MMX,          PARAM_MMXM,         0               },
-	{_T("psrlq"),           MODRM,          PARAM_MMX,          PARAM_MMXM,         0               },
-	{_T("paddq"),           MODRM,          PARAM_MMX,          PARAM_MMXM,         0               },
-	{_T("pmullw"),          MODRM,          PARAM_MMX,          PARAM_MMXM,         0               },
-	{_T("???\0")
-	 _T("movq\0")
-	 _T("movdq2q\0")
-	 _T("movq2dq"),         MODRM|VAR_NAME4,PARAM_MMX,          PARAM_MMXM,         0               },
-	{_T("pmovmskb"),        MODRM,          PARAM_REG3264,      PARAM_MMXM,         0               },
-	{_T("psubusb"),         MODRM,          PARAM_MMX,          PARAM_MMXM,         0               },
-	{_T("psubusw"),         MODRM,          PARAM_MMX,          PARAM_MMXM,         0               },
-	{_T("pminub"),          MODRM,          PARAM_MMX,          PARAM_MMXM,         0               },
-	{_T("pand"),            MODRM,          PARAM_MMX,          PARAM_MMXM,         0               },
-	{_T("paddusb"),         MODRM,          PARAM_MMX,          PARAM_MMXM,         0               },
-	{_T("paddusw"),         MODRM,          PARAM_MMX,          PARAM_MMXM,         0               },
-	{_T("pmaxub"),          MODRM,          PARAM_MMX,          PARAM_MMXM,         0               },
-	{_T("pandn"),           MODRM,          PARAM_MMX,          PARAM_MMXM,         0               },
-	// 0xe0
-	{_T("brkxa"),           0,              PARAM_UI8,          0,                  0               }, /* V33,53 only */
-	{_T("psraw"),           MODRM,          PARAM_MMX,          PARAM_MMXM,         0               },
-	{_T("psrad"),           MODRM,          PARAM_MMX,          PARAM_MMXM,         0               },
-	{_T("pavgw"),           MODRM,          PARAM_MMX,          PARAM_MMXM,         0               },
-	{_T("pmulhuw"),         MODRM,          PARAM_MMX,          PARAM_MMXM,         0               },
-	{_T("pmulhw"),          MODRM,          PARAM_MMX,          PARAM_MMXM,         0               },
-	{_T("???\0")
-	 _T("cvttpd2dq\0")
-	 _T("cvtpd2dq\0")
-	 _T("cvtdq2pd"),        MODRM|VAR_NAME4,PARAM_XMM,          PARAM_XMMM,         0               },
-	{_T("movntq\0")
-	 _T("movntdq\0")
-	 _T("???\0")
-	 _T("???\0"),           MODRM|VAR_NAME4,PARAM_M64,          PARAM_MMX,          0               },
-	{_T("psubsb"),          MODRM,          PARAM_MMX,          PARAM_MMXM,         0               },
-	{_T("psubsw"),          MODRM,          PARAM_MMX,          PARAM_MMXM,         0               },
-	{_T("pminsw"),          MODRM,          PARAM_MMX,          PARAM_MMXM,         0               },
-	{_T("por"),             MODRM,          PARAM_MMX,          PARAM_MMXM,         0               },
-	{_T("paddsb"),          MODRM,          PARAM_MMX,          PARAM_MMXM,         0               },
-	{_T("paddsw"),          MODRM,          PARAM_MMX,          PARAM_MMXM,         0               },
-	{_T("pmaxsw"),          MODRM,          PARAM_MMX,          PARAM_MMXM,         0               },
-	{_T("pxor"),            MODRM,          PARAM_MMX,          PARAM_MMXM,         0               },
-	// 0xf0
-	{_T("retxa"),           0,              PARAM_UI8,          0,                  0               }, /* V33,53 only */
-	{_T("psllw"),           MODRM,          PARAM_MMX,          PARAM_MMXM,         0               },
-	{_T("pslld"),           MODRM,          PARAM_MMX,          PARAM_MMXM,         0               },
-	{_T("psllq"),           MODRM,          PARAM_MMX,          PARAM_MMXM,         0               },
-	{_T("pmuludq"),         MODRM,          PARAM_MMX,          PARAM_MMXM,         0               },
-	{_T("pmaddwd"),         MODRM,          PARAM_MMX,          PARAM_MMXM,         0               },
-	{_T("psadbw"),          MODRM,          PARAM_MMX,          PARAM_MMXM,         0               },
-	{_T("maskmovq\0")
-	 _T("maskmovdqu\0")
-	 _T("???\0")
-	 _T("???"),             MODRM|VAR_NAME4,PARAM_MMX,          PARAM_MMXM,         0               },
-	{_T("psubb"),           MODRM,          PARAM_MMX,          PARAM_MMXM,         0               },
-	{_T("psubw"),           MODRM,          PARAM_MMX,          PARAM_MMXM,         0               },
-	{_T("psubd"),           MODRM,          PARAM_MMX,          PARAM_MMXM,         0               },
-	{_T("psubq"),           MODRM,          PARAM_MMX,          PARAM_MMXM,         0               },
-	{_T("paddb"),           MODRM,          PARAM_MMX,          PARAM_MMXM,         0               },
-	{_T("paddw"),           MODRM,          PARAM_MMX,          PARAM_MMXM,         0               },
-	{_T("paddd"),           MODRM,          PARAM_MMX,          PARAM_MMXM,         0               },
-	{_T("brkem"),           0,              PARAM_UI8,          0,                  0               } /* V20,30,40,50 only */
-};
-
 static const GROUP_OP group_op_table[] =
 {
 	{_T("group80"),            group80_table           },
@@ -2643,69 +1974,9 @@
 	{_T("rax"), _T("rcx"), _T("rdx"), _T("rbx"), _T("rsp"), _T("rbp"), _T("rsi"), _T("rdi"), _T("r8"),  _T("r9"),  _T("r10"), _T("r11"), _T("r12"), _T("r13"), _T("r14"), _T("r15")}
 };
 
-static const _TCHAR *const i386_reg8[8] =
-{
-	_T("al"), _T("cl"), _T("dl"), _T("bl"), _T("ah"), _T("ch"), _T("dh"), _T("bh")
-};
-static const _TCHAR *const i386_reg8rex[16] =
-{
-	_T("al"), _T("cl"), _T("dl"), _T("bl"), _T("spl"), _T("bpl"), _T("sil"), _T("dil"), _T("r8l"), _T("r9l"), _T("r10l"), _T("r11l"), _T("r12l"), _T("r13l"), _T("r14l"), _T("r15l")
-};
-static const _TCHAR *const i386_sreg[8] =
-{
-	_T("es"), _T("cs"), _T("ss"), _T("ds"), _T("fs"), _T("gs"), _T("???"), _T("???")
-};
-static const char *const nec_sfreg[256] =
-{
-	/* 0x00 */
-	_T("p0"),	_T("pm0"),	_T("pmc0"),	_T("???"),	_T("???"),	_T("???"),	_T("???"),	_T("???"),
-	_T("p1"),	_T("pm1"),	_T("pmc1"),	_T("???"),	_T("???"),	_T("???"),	_T("???"),	_T("???"),
-	/* 0x10 */
-	_T("p2"),	_T("pm2"),	_T("pmc2"),	_T("???"),	_T("???"),	_T("???"),	_T("???"),	_T("???"),
-	_T("???"),	_T("???"),	_T("???"),	_T("???"),	_T("???"),	_T("???"),	_T("???"),	_T("???"),
-	/* 0x20 */
-	_T("???"),	_T("???"),	_T("???"),	_T("???"),	_T("???"),	_T("???"),	_T("???"),	_T("???"),
-	_T("???"),	_T("???"),	_T("???"),	_T("???"),	_T("???"),	_T("???"),	_T("???"),	_T("???"),
-	/* 0x30 */
-	_T("???"),	_T("???"),	_T("???"),	_T("???"),	_T("???"),	_T("???"),	_T("???"),	_T("???"),
-	_T("pt"),	_T("???"),	_T("???"),	_T("pmt"),	_T("???"),	_T("???"),	_T("???"),	_T("???"),
-	/* 0x40 */
-	_T("intm"),	_T("???"),	_T("???"),	_T("???"),	_T("ems0"),	_T("ems1"),	_T("ems2"),	_T("???"),
-	_T("???"),	_T("???"),	_T("???"),	_T("???"),	_T("exic0"),	_T("exic1"),	_T("exic2"),	_T("???"),
-	/* 0x50 */
-	_T("???"),	_T("???"),	_T("???"),	_T("???"),	_T("???"),	_T("???"),	_T("???"),	_T("???"),
-	_T("???"),	_T("???"),	_T("???"),	_T("???"),	_T("???"),	_T("???"),	_T("???"),	_T("???"),
-	/* 0x60 */
-	_T("rxb0"),	_T("???"),	_T("txb0"),	_T("???"),	_T("???"),	_T("srms0"),	_T("stms0"),	_T("???"),
-	_T("scm0"),	_T("scc0"),	_T("brg0"),	_T("scs0"),	_T("seic0"),	_T("sric0"),	_T("stic0"),	_T("???"),
-	/* 0x70 */
-	_T("rxb1"),	_T("???"),	_T("txb1"),	_T("???"),	_T("???"),	_T("srms1"),	_T("stms1"),	_T("???"),
-	_T("scm1"),	_T("scc1"),	_T("brg1"),	_T("scs1"),	_T("seic1"),	_T("sric1"),	_T("stic1"),	_T("???"),
-	/* 0x80 */
-	_T("tm0"),	_T("???"),	_T("md0"),	_T("???"),	_T("???"),	_T("???"),	_T("???"),	_T("???"),
-	_T("tm1"),	_T("???"),	_T("md1"),	_T("???"),	_T("???"),	_T("???"),	_T("???"),	_T("???"),
-	/* 0x90 */
-	_T("tmc0"),	_T("tmc1"),	_T("???"),	_T("???"),	_T("tmms0"),	_T("tmms1"),	_T("tmms2"),	_T("???"),
-	_T("???"),	_T("???"),	_T("???"),	_T("???"),	_T("tmic0"),	_T("tmic1"),	_T("tmic2"),	_T("???"),
-	/* 0xa0 */
-	_T("dmac0"),	_T("dmam0"),	_T("dmac1"),	_T("dmam1"),	_T("???"),	_T("???"),	_T("???"),	_T("???"),
-	_T("???"),	_T("???"),	_T("???"),	_T("???"),	_T("dic0"),	_T("dic1"),	_T("???"),	_T("???"),
-	/* 0xb0 */
-	_T("???"),	_T("???"),	_T("???"),	_T("???"),	_T("???"),	_T("???"),	_T("???"),	_T("???"),
-	_T("???"),	_T("???"),	_T("???"),	_T("???"),	_T("???"),	_T("???"),	_T("???"),	_T("???"),
-	/* 0xc0 */
-	_T("sar0l"),	_T("sar0m"),	_T("sar0h"),	_T("???"),	_T("dar0l"),	_T("dar0m"),	_T("dar0h"),	_T("???"),
-	_T("tc0l"),	_T("tc0h"),	_T("???"),	_T("???"),	_T("???"),	_T("???"),	_T("???"),	_T("???"),
-	/* 0xd0 */
-	_T("sar1l"),	_T("sar1m"),	_T("sar1h"),	_T("???"),	_T("dar1l"),	_T("dar1m"),	_T("dar1h"),	_T("???"),
-	_T("tc1l"),	_T("tc1h"),	_T("???"),	_T("???"),	_T("???"),	_T("???"),	_T("???"),	_T("???"),
-	/* 0xe0 */
-	_T("stbc"),	_T("rfm"),	_T("???"),	_T("???"),	_T("???"),	_T("???"),	_T("???"),	_T("???"),
-	_T("wtc"),	_T("???"),	_T("flag"),	_T("prc"),	_T("tbic"),	_T("???"),	_T("???"),	_T("irqs"),
-	/* 0xf0 */
-	_T("???"),	_T("???"),	_T("???"),	_T("???"),	_T("???"),	_T("???"),	_T("???"),	_T("???"),
-	_T("???"),	_T("???"),	_T("???"),	_T("???"),	_T("ispr"),	_T("???"),	_T("???"),	_T("idb")
-};
+static const _TCHAR *const i386_reg8[8] = {_T("al"), _T("cl"), _T("dl"), _T("bl"), _T("ah"), _T("ch"), _T("dh"), _T("bh")};
+static const _TCHAR *const i386_reg8rex[16] = {_T("al"), _T("cl"), _T("dl"), _T("bl"), _T("spl"), _T("bpl"), _T("sil"), _T("dil"), _T("r8l"), _T("r9l"), _T("r10l"), _T("r11l"), _T("r12l"), _T("r13l"), _T("r14l"), _T("r15l")};
+static const _TCHAR *const i386_sreg[8] = {_T("es"), _T("cs"), _T("ss"), _T("ds"), _T("fs"), _T("gs"), _T("???"), _T("???")};
 
 static int address_size;
 static int operand_size;
@@ -2720,7 +1991,6 @@
 static UINT8 rex, regex, sibex, rmex;
 static UINT8 pre0f;
 static UINT8 curmode;
-static UINT8 v30mode;
 
 #define MODRM_REG1  ((modrm >> 3) & 0x7)
 #define MODRM_REG2  (modrm & 0x7)
@@ -2973,14 +2243,6 @@
 			s += _stprintf( s, _T("%s"), i386_reg[0][MODRM_REG1 | regex] );
 			break;
 
-		case PARAM_REG2_8:
-			s += _stprintf( s, _T("%s"), i386_reg8[MODRM_REG2] );
-			break;
-
-		case PARAM_REG2_16:
-			s += _stprintf( s, _T("%s"), i386_reg[0][MODRM_REG2] );
-			break;
-
 		case PARAM_REG32:
 			s += _stprintf( s, _T("%s"), i386_reg[1][MODRM_REG1 | regex] );
 			break;
@@ -3112,11 +2374,6 @@
 			}
 			break;
 
-		case PARAM_I3:
-			i8 = _FETCHD();
-			s += _stprintf( s, _T("%d"), i8 & 0x07 );
-			break;
-
 		case PARAM_I4:
 			i8 = _FETCHD();
 			s += _stprintf( s, _T("%d"), i8 & 0x0f );
@@ -3232,11 +2489,6 @@
 			s += _stprintf( s, _T("%s"), i386_sreg[MODRM_REG1] );
 			break;
 
-		case PARAM_SFREG:
-			i8 = _FETCHD();
-			s += _stprintf( s, _T("%s"), nec_sfreg[i8] );
-			break;
-
 		case PARAM_CREG:
 			s += _stprintf( s, _T("cr%d"), MODRM_REG1 | regex );
 			break;
@@ -3691,10 +2943,7 @@
 				operand_prefix = 1;
 			}
 			op2 = _FETCH();
-			if (v30mode)
-				decode_opcode( s, &necv_opcode_table1[op2], op2 );
-			else
-				decode_opcode( s, &i386_opcode_table1[op2], op2 );
+			decode_opcode( s, &i386_opcode_table1[op2], op2 );
 			return;
 
 		case ADDR_SIZE:
@@ -3708,20 +2957,14 @@
 				address_prefix = 1;
 			}
 			op2 = _FETCH();
-			if (v30mode)
-				decode_opcode( s, &necv_opcode_table1[op2], op2 );
-			else
-				decode_opcode( s, &i386_opcode_table1[op2], op2 );
+			decode_opcode( s, &i386_opcode_table1[op2], op2 );
 			return;
 
 		case TWO_BYTE:
 			if (&opcode_ptr[-2] >= opcode_ptr_base)
 				pre0f = opcode_ptr[-2];
 			op2 = _FETCHD();
-			if (v30mode)
-				decode_opcode( s, &necv_opcode_table2[op2], op1 );
-			else
-				decode_opcode( s, &i386_opcode_table2[op2], op1 );
+			decode_opcode( s, &i386_opcode_table2[op2], op1 );
 			return;
 
 		case THREE_BYTE:
@@ -3741,10 +2984,7 @@
 			rex = regex = sibex = rmex = 0;
 			segment = op->flags;
 			op2 = _FETCH();
-			if (v30mode)
-				decode_opcode( s, &necv_opcode_table1[op2], op2 );
-			else
-				decode_opcode( s, &i386_opcode_table1[op2], op2 );
+			decode_opcode( s, &i386_opcode_table1[op2], op2 );
 			return;
 
 		case PREFIX:
@@ -3753,10 +2993,7 @@
 				s += _stprintf( s, _T("%-7s "), op->mnemonic );
 			if ((op2 == 0x90) && !pre0f)
 				pre0f = op1;
-			if (v30mode)
-				decode_opcode( s, &necv_opcode_table1[op2], op2 );
-			else
-				decode_opcode( s, &i386_opcode_table1[op2], op2 );
+			decode_opcode( s, &i386_opcode_table1[op2], op2 );
 			return;
 
 		case GROUP:
@@ -3834,36 +3071,26 @@
 			address_size = 0;
 			operand_size = 0;
 			max_length = 8; /* maximum without redundant prefixes - not enforced by chip */
-			v30mode = 0;
 			break;
 		case 2: /* 80286 */
 			address_size = 0;
 			operand_size = 0;
 			max_length = 10;
 			break;
-		case 3: /* V30 */
-			address_size = 0;
-			operand_size = 0;
-			max_length = 8; /* maximum without redundant prefixes - not enforced by chip */
-			v30mode = 1;
-			break;
 		case 16: /* 80386+ 16-bit code segment */
 			address_size = 0;
 			operand_size = 0;
 			max_length = 15;
-			v30mode = 0;
 			break;
 		case 32: /* 80386+ 32-bit code segment */
 			address_size = 1;
 			operand_size = 1;
 			max_length = 15;
-			v30mode = 0;
 			break;
 		case 64: /* x86_64 */
 			address_size = 2;
 			operand_size = 1;
 			max_length = 15;
-			v30mode = 0;
 			break;
 	}
 	pc = eip;
@@ -3877,21 +3104,13 @@
 
 	op = _FETCH();
 
-	if (v30mode)
-		decode_opcode( buffer, &necv_opcode_table1[op], op );
-	else
-		decode_opcode( buffer, &i386_opcode_table1[op], op );
+	decode_opcode( buffer, &i386_opcode_table1[op], op );
 	return (pc-eip) | dasm_flags | DASMFLAG_SUPPORTED;
 }
 
 int i386_dasm_one(_TCHAR *buffer, offs_t eip, const UINT8 *oprom, int mode)
 {
 	return i386_dasm_one_ex(buffer, eip, oprom, mode);
-}
-
-CPU_DISASSEMBLE( nec_generic )
-{
-	return i386_dasm_one_ex(buffer, eip, oprom, 3);
 }
 
 CPU_DISASSEMBLE( x86_16 )
diff -ruN source/src/vm/mame/emu/cpu/i386/i386op16.c src/vm/mame/emu/cpu/i386/i386op16.c
--- source/src/vm/mame/emu/cpu/i386/i386op16.c	2025-04-28 16:00:00
+++ src/vm/mame/emu/cpu/i386/i386op16.c	2025-04-28 22:36:36
@@ -1194,8 +1194,8 @@
 		{
 			UINT32 addr;
 			if(!STACK_32BIT)
-			{
-				REG16(BP) -= 2;
+		{
+			REG16(BP) -= 2;
 				addr = REG16(BP);
 			}
 			else
@@ -3802,35 +3802,30 @@
 
 static void I386OP(lds16)(i386_state *cpustate)             // Opcode 0xc5
 {
-	if(I386OP(load_far_pointer16)(cpustate, DS)) {
+	if(I386OP(load_far_pointer16)(cpustate, DS))
 		CYCLES(cpustate,CYCLES_LDS);
-	}
 }
 
 static void I386OP(lss16)(i386_state *cpustate)             // Opcode 0x0f 0xb2
 {
-	if(I386OP(load_far_pointer16)(cpustate, SS)) {
+	if(I386OP(load_far_pointer16)(cpustate, SS))
 		CYCLES(cpustate,CYCLES_LSS);
-	}
 }
 
 static void I386OP(les16)(i386_state *cpustate)             // Opcode 0xc4
 {
-	if(I386OP(load_far_pointer16)(cpustate, ES)) {
+	if(I386OP(load_far_pointer16)(cpustate, ES))
 		CYCLES(cpustate,CYCLES_LES);
-	}
 }
 
 static void I386OP(lfs16)(i386_state *cpustate)             // Opcode 0x0f 0xb4
 {
-	if(I386OP(load_far_pointer16)(cpustate, FS)) {
+	if(I386OP(load_far_pointer16)(cpustate, FS))
 		CYCLES(cpustate,CYCLES_LFS);
-	}
 }
 
 static void I386OP(lgs16)(i386_state *cpustate)             // Opcode 0x0f 0xb5
 {
-	if(I386OP(load_far_pointer16)(cpustate, GS)) {
+	if(I386OP(load_far_pointer16)(cpustate, GS))
 		CYCLES(cpustate,CYCLES_LGS);
-	}
 }
diff -ruN source/src/vm/mame/emu/cpu/i386/i386op32.c src/vm/mame/emu/cpu/i386/i386op32.c
--- source/src/vm/mame/emu/cpu/i386/i386op32.c	2025-04-28 16:00:00
+++ src/vm/mame/emu/cpu/i386/i386op32.c	2025-04-28 22:36:36
@@ -1030,20 +1030,10 @@
 
 	if(level > 0)
 	{
-		for(x=1;x<=level-1;x++)
+		for(x=1;x<level-1;x++)
 		{
-			UINT32 addr;
-			if(!STACK_32BIT)
-			{
-				REG16(BP) -= 4;
-				addr = REG16(BP);
-			}
-			else
-			{
-				REG32(EBP) -= 4;
-				addr = REG32(EBP);
-			}
-			PUSH32(cpustate,READ32(cpustate,i386_translate(cpustate, SS, addr, 0, 4)));
+			REG32(EBP) -= 4;
+			PUSH32(cpustate,READ32(cpustate,REG32(EBP)));
 		}
 		PUSH32(cpustate,frameptr);
 	}
diff -ruN source/src/vm/mame/emu/cpu/i386/i386ops.c src/vm/mame/emu/cpu/i386/i386ops.c
--- source/src/vm/mame/emu/cpu/i386/i386ops.c	2025-04-28 16:00:00
+++ src/vm/mame/emu/cpu/i386/i386ops.c	2025-04-28 22:36:36
@@ -1228,7 +1228,7 @@
 		default:
 			logerror("i386: Invalid REP/opcode %02X combination at %08x\n",opcode, cpustate->pc - 2);
 			cpustate->pc--;
-			return;
+			break;
 	}
 
 	if( cpustate->address_size ) {
@@ -2403,71 +2403,18 @@
 
 static void I386OP(daa)(i386_state *cpustate)               // Opcode 0x27
 {
-#if 0
 	I386OP(decimal_adjust)(cpustate, +1);
-#else
-	// from DOSBox
-	if (((REG8(AL) & 0x0f) > 0x09) || cpustate->AF) {
-		if ((REG8(AL) > 0x99) || cpustate->CF) {
-			REG8(AL) += 0x60;
-			cpustate->CF = 1;
-		} else {
-			cpustate->CF = 0;
-		}
-		REG8(AL) += 0x06;
-		cpustate->AF = 1;
-	} else {
-		if ((REG8(AL) > 0x99) || cpustate->CF) {
-			REG8(AL) += 0x60;
-			cpustate->CF = 1;
-		} else {
-			cpustate->CF = 0;
-		}
-		cpustate->AF = 0;
-	}
-	cpustate->SF = ((REG8(AL) & 0x80) != 0);
-	cpustate->ZF = (REG8(AL) == 0);
-	cpustate->PF = i386_parity_table[REG8(AL)];
-#endif
 	CYCLES(cpustate,CYCLES_DAA);
 }
 
 static void I386OP(das)(i386_state *cpustate)               // Opcode 0x2f
 {
-#if 0
 	I386OP(decimal_adjust)(cpustate, -1);
-#else
-	// from DOSBox
-	UINT8 osigned = REG8(AL) & 0x80;
-	if (((REG8(AL) & 0x0f) > 9) || cpustate->AF) {
-		if ((REG8(AL) > 0x99) || cpustate->CF) {
-			REG8(AL) -= 0x60;
-			cpustate->CF = 1;
-		} else {
-			cpustate->CF = (REG8(AL) <= 0x05);
-		}
-		REG8(AL) -= 6;
-		cpustate->AF = 1;
-	} else {
-		if ((REG8(AL) > 0x99) || cpustate->CF) {
-			REG8(AL) -= 0x60;
-			cpustate->CF = 1;
-		} else {
-			cpustate->CF = 0;
-		}
-		cpustate->AF = 0;
-	}
-	cpustate->OF = ((osigned != 0) && ((REG8(AL) & 0x80) == 0));
-	cpustate->SF = ((REG8(AL) & 0x80) != 0);
-	cpustate->ZF = (REG8(AL) == 0);
-	cpustate->PF = i386_parity_table[REG8(AL)];
-#endif
 	CYCLES(cpustate,CYCLES_DAS);
 }
 
 static void I386OP(aaa)(i386_state *cpustate)               // Opcode 0x37
 {
-#if 0
 	if( ( (REG8(AL) & 0x0f) > 9) || (cpustate->AF != 0) ) {
 		REG16(AX) = REG16(AX) + 6;
 		REG8(AH) = REG8(AH) + 1;
@@ -2477,36 +2424,12 @@
 		cpustate->AF = 0;
 		cpustate->CF = 0;
 	}
-#else
-	// from DOSBox
-	cpustate->SF = ((REG8(AL) >= 0x7a) && (REG8(AL) <= 0xf9));
-	if ((REG8(AL) & 0xf) > 9) {
-		cpustate->OF = ((REG8(AL) & 0xf0) == 0x70);
-		REG16(AX) += 0x106;
-		cpustate->CF = 1;
-		cpustate->ZF = (REG8(AL) == 0);
-		cpustate->AF = 1;
-	} else if (cpustate->AF) {
-		REG16(AX) += 0x106;
-		cpustate->OF = 0;
-		cpustate->CF = 1;
-		cpustate->ZF = 0;
-		cpustate->AF = 1;
-	} else {
-		cpustate->OF = 0;
-		cpustate->CF = 0;
-		cpustate->ZF = (REG8(AL) == 0);
-		cpustate->AF = 0;
-	}
-	cpustate->PF = i386_parity_table[REG8(AL)];
-#endif
-	REG8(AL) &= 0x0f;
+	REG8(AL) = REG8(AL) & 0x0f;
 	CYCLES(cpustate,CYCLES_AAA);
 }
 
 static void I386OP(aas)(i386_state *cpustate)               // Opcode 0x3f
 {
-#if 0
 	if (cpustate->AF || ((REG8(AL) & 0xf) > 9))
 	{
 		REG16(AX) -= 6;
@@ -2519,29 +2442,6 @@
 		cpustate->AF = 0;
 		cpustate->CF = 0;
 	}
-#else
-	// from DOSBox
-	if ((REG8(AL) & 0x0f) > 9) {
-		cpustate->SF = (REG8(AL) > 0x85);
-		REG16(AX) -= 0x106;
-		cpustate->OF = 0;
-		cpustate->CF = 1;
-		cpustate->AF = 1;
-	} else if (cpustate->AF) {
-		cpustate->OF = ((REG8(AL) >= 0x80) && (REG8(AL) <= 0x85));
-		cpustate->SF = (REG8(AL) < 0x06) || (REG8(AL) > 0x85);
-		REG16(AX) -= 0x106;
-		cpustate->CF = 1;
-		cpustate->AF = 1;
-	} else {
-		cpustate->SF = (REG8(AL) >= 0x80);
-		cpustate->OF = 0;
-		cpustate->CF = 0;
-		cpustate->AF = 0;
-	}
-	cpustate->ZF = (REG8(AL) == 0);
-	cpustate->PF = i386_parity_table[REG8(AL)];
-#endif
 	REG8(AL) &= 0x0f;
 	CYCLES(cpustate,CYCLES_AAS);
 }
@@ -2555,8 +2455,6 @@
 	REG8(AL) = (tempAL + (tempAH * i)) & 0xff;
 	REG8(AH) = 0;
 	SetSZPF8( REG8(AL) );
-	// from DOSBox
-	cpustate->CF = cpustate->OF = cpustate->AF = 0;
 	CYCLES(cpustate,CYCLES_AAD);
 }
 
@@ -2573,8 +2471,6 @@
 	REG8(AH) = tempAL / i;
 	REG8(AL) = tempAL % i;
 	SetSZPF8( REG8(AL) );
-	// from DOSBox
-	cpustate->CF = cpustate->OF = cpustate->AF = 0;
 	CYCLES(cpustate,CYCLES_AAM);
 }
 
@@ -2589,11 +2485,6 @@
 
 static void I386OP(wait)(i386_state *cpustate)              // Opcode 0x9B
 {
-	if ((cpustate->cr[0] & 0xa) == 0xa)
-	{
-		i386_trap(cpustate, FAULT_NM, 0, 0);
-		return;
-	}
 	// TODO
 }
 
diff -ruN source/src/vm/mame/emu/cpu/i386/i386ops.h src/vm/mame/emu/cpu/i386/i386ops.h
--- source/src/vm/mame/emu/cpu/i386/i386ops.h	2025-04-28 16:00:00
+++ src/vm/mame/emu/cpu/i386/i386ops.h	2025-04-28 22:36:36
@@ -189,7 +189,6 @@
 	{ 0x99,     OP_I386,                    I386OP(cwd),                    I386OP(cdq),                false},
 	{ 0x9A,     OP_I386,                    I386OP(call_abs16),             I386OP(call_abs32),         false},
 	{ 0x9B,     OP_I386,                    I386OP(wait),                   I386OP(wait),               false},
-	{ 0x9B,     OP_I486,                    I486OP(wait),                   I486OP(wait),               false},
 	{ 0x9C,     OP_I386,                    I386OP(pushf),                  I386OP(pushfd),             false},
 	{ 0x9D,     OP_I386,                    I386OP(popf),                   I386OP(popfd),              false},
 	{ 0x9E,     OP_I386,                    I386OP(sahf),                   I386OP(sahf),               false},
@@ -459,13 +458,13 @@
 	{ 0xB4,     OP_2BYTE|OP_I386,           I386OP(lfs16),                  I386OP(lfs32),              false},
 	{ 0xB5,     OP_2BYTE|OP_I386,           I386OP(lgs16),                  I386OP(lgs32),              false},
 	{ 0xB6,     OP_2BYTE|OP_I386,           I386OP(movzx_r16_rm8),          I386OP(movzx_r32_rm8),      false},
-	{ 0xB7,     OP_2BYTE|OP_I386,           I386OP(mov_r16_rm16),           I386OP(movzx_r32_rm16),     false},
+	{ 0xB7,     OP_2BYTE|OP_I386,           I386OP(invalid),                I386OP(movzx_r32_rm16),     false},
 	{ 0xBA,     OP_2BYTE|OP_I386,           I386OP(group0FBA_16),           I386OP(group0FBA_32),       true },
 	{ 0xBB,     OP_2BYTE|OP_I386,           I386OP(btc_rm16_r16),           I386OP(btc_rm32_r32),       true },
 	{ 0xBC,     OP_2BYTE|OP_I386,           I386OP(bsf_r16_rm16),           I386OP(bsf_r32_rm32),       false},
 	{ 0xBD,     OP_2BYTE|OP_I386,           I386OP(bsr_r16_rm16),           I386OP(bsr_r32_rm32),       false},
 	{ 0xBE,     OP_2BYTE|OP_I386,           I386OP(movsx_r16_rm8),          I386OP(movsx_r32_rm8),      false},
-	{ 0xBF,     OP_2BYTE|OP_I386,           I386OP(mov_r16_rm16),           I386OP(movsx_r32_rm16),     false},
+	{ 0xBF,     OP_2BYTE|OP_I386,           I386OP(invalid),                I386OP(movsx_r32_rm16),     false},
 	{ 0xC0,     OP_2BYTE|OP_I486,           I486OP(xadd_rm8_r8),            I486OP(xadd_rm8_r8),        true },
 	{ 0xC1,     OP_2BYTE|OP_I486,           I486OP(xadd_rm16_r16),          I486OP(xadd_rm32_r32),      true },
 	{ 0xC2,     OP_2BYTE|OP_SSE,            SSEOP(cmpps_r128_rm128_i8),     SSEOP(cmpps_r128_rm128_i8), false},
diff -ruN source/src/vm/mame/emu/cpu/i386/i386priv.h src/vm/mame/emu/cpu/i386/i386priv.h
--- source/src/vm/mame/emu/cpu/i386/i386priv.h	2025-04-28 16:00:00
+++ src/vm/mame/emu/cpu/i386/i386priv.h	2025-04-28 22:36:36
@@ -20,6 +20,8 @@
 #define MMXOP(XX)       mmx_##XX
 #define SSEOP(XX)       sse_##XX
 
+extern int i386_dasm_one(_TCHAR *buffer, UINT32 pc, const UINT8 *oprom, int mode);
+
 enum SREGS { ES, CS, SS, DS, FS, GS };
 
 enum BREGS
@@ -440,9 +442,7 @@
 	UINT16 x87_cw;
 	UINT16 x87_sw;
 	UINT16 x87_tw;
-	UINT16 x87_ds;
 	UINT64 x87_data_ptr;
-	UINT16 x87_cs;
 	UINT64 x87_inst_ptr;
 	UINT16 x87_opcode;
 
@@ -511,8 +511,6 @@
 extern int i386_parity_table[256];
 static int i386_limit_check(i386_state *cpustate, int seg, UINT32 offset, UINT32 size);
 
-extern int x87_mf_fault(i386_state *cpustate);
-
 #define FAULT_THROW(fault,error) { throw (UINT64)(fault | (UINT64)error << 32); }
 #define PF_THROW(error) { cpustate->cr[2] = address; FAULT_THROW(FAULT_PF,error); }
 
@@ -758,9 +756,15 @@
 	cpustate->pc += offs;
 }
 
-INLINE UINT8 FETCH_FIRST_OP(i386_state *cpustate, UINT32 address)
+INLINE UINT8 FETCH(i386_state *cpustate)
 {
-	UINT8 value = cpustate->program->read_data8(address & cpustate->a20_mask);
+	UINT8 value;
+	UINT32 address = cpustate->pc, error;
+
+	if(!translate_address(cpustate,cpustate->CPL,TRANSLATE_FETCH,&address,&error))
+		PF_THROW(error);
+
+	value = cpustate->program->read_data8(address & cpustate->a20_mask);
 #ifdef DEBUG_MISSING_OPCODE
 	cpustate->opcode_bytes[cpustate->opcode_bytes_length] = value;
 	cpustate->opcode_bytes_length = (cpustate->opcode_bytes_length + 1) & 15;
@@ -768,15 +772,6 @@
 	cpustate->eip++;
 	cpustate->pc++;
 	return value;
-}
-INLINE UINT8 FETCH(i386_state *cpustate)
-{
-	UINT32 address = cpustate->pc, error;
-
-	if(!translate_address(cpustate,cpustate->CPL,TRANSLATE_FETCH,&address,&error))
-		PF_THROW(error);
-
-	return FETCH_FIRST_OP(cpustate, address);
 }
 INLINE UINT16 FETCH16(i386_state *cpustate)
 {
diff -ruN source/src/vm/mame/emu/cpu/i386/i486ops.c src/vm/mame/emu/cpu/i386/i486ops.c
--- source/src/vm/mame/emu/cpu/i386/i486ops.c	2025-04-28 16:00:00
+++ src/vm/mame/emu/cpu/i386/i486ops.c	2025-04-28 22:36:36
@@ -522,13 +522,3 @@
 	}
 	cpustate->cr[cr] = data;
 }
-
-void I486OP(wait)(i386_state *cpustate)
-{
-	if ((cpustate->cr[0] & 0xa) == 0xa)
-	{
-		i386_trap(cpustate, FAULT_NM, 0, 0);
-		return;
-	}
-	x87_mf_fault(cpustate);
-}
diff -ruN source/src/vm/mame/emu/cpu/i386/pentops.c src/vm/mame/emu/cpu/i386/pentops.c
--- source/src/vm/mame/emu/cpu/i386/pentops.c	2025-04-28 16:00:00
+++ src/vm/mame/emu/cpu/i386/pentops.c	2025-04-28 22:36:36
@@ -7,11 +7,6 @@
 
 INLINE void MMXPROLOG(i386_state *cpustate)
 {
-	if (cpustate->cr[0] & 0xc)
-	{
-		i386_trap(cpustate, FAULT_NM, 0, 0);
-		return;
-	}
 	//cpustate->x87_sw &= ~(X87_SW_TOP_MASK << X87_SW_TOP_SHIFT); // top = 0
 	cpustate->x87_tw = 0; // tag word = 0
 }
@@ -1985,11 +1980,6 @@
 
 static void MMXOP(emms)(i386_state* cpustate) // Opcode 0f 77
 {
-	if (cpustate->cr[0] & 0xc)
-	{
-		i386_trap(cpustate, FAULT_NM, 0, 0);
-		return;
-	}
 	cpustate->x87_tw = 0xffff; // tag word = 0xffff
 	// TODO
 	CYCLES(cpustate,1);     // TODO: correct cycle count
diff -ruN source/src/vm/mame/emu/cpu/i386/x87ops.c src/vm/mame/emu/cpu/i386/x87ops.c
--- source/src/vm/mame/emu/cpu/i386/x87ops.c	2025-04-28 16:00:00
+++ src/vm/mame/emu/cpu/i386/x87ops.c	2025-04-28 22:36:36
@@ -280,66 +280,15 @@
 	return ret;
 }
 
-static int x87_ck_over_stack(i386_state *cpustate)
-{
-	int ret = 1;
 
-	// Check for stack overflow
-	if (!X87_IS_ST_EMPTY(7))
-	{
-		ret = 0;
-		x87_set_stack_overflow(cpustate);
-
-		// Don't update the stack if the exception is unmasked
-		if (~cpustate->x87_cw & X87_CW_IM)
-			return ret;
-	}
-
-	return ret;
-}
-
 /*************************************
  *
  * Exception handling
  *
  *************************************/
 
-int x87_mf_fault(i386_state *cpustate)
+int x87_check_exceptions(i386_state *cpustate)
 {
-	if ((cpustate->x87_sw & X87_SW_ES) && (cpustate->cr[0] & 0x20)) // FIXME: 486 and up only
-	{
-		cpustate->ext = 1;
-		i386_trap(cpustate, FAULT_MF, 0, 0);
-		return 1;
-	}
-	return 0;
-}
-
-UINT32 Getx87EA(i386_state *cpustate, UINT8 modrm, int rwn)
-{
-	UINT8 segment;
-	UINT32 ea;
-	modrm_to_EA(cpustate, modrm, &ea, &segment);
-	UINT32 ret = i386_translate(cpustate, segment, ea, rwn, 0);
-	cpustate->x87_ds = cpustate->sreg[segment].selector;
-	if (PROTECTED_MODE && !V8086_MODE)
-		cpustate->x87_data_ptr = ea;
-	else
-		cpustate->x87_data_ptr = ea + (cpustate->x87_ds << 4);
-	cpustate->x87_opcode = ((cpustate->opcode << 8) | modrm) & 0x7ff;
-	return ret;
-}
-
-int x87_check_exceptions(i386_state *cpustate, bool store = false);
-
-int x87_check_exceptions(i386_state *cpustate, bool store)
-{
-	cpustate->x87_cs = cpustate->sreg[CS].selector;
-	if (PROTECTED_MODE && !V8086_MODE)
-		cpustate->x87_inst_ptr = cpustate->prev_eip;
-	else
-		cpustate->x87_inst_ptr = cpustate->prev_eip + (cpustate->x87_cs << 4);
-
 	/* Update the exceptions from SoftFloat */
 	if (float_exception_flags & float_flag_invalid)
 	{
@@ -362,18 +311,18 @@
 		float_exception_flags &= ~float_flag_inexact;
 	}
 
-	if (float_exception_flags & float_flag_divbyzero)
+	if ((cpustate->x87_sw & ~cpustate->x87_cw) & 0x3f)
 	{
-		cpustate->x87_sw |= X87_SW_ZE;
-		float_exception_flags &= ~float_flag_divbyzero;
-	}
+		// cpustate->device->execute().set_input_line(INPUT_LINE_FERR, RAISE_LINE);
+		logerror("Unmasked x87 exception (CW:%.4x, SW:%.4x)\n", cpustate->x87_cw, cpustate->x87_sw);
+		// interrupt handler
+		if (!(cpustate->x87_cw & X87_CW_IEM)) { cpustate->x87_sw |= X87_SW_ES; /*ferr_handler(cpustate, 1);*/ }
 
-	UINT16 unmasked = (cpustate->x87_sw & ~cpustate->x87_cw) & 0x3f;
-	if (unmasked)
-	{
-  		logerror("Unmasked x87 exception (CW:%.4x, SW:%.4x)\n", cpustate->x87_cw, cpustate->x87_sw);
-		cpustate->x87_sw |= X87_SW_ES;
-		if (store || !(unmasked & (X87_SW_OE | X87_SW_UE)))
+		if (cpustate->cr[0] & 0x20) // FIXME: 486 and up only
+		{
+			cpustate->ext = 1;
+			i386_trap(cpustate, FAULT_MF, 0, 0);
+		}
 		return 0;
 	}
 
@@ -547,9 +496,7 @@
 {
 	floatx80 result;
 
-	if (x87_mf_fault(cpustate))
-		return;
-	UINT32 ea = Getx87EA(cpustate, modrm, 0);
+	UINT32 ea = GetEA(cpustate, modrm, 0, 4);
 	if (X87_IS_ST_EMPTY(0))
 	{
 		x87_set_stack_underflow(cpustate);
@@ -584,9 +531,7 @@
 {
 	floatx80 result;
 
-	if (x87_mf_fault(cpustate))
-		return;
-	UINT32 ea = Getx87EA(cpustate, modrm, 0);
+	UINT32 ea = GetEA(cpustate, modrm, 0, 8);
 	if (X87_IS_ST_EMPTY(0))
 	{
 		x87_set_stack_underflow(cpustate);
@@ -622,8 +567,6 @@
 	floatx80 result;
 	int i = modrm & 7;
 
-	if (x87_mf_fault(cpustate))
-		return;
 	if (X87_IS_ST_EMPTY(0) || X87_IS_ST_EMPTY(i))
 	{
 		x87_set_stack_underflow(cpustate);
@@ -648,9 +591,6 @@
 
 	if (x87_check_exceptions(cpustate))
 		x87_write_stack(cpustate, 0, result, TRUE);
-	cpustate->x87_opcode = ((cpustate->opcode << 8) | modrm) & 0x7ff;
-	cpustate->x87_data_ptr = 0;
-	cpustate->x87_ds = 0;
 
 	CYCLES(cpustate, 8);
 }
@@ -660,8 +600,6 @@
 	floatx80 result;
 	int i = modrm & 7;
 
-	if (x87_mf_fault(cpustate))
-		return;
 	if (X87_IS_ST_EMPTY(0) || X87_IS_ST_EMPTY(i))
 	{
 		x87_set_stack_underflow(cpustate);
@@ -686,9 +624,6 @@
 
 	if (x87_check_exceptions(cpustate))
 		x87_write_stack(cpustate, i, result, TRUE);
-	cpustate->x87_opcode = ((cpustate->opcode << 8) | modrm) & 0x7ff;
-	cpustate->x87_data_ptr = 0;
-	cpustate->x87_ds = 0;
 
 	CYCLES(cpustate, 8);
 }
@@ -698,8 +633,6 @@
 	floatx80 result;
 	int i = modrm & 7;
 
-	if (x87_mf_fault(cpustate))
-		return;
 	if (X87_IS_ST_EMPTY(0) || X87_IS_ST_EMPTY(i))
 	{
 		x87_set_stack_underflow(cpustate);
@@ -727,9 +660,6 @@
 		x87_write_stack(cpustate, i, result, TRUE);
 		x87_inc_stack(cpustate);
 	}
-	cpustate->x87_opcode = ((cpustate->opcode << 8) | modrm) & 0x7ff;
-	cpustate->x87_data_ptr = 0;
-	cpustate->x87_ds = 0;
 
 	CYCLES(cpustate, 8);
 }
@@ -738,9 +668,7 @@
 {
 	floatx80 result;
 
-	if (x87_mf_fault(cpustate))
-		return;
-	UINT32 ea = Getx87EA(cpustate, modrm, 0);
+	UINT32 ea = GetEA(cpustate, modrm, 0, 4);
 	if (X87_IS_ST_EMPTY(0))
 	{
 		x87_set_stack_underflow(cpustate);
@@ -775,9 +703,7 @@
 {
 	floatx80 result;
 
-	if (x87_mf_fault(cpustate))
-		return;
-	UINT32 ea = Getx87EA(cpustate, modrm, 0);
+	UINT32 ea = GetEA(cpustate, modrm, 0, 2);
 	if (X87_IS_ST_EMPTY(0))
 	{
 		x87_set_stack_underflow(cpustate);
@@ -819,9 +745,7 @@
 {
 	floatx80 result;
 
-	if (x87_mf_fault(cpustate))
-		return;
-	UINT32 ea = Getx87EA(cpustate, modrm, 0);
+	UINT32 ea = GetEA(cpustate, modrm, 0, 4);
 	if (X87_IS_ST_EMPTY(0))
 	{
 		x87_set_stack_underflow(cpustate);
@@ -856,9 +780,7 @@
 {
 	floatx80 result;
 
-  	if (x87_mf_fault(cpustate))
-		return;
-	UINT32 ea = Getx87EA(cpustate, modrm, 0);
+	UINT32 ea = GetEA(cpustate, modrm, 0, 8);
 	if (X87_IS_ST_EMPTY(0))
 	{
 		x87_set_stack_underflow(cpustate);
@@ -894,8 +816,6 @@
 	floatx80 result;
 	int i = modrm & 7;
 
-	if (x87_mf_fault(cpustate))
-		return;
 	if (X87_IS_ST_EMPTY(0) || X87_IS_ST_EMPTY(i))
 	{
 		x87_set_stack_underflow(cpustate);
@@ -920,9 +840,6 @@
 
 	if (x87_check_exceptions(cpustate))
 		x87_write_stack(cpustate, 0, result, TRUE);
-	cpustate->x87_opcode = ((cpustate->opcode << 8) | modrm) & 0x7ff;
-	cpustate->x87_data_ptr = 0;
-	cpustate->x87_ds = 0;
 
 	CYCLES(cpustate, 8);
 }
@@ -932,8 +849,6 @@
 	floatx80 result;
 	int i = modrm & 7;
 
-	if (x87_mf_fault(cpustate))
-		return;
 	if (X87_IS_ST_EMPTY(0) || X87_IS_ST_EMPTY(i))
 	{
 		x87_set_stack_underflow(cpustate);
@@ -958,9 +873,6 @@
 
 	if (x87_check_exceptions(cpustate))
 		x87_write_stack(cpustate, i, result, TRUE);
-	cpustate->x87_opcode = ((cpustate->opcode << 8) | modrm) & 0x7ff;
-	cpustate->x87_data_ptr = 0;
-	cpustate->x87_ds = 0;
 
 	CYCLES(cpustate, 8);
 }
@@ -970,8 +882,6 @@
 	floatx80 result;
 	int i = modrm & 7;
 
-	if (x87_mf_fault(cpustate))
-		return;
 	if (X87_IS_ST_EMPTY(0) || X87_IS_ST_EMPTY(i))
 	{
 		x87_set_stack_underflow(cpustate);
@@ -999,9 +909,6 @@
 		x87_write_stack(cpustate, i, result, TRUE);
 		x87_inc_stack(cpustate);
 	}
-	cpustate->x87_opcode = ((cpustate->opcode << 8) | modrm) & 0x7ff;
-	cpustate->x87_data_ptr = 0;
-	cpustate->x87_ds = 0;
 
 	CYCLES(cpustate, 8);
 }
@@ -1010,9 +917,7 @@
 {
 	floatx80 result;
 
-	if (x87_mf_fault(cpustate))
-		return;
-	UINT32 ea = Getx87EA(cpustate, modrm, 0);
+	UINT32 ea = GetEA(cpustate, modrm, 0, 4);
 	if (X87_IS_ST_EMPTY(0))
 	{
 		x87_set_stack_underflow(cpustate);
@@ -1047,9 +952,7 @@
 {
 	floatx80 result;
 
-	if (x87_mf_fault(cpustate))
-		return;
-	UINT32 ea = Getx87EA(cpustate, modrm, 0);
+	UINT32 ea = GetEA(cpustate, modrm, 0, 2);
 	if (X87_IS_ST_EMPTY(0))
 	{
 		x87_set_stack_underflow(cpustate);
@@ -1091,9 +994,7 @@
 {
 	floatx80 result;
 
-	if (x87_mf_fault(cpustate))
-		return;
-	UINT32 ea = Getx87EA(cpustate, modrm, 0);
+	UINT32 ea = GetEA(cpustate, modrm, 0, 4);
 	if (X87_IS_ST_EMPTY(0))
 	{
 		x87_set_stack_underflow(cpustate);
@@ -1128,9 +1029,7 @@
 {
 	floatx80 result;
 
-	if (x87_mf_fault(cpustate))
-		return;
-	UINT32 ea = Getx87EA(cpustate, modrm, 0);
+	UINT32 ea = GetEA(cpustate, modrm, 0, 8);
 	if (X87_IS_ST_EMPTY(0))
 	{
 		x87_set_stack_underflow(cpustate);
@@ -1166,8 +1065,6 @@
 	floatx80 result;
 	int i = modrm & 7;
 
-	if (x87_mf_fault(cpustate))
-		return;
 	if (X87_IS_ST_EMPTY(0) || X87_IS_ST_EMPTY(i))
 	{
 		x87_set_stack_underflow(cpustate);
@@ -1192,9 +1089,6 @@
 
 	if (x87_check_exceptions(cpustate))
 		x87_write_stack(cpustate, 0, result, TRUE);
-	cpustate->x87_opcode = ((cpustate->opcode << 8) | modrm) & 0x7ff;
-	cpustate->x87_data_ptr = 0;
-	cpustate->x87_ds = 0;
 
 	CYCLES(cpustate, 8);
 }
@@ -1204,8 +1098,6 @@
 	floatx80 result;
 	int i = modrm & 7;
 
-	if (x87_mf_fault(cpustate))
-		return;
 	if (X87_IS_ST_EMPTY(0) || X87_IS_ST_EMPTY(i))
 	{
 		x87_set_stack_underflow(cpustate);
@@ -1230,9 +1122,6 @@
 
 	if (x87_check_exceptions(cpustate))
 		x87_write_stack(cpustate, i, result, TRUE);
-	cpustate->x87_opcode = ((cpustate->opcode << 8) | modrm) & 0x7ff;
-	cpustate->x87_data_ptr = 0;
-	cpustate->x87_ds = 0;
 
 	CYCLES(cpustate, 8);
 }
@@ -1242,8 +1131,6 @@
 	floatx80 result;
 	int i = modrm & 7;
 
-	if (x87_mf_fault(cpustate))
-		return;
 	if (X87_IS_ST_EMPTY(0) || X87_IS_ST_EMPTY(i))
 	{
 		x87_set_stack_underflow(cpustate);
@@ -1271,9 +1158,6 @@
 		x87_write_stack(cpustate, i, result, TRUE);
 		x87_inc_stack(cpustate);
 	}
-	cpustate->x87_opcode = ((cpustate->opcode << 8) | modrm) & 0x7ff;
-	cpustate->x87_data_ptr = 0;
-	cpustate->x87_ds = 0;
 
 	CYCLES(cpustate, 8);
 }
@@ -1282,9 +1166,7 @@
 {
 	floatx80 result;
 
-	if (x87_mf_fault(cpustate))
-		return;
-	UINT32 ea = Getx87EA(cpustate, modrm, 0);
+	UINT32 ea = GetEA(cpustate, modrm, 0, 4);
 	if (X87_IS_ST_EMPTY(0))
 	{
 		x87_set_stack_underflow(cpustate);
@@ -1319,9 +1201,7 @@
 {
 	floatx80 result;
 
-	if (x87_mf_fault(cpustate))
-		return;
-	UINT32 ea = Getx87EA(cpustate, modrm, 0);
+	UINT32 ea = GetEA(cpustate, modrm, 0, 2);
 	if (X87_IS_ST_EMPTY(0))
 	{
 		x87_set_stack_underflow(cpustate);
@@ -1363,9 +1243,7 @@
 {
 	floatx80 result;
 
-	if (x87_mf_fault(cpustate))
-		return;
-	UINT32 ea = Getx87EA(cpustate, modrm, 0);
+	UINT32 ea = GetEA(cpustate, modrm, 0, 4);
 	if (X87_IS_ST_EMPTY(0))
 	{
 		x87_set_stack_underflow(cpustate);
@@ -1400,9 +1278,7 @@
 {
 	floatx80 result;
 
-	if (x87_mf_fault(cpustate))
-		return;
-	UINT32 ea = Getx87EA(cpustate, modrm, 0);
+	UINT32 ea = GetEA(cpustate, modrm, 0, 8);
 	if (X87_IS_ST_EMPTY(0))
 	{
 		x87_set_stack_underflow(cpustate);
@@ -1438,8 +1314,6 @@
 	int i = modrm & 7;
 	floatx80 result;
 
-	if (x87_mf_fault(cpustate))
-		return;
 	if (X87_IS_ST_EMPTY(0) || X87_IS_ST_EMPTY(i))
 	{
 		x87_set_stack_underflow(cpustate);
@@ -1465,9 +1339,6 @@
 	{
 		x87_write_stack(cpustate, 0, result, TRUE);
 	}
-	cpustate->x87_opcode = ((cpustate->opcode << 8) | modrm) & 0x7ff;
-	cpustate->x87_data_ptr = 0;
-	cpustate->x87_ds = 0;
 
 	// 73, 62, 35
 	CYCLES(cpustate, 73);
@@ -1478,8 +1349,6 @@
 	int i = modrm & 7;
 	floatx80 result;
 
-	if (x87_mf_fault(cpustate))
-		return;
 	if (X87_IS_ST_EMPTY(0) || X87_IS_ST_EMPTY(i))
 	{
 		x87_set_stack_underflow(cpustate);
@@ -1505,9 +1374,6 @@
 	{
 		x87_write_stack(cpustate, i, result, TRUE);
 	}
-	cpustate->x87_opcode = ((cpustate->opcode << 8) | modrm) & 0x7ff;
-	cpustate->x87_data_ptr = 0;
-	cpustate->x87_ds = 0;
 
 	// 73, 62, 35
 	CYCLES(cpustate, 73);
@@ -1518,8 +1384,6 @@
 	int i = modrm & 7;
 	floatx80 result;
 
-	if (x87_mf_fault(cpustate))
-		return;
 	if (X87_IS_ST_EMPTY(0) || X87_IS_ST_EMPTY(i))
 	{
 		x87_set_stack_underflow(cpustate);
@@ -1546,9 +1410,6 @@
 		x87_write_stack(cpustate, i, result, TRUE);
 		x87_inc_stack(cpustate);
 	}
-	cpustate->x87_opcode = ((cpustate->opcode << 8) | modrm) & 0x7ff;
-	cpustate->x87_data_ptr = 0;
-	cpustate->x87_ds = 0;
 
 	// 73, 62, 35
 	CYCLES(cpustate, 73);
@@ -1558,9 +1419,7 @@
 {
 	floatx80 result;
 
-	if (x87_mf_fault(cpustate))
-		return;
-	UINT32 ea = Getx87EA(cpustate, modrm, 0);
+	UINT32 ea = GetEA(cpustate, modrm, 0, 4);
 	if (X87_IS_ST_EMPTY(0))
 	{
 		x87_set_stack_underflow(cpustate);
@@ -1595,9 +1454,7 @@
 {
 	floatx80 result;
 
-	if (x87_mf_fault(cpustate))
-		return;
-	UINT32 ea = Getx87EA(cpustate, modrm, 0);
+	UINT32 ea = GetEA(cpustate, modrm, 0, 2);
 	if (X87_IS_ST_EMPTY(0))
 	{
 		x87_set_stack_underflow(cpustate);
@@ -1639,9 +1496,7 @@
 {
 	floatx80 result;
 
-	if (x87_mf_fault(cpustate))
-		return;
-	UINT32 ea = Getx87EA(cpustate, modrm, 0);
+	UINT32 ea = GetEA(cpustate, modrm, 0, 4);
 	if (X87_IS_ST_EMPTY(0))
 	{
 		x87_set_stack_underflow(cpustate);
@@ -1676,9 +1531,7 @@
 {
 	floatx80 result;
 
-	if (x87_mf_fault(cpustate))
-		return;
-	UINT32 ea = Getx87EA(cpustate, modrm, 0);
+	UINT32 ea = GetEA(cpustate, modrm, 0, 8);
 	if (X87_IS_ST_EMPTY(0))
 	{
 		x87_set_stack_underflow(cpustate);
@@ -1714,8 +1567,6 @@
 	int i = modrm & 7;
 	floatx80 result;
 
-	if (x87_mf_fault(cpustate))
-		return;
 	if (X87_IS_ST_EMPTY(0) || X87_IS_ST_EMPTY(i))
 	{
 		x87_set_stack_underflow(cpustate);
@@ -1741,9 +1592,6 @@
 	{
 		x87_write_stack(cpustate, 0, result, TRUE);
 	}
-	cpustate->x87_opcode = ((cpustate->opcode << 8) | modrm) & 0x7ff;
-	cpustate->x87_data_ptr = 0;
-	cpustate->x87_ds = 0;
 
 	// 73, 62, 35
 	CYCLES(cpustate, 73);
@@ -1754,8 +1602,6 @@
 	int i = modrm & 7;
 	floatx80 result;
 
-	if (x87_mf_fault(cpustate))
-		return;
 	if (X87_IS_ST_EMPTY(0) || X87_IS_ST_EMPTY(i))
 	{
 		x87_set_stack_underflow(cpustate);
@@ -1781,9 +1627,6 @@
 	{
 		x87_write_stack(cpustate, i, result, TRUE);
 	}
-	cpustate->x87_opcode = ((cpustate->opcode << 8) | modrm) & 0x7ff;
-	cpustate->x87_data_ptr = 0;
-	cpustate->x87_ds = 0;
 
 	// 73, 62, 35
 	CYCLES(cpustate, 73);
@@ -1794,8 +1637,6 @@
 	int i = modrm & 7;
 	floatx80 result;
 
-	if (x87_mf_fault(cpustate))
-		return;
 	if (X87_IS_ST_EMPTY(0) || X87_IS_ST_EMPTY(i))
 	{
 		x87_set_stack_underflow(cpustate);
@@ -1822,9 +1663,6 @@
 		x87_write_stack(cpustate, i, result, TRUE);
 		x87_inc_stack(cpustate);
 	}
-	cpustate->x87_opcode = ((cpustate->opcode << 8) | modrm) & 0x7ff;
-	cpustate->x87_data_ptr = 0;
-	cpustate->x87_ds = 0;
 
 	// 73, 62, 35
 	CYCLES(cpustate, 73);
@@ -1835,9 +1673,7 @@
 {
 	floatx80 result;
 
-	if (x87_mf_fault(cpustate))
-		return;
-	UINT32 ea = Getx87EA(cpustate, modrm, 0);
+	UINT32 ea = GetEA(cpustate, modrm, 0, 4);
 	if (X87_IS_ST_EMPTY(0))
 	{
 		x87_set_stack_underflow(cpustate);
@@ -1872,9 +1708,7 @@
 {
 	floatx80 result;
 
-	if (x87_mf_fault(cpustate))
-		return;
-	UINT32 ea = Getx87EA(cpustate, modrm, 0);
+	UINT32 ea = GetEA(cpustate, modrm, 0, 2);
 	if (X87_IS_ST_EMPTY(0))
 	{
 		x87_set_stack_underflow(cpustate);
@@ -1916,9 +1750,7 @@
 {
 	floatx80 result;
 
-	if (x87_mf_fault(cpustate))
-		return;
-	UINT32 ea = Getx87EA(cpustate, modrm, 0);
+	UINT32 ea = GetEA(cpustate, modrm, 0, 4);
 	if (X87_IS_ST_EMPTY(0))
 	{
 		x87_set_stack_underflow(cpustate);
@@ -1952,9 +1784,7 @@
 {
 	floatx80 result;
 
-	if (x87_mf_fault(cpustate))
-		return;
-	UINT32 ea = Getx87EA(cpustate, modrm, 0);
+	UINT32 ea = GetEA(cpustate, modrm, 0, 8);
 	if (X87_IS_ST_EMPTY(0))
 	{
 		x87_set_stack_underflow(cpustate);
@@ -1989,8 +1819,6 @@
 	floatx80 result;
 	int i = modrm & 7;
 
-	if (x87_mf_fault(cpustate))
-		return;
 	if (X87_IS_ST_EMPTY(0) || X87_IS_ST_EMPTY(i))
 	{
 		x87_set_stack_underflow(cpustate);
@@ -2014,9 +1842,6 @@
 
 	if (x87_check_exceptions(cpustate))
 		x87_write_stack(cpustate, 0, result, TRUE);
-	cpustate->x87_opcode = ((cpustate->opcode << 8) | modrm) & 0x7ff;
-	cpustate->x87_data_ptr = 0;
-	cpustate->x87_ds = 0;
 
 	CYCLES(cpustate, 16);
 }
@@ -2026,8 +1851,6 @@
 	floatx80 result;
 	int i = modrm & 7;
 
-	if (x87_mf_fault(cpustate))
-		return;
 	if (X87_IS_ST_EMPTY(0) || X87_IS_ST_EMPTY(i))
 	{
 		x87_set_stack_underflow(cpustate);
@@ -2051,9 +1874,6 @@
 
 	if (x87_check_exceptions(cpustate))
 		x87_write_stack(cpustate, i, result, TRUE);
-	cpustate->x87_opcode = ((cpustate->opcode << 8) | modrm) & 0x7ff;
-	cpustate->x87_data_ptr = 0;
-	cpustate->x87_ds = 0;
 
 	CYCLES(cpustate, 16);
 }
@@ -2063,8 +1883,6 @@
 	floatx80 result;
 	int i = modrm & 7;
 
-	if (x87_mf_fault(cpustate))
-		return;
 	if (X87_IS_ST_EMPTY(0) || X87_IS_ST_EMPTY(i))
 	{
 		x87_set_stack_underflow(cpustate);
@@ -2091,9 +1909,6 @@
 		x87_write_stack(cpustate, i, result, TRUE);
 		x87_inc_stack(cpustate);
 	}
-	cpustate->x87_opcode = ((cpustate->opcode << 8) | modrm) & 0x7ff;
-	cpustate->x87_data_ptr = 0;
-	cpustate->x87_ds = 0;
 
 	CYCLES(cpustate, 16);
 }
@@ -2102,9 +1917,7 @@
 {
 	floatx80 result;
 
-	if (x87_mf_fault(cpustate))
-		return;
-	UINT32 ea = Getx87EA(cpustate, modrm, 0);
+	UINT32 ea = GetEA(cpustate, modrm, 0, 4);
 	if (X87_IS_ST_EMPTY(0))
 	{
 		x87_set_stack_underflow(cpustate);
@@ -2138,9 +1951,7 @@
 {
 	floatx80 result;
 
-	if (x87_mf_fault(cpustate))
-		return;
-	UINT32 ea = Getx87EA(cpustate, modrm, 0);
+	UINT32 ea = GetEA(cpustate, modrm, 0, 2);
 	if (X87_IS_ST_EMPTY(0))
 	{
 		x87_set_stack_underflow(cpustate);
@@ -2182,8 +1993,6 @@
 	floatx80 result;
 	int i = modrm & 7;
 
-	if (x87_mf_fault(cpustate))
-		return;
 	if (cpustate->CF == 1)
 	{
 		if (X87_IS_ST_EMPTY(i))
@@ -2199,9 +2008,6 @@
 			ST(0) = result;
 		}
 	}
-	cpustate->x87_opcode = ((cpustate->opcode << 8) | modrm) & 0x7ff;
-	cpustate->x87_data_ptr = 0;
-	cpustate->x87_ds = 0;
 
 	CYCLES(cpustate, 4);
 }
@@ -2211,8 +2017,6 @@
 	floatx80 result;
 	int i = modrm & 7;
 
-	if (x87_mf_fault(cpustate))
-		return;
 	if (cpustate->ZF == 1)
 	{
 		if (X87_IS_ST_EMPTY(i))
@@ -2228,9 +2032,6 @@
 			ST(0) = result;
 		}
 	}
-	cpustate->x87_opcode = ((cpustate->opcode << 8) | modrm) & 0x7ff;
-	cpustate->x87_data_ptr = 0;
-	cpustate->x87_ds = 0;
 
 	CYCLES(cpustate, 4);
 }
@@ -2240,8 +2041,6 @@
 	floatx80 result;
 	int i = modrm & 7;
 
-	if (x87_mf_fault(cpustate))
-		return;
 	if ((cpustate->CF | cpustate->ZF) == 1)
 	{
 		if (X87_IS_ST_EMPTY(i))
@@ -2257,9 +2056,6 @@
 			ST(0) = result;
 		}
 	}
-	cpustate->x87_opcode = ((cpustate->opcode << 8) | modrm) & 0x7ff;
-	cpustate->x87_data_ptr = 0;
-	cpustate->x87_ds = 0;
 
 	CYCLES(cpustate, 4);
 }
@@ -2269,8 +2065,6 @@
 	floatx80 result;
 	int i = modrm & 7;
 
-	if (x87_mf_fault(cpustate))
-		return;
 	if (cpustate->PF == 1)
 	{
 		if (X87_IS_ST_EMPTY(i))
@@ -2286,9 +2080,6 @@
 			ST(0) = result;
 		}
 	}
-	cpustate->x87_opcode = ((cpustate->opcode << 8) | modrm) & 0x7ff;
-	cpustate->x87_data_ptr = 0;
-	cpustate->x87_ds = 0;
 
 	CYCLES(cpustate, 4);
 }
@@ -2298,8 +2089,6 @@
 	floatx80 result;
 	int i = modrm & 7;
 
-	if (x87_mf_fault(cpustate))
-		return;
 	if (cpustate->CF == 0)
 	{
 		if (X87_IS_ST_EMPTY(i))
@@ -2315,9 +2104,6 @@
 			ST(0) = result;
 		}
 	}
-	cpustate->x87_opcode = ((cpustate->opcode << 8) | modrm) & 0x7ff;
-	cpustate->x87_data_ptr = 0;
-	cpustate->x87_ds = 0;
 
 	CYCLES(cpustate, 4);
 }
@@ -2327,8 +2113,6 @@
 	floatx80 result;
 	int i = modrm & 7;
 
-	if (x87_mf_fault(cpustate))
-		return;
 	if (cpustate->ZF == 0)
 	{
 		if (X87_IS_ST_EMPTY(i))
@@ -2344,9 +2128,6 @@
 			ST(0) = result;
 		}
 	}
-	cpustate->x87_opcode = ((cpustate->opcode << 8) | modrm) & 0x7ff;
-	cpustate->x87_data_ptr = 0;
-	cpustate->x87_ds = 0;
 
 	CYCLES(cpustate, 4);
 }
@@ -2356,8 +2137,6 @@
 	floatx80 result;
 	int i = modrm & 7;
 
-	if (x87_mf_fault(cpustate))
-		return;
 	if ((cpustate->CF == 0) && (cpustate->ZF == 0))
 	{
 		if (X87_IS_ST_EMPTY(i))
@@ -2373,9 +2152,6 @@
 			ST(0) = result;
 		}
 	}
-	cpustate->x87_opcode = ((cpustate->opcode << 8) | modrm) & 0x7ff;
-	cpustate->x87_data_ptr = 0;
-	cpustate->x87_ds = 0;
 
 	CYCLES(cpustate, 4);
 }
@@ -2385,8 +2161,6 @@
 	floatx80 result;
 	int i = modrm & 7;
 
-	if (x87_mf_fault(cpustate))
-		return;
 	if (cpustate->PF == 0)
 	{
 		if (X87_IS_ST_EMPTY(i))
@@ -2402,9 +2176,6 @@
 			ST(0) = result;
 		}
 	}
-	cpustate->x87_opcode = ((cpustate->opcode << 8) | modrm) & 0x7ff;
-	cpustate->x87_data_ptr = 0;
-	cpustate->x87_ds = 0;
 
 	CYCLES(cpustate, 4);
 }
@@ -2419,8 +2190,6 @@
 {
 	floatx80 result;
 
-	if (x87_mf_fault(cpustate))
-		return;
 	if (X87_IS_ST_EMPTY(0) || X87_IS_ST_EMPTY(1))
 	{
 		x87_set_stack_underflow(cpustate);
@@ -2470,9 +2239,6 @@
 
 	if (x87_check_exceptions(cpustate))
 		x87_write_stack(cpustate, 0, result, TRUE);
-	cpustate->x87_opcode = ((cpustate->opcode << 8) | modrm) & 0x7ff;
-	cpustate->x87_data_ptr = 0;
-	cpustate->x87_ds = 0;
 
 	CYCLES(cpustate, 84);
 }
@@ -2481,8 +2247,6 @@
 {
 	floatx80 result;
 
-	if (x87_mf_fault(cpustate))
-		return;
 	if (X87_IS_ST_EMPTY(0) || X87_IS_ST_EMPTY(1))
 	{
 		x87_set_stack_underflow(cpustate);
@@ -2501,9 +2265,6 @@
 
 	if (x87_check_exceptions(cpustate))
 		x87_write_stack(cpustate, 0, result, TRUE);
-	cpustate->x87_opcode = ((cpustate->opcode << 8) | modrm) & 0x7ff;
-	cpustate->x87_data_ptr = 0;
-	cpustate->x87_ds = 0;
 
 	CYCLES(cpustate, 94);
 }
@@ -2512,8 +2273,6 @@
 {
 	floatx80 result;
 
-	if (x87_mf_fault(cpustate))
-		return;
 	if (X87_IS_ST_EMPTY(0))
 	{
 		x87_set_stack_underflow(cpustate);
@@ -2537,9 +2296,6 @@
 
 	if (x87_check_exceptions(cpustate))
 		x87_write_stack(cpustate, 0, result, TRUE);
-	cpustate->x87_opcode = ((cpustate->opcode << 8) | modrm) & 0x7ff;
-	cpustate->x87_data_ptr = 0;
-	cpustate->x87_ds = 0;
 
 	CYCLES(cpustate, 8);
 }
@@ -2554,8 +2310,6 @@
 {
 	floatx80 result;
 
-	if (x87_mf_fault(cpustate))
-		return;
 	if (X87_IS_ST_EMPTY(0))
 	{
 		x87_set_stack_underflow(cpustate);
@@ -2573,9 +2327,6 @@
 	{
 		x87_write_stack(cpustate, 0, result, TRUE);
 	}
-	cpustate->x87_opcode = ((cpustate->opcode << 8) | modrm) & 0x7ff;
-	cpustate->x87_data_ptr = 0;
-	cpustate->x87_ds = 0;
 
 	CYCLES(cpustate, 242);
 }
@@ -2584,8 +2335,6 @@
 {
 	floatx80 result;
 
-	if (x87_mf_fault(cpustate))
-		return;
 	if (X87_IS_ST_EMPTY(0) || X87_IS_ST_EMPTY(1))
 	{
 		x87_set_stack_underflow(cpustate);
@@ -2615,9 +2364,6 @@
 		x87_write_stack(cpustate, 1, result, TRUE);
 		x87_inc_stack(cpustate);
 	}
-	cpustate->x87_opcode = ((cpustate->opcode << 8) | modrm) & 0x7ff;
-	cpustate->x87_data_ptr = 0;
-	cpustate->x87_ds = 0;
 
 	CYCLES(cpustate, 250);
 }
@@ -2626,8 +2372,6 @@
 {
 	floatx80 result;
 
-	if (x87_mf_fault(cpustate))
-		return;
 	if (X87_IS_ST_EMPTY(0) || X87_IS_ST_EMPTY(1))
 	{
 		x87_set_stack_underflow(cpustate);
@@ -2649,9 +2393,6 @@
 		x87_write_stack(cpustate, 1, result, TRUE);
 		x87_inc_stack(cpustate);
 	}
-	cpustate->x87_opcode = ((cpustate->opcode << 8) | modrm) & 0x7ff;
-	cpustate->x87_data_ptr = 0;
-	cpustate->x87_ds = 0;
 
 	CYCLES(cpustate, 313);
 }
@@ -2660,8 +2401,6 @@
 {
 	floatx80 result1, result2;
 
-	if (x87_mf_fault(cpustate))
-		return;
 	if (X87_IS_ST_EMPTY(0))
 	{
 		x87_set_stack_underflow(cpustate);
@@ -2699,9 +2438,6 @@
 		x87_dec_stack(cpustate);
 		x87_write_stack(cpustate, 0, result2, TRUE);
 	}
-	cpustate->x87_opcode = ((cpustate->opcode << 8) | modrm) & 0x7ff;
-	cpustate->x87_data_ptr = 0;
-	cpustate->x87_ds = 0;
 
 	CYCLES(cpustate, 244);
 }
@@ -2710,9 +2446,7 @@
 {
 	floatx80 result;
 
-	if (x87_mf_fault(cpustate))
-		return;
-	if (X87_IS_ST_EMPTY(0) || X87_IS_ST_EMPTY(1))
+	if (X87_IS_ST_EMPTY(0))
 	{
 		x87_set_stack_underflow(cpustate);
 		result = fx80_inan;
@@ -2729,9 +2463,6 @@
 		x87_write_stack(cpustate, 1, result, TRUE);
 		x87_inc_stack(cpustate);
 	}
-	cpustate->x87_opcode = ((cpustate->opcode << 8) | modrm) & 0x7ff;
-	cpustate->x87_data_ptr = 0;
-	cpustate->x87_ds = 0;
 
 	CYCLES(cpustate, 289);
 }
@@ -2740,8 +2471,6 @@
 {
 	floatx80 result;
 
-	if (x87_mf_fault(cpustate))
-		return;
 	if (X87_IS_ST_EMPTY(0))
 	{
 		x87_set_stack_underflow(cpustate);
@@ -2767,9 +2496,6 @@
 
 	if (x87_check_exceptions(cpustate))
 		x87_write_stack(cpustate, 0, result, TRUE);
-	cpustate->x87_opcode = ((cpustate->opcode << 8) | modrm) & 0x7ff;
-	cpustate->x87_data_ptr = 0;
-	cpustate->x87_ds = 0;
 
 	CYCLES(cpustate, 241);
 }
@@ -2778,8 +2504,6 @@
 {
 	floatx80 result;
 
-	if (x87_mf_fault(cpustate))
-		return;
 	if (X87_IS_ST_EMPTY(0))
 	{
 		x87_set_stack_underflow(cpustate);
@@ -2805,9 +2529,6 @@
 
 	if (x87_check_exceptions(cpustate))
 		x87_write_stack(cpustate, 0, result, TRUE);
-	cpustate->x87_opcode = ((cpustate->opcode << 8) | modrm) & 0x7ff;
-	cpustate->x87_data_ptr = 0;
-	cpustate->x87_ds = 0;
 
 	CYCLES(cpustate, 241);
 }
@@ -2816,8 +2537,6 @@
 {
 	floatx80 s_result, c_result;
 
-	if (x87_mf_fault(cpustate))
-		return;
 	if (X87_IS_ST_EMPTY(0))
 	{
 		x87_set_stack_underflow(cpustate);
@@ -2858,9 +2577,6 @@
 		x87_dec_stack(cpustate);
 		x87_write_stack(cpustate, 0, c_result, TRUE);
 	}
-	cpustate->x87_opcode = ((cpustate->opcode << 8) | modrm) & 0x7ff;
-	cpustate->x87_data_ptr = 0;
-	cpustate->x87_ds = 0;
 
 	CYCLES(cpustate, 291);
 }
@@ -2876,10 +2592,8 @@
 {
 	floatx80 value;
 
-	if (x87_mf_fault(cpustate))
-		return;
-	UINT32 ea = Getx87EA(cpustate, modrm, 0);
-	if (x87_ck_over_stack(cpustate))
+	UINT32 ea = GetEA(cpustate, modrm, 0, 4);
+	if (x87_dec_stack(cpustate))
 	{
 		UINT32 m32real = READ32(cpustate, ea);
 
@@ -2899,10 +2613,7 @@
 	}
 
 	if (x87_check_exceptions(cpustate))
-	{
-		x87_set_stack_top(cpustate, ST_TO_PHYS(7));
 		x87_write_stack(cpustate, 0, value, TRUE);
-	}
 
 	CYCLES(cpustate, 3);
 }
@@ -2911,10 +2622,8 @@
 {
 	floatx80 value;
 
-	if (x87_mf_fault(cpustate))
-		return;
-	UINT32 ea = Getx87EA(cpustate, modrm, 0);
-	if (x87_ck_over_stack(cpustate))
+	UINT32 ea = GetEA(cpustate, modrm, 0, 8);
+	if (x87_dec_stack(cpustate))
 	{
 		UINT64 m64real = READ64(cpustate, ea);
 
@@ -2934,10 +2643,7 @@
 	}
 
 	if (x87_check_exceptions(cpustate))
-	{
-		x87_set_stack_top(cpustate, ST_TO_PHYS(7));
 		x87_write_stack(cpustate, 0, value, TRUE);
-	}
 
 	CYCLES(cpustate, 3);
 }
@@ -2946,10 +2652,8 @@
 {
 	floatx80 value;
 
-	if (x87_mf_fault(cpustate))
-		return;
-	UINT32 ea = Getx87EA(cpustate, modrm, 0);
-	if (x87_ck_over_stack(cpustate))
+	UINT32 ea = GetEA(cpustate, modrm, 0, 10);
+	if (x87_dec_stack(cpustate))
 	{
 		cpustate->x87_sw &= ~X87_SW_C1;
 		value = READ80(cpustate, ea);
@@ -2960,10 +2664,7 @@
 	}
 
 	if (x87_check_exceptions(cpustate))
-	{
-		x87_set_stack_top(cpustate, ST_TO_PHYS(7));
 		x87_write_stack(cpustate, 0, value, TRUE);
-	}
 
 	CYCLES(cpustate, 6);
 }
@@ -2972,8 +2673,6 @@
 {
 	floatx80 value;
 
-	if (x87_mf_fault(cpustate))
-		return;
 	if (x87_dec_stack(cpustate))
 	{
 		cpustate->x87_sw &= ~X87_SW_C1;
@@ -2986,9 +2685,6 @@
 
 	if (x87_check_exceptions(cpustate))
 		x87_write_stack(cpustate, 0, value, TRUE);
-	cpustate->x87_opcode = ((cpustate->opcode << 8) | modrm) & 0x7ff;
-	cpustate->x87_data_ptr = 0;
-	cpustate->x87_ds = 0;
 
 	CYCLES(cpustate, 4);
 }
@@ -2997,10 +2693,8 @@
 {
 	floatx80 value;
 
-	if (x87_mf_fault(cpustate))
-		return;
-	UINT32 ea = Getx87EA(cpustate, modrm, 0);
-	if (!x87_ck_over_stack(cpustate))
+	UINT32 ea = GetEA(cpustate, modrm, 0, 2);
+	if (!x87_dec_stack(cpustate))
 	{
 		value = fx80_inan;
 	}
@@ -3013,10 +2707,7 @@
 	}
 
 	if (x87_check_exceptions(cpustate))
-	{
-		x87_set_stack_top(cpustate, ST_TO_PHYS(7));
 		x87_write_stack(cpustate, 0, value, TRUE);
-	}
 
 	CYCLES(cpustate, 13);
 }
@@ -3025,10 +2716,8 @@
 {
 	floatx80 value;
 
-	if (x87_mf_fault(cpustate))
-		return;
-	UINT32 ea = Getx87EA(cpustate, modrm, 0);
-	if (!x87_ck_over_stack(cpustate))
+	UINT32 ea = GetEA(cpustate, modrm, 0, 4);
+	if (!x87_dec_stack(cpustate))
 	{
 		value = fx80_inan;
 	}
@@ -3041,10 +2730,7 @@
 	}
 
 	if (x87_check_exceptions(cpustate))
-	{
-		x87_set_stack_top(cpustate, ST_TO_PHYS(7));
 		x87_write_stack(cpustate, 0, value, TRUE);
-	}
 
 	CYCLES(cpustate, 9);
 }
@@ -3053,10 +2739,8 @@
 {
 	floatx80 value;
 
-	if (x87_mf_fault(cpustate))
-		return;
-	UINT32 ea = Getx87EA(cpustate, modrm, 0);
-	if (!x87_ck_over_stack(cpustate))
+	UINT32 ea = GetEA(cpustate, modrm, 0, 8);
+	if (!x87_dec_stack(cpustate))
 	{
 		value = fx80_inan;
 	}
@@ -3069,10 +2753,7 @@
 	}
 
 	if (x87_check_exceptions(cpustate))
-	{
-		x87_set_stack_top(cpustate, ST_TO_PHYS(7));
 		x87_write_stack(cpustate, 0, value, TRUE);
-	}
 
 	CYCLES(cpustate, 10);
 }
@@ -3082,7 +2763,7 @@
 	floatx80 value;
 
 	UINT32 ea = GetEA(cpustate, modrm, 0, 10);
-	if (!x87_ck_over_stack(cpustate))
+	if (!x87_dec_stack(cpustate))
 	{
 		value = fx80_inan;
 	}
@@ -3110,10 +2791,7 @@
 	}
 
 	if (x87_check_exceptions(cpustate))
-	{
-		x87_set_stack_top(cpustate, ST_TO_PHYS(7));
 		x87_write_stack(cpustate, 0, value, TRUE);
-	}
 
 	CYCLES(cpustate, 75);
 }
@@ -3129,9 +2807,7 @@
 {
 	floatx80 value;
 
-	if (x87_mf_fault(cpustate))
-		return;
-	UINT32 ea = Getx87EA(cpustate, modrm, 1);
+	UINT32 ea = GetEA(cpustate, modrm, 1, 4);
 	if (X87_IS_ST_EMPTY(0))
 	{
 		x87_set_stack_underflow(cpustate);
@@ -3143,9 +2819,11 @@
 		value = ST(0);
 	}
 
-	UINT32 m32real = floatx80_to_float32(value);
-	if (x87_check_exceptions(cpustate, true))
+	if (x87_check_exceptions(cpustate))
+	{
+		UINT32 m32real = floatx80_to_float32(value);
 		WRITE32(cpustate, ea, m32real);
+	}
 
 	CYCLES(cpustate, 7);
 }
@@ -3154,9 +2832,7 @@
 {
 	floatx80 value;
 
-	if (x87_mf_fault(cpustate))
-		return;
-	UINT32 ea = Getx87EA(cpustate, modrm, 1);
+	UINT32 ea = GetEA(cpustate, modrm, 1, 8);
 	if (X87_IS_ST_EMPTY(0))
 	{
 		x87_set_stack_underflow(cpustate);
@@ -3168,9 +2844,11 @@
 		value = ST(0);
 	}
 
-	UINT64 m64real = floatx80_to_float64(value);
-	if (x87_check_exceptions(cpustate, true))
+	if (x87_check_exceptions(cpustate))
+	{
+		UINT64 m64real = floatx80_to_float64(value);
 		WRITE64(cpustate, ea, m64real);
+	}
 
 	CYCLES(cpustate, 8);
 }
@@ -3180,8 +2858,6 @@
 	int i = modrm & 7;
 	floatx80 value;
 
-	if (x87_mf_fault(cpustate))
-		return;
 	if (X87_IS_ST_EMPTY(0))
 	{
 		x87_set_stack_underflow(cpustate);
@@ -3203,9 +2879,7 @@
 {
 	floatx80 value;
 
-	if (x87_mf_fault(cpustate))
-		return;
-	UINT32 ea = Getx87EA(cpustate, modrm, 1);
+	UINT32 ea = GetEA(cpustate, modrm, 1, 4);
 	if (X87_IS_ST_EMPTY(0))
 	{
 		x87_set_stack_underflow(cpustate);
@@ -3217,9 +2891,9 @@
 		value = ST(0);
 	}
 
-	UINT32 m32real = floatx80_to_float32(value);
-	if (x87_check_exceptions(cpustate, true))
+	if (x87_check_exceptions(cpustate))
 	{
+		UINT32 m32real = floatx80_to_float32(value);
 		WRITE32(cpustate, ea, m32real);
 		x87_inc_stack(cpustate);
 	}
@@ -3231,8 +2905,6 @@
 {
 	floatx80 value;
 
-	if (x87_mf_fault(cpustate))
-		return;
 	if (X87_IS_ST_EMPTY(0))
 	{
 		x87_set_stack_underflow(cpustate);
@@ -3245,9 +2917,8 @@
 	}
 
 
-	UINT32 ea = Getx87EA(cpustate, modrm, 1);
-	UINT64 m64real = floatx80_to_float64(value);
-	if (x87_check_exceptions(cpustate, true))
+	UINT32 ea = GetEA(cpustate, modrm, 1, 8);
+	if (x87_check_exceptions(cpustate))
 	{
 		UINT64 m64real = floatx80_to_float64(value);
 		WRITE64(cpustate, ea, m64real);
@@ -3261,8 +2932,6 @@
 {
 	floatx80 value;
 
-	if (x87_mf_fault(cpustate))
-		return;
 	if (X87_IS_ST_EMPTY(0))
 	{
 		x87_set_stack_underflow(cpustate);
@@ -3274,8 +2943,8 @@
 		value = ST(0);
 	}
 
-	UINT32 ea = Getx87EA(cpustate, modrm, 1);
-	if (x87_check_exceptions(cpustate, true))
+	UINT32 ea = GetEA(cpustate, modrm, 1, 10);
+	if (x87_check_exceptions(cpustate))
 	{
 		WRITE80(cpustate, ea, value);
 		x87_inc_stack(cpustate);
@@ -3289,8 +2958,6 @@
 	int i = modrm & 7;
 	floatx80 value;
 
-	if (x87_mf_fault(cpustate))
-		return;
 	if (X87_IS_ST_EMPTY(0))
 	{
 		x87_set_stack_underflow(cpustate);
@@ -3307,9 +2974,6 @@
 		x87_write_stack(cpustate, i, value, TRUE);
 		x87_inc_stack(cpustate);
 	}
-	cpustate->x87_opcode = ((cpustate->opcode << 8) | modrm) & 0x7ff;
-	cpustate->x87_data_ptr = 0;
-	cpustate->x87_ds = 0;
 
 	CYCLES(cpustate, 3);
 }
@@ -3318,8 +2982,6 @@
 {
 	INT16 m16int;
 
-	if (x87_mf_fault(cpustate))
-		return;
 	if (X87_IS_ST_EMPTY(0))
 	{
 		x87_set_stack_underflow(cpustate);
@@ -3337,14 +2999,11 @@
 		if (!floatx80_lt(fx80, lowerLim) && floatx80_le(fx80, upperLim))
 			m16int = floatx80_to_int32(fx80);
 		else
-		{
-			float_exception_flags = float_flag_invalid;
 			m16int = -32768;
-		}
 	}
 
-	UINT32 ea = Getx87EA(cpustate, modrm, 1);
-	if (x87_check_exceptions(cpustate, true))
+	UINT32 ea = GetEA(cpustate, modrm, 1, 2);
+	if (x87_check_exceptions(cpustate))
 	{
 		WRITE16(cpustate, ea, m16int);
 	}
@@ -3356,8 +3015,6 @@
 {
 	INT32 m32int;
 
-	if (x87_mf_fault(cpustate))
-		return;
 	if (X87_IS_ST_EMPTY(0))
 	{
 		x87_set_stack_underflow(cpustate);
@@ -3375,14 +3032,11 @@
 		if (!floatx80_lt(fx80, lowerLim) && floatx80_le(fx80, upperLim))
 			m32int = floatx80_to_int32(fx80);
 		else
-		{
-			float_exception_flags = float_flag_invalid;
 			m32int = 0x80000000;
-		}
 	}
 
-	UINT32 ea = Getx87EA(cpustate, modrm, 1);
-	if (x87_check_exceptions(cpustate, true))
+	UINT32 ea = GetEA(cpustate, modrm, 1, 4);
+	if (x87_check_exceptions(cpustate))
 	{
 		WRITE32(cpustate, ea, m32int);
 	}
@@ -3394,8 +3048,6 @@
 {
 	INT16 m16int;
 
-	if (x87_mf_fault(cpustate))
-		return;
 	if (X87_IS_ST_EMPTY(0))
 	{
 		x87_set_stack_underflow(cpustate);
@@ -3413,14 +3065,11 @@
 		if (!floatx80_lt(fx80, lowerLim) && floatx80_le(fx80, upperLim))
 			m16int = floatx80_to_int32(fx80);
 		else
-		{
-			float_exception_flags = float_flag_invalid;
 			m16int = (UINT16)0x8000;
-		}
 	}
 
-	UINT32 ea = Getx87EA(cpustate, modrm, 1);
-	if (x87_check_exceptions(cpustate, true))
+	UINT32 ea = GetEA(cpustate, modrm, 1, 2);
+	if (x87_check_exceptions(cpustate))
 	{
 		WRITE16(cpustate, ea, m16int);
 		x87_inc_stack(cpustate);
@@ -3433,8 +3082,6 @@
 {
 	INT32 m32int;
 
-	if (x87_mf_fault(cpustate))
-		return;
 	if (X87_IS_ST_EMPTY(0))
 	{
 		x87_set_stack_underflow(cpustate);
@@ -3452,14 +3099,11 @@
 		if (!floatx80_lt(fx80, lowerLim) && floatx80_le(fx80, upperLim))
 			m32int = floatx80_to_int32(fx80);
 		else
-		{
-			float_exception_flags = float_flag_invalid;
 			m32int = 0x80000000;
-		}
 	}
 
-	UINT32 ea = Getx87EA(cpustate, modrm, 1);
-	if (x87_check_exceptions(cpustate, true))
+	UINT32 ea = GetEA(cpustate, modrm, 1, 4);
+	if (x87_check_exceptions(cpustate))
 	{
 		WRITE32(cpustate, ea, m32int);
 		x87_inc_stack(cpustate);
@@ -3472,8 +3116,6 @@
 {
 	INT64 m64int;
 
-	if (x87_mf_fault(cpustate))
-		return;
 	if (X87_IS_ST_EMPTY(0))
 	{
 		x87_set_stack_underflow(cpustate);
@@ -3491,14 +3133,11 @@
 		if (!floatx80_lt(fx80, lowerLim) && floatx80_le(fx80, upperLim))
 			m64int = floatx80_to_int64(fx80);
 		else
-		{
-			float_exception_flags = float_flag_invalid;
 			m64int = U64(0x8000000000000000);
-		}
 	}
 
-	UINT32 ea = Getx87EA(cpustate, modrm, 1);
-	if (x87_check_exceptions(cpustate, true))
+	UINT32 ea = GetEA(cpustate, modrm, 1, 8);
+	if (x87_check_exceptions(cpustate))
 	{
 		WRITE64(cpustate, ea, m64int);
 		x87_inc_stack(cpustate);
@@ -3511,8 +3150,6 @@
 {
 	floatx80 result;
 
-	if (x87_mf_fault(cpustate))
-		return;
 	if (X87_IS_ST_EMPTY(0))
 	{
 		x87_set_stack_underflow(cpustate);
@@ -3534,8 +3171,8 @@
 		result.high |= ST(0).high & 0x8000;
 	}
 
-	UINT32 ea = Getx87EA(cpustate, modrm, 1);
-	if (x87_check_exceptions(cpustate, true))
+	UINT32 ea = GetEA(cpustate, modrm, 1, 10);
+	if (x87_check_exceptions(cpustate))
 	{
 		WRITE80(cpustate, ea, result);
 		x87_inc_stack(cpustate);
@@ -3556,8 +3193,6 @@
 	floatx80 value;
 	int tag;
 
-	if (x87_mf_fault(cpustate))
-		return;
 	if (x87_dec_stack(cpustate))
 	{
 		cpustate->x87_sw &= ~X87_SW_C1;
@@ -3575,9 +3210,6 @@
 		x87_set_tag(cpustate, ST_TO_PHYS(0), tag);
 		x87_write_stack(cpustate, 0, value, FALSE);
 	}
-	cpustate->x87_opcode = ((cpustate->opcode << 8) | modrm) & 0x7ff;
-	cpustate->x87_data_ptr = 0;
-	cpustate->x87_ds = 0;
 
 	CYCLES(cpustate, 4);
 }
@@ -3587,8 +3219,6 @@
 	floatx80 value;
 	int tag;
 
-	if (x87_mf_fault(cpustate))
-		return;
 	if (x87_dec_stack(cpustate))
 	{
 		tag = X87_TW_VALID;
@@ -3612,9 +3242,6 @@
 		x87_set_tag(cpustate, ST_TO_PHYS(0), tag);
 		x87_write_stack(cpustate, 0, value, FALSE);
 	}
-	cpustate->x87_opcode = ((cpustate->opcode << 8) | modrm) & 0x7ff;
-	cpustate->x87_data_ptr = 0;
-	cpustate->x87_ds = 0;
 
 	CYCLES(cpustate, 8);
 }
@@ -3624,8 +3251,6 @@
 	floatx80 value;
 	int tag;
 
-	if (x87_mf_fault(cpustate))
-		return;
 	if (x87_dec_stack(cpustate))
 	{
 		int rc = X87_RC;
@@ -3650,9 +3275,6 @@
 		x87_set_tag(cpustate, ST_TO_PHYS(0), tag);
 		x87_write_stack(cpustate, 0, value, FALSE);
 	}
-	cpustate->x87_opcode = ((cpustate->opcode << 8) | modrm) & 0x7ff;
-	cpustate->x87_data_ptr = 0;
-	cpustate->x87_ds = 0;
 
 	CYCLES(cpustate, 8);
 }
@@ -3662,8 +3284,6 @@
 	floatx80 value;
 	int tag;
 
-	if (x87_mf_fault(cpustate))
-		return;
 	if (x87_dec_stack(cpustate))
 	{
 		int rc = X87_RC;
@@ -3688,9 +3308,6 @@
 		x87_set_tag(cpustate, ST_TO_PHYS(0), tag);
 		x87_write_stack(cpustate, 0, value, FALSE);
 	}
-	cpustate->x87_opcode = ((cpustate->opcode << 8) | modrm) & 0x7ff;
-	cpustate->x87_data_ptr = 0;
-	cpustate->x87_ds = 0;
 
 	CYCLES(cpustate, 8);
 }
@@ -3700,8 +3317,6 @@
 	floatx80 value;
 	int tag;
 
-	if (x87_mf_fault(cpustate))
-		return;
 	if (x87_dec_stack(cpustate))
 	{
 		int rc = X87_RC;
@@ -3726,9 +3341,6 @@
 		x87_set_tag(cpustate, ST_TO_PHYS(0), tag);
 		x87_write_stack(cpustate, 0, value, FALSE);
 	}
-	cpustate->x87_opcode = ((cpustate->opcode << 8) | modrm) & 0x7ff;
-	cpustate->x87_data_ptr = 0;
-	cpustate->x87_ds = 0;
 
 	CYCLES(cpustate, 8);
 }
@@ -3738,8 +3350,6 @@
 	floatx80 value;
 	int tag;
 
-	if (x87_mf_fault(cpustate))
-		return;
 	if (x87_dec_stack(cpustate))
 	{
 		int rc = X87_RC;
@@ -3764,9 +3374,6 @@
 		x87_set_tag(cpustate, ST_TO_PHYS(0), tag);
 		x87_write_stack(cpustate, 0, value, FALSE);
 	}
-	cpustate->x87_opcode = ((cpustate->opcode << 8) | modrm) & 0x7ff;
-	cpustate->x87_data_ptr = 0;
-	cpustate->x87_ds = 0;
 
 	CYCLES(cpustate, 8);
 }
@@ -3776,8 +3383,6 @@
 	floatx80 value;
 	int tag;
 
-	if (x87_mf_fault(cpustate))
-		return;
 	if (x87_dec_stack(cpustate))
 	{
 		value = fx80_zero;
@@ -3795,9 +3400,6 @@
 		x87_set_tag(cpustate, ST_TO_PHYS(0), tag);
 		x87_write_stack(cpustate, 0, value, FALSE);
 	}
-	cpustate->x87_opcode = ((cpustate->opcode << 8) | modrm) & 0x7ff;
-	cpustate->x87_data_ptr = 0;
-	cpustate->x87_ds = 0;
 
 	CYCLES(cpustate, 4);
 }
@@ -3811,7 +3413,6 @@
 
 void x87_fnop(i386_state *cpustate, UINT8 modrm)
 {
-	x87_mf_fault(cpustate);
 	CYCLES(cpustate, 3);
 }
 
@@ -3819,8 +3420,6 @@
 {
 	floatx80 value;
 
-	if (x87_mf_fault(cpustate))
-		return;
 	if (X87_IS_ST_EMPTY(0))
 	{
 		x87_set_stack_underflow(cpustate);
@@ -3836,9 +3435,6 @@
 
 	if (x87_check_exceptions(cpustate))
 		x87_write_stack(cpustate, 0, value, FALSE);
-	cpustate->x87_opcode = ((cpustate->opcode << 8) | modrm) & 0x7ff;
-	cpustate->x87_data_ptr = 0;
-	cpustate->x87_ds = 0;
 
 	CYCLES(cpustate, 6);
 }
@@ -3847,8 +3443,6 @@
 {
 	floatx80 value;
 
-	if (x87_mf_fault(cpustate))
-		return;
 	if (X87_IS_ST_EMPTY(0))
 	{
 		x87_set_stack_underflow(cpustate);
@@ -3864,9 +3458,6 @@
 
 	if (x87_check_exceptions(cpustate))
 		x87_write_stack(cpustate, 0, value, FALSE);
-	cpustate->x87_opcode = ((cpustate->opcode << 8) | modrm) & 0x7ff;
-	cpustate->x87_data_ptr = 0;
-	cpustate->x87_ds = 0;
 
 	CYCLES(cpustate, 6);
 }
@@ -3875,8 +3466,6 @@
 {
 	floatx80 value;
 
-	if (x87_mf_fault(cpustate))
-		return;
 	if (X87_IS_ST_EMPTY(0) || X87_IS_ST_EMPTY(1))
 	{
 		x87_set_stack_underflow(cpustate);
@@ -3885,14 +3474,31 @@
 	else
 	{
 		cpustate->x87_sw &= ~X87_SW_C1;
-		value = floatx80_scale(ST(0), ST(1));
+		value = ST(0);
+
+		// Set the rounding mode to truncate
+		UINT16 old_cw = cpustate->x87_cw;
+		UINT16 new_cw = (old_cw & ~(X87_CW_RC_MASK << X87_CW_RC_SHIFT)) | (X87_CW_RC_ZERO << X87_CW_RC_SHIFT);
+		x87_write_cw(cpustate, new_cw);
+
+		// Interpret ST(1) as an integer
+		UINT32 st1 = floatx80_to_int32(floatx80_round_to_int(ST(1)));
+
+		// Restore the rounding mode
+		x87_write_cw(cpustate, old_cw);
+
+		// Get the unbiased exponent of ST(0)
+		INT16 exp = (ST(0).high & 0x7fff) - 0x3fff;
+
+		// Calculate the new exponent
+		exp = (exp + st1 + 0x3fff) & 0x7fff;
+
+		// Write it back
+		value.high = (value.high & ~0x7fff) + exp;
 	}
 
 	if (x87_check_exceptions(cpustate))
 		x87_write_stack(cpustate, 0, value, FALSE);
-	cpustate->x87_opcode = ((cpustate->opcode << 8) | modrm) & 0x7ff;
-	cpustate->x87_data_ptr = 0;
-	cpustate->x87_ds = 0;
 
 	CYCLES(cpustate, 31);
 }
@@ -3901,8 +3507,6 @@
 {
 	floatx80 value;
 
-	if (x87_mf_fault(cpustate))
-		return;
 	if (X87_IS_ST_EMPTY(0))
 	{
 		x87_set_stack_underflow(cpustate);
@@ -3917,9 +3521,6 @@
 
 	if (x87_check_exceptions(cpustate))
 		x87_write_stack(cpustate, 0, value, TRUE);
-	cpustate->x87_opcode = ((cpustate->opcode << 8) | modrm) & 0x7ff;
-	cpustate->x87_data_ptr = 0;
-	cpustate->x87_ds = 0;
 
 	CYCLES(cpustate, 21);
 }
@@ -3928,8 +3529,6 @@
 {
 	floatx80 sig80, exp80;
 
-	if (x87_mf_fault(cpustate))
-		return;
 	if (X87_IS_ST_EMPTY(0))
 	{
 		x87_set_stack_underflow(cpustate);
@@ -3969,9 +3568,6 @@
 		x87_dec_stack(cpustate);
 		x87_write_stack(cpustate, 0, sig80, TRUE);
 	}
-	cpustate->x87_opcode = ((cpustate->opcode << 8) | modrm) & 0x7ff;
-	cpustate->x87_data_ptr = 0;
-	cpustate->x87_ds = 0;
 
 	CYCLES(cpustate, 21);
 }
@@ -3984,8 +3580,6 @@
 
 void x87_ftst(i386_state *cpustate, UINT8 modrm)
 {
-	if (x87_mf_fault(cpustate))
-		return;
 	if (X87_IS_ST_EMPTY(0))
 	{
 		x87_set_stack_underflow(cpustate);
@@ -4011,9 +3605,6 @@
 	}
 
 	x87_check_exceptions(cpustate);
-	cpustate->x87_opcode = ((cpustate->opcode << 8) | modrm) & 0x7ff;
-	cpustate->x87_data_ptr = 0;
-	cpustate->x87_ds = 0;
 
 	CYCLES(cpustate, 4);
 }
@@ -4022,8 +3613,6 @@
 {
 	floatx80 value = ST(0);
 
-	if (x87_mf_fault(cpustate))
-		return;
 	cpustate->x87_sw &= ~(X87_SW_C3 | X87_SW_C2 | X87_SW_C1 | X87_SW_C0);
 
 	// TODO: Unsupported and denormal values
@@ -4056,9 +3645,7 @@
 
 void x87_ficom_m16int(i386_state *cpustate, UINT8 modrm)
 {
-	if (x87_mf_fault(cpustate))
-		return;
-	UINT32 ea = Getx87EA(cpustate, modrm, 0);
+	UINT32 ea = GetEA(cpustate, modrm, 0, 2);
 	if (X87_IS_ST_EMPTY(0))
 	{
 		x87_set_stack_underflow(cpustate);
@@ -4095,9 +3682,7 @@
 
 void x87_ficom_m32int(i386_state *cpustate, UINT8 modrm)
 {
-	if (x87_mf_fault(cpustate))
-		return;
-	UINT32 ea = Getx87EA(cpustate, modrm, 0);
+	UINT32 ea = GetEA(cpustate, modrm, 0, 4);
 	if (X87_IS_ST_EMPTY(0))
 	{
 		x87_set_stack_underflow(cpustate);
@@ -4134,9 +3719,7 @@
 
 void x87_ficomp_m16int(i386_state *cpustate, UINT8 modrm)
 {
-	if (x87_mf_fault(cpustate))
-		return;
-	UINT32 ea = Getx87EA(cpustate, modrm, 0);
+	UINT32 ea = GetEA(cpustate, modrm, 0, 2);
 	if (X87_IS_ST_EMPTY(0))
 	{
 		x87_set_stack_underflow(cpustate);
@@ -4174,9 +3757,7 @@
 
 void x87_ficomp_m32int(i386_state *cpustate, UINT8 modrm)
 {
-	if (x87_mf_fault(cpustate))
-		return;
-	UINT32 ea = Getx87EA(cpustate, modrm, 0);
+	UINT32 ea = GetEA(cpustate, modrm, 0, 4);
 	if (X87_IS_ST_EMPTY(0))
 	{
 		x87_set_stack_underflow(cpustate);
@@ -4215,9 +3796,7 @@
 
 void x87_fcom_m32real(i386_state *cpustate, UINT8 modrm)
 {
-	if (x87_mf_fault(cpustate))
-		return;
-	UINT32 ea = Getx87EA(cpustate, modrm, 0);
+	UINT32 ea = GetEA(cpustate, modrm, 0, 4);
 	if (X87_IS_ST_EMPTY(0))
 	{
 		x87_set_stack_underflow(cpustate);
@@ -4254,9 +3833,7 @@
 
 void x87_fcom_m64real(i386_state *cpustate, UINT8 modrm)
 {
-	if (x87_mf_fault(cpustate))
-		return;
-	UINT32 ea = Getx87EA(cpustate, modrm, 0);
+	UINT32 ea = GetEA(cpustate, modrm, 0, 8);
 	if (X87_IS_ST_EMPTY(0))
 	{
 		x87_set_stack_underflow(cpustate);
@@ -4295,8 +3872,6 @@
 {
 	int i = modrm & 7;
 
-	if (x87_mf_fault(cpustate))
-		return;
 	if (X87_IS_ST_EMPTY(0) || X87_IS_ST_EMPTY(i))
 	{
 		x87_set_stack_underflow(cpustate);
@@ -4325,18 +3900,13 @@
 	}
 
 	x87_check_exceptions(cpustate);
-	cpustate->x87_opcode = ((cpustate->opcode << 8) | modrm) & 0x7ff;
-	cpustate->x87_data_ptr = 0;
-	cpustate->x87_ds = 0;
 
 	CYCLES(cpustate, 4);
 }
 
 void x87_fcomp_m32real(i386_state *cpustate, UINT8 modrm)
 {
-	if (x87_mf_fault(cpustate))
-		return;
-	UINT32 ea = Getx87EA(cpustate, modrm, 0);
+	UINT32 ea = GetEA(cpustate, modrm, 0, 4);
 	if (X87_IS_ST_EMPTY(0))
 	{
 		x87_set_stack_underflow(cpustate);
@@ -4374,9 +3944,7 @@
 
 void x87_fcomp_m64real(i386_state *cpustate, UINT8 modrm)
 {
-	if (x87_mf_fault(cpustate))
-		return;
-	UINT32 ea = Getx87EA(cpustate, modrm, 0);
+	UINT32 ea = GetEA(cpustate, modrm, 0, 8);
 	if (X87_IS_ST_EMPTY(0))
 	{
 		x87_set_stack_underflow(cpustate);
@@ -4416,8 +3984,6 @@
 {
 	int i = modrm & 7;
 
-	if (x87_mf_fault(cpustate))
-		return;
 	if (X87_IS_ST_EMPTY(0) || X87_IS_ST_EMPTY(i))
 	{
 		x87_set_stack_underflow(cpustate);
@@ -4447,9 +4013,6 @@
 
 	if (x87_check_exceptions(cpustate))
 		x87_inc_stack(cpustate);
-	cpustate->x87_opcode = ((cpustate->opcode << 8) | modrm) & 0x7ff;
-	cpustate->x87_data_ptr = 0;
-	cpustate->x87_ds = 0;
 
 	CYCLES(cpustate, 4);
 }
@@ -4458,8 +4021,6 @@
 {
 	int i = modrm & 7;
 
-	if (x87_mf_fault(cpustate))
-		return;
 	if (X87_IS_ST_EMPTY(0) || X87_IS_ST_EMPTY(i))
 	{
 		x87_set_stack_underflow(cpustate);
@@ -4496,9 +4057,6 @@
 	}
 
 	x87_check_exceptions(cpustate);
-	cpustate->x87_opcode = ((cpustate->opcode << 8) | modrm) & 0x7ff;
-	cpustate->x87_data_ptr = 0;
-	cpustate->x87_ds = 0;
 
 	CYCLES(cpustate, 4); // TODO: correct cycle count
 }
@@ -4507,8 +4065,6 @@
 {
 	int i = modrm & 7;
 
-	if (x87_mf_fault(cpustate))
-		return;
 	if (X87_IS_ST_EMPTY(0) || X87_IS_ST_EMPTY(i))
 	{
 		x87_set_stack_underflow(cpustate);
@@ -4546,9 +4102,6 @@
 
 	if (x87_check_exceptions(cpustate))
 		x87_inc_stack(cpustate);
-	cpustate->x87_opcode = ((cpustate->opcode << 8) | modrm) & 0x7ff;
-	cpustate->x87_data_ptr = 0;
-	cpustate->x87_ds = 0;
 
 	CYCLES(cpustate, 4); // TODO: correct cycle count
 }
@@ -4557,8 +4110,6 @@
 {
 	int i = modrm & 7;
 
-	if (x87_mf_fault(cpustate))
-		return;
 	if (X87_IS_ST_EMPTY(0) || X87_IS_ST_EMPTY(i))
 	{
 		x87_set_stack_underflow(cpustate);
@@ -4601,9 +4152,6 @@
 	}
 
 	x87_check_exceptions(cpustate);
-	cpustate->x87_opcode = ((cpustate->opcode << 8) | modrm) & 0x7ff;
-	cpustate->x87_data_ptr = 0;
-	cpustate->x87_ds = 0;
 
 	CYCLES(cpustate, 4); // TODO: correct cycle count
 }
@@ -4612,8 +4160,6 @@
 {
 	int i = modrm & 7;
 
-	if (x87_mf_fault(cpustate))
-		return;
 	if (X87_IS_ST_EMPTY(0) || X87_IS_ST_EMPTY(i))
 	{
 		x87_set_stack_underflow(cpustate);
@@ -4657,17 +4203,12 @@
 
 	if (x87_check_exceptions(cpustate))
 		x87_inc_stack(cpustate);
-	cpustate->x87_opcode = ((cpustate->opcode << 8) | modrm) & 0x7ff;
-	cpustate->x87_data_ptr = 0;
-	cpustate->x87_ds = 0;
 
 	CYCLES(cpustate, 4); // TODO: correct cycle count
 }
 
 void x87_fcompp(i386_state *cpustate, UINT8 modrm)
 {
-	if (x87_mf_fault(cpustate))
-		return;
 	if (X87_IS_ST_EMPTY(0) || X87_IS_ST_EMPTY(1))
 	{
 		x87_set_stack_underflow(cpustate);
@@ -4700,9 +4241,6 @@
 		x87_inc_stack(cpustate);
 		x87_inc_stack(cpustate);
 	}
-	cpustate->x87_opcode = ((cpustate->opcode << 8) | modrm) & 0x7ff;
-	cpustate->x87_data_ptr = 0;
-	cpustate->x87_ds = 0;
 
 	CYCLES(cpustate, 5);
 }
@@ -4718,8 +4256,6 @@
 {
 	int i = modrm & 7;
 
-	if (x87_mf_fault(cpustate))
-		return;
 	if (X87_IS_ST_EMPTY(0) || X87_IS_ST_EMPTY(i))
 	{
 		x87_set_stack_underflow(cpustate);
@@ -4750,9 +4286,6 @@
 	}
 
 	x87_check_exceptions(cpustate);
-	cpustate->x87_opcode = ((cpustate->opcode << 8) | modrm) & 0x7ff;
-	cpustate->x87_data_ptr = 0;
-	cpustate->x87_ds = 0;
 
 	CYCLES(cpustate, 4);
 }
@@ -4761,8 +4294,6 @@
 {
 	int i = modrm & 7;
 
-	if (x87_mf_fault(cpustate))
-		return;
 	if (X87_IS_ST_EMPTY(0) || X87_IS_ST_EMPTY(i))
 	{
 		x87_set_stack_underflow(cpustate);
@@ -4794,17 +4325,12 @@
 
 	if (x87_check_exceptions(cpustate))
 		x87_inc_stack(cpustate);
-	cpustate->x87_opcode = ((cpustate->opcode << 8) | modrm) & 0x7ff;
-	cpustate->x87_data_ptr = 0;
-	cpustate->x87_ds = 0;
 
 	CYCLES(cpustate, 4);
 }
 
 void x87_fucompp(i386_state *cpustate, UINT8 modrm)
 {
-	if (x87_mf_fault(cpustate))
-		return;
 	if (X87_IS_ST_EMPTY(0) || X87_IS_ST_EMPTY(1))
 	{
 		x87_set_stack_underflow(cpustate);
@@ -4839,9 +4365,6 @@
 		x87_inc_stack(cpustate);
 		x87_inc_stack(cpustate);
 	}
-	cpustate->x87_opcode = ((cpustate->opcode << 8) | modrm) & 0x7ff;
-	cpustate->x87_data_ptr = 0;
-	cpustate->x87_ds = 0;
 
 	CYCLES(cpustate, 4);
 }
@@ -4855,8 +4378,6 @@
 
 void x87_fdecstp(i386_state *cpustate, UINT8 modrm)
 {
-	if (x87_mf_fault(cpustate))
-		return;
 	cpustate->x87_sw &= ~X87_SW_C1;
 
 	x87_set_stack_top(cpustate, ST_TO_PHYS(7));
@@ -4866,8 +4387,6 @@
 
 void x87_fincstp(i386_state *cpustate, UINT8 modrm)
 {
-	if (x87_mf_fault(cpustate))
-		return;
 	cpustate->x87_sw &= ~X87_SW_C1;
 
 	x87_set_stack_top(cpustate, ST_TO_PHYS(1));
@@ -4882,22 +4401,12 @@
 	CYCLES(cpustate, 7);
 }
 
-void x87_ffree(i386_state *cpustate, UINT8 modrm)
-{
-	if (x87_mf_fault(cpustate))
-		return;
-	x87_set_tag(cpustate, ST_TO_PHYS(modrm & 7), X87_TW_EMPTY);
-
-	CYCLES(cpustate, 3);
-}
-
 void x87_feni(i386_state *cpustate, UINT8 modrm)
 {
-	if (x87_mf_fault(cpustate))
-		return;
-	x87_set_tag(cpustate, ST_TO_PHYS(modrm & 7), X87_TW_EMPTY);
+	cpustate->x87_cw &= ~X87_CW_IEM;
+	x87_check_exceptions(cpustate);
 
-	CYCLES(cpustate, 3);
+	CYCLES(cpustate, 5);
 }
 
 void x87_fdisi(i386_state *cpustate, UINT8 modrm)
@@ -4907,6 +4416,13 @@
 	CYCLES(cpustate, 5);
 }
 
+void x87_ffree(i386_state *cpustate, UINT8 modrm)
+{
+	x87_set_tag(cpustate, ST_TO_PHYS(modrm & 7), X87_TW_EMPTY);
+
+	CYCLES(cpustate, 3);
+}
+
 void x87_finit(i386_state *cpustate, UINT8 modrm)
 {
 	x87_reset(cpustate);
@@ -4916,9 +4432,7 @@
 
 void x87_fldcw(i386_state *cpustate, UINT8 modrm)
 {
-	if (x87_mf_fault(cpustate))
-		return;
-	UINT32 ea = Getx87EA(cpustate, modrm, 0);
+	UINT32 ea = GetEA(cpustate, modrm, 0, 2);
 	UINT16 cw = READ16(cpustate, ea);
 
 	x87_write_cw(cpustate, cw);
@@ -4938,63 +4452,23 @@
 
 void x87_fldenv(i386_state *cpustate, UINT8 modrm)
 {
-	if (x87_mf_fault(cpustate))
-		return;
-	UINT32 ea = Getx87EA(cpustate, modrm, 0);
-	UINT32 temp;
-  
-	switch(((PROTECTED_MODE && !V8086_MODE) ? 1 : 0) | (cpustate->operand_size & 1)<<1)
+	// TODO: Pointers and selectors
+	if (cpustate->operand_size)
 	{
-		case 0: // 16-bit real mode
-			x87_write_cw(cpustate, READ16(cpustate, ea));
-			cpustate->x87_sw = READ16(cpustate, ea + 2);
-			cpustate->x87_tw = READ16(cpustate, ea + 4);
-			cpustate->x87_inst_ptr = READ16(cpustate, ea + 6);
-			temp = READ16(cpustate, ea + 8);
-			cpustate->x87_opcode = temp & 0x7ff;
-			cpustate->x87_inst_ptr |= ((temp & 0xf000) << 4);
-			cpustate->x87_data_ptr = READ16(cpustate, ea + 10) | ((READ16(cpustate, ea + 12) & 0xf000) << 4);
-			cpustate->x87_cs = 0;
-			cpustate->x87_ds = 0;
-			ea += 14;
-			break;
-		case 1: // 16-bit protected mode
-			x87_write_cw(cpustate, READ16(cpustate, ea));
-			cpustate->x87_sw = READ16(cpustate, ea + 2);
-			cpustate->x87_tw = READ16(cpustate, ea + 4);
-			cpustate->x87_inst_ptr = READ16(cpustate, ea + 6);
-			cpustate->x87_opcode = 0;
-			cpustate->x87_cs = READ16(cpustate, ea + 8);
-			cpustate->x87_data_ptr = READ16(cpustate, ea + 10);
-			cpustate->x87_ds = READ16(cpustate, ea + 12);
-			ea += 14;
-			break;
-		case 2: // 32-bit real mode
-			x87_write_cw(cpustate, READ16(cpustate, ea));
-			cpustate->x87_sw = READ16(cpustate, ea + 4);
-			cpustate->x87_tw = READ16(cpustate, ea + 8);
-			cpustate->x87_inst_ptr = READ16(cpustate, ea + 12);
-			temp = READ32(cpustate, ea + 16);
-			cpustate->x87_opcode = temp & 0x7ff;
-			cpustate->x87_inst_ptr |= ((temp & 0xffff000) << 4);
-			cpustate->x87_data_ptr = READ16(cpustate, ea + 20) | ((READ32(cpustate, ea + 24) & 0xffff000) << 4);
-			cpustate->x87_cs = 0;
-			cpustate->x87_ds = 0;
-			ea += 28;
-			break;
-		case 3: // 32-bit protected mode
-			x87_write_cw(cpustate, READ16(cpustate, ea));
-			cpustate->x87_sw = READ16(cpustate, ea + 4);
-			cpustate->x87_tw = READ16(cpustate, ea + 8);
-			cpustate->x87_inst_ptr = READ32(cpustate, ea + 12);
-			temp = READ32(cpustate, ea + 16);
-			cpustate->x87_opcode = (temp >> 16) & 0x7ff;
-			cpustate->x87_cs = temp & 0xffff;
-			cpustate->x87_data_ptr = READ32(cpustate, ea + 20);
-			cpustate->x87_ds = READ16(cpustate, ea + 24);
-			ea += 28;
-			break;
+		// 32-bit real/protected mode
+		UINT32 ea = GetEA(cpustate, modrm, 0, 10);
+		x87_write_cw(cpustate, READ16(cpustate, ea));
+		cpustate->x87_sw = READ16(cpustate, ea + 4);
+		cpustate->x87_tw = READ16(cpustate, ea + 8);
 	}
+	else
+	{
+		// 16-bit real/protected mode
+		UINT32 ea = GetEA(cpustate, modrm, 0, 6);
+		x87_write_cw(cpustate, READ16(cpustate, ea));
+		cpustate->x87_sw = READ16(cpustate, ea + 2);
+		cpustate->x87_tw = READ16(cpustate, ea + 4);
+	}
 
 	x87_check_exceptions(cpustate);
 
@@ -5003,45 +4477,51 @@
 
 void x87_fstenv(i386_state *cpustate, UINT8 modrm)
 {
-	UINT32 ea = GetEA(cpustate, modrm, 1, 10);
+	UINT32 ea;
 
-	switch(((PROTECTED_MODE && !V8086_MODE) ? 1 : 0) | (cpustate->operand_size & 1)<<1)
+	// TODO: Pointers and selectors
+	switch((cpustate->cr[0] & 1)|(cpustate->operand_size & 1)<<1)
 	{
 		case 0: // 16-bit real mode
+			ea = GetEA(cpustate, modrm, 1, 6);
 			WRITE16(cpustate, ea + 0, cpustate->x87_cw);
 			WRITE16(cpustate, ea + 2, cpustate->x87_sw);
 			WRITE16(cpustate, ea + 4, cpustate->x87_tw);
-			WRITE16(cpustate, ea + 6, cpustate->x87_inst_ptr & 0xffff);
-			WRITE16(cpustate, ea + 8, (cpustate->x87_opcode & 0x07ff) | ((cpustate->x87_inst_ptr & 0x0f0000) >> 4));
-			WRITE16(cpustate, ea + 10, cpustate->x87_data_ptr & 0xffff);
-			WRITE16(cpustate, ea + 12, (cpustate->x87_data_ptr & 0x0f0000) >> 4);
+//          WRITE16(cpustate, ea + 6, cpustate->fpu_inst_ptr & 0xffff);
+//          WRITE16(cpustate, ea + 8, (cpustate->fpu_opcode & 0x07ff) | ((cpustate->fpu_inst_ptr & 0x0f0000) >> 4));
+//          WRITE16(cpustate, ea + 10, cpustate->fpu_data_ptr & 0xffff);
+//          WRITE16(cpustate, ea + 12, (cpustate->fpu_inst_ptr & 0x0f0000) >> 4);
 			break;
 		case 1: // 16-bit protected mode
+			ea = GetEA(cpustate, modrm, 1, 6);
 			WRITE16(cpustate, ea + 0, cpustate->x87_cw);
-			WRITE16(cpustate, ea + 2, cpustate->x87_sw);
-			WRITE16(cpustate, ea + 4, cpustate->x87_tw);
-			WRITE16(cpustate, ea + 6, cpustate->x87_inst_ptr & 0xffff);
-			WRITE16(cpustate, ea + 8, cpustate->x87_cs);
-			WRITE16(cpustate, ea + 10, cpustate->x87_data_ptr & 0xffff);
-			WRITE16(cpustate, ea + 12, cpustate->x87_ds);
+			WRITE16(cpustate,ea + 2, cpustate->x87_sw);
+			WRITE16(cpustate,ea + 4, cpustate->x87_tw);
+//          WRITE16(cpustate,ea + 6, cpustate->fpu_inst_ptr & 0xffff);
+//          WRITE16(cpustate,ea + 8, (cpustate->fpu_opcode & 0x07ff) | ((cpustate->fpu_inst_ptr & 0x0f0000) >> 4));
+//          WRITE16(cpustate,ea + 10, cpustate->fpu_data_ptr & 0xffff);
+//          WRITE16(cpustate,ea + 12, (cpustate->fpu_inst_ptr & 0x0f0000) >> 4);
 			break;
 		case 2: // 32-bit real mode
-			WRITE32(cpustate, ea + 0, 0xffff0000 | cpustate->x87_cw);
-			WRITE32(cpustate, ea + 4, 0xffff0000 | cpustate->x87_sw);
-			WRITE32(cpustate, ea + 8, 0xffff0000 | cpustate->x87_tw);
-			WRITE32(cpustate, ea + 12, 0xffff0000 | (cpustate->x87_inst_ptr & 0xffff));
-			WRITE32(cpustate, ea + 16, (cpustate->x87_opcode & 0x07ff) | ((cpustate->x87_inst_ptr & 0xffff0000) >> 4));
-			WRITE32(cpustate, ea + 20, 0xffff0000 | (cpustate->x87_data_ptr & 0xffff));
-			WRITE32(cpustate, ea + 24, (cpustate->x87_data_ptr & 0xffff0000) >> 4);
+			ea = GetEA(cpustate, modrm, 1, 10);
+			WRITE16(cpustate, ea + 0, cpustate->x87_cw);
+			WRITE16(cpustate, ea + 4, cpustate->x87_sw);
+			WRITE16(cpustate, ea + 8, cpustate->x87_tw);
+//          WRITE16(cpustate, ea + 12, cpustate->fpu_inst_ptr & 0xffff);
+//          WRITE16(cpustate, ea + 8, (cpustate->fpu_opcode & 0x07ff) | ((cpustate->fpu_inst_ptr & 0x0f0000) >> 4));
+//          WRITE16(cpustate, ea + 20, cpustate->fpu_data_ptr & 0xffff);
+//          WRITE16(cpustate, ea + 12, ((cpustate->fpu_inst_ptr & 0x0f0000) >> 4));
+//          WRITE32(cpustate, ea + 24, (cpustate->fpu_data_ptr >> 16) << 12);
 			break;
 		case 3: // 32-bit protected mode
-			WRITE32(cpustate, ea + 0,  0xffff0000 | cpustate->x87_cw);
-			WRITE32(cpustate, ea + 4,  0xffff0000 | cpustate->x87_sw);
-			WRITE32(cpustate, ea + 8,  0xffff0000 | cpustate->x87_tw);
-			WRITE32(cpustate, ea + 12, cpustate->x87_inst_ptr);
-			WRITE32(cpustate, ea + 16, (cpustate->x87_opcode << 16) | cpustate->x87_cs);
-			WRITE32(cpustate, ea + 20, cpustate->x87_data_ptr);
-			WRITE32(cpustate, ea + 24, 0xffff0000 | cpustate->x87_ds);
+			ea = GetEA(cpustate, modrm, 1, 10);
+			WRITE16(cpustate, ea + 0, cpustate->x87_cw);
+			WRITE16(cpustate, ea + 4,  cpustate->x87_sw);
+			WRITE16(cpustate, ea + 8,  cpustate->x87_tw);
+//          WRITE32(cpustate, ea + 12, cpustate->fpu_inst_ptr);
+//          WRITE32(cpustate, ea + 16, cpustate->fpu_opcode);
+//          WRITE32(cpustate, ea + 20, cpustate->fpu_data_ptr);
+//          WRITE32(cpustate, ea + 24, cpustate->fpu_inst_ptr);
 			break;
 	}
 	cpustate->x87_cw |= 0x3f;   // set all masks
@@ -5053,116 +4533,108 @@
 {
 	UINT32 ea = GetEA(cpustate, modrm, 1, 80);
 
-	switch(((PROTECTED_MODE && !V8086_MODE) ? 1 : 0) | (cpustate->operand_size & 1)<<1)
+	// TODO: Pointers and selectors
+	switch((cpustate->cr[0] & 1)|(cpustate->operand_size & 1)<<1)
 	{
 		case 0: // 16-bit real mode
 			WRITE16(cpustate, ea + 0, cpustate->x87_cw);
 			WRITE16(cpustate, ea + 2, cpustate->x87_sw);
 			WRITE16(cpustate, ea + 4, cpustate->x87_tw);
-			WRITE16(cpustate, ea + 6, cpustate->x87_inst_ptr & 0xffff);
-			WRITE16(cpustate, ea + 8, (cpustate->x87_opcode & 0x07ff) | ((cpustate->x87_inst_ptr & 0x0f0000) >> 4));
-			WRITE16(cpustate, ea + 10, cpustate->x87_data_ptr & 0xffff);
-			WRITE16(cpustate, ea + 12, (cpustate->x87_data_ptr & 0x0f0000) >> 4);
+//          WRITE16(cpustate, ea + 6, cpustate->fpu_inst_ptr & 0xffff);
+//          WRITE16(cpustate, ea + 8, (cpustate->fpu_opcode & 0x07ff) | ((cpustate->fpu_inst_ptr & 0x0f0000) >> 4));
+//          WRITE16(cpustate, ea + 10, cpustate->fpu_data_ptr & 0xffff);
+//          WRITE16(cpustate, ea + 12, (cpustate->fpu_inst_ptr & 0x0f0000) >> 4);
 			ea += 14;
 			break;
 		case 1: // 16-bit protected mode
-			WRITE16(cpustate, ea + 0, cpustate->x87_cw);
-			WRITE16(cpustate, ea + 2, cpustate->x87_sw);
-			WRITE16(cpustate, ea + 4, cpustate->x87_tw);
-			WRITE16(cpustate, ea + 6, cpustate->x87_inst_ptr & 0xffff);
-			WRITE16(cpustate, ea + 8, cpustate->x87_cs);
-			WRITE16(cpustate, ea + 10, cpustate->x87_data_ptr & 0xffff);
-			WRITE16(cpustate, ea + 12, cpustate->x87_ds);
+			WRITE16(cpustate,ea + 0, cpustate->x87_cw);
+			WRITE16(cpustate,ea + 2, cpustate->x87_sw);
+			WRITE16(cpustate,ea + 4, cpustate->x87_tw);
+//          WRITE16(cpustate,ea + 6, cpustate->fpu_inst_ptr & 0xffff);
+//          WRITE16(cpustate,ea + 8, (cpustate->fpu_opcode & 0x07ff) | ((cpustate->fpu_inst_ptr & 0x0f0000) >> 4));
+//          WRITE16(cpustate,ea + 10, cpustate->fpu_data_ptr & 0xffff);
+//          WRITE16(cpustate,ea + 12, (cpustate->fpu_inst_ptr & 0x0f0000) >> 4);
 			ea += 14;
 			break;
 		case 2: // 32-bit real mode
-			WRITE32(cpustate, ea + 0, 0xffff0000 | cpustate->x87_cw);
-			WRITE32(cpustate, ea + 4, 0xffff0000 | cpustate->x87_sw);
-			WRITE32(cpustate, ea + 8, 0xffff0000 | cpustate->x87_tw);
-			WRITE32(cpustate, ea + 12, 0xffff0000 | (cpustate->x87_inst_ptr & 0xffff));
-			WRITE32(cpustate, ea + 16, (cpustate->x87_opcode & 0x07ff) | ((cpustate->x87_inst_ptr & 0xffff0000) >> 4));
-			WRITE32(cpustate, ea + 20, 0xffff0000 | (cpustate->x87_data_ptr & 0xffff));
-			WRITE32(cpustate, ea + 24, (cpustate->x87_data_ptr & 0xffff0000) >> 4);
+			WRITE16(cpustate, ea + 0, cpustate->x87_cw);
+			WRITE16(cpustate, ea + 4, cpustate->x87_sw);
+			WRITE16(cpustate, ea + 8, cpustate->x87_tw);
+//          WRITE16(cpustate, ea + 12, cpustate->fpu_inst_ptr & 0xffff);
+//          WRITE16(cpustate, ea + 8, (cpustate->fpu_opcode & 0x07ff) | ((cpustate->fpu_inst_ptr & 0x0f0000) >> 4));
+//          WRITE16(cpustate, ea + 20, cpustate->fpu_data_ptr & 0xffff);
+//          WRITE16(cpustate, ea + 12, ((cpustate->fpu_inst_ptr & 0x0f0000) >> 4));
+//          WRITE32(cpustate, ea + 24, (cpustate->fpu_data_ptr >> 16) << 12);
 			ea += 28;
 			break;
 		case 3: // 32-bit protected mode
-			WRITE32(cpustate, ea + 0,  0xffff0000 | cpustate->x87_cw);
-			WRITE32(cpustate, ea + 4,  0xffff0000 | cpustate->x87_sw);
-			WRITE32(cpustate, ea + 8,  0xffff0000 | cpustate->x87_tw);
-			WRITE32(cpustate, ea + 12, cpustate->x87_inst_ptr);
-			WRITE32(cpustate, ea + 16, (cpustate->x87_opcode << 16) | cpustate->x87_cs);
-			WRITE32(cpustate, ea + 20, cpustate->x87_data_ptr);
-			WRITE32(cpustate, ea + 24, 0xffff0000 | cpustate->x87_ds);
+			WRITE16(cpustate, ea + 0,  cpustate->x87_cw);
+			WRITE16(cpustate, ea + 4,  cpustate->x87_sw);
+			WRITE16(cpustate, ea + 8,  cpustate->x87_tw);
+//          WRITE32(cpustate, ea + 12, cpustate->fpu_inst_ptr);
+//          WRITE32(cpustate, ea + 16, cpustate->fpu_opcode);
+//          WRITE32(cpustate, ea + 20, cpustate->fpu_data_ptr);
+//          WRITE32(cpustate, ea + 24, cpustate->fpu_inst_ptr);
 			ea += 28;
 			break;
 	}
 
 	for (int i = 0; i < 8; ++i)
 		WRITE80(cpustate, ea + i*10, ST(i));
-	x87_reset(cpustate);
 
 	CYCLES(cpustate,(cpustate->cr[0] & 1) ? 56 : 67);
 }
 
 void x87_frstor(i386_state *cpustate, UINT8 modrm)
 {
-	if (x87_mf_fault(cpustate))
-		return;
 	UINT32 ea = GetEA(cpustate, modrm, 0, 80);
-	UINT32 temp;
 
-	switch(((PROTECTED_MODE && !V8086_MODE) ? 1 : 0) | (cpustate->operand_size & 1)<<1)
+	// TODO: Pointers and selectors
+	switch((cpustate->cr[0] & 1)|(cpustate->operand_size & 1)<<1)
 	{
 		case 0: // 16-bit real mode
 			x87_write_cw(cpustate, READ16(cpustate, ea));
 			cpustate->x87_sw = READ16(cpustate, ea + 2);
 			cpustate->x87_tw = READ16(cpustate, ea + 4);
-			cpustate->x87_inst_ptr = READ16(cpustate, ea + 6);
-			temp = READ16(cpustate, ea + 8);
-			cpustate->x87_opcode = temp & 0x7ff;
-			cpustate->x87_inst_ptr |= ((temp & 0xf000) << 4);
-			cpustate->x87_data_ptr = READ16(cpustate, ea + 10) | ((READ16(cpustate, ea + 12) & 0xf000) << 4);
-			cpustate->x87_cs = 0;
-			cpustate->x87_ds = 0;
+//          WRITE16(cpustate, ea + 6, cpustate->fpu_inst_ptr & 0xffff);
+//          WRITE16(cpustate, ea + 8, (cpustate->fpu_opcode & 0x07ff) | ((cpustate->fpu_inst_ptr & 0x0f0000) >> 4));
+//          WRITE16(cpustate, ea + 10, cpustate->fpu_data_ptr & 0xffff);
+//          WRITE16(cpustate, ea + 12, (cpustate->fpu_inst_ptr & 0x0f0000) >> 4);
 			ea += 14;
 			break;
 		case 1: // 16-bit protected mode
 			x87_write_cw(cpustate, READ16(cpustate, ea));
 			cpustate->x87_sw = READ16(cpustate, ea + 2);
 			cpustate->x87_tw = READ16(cpustate, ea + 4);
-			cpustate->x87_inst_ptr = READ16(cpustate, ea + 6);
-			cpustate->x87_opcode = 0;
-			cpustate->x87_cs = READ16(cpustate, ea + 8);
-			cpustate->x87_data_ptr = READ16(cpustate, ea + 10);
-			cpustate->x87_ds = READ16(cpustate, ea + 12);
+//          WRITE16(cpustate,ea + 6, cpustate->fpu_inst_ptr & 0xffff);
+//          WRITE16(cpustate,ea + 8, (cpustate->fpu_opcode & 0x07ff) | ((cpustate->fpu_inst_ptr & 0x0f0000) >> 4));
+//          WRITE16(cpustate,ea + 10, cpustate->fpu_data_ptr & 0xffff);
+//          WRITE16(cpustate,ea + 12, (cpustate->fpu_inst_ptr & 0x0f0000) >> 4);
 			ea += 14;
 			break;
 		case 2: // 32-bit real mode
 			x87_write_cw(cpustate, READ16(cpustate, ea));
 			cpustate->x87_sw = READ16(cpustate, ea + 4);
 			cpustate->x87_tw = READ16(cpustate, ea + 8);
-			cpustate->x87_inst_ptr = READ16(cpustate, ea + 12);
-			temp = READ32(cpustate, ea + 16);
-			cpustate->x87_opcode = temp & 0x7ff;
-			cpustate->x87_inst_ptr |= ((temp & 0xffff000) << 4);
-			cpustate->x87_data_ptr = READ16(cpustate, ea + 20) | ((READ32(cpustate, ea + 24) & 0xffff000) << 4);
-			cpustate->x87_cs = 0;
-			cpustate->x87_ds = 0;
+//          WRITE16(cpustate, ea + 12, cpustate->fpu_inst_ptr & 0xffff);
+//          WRITE16(cpustate, ea + 8, (cpustate->fpu_opcode & 0x07ff) | ((cpustate->fpu_inst_ptr & 0x0f0000) >> 4));
+//          WRITE16(cpustate, ea + 20, cpustate->fpu_data_ptr & 0xffff);
+//          WRITE16(cpustate, ea + 12, ((cpustate->fpu_inst_ptr & 0x0f0000) >> 4));
+//          WRITE32(cpustate, ea + 24, (cpustate->fpu_data_ptr >> 16) << 12);
 			ea += 28;
 			break;
 		case 3: // 32-bit protected mode
 			x87_write_cw(cpustate, READ16(cpustate, ea));
 			cpustate->x87_sw = READ16(cpustate, ea + 4);
 			cpustate->x87_tw = READ16(cpustate, ea + 8);
-			cpustate->x87_inst_ptr = READ32(cpustate, ea + 12);
-			temp = READ32(cpustate, ea + 16);
-			cpustate->x87_opcode = (temp >> 16) & 0x7ff;
-			cpustate->x87_cs = temp & 0xffff;
-			cpustate->x87_data_ptr = READ32(cpustate, ea + 20);
-			cpustate->x87_ds = READ16(cpustate, ea + 24);
+//          WRITE32(cpustate, ea + 12, cpustate->fpu_inst_ptr);
+//          WRITE32(cpustate, ea + 16, cpustate->fpu_opcode);
+//          WRITE32(cpustate, ea + 20, cpustate->fpu_data_ptr);
+//          WRITE32(cpustate, ea + 24, cpustate->fpu_inst_ptr);
 			ea += 28;
 			break;
 	}
+
 	for (int i = 0; i < 8; ++i)
 		x87_write_stack(cpustate, i, READ80(cpustate, ea + i*10), FALSE);
 
@@ -5171,8 +4643,6 @@
 
 void x87_fxch(i386_state *cpustate, UINT8 modrm)
 {
-	if (x87_mf_fault(cpustate))
-		return;
 	if (X87_IS_ST_EMPTY(0) || X87_IS_ST_EMPTY(1))
 		x87_set_stack_underflow(cpustate);
 
@@ -5195,8 +4665,6 @@
 {
 	int i = modrm & 7;
 
-	if (x87_mf_fault(cpustate))
-		return;
 	if (X87_IS_ST_EMPTY(0))
 	{
 		ST(0) = fx80_inan;
@@ -5258,88 +4726,48 @@
 
 static void I386OP(x87_group_d8)(i386_state *cpustate)
 {
-	if (cpustate->cr[0] & 0xc)
-	{
-		i386_trap(cpustate, FAULT_NM, 0, 0);
-		return;
-	}
 	UINT8 modrm = FETCH(cpustate);
 	cpustate->opcode_table_x87_d8[modrm](cpustate, modrm);
 }
 
 static void I386OP(x87_group_d9)(i386_state *cpustate)
 {
-	if (cpustate->cr[0] & 0xc)
-	{
-		i386_trap(cpustate, FAULT_NM, 0, 0);
-		return;
-	}
 	UINT8 modrm = FETCH(cpustate);
 	cpustate->opcode_table_x87_d9[modrm](cpustate, modrm);
 }
 
 static void I386OP(x87_group_da)(i386_state *cpustate)
 {
-	if (cpustate->cr[0] & 0xc)
-	{
-		i386_trap(cpustate, FAULT_NM, 0, 0);
-		return;
-	}
 	UINT8 modrm = FETCH(cpustate);
 	cpustate->opcode_table_x87_da[modrm](cpustate, modrm);
 }
 
 static void I386OP(x87_group_db)(i386_state *cpustate)
 {
-	if (cpustate->cr[0] & 0xc)
-	{
-		i386_trap(cpustate, FAULT_NM, 0, 0);
-		return;
-	}
 	UINT8 modrm = FETCH(cpustate);
 	cpustate->opcode_table_x87_db[modrm](cpustate, modrm);
 }
 
 static void I386OP(x87_group_dc)(i386_state *cpustate)
 {
-	if (cpustate->cr[0] & 0xc)
-	{
-		i386_trap(cpustate, FAULT_NM, 0, 0);
-		return;
-	}
 	UINT8 modrm = FETCH(cpustate);
 	cpustate->opcode_table_x87_dc[modrm](cpustate, modrm);
 }
 
 static void I386OP(x87_group_dd)(i386_state *cpustate)
 {
-	if (cpustate->cr[0] & 0xc)
-	{
-		i386_trap(cpustate, FAULT_NM, 0, 0);
-		return;
-	}
 	UINT8 modrm = FETCH(cpustate);
 	cpustate->opcode_table_x87_dd[modrm](cpustate, modrm);
 }
 
 static void I386OP(x87_group_de)(i386_state *cpustate)
 {
-	if (cpustate->cr[0] & 0xc)
-	{
-		i386_trap(cpustate, FAULT_NM, 0, 0);
-		return;
-	}
 	UINT8 modrm = FETCH(cpustate);
 	cpustate->opcode_table_x87_de[modrm](cpustate, modrm);
 }
 
 static void I386OP(x87_group_df)(i386_state *cpustate)
 {
-	if (cpustate->cr[0] & 0xc)
-	{
-		i386_trap(cpustate, FAULT_NM, 0, 0);
-		return;
-	}
 	UINT8 modrm = FETCH(cpustate);
 	cpustate->opcode_table_x87_df[modrm](cpustate, modrm);
 }
@@ -5437,14 +4865,6 @@
 				case 0xcf: ptr = x87_fxch_sti;  break;
 
 				case 0xd0: ptr = x87_fnop;      break;
-				case 0xd8:
-				case 0xd9:
-				case 0xda:
-				case 0xdb:
-				case 0xdc:
-				case 0xdd:
-				case 0xde:
-				case 0xdf: ptr = x87_fstp_sti;  break;
 				case 0xe0: ptr = x87_fchs;      break;
 				case 0xe1: ptr = x87_fabs;      break;
 				case 0xe4: ptr = x87_ftst;      break;
diff -ruN source/src/vm/mame/emu/cpu/i86/i286.c src/vm/mame/emu/cpu/i86/i286.c
--- source/src/vm/mame/emu/cpu/i86/i286.c	2025-04-28 16:00:00
+++ src/vm/mame/emu/cpu/i86/i286.c	2025-04-28 22:36:36
@@ -369,7 +369,7 @@
 			} else {
 				now_debugging = false;
 			}
-			cpustate->debugger->add_cpu_trace(cpustate->pc, cpustate->pc - cpustate->base[CS], false);
+			cpustate->debugger->add_cpu_trace(cpustate->pc);
 			int first_icount = cpustate->icount;
 			cpustate->seg_prefix=FALSE;
 			try
@@ -398,7 +398,7 @@
 				cpustate->io = cpustate->io_stored;
 			}
 		} else {
-			cpustate->debugger->add_cpu_trace(cpustate->pc, cpustate->pc - cpustate->base[CS], false);
+			cpustate->debugger->add_cpu_trace(cpustate->pc);
 			int first_icount = cpustate->icount;
 #endif
 			cpustate->seg_prefix=FALSE;
diff -ruN source/src/vm/mame/emu/cpu/i86/i86.c src/vm/mame/emu/cpu/i86/i86.c
--- source/src/vm/mame/emu/cpu/i86/i86.c	2025-04-28 16:00:00
+++ src/vm/mame/emu/cpu/i86/i86.c	2025-04-28 22:36:36
@@ -387,7 +387,7 @@
 			} else {
 				now_debugging = false;
 			}
-			cpustate->debugger->add_cpu_trace(cpustate->pc, cpustate->pc - cpustate->base[CS], false);
+			cpustate->debugger->add_cpu_trace(cpustate->pc);
 			int first_icount = cpustate->icount;
 			cpustate->seg_prefix = FALSE;
 			cpustate->prevpc = cpustate->pc;
@@ -407,7 +407,7 @@
 				cpustate->io = cpustate->io_stored;
 			}
 		} else {
-			cpustate->debugger->add_cpu_trace(cpustate->pc, cpustate->pc - cpustate->base[CS], false);
+			cpustate->debugger->add_cpu_trace(cpustate->pc);
 			int first_icount = cpustate->icount;
 #endif
 			cpustate->seg_prefix = FALSE;
@@ -537,7 +537,7 @@
 			} else {
 				now_debugging = false;
 			}
-			cpustate->debugger->add_cpu_trace(cpustate->pc, cpustate->pc - cpustate->base[CS], false);
+			cpustate->debugger->add_cpu_trace(cpustate->pc);
 			int first_icount = cpustate->icount;
 			cpustate->seg_prefix = FALSE;
 			cpustate->prevpc = cpustate->pc;
@@ -557,7 +557,7 @@
 				cpustate->io = cpustate->io_stored;
 			}
 		} else {
-			cpustate->debugger->add_cpu_trace(cpustate->pc, cpustate->pc - cpustate->base[CS], false);
+			cpustate->debugger->add_cpu_trace(cpustate->pc);
 			int first_icount = cpustate->icount;
 #endif
 			cpustate->seg_prefix = FALSE;
@@ -683,7 +683,7 @@
 			} else {
 				now_debugging = false;
 			}
-			cpustate->debugger->add_cpu_trace(cpustate->pc, cpustate->pc - cpustate->base[CS], (cpustate->MF == 0));
+			cpustate->debugger->add_cpu_trace(cpustate->pc);
 			int first_icount = cpustate->icount;
 			cpustate->seg_prefix = FALSE;
 			cpustate->prevpc = cpustate->pc;
@@ -714,7 +714,7 @@
 				cpustate->io = cpustate->io_stored;
 			}
 		} else {
-			cpustate->debugger->add_cpu_trace(cpustate->pc, cpustate->pc - cpustate->base[CS], (cpustate->MF == 0));
+			cpustate->debugger->add_cpu_trace(cpustate->pc);
 			int first_icount = cpustate->icount;
 #endif
 			cpustate->seg_prefix = FALSE;
diff -ruN source/src/vm/mame/lib/softfloat/mamesf.h src/vm/mame/lib/softfloat/mamesf.h
--- source/src/vm/mame/lib/softfloat/mamesf.h	2025-04-28 16:00:00
+++ src/vm/mame/lib/softfloat/mamesf.h	2025-04-28 22:36:36
@@ -58,7 +58,7 @@
 | name for the 64-bit integer type.  Some compilers may allow `LIT64' to be
 | defined as the identity macro:  `#define LIT64( a ) a'.
 *----------------------------------------------------------------------------*/
-#define LIT64( a ) (unsigned __int64)(a)
+#define LIT64( a ) a##ULL
 
 /*----------------------------------------------------------------------------
 | The macro `INLINE' can be used before functions that should be inlined.  If
Binary files source/src/vm/mb8877.o and src/vm/mb8877.o differ
Binary files source/src/vm/mb8877_wd.o and src/vm/mb8877_wd.o differ
diff -ruN source/src/vm/mz1p17.cpp src/vm/mz1p17.cpp
--- source/src/vm/mz1p17.cpp	2018-10-14 22:30:00
+++ src/vm/mz1p17.cpp	2025-04-28 22:36:36
@@ -3566,20 +3566,20 @@
 	}
 	if(IS_KANA(code) && hiragana_mode) {
 		static const uint16_t hiragana_sjis[] = {
-			0x82f0,					// Ç
-			0x829f, 0x82a1, 0x82a3, 0x82a5, 0x82a7,	// ÇüÇ°Ç£Ç•Çß
-			0x82e1, 0x82e3, 0x82e5, 0x82c1,		// Ç·Ç„ÇÂÇ¡
+			0x82f0,					// ÔøΩÔøΩ
+			0x829f, 0x82a1, 0x82a3, 0x82a5, 0x82a7,	// ÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩ
+			0x82e1, 0x82e3, 0x82e5, 0x82c1,		// ÔøΩÔøΩÔøΩÔøΩÔøΩ
 			0,					// 
-			0x82a0, 0x82a2, 0x82a4, 0x82a6, 0x82a8,	// Ç†Ç¢Ç§Ç¶Ç®
-			0x82a9, 0x82ab, 0x82ad, 0x82af, 0x82b1,	// Ç©Ç´Ç≠ÇØÇ±
-			0x82b3, 0x82b5, 0x82b7, 0x82b9, 0x82bb,	// Ç≥ÇµÇ∑ÇπÇª
-			0x82bd, 0x82bf, 0x82c2, 0x82c4, 0x82c6,	// ÇΩÇøÇ¬ÇƒÇ∆
-			0x82c8, 0x82c9, 0x82ca, 0x82cb, 0x82cc,	// Ç»Ç…Ç ÇÀÇÃ
-			0x82cd, 0x82d0, 0x82d3, 0x82d6, 0x82d9,	// ÇÕÇ–Ç”Ç÷ÇŸ
-			0x82dc, 0x82dd, 0x82de, 0x82df, 0x82e0,	// Ç‹Ç›ÇﬁÇﬂÇ‡
-			0x82e2, 0x82e4, 0x82e6,			// Ç‚Ç‰ÇÊ
-			0x82e7, 0x82e8, 0x82e9, 0x82ea, 0x82eb,	// ÇÁÇËÇÈÇÍÇÎ
-			0x82ed, 0x82f1,				// ÇÌÇÒ
+			0x82a0, 0x82a2, 0x82a4, 0x82a6, 0x82a8,	// ÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩ
+			0x82a9, 0x82ab, 0x82ad, 0x82af, 0x82b1,	// ÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩ
+			0x82b3, 0x82b5, 0x82b7, 0x82b9, 0x82bb,	// ÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩ
+			0x82bd, 0x82bf, 0x82c2, 0x82c4, 0x82c6,	// ÔøΩÔøΩÔøΩÔøΩÔøΩ¬ÇƒÇÔøΩ
+			0x82c8, 0x82c9, 0x82ca, 0x82cb, 0x82cc,	// ÔøΩ»Ç…Ç ÇÀÇÔøΩ
+			0x82cd, 0x82d0, 0x82d3, 0x82d6, 0x82d9,	// ÔøΩÕÇ–Ç”Ç÷ÇÔøΩ
+			0x82dc, 0x82dd, 0x82de, 0x82df, 0x82e0,	// ÔøΩ‹Ç›ÇﬁÇﬂÇÔøΩ
+			0x82e2, 0x82e4, 0x82e6,			// ÔøΩÔøΩÔøΩÔøΩ
+			0x82e7, 0x82e8, 0x82e9, 0x82ea, 0x82eb,	// ÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩ
+			0x82ed, 0x82f1,				// ÔøΩÔøΩÔøΩ
 		};
 		uint16_t sjis = hiragana_sjis[(code & 0xff) - 0xa6];
 		tmp[0] = sjis >> 8;
@@ -3673,10 +3673,10 @@
 void MZ1P17::draw_dot(bitmap_t *bitmap, int x, int y, int width, int height, uint8_t r, uint8_t g, uint8_t b)
 {
 	if(!DOT_PRINT || width < 3 || height < 3) {
-		// dot pattern : square (Å°å^)
+		// dot pattern : square (ÔøΩÔøΩÔøΩ^)
 		emu->draw_rectangle_to_bitmap(&bitmap_line[color_mode], x, y, width, height, r, g, b);
 	} else {
-		// dot pattern : convex (ì å^)
+		// dot pattern : convex (ÔøΩ å^)
 		int loop = (int)(width / 3) + (width % 3 > 0 ? 1 : 0);
 		for(int i = 0; i < loop; i++) {
 			int sx = x + 3 * i;
diff -ruN source/src/vm/np21/i386c/ia32/cpu.cpp src/vm/np21/i386c/ia32/cpu.cpp
--- source/src/vm/np21/i386c/ia32/cpu.cpp	2025-04-28 16:00:00
+++ src/vm/np21/i386c/ia32/cpu.cpp	2025-04-28 22:36:36
@@ -133,9 +133,7 @@
 	for (prefix = 0; prefix < MAX_PREFIX; prefix++) {
 		GET_PCBYTE(op);
 #ifdef USE_DEBUGGER
-		if (prefix == 0) {
-			device_debugger->add_cpu_trace(codefetch_address, CPU_PREV_EIP, (CPU_INST_OP32 != 0));
-		}
+		if (prefix == 0) device_debugger->add_cpu_trace(codefetch_address);
 #endif
 #if defined(IA32_INSTRUCTION_TRACE)
 		ctx[ctx_index].op[prefix] = op;
diff -ruN source/src/vm/np21/i386c/ia32/cpu.h src/vm/np21/i386c/ia32/cpu.h
--- source/src/vm/np21/i386c/ia32/cpu.h	2025-04-28 16:00:00
+++ src/vm/np21/i386c/ia32/cpu.h	2025-04-28 22:36:36
@@ -78,9 +78,13 @@
 #ifndef SINT64
 	typedef signed __int64 SINT64;
 #endif
+#ifndef REG8
+	#define	REG8	UINT8
+#endif
+#ifndef REG16
+	#define	REG16	UINT16
+#endif
 
-/* Little Ending */
-
 #ifndef LOADINTELDWORD
 #define	LOADINTELDWORD(a)	(((UINT32)(((UINT8*)(a))[0])      ) |	\
 				 ((UINT32)(((UINT8*)(a))[1]) <<  8) |	\
@@ -104,23 +108,8 @@
 				*(((UINT8*)(a))+1) = (UINT8)((b)>>8)
 #endif
 
-/* *** */
-
-#ifndef	NELEMENTS
-#define	NELEMENTS(a)	((int)(sizeof(a) / sizeof(a[0])))
-#endif
-
-// ---- Optimize Macros
-
-#ifndef REG8
-#define	REG8		UINT8
-#endif
-#ifndef REG16
-#define	REG16		UINT16
-#endif
-
 #ifndef LOW16
-#define	LOW16(a)	((UINT16)(a))
+#define	LOW16(a)		((UINT16)(a))
 #endif
 
 #ifndef INLINE
@@ -160,10 +149,6 @@
 #define USE_SSE
 #define USE_SSE2
 #define USE_SSE3
-#define USE_SSSE3
-#define USE_SSE4_1
-#define USE_SSE4_2
-#define USE_SSE4A
 #define USE_TSC
 #define USE_FASTPAGING
 #define USE_VME
@@ -363,7 +348,6 @@
 	FPU_PTR		data; // ÉâÉXÉgÉfÅ[É^É|ÉCÉìÉ^ÉåÉWÉXÉ^Å[
 } FPU_REGS_S;
 
-#if defined(USE_FPU)
 #if 0
 
 typedef struct {
@@ -471,7 +455,6 @@
 } FPU_STAT_S;
 
 #endif
-#endif
 
 typedef struct {
 	CPU_REGS	cpu_regs;
@@ -487,10 +470,8 @@
 
 	/* protected by cpu shut */
 	UINT8		cpu_type;
-#if 0
 	UINT8		itfbank;
 	UINT16		ram_d0;
-#endif
 	SINT32		remainclock;
 	SINT32		baseclock;
 	UINT32		clock;
@@ -500,7 +481,6 @@
 #endif
 } I386STAT;
 
-#if 0
 typedef struct {
 	UINT8		*ext;
 	UINT32		extsize;
@@ -510,13 +490,10 @@
 	UINT32		inport;
 	UINT8		*ems[4];
 } I386EXT;
-#endif
 
 typedef struct {
 	I386STAT	s;		/* STATsave'ed */
-#if 0
 	I386EXT		e;
-#endif
 } I386CORE;
 
 #define I386CPUID_VERSION	1
@@ -535,8 +512,7 @@
 
 	UINT8 allow_movCS; // mov cs,xxÇãñâ¬Ç∑ÇÈ
 	UINT8 reserved8[3]; // è´óàÇÃägí£ÇÃÇΩÇﬂÇ…Ç∆ÇËÇ†Ç¶Ç∏
-	UINT32 cpu_feature_ex_ecx; // ECXägí£ã@î\ÉtÉâÉO
-	UINT32 reserved[29]; // è´óàÇÃägí£ÇÃÇΩÇﬂÇ…Ç∆ÇËÇ†Ç¶Ç∏32bit*29å¬ópà”ÇµÇƒÇ®Ç≠
+	UINT32 reserved[30]; // è´óàÇÃägí£ÇÃÇΩÇﬂÇ…Ç∆ÇËÇ†Ç¶Ç∏32bit*31å¬ópà”ÇµÇƒÇ®Ç≠
 	
 	UINT8 fpu_type; // FPUéÌóﬁ
 } I386CPUID;
@@ -567,15 +543,12 @@
 #define	CPU_REMCLOCK	i386core.s.remainclock
 #define	CPU_BASECLOCK	i386core.s.baseclock
 #define	CPU_CLOCK	i386core.s.clock
-#if 0
 #define	CPU_ITFBANK	i386core.s.itfbank
 #define	CPU_RAM_D000	i386core.s.ram_d0
-#endif
 
 #define CPU_TYPE	i386core.s.cpu_type
 #define CPUTYPE_V30	0x01
 
-#if 0
 #define	CPU_EXTMEM	i386core.e.ext
 #define	CPU_EXTMEMSIZE	i386core.e.extsize
 #define	CPU_EXTMEMBASE	i386core.e.extbase
@@ -583,7 +556,6 @@
 #define	CPU_EXTLIMIT	i386core.e.extlimit4gb
 #define	CPU_INPADRS	i386core.e.inport
 #define	CPU_EMSPTR	i386core.e.ems
-#endif
 
 #ifndef __cplusplus
 extern sigjmp_buf	exec_1step_jmpbuf;
@@ -613,18 +585,6 @@
 #define	CPU_VENDOR		CPU_VENDOR_INTEL
 
 /*** version ***/
-#define	CPU_CORE_I_FAMILY			6
-#define	CPU_CORE_I_MODEL			37	/* Core i5 Nehalem */  // 25
-#define	CPU_CORE_I_STEPPING			5
-
-#define	CPU_CORE_2_DUOW_FAMILY		6
-#define	CPU_CORE_2_DUOW_MODEL		23	/* Core 2 Duo Wolfdale */  // 17
-#define	CPU_CORE_2_DUOW_STEPPING	6
-
-#define	CPU_CORE_2_DUO_FAMILY		6
-#define	CPU_CORE_2_DUO_MODEL		15	/* Core 2 Duo Conroe */  // 15
-#define	CPU_CORE_2_DUO_STEPPING		13
-
 #define	CPU_PENTIUM_4_FAMILY		15
 #define	CPU_PENTIUM_4_MODEL			2	/* Pentium 4 */
 #define	CPU_PENTIUM_4_STEPPING		4
@@ -670,18 +630,6 @@
 #define	CPU_80286_STEPPING			1
 
 
-#define	CPU_AMD_K10_PHENOM_FAMILY		16
-#define	CPU_AMD_K10_PHENOM_MODEL		2	/* AMD K10 Phenom */
-#define	CPU_AMD_K10_PHENOM_STEPPING		2
-
-#define	CPU_AMD_K8_ATHLON_64X2_FAMILY	15
-#define	CPU_AMD_K8_ATHLON_64X2_MODEL	44	/* AMD K8 Athlon 64 X2 */
-#define	CPU_AMD_K8_ATHLON_64X2_STEPPING	2
-
-#define	CPU_AMD_K8_ATHLON_64_FAMILY		15
-#define	CPU_AMD_K8_ATHLON_64_MODEL		4	/* AMD K8 Athlon 64 */
-#define	CPU_AMD_K8_ATHLON_64_STEPPING	8
-
 #define	CPU_AMD_K7_ATHLON_XP_FAMILY		6
 #define	CPU_AMD_K7_ATHLON_XP_MODEL		6	/* AMD K7 Athlon XP */
 #define	CPU_AMD_K7_ATHLON_XP_STEPPING	2
@@ -774,9 +722,6 @@
 /* égópÇ≈Ç´ÇÈã@î\ëSïî */
 #define	CPU_FEATURES_ALL	(CPU_FEATURE_FPU_FLAG|CPU_FEATURE_CX8|CPU_FEATURE_TSC_FLAG|CPU_FEATURE_VME_FLAG|CPU_FEATURE_CMOV|CPU_FEATURE_MMX_FLAG|CPU_FEATURE_SSE_FLAG|CPU_FEATURE_SSE2_FLAG|CPU_FEATURE_SEP)
 
-#define	CPU_FEATURES_CORE_I				(CPU_FEATURE_FPU|CPU_FEATURE_CX8|CPU_FEATURE_TSC|CPU_FEATURE_VME_FLAG|CPU_FEATURE_CMOV|CPU_FEATURE_FXSR|CPU_FEATURE_MMX|CPU_FEATURE_CLFSH|CPU_FEATURE_SSE|CPU_FEATURE_SSE2)
-#define	CPU_FEATURES_CORE_2_DUOW		(CPU_FEATURE_FPU|CPU_FEATURE_CX8|CPU_FEATURE_TSC|CPU_FEATURE_VME_FLAG|CPU_FEATURE_CMOV|CPU_FEATURE_FXSR|CPU_FEATURE_MMX|CPU_FEATURE_CLFSH|CPU_FEATURE_SSE|CPU_FEATURE_SSE2)
-#define	CPU_FEATURES_CORE_2_DUO			(CPU_FEATURE_FPU|CPU_FEATURE_CX8|CPU_FEATURE_TSC|CPU_FEATURE_VME_FLAG|CPU_FEATURE_CMOV|CPU_FEATURE_FXSR|CPU_FEATURE_MMX|CPU_FEATURE_CLFSH|CPU_FEATURE_SSE|CPU_FEATURE_SSE2)
 #define	CPU_FEATURES_PENTIUM_4			(CPU_FEATURE_FPU|CPU_FEATURE_CX8|CPU_FEATURE_TSC|CPU_FEATURE_VME_FLAG|CPU_FEATURE_CMOV|CPU_FEATURE_FXSR|CPU_FEATURE_MMX|CPU_FEATURE_CLFSH|CPU_FEATURE_SSE|CPU_FEATURE_SSE2)
 #define	CPU_FEATURES_PENTIUM_M			(CPU_FEATURE_FPU|CPU_FEATURE_CX8|CPU_FEATURE_TSC|CPU_FEATURE_VME_FLAG|CPU_FEATURE_CMOV|CPU_FEATURE_FXSR|CPU_FEATURE_MMX|CPU_FEATURE_CLFSH|CPU_FEATURE_SSE|CPU_FEATURE_SSE2)
 #define	CPU_FEATURES_PENTIUM_III		(CPU_FEATURE_FPU|CPU_FEATURE_CX8|CPU_FEATURE_TSC|CPU_FEATURE_VME_FLAG|CPU_FEATURE_CMOV|CPU_FEATURE_FXSR|CPU_FEATURE_MMX|CPU_FEATURE_CLFSH|CPU_FEATURE_SSE)
@@ -789,9 +734,6 @@
 #define	CPU_FEATURES_80386				(0)
 #define	CPU_FEATURES_80286				(0)
 
-#define	CPU_FEATURES_AMD_K10_PHENOM		(CPU_FEATURE_FPU|CPU_FEATURE_CX8|CPU_FEATURE_TSC|CPU_FEATURE_VME_FLAG|CPU_FEATURE_CMOV|CPU_FEATURE_FXSR|CPU_FEATURE_MMX|CPU_FEATURE_CLFSH|CPU_FEATURE_SSE|CPU_FEATURE_SSE2)
-#define	CPU_FEATURES_AMD_K8_ATHLON_64X2	(CPU_FEATURE_FPU|CPU_FEATURE_CX8|CPU_FEATURE_TSC|CPU_FEATURE_VME_FLAG|CPU_FEATURE_CMOV|CPU_FEATURE_FXSR|CPU_FEATURE_MMX|CPU_FEATURE_CLFSH|CPU_FEATURE_SSE|CPU_FEATURE_SSE2)
-#define	CPU_FEATURES_AMD_K8_ATHLON_64	(CPU_FEATURE_FPU|CPU_FEATURE_CX8|CPU_FEATURE_TSC|CPU_FEATURE_VME_FLAG|CPU_FEATURE_CMOV|CPU_FEATURE_FXSR|CPU_FEATURE_MMX|CPU_FEATURE_CLFSH|CPU_FEATURE_SSE|CPU_FEATURE_SSE2)
 #define	CPU_FEATURES_AMD_K7_ATHLON_XP	(CPU_FEATURE_FPU|CPU_FEATURE_CX8|CPU_FEATURE_TSC|CPU_FEATURE_VME_FLAG|CPU_FEATURE_CMOV|CPU_FEATURE_FXSR|CPU_FEATURE_MMX|CPU_FEATURE_CLFSH|CPU_FEATURE_SSE)
 #define	CPU_FEATURES_AMD_K7_ATHLON		(CPU_FEATURE_FPU|CPU_FEATURE_CX8|CPU_FEATURE_TSC|CPU_FEATURE_VME_FLAG|CPU_FEATURE_CMOV|CPU_FEATURE_MMX)
 #define	CPU_FEATURES_AMD_K6_III			(CPU_FEATURE_FPU|CPU_FEATURE_CX8|CPU_FEATURE_TSC|CPU_FEATURE_VME_FLAG|CPU_FEATURE_MMX)
@@ -819,9 +761,6 @@
 /* égópÇ≈Ç´ÇÈã@î\ëSïî */
 #define	CPU_FEATURES_EX_ALL		(CPU_FEATURE_EX_3DNOW_FLAG|CPU_FEATURE_EX_E3DNOW_FLAG)
 
-#define	CPU_FEATURES_EX_CORE_I		(0)
-#define	CPU_FEATURES_EX_CORE_2_DUOW	(0)
-#define	CPU_FEATURES_EX_CORE_2_DUO	(0)
 #define	CPU_FEATURES_EX_PENTIUM_4	(0)
 #define	CPU_FEATURES_EX_PENTIUM_M	(0)
 #define	CPU_FEATURES_EX_PENTIUM_III	(0)
@@ -834,49 +773,11 @@
 #define	CPU_FEATURES_EX_80386		(0)
 #define	CPU_FEATURES_EX_80286		(0)
 
-#define	CPU_FEATURES_EX_AMD_K10_PHENOM		(CPU_FEATURE_EX_3DNOW|CPU_FEATURE_EX_E3DNOW)
-#define	CPU_FEATURES_EX_AMD_K8_ATHLON_64X2	(CPU_FEATURE_EX_3DNOW|CPU_FEATURE_EX_E3DNOW)
-#define	CPU_FEATURES_EX_AMD_K8_ATHLON_64	(CPU_FEATURE_EX_3DNOW|CPU_FEATURE_EX_E3DNOW)
-#define	CPU_FEATURES_EX_AMD_K7_ATHLON_XP	(CPU_FEATURE_EX_3DNOW|CPU_FEATURE_EX_E3DNOW)
-#define	CPU_FEATURES_EX_AMD_K7_ATHLON		(CPU_FEATURE_EX_3DNOW|CPU_FEATURE_EX_E3DNOW)
-#define	CPU_FEATURES_EX_AMD_K6_III			(CPU_FEATURE_EX_3DNOW)
 #define	CPU_FEATURES_EX_AMD_K6_2			(CPU_FEATURE_EX_3DNOW)
+#define	CPU_FEATURES_EX_AMD_K6_III			(CPU_FEATURE_EX_3DNOW)
+#define	CPU_FEATURES_EX_AMD_K7_ATHLON		(CPU_FEATURE_EX_3DNOW|CPU_FEATURE_EX_E3DNOW)
+#define	CPU_FEATURES_EX_AMD_K7_ATHLON_XP	(CPU_FEATURE_EX_3DNOW|CPU_FEATURE_EX_E3DNOW)
 
-/*** extended ECX feature ***/
-#define	CPU_FEATURE_EX_ECX_SSE4A		(1 << 6)
-
-#if defined(USE_MMX)&&defined(USE_FPU)&&defined(USE_3DNOW)&&defined(USE_SSE)&&defined(USE_SSE2)&&defined(USE_SSE3)&&defined(USE_SSE4A)
-#define	CPU_FEATURE_EX_ECX_SSE4A_FLAG	CPU_FEATURE_EX_ECX_SSE4A
-#else
-#define	CPU_FEATURE_EX_ECX_SSE4A_FLAG	0
-#endif
-
-/* égópÇ≈Ç´ÇÈã@î\ëSïî */
-#define	CPU_FEATURES_EX_ECX_ALL		(CPU_FEATURE_EX_ECX_SSE4A_FLAG)
-
-#define	CPU_FEATURES_EX_ECX_CORE_I		(0)
-#define	CPU_FEATURES_EX_ECX_CORE_2_DUOW	(0)
-#define	CPU_FEATURES_EX_ECX_CORE_2_DUO	(0)
-#define	CPU_FEATURES_EX_ECX_PENTIUM_4	(0)
-#define	CPU_FEATURES_EX_ECX_PENTIUM_M	(0)
-#define	CPU_FEATURES_EX_ECX_PENTIUM_III	(0)
-#define	CPU_FEATURES_EX_ECX_PENTIUM_II	(0)
-#define	CPU_FEATURES_EX_ECX_PENTIUM_PRO	(0)
-#define	CPU_FEATURES_EX_ECX_MMX_PENTIUM	(0)
-#define	CPU_FEATURES_EX_ECX_PENTIUM		(0)
-#define	CPU_FEATURES_EX_ECX_I486DX		(0)
-#define	CPU_FEATURES_EX_ECX_I486SX		(0)
-#define	CPU_FEATURES_EX_ECX_80386		(0)
-#define	CPU_FEATURES_EX_ECX_80286		(0)
-
-#define	CPU_FEATURES_EX_ECX_AMD_K10_PHENOM		(CPU_FEATURE_EX_ECX_SSE4A_FLAG)
-#define	CPU_FEATURES_EX_ECX_AMD_K8_ATHLON_64X2	(0)
-#define	CPU_FEATURES_EX_ECX_AMD_K8_ATHLON_64	(0)
-#define	CPU_FEATURES_EX_ECX_AMD_K7_ATHLON_XP	(0)
-#define	CPU_FEATURES_EX_ECX_AMD_K7_ATHLON		(0)
-#define	CPU_FEATURES_EX_ECX_AMD_K6_III			(0)
-#define	CPU_FEATURES_EX_ECX_AMD_K6_2			(0)
-
 /*** ECX feature ***/
 #define	CPU_FEATURE_ECX_SSE3		(1 << 0)
 #define	CPU_FEATURE_ECX_PCLMULDQ	(1 << 1)
@@ -917,32 +818,9 @@
 #define	CPU_FEATURE_ECX_SSE3_FLAG	0
 #endif
 
-#if defined(USE_MMX)&&defined(USE_FPU)&&defined(USE_SSE)&&defined(USE_SSE2)&&defined(USE_SSE3)&&defined(USE_SSSE3)
-#define	CPU_FEATURE_ECX_SSSE3_FLAG	CPU_FEATURE_ECX_SSSE3
-#else
-#define	CPU_FEATURE_ECX_SSSE3_FLAG	0
-#endif
-
-#if defined(USE_MMX)&&defined(USE_FPU)&&defined(USE_SSE)&&defined(USE_SSE2)&&defined(USE_SSE3)&&defined(USE_SSSE3)&&defined(USE_SSE4_1)
-#define	CPU_FEATURE_ECX_SSE4_1_FLAG	CPU_FEATURE_ECX_SSE4_1
-#else
-#define	CPU_FEATURE_ECX_SSE4_1_FLAG	0
-#endif
-
-#if defined(USE_MMX)&&defined(USE_FPU)&&defined(USE_SSE)&&defined(USE_SSE2)&&defined(USE_SSE3)&&defined(USE_SSSE3)&&defined(USE_SSE4_1)&&defined(USE_SSE4_2)
-#define	CPU_FEATURE_ECX_SSE4_2_FLAG	CPU_FEATURE_ECX_SSE4_2
-#define	CPU_FEATURE_ECX_POPCNT_FLAG	CPU_FEATURE_ECX_POPCNT
-#else
-#define	CPU_FEATURE_ECX_SSE4_2_FLAG	0
-#define	CPU_FEATURE_ECX_POPCNT_FLAG	0
-#endif
-
 /* égópÇ≈Ç´ÇÈã@î\ëSïî */
-#define	CPU_FEATURES_ECX_ALL	(CPU_FEATURE_ECX_SSE3_FLAG|CPU_FEATURE_ECX_SSSE3_FLAG|CPU_FEATURE_ECX_SSE4_1_FLAG|CPU_FEATURE_ECX_SSE4_2_FLAG|CPU_FEATURE_ECX_POPCNT_FLAG)
+#define	CPU_FEATURES_ECX_ALL	(CPU_FEATURE_ECX_SSE3_FLAG)
 
-#define	CPU_FEATURES_ECX_CORE_I			(CPU_FEATURE_ECX_SSE3|CPU_FEATURE_ECX_SSSE3|CPU_FEATURE_ECX_SSE4_1|CPU_FEATURE_ECX_SSE4_2|CPU_FEATURE_ECX_POPCNT)
-#define	CPU_FEATURES_ECX_CORE_2_DUOW	(CPU_FEATURE_ECX_SSE3|CPU_FEATURE_ECX_SSSE3|CPU_FEATURE_ECX_SSE4_1)
-#define	CPU_FEATURES_ECX_CORE_2_DUO		(CPU_FEATURE_ECX_SSE3|CPU_FEATURE_ECX_SSSE3)
 #define	CPU_FEATURES_ECX_PENTIUM_4		(CPU_FEATURE_ECX_SSE3)
 #define	CPU_FEATURES_ECX_PENTIUM_M		(0)
 #define	CPU_FEATURES_ECX_PENTIUM_III	(0)
@@ -955,19 +833,13 @@
 #define	CPU_FEATURES_ECX_80386			(0)
 #define	CPU_FEATURES_ECX_80286			(0)
 
-#define	CPU_FEATURES_ECX_AMD_K10_PHENOM		(CPU_FEATURE_ECX_SSE3|CPU_FEATURE_ECX_POPCNT)
-#define	CPU_FEATURES_ECX_AMD_K8_ATHLON_64X2	(CPU_FEATURE_ECX_SSE3)
-#define	CPU_FEATURES_ECX_AMD_K8_ATHLON_64	(0)
-#define	CPU_FEATURES_ECX_AMD_K7_ATHLON_XP	(0)
-#define	CPU_FEATURES_ECX_AMD_K7_ATHLON		(0)
-#define	CPU_FEATURES_ECX_AMD_K6_III			(0)
 #define	CPU_FEATURES_ECX_AMD_K6_2			(0)
+#define	CPU_FEATURES_ECX_AMD_K6_III			(0)
+#define	CPU_FEATURES_ECX_AMD_K7_ATHLON		(0)
+#define	CPU_FEATURES_ECX_AMD_K7_ATHLON_XP	(0)
 
 
 /* EFLAGS MASK */
-#define	CPU_EFLAGS_MASK_CORE_I			(0)
-#define	CPU_EFLAGS_MASK_CORE_2_DUOW		(0)
-#define	CPU_EFLAGS_MASK_CORE_2_DUO		(0)
 #define	CPU_EFLAGS_MASK_PENTIUM_4		(0)
 #define	CPU_EFLAGS_MASK_PENTIUM_M		(0)
 #define	CPU_EFLAGS_MASK_PENTIUM_III		(0)
@@ -980,19 +852,13 @@
 #define	CPU_EFLAGS_MASK_80386			((1 << 18))
 #define	CPU_EFLAGS_MASK_80286			((1 << 18))
 
-#define	CPU_EFLAGS_MASK_AMD_K10_PHENOM		(0)
-#define	CPU_EFLAGS_MASK_AMD_K8_ATHLON_64X2	(0)
-#define	CPU_EFLAGS_MASK_AMD_K8_ATHLON_64	(0)
-#define	CPU_EFLAGS_MASK_AMD_K7_ATHLON_XP	(0)
-#define	CPU_EFLAGS_MASK_AMD_K7_ATHLON		(0)
-#define	CPU_EFLAGS_MASK_AMD_K6_III			(0)
 #define	CPU_EFLAGS_MASK_AMD_K6_2			(0)
+#define	CPU_EFLAGS_MASK_AMD_K6_III			(0)
+#define	CPU_EFLAGS_MASK_AMD_K7_ATHLON		(0)
+#define	CPU_EFLAGS_MASK_AMD_K7_ATHLON_XP	(0)
 
 
 /* brand string */
-#define	CPU_BRAND_STRING_CORE_I				"Intel(R) Core(TM) i3/5/7 CPU "
-#define	CPU_BRAND_STRING_CORE_2_DUOW		"Intel(R) Core(TM)2 CPU SSE4.1 "
-#define	CPU_BRAND_STRING_CORE_2_DUO			"Intel(R) Core(TM)2 CPU "
 #define	CPU_BRAND_STRING_PENTIUM_4			"Intel(R) Pentium(R) 4 CPU "
 #define	CPU_BRAND_STRING_PENTIUM_M			"Intel(R) Pentium(R) M processor "
 #define	CPU_BRAND_STRING_PENTIUM_III		"Intel(R) Pentium(R) III CPU "
@@ -1004,21 +870,15 @@
 #define	CPU_BRAND_STRING_I486SX				"Intel(R) i486SX Processor "
 #define	CPU_BRAND_STRING_80386				"Intel(R) 80386 Processor "
 #define	CPU_BRAND_STRING_80286				"Intel(R) 80286 Processor "
-#define	CPU_BRAND_STRING_AMD_K10_PHENOM		"AMD Phenom(tm) Processor "
-#define	CPU_BRAND_STRING_AMD_K8_ATHLON_64X2	"AMD Athlon(tm) 64 Processor "
-#define	CPU_BRAND_STRING_AMD_K8_ATHLON_64	"AMD Athlon(tm) 64 Processor "
-#define	CPU_BRAND_STRING_AMD_K7_ATHLON_XP	"AMD Athlon(tm) XP "
-#define	CPU_BRAND_STRING_AMD_K7_ATHLON		"AMD-K7(tm) Processor "
-#define	CPU_BRAND_STRING_AMD_K6_III			"AMD-K6(tm) 3D+ Processor "
 #define	CPU_BRAND_STRING_AMD_K6_2			"AMD-K6(tm) 3D processor "
+#define	CPU_BRAND_STRING_AMD_K6_III			"AMD-K6(tm) 3D+ Processor "
+#define	CPU_BRAND_STRING_AMD_K7_ATHLON		"AMD-K7(tm) Processor "
+#define	CPU_BRAND_STRING_AMD_K7_ATHLON_XP	"AMD Athlon(tm) XP "
 #define	CPU_BRAND_STRING_NEKOPRO			"Neko Processor " // ÉJÉXÉ^ÉÄê›íË
 #define	CPU_BRAND_STRING_NEKOPRO2			"Neko Processor II " // ëSã@î\égópâ¬î\
 
 
 /* brand id */
-#define	CPU_BRAND_ID_CORE_I				0
-#define	CPU_BRAND_ID_CORE_2_DUOW		0
-#define	CPU_BRAND_ID_CORE_2_DUO			0
 #define	CPU_BRAND_ID_PENTIUM_4			0x9
 #define	CPU_BRAND_ID_PENTIUM_M			0x16
 #define	CPU_BRAND_ID_PENTIUM_III		0x2
@@ -1030,13 +890,10 @@
 #define	CPU_BRAND_ID_I486SX				0
 #define	CPU_BRAND_ID_80386				0
 #define	CPU_BRAND_ID_80286				0
-#define	CPU_BRAND_ID_AMD_K10_PHENOM		0
-#define	CPU_BRAND_ID_AMD_K8_ATHLON_64X2	0
-#define	CPU_BRAND_ID_AMD_K8_ATHLON_64	0
-#define	CPU_BRAND_ID_AMD_K7_ATHLON_XP	0
-#define	CPU_BRAND_ID_AMD_K7_ATHLON		0
-#define	CPU_BRAND_ID_AMD_K6_III			0
 #define	CPU_BRAND_ID_AMD_K6_2			0
+#define	CPU_BRAND_ID_AMD_K6_III			0
+#define	CPU_BRAND_ID_AMD_K7_ATHLON		0
+#define	CPU_BRAND_ID_AMD_K7_ATHLON_XP	0
 #define	CPU_BRAND_ID_NEKOPRO			0 // ÉJÉXÉ^ÉÄê›íË
 #define	CPU_BRAND_ID_NEKOPRO2			0 // ëSã@î\égópâ¬î\
 
@@ -1051,10 +908,18 @@
 #define	CPU_FEATURES		CPU_FEATURES_PENTIUM_III
 #define	CPU_FEATURES_EX		CPU_FEATURES_EX_PENTIUM_III
 #define	CPU_FEATURES_ECX	CPU_FEATURES_ECX_PENTIUM_III
-#define	CPU_FEATURES_EX_ECX	CPU_FEATURES_EX_ECX_PENTIUM_III
 #define	CPU_BRAND_STRING	CPU_BRAND_STRING_PENTIUM_III
 #define	CPU_BRAND_ID		CPU_BRAND_ID_PENTIUM_III
 #define	CPU_EFLAGS_MASK		CPU_EFLAGS_MASK_PENTIUM_III
+//#define	CPU_FAMILY			CPU_PENTIUM_4_FAMILY
+//#define	CPU_MODEL			CPU_PENTIUM_4_MODEL	/* Pentium 4 */
+//#define	CPU_STEPPING		CPU_PENTIUM_4_STEPPING
+//#define	CPU_FEATURES		CPU_FEATURES_PENTIUM_4
+//#define	CPU_FEATURES_EX		CPU_FEATURES_EX_PENTIUM_4
+//#define	CPU_FEATURES_ECX	CPU_FEATURES_ECX_PENTIUM_4
+//#define	CPU_BRAND_STRING	CPU_BRAND_STRING_PENTIUM_4
+//#define	CPU_BRAND_ID		CPU_BRAND_ID_PENTIUM_4
+//#define	CPU_EFLAGS_MASK		CPU_EFLAGS_MASK_PENTIUM_4
 #elif defined(USE_SSE2)
 #define	CPU_FAMILY			CPU_PENTIUM_III_FAMILY
 #define	CPU_MODEL			CPU_PENTIUM_III_MODEL	/* Pentium III */
@@ -1062,10 +927,18 @@
 #define	CPU_FEATURES		CPU_FEATURES_PENTIUM_III
 #define	CPU_FEATURES_EX		CPU_FEATURES_EX_PENTIUM_III
 #define	CPU_FEATURES_ECX	CPU_FEATURES_ECX_PENTIUM_III
-#define	CPU_FEATURES_EX_ECX	CPU_FEATURES_EX_ECX_PENTIUM_III
 #define	CPU_BRAND_STRING	CPU_BRAND_STRING_PENTIUM_III
 #define	CPU_BRAND_ID		CPU_BRAND_ID_PENTIUM_III
 #define	CPU_EFLAGS_MASK		CPU_EFLAGS_MASK_PENTIUM_III
+//#define	CPU_FAMILY			CPU_PENTIUM_M_FAMILY
+//#define	CPU_MODEL			CPU_PENTIUM_M_MODEL	/* Pentium M */
+//#define	CPU_STEPPING		CPU_PENTIUM_M_STEPPING
+//#define	CPU_FEATURES		CPU_FEATURES_PENTIUM_M
+//#define	CPU_FEATURES_EX		CPU_FEATURES_EX_PENTIUM_M
+//#define	CPU_FEATURES_ECX	CPU_FEATURES_ECX_PENTIUM_M
+//#define	CPU_BRAND_STRING	CPU_BRAND_STRING_PENTIUM_M
+//#define	CPU_BRAND_ID		CPU_BRAND_ID_PENTIUM_M
+//#define	CPU_EFLAGS_MASK		CPU_EFLAGS_MASK_PENTIUM_M
 #elif defined(USE_SSE)
 #define	CPU_FAMILY			CPU_PENTIUM_III_FAMILY
 #define	CPU_MODEL			CPU_PENTIUM_III_MODEL	/* Pentium III */
@@ -1073,7 +946,6 @@
 #define	CPU_FEATURES		CPU_FEATURES_PENTIUM_III
 #define	CPU_FEATURES_EX		CPU_FEATURES_EX_PENTIUM_III
 #define	CPU_FEATURES_ECX	CPU_FEATURES_ECX_PENTIUM_III
-#define	CPU_FEATURES_EX_ECX	CPU_FEATURES_EX_ECX_PENTIUM_III
 #define	CPU_BRAND_STRING	CPU_BRAND_STRING_PENTIUM_III
 #define	CPU_BRAND_ID		CPU_BRAND_ID_PENTIUM_III
 #define	CPU_EFLAGS_MASK		CPU_EFLAGS_MASK_PENTIUM_III
@@ -1084,7 +956,6 @@
 #define	CPU_FEATURES		CPU_FEATURES_PENTIUM_II
 #define	CPU_FEATURES_EX		CPU_FEATURES_EX_PENTIUM_II
 #define	CPU_FEATURES_ECX	CPU_FEATURES_ECX_PENTIUM_II
-#define	CPU_FEATURES_EX_ECX	CPU_FEATURES_EX_ECX_PENTIUM_II
 #define	CPU_BRAND_STRING	CPU_BRAND_STRING_PENTIUM_II
 #define	CPU_BRAND_ID		CPU_BRAND_ID_PENTIUM_II
 #define	CPU_EFLAGS_MASK		CPU_EFLAGS_MASK_PENTIUM_II
@@ -1095,7 +966,6 @@
 #define	CPU_FEATURES		CPU_FEATURES_PENTIUM
 #define	CPU_FEATURES_EX		CPU_FEATURES_EX_PENTIUM
 #define	CPU_FEATURES_ECX	CPU_FEATURES_ECX_PENTIUM
-#define	CPU_FEATURES_EX_ECX	CPU_FEATURES_EX_ECX_PENTIUM
 #define	CPU_BRAND_STRING	CPU_BRAND_STRING_PENTIUM
 #define	CPU_BRAND_ID		CPU_BRAND_ID_PENTIUM
 #define	CPU_EFLAGS_MASK		CPU_EFLAGS_MASK_PENTIUM
@@ -1107,7 +977,6 @@
 #define	CPU_FEATURES		CPU_FEATURES_I486SX
 #define	CPU_FEATURES_EX		CPU_FEATURES_EX_I486SX
 #define	CPU_FEATURES_ECX	CPU_FEATURES_ECX_I486SX
-#define	CPU_FEATURES_EX_ECX	CPU_FEATURES_EX_ECX_I486SX
 #define	CPU_BRAND_STRING	CPU_BRAND_STRING_I486SX
 #define	CPU_BRAND_ID		CPU_BRAND_ID_I486SX
 #define	CPU_EFLAGS_MASK		CPU_EFLAGS_MASK_I486SX
@@ -1452,7 +1321,6 @@
 #define	FPU_CTRLWORD		FPU_REGS.control
 #define	FPU_CTRLWORDMASK	FPU_REGS.cw_mask_all
 #define	FPU_STATUSWORD		FPU_REGS.status
-#define	FPU_TAGWORD		FPU_REGS.tag
 #define	FPU_INSTPTR		FPU_REGS.inst
 #define	FPU_DATAPTR		FPU_REGS.data
 #define	FPU_LASTINSTOP		FPU_REGS.op
diff -ruN source/src/vm/np21/i386c/ia32/debug.cpp src/vm/np21/i386c/ia32/debug.cpp
--- source/src/vm/np21/i386c/ia32/debug.cpp	2025-04-28 16:00:00
+++ src/vm/np21/i386c/ia32/debug.cpp	2025-04-28 22:36:36
@@ -132,7 +132,6 @@
 	va_start(ap, str);
 	vsnprintf(buf, sizeof(buf), str, ap);
 	va_end(ap);
-	buf[NELEMENTS(buf) - 2] = '\0';
 	strcat(buf, "\n");
 
 	printf("%s", buf);
diff -ruN source/src/vm/np21/i386c/ia32/ia32.mcr src/vm/np21/i386c/ia32/ia32.mcr
--- source/src/vm/np21/i386c/ia32/ia32.mcr	2025-04-28 16:00:00
+++ src/vm/np21/i386c/ia32/ia32.mcr	2025-04-28 22:36:36
@@ -34,18 +34,10 @@
 #define	__CWDE(src)	((SINT16)(src))
 
 #ifndef	PTR_TO_UINT32
-#ifdef _WIN64
-#define	PTR_TO_UINT32(p)	((UINT32)((unsigned long long)(p)))
-#else
 #define	PTR_TO_UINT32(p)	((UINT32)((unsigned long)(p)))
 #endif
-#endif
 #ifndef	UINT32_TO_PTR
-#ifdef _WIN64
-#define	UINT32_TO_PTR(v)	((void *)((unsigned long long)(UINT32)(v)))
-#else
 #define	UINT32_TO_PTR(v)	((void *)((unsigned long)(UINT32)(v)))
-#endif
 #endif
 
 #define	SWAP_BYTE(p, q) \
diff -ruN source/src/vm/np21/i386c/ia32/inst_table.cpp src/vm/np21/i386c/ia32/inst_table.cpp
--- source/src/vm/np21/i386c/ia32/inst_table.cpp	2025-04-28 16:00:00
+++ src/vm/np21/i386c/ia32/inst_table.cpp	2025-04-28 22:36:36
@@ -48,10 +48,6 @@
 #include "instructions/sse/sse.h"
 #include "instructions/sse2/sse2.h"
 #include "instructions/sse3/sse3.h"
-#include "instructions/ssse3/ssse3.h"
-#include "instructions/sse4/sse4_1.h"
-#include "instructions/sse4/sse4_2.h"
-#include "instructions/sse4a/sse4a.h"
 
 /*
  * UNDEF OP
@@ -1512,14 +1508,14 @@
 		SYSEXIT,
 		undef_op,
 		undef_op,
-		_3byte_38ESC_16,		/* 38 */
+		undef_op,		/* 38 */
 		undef_op,
-		_3byte_3AESC,
 		undef_op,
 		undef_op,
 		undef_op,
 		undef_op,
 		undef_op,
+		undef_op,
 
 		CMOVO_GwEw,		/* 40 */
 		CMOVNO_GwEw,
@@ -1554,7 +1550,7 @@
 		SSE_MINPS,
 		SSE_DIVPS,
 		SSE_MAXPS,
-
+		
 		MMX_PUNPCKLBW,		/* 60 */
 		MMX_PUNPCKLWD,
 		MMX_PUNPCKLDQ,
@@ -1744,7 +1740,7 @@
 		AMD3DNOW_PREFETCH,
 		AMD3DNOW_FEMMS,
 		undef_op,
-
+		
 		SSE_MOVUPSmem2xmm,		/* 10 */
 		SSE_MOVUPSxmm2mem,
 		SSE_MOVLPSmem2xmm, // + MOVHLPS
@@ -1787,14 +1783,14 @@
 		SYSEXIT,
 		undef_op,
 		undef_op,
-		_3byte_38ESC,		/* 38 */
+		undef_op,		/* 38 */
 		undef_op,
-		_3byte_3AESC,
 		undef_op,
 		undef_op,
 		undef_op,
 		undef_op,
 		undef_op,
+		undef_op,
 
 		CMOVO_GdEd,		/* 40 */
 		CMOVNO_GdEd,
@@ -1812,7 +1808,7 @@
 		CMOVNL_GdEd,
 		CMOVLE_GdEd,
 		CMOVNLE_GdEd,
-
+		
 		SSE_MOVMSKPS,		/* 50 */
 		SSE_SQRTPS,
 		SSE_RSQRTPS,
@@ -1846,7 +1842,7 @@
 		undef_op,
 		MMX_MOVD_mm_rm32,
 		MMX_MOVQ_mm_mmm64,
-
+		
 		SSE_PSHUFW,		/* 70 */
 		MMX_PSxxW_imm8,
 		MMX_PSxxD_imm8,
@@ -1965,7 +1961,7 @@
 		MMX_PADDUSW,
 		SSE_PMAXUB,
 		MMX_PANDN,
-
+		
 		SSE_PAVGB,		/* E0 */
 		MMX_PSRAW,
 		MMX_PSRAD,
@@ -2008,9 +2004,9 @@
 	NULL,
 	NULL,
 	NULL,
+	NULL,		
 	NULL,
 	NULL,
-	NULL,
 	NULL,		/* 08 */
 	NULL,
 	NULL,
@@ -2130,10 +2126,10 @@
 	SSE2_PCMPEQW,
 	SSE2_PCMPEQD,
 	NULL,
-	SSE4a_EXTRQimm,		/* 78 */
-	SSE4a_EXTRQxmm,
+	NULL,		/* 78 */
 	NULL,
 	NULL,
+	NULL,
 	SSE3_HADDPD,
 	SSE3_HSUBPD,
 	SSE2_MOVDxmm2rm,
@@ -2179,8 +2175,8 @@
 	NULL,
 	NULL,
 	NULL,
-	NULL,
-	NULL,
+	NULL,		
+	NULL,		
 	NULL,		/* A8 */
 	NULL,
 	NULL,
@@ -2282,9 +2278,9 @@
 	NULL,
 	NULL,
 	NULL,
+	NULL,		
 	NULL,
 	NULL,
-	NULL,
 	NULL,		/* 08 */
 	NULL,
 	NULL,
@@ -2322,7 +2318,7 @@
 	NULL,		/* 28 */
 	NULL,
 	SSE2_CVTSI2SD,
-	SSE4a_MOVNTSD,
+	NULL,
 	SSE2_CVTTSD2SI,
 	SSE2_CVTSD2SI,
 	NULL,
@@ -2404,10 +2400,10 @@
 	NULL,
 	NULL,
 	NULL,
-	SSE4a_INSERTQimm,		/* 78 */
-	SSE4a_INSERTQxmm,
+	NULL,		/* 78 */
 	NULL,
 	NULL,
+	NULL,
 	SSE3_HADDPS,
 	SSE3_HSUBPS,
 	NULL,
@@ -2453,8 +2449,8 @@
 	NULL,
 	NULL,
 	NULL,
-	NULL,
-	NULL,
+	NULL,		
+	NULL,		
 	NULL,		/* A8 */
 	NULL,
 	NULL,
@@ -2556,9 +2552,9 @@
 	NULL,
 	NULL,
 	NULL,
+	NULL,		
 	NULL,
 	NULL,
-	NULL,
 	NULL,		/* 08 */
 	NULL,
 	NULL,
@@ -2596,7 +2592,7 @@
 	NULL,		/* 28 */
 	NULL,
 	SSE_CVTSI2SS,
-	SSE4a_MOVNTSS,
+	NULL,
 	SSE_CVTTSS2SI,
 	SSE_CVTSS2SI,
 	NULL,
@@ -2727,8 +2723,8 @@
 	NULL,
 	NULL,
 	NULL,
-	NULL,
-	NULL,
+	NULL,		
+	NULL,		
 	NULL,		/* A8 */
 	NULL,
 	NULL,
@@ -2824,1569 +2820,14 @@
 	NULL,
 };
 
-void (*insttable_2byte0F38_32[256])(void) = {
-	SSSE3_PSHUFB_MM,		/* 00 */
-	SSSE3_PHADDW_MM,
-	SSSE3_PHADDD_MM,
-	SSSE3_PHADDSW_MM,
-	SSSE3_PMADDUBSW_MM,
-	SSSE3_PHSUBW_MM,
-	SSSE3_PHSUBD_MM,
-	SSSE3_PHSUBSW_MM,
-	SSSE3_PSIGNB_MM,		/* 08 */
-	SSSE3_PSIGNW_MM,
-	SSSE3_PSIGND_MM,
-	SSSE3_PMULHRSW_MM,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,		/* 10 */
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,		/* 18 */
-	NULL,
-	NULL,
-	NULL,
-	SSSE3_PABSB_MM,
-	SSSE3_PABSW_MM,
-	SSSE3_PABSD_MM,
-	NULL,
-	NULL,		/* 20 */
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,		/* 28 */
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,		/* 30 */
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,		/* 38 */
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,		/* 40 */
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,		/* 48 */
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,		/* 50 */
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,		/* 58 */
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,		/* 60 */
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,		/* 68 */
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,		/* 70 */
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,		/* 78 */
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,		/* 80 */
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,		/* 88 */
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,		/* 90 */
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,		/* 98 */
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,		/* A0 */
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,		/* A8 */
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,		/* B0 */
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,		/* B8 */
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,		/* C0 */
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,		/* C8 */
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,		/* D0 */
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,		/* D8 */
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,		/* E0 */
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,		/* E8 */
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,		/* F0 */
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,		/* F8 */
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL
-};
 
-void (*insttable_3byte660F38_32[256])(void) = {
-	SSSE3_PSHUFB,		/* 00 */
-	SSSE3_PHADDW,
-	SSSE3_PHADDD,
-	SSSE3_PHADDSW,
-	SSSE3_PMADDUBSW,
-	SSSE3_PHSUBW,
-	SSSE3_PHSUBD,
-	SSSE3_PHSUBSW,
-	SSSE3_PSIGNB,		/* 08 */
-	SSSE3_PSIGNW,
-	SSSE3_PSIGND,
-	SSSE3_PMULHRSW,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	SSE4_1_PBLENDVB,		/* 10 */
-	NULL,
-	NULL,
-	NULL,
-	SSE4_1_BLENDVPS,
-	SSE4_1_BLENDVPD,
-	NULL,
-	SSE4_1_VPTEST,
-	NULL,		/* 18 */
-	NULL,
-	NULL,
-	NULL,
-	SSSE3_PABSB,
-	SSSE3_PABSW,
-	SSSE3_PABSD,
-	NULL,
-	SSE4_1_PMOVSXBW,		/* 20 */
-	SSE4_1_PMOVSXBD,
-	SSE4_1_PMOVSXBQ,
-	SSE4_1_PMOVSXWD,
-	SSE4_1_PMOVSXWQ,
-	SSE4_1_PMOVSXDQ,
-	NULL,
-	NULL,
-	SSE4_1_PMULDQ,		/* 28 */
-	SSE4_1_PCMPEQQ,
-	SSE4_1_MOVNTDQA,
-	SSE4_1_PACKUSDW,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	SSE4_1_PMOVZXBW,		/* 30 */
-	SSE4_1_PMOVZXBD,
-	SSE4_1_PMOVZXBQ,
-	SSE4_1_PMOVZXWD,
-	SSE4_1_PMOVZXWQ,
-	SSE4_1_PMOVZXDQ,
-	NULL,
-	SSE4_2_PCMPGTQ,
-	SSE4_1_PMINSB,		/* 38 */
-	SSE4_1_PMINSD,
-	SSE4_1_PMINUW,
-	SSE4_1_PMINUD,
-	SSE4_1_PMAXSB,
-	SSE4_1_PMAXSD,
-	SSE4_1_PMAXUW,
-	SSE4_1_PMAXUD,
-	SSE4_1_PMULLD,		/* 40 */
-	SSE4_1_PHMINPOSUW,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,		/* 48 */
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,		/* 50 */
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,		/* 58 */
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,		/* 60 */
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,		/* 68 */
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,		/* 70 */
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,		/* 78 */
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,		/* 80 */
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,		/* 88 */
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,		/* 90 */
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,		/* 98 */
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,		/* A0 */
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,		/* A8 */
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,		/* B0 */
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,		/* B8 */
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,		/* C0 */
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,		/* C8 */
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,		/* D0 */
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,		/* D8 */
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,		/* E0 */
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,		/* E8 */
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,		/* F0 */
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,		/* F8 */
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL
-};
 
-void (*insttable_2byte0F3A_32[256])(void) = {
-	NULL,		/* 00 */
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,		/* 08 */
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	SSSE3_PALIGNR_MM,
-	NULL,		/* 10 */
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,		/* 18 */
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,		/* 20 */
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,		/* 28 */
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,		/* 30 */
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,		/* 38 */
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,		/* 40 */
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,		/* 48 */
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,		/* 50 */
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,		/* 58 */
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,		/* 60 */
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,		/* 68 */
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,		/* 70 */
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,		/* 78 */
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,		/* 80 */
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,		/* 88 */
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,		/* 90 */
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,		/* 98 */
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,		/* A0 */
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,		/* A8 */
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,		/* B0 */
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,		/* B8 */
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,		/* C0 */
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,		/* C8 */
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,		/* D0 */
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,		/* D8 */
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,		/* E0 */
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,		/* E8 */
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,		/* F0 */
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,		/* F8 */
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL
-};
-
-void (*insttable_3byte660F3A_32[256])(void) = {
-	NULL,		/* 00 */
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	SSE4_1_ROUNDPS,		/* 08 */
-	SSE4_1_ROUNDPD,
-	SSE4_1_ROUNDSS,
-	SSE4_1_ROUNDSD,
-	SSE4_1_PBLENDPS,
-	SSE4_1_PBLENDPD,
-	SSE4_1_PBLENDW,
-	SSSE3_PALIGNR,
-	NULL,		/* 10 */
-	NULL,
-	NULL,
-	NULL,
-	SSE4_1_PEXTRB,
-	SSE4_1_PEXTRW,
-	SSE4_1_PEXTRD,
-	SSE4_1_PEXTRACTPS,
-	NULL,		/* 18 */
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	SSE4_1_PINSRB,		/* 20 */
-	SSE4_1_INSERTPS,
-	SSE4_1_PINSRD,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,		/* 28 */
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,		/* 30 */
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,		/* 38 */
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	SSE4_1_DPPS,		/* 40 */
-	SSE4_1_DPPD,
-	SSE4_1_MPSADBW,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,		/* 48 */
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,		/* 50 */
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,		/* 58 */
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	SSE4_2_PCMPESTRM,		/* 60 */
-	SSE4_2_PCMPESTRI,
-	SSE4_2_PCMPISTRM,
-	SSE4_2_PCMPISTRI,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,		/* 68 */
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,		/* 70 */
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,		/* 78 */
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,		/* 80 */
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,		/* 88 */
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,		/* 90 */
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,		/* 98 */
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,		/* A0 */
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,		/* A8 */
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,		/* B0 */
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,		/* B8 */
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,		/* C0 */
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,		/* C8 */
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,		/* D0 */
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,		/* D8 */
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,		/* E0 */
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,		/* E8 */
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,		/* F0 */
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,		/* F8 */
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL
-};
-
-void (*insttable_3byteF20F38_32[256])(void) = {
-	NULL,		/* 00 */
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,		/* 08 */
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,		/* 10 */
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,		/* 18 */
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,		/* 20 */
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,		/* 28 */
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,		/* 30 */
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,		/* 38 */
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,		/* 40 */
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,		/* 48 */
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,		/* 50 */
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,		/* 58 */
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,		/* 60 */
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,		/* 68 */
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,		/* 70 */
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,		/* 78 */
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,		/* 80 */
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,		/* 88 */
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,		/* 90 */
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,		/* 98 */
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,		/* A0 */
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,		/* A8 */
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,		/* B0 */
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	SSE4_2_POPCNT_32,		/* B8 */
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,		/* C0 */
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,		/* C8 */
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,		/* D0 */
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,		/* D8 */
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,		/* E0 */
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,		/* E8 */
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	SSE4_2_CRC32_Gy_Eb,		/* F0 */
-	SSE4_2_CRC32_Gy_Ev,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,		/* F8 */
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL
-};
-
-
-void (*insttable_3byteF20F38_16[256])(void) = {
-	NULL,		/* 00 */
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,		/* 08 */
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,		/* 10 */
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,		/* 18 */
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,		/* 20 */
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,		/* 28 */
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,		/* 30 */
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,		/* 38 */
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,		/* 40 */
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,		/* 48 */
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,		/* 50 */
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,		/* 58 */
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,		/* 60 */
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,		/* 68 */
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,		/* 70 */
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,		/* 78 */
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,		/* 80 */
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,		/* 88 */
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,		/* 90 */
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,		/* 98 */
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,		/* A0 */
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,		/* A8 */
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,		/* B0 */
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	SSE4_2_POPCNT_16,		/* B8 */
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,		/* C0 */
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,		/* C8 */
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,		/* D0 */
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,		/* D8 */
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,		/* E0 */
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,		/* E8 */
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	SSE4_2_CRC32_Gy_Eb_16,		/* F0 */
-	SSE4_2_CRC32_Gy_Ev_16,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,		/* F8 */
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL
-};
-
-
-
 /*
  * for group
  */
 
- /* group 1 */
-void (CPUCALL* insttable_G1EbIb[])(UINT8*, UINT32) = {
+/* group 1 */
+void (CPUCALL *insttable_G1EbIb[])(UINT8 *, UINT32) = {
 	ADD_EbIb,
 	OR_EbIb,
 	ADC_EbIb,
@@ -4396,7 +2837,7 @@
 	XOR_EbIb,
 	CMP_EbIb,
 };
-void (CPUCALL* insttable_G1EbIb_ext[])(UINT32, UINT32) = {
+void (CPUCALL *insttable_G1EbIb_ext[])(UINT32, UINT32) = {
 	ADD_EbIb_ext,
 	OR_EbIb_ext,
 	ADC_EbIb_ext,
@@ -4407,7 +2848,7 @@
 	CMP_EbIb_ext,
 };
 
-void (CPUCALL* insttable_G1EwIx[])(UINT16*, UINT32) = {
+void (CPUCALL *insttable_G1EwIx[])(UINT16 *, UINT32) = {
 	ADD_EwIx,
 	OR_EwIx,
 	ADC_EwIx,
@@ -4417,7 +2858,7 @@
 	XOR_EwIx,
 	CMP_EwIx,
 };
-void (CPUCALL* insttable_G1EwIx_ext[])(UINT32, UINT32) = {
+void (CPUCALL *insttable_G1EwIx_ext[])(UINT32, UINT32) = {
 	ADD_EwIx_ext,
 	OR_EwIx_ext,
 	ADC_EwIx_ext,
@@ -4428,7 +2869,7 @@
 	CMP_EwIx_ext,
 };
 
-void (CPUCALL* insttable_G1EdIx[])(UINT32*, UINT32) = {
+void (CPUCALL *insttable_G1EdIx[])(UINT32 *, UINT32) = {
 	ADD_EdIx,
 	OR_EdIx,
 	ADC_EdIx,
@@ -4438,7 +2879,7 @@
 	XOR_EdIx,
 	CMP_EdIx,
 };
-void (CPUCALL* insttable_G1EdIx_ext[])(UINT32, UINT32) = {
+void (CPUCALL *insttable_G1EdIx_ext[])(UINT32, UINT32) = {
 	ADD_EdIx_ext,
 	OR_EdIx_ext,
 	ADC_EdIx_ext,
@@ -4451,7 +2892,7 @@
 
 
 /* group 2 */
-void (CPUCALL* insttable_G2Eb[])(UINT8*) = {
+void (CPUCALL *insttable_G2Eb[])(UINT8 *) = {
 	ROL_Eb,
 	ROR_Eb,
 	RCL_Eb,
@@ -4461,7 +2902,7 @@
 	SHL_Eb,
 	SAR_Eb,
 };
-void (CPUCALL* insttable_G2Eb_ext[])(UINT32) = {
+void (CPUCALL *insttable_G2Eb_ext[])(UINT32) = {
 	ROL_Eb_ext,
 	ROR_Eb_ext,
 	RCL_Eb_ext,
@@ -4472,7 +2913,7 @@
 	SAR_Eb_ext,
 };
 
-void (CPUCALL* insttable_G2Ew[])(UINT16*) = {
+void (CPUCALL *insttable_G2Ew[])(UINT16 *) = {
 	ROL_Ew,
 	ROR_Ew,
 	RCL_Ew,
@@ -4482,7 +2923,7 @@
 	SHL_Ew,
 	SAR_Ew,
 };
-void (CPUCALL* insttable_G2Ew_ext[])(UINT32) = {
+void (CPUCALL *insttable_G2Ew_ext[])(UINT32) = {
 	ROL_Ew_ext,
 	ROR_Ew_ext,
 	RCL_Ew_ext,
@@ -4493,7 +2934,7 @@
 	SAR_Ew_ext,
 };
 
-void (CPUCALL* insttable_G2Ed[])(UINT32*) = {
+void (CPUCALL *insttable_G2Ed[])(UINT32 *) = {
 	ROL_Ed,
 	ROR_Ed,
 	RCL_Ed,
@@ -4503,7 +2944,7 @@
 	SHL_Ed,
 	SAR_Ed,
 };
-void (CPUCALL* insttable_G2Ed_ext[])(UINT32) = {
+void (CPUCALL *insttable_G2Ed_ext[])(UINT32) = {
 	ROL_Ed_ext,
 	ROR_Ed_ext,
 	RCL_Ed_ext,
@@ -4514,7 +2955,7 @@
 	SAR_Ed_ext,
 };
 
-void (CPUCALL* insttable_G2EbCL[])(UINT8*, UINT) = {
+void (CPUCALL *insttable_G2EbCL[])(UINT8 *, UINT) = {
 	ROL_EbCL,
 	ROR_EbCL,
 	RCL_EbCL,
@@ -4524,7 +2965,7 @@
 	SHL_EbCL,
 	SAR_EbCL,
 };
-void (CPUCALL* insttable_G2EbCL_ext[])(UINT32, UINT) = {
+void (CPUCALL *insttable_G2EbCL_ext[])(UINT32, UINT) = {
 	ROL_EbCL_ext,
 	ROR_EbCL_ext,
 	RCL_EbCL_ext,
@@ -4535,7 +2976,7 @@
 	SAR_EbCL_ext,
 };
 
-void (CPUCALL* insttable_G2EwCL[])(UINT16*, UINT) = {
+void (CPUCALL *insttable_G2EwCL[])(UINT16 *, UINT) = {
 	ROL_EwCL,
 	ROR_EwCL,
 	RCL_EwCL,
@@ -4545,7 +2986,7 @@
 	SHL_EwCL,
 	SAR_EwCL,
 };
-void (CPUCALL* insttable_G2EwCL_ext[])(UINT32, UINT) = {
+void (CPUCALL *insttable_G2EwCL_ext[])(UINT32, UINT) = {
 	ROL_EwCL_ext,
 	ROR_EwCL_ext,
 	RCL_EwCL_ext,
@@ -4556,7 +2997,7 @@
 	SAR_EwCL_ext,
 };
 
-void (CPUCALL* insttable_G2EdCL[])(UINT32*, UINT) = {
+void (CPUCALL *insttable_G2EdCL[])(UINT32 *, UINT) = {
 	ROL_EdCL,
 	ROR_EdCL,
 	RCL_EdCL,
@@ -4566,7 +3007,7 @@
 	SHL_EdCL,
 	SAR_EdCL,
 };
-void (CPUCALL* insttable_G2EdCL_ext[])(UINT32, UINT) = {
+void (CPUCALL *insttable_G2EdCL_ext[])(UINT32, UINT) = {
 	ROL_EdCL_ext,
 	ROR_EdCL_ext,
 	RCL_EdCL_ext,
@@ -4578,7 +3019,7 @@
 };
 
 /* group 3 */
-void (CPUCALL* insttable_G3Eb[])(UINT32) = {
+void (CPUCALL *insttable_G3Eb[])(UINT32) = {
 	TEST_EbIb,
 	TEST_EbIb,
 	NOT_Eb,
@@ -4589,7 +3030,7 @@
 	IDIV_ALEb,
 };
 
-void (CPUCALL* insttable_G3Ew[])(UINT32) = {
+void (CPUCALL *insttable_G3Ew[])(UINT32) = {
 	TEST_EwIw,
 	TEST_EwIw,
 	NOT_Ew,
@@ -4600,7 +3041,7 @@
 	IDIV_AXEw,
 };
 
-void (CPUCALL* insttable_G3Ed[])(UINT32) = {
+void (CPUCALL *insttable_G3Ed[])(UINT32) = {
 	TEST_EdId,
 	TEST_EdId,
 	NOT_Ed,
@@ -4612,7 +3053,7 @@
 };
 
 /* group 4 */
-void (CPUCALL* insttable_G4[])(UINT32) = {
+void (CPUCALL *insttable_G4[])(UINT32) = {
 	INC_Eb,
 	DEC_Eb,
 	undef_op2,
@@ -4624,7 +3065,7 @@
 };
 
 /* group 5 */
-void (CPUCALL* insttable_G5Ew[])(UINT32) = {
+void (CPUCALL *insttable_G5Ew[])(UINT32) = {
 	INC_Ew,
 	DEC_Ew,
 	CALL_Ew,
@@ -4635,7 +3076,7 @@
 	undef_op2,	/* POP_Ew_G5 */
 };
 
-void (CPUCALL* insttable_G5Ed[])(UINT32) = {
+void (CPUCALL *insttable_G5Ed[])(UINT32) = {
 	INC_Ed,
 	DEC_Ed,
 	CALL_Ed,
@@ -4647,7 +3088,7 @@
 };
 
 /* group 6 */
-void (CPUCALL* insttable_G6[])(UINT32) = {
+void (CPUCALL *insttable_G6[])(UINT32) = {
 	SLDT_Ew,
 	STR_Ew,
 	LLDT_Ew,
@@ -4659,7 +3100,7 @@
 };
 
 /* group 7 */
-void (CPUCALL* insttable_G7[])(UINT32) = {
+void (CPUCALL *insttable_G7[])(UINT32) = {
 	SGDT_Ms,
 	SIDT_Ms,
 	LGDT_Ms,
@@ -4671,7 +3112,7 @@
 };
 
 /* group 8 */
-void (CPUCALL* insttable_G8EwIb[])(UINT32) = {
+void (CPUCALL *insttable_G8EwIb[])(UINT32) = {
 	undef_op2,
 	undef_op2,
 	undef_op2,
@@ -4682,7 +3123,7 @@
 	BTC_EwIb,
 };
 
-void (CPUCALL* insttable_G8EdIb[])(UINT32) = {
+void (CPUCALL *insttable_G8EdIb[])(UINT32) = {
 	undef_op2,
 	undef_op2,
 	undef_op2,
@@ -4694,7 +3135,7 @@
 };
 
 /* group 9 */
-void (CPUCALL* insttable_G9[])(UINT32) = {
+void (CPUCALL *insttable_G9[])(UINT32) = {
 	undef_op2,
 	CMPXCHG8B,
 	undef_op2,
diff -ruN source/src/vm/np21/i386c/ia32/inst_table.h src/vm/np21/i386c/ia32/inst_table.h
--- source/src/vm/np21/i386c/ia32/inst_table.h	2025-04-28 16:00:00
+++ src/vm/np21/i386c/ia32/inst_table.h	2025-04-28 22:36:36
@@ -42,13 +42,6 @@
 extern void (*insttable_2byteF20F_32[256])(void);
 extern void (*insttable_2byteF30F_32[256])(void);
 
-extern void (*insttable_2byte0F38_32[256])(void);
-extern void (*insttable_3byte660F38_32[256])(void);
-extern void (*insttable_2byte0F3A_32[256])(void);
-extern void (*insttable_3byte660F3A_32[256])(void);
-extern void (*insttable_3byteF20F38_32[256])(void);
-extern void (*insttable_3byteF20F38_16[256])(void);
-
 /*
  * for group
  */
diff -ruN source/src/vm/np21/i386c/ia32/instructions/fpu/fpemul_softfloat.cpp src/vm/np21/i386c/ia32/instructions/fpu/fpemul_softfloat.cpp
--- source/src/vm/np21/i386c/ia32/instructions/fpu/fpemul_softfloat.cpp	2025-04-28 16:00:00
+++ src/vm/np21/i386c/ia32/instructions/fpu/fpemul_softfloat.cpp	2025-04-28 22:36:36
@@ -1,22 +1,4 @@
 /*
- *  Copyright (C) 2002-2015  The DOSBox Team
- *
- *  This program is free software; you can redistribute it and/or modify
- *  it under the terms of the GNU General Public License as published by
- *  the Free Software Foundation; either version 2 of the License, or
- *  (at your option) any later version.
- *
- *  This program is distributed in the hope that it will be useful,
- *  but WITHOUT ANY WARRANTY; without even the implied warranty of
- *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
- *  GNU General Public License for more details.
- *
- *  You should have received a copy of the GNU General Public License
- *  along with this program; if not, write to the Free Software
- *  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.
- */
-
-/*
  * Copyright (c) 2012 NONAKA Kimihiro
  * All rights reserved.
  *
@@ -60,86 +42,62 @@
 #include "../sse/sse.h"
 #endif
 
-#if 1
-#undef	TRACEOUT
-#define	TRACEOUT(s)	(void)(s)
-#endif	/* 0 */
+ /*
+ Short Real
+	31: sign (ïÑçÜ)
+ 30-23: exp-8 (éwêîïî: exponet)
+ 22-00: num-23 (è¨êîïî)
 
-#define FPU_WORKCLOCK	6
+ Long Real
+	63: sign
+ 62-52: exp-11
+ 51-00: num-52
 
-#define PI		3.14159265358979323846
-#define L2E		1.4426950408889634
-#define L2T		3.3219280948873623
-#define LN2		0.69314718055994531
-#define LG2		0.3010299956639812
+ Temp Real
+	79: sign
+ 78-64: exp-15
+	63: 1(?)
+ 62-00: num-63
 
-static void FPU_FINIT(void);
+ --
+ éwêîïî:
+ 2 ÇÃ 0 èÊÇÃÇ∆Ç´ 0111 1111 Ç∆Ç»ÇÈ
+ 1000 0001: +2 èÊ
+ 1000 0000: +1 èÊ
+ 0111 1111:  0 èÊ
+ 0111 1110: -1 èÊ
 
-static void
-fpu_check_NM_EXCEPTION(){
-	// É^ÉXÉNÉXÉCÉbÉ`Ç‹ÇΩÇÕÉGÉ~ÉÖÉåÅ[ÉVÉáÉìéûÇ…NM(ÉfÉoÉCÉXégópïsâ¬ó·äO)Çî≠ê∂Ç≥ÇπÇÈ
-	if ((CPU_CR0 & (CPU_CR0_TS)) || (CPU_CR0 & CPU_CR0_EM)) {
-		EXCEPTION(NM_EXCEPTION, 0);
-	}
-}
-static void
-fpu_check_NM_EXCEPTION2(){
-	// É^ÉXÉNÉXÉCÉbÉ`Ç‹ÇΩÇÕÉGÉ~ÉÖÉåÅ[ÉVÉáÉìéûÇ…NM(ÉfÉoÉCÉXégópïsâ¬ó·äO)Çî≠ê∂Ç≥ÇπÇÈ
-	if ((CPU_CR0 & (CPU_CR0_TS)) || (CPU_CR0 & CPU_CR0_EM)) {
-		EXCEPTION(NM_EXCEPTION, 0);
-	}
-}
+ âºêîïî:
+ 2 ÇäÓêîÇ∆ÇµÇƒêÆêîïîÇ™àÍåÖÇ…Ç»ÇÈÇÊÇ§Ç…ê≥ãKâªÇµÇΩêîÇÃ 2 êiêîï\åªÇ∆Ç»ÇÈÅB
+ ê≥ãKâªÇ…ÇÊÇ¡ÇƒâºêîïîÇÃç≈è„à ÉrÉbÉgÇÕèÌÇ… 1 Ç…Ç»ÇÈÇÃÇ≈é¿ç€Ç…ópà”ÇµÇƒÇ®Ç≠
+ ïKóvÇÕÇ»Ç≠ÅAî{ê∏ìxÇÃ 52 ÉrÉbÉgÇ≈Ç†ÇÍÇŒç≈è„à ÇÃ 1 Ç hidden bit Ç…ÇµÇƒ
+ ä‹ÇﬂÇ»ÇØÇÍÇŒÅA53 ÉrÉbÉgï™ÇÃèÓïÒÇ™ä‹Ç‹ÇÍÇÈÇ±Ç∆Ç…Ç»ÇÈÅB
 
-static const FPU_PTR zero_ptr = { 0, 0, 0 };
-
-/*
- * FPU interface
+ è¨êîÇÃìÒêiêîï\åª:
+ 0.1000    1/2         = 0.5
+ 0.0100    1/(2*2)     = 0.25
+ 0.0010    1/(2*2*2)   = 0.125
+ 0.0001    1/(2*2*2*2) = 0.0625
  */
- 
-static INLINE UINT FPU_GET_TOP(void) {
-	return (FPU_STATUSWORD & 0x3800)>>11;
-}
 
-static INLINE void FPU_SET_TOP(UINT val){
-	FPU_STATUSWORD &= ~0x3800;
-	FPU_STATUSWORD |= (val&7)<<11;
-}
+#if 1
+#undef	TRACEOUT
+#define	TRACEOUT(s)	(void)(s)
+#endif	/* 0 */
 
+#define FPU_WORKCLOCK	6
 
-static INLINE void FPU_SET_C0(UINT C){
-	FPU_STATUSWORD &= ~0x0100;
-	if(C) FPU_STATUSWORD |=  0x0100;
-}
+#define PI		3.1415926535897932384626433832795
+#define L2E		1.4426950408889634073599246810019
+#define L2T		3.3219280948873623478703194294894
+#define LN2		0.6931471805599453094172321214582
+#define LG2		0.3010299956639811952137388947245
 
-static INLINE void FPU_SET_C1(UINT C){
-	FPU_STATUSWORD &= ~0x0200;
-	if(C) FPU_STATUSWORD |=  0x0200;
-}
-
-static INLINE void FPU_SET_C2(UINT C){
-	FPU_STATUSWORD &= ~0x0400;
-	if(C) FPU_STATUSWORD |=  0x0400;
-}
-
-static INLINE void FPU_SET_C3(UINT C){
-	FPU_STATUSWORD &= ~0x4000;
-	if(C) FPU_STATUSWORD |= 0x4000;
-}
-
-static INLINE void FPU_SET_D(UINT C){
-	FPU_STATUSWORD &= ~0x0002;
-	if(C) FPU_STATUSWORD |= 0x0002;
-}
-
 static INLINE void FPU_SetCW(UINT16 cword)
 {
-	// HACK: Bits 13-15 are not defined. Apparently, one program likes to test for
-	// Cyrix EMC87 by trying to set bit 15. We want the test program to see
-	// us as an Intel 287 when cputype == 286.
-	cword &= 0x7FFF;
-	FPU_CTRLWORD = cword;
+	FPU_CTRLWORD = cword & 0x7FFF;
 	FPU_STAT.round = (FP_RND)((cword >> 10) & 3);
-	switch(FPU_STAT.round){
+	switch (FPU_STAT.round) {
 	case ROUND_Nearest:
 		float_rounding_mode = float_round_nearest_even;
 		break;
@@ -157,776 +115,736 @@
 	}
 }
 
-static void FPU_FLDCW(UINT32 addr)
-{
-	UINT16 temp = cpu_vmemoryread_w(CPU_INST_SEGREG_INDEX, addr);
-	FPU_SetCW(temp);
-}
+/*
+ * FPU exception
+ */
 
-static UINT16 FPU_GetTag(void)
-{
-	UINT i;
-	
-	UINT16 tag=0;
-	for(i=0;i<8;i++)
-		tag |= ( (FPU_STAT.tag[i]&3) <<(2*i));
-	return tag;
-}
-static UINT8 FPU_GetTag8(void)
-{
-	UINT i;
-	
-	UINT8 tag=0;
-	for(i=0;i<8;i++)
-		tag |= ( (FPU_STAT.tag[i]==TAG_Empty ? 0 : 1) <<(i));
-	return tag;
-}
-
-static INLINE void FPU_SetTag(UINT16 tag)
-{
-	UINT i;
-	
-	for(i=0;i<8;i++){
-		FPU_STAT.tag[i] = (FP_TAG)((tag >>(2*i))&3);
-
+static void
+fpu_check_NM_EXCEPTION(){
+	// É^ÉXÉNÉXÉCÉbÉ`Ç‹ÇΩÇÕÉGÉ~ÉÖÉåÅ[ÉVÉáÉìéûÇ…NM(ÉfÉoÉCÉXégópïsâ¬ó·äO)Çî≠ê∂Ç≥ÇπÇÈ
+	if ((CPU_CR0 & (CPU_CR0_TS)) || (CPU_CR0 & CPU_CR0_EM)) {
+		EXCEPTION(NM_EXCEPTION, 0);
 	}
 }
-static INLINE void FPU_SetTag8(UINT8 tag)
-{
-	UINT i;
-	
-	for(i=0;i<8;i++){
-		FPU_STAT.tag[i] = (((tag>>i)&1) == 0 ? TAG_Empty : TAG_Valid);
+static void
+fpu_check_NM_EXCEPTION2(){
+	// É^ÉXÉNÉXÉCÉbÉ`Ç‹ÇΩÇÕÉGÉ~ÉÖÉåÅ[ÉVÉáÉìéûÇ…NM(ÉfÉoÉCÉXégópïsâ¬ó·äO)Çî≠ê∂Ç≥ÇπÇÈ
+	if ((CPU_CR0 & (CPU_CR0_TS)) || (CPU_CR0 & CPU_CR0_EM)) {
+		EXCEPTION(NM_EXCEPTION, 0);
 	}
 }
 
-static void FPU_FCLEX(void){
-	//FPU_STATUSWORD &= 0xff00;			//should clear exceptions
-	FPU_STATUSWORD &= 0x7f00;			//should clear exceptions?
+static void fpu_checkexception() {
+	if ((FPU_STATUSWORD & ~FPU_CTRLWORD) & 0x3F) {
+		EXCEPTION(MF_EXCEPTION, 0);
+	}
 }
 
-static void FPU_FNOP(void){
-	return;
-}
 
-static void FPU_PUSH(floatx80 in){
-	FPU_STAT_TOP = (FPU_STAT_TOP - 1) & 7;
-	//actually check if empty
-	FPU_STAT.tag[FPU_STAT_TOP] = TAG_Valid;
-	FPU_STAT.reg[FPU_STAT_TOP].d = in;
-//	LOG(LOG_FPU,LOG_ERROR)("Pushed at %d  %g to the stack",newtop,in);
-	return;
-}
+/*
+ * FPU memory access function
+ */
 
-static void FPU_PREP_PUSH(void){
-	FPU_SET_C1(FPU_STAT_TOP == 0 ? 1 : 0);
-	FPU_STAT_TOP = (FPU_STAT_TOP - 1) & 7;
-	FPU_STAT.tag[FPU_STAT_TOP] = TAG_Valid;
-}
-
-static void FPU_FPOP(void){
-	FPU_STAT.tag[FPU_STAT_TOP] = TAG_Empty;
-	FPU_STAT.mmxenable = 0;
-	//maybe set zero in it as well
-	FPU_STAT_TOP = ((FPU_STAT_TOP+1)&7);
-//	LOG(LOG_FPU,LOG_ERROR)("popped from %d  %g off the stack",top,fpu.regs[top].d);
-	return;
-}
-
-static floatx80 FROUND(floatx80 in){
-	return floatx80_round_to_int(in);
-}
-
-#define BIAS80 16383
-#define BIAS64 1023
-
-static void FPU_FLD80(UINT32 addr, UINT reg) 
+static void FPU_FLD80(UINT32 addr, UINT reg)
 {
-	FPU_STAT.reg[reg].ul.lower = fpu_memoryread_d(addr);
-	FPU_STAT.reg[reg].ul.upper = fpu_memoryread_d(addr+4);
-	FPU_STAT.reg[reg].ul.ext = fpu_memoryread_w(addr+8);
+	*((REG80*)FPU_STAT.reg[reg].b) = fpu_memoryread_f(addr);
 }
 
-static void FPU_ST80(UINT32 addr,UINT reg) 
-{
-	fpu_memorywrite_d(addr,FPU_STAT.reg[reg].ul.lower);
-	fpu_memorywrite_d(addr+4,FPU_STAT.reg[reg].ul.upper);
-	fpu_memorywrite_w(addr+8,FPU_STAT.reg[reg].ul.ext);
+static void FPU_FLD_F32(UINT32 addr, UINT reg) {
+	FPU_STAT.reg[reg].d = c_float_to_floatx80(fpu_memoryread_f32(addr));
 }
 
-
-static void FPU_FLD_F32(UINT32 addr,UINT store_to) {
-	union {
-		float f;
-		UINT32 l;
-	}	blah;
-	
-	blah.l = fpu_memoryread_d(addr);
-	FPU_STAT.reg[store_to].d = c_float_to_floatx80(blah.f);
+static void FPU_FLD_F64(UINT32 addr, UINT reg) {
+	FPU_STAT.reg[reg].d = c_double_to_floatx80(fpu_memoryread_f64(addr));
 }
 
-static void FPU_FLD_F64(UINT32 addr,UINT store_to) {
-	union {
-		double d;
-		UINT64 l;
-	}	blah;
-	blah.l = fpu_memoryread_q(addr);
-	FPU_STAT.reg[store_to].d = c_double_to_floatx80(blah.d);
-}
-
 static void FPU_FLD_F80(UINT32 addr) {
 	FPU_FLD80(addr, FPU_STAT_TOP);
 }
 
-static void FPU_FLD_I16(UINT32 addr,UINT store_to) {
-	SINT16 blah;
-
-	blah = fpu_memoryread_w(addr);
-	FPU_STAT.reg[store_to].d = int32_to_floatx80((SINT32)blah);
+static void FPU_FLD_I16(UINT32 addr, UINT reg) {
+	FPU_STAT.reg[reg].d = int32_to_floatx80((SINT32)((SINT16)fpu_memoryread_w(addr)));
 }
 
-static void FPU_FLD_I32(UINT32 addr,UINT store_to) {
-	SINT32 blah;
-
-	blah = fpu_memoryread_d(addr);
-	FPU_STAT.reg[store_to].d = int32_to_floatx80(blah);
+static void FPU_FLD_I32(UINT32 addr, UINT reg) {
+	FPU_STAT.reg[reg].d = int32_to_floatx80((SINT32)fpu_memoryread_d(addr));
 }
 
-static void FPU_FLD_I64(UINT32 addr,UINT store_to) {
-	SINT64 blah;
-	
-	blah = fpu_memoryread_q(addr);
-	FPU_STAT.reg[store_to].d = int64_to_floatx80(blah);
+static void FPU_FLD_I64(UINT32 addr, UINT reg) {
+	FPU_STAT.reg[reg].d = int64_to_floatx80((SINT64)fpu_memoryread_q(addr));
 }
 
-static void FPU_FBLD(UINT32 addr,UINT store_to) 
+static void FPU_FBLD(UINT32 addr, UINT reg)
 {
-	UINT i;
-	floatx80 temp;
-	
-	UINT64 val = 0;
-	UINT in = 0;
-	UINT64 base = 1;
-	for(i = 0;i < 9;i++){
-		in = fpu_memoryread_b(addr + i);
-		val += ( (in&0xf) * base); //in&0xf shouldn't be higher then 9
-		base *= 10;
-		val += ((( in>>4)&0xf) * base);
-		base *= 10;
+	int i;
+	int tmp;
+
+	REG80 bcdbuf;
+	SINT64 val = 0;
+	UINT8 in = 0;
+
+	// 80bitÇ‹Ç∆ÇﬂÇƒì«Ç›éÊÇË
+	bcdbuf = fpu_memoryread_f(addr);
+
+	// 0Å`8byteñ⁄ÇÃèàóù BCD
+	for (i = 8; i >= 0; i--) {
+		in = bcdbuf.b[i];
+		tmp = ((in >> 4) & 0xf) * 10 + (in & 0xf);
+		val = val * 100 + tmp;
 	}
 
-	//last number, only now convert to float in order to get
-	//the best signification
-	temp = int64_to_floatx80(val);
-	in = fpu_memoryread_b(addr + 9);
-	temp = floatx80_add(temp, int64_to_floatx80((in&0xf) * base));
-	if(in&0x80) temp = floatx80_mul(temp, int32_to_floatx80(-1));
-	FPU_STAT.reg[store_to].d = temp;
+	// 9byteñ⁄ÇÕïÑçÜÇÃÇ›à”ñ°Ç™Ç†ÇÈ
+	if (bcdbuf.b[9] & 0x80) {
+		val = -val;
+	}
+
+	FPU_STAT.reg[reg].d = int64_to_floatx80(val);
 }
 
-
 static INLINE void FPU_FLD_F32_EA(UINT32 addr) {
-	FPU_FLD_F32(addr,8);
+	FPU_FLD_F32(addr, 8);
 }
 static INLINE void FPU_FLD_F64_EA(UINT32 addr) {
-	FPU_FLD_F64(addr,8);
+	FPU_FLD_F64(addr, 8);
 }
 static INLINE void FPU_FLD_I32_EA(UINT32 addr) {
-	FPU_FLD_I32(addr,8);
+	FPU_FLD_I32(addr, 8);
 }
 static INLINE void FPU_FLD_I16_EA(UINT32 addr) {
-	FPU_FLD_I16(addr,8);
+	FPU_FLD_I16(addr, 8);
 }
 
+
+static void FPU_ST80(UINT32 addr, UINT reg)
+{
+	fpu_memorywrite_f(addr, (REG80*)FPU_STAT.reg[reg].b);
+}
+
 static void FPU_FST_F32(UINT32 addr) {
-	union {
-		float f;
-		UINT32 l;
-	}	blah;
-	
-	blah.f = floatx80_to_c_float(FPU_STAT.reg[FPU_STAT_TOP].d);
-	fpu_memorywrite_d(addr,blah.l);
+	fpu_memorywrite_f32(addr, floatx80_to_c_float(FPU_STAT.reg[FPU_STAT_TOP].d));
 }
 
 static void FPU_FST_F64(UINT32 addr) {
-	union {
-		double d;
-		UINT64 l;
-	}	blah;
-
-	blah.d = floatx80_to_c_double(FPU_STAT.reg[FPU_STAT_TOP].d);
-	fpu_memorywrite_q(addr,blah.l);
+	fpu_memorywrite_f64(addr, floatx80_to_c_double(FPU_STAT.reg[FPU_STAT_TOP].d));
 }
 
 static void FPU_FST_F80(UINT32 addr) {
-	FPU_ST80(addr,FPU_STAT_TOP);
+	FPU_ST80(addr, FPU_STAT_TOP);
 }
 
 static void FPU_FST_I16(UINT32 addr) {
-	INT16 blah;
-	
 	float_exception_flags = (FPU_STATUSWORD & 0x3f);
-	blah = (SINT16)floatx80_to_int32(FPU_STAT.reg[FPU_STAT_TOP].d);
-	fpu_memorywrite_w(addr,(UINT16)blah);
+	fpu_memorywrite_w(addr, (UINT16)((SINT16)floatx80_to_int32(FPU_STAT.reg[FPU_STAT_TOP].d)));
 	FPU_STATUSWORD |= float_exception_flags;
 }
 
 static void FPU_FST_I32(UINT32 addr) {
-	INT32 blah;
-	
 	float_exception_flags = (FPU_STATUSWORD & 0x3f);
-	blah = floatx80_to_int32(FPU_STAT.reg[FPU_STAT_TOP].d);
-	fpu_memorywrite_d(addr,blah);
+	fpu_memorywrite_d(addr, (UINT32)floatx80_to_int32(FPU_STAT.reg[FPU_STAT_TOP].d));
 	FPU_STATUSWORD |= float_exception_flags;
 }
 
 static void FPU_FST_I64(UINT32 addr) {
-	INT64 blah;
-	
 	float_exception_flags = (FPU_STATUSWORD & 0x3f);
-	blah = floatx80_to_int64(FPU_STAT.reg[FPU_STAT_TOP].d);
-	fpu_memorywrite_q(addr,blah);
+	fpu_memorywrite_q(addr, (UINT64)floatx80_to_int64(FPU_STAT.reg[FPU_STAT_TOP].d));
 	FPU_STATUSWORD |= float_exception_flags;
 }
 
-static void FPU_FBST(UINT32 addr) 
+static void FPU_FBST(UINT32 addr)
 {
-	FP_REG val;
-	UINT32 p;
+	SINT64 val;
+	REG80 bcdbuf = { 0 };
 	UINT i;
-	BOOL sign;
-	floatx80 temp;
-	floatx80 m1 = int32_to_floatx80(-1);
-	floatx80 p10 = int32_to_floatx80(10);
+
 	signed char oldrnd = float_rounding_mode;
 	float_rounding_mode = float_round_down;
 
-	val = FPU_STAT.reg[FPU_STAT_TOP];
-	sign = FALSE;
-	if(FPU_STAT.reg[FPU_STAT_TOP].l.ext & 0x8000) { //sign
-		sign=TRUE;
-		val.d = floatx80_mul(val.d, m1);
+	val = floatx80_to_int64(FPU_STAT.reg[FPU_STAT_TOP].d);
+
+	// 9byteñ⁄ÇÕïÑçÜÇÃÇ›à”ñ°Ç™Ç†ÇÈ
+	if (val < 0)
+	{
+		bcdbuf.b[9] = 0x80;
+		val = -val;
 	}
-	//numbers from back to front
-	temp = val.d;
-	for(i=0;i<9;i++){
-		val.d = temp;
-		temp = floatx80_round_to_int(floatx80_div(val.d, p10));
-		p = floatx80_to_int32_round_to_zero(floatx80_sub(val.d, floatx80_mul(temp, p10)));  
-		val.d = temp;
-		temp = floatx80_round_to_int(floatx80_div(val.d, p10));
-		p |= (floatx80_to_int32_round_to_zero(floatx80_sub(val.d, floatx80_mul(temp, p10))) << 4);
 
-		fpu_memorywrite_b(addr+i,(UINT8)p);
+	// 0Å`8byteñ⁄ÇÃèàóù BCD
+	for (i = 0; i < 9; i++) {
+		bcdbuf.b[i] = (UINT8)(val % 10);
+		val /= 10;
+		bcdbuf.b[i] |= (UINT8)(val % 10) << 4;
+		val /= 10;
 	}
-	val.d = temp;
-	temp = floatx80_round_to_int(floatx80_div(val.d, p10));
-	p = floatx80_to_int32_round_to_zero(floatx80_sub(val.d, floatx80_mul(temp, p10)));  
-	if(sign)
-		p |= 0x80;
-	fpu_memorywrite_b(addr+9,(UINT8)p);
 
+	// 80bitÇ‹Ç∆ÇﬂÇƒèëÇ´çûÇ›
+	fpu_memorywrite_f(addr, &bcdbuf);
+
 	float_rounding_mode = oldrnd;
 	FPU_STATUSWORD |= float_exception_flags;
 }
 
-#define isinf(x) (!(_finite(x) || _isnan(x)))
-#define isdenormal(x) (_fpclass(x) == _FPCLASS_ND || _fpclass(x) == _FPCLASS_PD)
 
-static void FPU_FADD(UINT op1, UINT op2){
+/*
+ * FPU interface
+ */
+
+static void
+FPU_FINIT(void)
+{
+	int i;
+	FPU_SetCW(0x37F);
+	FPU_STATUSWORD = 0;
+	FPU_STAT_TOP=FP_TOP_GET();
+	for(i=0;i<8;i++){
+		// EmptyÉZÉbÉgÇµÇƒÇ‡ÉåÉWÉXÉ^ÇÃì‡óeÇÕè¡ÇµÇƒÇÕÇ¢ÇØÇ»Ç¢
+		FPU_STAT.tag[i] = TAG_Empty;
+	}
+	FPU_STAT.tag[8] = TAG_Valid; // dummy
+	FPU_STAT.mmxenable = 0;
+}
+void SF_FPU_FINIT(void){
+	int i;
+	FPU_FINIT();
+	for(i=0;i<8;i++){
+		FPU_STAT.tag[i] = TAG_Empty;
+		FPU_STAT.reg[i].l.ext = 0;
+		FPU_STAT.reg[i].l.lower = 0;
+		FPU_STAT.reg[i].l.upper = 0;
+	}
+}
+
+static void FPU_FLDCW(UINT32 addr)
+{
+	UINT16 temp = cpu_vmemoryread_w(CPU_INST_SEGREG_INDEX, addr);
+	FPU_SetCW(temp);
+}
+
+static UINT16 FPU_GetTag(void)
+{
+	UINT i;
+
+	UINT16 tag = 0;
+	for (i = 0; i < 8; i++)
+		tag |= ((FPU_STAT.tag[i] & 3) << (2 * i));
+	return tag;
+}
+static UINT8 FPU_GetTag8(void)
+{
+	UINT i;
+
+	UINT8 tag = 0;
+	for (i = 0; i < 8; i++)
+		tag |= ((FPU_STAT.tag[i] == TAG_Empty ? 0 : 1) << (i));
+	return tag;
+}
+
+static INLINE void FPU_SetTag(UINT16 tag)
+{
+	UINT i;
+
+	for (i = 0; i < 8; i++) {
+		FPU_STAT.tag[i] = (FP_TAG)((tag >> (2 * i)) & 3);
+
+	}
+}
+static INLINE void FPU_SetTag8(UINT8 tag)
+{
+	UINT i;
+
+	for (i = 0; i < 8; i++) {
+		FPU_STAT.tag[i] = (((tag >> i) & 1) == 0 ? TAG_Empty : TAG_Valid);
+	}
+}
+
+static void FPU_prepush(void) {
+	if(FPU_STAT_TOP == 0){
+		FPU_STATUSWORD |= FP_C1_FLAG;
+	}else{
+		FPU_STATUSWORD &= ~FP_C1_FLAG;
+	}
+	FPU_STAT_TOP = (FPU_STAT_TOP - 1) & 7;
+	FPU_STAT.tag[FPU_STAT_TOP] = TAG_Valid;
+}
+static void FPU_push(floatx80 in) {
+	FPU_prepush();
+	FPU_STAT.reg[FPU_STAT_TOP].d = in;
+}
+
+static void FPU_pop(void) {
+	FPU_STAT.tag[FPU_STAT_TOP] = TAG_Empty;
+	FPU_STAT.mmxenable = 0;
+	FPU_STAT_TOP = ((FPU_STAT_TOP + 1) & 7);
+}
+
+/*
+ * FPU instruction
+ */
+
+ // ÉåÉWÉXÉ^ëÄçÏ
+static void FPU_FST(UINT st, UINT other) {
+	FPU_STAT.tag[other] = FPU_STAT.tag[st];
+	FPU_STAT.reg[other] = FPU_STAT.reg[st];
+}
+static void FPU_FXCH(UINT st, UINT other) {
+	FP_TAG tag;
+	FP_REG reg;
+
+	tag = FPU_STAT.tag[other];
+	reg = FPU_STAT.reg[other];
+	FPU_STAT.tag[other] = FPU_STAT.tag[st];
+	FPU_STAT.reg[other] = FPU_STAT.reg[st];
+	FPU_STAT.tag[st] = tag;
+	FPU_STAT.reg[st] = reg;
+}
+static void FPU_FLD1(void) {
+	FPU_prepush();
+	FPU_STAT.reg[FPU_STAT_TOP].d = c_double_to_floatx80(1.0);
+}
+static void FPU_FLDL2T(void) {
+	FPU_prepush();
+	FPU_STAT.reg[FPU_STAT_TOP].d = c_double_to_floatx80(L2T);
+}
+static void FPU_FLDL2E(void) {
+	FPU_prepush();
+	FPU_STAT.reg[FPU_STAT_TOP].d = c_double_to_floatx80(L2E);
+}
+static void FPU_FLDPI(void) {
+	FPU_prepush();
+	FPU_STAT.reg[FPU_STAT_TOP].d = c_double_to_floatx80(PI);
+}
+static void FPU_FLDLG2(void) {
+	FPU_prepush();
+	FPU_STAT.reg[FPU_STAT_TOP].d = c_double_to_floatx80(LG2);
+}
+static void FPU_FLDLN2(void) {
+	FPU_prepush();
+	FPU_STAT.reg[FPU_STAT_TOP].d = c_double_to_floatx80(LN2);
+}
+static void FPU_FLDZ(void) {
+	FPU_prepush();
+	FPU_STAT.reg[FPU_STAT_TOP].d = c_double_to_floatx80(0.0);
+	FPU_STAT.tag[FPU_STAT_TOP] = TAG_Zero;
+	FPU_STAT.mmxenable = 0;
+}
+
+// élë•ââéZ
+static void FPU_FADD(UINT op1, UINT op2) {
 	float_exception_flags = (FPU_STATUSWORD & 0x3f);
 	FPU_STAT.reg[op1].d = floatx80_add(FPU_STAT.reg[op1].d, FPU_STAT.reg[op2].d);
 	FPU_STATUSWORD |= float_exception_flags;
 	return;
 }
-
-static void FPU_FSIN(void){
+static void FPU_FMUL(UINT st, UINT other) {
 	float_exception_flags = (FPU_STATUSWORD & 0x3f);
-	FPU_STAT.reg[FPU_STAT_TOP].d = c_double_to_floatx80(sin(floatx80_to_c_double(FPU_STAT.reg[FPU_STAT_TOP].d)));
-	FPU_SET_C2(0);
-	//flags and such :)
+	FPU_STAT.reg[st].d = floatx80_mul(FPU_STAT.reg[st].d, FPU_STAT.reg[other].d);
 	FPU_STATUSWORD |= float_exception_flags;
 	return;
 }
-
-static void FPU_FSINCOS(void){
-	double temp;
-	
+static void FPU_FSUB(UINT st, UINT other) {
 	float_exception_flags = (FPU_STATUSWORD & 0x3f);
-	temp = floatx80_to_c_double(FPU_STAT.reg[FPU_STAT_TOP].d);
-	FPU_STAT.reg[FPU_STAT_TOP].d = c_double_to_floatx80(sin(temp));
-	FPU_PUSH(c_double_to_floatx80(cos(temp)));
-	FPU_SET_C2(0);
-	//flags and such :)
-	FPU_STATUSWORD |= float_exception_flags;
+	FPU_STAT.reg[st].d = floatx80_sub(FPU_STAT.reg[st].d, FPU_STAT.reg[other].d);
 	return;
 }
-
-static void FPU_FCOS(void){
+static void FPU_FSUBR(UINT st, UINT other) {
 	float_exception_flags = (FPU_STATUSWORD & 0x3f);
-	FPU_STAT.reg[FPU_STAT_TOP].d = c_double_to_floatx80(cos(floatx80_to_c_double(FPU_STAT.reg[FPU_STAT_TOP].d)));
-	FPU_SET_C2(0);
-	//flags and such :)
+	FPU_STAT.reg[st].d = floatx80_sub(FPU_STAT.reg[other].d, FPU_STAT.reg[st].d);
 	FPU_STATUSWORD |= float_exception_flags;
 	return;
 }
-
-static void FPU_FSQRT(void){
+static void FPU_FDIV(UINT st, UINT other) {
 	float_exception_flags = (FPU_STATUSWORD & 0x3f);
-	FPU_STAT.reg[FPU_STAT_TOP].d = floatx80_sqrt(FPU_STAT.reg[FPU_STAT_TOP].d);
-	//flags and such :)
+	FPU_STAT.reg[st].d = floatx80_div(FPU_STAT.reg[st].d, FPU_STAT.reg[other].d);
 	FPU_STATUSWORD |= float_exception_flags;
 	return;
 }
-static void FPU_FPATAN(void){
+static void FPU_FDIVR(UINT st, UINT other) {
 	float_exception_flags = (FPU_STATUSWORD & 0x3f);
-	FPU_STAT.reg[FPU_ST(1)].d = c_double_to_floatx80(atan2(floatx80_to_c_double(FPU_STAT.reg[FPU_ST(1)].d),floatx80_to_c_double(FPU_STAT.reg[FPU_STAT_TOP].d)));
-	FPU_FPOP();
-	//flags and such :)
+	FPU_STAT.reg[st].d = floatx80_div(FPU_STAT.reg[other].d, FPU_STAT.reg[st].d);
 	FPU_STATUSWORD |= float_exception_flags;
 	return;
 }
-static void FPU_FPTAN(void){
+static INLINE void FPU_FADD_EA(UINT op1) {
+	FPU_FADD(op1, 8);
+}
+static INLINE void FPU_FMUL_EA(UINT op1) {
+	FPU_FMUL(op1, 8);
+}
+static INLINE void FPU_FSUB_EA(UINT op1) {
+	FPU_FSUB(op1, 8);
+}
+static INLINE void FPU_FSUBR_EA(UINT op1) {
+	FPU_FSUBR(op1, 8);
+}
+static INLINE void FPU_FDIV_EA(UINT op1) {
+	FPU_FDIV(op1, 8);
+}
+static INLINE void FPU_FDIVR_EA(UINT op1) {
+	FPU_FDIVR(op1, 8);
+}
+static void FPU_FPREM(void) {
+	floatx80 val, div;
+	SINT64 qint;
+
 	float_exception_flags = (FPU_STATUSWORD & 0x3f);
-	FPU_STAT.reg[FPU_STAT_TOP].d = c_double_to_floatx80(tan(floatx80_to_c_double(FPU_STAT.reg[FPU_STAT_TOP].d)));
-	FPU_PUSH(c_double_to_floatx80(1.0));
-	FPU_SET_C2(0);
-	//flags and such :)
+	val = FPU_STAT.reg[FPU_STAT_TOP].d;
+	div = FPU_STAT.reg[FPU_ST(1)].d;
+	qint = floatx80_to_int64_round_to_zero(floatx80_div(val, div)); // int(îÌèúêî / èúêî) = è§
+
+	FPU_STAT.reg[FPU_STAT_TOP].d = floatx80_sub(val, floatx80_mul(int64_to_floatx80(qint), div)); // îÌèúêî - è§ x èúêî = èËó]
+	FPU_STATUSWORD &= ~(FP_C0_FLAG | FP_C1_FLAG | FP_C2_FLAG | FP_C3_FLAG);
+	if(qint & 4) FPU_STATUSWORD |= FP_C0_FLAG; // è§ÇÃbit2
+	if(qint & 2) FPU_STATUSWORD |= FP_C3_FLAG; // è§ÇÃbit1
+	if(qint & 1) FPU_STATUSWORD |= FP_C1_FLAG; // è§ÇÃbit0
+	// C2ÉNÉäÉAÇ≈äÆóπàµÇ¢
 	FPU_STATUSWORD |= float_exception_flags;
+}
+
+static void FPU_FPREM1(void) {
+	floatx80 val, div, q;
+	SINT64 qint;
+	signed char oldrnd = float_rounding_mode;
+
+	// IEEE 754 èËó]Å@è§Çç≈Ç‡ãﬂÇ¢êÆêîílÇ∆Ç∑ÇÈÅBó]ÇËÇ™ïâílÇ…Ç»ÇÈÇ±Ç∆Ç™óLÇËìæÇÈ
+
+	float_exception_flags = (FPU_STATUSWORD & 0x3f);
+	val = FPU_STAT.reg[FPU_STAT_TOP].d;
+	div = FPU_STAT.reg[FPU_ST(1)].d;
+	q = floatx80_add(floatx80_div(val, div), c_double_to_floatx80(0.5)); // floor(íl + 0.5)Ç≈éléÃå‹ì¸ åµñßÇ…ÇÕïâílÇÃã´äEÇ≈à·Ç§Ç™î˜ÅXÇΩÇÈç∑Ç∆ÇµÇƒãCÇ…ÇµÇ»Ç¢Ç±Ç∆Ç…Ç∑ÇÈÅB
+	float_rounding_mode = float_round_down;
+	qint = floatx80_to_int64(q); // éléÃå‹ì¸(îÌèúêî / èúêî) = ç≈Ç‡êÆêîÇ…ãﬂÇ¢è§
+
+	FPU_STAT.reg[FPU_STAT_TOP].d = floatx80_sub(val, floatx80_mul(int64_to_floatx80(qint), div)); // îÌèúêî - è§ x èúêî = èËó]
+	FPU_STATUSWORD &= ~(FP_C0_FLAG | FP_C1_FLAG | FP_C2_FLAG | FP_C3_FLAG);
+	if(qint & 4) FPU_STATUSWORD |= FP_C0_FLAG; // è§ÇÃbit2
+	if(qint & 2) FPU_STATUSWORD |= FP_C3_FLAG; // è§ÇÃbit1
+	if(qint & 1) FPU_STATUSWORD |= FP_C1_FLAG; // è§ÇÃbit0
+	// C2ÉNÉäÉAÇ≈äÆóπàµÇ¢
+	float_rounding_mode = oldrnd;
+	FPU_STATUSWORD |= float_exception_flags;
+}
+
+// êîäwä÷êî
+static void FPU_FSIN(void) {
+	float_exception_flags = (FPU_STATUSWORD & 0x3f);
+	FPU_STAT.reg[FPU_STAT_TOP].d = c_double_to_floatx80(sin(floatx80_to_c_double(FPU_STAT.reg[FPU_STAT_TOP].d)));
+	FPU_STATUSWORD &= ~FP_C2_FLAG;
+	FPU_STATUSWORD |= float_exception_flags;
 	return;
 }
-static void FPU_FDIV(UINT st, UINT other){
+static void FPU_FCOS(void) {
 	float_exception_flags = (FPU_STATUSWORD & 0x3f);
-	//if(floatx80_eq(FPU_STAT.reg[other].d, c_double_to_floatx80(0.0))){
-	//	FPU_STATUSWORD |= FP_ZE_FLAG;
-	//	if(!(FPU_CTRLWORD & FP_ZE_FLAG))
-	//		return;
-	//}
-	FPU_STAT.reg[st].d = floatx80_div(FPU_STAT.reg[st].d, FPU_STAT.reg[other].d);
-	//flags and such :)
+	FPU_STAT.reg[FPU_STAT_TOP].d = c_double_to_floatx80(cos(floatx80_to_c_double(FPU_STAT.reg[FPU_STAT_TOP].d)));
+	FPU_STATUSWORD &= ~FP_C2_FLAG;
 	FPU_STATUSWORD |= float_exception_flags;
 	return;
 }
+static void FPU_FSINCOS(void) {
+	double temp;
 
-static void FPU_FDIVR(UINT st, UINT other){
 	float_exception_flags = (FPU_STATUSWORD & 0x3f);
-	//if(floatx80_eq(FPU_STAT.reg[st].d, c_double_to_floatx80(0.0))){
-	//	FPU_STATUSWORD |= FP_ZE_FLAG;
-	//	if(!(FPU_CTRLWORD & FP_ZE_FLAG))
-	//		return;
-	//}
-	FPU_STAT.reg[st].d = floatx80_div(FPU_STAT.reg[other].d, FPU_STAT.reg[st].d);
-	// flags and such :)
+	temp = floatx80_to_c_double(FPU_STAT.reg[FPU_STAT_TOP].d);
+	FPU_STAT.reg[FPU_STAT_TOP].d = c_double_to_floatx80(sin(temp));
+	FPU_push(c_double_to_floatx80(cos(temp)));
+	FPU_STATUSWORD &= ~FP_C2_FLAG;
 	FPU_STATUSWORD |= float_exception_flags;
 	return;
 }
-
-static void FPU_FMUL(UINT st, UINT other){
+static void FPU_FPTAN(void) {
 	float_exception_flags = (FPU_STATUSWORD & 0x3f);
-	FPU_STAT.reg[st].d = floatx80_mul(FPU_STAT.reg[st].d, FPU_STAT.reg[other].d);
-	//flags and such :)
+	FPU_STAT.reg[FPU_STAT_TOP].d = c_double_to_floatx80(tan(floatx80_to_c_double(FPU_STAT.reg[FPU_STAT_TOP].d)));
+	FPU_push(c_double_to_floatx80(1.0));
+	FPU_STATUSWORD &= ~FP_C2_FLAG;
 	FPU_STATUSWORD |= float_exception_flags;
 	return;
 }
-
-static void FPU_FSUB(UINT st, UINT other){
+static void FPU_FPATAN(void) {
 	float_exception_flags = (FPU_STATUSWORD & 0x3f);
-	FPU_STAT.reg[st].d = floatx80_sub(FPU_STAT.reg[st].d, FPU_STAT.reg[other].d);
-	//flags and such :)
+	FPU_STAT.reg[FPU_ST(1)].d = c_double_to_floatx80(atan2(floatx80_to_c_double(FPU_STAT.reg[FPU_ST(1)].d), floatx80_to_c_double(FPU_STAT.reg[FPU_STAT_TOP].d)));
+	FPU_pop();
+	FPU_STATUSWORD |= float_exception_flags;
 	return;
 }
-
-static void FPU_FSUBR(UINT st, UINT other){
+static void FPU_FSQRT(void) {
 	float_exception_flags = (FPU_STATUSWORD & 0x3f);
-	FPU_STAT.reg[st].d = floatx80_sub(FPU_STAT.reg[other].d, FPU_STAT.reg[st].d);
-	//flags and such :)
+	FPU_STAT.reg[FPU_STAT_TOP].d = floatx80_sqrt(FPU_STAT.reg[FPU_STAT_TOP].d);
 	FPU_STATUSWORD |= float_exception_flags;
 	return;
 }
-
-static void FPU_FXCH(UINT st, UINT other){
-	FP_TAG tag; 
-	FP_REG reg;
-
-	tag = FPU_STAT.tag[other];
-	reg = FPU_STAT.reg[other];
-	FPU_STAT.tag[other] = FPU_STAT.tag[st];
-	FPU_STAT.reg[other] = FPU_STAT.reg[st];
-	FPU_STAT.tag[st] = tag;
-	FPU_STAT.reg[st] = reg;
+static void FPU_FRNDINT(void) {
+	float_exception_flags = (FPU_STATUSWORD & 0x3f);
+	FPU_STAT.reg[FPU_STAT_TOP].d = floatx80_round_to_int(FPU_STAT.reg[FPU_STAT_TOP].d);
+	FPU_STATUSWORD |= float_exception_flags;
 }
-
-static void FPU_FST(UINT st, UINT other){
-	FPU_STAT.tag[other] = FPU_STAT.tag[st];
-	FPU_STAT.reg[other] = FPU_STAT.reg[st];
+static void FPU_F2XM1(void) {
+	FPU_STAT.reg[FPU_STAT_TOP].d = c_double_to_floatx80(pow(2.0, floatx80_to_c_double(FPU_STAT.reg[FPU_STAT_TOP].d)) - 1);
 }
+static void FPU_FYL2X(void) {
+	FPU_STAT.reg[FPU_ST(1)].d = floatx80_mul(FPU_STAT.reg[FPU_ST(1)].d, c_double_to_floatx80(log(floatx80_to_c_double(FPU_STAT.reg[FPU_STAT_TOP].d)) / log(2.0)));
+	FPU_pop();
+}
+static void FPU_FYL2XP1(void) {
+	FPU_STAT.reg[FPU_ST(1)].d = floatx80_mul(FPU_STAT.reg[FPU_ST(1)].d, c_double_to_floatx80(log(floatx80_to_c_double(FPU_STAT.reg[FPU_STAT_TOP].d) + 1.0) / log(2.0)));
+	FPU_pop();
+}
+static void FPU_FSCALE(void) {
+	FPU_STAT.reg[FPU_STAT_TOP].d = floatx80_mul(FPU_STAT.reg[FPU_STAT_TOP].d, c_double_to_floatx80(pow(2.0, floatx80_to_c_double(FPU_STAT.reg[FPU_ST(1)].d))));
+}
+static void FPU_FCHS(void) {
+	FPU_STAT.reg[FPU_STAT_TOP].b[9] ^= 0x80;
+}
+static void FPU_FABS(void) {
+	FPU_STAT.reg[FPU_STAT_TOP].b[9] &= ~0x80;
+}
 
-static void FPU_FCOM(UINT st, UINT other){
-	if(((FPU_STAT.tag[st] != TAG_Valid) && (FPU_STAT.tag[st] != TAG_Zero)) || 
-		((FPU_STAT.tag[other] != TAG_Valid) && (FPU_STAT.tag[other] != TAG_Zero)) || 
-		(floatx80_is_nan(FPU_STAT.reg[st].d) || floatx80_is_nan(FPU_STAT.reg[other].d))){
-		FPU_SET_C3(1);
-		FPU_SET_C2(1);
-		FPU_SET_C0(1);
-		return;
+// î‰är
+static void FPU_FCOM(UINT st, UINT other) {
+	FPU_STATUSWORD &= ~(FP_C0_FLAG | FP_C2_FLAG | FP_C3_FLAG);
+	if (((FPU_STAT.tag[st] != TAG_Valid) && (FPU_STAT.tag[st] != TAG_Zero)) ||
+		((FPU_STAT.tag[other] != TAG_Valid) && (FPU_STAT.tag[other] != TAG_Zero)) ||
+		(floatx80_is_nan(FPU_STAT.reg[st].d) || floatx80_is_nan(FPU_STAT.reg[other].d))) {
+		FPU_STATUSWORD |= FP_C3_FLAG|FP_C2_FLAG|FP_C0_FLAG;
 	}
-
-	if(floatx80_eq(FPU_STAT.reg[st].d, FPU_STAT.reg[other].d)){
-		FPU_SET_C3(1);
-		FPU_SET_C2(0);
-		FPU_SET_C0(0);
-		return;
+	else if (floatx80_eq(FPU_STAT.reg[st].d, FPU_STAT.reg[other].d)) {
+		FPU_STATUSWORD |= FP_C3_FLAG;
 	}
-	if(floatx80_lt(FPU_STAT.reg[st].d, FPU_STAT.reg[other].d)){
-		FPU_SET_C3(0);
-		FPU_SET_C2(0);
-		FPU_SET_C0(1);
-		return;
+	else if (floatx80_lt(FPU_STAT.reg[st].d, FPU_STAT.reg[other].d)) {
+		FPU_STATUSWORD |= FP_C0_FLAG;
 	}
-	// st > other
-	FPU_SET_C3(0);
-	FPU_SET_C2(0);
-	FPU_SET_C0(0);
-	return;
 }
-static void FPU_FCOMI(UINT st, UINT other){
-	if(((FPU_STAT.tag[st] != TAG_Valid) && (FPU_STAT.tag[st] != TAG_Zero)) || 
-		((FPU_STAT.tag[other] != TAG_Valid) && (FPU_STAT.tag[other] != TAG_Zero)) || 
-		(floatx80_is_nan(FPU_STAT.reg[st].d) || floatx80_is_nan(FPU_STAT.reg[other].d))){
-		CPU_FLAGL = (CPU_FLAGL & ~Z_FLAG) | Z_FLAG;
-		CPU_FLAGL = (CPU_FLAGL & ~P_FLAG) | P_FLAG;
-		CPU_FLAGL = (CPU_FLAGL & ~C_FLAG) | C_FLAG;
-		return;
+static void FPU_FCOMI(UINT st, UINT other) {
+	CPU_FLAGL &= ~(Z_FLAG|P_FLAG|C_FLAG);
+	if (((FPU_STAT.tag[st] != TAG_Valid) && (FPU_STAT.tag[st] != TAG_Zero)) ||
+		((FPU_STAT.tag[other] != TAG_Valid) && (FPU_STAT.tag[other] != TAG_Zero)) ||
+		(floatx80_is_nan(FPU_STAT.reg[st].d) || floatx80_is_nan(FPU_STAT.reg[other].d))) {
+		CPU_FLAGL |= Z_FLAG|P_FLAG|C_FLAG;
 	}
-
-	if(floatx80_eq(FPU_STAT.reg[st].d, FPU_STAT.reg[other].d)){
-		CPU_FLAGL = (CPU_FLAGL & ~Z_FLAG) | Z_FLAG;
-		CPU_FLAGL = (CPU_FLAGL & ~P_FLAG) | 0;
-		CPU_FLAGL = (CPU_FLAGL & ~C_FLAG) | 0;
-		return;
+	else if (floatx80_eq(FPU_STAT.reg[st].d, FPU_STAT.reg[other].d)) {
+		CPU_FLAGL |= Z_FLAG;
 	}
-	if(floatx80_lt(FPU_STAT.reg[st].d, FPU_STAT.reg[other].d)){
-		CPU_FLAGL = (CPU_FLAGL & ~Z_FLAG) | 0;
-		CPU_FLAGL = (CPU_FLAGL & ~P_FLAG) | 0;
-		CPU_FLAGL = (CPU_FLAGL & ~C_FLAG) | C_FLAG;
-		return;
+	else if (floatx80_lt(FPU_STAT.reg[st].d, FPU_STAT.reg[other].d)) {
+		CPU_FLAGL |= C_FLAG;
 	}
-	// st > other
-	CPU_FLAGL = (CPU_FLAGL & ~Z_FLAG) | 0;
-	CPU_FLAGL = (CPU_FLAGL & ~P_FLAG) | 0;
-	CPU_FLAGL = (CPU_FLAGL & ~C_FLAG) | 0;
-	return;
 }
-
-static void FPU_FUCOM(UINT st, UINT other){
-	//does atm the same as fcom 
-	FPU_FCOM(st,other);
+static void FPU_FUCOM(UINT st, UINT other) {
+	// ó·äOóçÇ›ÇÃãììÆÇ™à·Ç§Ç™ÇŸÇ⁄ìØÇ∂Ç∆ÇµÇƒÉXÉãÅ[
+	FPU_FCOM(st, other);
 }
-static void FPU_FUCOMI(UINT st, UINT other){
-	//does atm the same as fcomi 
-	FPU_FCOMI(st,other);
+static void FPU_FUCOMI(UINT st, UINT other) {
+	// ó·äOóçÇ›ÇÃãììÆÇ™à·Ç§Ç™ÇŸÇ⁄ìØÇ∂Ç∆ÇµÇƒÉXÉãÅ[
+	FPU_FCOMI(st, other);
 }
+static INLINE void FPU_FCOM_EA(UINT op1) {
+	FPU_FCOM(op1, 8);
+}
+static void FPU_FTST(void) {
+	FPU_STAT.reg[8].d = c_double_to_floatx80(0.0);
+	FPU_FCOM(FPU_STAT_TOP, 8);
+}
 
-static void FPU_FCMOVB(UINT st, UINT other){
-	if(CPU_FLAGL & C_FLAG){
+// èåèïtÇ´ÉRÉsÅ[
+static void FPU_FCMOVB(UINT st, UINT other) {
+	if (CPU_FLAGL & C_FLAG) {
 		FPU_STAT.tag[st] = FPU_STAT.tag[other];
 		FPU_STAT.reg[st] = FPU_STAT.reg[other];
 	}
 }
-static void FPU_FCMOVE(UINT st, UINT other){
-	if(CPU_FLAGL & Z_FLAG){
+static void FPU_FCMOVE(UINT st, UINT other) {
+	if (CPU_FLAGL & Z_FLAG) {
 		FPU_STAT.tag[st] = FPU_STAT.tag[other];
 		FPU_STAT.reg[st] = FPU_STAT.reg[other];
 	}
 }
-static void FPU_FCMOVBE(UINT st, UINT other){
-	if(CPU_FLAGL & (C_FLAG|Z_FLAG)){
+static void FPU_FCMOVBE(UINT st, UINT other) {
+	if (CPU_FLAGL & (C_FLAG | Z_FLAG)) {
 		FPU_STAT.tag[st] = FPU_STAT.tag[other];
 		FPU_STAT.reg[st] = FPU_STAT.reg[other];
 	}
 }
-static void FPU_FCMOVU(UINT st, UINT other){
-	if(CPU_FLAGL & P_FLAG){
+static void FPU_FCMOVU(UINT st, UINT other) {
+	if (CPU_FLAGL & P_FLAG) {
 		FPU_STAT.tag[st] = FPU_STAT.tag[other];
 		FPU_STAT.reg[st] = FPU_STAT.reg[other];
 	}
 }
-
-static void FPU_FCMOVNB(UINT st, UINT other){
-	if(!(CPU_FLAGL & C_FLAG)){
+static void FPU_FCMOVNB(UINT st, UINT other) {
+	if (!(CPU_FLAGL & C_FLAG)) {
 		FPU_STAT.tag[st] = FPU_STAT.tag[other];
 		FPU_STAT.reg[st] = FPU_STAT.reg[other];
 	}
 }
-static void FPU_FCMOVNE(UINT st, UINT other){
-	if(!(CPU_FLAGL & Z_FLAG)){
+static void FPU_FCMOVNE(UINT st, UINT other) {
+	if (!(CPU_FLAGL & Z_FLAG)) {
 		FPU_STAT.tag[st] = FPU_STAT.tag[other];
 		FPU_STAT.reg[st] = FPU_STAT.reg[other];
 	}
 }
-static void FPU_FCMOVNBE(UINT st, UINT other){
-	if(!(CPU_FLAGL & (C_FLAG|Z_FLAG))){
+static void FPU_FCMOVNBE(UINT st, UINT other) {
+	if (!(CPU_FLAGL & (C_FLAG | Z_FLAG))) {
 		FPU_STAT.tag[st] = FPU_STAT.tag[other];
 		FPU_STAT.reg[st] = FPU_STAT.reg[other];
 	}
 }
-static void FPU_FCMOVNU(UINT st, UINT other){
-	if(!(CPU_FLAGL & P_FLAG)){
+static void FPU_FCMOVNU(UINT st, UINT other) {
+	if (!(CPU_FLAGL & P_FLAG)) {
 		FPU_STAT.tag[st] = FPU_STAT.tag[other];
 		FPU_STAT.reg[st] = FPU_STAT.reg[other];
 	}
 }
 
-static void FPU_FRNDINT(void){
-	
-	float_exception_flags = (FPU_STATUSWORD & 0x3f);
-	FPU_STAT.reg[FPU_STAT_TOP].d = floatx80_round_to_int(FPU_STAT.reg[FPU_STAT_TOP].d);
-	FPU_STATUSWORD |= float_exception_flags;
-}
+// ïÇìÆè¨êîì_êîëÄçÏ
+static void FPU_FXAM(void) {
+	FPU_STATUSWORD &= ~(FP_C0_FLAG | FP_C1_FLAG | FP_C2_FLAG | FP_C3_FLAG);
+	if (FPU_STAT.reg[FPU_STAT_TOP].d.high & 0x8000) {
+		FPU_STATUSWORD |= FP_C1_FLAG;
+	}
 
-static void FPU_FPREM(void){
-	floatx80 valtop;
-	floatx80 valdiv;
-	SINT64 ressaved;
-	
-	float_exception_flags = (FPU_STATUSWORD & 0x3f);
-	valtop = FPU_STAT.reg[FPU_STAT_TOP].d;
-	valdiv = FPU_STAT.reg[FPU_ST(1)].d;
-	ressaved = floatx80_to_int64_round_to_zero(floatx80_div(valtop, valdiv)); 
-// Some backups
-//	Real64 res=valtop - ressaved*valdiv; 
-//      res= fmod(valtop,valdiv);
-	FPU_STAT.reg[FPU_STAT_TOP].d = floatx80_sub(valtop, floatx80_mul(int64_to_floatx80(ressaved), valdiv));
-	FPU_SET_C0((UINT)(ressaved&4));
-	FPU_SET_C3((UINT)(ressaved&2));
-	FPU_SET_C1((UINT)(ressaved&1));
-	FPU_SET_C2(0);
-	FPU_STATUSWORD |= float_exception_flags;
-}
-
-static void FPU_FPREM1(void){
-	floatx80 valtop;
-	floatx80 valdiv, quot, quotf, quot_sub_quotf;
-	SINT64 ressaved;
-	floatx80 v05 = c_double_to_floatx80(0.5);
-	signed char oldrnd = float_rounding_mode;
-	
-	float_exception_flags = (FPU_STATUSWORD & 0x3f);
-	valtop = FPU_STAT.reg[FPU_STAT_TOP].d;
-	valdiv = FPU_STAT.reg[FPU_ST(1)].d;
-	quot = floatx80_div(valtop, valdiv);
-	float_rounding_mode = float_round_down;
-	quotf = floatx80_round_to_int(quot);
-	
-	quot_sub_quotf = floatx80_sub(quot, quotf);
-	if (floatx80_lt(v05, quot_sub_quotf)) ressaved = floatx80_to_int64_round_to_zero(quotf)+1;
-	else if (floatx80_lt(quot_sub_quotf, v05)) ressaved = floatx80_to_int64_round_to_zero(quotf);
-	else ressaved = ((((floatx80_to_int64_round_to_zero(quotf))&1)!=0) ? floatx80_to_int64_round_to_zero(quotf)+1 : floatx80_to_int64_round_to_zero(quotf));
-	
-	FPU_STAT.reg[FPU_STAT_TOP].d = floatx80_sub(valtop, floatx80_mul(int64_to_floatx80(ressaved), valdiv));
-	FPU_SET_C0((UINT)(ressaved&4));
-	FPU_SET_C3((UINT)(ressaved&2));
-	FPU_SET_C1((UINT)(ressaved&1));
-	FPU_SET_C2(0);
-
-	float_rounding_mode = oldrnd;
-	FPU_STATUSWORD |= float_exception_flags;
-}
-
-static void FPU_FXAM(void){
-	if(FPU_STAT.reg[FPU_STAT_TOP].d.high & 0x8000)	//sign
-	{ 
-		FPU_SET_C1(1);
-	} 
-	else 
-	{
-		FPU_SET_C1(0);
+	if (FPU_STAT.tag[FPU_STAT_TOP] == TAG_Empty) {
+		FPU_STATUSWORD |= FP_C3_FLAG;
+		FPU_STATUSWORD |= FP_C0_FLAG;
 	}
-	if(FPU_STAT.tag[FPU_STAT_TOP] == TAG_Empty)
-	{
-		FPU_SET_C3(1);FPU_SET_C2(0);FPU_SET_C0(1);
-		return;
+	else if (floatx80_is_nan(FPU_STAT.reg[FPU_STAT_TOP].d)) {
+		FPU_STATUSWORD |= FP_C0_FLAG;
 	}
-	if(floatx80_is_nan(FPU_STAT.reg[FPU_STAT_TOP].d))
-	{
-		FPU_SET_C3(0);FPU_SET_C2(0);FPU_SET_C0(1);
-		return;
+	else if (floatx80_is_inf(FPU_STAT.reg[FPU_STAT_TOP].d)) {
+		FPU_STATUSWORD |= FP_C2_FLAG;
+		FPU_STATUSWORD |= FP_C0_FLAG;
 	}
-	if(floatx80_is_inf(FPU_STAT.reg[FPU_STAT_TOP].d))
-	{
-		FPU_SET_C3(0);FPU_SET_C2(1);FPU_SET_C0(1);
-		return;
+	else if (floatx80_eq(FPU_STAT.reg[FPU_STAT_TOP].d, c_double_to_floatx80(0.0))) {
+		FPU_STATUSWORD |= FP_C3_FLAG;
 	}
-	if(floatx80_eq(FPU_STAT.reg[FPU_STAT_TOP].d, c_double_to_floatx80(0.0)))		//zero or normalized number.
-	{ 
-		FPU_SET_C3(1);FPU_SET_C2(0);FPU_SET_C0(0);
+	else {
+		FPU_STATUSWORD |= FP_C2_FLAG;
 	}
-	else
-	{
-		FPU_SET_C3(0);FPU_SET_C2(1);FPU_SET_C0(0);
-	}
 }
 
-static void FPU_F2XM1(void){
-	FPU_STAT.reg[FPU_STAT_TOP].d = c_double_to_floatx80(pow(2.0, floatx80_to_c_double(FPU_STAT.reg[FPU_STAT_TOP].d)) - 1);
-	return;
-}
+static void FPU_FXTRACT(void) {
+	SINT32 expval;
+	floatx80 fracval;
 
-static void FPU_FYL2X(void){
-	FPU_STAT.reg[FPU_ST(1)].d = floatx80_mul(FPU_STAT.reg[FPU_ST(1)].d, c_double_to_floatx80(log(floatx80_to_c_double(FPU_STAT.reg[FPU_STAT_TOP].d))/log((double)(2.0))));
-	FPU_FPOP();
-	return;
+	fracval = FPU_STAT.reg[FPU_STAT_TOP].d;
+	expval = (SINT32)((UINT16)fracval.high & 0x7FFF) - 0x3FFF; // éwêîïîï™ÇíäèoÅAÉoÉCÉAÉXï™Çà¯Ç≠
+	fracval.high = (SINT16)(((UINT16)fracval.high & 0x8000) | 0x3FFF); // ïÑçÜÇÕécÇµÅAéwêîïîï™Ç0x3FFFÅiÉoÉCÉAÉXï™=0ÅjÇ…ÇµÇƒâºêîÇæÇØÇ…Ç∑ÇÈ
+	FPU_STAT.reg[FPU_STAT_TOP].d = int64_to_floatx80(expval); // éwêîÇÃèëÇ´çûÇ›
+	FPU_push(fracval); // âºêîÇÃpush
 }
 
-static void FPU_FYL2XP1(void){
-	FPU_STAT.reg[FPU_ST(1)].d = floatx80_mul(FPU_STAT.reg[FPU_ST(1)].d, c_double_to_floatx80(log(floatx80_to_c_double(FPU_STAT.reg[FPU_STAT_TOP].d)+1.0)/log((double)(2.0))));
-	FPU_FPOP();
-	return;
-}
-
-static void FPU_FSCALE(void){
-	FPU_STAT.reg[FPU_STAT_TOP].d = floatx80_mul(FPU_STAT.reg[FPU_STAT_TOP].d, c_double_to_floatx80(pow(2.0, floatx80_to_c_double(FPU_STAT.reg[FPU_ST(1)].d))));
-	return; //2^x where x is chopped.
-}
-
+// ä¬ã´ÉçÅ[ÉhÅEÉXÉgÉA
 static void FPU_FSTENV(UINT32 addr)
 {
-//	descriptor_t *sdp = &CPU_CS_DESC;	
-	FPU_SET_TOP(FPU_STAT_TOP);
-	
-//	switch ((CPU_CR0 & 1) | (SEG_IS_32BIT(sdp) ? 0x100 : 0x000))
+	FP_TOP_SET(FPU_STAT_TOP);
+
 	switch ((CPU_CR0 & 1) | (CPU_INST_OP32 ? 0x100 : 0x000))
 	{
 	case 0x000: case 0x001:
-		fpu_memorywrite_w(addr+0,FPU_CTRLWORD);
-		fpu_memorywrite_w(addr+2,FPU_STATUSWORD);
-		fpu_memorywrite_w(addr+4,FPU_GetTag());
-		fpu_memorywrite_w(addr+10,FPU_LASTINSTOP);
+		fpu_memorywrite_w(addr + 0, FPU_CTRLWORD);
+		fpu_memorywrite_w(addr + 2, FPU_STATUSWORD);
+		fpu_memorywrite_w(addr + 4, FPU_GetTag());
+		fpu_memorywrite_w(addr + 10, FPU_LASTINSTOP);
 		break;
-		
+
 	case 0x100: case 0x101:
-		fpu_memorywrite_d(addr+0,(UINT32)(FPU_CTRLWORD));
-		fpu_memorywrite_d(addr+4,(UINT32)(FPU_STATUSWORD));
-		fpu_memorywrite_d(addr+8,(UINT32)(FPU_GetTag()));	
-		fpu_memorywrite_d(addr+20,FPU_LASTINSTOP);			
+		fpu_memorywrite_d(addr + 0, (UINT32)(FPU_CTRLWORD));
+		fpu_memorywrite_d(addr + 4, (UINT32)(FPU_STATUSWORD));
+		fpu_memorywrite_d(addr + 8, (UINT32)(FPU_GetTag()));
+		fpu_memorywrite_d(addr + 20, FPU_LASTINSTOP);
 		break;
 	}
 }
-
 static void FPU_FLDENV(UINT32 addr)
 {
-//	descriptor_t *sdp = &CPU_CS_DESC;	
-	
-//	switch ((CPU_CR0 & 1) | (SEG_IS_32BIT(sdp) ? 0x100 : 0x000)) {
 	switch ((CPU_CR0 & 1) | (CPU_INST_OP32 ? 0x100 : 0x000)) {
 	case 0x000: case 0x001:
-		FPU_SetCW(fpu_memoryread_w(addr+0));
-		FPU_STATUSWORD = fpu_memoryread_w(addr+2);
-		FPU_SetTag(fpu_memoryread_w(addr+4));
-		FPU_LASTINSTOP = fpu_memoryread_w(addr+10);
+		FPU_SetCW(fpu_memoryread_w(addr + 0));
+		FPU_STATUSWORD = fpu_memoryread_w(addr + 2);
+		FPU_SetTag(fpu_memoryread_w(addr + 4));
+		FPU_LASTINSTOP = fpu_memoryread_w(addr + 10);
 		break;
-		
+
 	case 0x100: case 0x101:
-		FPU_SetCW((UINT16)fpu_memoryread_d(addr+0));
-		FPU_STATUSWORD = (UINT16)fpu_memoryread_d(addr+4);
-		FPU_SetTag((UINT16)fpu_memoryread_d(addr+8));
-		FPU_LASTINSTOP = (UINT16)fpu_memoryread_d(addr+20);		
+		FPU_SetCW((UINT16)fpu_memoryread_d(addr + 0));
+		FPU_STATUSWORD = (UINT16)fpu_memoryread_d(addr + 4);
+		FPU_SetTag((UINT16)fpu_memoryread_d(addr + 8));
+		FPU_LASTINSTOP = (UINT16)fpu_memoryread_d(addr + 20);
 		break;
 	}
-	FPU_STAT_TOP = FPU_GET_TOP();
+	FPU_STAT_TOP = FP_TOP_GET();
 }
-
 static void FPU_FSAVE(UINT32 addr)
 {
 	UINT start;
 	UINT i;
-	
-//	descriptor_t *sdp = &CPU_CS_DESC;
-	
+
 	FPU_FSTENV(addr);
-//	start = ((SEG_IS_32BIT(sdp))?28:14);
-	start = ((CPU_INST_OP32)?28:14);
-	for(i = 0;i < 8;i++){
-		FPU_ST80(addr+start,FPU_ST(i));
+	start = ((CPU_INST_OP32) ? 28 : 14);
+	for (i = 0; i < 8; i++) {
+		FPU_ST80(addr + start, FPU_ST(i));
 		start += 10;
 	}
 	FPU_FINIT();
 }
-
 static void FPU_FRSTOR(UINT32 addr)
 {
 	UINT start;
 	UINT i;
-	
-//	descriptor_t *sdp = &CPU_CS_DESC;
-	
+
 	FPU_FLDENV(addr);
-//	start = ((SEG_IS_32BIT(sdp))?28:14);
-	start = ((CPU_INST_OP32)?28:14);
-	for(i = 0;i < 8;i++){
-		FPU_FLD80(addr+start, FPU_ST(i));
+	start = ((CPU_INST_OP32) ? 28 : 14);
+	for (i = 0; i < 8; i++) {
+		FPU_FLD80(addr + start, FPU_ST(i));
 		start += 10;
 	}
 }
-
-static void FPU_FXSAVE(UINT32 addr){
+static void FPU_FXSAVE(UINT32 addr) {
 	UINT start;
 	UINT i;
-	
-//	descriptor_t *sdp = &CPU_CS_DESC;
-	
-	//FPU_FSTENV(addr);
-	FPU_SET_TOP(FPU_STAT_TOP);
-	fpu_memorywrite_w(addr+0,FPU_CTRLWORD);
-	fpu_memorywrite_w(addr+2,FPU_STATUSWORD);
-	fpu_memorywrite_b(addr+4,FPU_GetTag8());
+
+	FP_TOP_SET(FPU_STAT_TOP);
+	fpu_memorywrite_w(addr + 0, FPU_CTRLWORD);
+	fpu_memorywrite_w(addr + 2, FPU_STATUSWORD);
+	fpu_memorywrite_b(addr + 4, FPU_GetTag8());
 #ifdef USE_SSE
-	fpu_memorywrite_d(addr+24,SSE_MXCSR);
+	fpu_memorywrite_d(addr + 24, SSE_MXCSR);
 #endif
 	start = 32;
-	for(i = 0;i < 8;i++){
-		FPU_ST80(addr+start, FPU_ST(i));
+	for (i = 0; i < 8; i++) {
+		FPU_ST80(addr + start, FPU_ST(i));
 		start += 16;
 	}
 #ifdef USE_SSE
 	start = 160;
-	for(i = 0;i < 8;i++){
-		fpu_memorywrite_q(addr+start+0,SSE_XMMREG(i).ul64[0]);
-		fpu_memorywrite_q(addr+start+8,SSE_XMMREG(i).ul64[1]);
+	for (i = 0; i < 8; i++) {
+		fpu_memorywrite_q(addr + start + 0, SSE_XMMREG(i).ul64[0]);
+		fpu_memorywrite_q(addr + start + 8, SSE_XMMREG(i).ul64[1]);
 		start += 16;
 	}
 #endif
 }
-static void FPU_FXRSTOR(UINT32 addr){
+static void FPU_FXRSTOR(UINT32 addr) {
 	UINT start;
 	UINT i;
-	
-//	descriptor_t *sdp = &CPU_CS_DESC;
-	
-	//FPU_FLDENV(addr);
-	FPU_SetCW(fpu_memoryread_w(addr+0));
-	FPU_STATUSWORD = fpu_memoryread_w(addr+2);
-	FPU_SetTag8(fpu_memoryread_b(addr+4));
-	FPU_STAT_TOP = FPU_GET_TOP();
+
+	FPU_SetCW(fpu_memoryread_w(addr + 0));
+	FPU_STATUSWORD = fpu_memoryread_w(addr + 2);
+	FPU_SetTag8(fpu_memoryread_b(addr + 4));
+	FPU_STAT_TOP = FP_TOP_GET();
 #ifdef USE_SSE
-	SSE_MXCSR = fpu_memoryread_d(addr+24);
+	SSE_MXCSR = fpu_memoryread_d(addr + 24);
 #endif
 	start = 32;
-	for(i = 0;i < 8;i++){
-		FPU_FLD80(addr+start, FPU_ST(i));
+	for (i = 0; i < 8; i++) {
+		FPU_FLD80(addr + start, FPU_ST(i));
 		start += 16;
 	}
 #ifdef USE_SSE
 	start = 160;
-	for(i = 0;i < 8;i++){
-		SSE_XMMREG(i).ul64[0] = fpu_memoryread_q(addr+start+0);
-		SSE_XMMREG(i).ul64[1] = fpu_memoryread_q(addr+start+8);
+	for (i = 0; i < 8; i++) {
+		SSE_XMMREG(i).ul64[0] = fpu_memoryread_q(addr + start + 0);
+		SSE_XMMREG(i).ul64[1] = fpu_memoryread_q(addr + start + 8);
 		start += 16;
 	}
 #endif
 }
-
-void SF_FPU_FXSAVERSTOR(void){
+void SF_FPU_FXSAVERSTOR(void) {
 	UINT32 op;
 	UINT idx, sub;
 	UINT32 maddr;
@@ -935,9 +853,9 @@
 	GET_PCBYTE((op));
 	idx = (op >> 3) & 7;
 	sub = (op & 7);
-	
+
 	fpu_check_NM_EXCEPTION2(); // XXX: ç™ãíñ≥Çµ
-	switch(idx){
+	switch (idx) {
 	case 0: // FXSAVE
 		maddr = calc_ea_dst(op);
 		FPU_FXSAVE(maddr);
@@ -974,150 +892,6 @@
 	}
 }
 
-static void FPU_FXTRACT(void) {
-	// function stores real bias in st and 
-	// pushes the significant number onto the stack
-	// if double ever uses a different base please correct this function
-	FP_REG test;
-	SINT64 exp80, exp80final;
-	floatx80 mant;
-	
-	test = FPU_STAT.reg[FPU_STAT_TOP];
-	exp80 =  test.ll&QWORD_CONST(0x7ff0000000000000);
-	exp80final = (exp80>>52) - BIAS64;
-	mant = floatx80_div(test.d, c_double_to_floatx80(pow(2.0,(double)(exp80final))));
-	FPU_STAT.reg[FPU_STAT_TOP].d = int64_to_floatx80(exp80final);
-	FPU_PUSH(mant);
-}
-
-static void FPU_FCHS(void){
-	float_exception_flags = (FPU_STATUSWORD & 0x3f);
-	FPU_STAT.reg[FPU_STAT_TOP].d = floatx80_mul(c_double_to_floatx80(-1.0), FPU_STAT.reg[FPU_STAT_TOP].d);
-	FPU_STATUSWORD |= float_exception_flags;
-}
-
-static void FPU_FABS(void){
-	float_exception_flags = (FPU_STATUSWORD & 0x3f);
-	if(floatx80_le(FPU_STAT.reg[FPU_STAT_TOP].d, c_double_to_floatx80(0.0))){
-		FPU_STAT.reg[FPU_STAT_TOP].d = floatx80_mul(c_double_to_floatx80(-1.0), FPU_STAT.reg[FPU_STAT_TOP].d);
-	}
-	FPU_STATUSWORD |= float_exception_flags;
-}
-
-static void FPU_FTST(void){
-	FPU_STAT.reg[8].d = c_double_to_floatx80(0.0);
-	FPU_FCOM(FPU_STAT_TOP,8);
-}
-
-static void FPU_FLD1(void){
-	FPU_PREP_PUSH();
-	FPU_STAT.reg[FPU_STAT_TOP].d = c_double_to_floatx80(1.0);
-}
-
-static void FPU_FLDL2T(void){
-	FPU_PREP_PUSH();
-	FPU_STAT.reg[FPU_STAT_TOP].d = c_double_to_floatx80(L2T);
-}
-
-static void FPU_FLDL2E(void){
-	FPU_PREP_PUSH();
-	FPU_STAT.reg[FPU_STAT_TOP].d = c_double_to_floatx80(L2E);
-}
-
-static void FPU_FLDPI(void){
-	FPU_PREP_PUSH();
-	FPU_STAT.reg[FPU_STAT_TOP].d = c_double_to_floatx80(PI);
-}
-
-static void FPU_FLDLG2(void){
-	FPU_PREP_PUSH();
-	FPU_STAT.reg[FPU_STAT_TOP].d = c_double_to_floatx80(LG2);
-}
-
-static void FPU_FLDLN2(void){
-	FPU_PREP_PUSH();
-	FPU_STAT.reg[FPU_STAT_TOP].d = c_double_to_floatx80(LN2);
-}
-
-static void FPU_FLDZ(void){
-	FPU_PREP_PUSH();
-	FPU_STAT.reg[FPU_STAT_TOP].d = c_double_to_floatx80(0.0);
-	FPU_STAT.tag[FPU_STAT_TOP] = TAG_Zero;
-	FPU_STAT.mmxenable = 0;
-}
-
-
-static INLINE void FPU_FADD_EA(UINT op1){
-	FPU_FADD(op1,8);
-}
-static INLINE void FPU_FMUL_EA(UINT op1){
-	FPU_FMUL(op1,8);
-}
-static INLINE void FPU_FSUB_EA(UINT op1){
-	FPU_FSUB(op1,8);
-}
-static INLINE void FPU_FSUBR_EA(UINT op1){
-	FPU_FSUBR(op1,8);
-}
-static INLINE void FPU_FDIV_EA(UINT op1){
-	FPU_FDIV(op1,8);
-}
-static INLINE void FPU_FDIVR_EA(UINT op1){
-	FPU_FDIVR(op1,8);
-}
-static INLINE void FPU_FCOM_EA(UINT op1){
-	FPU_FCOM(op1,8);
-} 
- 
-/*
- * FPU interface
- */
-//int fpu_updateEmuEnv(void);
-static void
-FPU_FINIT(void)
-{
-	int i;
-	FPU_SetCW(0x37F);
-	FPU_STATUSWORD = 0;
-	FPU_STAT_TOP=FPU_GET_TOP();
-	for(i=0;i<8;i++){
-		FPU_STAT.tag[i] = TAG_Empty;
-		// ÉåÉWÉXÉ^ÇÃì‡óeÇÕè¡ÇµÇƒÇÕÇ¢ÇØÇ»Ç¢ ver0.86 rev40
-		//FPU_STAT.reg[i].d = 0;
-		//FPU_STAT.reg[i].l.lower = 0;
-		//FPU_STAT.reg[i].l.upper = 0;
-		//FPU_STAT.reg[i].ll = 0;
-	}
-	FPU_STAT.tag[8] = TAG_Valid; // is only used by us
-	FPU_STAT.mmxenable = 0;
-}
-void SF_FPU_FINIT(void){
-	int i;
-	FPU_FINIT();
-	for(i=0;i<8;i++){
-		FPU_STAT.tag[i] = TAG_Empty;
-		FPU_STAT.reg[i].l.ext = 0;
-		FPU_STAT.reg[i].l.lower = 0;
-		FPU_STAT.reg[i].l.upper = 0;
-	}
-}
-
-//char *
-//fpu_reg2str(void)
-//{
-//	return NULL;
-//}
-
-/*
- * FPU instruction
- */
-
-static void fpu_checkexception(){
-	if((FPU_STATUSWORD & ~FPU_CTRLWORD) & 0x3F){
-		EXCEPTION(MF_EXCEPTION, 0);
-	}
-}
-
 static void EA_TREE(UINT op)
 {
 	UINT idx;
@@ -1140,7 +914,7 @@
 		case 3:	/* FCOMP (íPê∏ìxé¿êî) */
 			TRACEOUT(("FCOMP EA"));
 			FPU_FCOM_EA(FPU_STAT_TOP);
-			FPU_FPOP();
+			FPU_pop();
 			break;
 		case 4:	/* FSUB (íPê∏ìxé¿êî) */
 			TRACEOUT(("FSUB EA"));
@@ -1196,7 +970,7 @@
 		case 3:	/* FCOMP */
 			TRACEOUT(("FCOMP"));
 			FPU_FCOM(FPU_STAT_TOP,FPU_ST(sub));
-			FPU_FPOP();
+			FPU_pop();
 			break;
 		case 4:	/* FSUB */
 			TRACEOUT(("FSUB"));
@@ -1248,7 +1022,7 @@
 			
 				TRACEOUT(("FLD STi"));
 				reg_from = FPU_ST(sub);
-				FPU_PREP_PUSH();
+				FPU_prepush();
 				FPU_FST(reg_from, FPU_STAT_TOP);
 			}
 			break;
@@ -1260,13 +1034,12 @@
 
 		case 2: /* FNOP */
 			TRACEOUT(("FNOP"));
-			FPU_FNOP();
 			break;
 
 		case 3: /* FSTP STi */
 			TRACEOUT(("FSTP STi"));
 			FPU_FST(FPU_STAT_TOP,FPU_ST(sub));
-			FPU_FPOP();
+			FPU_pop();
 			break;
 		
 		case 4:
@@ -1377,13 +1150,13 @@
 				
 			case 0x6:	/* FDECSTP */
 				TRACEOUT(("FDECSTP"));
-				FPU_SET_C1(0);
+				FPU_STATUSWORD &= ~FP_C1_FLAG;
 				FPU_STAT_TOP = (FPU_STAT_TOP - 1) & 7;
 				break;
 				
 			case 0x7:	/* FINCSTP */
 				TRACEOUT(("FINCSTP"));
-				FPU_SET_C1(0);
+				FPU_STATUSWORD &= ~FP_C1_FLAG;
 				FPU_STAT_TOP = (FPU_STAT_TOP + 1) & 7;
 				break;
 			}
@@ -1442,7 +1215,7 @@
 		switch (idx) {
 		case 0:	/* FLD (íPê∏ìxé¿êî) */
 			TRACEOUT(("FLD float"));
-			FPU_PREP_PUSH();
+			FPU_prepush();
 			FPU_FLD_F32(madr,FPU_STAT_TOP);
 			break;
 			
@@ -1457,7 +1230,7 @@
 		case 3:	/* FSTP (íPê∏ìxé¿êî) */
 			TRACEOUT(("FSTP float"));
 			FPU_FST_F32(madr);
-			FPU_FPOP();
+			FPU_pop();
 			break;
 
 		case 4:	/* FLDENV */
@@ -1525,8 +1298,8 @@
 			case 1: /* FUCOMPP */
 				TRACEOUT(("FUCOMPP"));
 				FPU_FUCOM(FPU_STAT_TOP,FPU_ST(1));
-				FPU_FPOP();
-				FPU_FPOP();
+				FPU_pop();
+				FPU_pop();
 				break;
 				
 			default:
@@ -1589,7 +1362,7 @@
 				
 			case 2: /* FCLEX */
 				TRACEOUT(("FCLEX"));
-				FPU_FCLEX();
+				FPU_STATUSWORD &= 0x7f00;
 				break;
 				
 			case 3: /* FNINIT/FINIT */
@@ -1599,7 +1372,7 @@
 				
 			case 4: /* FNSETPM */
 			case 5: /* FRSTPM */
-				FPU_FNOP();
+				// nop
 				break;
 				
 			default:
@@ -1622,7 +1395,7 @@
 		switch (idx) {
 		case 0:	/* FILD (DWORD) */
 			TRACEOUT(("FILD"));
-			FPU_PREP_PUSH();
+			FPU_prepush();
 			FPU_FLD_I32(madr,FPU_STAT_TOP);
 			break;
 			
@@ -1633,7 +1406,7 @@
 				FPU_FST_I32(madr);
 				float_rounding_mode = oldrnd;
 			}
-			FPU_FPOP();
+			FPU_pop();
 			break;
 			
 		case 2:	/* FIST (DWORD) */
@@ -1644,19 +1417,19 @@
 		case 3:	/* FISTP (DWORD) */
 			TRACEOUT(("FISTP"));
 			FPU_FST_I32(madr);
-			FPU_FPOP();
+			FPU_pop();
 			break;
 			
 		case 5:	/* FLD (ägí£é¿êî) */
 			TRACEOUT(("FLD 80 Bits Real"));
-			FPU_PREP_PUSH();
+			FPU_prepush();
 			FPU_FLD_F80(madr);
 			break;
 			
 		case 7:	/* FSTP (ägí£é¿êî) */
 			TRACEOUT(("FSTP 80 Bits Real"));
 			FPU_FST_F80(madr);
-			FPU_FPOP();
+			FPU_pop();
 			break;
 
 		default:
@@ -1698,7 +1471,7 @@
 		case 3: /* FCOMP */
 			TRACEOUT(("ESC4: FCOMP"));
 			FPU_FCOM(FPU_STAT_TOP,FPU_ST(sub));	
-			FPU_FPOP();
+			FPU_pop();
 			break;
 		case 4:	/* FSUBR */
 			TRACEOUT(("ESC4: FSUBR"));
@@ -1739,15 +1512,6 @@
 	idx = (op >> 3) & 7;
 	sub = (op & 7);
 	fpu_check_NM_EXCEPTION();
-	//if(op < 0xc0 && (idx==6 || idx==4)){
-	//	_ADD_EIP(-1); // XXX: ñ≥óùÇ‚ÇËñﬂÇ∑
-	//	fpu_check_NM_EXCEPTION2();
-	//	_ADD_EIP(1);
-	//}else{
-	//	_ADD_EIP(-1); // XXX: ñ≥óùÇ‚ÇËñﬂÇ∑
-	//	fpu_check_NM_EXCEPTION();
-	//	_ADD_EIP(1);
-	//}
 	if(op >= 0xc0 || (idx!=4 && idx!=6 && idx!=7)){
 		fpu_checkexception();
 	}
@@ -1771,7 +1535,7 @@
 		case 3:	/* FSTP */
 			TRACEOUT(("FSTP"));
 			FPU_FST(FPU_STAT_TOP,FPU_ST(sub));
-			FPU_FPOP();
+			FPU_pop();
 			break;
 		case 4:	/* FUCOM */
 			TRACEOUT(("FUCOM"));
@@ -1780,7 +1544,7 @@
 		case 5:	/* FUCOMP */
 			TRACEOUT(("FUCOMP"));
 			FPU_FUCOM(FPU_STAT_TOP,FPU_ST(sub));
-			FPU_FPOP();
+			FPU_pop();
 			break;
 
 		default:
@@ -1791,7 +1555,7 @@
 		switch (idx) {
 		case 0:	/* FLD (î{ê∏ìxé¿êî) */
 			TRACEOUT(("FLD double real"));
-			FPU_PREP_PUSH();
+			FPU_prepush();
 			FPU_FLD_F64(madr,FPU_STAT_TOP);
 			break;
 		case 1:	/* FISTTP (QWORD) */
@@ -1801,7 +1565,7 @@
 				FPU_FST_I64(madr);
 				float_rounding_mode = oldrnd;
 			}
-			FPU_FPOP();
+			FPU_pop();
 			break;
 		case 2:	/* FST (î{ê∏ìxé¿êî) */
 			TRACEOUT(("FST double real"));
@@ -1810,7 +1574,7 @@
 		case 3:	/* FSTP (î{ê∏ìxé¿êî) */
 			TRACEOUT(("FSTP double real"));
 			FPU_FST_F64(madr);
-			FPU_FPOP();
+			FPU_pop();
 			break;
 		case 4:	/* FRSTOR */
 			TRACEOUT(("FRSTOR"));
@@ -1822,8 +1586,7 @@
 			break;
 
 		case 7:	/* FSTSW */
-			FPU_SET_TOP(FPU_STAT_TOP);
-			//cpu_vmemorywrite_w(CPU_INST_SEGREG_INDEX, madr, FPU_CTRLWORD);
+			FP_TOP_SET(FPU_STAT_TOP);
 			cpu_vmemorywrite_w(CPU_INST_SEGREG_INDEX, madr, FPU_STATUSWORD);
 			break;
 
@@ -1869,7 +1632,7 @@
 				return;
 			}
 			FPU_FCOM(FPU_STAT_TOP,FPU_ST(1));
-			FPU_FPOP(); /* extra pop at the bottom*/
+			FPU_pop(); /* extra pop at the bottom*/
 			break;			
 		case 4:	/* FSUBRP */
 			TRACEOUT(("FSUBRP"));
@@ -1897,7 +1660,7 @@
 		default:
 			break;
 		}
-		FPU_FPOP();
+		FPU_pop();
 	} else {
 		madr = calc_ea_dst(op);
 		FPU_FLD_I16_EA(madr);
@@ -1929,7 +1692,7 @@
 			TRACEOUT(("FFREEP"));
 			FPU_STAT.tag[FPU_ST(sub)]=TAG_Empty;
 			FPU_STAT.mmxenable = 0;
-			FPU_FPOP();
+			FPU_pop();
 			break;
 		case 1: /* FXCH */
 			TRACEOUT(("FXCH"));
@@ -1940,7 +1703,7 @@
 		case 3: /* FSTP */
 			TRACEOUT(("FSTP"));
 			FPU_FST(FPU_STAT_TOP,FPU_ST(sub));
-			FPU_FPOP();
+			FPU_pop();
 			break;
 
 		case 4:
@@ -1948,7 +1711,7 @@
 			{
 			case 0: /* FSTSW AX */
 				TRACEOUT(("FSTSW AX"));
-				FPU_SET_TOP(FPU_STAT_TOP);
+				FP_TOP_SET(FPU_STAT_TOP);
 				CPU_AX = FPU_STATUSWORD;
 				break;
 				
@@ -1959,12 +1722,12 @@
 		case 5: /* FUCOMIP */
 			TRACEOUT(("ESC7: FUCOMIP"));
 			FPU_FUCOMI(FPU_STAT_TOP,FPU_ST(sub));	
-			FPU_FPOP();
+			FPU_pop();
 			break;
 		case 6: /* FCOMIP */
 			TRACEOUT(("ESC7: FCOMIP"));
 			FPU_FCOMI(FPU_STAT_TOP,FPU_ST(sub));	
-			FPU_FPOP();
+			FPU_pop();
 			break;
 		default:
 			break;
@@ -1974,7 +1737,7 @@
 		switch (idx) {
 		case 0:	/* FILD (WORD) */
 			TRACEOUT(("FILD SINT16"));
-			FPU_PREP_PUSH();
+			FPU_prepush();
 			FPU_FLD_I16(madr,FPU_STAT_TOP);
 			break;
 		case 1:	/* FISTTP (WORD) */
@@ -1984,7 +1747,7 @@
 				FPU_FST_I16(madr);
 				float_rounding_mode = oldrnd;
 			}
-			FPU_FPOP();
+			FPU_pop();
 			break;
 		case 2:	/* FIST (WORD) */
 			TRACEOUT(("FIST SINT16"));
@@ -1993,31 +1756,31 @@
 		case 3:	/* FISTP (WORD) */
 			TRACEOUT(("FISTP SINT16"));
 			FPU_FST_I16(madr);
-			FPU_FPOP();
+			FPU_pop();
 			break;
 
 		case 4:	/* FBLD (BCD) */
 			TRACEOUT(("FBLD packed BCD"));
-			FPU_PREP_PUSH();
+			FPU_prepush();
 			FPU_FBLD(madr,FPU_STAT_TOP);
 			break;
 
 		case 5:	/* FILD (QWORD) */
 			TRACEOUT(("FILD SINT64"));
-			FPU_PREP_PUSH();
+			FPU_prepush();
 			FPU_FLD_I64(madr,FPU_STAT_TOP);
 			break;
 
 		case 6:	/* FBSTP (BCD) */
 			TRACEOUT(("FBSTP packed BCD"));
 			FPU_FBST(madr);
-			FPU_FPOP();
+			FPU_pop();
 			break;
 
 		case 7:	/* FISTP (QWORD) */
 			TRACEOUT(("FISTP SINT64"));
 			FPU_FST_I64(madr);
-			FPU_FPOP();
+			FPU_pop();
 			break;
 
 		default:
diff -ruN source/src/vm/np21/i386c/ia32/instructions/fpu/softfloat/softfloat-macros.h src/vm/np21/i386c/ia32/instructions/fpu/softfloat/softfloat-macros.h
--- source/src/vm/np21/i386c/ia32/instructions/fpu/softfloat/softfloat-macros.h	2025-04-28 16:00:00
+++ src/vm/np21/i386c/ia32/instructions/fpu/softfloat/softfloat-macros.h	2025-04-28 22:36:36
@@ -444,10 +444,10 @@
     bits32 aHigh, aLow, bHigh, bLow;
     bits64 z0, zMiddleA, zMiddleB, z1;
 
-    aLow = (bits32) a;
-    aHigh = (bits32) (a>>32);
-    bLow = (bits32) b;
-    bHigh = (bits32) (b>>32);
+    aLow = a;
+    aHigh = a>>32;
+    bLow = b;
+    bHigh = b>>32;
     z1 = ( (bits64) aLow ) * bLow;
     zMiddleA = ( (bits64) aLow ) * bHigh;
     zMiddleB = ( (bits64) aHigh ) * bLow;
@@ -654,7 +654,7 @@
     else {
         a >>= 32;
     }
-    shiftCount += countLeadingZeros32( (bits32) a );
+    shiftCount += countLeadingZeros32( a );
     return shiftCount;
 
 }
diff -ruN source/src/vm/np21/i386c/ia32/instructions/fpu/softfloat/softfloat.cpp src/vm/np21/i386c/ia32/instructions/fpu/softfloat/softfloat.cpp
--- source/src/vm/np21/i386c/ia32/instructions/fpu/softfloat/softfloat.cpp	2025-04-28 16:00:00
+++ src/vm/np21/i386c/ia32/instructions/fpu/softfloat/softfloat.cpp	2025-04-28 22:36:36
@@ -104,7 +104,7 @@
     roundBits = absZ & 0x7F;
     absZ = ( absZ + roundIncrement )>>7;
     absZ &= ~ ( ( ( roundBits ^ 0x40 ) == 0 ) & roundNearestEven );
-    z = (int32) absZ;
+    z = absZ;
     if ( zSign ) z = - z;
     z = (sbits32) z;
     if ( ( absZ>>32 ) || ( z && ( ( z < 0 ) ^ zSign ) ) ) {
@@ -656,7 +656,7 @@
     }
     if ( roundBits ) float_exception_flags |= float_flag_inexact;
     zSig0 += roundIncrement;
-    if ( zSig0 < (bits64) roundIncrement ) {
+    if ( zSig0 < roundIncrement ) {
         ++zExp;
         zSig0 = LIT64( 0x8000000000000000 );
     }
@@ -1151,7 +1151,7 @@
     absA = zSign ? - a : a;
     shiftCount = countLeadingZeros64( absA ) - 40;
     if ( 0 <= shiftCount ) {
-        return packFloat32( zSign, 0x95 - shiftCount, (bits32) (absA<<shiftCount) );
+        return packFloat32( zSign, 0x95 - shiftCount, absA<<shiftCount );
     }
     else {
         shiftCount += 7;
@@ -1161,7 +1161,7 @@
         else {
             absA <<= shiftCount;
         }
-        return roundAndPackFloat32( zSign, 0x9C - shiftCount, (bits32) absA );
+        return roundAndPackFloat32( zSign, 0x9C - shiftCount, absA );
     }
 
 }
@@ -1788,7 +1788,7 @@
     aSig = ( aSig | 0x00800000 )<<7;
     bSig = ( bSig | 0x00800000 )<<8;
     shift64RightJamming( ( (bits64) aSig ) * bSig, 32, &zSig64 );
-    zSig = (bits32) zSig64;
+    zSig = zSig64;
     if ( 0 <= (sbits32) ( zSig<<1 ) ) {
         zSig <<= 1;
         --zExp;
@@ -1934,13 +1934,13 @@
         while ( 0 < expDiff ) {
             q64 = estimateDiv128To64( aSig64, 0, bSig64 );
             q64 = ( 2 < q64 ) ? q64 - 2 : 0;
-            aSig64 = - (sbits64) ( ( bSig * q64 )<<38 );
+            aSig64 = - ( ( bSig * q64 )<<38 );
             expDiff -= 62;
         }
         expDiff += 64;
         q64 = estimateDiv128To64( aSig64, 0, bSig64 );
         q64 = ( 2 < q64 ) ? q64 - 2 : 0;
-        q = (bits32) (q64>>( 64 - expDiff ));
+        q = q64>>( 64 - expDiff );
         bSig <<= 6;
         aSig = ( ( aSig64>>33 )<<( expDiff - 1 ) ) - bSig * q;
     }
@@ -1954,7 +1954,7 @@
         aSig = alternateASig;
     }
     zSign = ( (sbits32) aSig < 0 );
-    if ( zSign ) aSig = - (sbits32) aSig;
+    if ( zSign ) aSig = - aSig;
     return normalizeRoundAndPackFloat32( aSign ^ zSign, bExp, aSig );
 
 }
@@ -2211,7 +2211,7 @@
     shiftCount = 0x433 - aExp;
     savedASig = aSig;
     aSig >>= shiftCount;
-    z = (int32) aSig;
+    z = aSig;
     if ( aSign ) z = - z;
     z = (sbits32) z;
     if ( ( z < 0 ) ^ aSign ) {
@@ -2340,7 +2340,7 @@
         return packFloat32( aSign, 0xFF, 0 );
     }
     shift64RightJamming( aSig, 22, &aSig );
-    zSig = (bits32) aSig;
+    zSig = aSig;
     if ( aExp || zSig ) {
         zSig |= 0x40000000;
         aExp -= 0x381;
@@ -2846,7 +2846,7 @@
     while ( 0 < expDiff ) {
         q = estimateDiv128To64( aSig, 0, bSig );
         q = ( 2 < q ) ? q - 2 : 0;
-        aSig = - (sbits64) ( ( bSig>>2 ) * q );
+        aSig = - ( ( bSig>>2 ) * q );
         expDiff -= 62;
     }
     expDiff += 64;
@@ -2871,7 +2871,7 @@
         aSig = alternateASig;
     }
     zSign = ( (sbits64) aSig < 0 );
-    if ( zSign ) aSig = - (sbits64) aSig;
+    if ( zSign ) aSig = - aSig;
     return normalizeRoundAndPackFloat64( aSign ^ zSign, bExp, aSig );
 
 }
@@ -2910,7 +2910,7 @@
     }
     zExp = ( ( aExp - 0x3FF )>>1 ) + 0x3FE;
     aSig |= LIT64( 0x0010000000000000 );
-    zSig = estimateSqrt32( aExp, (bits32) (aSig>>21) );
+    zSig = estimateSqrt32( aExp, aSig>>21 );
     aSig <<= 9 - ( aExp & 1 );
     zSig = estimateDiv128To64( aSig, 0, zSig<<32 ) + ( zSig<<30 );
     if ( ( zSig & 0x1FF ) <= 5 ) {
@@ -3128,7 +3128,7 @@
     shiftCount = 0x403E - aExp;
     savedASig = aSig;
     aSig >>= shiftCount;
-    z = (int32) aSig;
+    z = aSig;
     if ( aSign ) z = - z;
     z = (sbits32) z;
     if ( ( z < 0 ) ^ aSign ) {
@@ -3251,7 +3251,7 @@
     }
     shift64RightJamming( aSig, 33, &aSig );
     if ( aExp || aSig ) aExp -= 0x3F81;
-    return roundAndPackFloat32( aSign, aExp, (bits32) aSig );
+    return roundAndPackFloat32( aSign, aExp, aSig );
 
 }
 
diff -ruN source/src/vm/np21/i386c/ia32/instructions/misc_inst.cpp src/vm/np21/i386c/ia32/instructions/misc_inst.cpp
--- source/src/vm/np21/i386c/ia32/instructions/misc_inst.cpp	2025-04-28 16:00:00
+++ src/vm/np21/i386c/ia32/instructions/misc_inst.cpp	2025-04-28 22:36:36
@@ -149,21 +149,17 @@
 		break;
 
 	case 0x80000001:
-		if (strncmp(i386cpuid.cpu_vendor, CPU_VENDOR_AMD, 12) == 0)
-		{ // AMDîªíË
-			if (i386cpuid.cpu_family >= 6 || (i386cpuid.cpu_family == 5 && i386cpuid.cpu_model >= 6))
-			{
-				CPU_EAX = ((i386cpuid.cpu_family + 1) << 8) | (i386cpuid.cpu_model << 4) | i386cpuid.cpu_stepping;
-			}
-			else
-			{
+		if(strncmp(i386cpuid.cpu_vendor, CPU_VENDOR_AMD, 12)==0){ // AMDîªíË
+			if(i386cpuid.cpu_family >= 6 || (i386cpuid.cpu_family==5 && i386cpuid.cpu_model >= 6)){
+				CPU_EAX = ((i386cpuid.cpu_family+1) << 8) | (i386cpuid.cpu_model << 4) | i386cpuid.cpu_stepping;
+			}else{
 				CPU_EAX = (i386cpuid.cpu_family << 8) | (i386cpuid.cpu_model << 4) | i386cpuid.cpu_stepping;
 			}
 		}else{
 			CPU_EAX = 0;
 		}
 		CPU_EBX = 0;
-		CPU_ECX = i386cpuid.cpu_feature_ex_ecx & CPU_FEATURES_EX_ECX_ALL;
+		CPU_ECX = 0;
 		CPU_EDX = i386cpuid.cpu_feature_ex & CPU_FEATURES_EX_ALL;
 		break;
 		
@@ -241,14 +237,9 @@
 	}else if(insttable_2byteF30F_32[op] && CPU_INST_REPUSE == 0xf3){
 		(*insttable_2byteF30F_32[op])();
 		return;
-	}else{
-		(*insttable_2byte[0][op])();
-		return;
 	}
-#else
-	(*insttable_2byte[0][op])();
 #endif
-	//(*insttable_2byte[0][op])();
+	(*insttable_2byte[0][op])();
 }
 
 void
@@ -267,95 +258,9 @@
 	}else if(insttable_2byteF30F_32[op] && CPU_INST_REPUSE == 0xf3){
 		(*insttable_2byteF30F_32[op])();
 		return;
-	}else{
-		(*insttable_2byte[1][op])();
-		return;
 	}
-#else
-	(*insttable_2byte[1][op])();
 #endif
-	//(*insttable_2byte[1][op])();
-}
-
-void
-_3byte_38ESC(void)
-{
-#ifdef USE_SSSE3
-	UINT32 op;
-
-	if(!(i386cpuid.cpu_feature_ecx & CPU_FEATURE_ECX_SSSE3)){
-		EXCEPTION(UD_EXCEPTION, 0);
-	} else {
-		GET_PCBYTE(op);
-		if(insttable_3byte660F38_32[op] && CPU_INST_OP32 == !CPU_STATSAVE.cpu_inst_default.op_32){
-			(*insttable_3byte660F38_32[op])();
-			return;
-		}else if(insttable_3byteF20F38_32[op] && CPU_INST_REPUSE == 0xf2){
-			(*insttable_3byteF20F38_32[op])();
-			return;
-		}else if(insttable_2byte0F38_32[op]){
-			(*insttable_2byte0F38_32[op])();
-			return;
-		}else{
-			EXCEPTION(UD_EXCEPTION, 0);
-		}
-	}
-#else
-	EXCEPTION(UD_EXCEPTION, 0);
-#endif
-}
-
-void
-_3byte_38ESC_16(void)
-{
-#ifdef USE_SSSE3
-	UINT32 op;
-
-	if(!(i386cpuid.cpu_feature_ecx & CPU_FEATURE_ECX_SSSE3)){
-		EXCEPTION(UD_EXCEPTION, 0);
-	} else {
-		GET_PCBYTE(op);
-		if(insttable_3byte660F38_32[op] && CPU_INST_OP32 == !CPU_STATSAVE.cpu_inst_default.op_32){
-			(*insttable_3byte660F38_32[op])();
-			return;
-		}else if(insttable_3byteF20F38_16[op] && CPU_INST_REPUSE == 0xf2){
-			(*insttable_3byteF20F38_16[op])();
-			return;
-		}else if(insttable_2byte0F38_32[op]){
-			(*insttable_2byte0F38_32[op])();
-			return;
-		}else{
-			EXCEPTION(UD_EXCEPTION, 0);
-		}
-	}
-#else
-	EXCEPTION(UD_EXCEPTION, 0);
-#endif
-}
-
-void
-_3byte_3AESC(void)
-{
-#ifdef USE_SSSE3
-	UINT32 op;
-
-	if(!(i386cpuid.cpu_feature_ecx & CPU_FEATURE_ECX_SSSE3)){
-		EXCEPTION(UD_EXCEPTION, 0);
-	} else {
-		GET_PCBYTE(op);
-		if(insttable_3byte660F3A_32[op] && CPU_INST_OP32 == !CPU_STATSAVE.cpu_inst_default.op_32){
-			(*insttable_3byte660F3A_32[op])();
-			return;
-		}else if(insttable_2byte0F3A_32[op]){
-			(*insttable_2byte0F3A_32[op])();
-			return;
-		}else{
-			EXCEPTION(UD_EXCEPTION, 0);
-		}
-	}
-#else
-	EXCEPTION(UD_EXCEPTION, 0);
-#endif
+	(*insttable_2byte[1][op])();
 }
 
 void
diff -ruN source/src/vm/np21/i386c/ia32/instructions/misc_inst.h src/vm/np21/i386c/ia32/instructions/misc_inst.h
--- source/src/vm/np21/i386c/ia32/instructions/misc_inst.h	2025-04-28 16:00:00
+++ src/vm/np21/i386c/ia32/instructions/misc_inst.h	2025-04-28 22:36:36
@@ -45,9 +45,6 @@
 void AddrSize(void);
 void _2byte_ESC16(void);
 void _2byte_ESC32(void);
-void _3byte_38ESC(void);
-void _3byte_38ESC_16(void);
-void _3byte_3AESC(void);
 void Prefix_ES(void);
 void Prefix_CS(void);
 void Prefix_SS(void);
diff -ruN source/src/vm/np21/i386c/ia32/instructions/mmx/3dnow.cpp src/vm/np21/i386c/ia32/instructions/mmx/3dnow.cpp
--- source/src/vm/np21/i386c/ia32/instructions/mmx/3dnow.cpp	2025-04-28 16:00:00
+++ src/vm/np21/i386c/ia32/instructions/mmx/3dnow.cpp	2025-04-28 22:36:36
@@ -34,7 +34,7 @@
 
 #if defined(USE_3DNOW) && defined(USE_MMX) && defined(USE_FPU)
 
-#define CPU_MMXWORKCLOCK(a)	CPU_WORKCLOCK(2)
+#define CPU_MMXWORKCLOCK(a)	CPU_WORKCLOCK(8)
 
 // 3DNow!
 void AMD3DNOW_PAVGUSB_REG(UINT8 reg1, UINT8 reg2);
diff -ruN source/src/vm/np21/i386c/ia32/instructions/mmx/mmx.cpp src/vm/np21/i386c/ia32/instructions/mmx/mmx.cpp
--- source/src/vm/np21/i386c/ia32/instructions/mmx/mmx.cpp	2025-04-28 16:00:00
+++ src/vm/np21/i386c/ia32/instructions/mmx/mmx.cpp	2025-04-28 22:36:36
@@ -32,7 +32,7 @@
 
 #if defined(USE_MMX) && defined(USE_FPU)
 
-#define CPU_MMXWORKCLOCK	CPU_WORKCLOCK(2)
+#define CPU_MMXWORKCLOCK	CPU_WORKCLOCK(6)
 
 static INLINE void
 MMX_check_NM_EXCEPTION(){
diff -ruN source/src/vm/np21/i386c/ia32/instructions/sse/sse.cpp src/vm/np21/i386c/ia32/instructions/sse/sse.cpp
--- source/src/vm/np21/i386c/ia32/instructions/sse/sse.cpp	2025-04-28 16:00:00
+++ src/vm/np21/i386c/ia32/instructions/sse/sse.cpp	2025-04-28 22:36:36
@@ -37,7 +37,7 @@
 
 #if defined(USE_SSE) && defined(USE_FPU)
 
-#define CPU_SSEWORKCLOCK	CPU_WORKCLOCK(2)
+#define CPU_SSEWORKCLOCK	CPU_WORKCLOCK(8)
 
 static INLINE void
 SSE_check_NM_EXCEPTION(){
diff -ruN source/src/vm/np21/i386c/ia32/instructions/sse2/sse2.cpp src/vm/np21/i386c/ia32/instructions/sse2/sse2.cpp
--- source/src/vm/np21/i386c/ia32/instructions/sse2/sse2.cpp	2025-04-28 16:00:00
+++ src/vm/np21/i386c/ia32/instructions/sse2/sse2.cpp	2025-04-28 22:36:36
@@ -60,7 +60,7 @@
 
 #if defined(USE_SSE2) && defined(USE_SSE) && defined(USE_FPU)
 
-#define CPU_SSE2WORKCLOCK	CPU_WORKCLOCK(2)
+#define CPU_SSE2WORKCLOCK	CPU_WORKCLOCK(8)
 
 static INLINE void
 SSE2_check_NM_EXCEPTION(){
@@ -3252,18 +3252,6 @@
 	EXCEPTION(UD_EXCEPTION, 0);
 }
 void SSE2_PSHUFD(void)
-{
-	EXCEPTION(UD_EXCEPTION, 0);
-}
-void SSE2_PSxxWimm(void)
-{
-	EXCEPTION(UD_EXCEPTION, 0);
-}
-void SSE2_PSxxDimm(void)
-{
-	EXCEPTION(UD_EXCEPTION, 0);
-}
-void SSE2_PSxxQimm(void)
 {
 	EXCEPTION(UD_EXCEPTION, 0);
 }
diff -ruN source/src/vm/np21/i386c/ia32/instructions/sse3/sse3.cpp src/vm/np21/i386c/ia32/instructions/sse3/sse3.cpp
--- source/src/vm/np21/i386c/ia32/instructions/sse3/sse3.cpp	2025-04-28 16:00:00
+++ src/vm/np21/i386c/ia32/instructions/sse3/sse3.cpp	2025-04-28 22:36:36
@@ -39,7 +39,7 @@
 
 #if defined(USE_SSE3) && defined(USE_SSE2) && defined(USE_SSE) && defined(USE_FPU)
 
-#define CPU_SSE3WORKCLOCK	CPU_WORKCLOCK(2)
+#define CPU_SSE3WORKCLOCK	CPU_WORKCLOCK(8)
 
 static INLINE void
 SSE3_check_NM_EXCEPTION(){
diff -ruN source/src/vm/np21/i386c/ia32/instructions/sse4/sse4_1.cpp src/vm/np21/i386c/ia32/instructions/sse4/sse4_1.cpp
--- source/src/vm/np21/i386c/ia32/instructions/sse4/sse4_1.cpp	2025-04-28 16:00:00
+++ src/vm/np21/i386c/ia32/instructions/sse4/sse4_1.cpp	1970-01-01 09:00:00
@@ -1,1361 +0,0 @@
-/*
- * Copyright (c) 2024 Gocaine Project
- * All rights reserved.
- *
- * Redistribution and use in source and binary forms, with or without
- * modification, are permitted provided that the following conditions
- * are met:
- * 1. Redistributions of source code must retain the above copyright
- *    notice, this list of conditions and the following disclaimer.
- * 2. Redistributions in binary form must reproduce the above copyright
- *    notice, this list of conditions and the following disclaimer in the
- *    documentation and/or other materials provided with the distribution.
- *
- * THIS SOFTWARE IS PROVIDED BY THE AUTHOR ``AS IS'' AND ANY EXPRESS OR
- * IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES
- * OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED.
- * IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY DIRECT, INDIRECT,
- * INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT
- * NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,
- * DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY
- * THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
- * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF
- * THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
- */
-
-//#include "compiler.h"
-
-#include <math.h>
-#include <float.h>
-
-#define isnan(x) (_isnan(x))
-
-#include "../../cpu.h"
-#include "../../ia32.mcr"
-
-#include "../sse/sse.h"
-#include "../sse2/sse2.h"
-#include "../sse3/sse3.h"
-#include "../ssse3/ssse3.h"
-#include "sse4_1.h"
-
-#if defined(USE_SSE4_1) && defined(USE_SSSE3) && defined(USE_SSE3) && defined(USE_SSE2) && defined(USE_SSE) && defined(USE_FPU)
-
-#define CPU_SSSE3WORKCLOCK	CPU_WORKCLOCK(2)
-
-static INLINE void
-SSE4_1_check_NM_EXCEPTION(){
-	// SSE4.1Ç»ÇµÇ»ÇÁUD(ñ≥å¯ÉIÉyÉRÅ[Éhó·äO)Çî≠ê∂Ç≥ÇπÇÈ
-	if(!(i386cpuid.cpu_feature_ecx & CPU_FEATURE_ECX_SSE4_1)){
-		EXCEPTION(UD_EXCEPTION, 0);
-	}
-	// ÉGÉ~ÉÖÉåÅ[ÉVÉáÉìÇ»ÇÁUD(ñ≥å¯ÉIÉyÉRÅ[Éhó·äO)Çî≠ê∂Ç≥ÇπÇÈ
-	if(CPU_CR0 & CPU_CR0_EM){
-		EXCEPTION(UD_EXCEPTION, 0);
-	}
-	// É^ÉXÉNÉXÉCÉbÉ`éûÇ…NM(ÉfÉoÉCÉXégópïsâ¬ó·äO)Çî≠ê∂Ç≥ÇπÇÈ
-	if (CPU_CR0 & CPU_CR0_TS) {
-		EXCEPTION(NM_EXCEPTION, 0);
-	}
-}
-
-static INLINE void
-SSE4_1_setTag(void)
-{
-}
-
-// mmx.cÇÃÇ‡ÇÃÇ∆ìØÇ∂
-static INLINE void
-MMX_setTag(void)
-{
-	int i;
-	
-	if(!FPU_STAT.mmxenable){
-		FPU_STAT.mmxenable = 1;
-		//FPU_CTRLWORD = 0x27F;
-		for (i = 0; i < FPU_REG_NUM; i++) {
-			FPU_STAT.tag[i] = TAG_Valid;
-#ifdef SUPPORT_FPU_DOSBOX2
-			FPU_STAT.int_regvalid[i] = 0;
-#endif
-			FPU_STAT.reg[i].ul.ext = 0xffff;
-		}
-	}
-	FPU_STAT_TOP = 0;
-	FPU_STATUSWORD &= ~0x3800;
-	FPU_STATUSWORD |= (FPU_STAT_TOP&7)<<11;
-}
-
-
-static INLINE float NEARBYINTF(float val)
-{
-	float floorval;
-	floorval = floorf(val);
-	if (val - floorval > 0.5f){
-		return (floorval + 1); // êÿÇËè„Ç∞
-	}else if (val - floorval < 0.5f){
-		return (floorval); // êÿÇËéÃÇƒ
-	}else{
-		if(floor(floorval / 2) == floorval/2){
-			return (floorval); // ãÙêî
-		}else{
-			return (floorval+1); // äÔêî
-		}
-	}
-}
-static INLINE float TRUNCF(float val)
-{
-	if(val < 0){
-		return ceilf(val); // É[Éçï˚å¸Ç÷ÇÃêÿÇËéÃÇƒ
-	}else{
-		return floorf(val); // É[Éçï˚å¸Ç÷ÇÃêÿÇËéÃÇƒ
-	}
-}
-static INLINE double NEARBYINT(double val)
-{
-	double floorval;
-	floorval = floor(val);
-	if (val - floorval > 0.5f){
-		return (floorval + 1); // êÿÇËè„Ç∞
-	}else if (val - floorval < 0.5f){
-		return (floorval); // êÿÇËéÃÇƒ
-	}else{
-		if(floor(floorval / 2) == floorval/2){
-			return (floorval); // ãÙêî
-		}else{
-			return (floorval+1); // äÔêî
-		}
-	}
-}
-static INLINE double TRUNC(double val)
-{
-	if(val < 0){
-		return ceil(val); // É[Éçï˚å¸Ç÷ÇÃêÿÇËéÃÇƒ
-	}else{
-		return floor(val); // É[Éçï˚å¸Ç÷ÇÃêÿÇËéÃÇƒ
-	}
-}
-
-/*
- * SSE3 interface
- */
-
-// ÉRÅ[ÉhÇ™í∑Ç≠Ç»ÇÈÇÃÇ≈Ç‚Ç‚ã≠à¯Ç…ã§í âª
-// xmm/m128 -> xmm
-static INLINE void SSE_PART_GETDATA1DATA2_PD(double **data1, double **data2, double *data2buf){
-	UINT32 op;
-	UINT idx, sub;
-	
-	SSE4_1_check_NM_EXCEPTION();
-	SSE4_1_setTag();
-	CPU_SSSE3WORKCLOCK;
-	GET_PCBYTE((op));
-	idx = (op >> 3) & 7;
-	sub = (op & 7);
-	*data1 = (double*)(&(FPU_STAT.xmm_reg[idx]));
-	if ((op) >= 0xc0) {
-		*data2 = (double*)(&(FPU_STAT.xmm_reg[sub]));
-	} else {
-		UINT32 maddr;
-		maddr = calc_ea_dst((op));
-		*((UINT64*)(data2buf+ 0)) = cpu_vmemoryread_q(CPU_INST_SEGREG_INDEX, maddr+ 0);
-		*((UINT64*)(data2buf+ 1)) = cpu_vmemoryread_q(CPU_INST_SEGREG_INDEX, maddr+ 8);
-		*data2 = data2buf;
-	}
-}
-
-static INLINE void SSE_PART_GETDATA1DATA2_P_UINT32(UINT32 **data1, UINT32 **data2, UINT32 *data2buf){
-	SSE_PART_GETDATA1DATA2_PD((double**)data1, (double**)data2, (double*)data2buf);
-}
-static INLINE void SSE_PART_GETDATA1DATA2_PD_UINT64(UINT64 **data1, UINT64 **data2, UINT64 *data2buf){
-	SSE_PART_GETDATA1DATA2_PD((double**)data1, (double**)data2, (double*)data2buf);
-}
-
-static INLINE UINT32 SSE_PART_GETDATA1DATA2_PD_MODRM(double **data1, double **data2, double *data2buf){
-	UINT32 op;
-	UINT idx, sub;
-	
-	SSE4_1_check_NM_EXCEPTION();
-	SSE4_1_setTag();
-	CPU_SSSE3WORKCLOCK;
-	GET_PCBYTE((op));
-	idx = (op >> 3) & 7;
-	sub = (op & 7);
-	*data1 = (double*)(&(FPU_STAT.xmm_reg[idx]));
-	if ((op) >= 0xc0) {
-		*data2 = (double*)(&(FPU_STAT.xmm_reg[sub]));
-	} else {
-		UINT32 maddr;
-		maddr = calc_ea_dst((op));
-		*((UINT64*)(data2buf+ 0)) = cpu_vmemoryread_q(CPU_INST_SEGREG_INDEX, maddr+ 0);
-		*((UINT64*)(data2buf+ 1)) = cpu_vmemoryread_q(CPU_INST_SEGREG_INDEX, maddr+ 8);
-		*data2 = data2buf;
-	}
-	return op;
-}
-
-static INLINE void MMX_PART_GETDATA1DATA2_PD(float **data1, float **data2, float *data2buf){
-	UINT32 op;
-	UINT idx, sub;
-	
-	SSE4_1_check_NM_EXCEPTION();
-	SSE4_1_setTag();
-	CPU_SSSE3WORKCLOCK;
-	GET_PCBYTE((op));
-	idx = (op >> 3) & 7;
-	sub = (op & 7);
-	*data1 = (float*)(&(FPU_STAT.reg[idx]));
-	if ((op) >= 0xc0) {
-		*data2 = (float*)(&(FPU_STAT.reg[sub]));
-	} else {
-		UINT32 maddr;
-		maddr = calc_ea_dst((op));
-		*((UINT32*)(data2buf+ 0)) = cpu_vmemoryread_d(CPU_INST_SEGREG_INDEX, maddr);
-		*((UINT32*)(data2buf+ 1)) = cpu_vmemoryread_d(CPU_INST_SEGREG_INDEX, maddr + 4);
-		*data2 = data2buf;
-	}
-}
-
-void SSE4_1_PBLENDVB(void)
-{
-	int i;
-
-	UINT8 data2buf[16];
-	UINT8 *data1, *data2;
-	SSE_PART_GETDATA1DATA2_PD((double**)(&data1), (double**)(&data2), (double*)data2buf);
-	for(i=0;i<16;i++){
-		if (FPU_STAT.xmm_reg[0].ul8[i]&128){
-			data1[i] = data2[i];
-		} else {
-			data1[i] = data1[i];
-		}
-	}
-	TRACEOUT(("SSE4_1_PBLENDVB"));
-}
-
-void SSE4_1_BLENDVPS(void)
-{
-	int i;
-
-	UINT32 data2buf[4];
-	UINT32 *data1, *data2;
-	SSE_PART_GETDATA1DATA2_PD((double**)(&data1), (double**)(&data2), (double*)data2buf);
-	for(i=0;i<4;i++){
-		if (FPU_STAT.xmm_reg[0].ul32[i]&((UINT32)0x80000000)){
-			data1[i] = data2[i];
-		} else {
-			data1[i] = data1[i];
-		}
-	}
-	TRACEOUT(("SSE4_1_BLENDVPS"));
-}
-
-void SSE4_1_BLENDVPD(void)
-{
-	int i;
-
-	UINT64 data2buf[2];
-	UINT64 *data1, *data2;
-	SSE_PART_GETDATA1DATA2_PD((double**)(&data1), (double**)(&data2), (double*)data2buf);
-	for(i=0;i<2;i++){
-		if (FPU_STAT.xmm_reg[0].ul32[i]&((UINT64)0x8000000000000000)){
-			data1[i] = data2[i];
-		} else {
-			data1[i] = data1[i];
-		}
-	}
-	TRACEOUT(("SSE4_1_BLENDVPD"));
-}
-
-void SSE4_1_VPTEST(void)
-{
-	UINT64 data2buf[2];
-	UINT64 *data1, *data2;
-	SSE_PART_GETDATA1DATA2_PD((double**)(&data1), (double**)(&data2), (double*)data2buf);
-	if ((data1[0] & data2[0]) == 0 && (data1[1] & data2[1]) == 0){
-		CPU_FLAG |=  Z_FLAG;
-		CPU_FLAG &= ~C_FLAG;
-	} else {
-		CPU_FLAG &= ~Z_FLAG;
-		CPU_FLAG |=  C_FLAG;
-	}
-	TRACEOUT(("SSE4_1_VPTEST"));
-}
-
-void SSE4_1_PMOVSXBW(void)
-{
-	int i;
-
-	SINT8 data2buf[16];
-	SINT8 *data1, *data2;
-	SSE_PART_GETDATA1DATA2_PD((double**)(&data1), (double**)(&data2), (double*)data2buf);
-	for(i=0;i<8;i++){
-		*((SINT16*)(data1 + (i * 2))) = (SINT16)data2[i];
-	}
-	TRACEOUT(("SSE4_1_PMOVSXBW"));
-}
-
-void SSE4_1_PMOVSXBD(void)
-{
-	int i;
-
-	SINT8 data2buf[16];
-	SINT8 *data1, *data2;
-	SSE_PART_GETDATA1DATA2_PD((double**)(&data1), (double**)(&data2), (double*)data2buf);
-	for(i=0;i<4;i++){
-		*((SINT32*)(data1 + (i * 4))) = (SINT32)data2[i];
-	}
-	TRACEOUT(("SSE4_1_PMOVSXBD"));
-}
-
-void SSE4_1_PMOVSXBQ(void)
-{
-	int i;
-
-	SINT8 data2buf[16];
-	SINT8 *data1, *data2;
-	SSE_PART_GETDATA1DATA2_PD((double**)(&data1), (double**)(&data2), (double*)data2buf);
-	for(i=0;i<2;i++){
-		*((SINT64*)(data1 + (i * 8))) = (SINT64)data2[i];
-	}
-	TRACEOUT(("SSE4_1_PMOVSXBQ"));
-}
-
-void SSE4_1_PMOVSXWD(void)
-{
-	int i;
-
-	SINT16 data2buf[8];
-	SINT16 *data1, *data2;
-	SSE_PART_GETDATA1DATA2_PD((double**)(&data1), (double**)(&data2), (double*)data2buf);
-	for(i=0;i<4;i++){
-		*((SINT32*)(data1 + (i * 4))) = (SINT32)data2[i];
-	}
-	TRACEOUT(("SSE4_1_PMOVSXWD"));
-}
-
-void SSE4_1_PMOVSXWQ(void)
-{
-	int i;
-
-	SINT16 data2buf[8];
-	SINT16 *data1, *data2;
-	SSE_PART_GETDATA1DATA2_PD((double**)(&data1), (double**)(&data2), (double*)data2buf);
-	for(i=0;i<2;i++){
-		*((SINT64*)(data1 + (i * 8))) = (SINT64)data2[i];
-	}
-	TRACEOUT(("SSE4_1_PMOVSXWQ"));
-}
-
-void SSE4_1_PMOVSXDQ(void)
-{
-	int i;
-
-	SINT32 data2buf[4];
-	SINT32 *data1, *data2;
-	SSE_PART_GETDATA1DATA2_PD((double**)(&data1), (double**)(&data2), (double*)data2buf);
-	for(i=0;i<2;i++){
-		*((SINT64*)(data1 + (i * 8))) = (SINT64)data2[i];
-	}
-	TRACEOUT(("SSE4_1_PMOVSXDQ"));
-}
-
-void SSE4_1_PMOVZXBW(void)
-{
-	int i;
-
-	UINT8 data2buf[16];
-	UINT8 *data1, *data2;
-	SSE_PART_GETDATA1DATA2_PD((double**)(&data1), (double**)(&data2), (double*)data2buf);
-	for(i=0;i<8;i++){
-		*((UINT16*)(data1 + (i * 2))) = (UINT16)data2[i];
-	}
-	TRACEOUT(("SSE4_1_PMOVZXBW"));
-}
-
-void SSE4_1_PMOVZXBD(void)
-{
-	int i;
-
-	UINT8 data2buf[16];
-	UINT8 *data1, *data2;
-	SSE_PART_GETDATA1DATA2_PD((double**)(&data1), (double**)(&data2), (double*)data2buf);
-	for(i=0;i<4;i++){
-		*((UINT32*)(data1 + (i * 4))) = (UINT32)data2[i];
-	}
-	TRACEOUT(("SSE4_1_PMOVZXBD"));
-}
-
-void SSE4_1_PMOVZXBQ(void)
-{
-	int i;
-
-	UINT8 data2buf[16];
-	UINT8 *data1, *data2;
-	SSE_PART_GETDATA1DATA2_PD((double**)(&data1), (double**)(&data2), (double*)data2buf);
-	for(i=0;i<2;i++){
-		*((UINT64*)(data1 + (i * 8))) = (UINT64)data2[i];
-	}
-	TRACEOUT(("SSE4_1_PMOVZXBQ"));
-}
-
-void SSE4_1_PMOVZXWD(void)
-{
-	int i;
-
-	UINT16 data2buf[8];
-	UINT16 *data1, *data2;
-	SSE_PART_GETDATA1DATA2_PD((double**)(&data1), (double**)(&data2), (double*)data2buf);
-	for(i=0;i<4;i++){
-		*((UINT32*)(data1 + (i * 4))) = (UINT32)data2[i];
-	}
-	TRACEOUT(("SSE4_1_PMOVZXWD"));
-}
-
-void SSE4_1_PMOVZXWQ(void)
-{
-	int i;
-
-	UINT16 data2buf[8];
-	UINT16 *data1, *data2;
-	SSE_PART_GETDATA1DATA2_PD((double**)(&data1), (double**)(&data2), (double*)data2buf);
-	for(i=0;i<2;i++){
-		*((UINT64*)(data1 + (i * 8))) = (UINT64)data2[i];
-	}
-	TRACEOUT(("SSE4_1_PMOVZXWQ"));
-}
-
-void SSE4_1_PMOVZXDQ(void)
-{
-	int i;
-
-	UINT32 data2buf[4];
-	UINT32 *data1, *data2;
-	SSE_PART_GETDATA1DATA2_PD((double**)(&data1), (double**)(&data2), (double*)data2buf);
-	for(i=0;i<2;i++){
-		*((UINT64*)(data1 + (i * 8))) = (UINT64)data2[i];
-	}
-	TRACEOUT(("SSE4_1_PMOVZXDQ"));
-}
-
-void SSE4_1_PMULLD(void)
-{
-	int i;
-
-	UINT64 tmp[4];
-	UINT32 data2buf[4];
-	UINT32 *data1, *data2;
-	SSE_PART_GETDATA1DATA2_PD((double**)(&data1), (double**)(&data2), (double*)data2buf);
-	for(i=0;i<4;i++){
-		tmp[i] = data1[i] * data2[i];
-		data1[i] = tmp[i];
-	}
-	TRACEOUT(("SSE4_1_PMULLD"));
-}
-
-void SSE4_1_PHMINPOSUW(void)
-{
-	int i;
-
-	UINT16 min;
-	UINT16 data2buf[8];
-	UINT16 *data1, *data2;
-	SSE_PART_GETDATA1DATA2_PD((double**)(&data1), (double**)(&data2), (double*)data2buf);
-	min = data2[0];
-	data1[1] = 7;
-	for(i=0;i<7;i++){
-		if (data2[i+1] < min){data1[1] = ((i+1) & 7); data1[0] = data2[i+1]; break;}
-		min = data2[i+1];
-	}
-	for(i=2;i<8;i++){
-		data1[i] = 0;
-	}
-	TRACEOUT(("SSE4_1_PHMINPOSUW"));
-}
-
-void SSE4_1_PMULDQ(void)
-{
-	int i;
-
-	SINT64 tmp[2];
-	SINT32 data2buf[4];
-	SINT32 *data1, *data2;
-	SSE_PART_GETDATA1DATA2_PD((double**)(&data1), (double**)(&data2), (double*)data2buf);
-	for(i=0;i<2;i++){
-		tmp[i] = (SINT64)data1[i * 2] * (SINT64)data2[i * 2];
-		*((SINT64*)(data1 + (i * 8))) = tmp[i];
-	}
-	TRACEOUT(("SSE4_1_PMULDQ"));
-}
-
-void SSE4_1_PCMPEQQ(void)
-{
-	int i;
-
-	UINT64 data2buf[2];
-	UINT64 *data1, *data2;
-	SSE_PART_GETDATA1DATA2_PD((double**)(&data1), (double**)(&data2), (double*)data2buf);
-	for(i=0;i<2;i++){
-		if (data1[i] == data2[i]){
-			data1[i] = 0xFFFFFFFFFFFFFFFF;
-		} else {
-			data1[i] = 0;
-		}
-	}
-	TRACEOUT(("SSE4_1_PCMPEQQ"));
-}
-
-void SSE4_1_MOVNTDQA(void)
-{
-	int i;
-
-	UINT64 data2buf[2];
-	UINT64 *data1, *data2;
-	SSE_PART_GETDATA1DATA2_PD((double**)(&data1), (double**)(&data2), (double*)data2buf);
-	for(i=0;i<2;i++){
-		data1[i] = data2[i];
-	}
-	TRACEOUT(("SSE4_1_MOVNTDQA"));
-}
-
-void SSE4_1_PACKUSDW(void)
-{
-	int i;
-
-	UINT16 tmp[8];
-	UINT16 data2buf[8];
-	UINT16 *data1, *data2;
-	SSE_PART_GETDATA1DATA2_PD((double**)(&data1), (double**)(&data2), (double*)data2buf);
-	for(i=0;i<4;i++){
-		tmp[i + 0] = ((*((UINT32*)(data1 + (i * 2)))) < 0) ? 0 : data1[i * 2];
-		data1[i] = ((*((UINT32*)(data1 + (i * 2)))) > 0xFFFF) ? 0xFFFF : tmp[i];
-	}
-	for(i=0;i<4;i++){
-		tmp[i + 4] = ((*((UINT32*)(data2 + (i * 2)))) < 0) ? 0 : data2[i * 2];
-		data1[i] = ((*((UINT32*)(data2 + (i * 2)))) > 0xFFFF) ? 0xFFFF : tmp[i + 4];
-	}
-	TRACEOUT(("SSE4_1_PACKUSDW"));
-}
-
-void SSE4_1_PMINSB(void)
-{
-	SINT8 data2buf[16];
-	SINT8 *data1, *data2;
-	int i;
-	
-	SSE_PART_GETDATA1DATA2_PD_UINT64((UINT64**)(&data1), (UINT64**)(&data2), (UINT64*)data2buf);
-	for(i=0;i<16;i++){
-		data1[i] = (data1[i] < data2[i] ? data1[i] : data2[i]);
-	}
-	TRACEOUT(("SSE4_1_PMINSB"));
-}
-
-void SSE4_1_PMINSD(void)
-{
-	SINT32 data2buf[16];
-	SINT32 *data1, *data2;
-	int i;
-	
-	SSE_PART_GETDATA1DATA2_PD_UINT64((UINT64**)(&data1), (UINT64**)(&data2), (UINT64*)data2buf);
-	for(i=0;i<4;i++){
-		data1[i] = (data1[i] < data2[i] ? data1[i] : data2[i]);
-	}
-	TRACEOUT(("SSE4_1_PMINSD"));
-}
-
-void SSE4_1_PMINUW(void)
-{
-	UINT16 data2buf[8];
-	UINT16 *data1, *data2;
-	int i;
-	
-	SSE_PART_GETDATA1DATA2_PD_UINT64((UINT64**)(&data1), (UINT64**)(&data2), (UINT64*)data2buf);
-	for(i=0;i<8;i++){
-		data1[i] = (data1[i] < data2[i] ? data1[i] : data2[i]);
-	}
-	TRACEOUT(("SSE4_1_PMINUW"));
-}
-
-void SSE4_1_PMINUD(void)
-{
-	UINT32 data2buf[4];
-	UINT32 *data1, *data2;
-	int i;
-	
-	SSE_PART_GETDATA1DATA2_PD_UINT64((UINT64**)(&data1), (UINT64**)(&data2), (UINT64*)data2buf);
-	for(i=0;i<4;i++){
-		data1[i] = (data1[i] < data2[i] ? data1[i] : data2[i]);
-	}
-	TRACEOUT(("SSE4_1_PMINUD"));
-}
-
-void SSE4_1_PMAXSB(void)
-{
-	SINT8 data2buf[16];
-	SINT8 *data1, *data2;
-	int i;
-	
-	SSE_PART_GETDATA1DATA2_PD_UINT64((UINT64**)(&data1), (UINT64**)(&data2), (UINT64*)data2buf);
-	for(i=0;i<16;i++){
-		data1[i] = (data1[i] > data2[i] ? data1[i] : data2[i]);
-	}
-	TRACEOUT(("SSE4_1_PMAXSB"));
-}
-
-void SSE4_1_PMAXSD(void)
-{
-	SINT32 data2buf[4];
-	SINT32 *data1, *data2;
-	int i;
-	
-	SSE_PART_GETDATA1DATA2_PD_UINT64((UINT64**)(&data1), (UINT64**)(&data2), (UINT64*)data2buf);
-	for(i=0;i<4;i++){
-		data1[i] = (data1[i] > data2[i] ? data1[i] : data2[i]);
-	}
-	TRACEOUT(("SSE4_1_PMAXSD"));
-}
-
-void SSE4_1_PMAXUW(void)
-{
-	UINT16 data2buf[8];
-	UINT16 *data1, *data2;
-	int i;
-	
-	SSE_PART_GETDATA1DATA2_PD_UINT64((UINT64**)(&data1), (UINT64**)(&data2), (UINT64*)data2buf);
-	for(i=0;i<8;i++){
-		data1[i] = (data1[i] > data2[i] ? data1[i] : data2[i]);
-	}
-	TRACEOUT(("SSE4_1_PMAXUW"));
-}
-
-void SSE4_1_PMAXUD(void)
-{
-	UINT32 data2buf[4];
-	UINT32 *data1, *data2;
-	int i;
-	
-	SSE_PART_GETDATA1DATA2_PD_UINT64((UINT64**)(&data1), (UINT64**)(&data2), (UINT64*)data2buf);
-	for(i=0;i<4;i++){
-		data1[i] = (data1[i] > data2[i] ? data1[i] : data2[i]);
-	}
-	TRACEOUT(("SSE4_1_PMAXUW"));
-}
-
-void SSE4_1_PEXTRB(void)
-{
-	UINT32 op2;
-	UINT8 *data1;
-
-	UINT32 *out;
-
-	UINT32 op;
-	UINT idx, sub;
-
-	UINT32 maddr;
-
-	
-	SSE4_1_check_NM_EXCEPTION();
-	SSE4_1_setTag();
-	CPU_SSSE3WORKCLOCK;
-	GET_PCBYTE((op));
-	idx = (op >> 3) & 7;
-	sub = (op & 7);
-	data1 = (UINT8*)(&(FPU_STAT.xmm_reg[idx]));
-	GET_PCBYTE((op2));
-	if ((op) >= 0xc0) {
-		out = reg32_b20[op];
-		*out = (UINT32)(data1[op2&0xF]&0xFF);
-	} else {
-		maddr = calc_ea_dst((op));
-		cpu_vmemorywrite_b(CPU_INST_SEGREG_INDEX, maddr+ 0, (UINT8)data1[op2&0xF]);
-	}
-	TRACEOUT(("SSE4_1_PEXTRB"));
-}
-
-void SSE4_1_PEXTRW(void)
-{
-	UINT32 op2;
-	UINT16 *data1;
-
-	UINT32 *out;
-
-	UINT32 op;
-	UINT idx, sub;
-
-	UINT32 maddr;
-
-	
-	SSE4_1_check_NM_EXCEPTION();
-	SSE4_1_setTag();
-	CPU_SSSE3WORKCLOCK;
-	GET_PCBYTE((op));
-	idx = (op >> 3) & 7;
-	sub = (op & 7);
-	data1 = (UINT16*)(&(FPU_STAT.xmm_reg[idx]));
-	GET_PCBYTE((op2));
-	if ((op) >= 0xc0) {
-		out = reg32_b20[op];
-		*out = (UINT32)(data1[op2&0x7]&0xFFFF);
-	} else {
-		maddr = calc_ea_dst((op));
-		cpu_vmemorywrite_w(CPU_INST_SEGREG_INDEX, maddr+ 0, (UINT16)data1[op2&0x7]);
-	}
-	TRACEOUT(("SSE4_1_PEXTRW"));
-}
-
-void SSE4_1_PEXTRD(void)
-{
-	UINT32 op2;
-	UINT32 *data1;
-
-	UINT32 *out;
-
-	UINT32 op;
-	UINT idx, sub;
-
-	UINT32 maddr;
-
-	
-	SSE4_1_check_NM_EXCEPTION();
-	SSE4_1_setTag();
-	CPU_SSSE3WORKCLOCK;
-	GET_PCBYTE((op));
-	idx = (op >> 3) & 7;
-	sub = (op & 7);
-	data1 = (UINT32*)(&(FPU_STAT.xmm_reg[idx]));
-	GET_PCBYTE((op2));
-	if ((op) >= 0xc0) {
-		out = reg32_b20[op];
-		*out = (UINT32)(data1[op2&0x3]&0xFFFFFFFF);
-	} else {
-		maddr = calc_ea_dst((op));
-		cpu_vmemorywrite_d(CPU_INST_SEGREG_INDEX, maddr+ 0, (UINT32)data1[op2&0x3]);
-	}
-	TRACEOUT(("SSE4_1_PEXTRD"));
-}
-
-void SSE4_1_PINSRB(void)
-{
-	UINT32 op2;
-	UINT8 *data1;
-
-	UINT32 *out;
-
-	UINT32 op;
-	UINT idx, sub;
-
-	UINT32 maddr;
-
-	
-	SSE4_1_check_NM_EXCEPTION();
-	SSE4_1_setTag();
-	CPU_SSSE3WORKCLOCK;
-	GET_PCBYTE((op));
-	idx = (op >> 3) & 7;
-	sub = (op & 7);
-	data1 = (UINT8*)(&(FPU_STAT.xmm_reg[idx]));
-	GET_PCBYTE((op2));
-	if ((op) >= 0xc0) {
-		out = reg32_b20[op];
-		data1[op2&0xF] = *out;
-	} else {
-		maddr = calc_ea_dst((op));
-		data1[op2&0xF] = cpu_vmemoryread_b(CPU_INST_SEGREG_INDEX, maddr+ 0);
-	}
-	TRACEOUT(("SSE4_1_PINSRB"));
-}
-
-void SSE4_1_PINSRW(void)
-{
-	UINT32 op2;
-	UINT16 *data1;
-
-	UINT32 *out;
-
-	UINT32 op;
-	UINT idx, sub;
-
-	UINT32 maddr;
-
-	
-	SSE4_1_check_NM_EXCEPTION();
-	SSE4_1_setTag();
-	CPU_SSSE3WORKCLOCK;
-	GET_PCBYTE((op));
-	idx = (op >> 3) & 7;
-	sub = (op & 7);
-	data1 = (UINT16*)(&(FPU_STAT.xmm_reg[idx]));
-	GET_PCBYTE((op2));
-	if ((op) >= 0xc0) {
-		out = reg32_b20[op];
-		data1[op2&0x7] = *out;
-	} else {
-		maddr = calc_ea_dst((op));
-		data1[op2&0x7] = cpu_vmemoryread_w(CPU_INST_SEGREG_INDEX, maddr+ 0);
-	}
-	TRACEOUT(("SSE4_1_PINSRW"));
-}
-
-void SSE4_1_PINSRD(void)
-{
-	UINT32 op2;
-	UINT32 *data1;
-
-	UINT32 *out;
-
-	UINT32 op;
-	UINT idx, sub;
-
-	UINT32 maddr;
-
-	
-	SSE4_1_check_NM_EXCEPTION();
-	SSE4_1_setTag();
-	CPU_SSSE3WORKCLOCK;
-	GET_PCBYTE((op));
-	idx = (op >> 3) & 7;
-	sub = (op & 7);
-	data1 = (UINT32*)(&(FPU_STAT.xmm_reg[idx]));
-	GET_PCBYTE((op2));
-	if ((op) >= 0xc0) {
-		out = reg32_b20[op];
-		data1[op2&0x3] = *out;
-	} else {
-		maddr = calc_ea_dst((op));
-		data1[op2&0x3] = cpu_vmemoryread_d(CPU_INST_SEGREG_INDEX, maddr+ 0);
-	}
-	TRACEOUT(("SSE4_1_PINSRD"));
-}
-
-void SSE4_1_PEXTRACTPS(void)
-{
-	UINT32 op2;
-	UINT32 data2buf[4];
-	UINT32 *data2;
-
-	UINT32 *out; 
-	UINT32 maddr; 
-	
-	UINT32 op;
-	UINT idx, sub;
-	
-	SSE4_1_check_NM_EXCEPTION();
-	SSE4_1_setTag();
-	CPU_SSSE3WORKCLOCK;
-	GET_PCBYTE((op));
-	idx = (op >> 3) & 7;
-	sub = (op & 7);
-	if ((op) >= 0xc0) {
-		data2 = (UINT32*)(&(FPU_STAT.xmm_reg[sub]));
-	} else {
-		maddr = calc_ea_dst((op));
-		*((UINT64*)(&data2buf[0])) = cpu_vmemoryread_q(CPU_INST_SEGREG_INDEX, maddr+ 0);
-		*((UINT64*)(&data2buf[2])) = cpu_vmemoryread_q(CPU_INST_SEGREG_INDEX, maddr+ 8);
-		data2 = data2buf;
-	}
-	GET_PCBYTE((op2));
-
-	if (op >= 0xc0) {
-		out = reg32_b20[op];
-		*out = data2[op2&0x3] & 0xFFFFFFFF;
-	} else {
-		maddr = calc_ea_dst((op));
-		cpu_vmemorywrite_d(CPU_INST_SEGREG_INDEX, maddr+ 0, (UINT32)(data2[op2&0x3] & 0xFFFFFFFF));
-	}
-	TRACEOUT(("SSE4_1_PEXTRACTPS"));
-}
-
-void SSE4_1_INSERTPS(void)
-{
-	int i;
-
-	UINT32 data2buf[4];
-	UINT32 *data1, *data2;
-	UINT32 op;
-	UINT32 tmp = SSE_PART_GETDATA1DATA2_PD_MODRM((double**)(&data1), (double**)(&data2), (double*)data2buf);
-
-	GET_PCBYTE((op));
-	data1[(op>>4)&3] = data2[(tmp >= 0xc0) ? ((op>>6)&3) : 0];
-	for(i=0;i<4;i++){
-		if (op & (1 << i)){
-			data1[i] = 0;
-		}
-	}
-	TRACEOUT(("SSE4_1_INSERTPS"));
-}
-
-void SSE4_1_DPPS(void)
-{
-	int i;
-
-	float data2buf[4];
-	float *data1, *data2;
-	float tmpsinedcalc = 0.0f;
-	UINT32 op;
-	SSE_PART_GETDATA1DATA2_PD((double**)(&data1), (double**)(&data2), (double*)data2buf);
-
-	GET_PCBYTE((op));
-	for(i=0;i<4;i++){
-		if (op&(1 << (i + 4))){
-			tmpsinedcalc += data1[i] * data2[i];
-		}
-	}
-	for(i=0;i<4;i++){
-		data1[i] = (op&(1 << i)) ? tmpsinedcalc : 0.0f;
-	}
-	TRACEOUT(("SSE4_1_DPPS"));
-}
-
-void SSE4_1_DPPD(void)
-{
-	int i;
-
-	double data2buf[2];
-	double *data1, *data2;
-	double tmpsinedcalc = 0.0;
-	UINT32 op;
-	SSE_PART_GETDATA1DATA2_PD((double**)(&data1), (double**)(&data2), (double*)data2buf);
-
-	GET_PCBYTE((op));
-	for(i=0;i<2;i++){
-		if (op&(1 << (i + 4))){
-			tmpsinedcalc += data1[i] * data2[i];
-		}
-	}
-	for(i=0;i<2;i++){
-		data1[i] = (op&(1 << i)) ? tmpsinedcalc : 0.0;
-	}
-	TRACEOUT(("SSE4_1_DPPD"));
-}
-
-void SSE4_1_MPSADBW(void)
-{
-	int i;
-
-	UINT8 data2buf[8];
-	UINT8 *data1, *data2;
-	SINT32 tmpsinedcalcb[11];
-	SINT32 tmpsinedcalc;
-	UINT32 op;
-	SSE_PART_GETDATA1DATA2_PD((double**)(&data1), (double**)(&data2), (double*)data2buf);
-
-	GET_PCBYTE((op));
-	for(i=0;i<11;i++){
-		tmpsinedcalcb[i] = data1[((op >> 2) & 1)*4 + i];
-	}
-	for(i=0;i<8;i++){
-		tmpsinedcalc  = abs(tmpsinedcalcb[i+0]-data2[(op & 3) * 4 + 0]);
-		tmpsinedcalc += abs(tmpsinedcalcb[i+1]-data2[(op & 3) * 4 + 1]);
-		tmpsinedcalc += abs(tmpsinedcalcb[i+2]-data2[(op & 3) * 4 + 2]);
-		tmpsinedcalc += abs(tmpsinedcalcb[i+3]-data2[(op & 3) * 4 + 3]);
-		*((UINT16*)(data1[2 * i])) = tmpsinedcalc;
-	}
-	TRACEOUT(("SSE4_1_MPSADBW"));
-}
-
-void SSE4_1_ROUNDPS(void)
-{
-	int i;
-
-	float data2buf[4];
-	float *data1, *data2;
-	UINT32 op;
-	SSE_PART_GETDATA1DATA2_PD((double**)(&data1), (double**)(&data2), (double*)data2buf);
-
-	GET_PCBYTE((op));
-	for(i=0;i<4;i++){
-		switch ((op & 4) ? ((CPU_MXCSR >> 13) & 3) : (op & 3)){
-			case 0:
-				data1[i] = NEARBYINTF(data2[i]);
-			break;
-			case 1:
-				data1[i] = floorf(data2[i]);
-			break;
-			case 2:
-				data1[i] = ceilf(data2[i]);
-			break;
-			case 3:
-				data1[i] = TRUNCF(data2[i]);
-			break;
-		}
-	}
-	TRACEOUT(("SSE4_1_ROUNDPS"));
-}
-
-void SSE4_1_ROUNDPD(void)
-{
-	int i;
-
-	double data2buf[2];
-	double *data1, *data2;
-	UINT32 op;
-	SSE_PART_GETDATA1DATA2_PD((double**)(&data1), (double**)(&data2), (double*)data2buf);
-
-	GET_PCBYTE((op));
-	for(i=0;i<2;i++){
-		switch ((op & 4) ? ((CPU_MXCSR >> 13) & 3) : (op & 3)){
-			case 0:
-				data1[i] = NEARBYINT(data2[i]);
-			break;
-			case 1:
-				data1[i] = floor(data2[i]);
-			break;
-			case 2:
-				data1[i] = ceil(data2[i]);
-			break;
-			case 3:
-				data1[i] = TRUNC(data2[i]);
-			break;
-		}
-	}
-	TRACEOUT(("SSE4_1_ROUNDPD"));
-}
-
-void SSE4_1_ROUNDSS(void)
-{
-	float data2buf[4];
-	float *data1, *data2;
-	UINT32 op;
-	SSE_PART_GETDATA1DATA2_PD((double**)(&data1), (double**)(&data2), (double*)data2buf);
-
-	GET_PCBYTE((op));
-	switch ((op & 4) ? ((CPU_MXCSR >> 13) & 3) : (op & 3)){
-		case 0:
-			data1[0] = NEARBYINTF(data2[0]);
-		break;
-		case 1:
-			data1[0] = floorf(data2[0]);
-		break;
-		case 2:
-			data1[0] = ceilf(data2[0]);
-		break;
-		case 3:
-			data1[0] = TRUNCF(data2[0]);
-		break;
-	}
-	TRACEOUT(("SSE4_1_ROUNDSS"));
-}
-
-void SSE4_1_ROUNDSD(void)
-{
-	double data2buf[2];
-	double *data1, *data2;
-	UINT32 op;
-	SSE_PART_GETDATA1DATA2_PD((double**)(&data1), (double**)(&data2), (double*)data2buf);
-
-	GET_PCBYTE((op));
-	switch ((op & 4) ? ((CPU_MXCSR >> 13) & 3) : (op & 3)){
-		case 0:
-			data1[0] = NEARBYINT(data2[0]);
-		break;
-		case 1:
-			data1[0] = floor(data2[0]);
-		break;
-		case 2:
-			data1[0] = ceil(data2[0]);
-		break;
-		case 3:
-			data1[0] = TRUNC(data2[0]);
-		break;
-	}
-	TRACEOUT(("SSE4_1_ROUNDSD"));
-}
-
-void SSE4_1_PBLENDPS(void)
-{
-	int i;
-
-	UINT32 data2buf[4];
-	UINT32 *data1, *data2;
-	UINT32 op;
-	SSE_PART_GETDATA1DATA2_PD((double**)(&data1), (double**)(&data2), (double*)data2buf);
-
-	GET_PCBYTE((op));
-	for(i=0;i<4;i++){
-		if (op & (1 << i)){
-			data1[i] = data2[i];
-		}
-	}
-	TRACEOUT(("SSE4_1_PBLENDPS"));
-}
-
-void SSE4_1_PBLENDPD(void)
-{
-	int i;
-
-	UINT64 data2buf[2];
-	UINT64 *data1, *data2;
-	UINT32 op;
-	SSE_PART_GETDATA1DATA2_PD((double**)(&data1), (double**)(&data2), (double*)data2buf);
-
-	GET_PCBYTE((op));
-	for(i=0;i<2;i++){
-		if (op & (1 << i)){
-			data1[i] = data2[i];
-		}
-	}
-	TRACEOUT(("SSE4_1_PBLENDPD"));
-}
-
-void SSE4_1_PBLENDW(void)
-{
-	int i;
-
-	UINT16 data2buf[8];
-	UINT16 *data1, *data2;
-	UINT32 op;
-	SSE_PART_GETDATA1DATA2_PD((double**)(&data1), (double**)(&data2), (double*)data2buf);
-
-	GET_PCBYTE((op));
-	for(i=0;i<8;i++){
-		if (op & (1 << i)){
-			data1[i] = data2[i];
-		}
-	}
-	TRACEOUT(("SSE4_1_PBLENDPD"));
-}
-
-#else
-
-void SSE4_1_PBLENDVB(void)
-{
-	EXCEPTION(UD_EXCEPTION, 0);
-}
-
-void SSE4_1_BLENDVPS(void)
-{
-	EXCEPTION(UD_EXCEPTION, 0);
-}
-
-void SSE4_1_BLENDVPD(void)
-{
-	EXCEPTION(UD_EXCEPTION, 0);
-}
-
-void SSE4_1_VPTEST(void)
-{
-	EXCEPTION(UD_EXCEPTION, 0);
-}
-
-void SSE4_1_PMOVSXBW(void)
-{
-	EXCEPTION(UD_EXCEPTION, 0);
-}
-
-void SSE4_1_PMOVSXBD(void)
-{
-	EXCEPTION(UD_EXCEPTION, 0);
-}
-
-void SSE4_1_PMOVSXBQ(void)
-{
-	EXCEPTION(UD_EXCEPTION, 0);
-}
-
-void SSE4_1_PMOVSXWD(void)
-{
-	EXCEPTION(UD_EXCEPTION, 0);
-}
-
-void SSE4_1_PMOVSXWQ(void)
-{
-	EXCEPTION(UD_EXCEPTION, 0);
-}
-
-void SSE4_1_PMOVSXDQ(void)
-{
-	EXCEPTION(UD_EXCEPTION, 0);
-}
-
-void SSE4_1_PMOVZXBW(void)
-{
-	EXCEPTION(UD_EXCEPTION, 0);
-}
-
-void SSE4_1_PMOVZXBD(void)
-{
-	EXCEPTION(UD_EXCEPTION, 0);
-}
-
-void SSE4_1_PMOVZXBQ(void)
-{
-	EXCEPTION(UD_EXCEPTION, 0);
-}
-
-void SSE4_1_PMOVZXWD(void)
-{
-	EXCEPTION(UD_EXCEPTION, 0);
-}
-
-void SSE4_1_PMOVZXWQ(void)
-{
-	EXCEPTION(UD_EXCEPTION, 0);
-}
-
-void SSE4_1_PMOVZXDQ(void)
-{
-	EXCEPTION(UD_EXCEPTION, 0);
-}
-
-void SSE4_1_PMULLD(void)
-{
-	EXCEPTION(UD_EXCEPTION, 0);
-}
-
-void SSE4_1_PHMINPOSUW(void)
-{
-	EXCEPTION(UD_EXCEPTION, 0);
-}
-
-void SSE4_1_PMULDQ(void)
-{
-	EXCEPTION(UD_EXCEPTION, 0);
-}
-
-void SSE4_1_PCMPEQQ(void)
-{
-	EXCEPTION(UD_EXCEPTION, 0);
-}
-
-void SSE4_1_MOVNTDQA(void)
-{
-	EXCEPTION(UD_EXCEPTION, 0);
-}
-
-void SSE4_1_PACKUSDW(void)
-{
-	EXCEPTION(UD_EXCEPTION, 0);
-}
-
-void SSE4_1_PMINSB(void)
-{
-	EXCEPTION(UD_EXCEPTION, 0);
-}
-
-void SSE4_1_PMINSD(void)
-{
-	EXCEPTION(UD_EXCEPTION, 0);
-}
-
-void SSE4_1_PMINUW(void)
-{
-	EXCEPTION(UD_EXCEPTION, 0);
-}
-
-void SSE4_1_PMINUD(void)
-{
-	EXCEPTION(UD_EXCEPTION, 0);
-}
-
-void SSE4_1_PMAXSB(void)
-{
-	EXCEPTION(UD_EXCEPTION, 0);
-}
-
-void SSE4_1_PMAXSD(void)
-{
-	EXCEPTION(UD_EXCEPTION, 0);
-}
-
-void SSE4_1_PMAXUW(void)
-{
-	EXCEPTION(UD_EXCEPTION, 0);
-}
-
-void SSE4_1_PMAXUD(void)
-{
-	EXCEPTION(UD_EXCEPTION, 0);
-}
-
-void SSE4_1_PEXTRB(void)
-{
-	EXCEPTION(UD_EXCEPTION, 0);
-}
-
-void SSE4_1_PEXTRW(void)
-{
-	EXCEPTION(UD_EXCEPTION, 0);
-}
-
-void SSE4_1_PEXTRD(void)
-{
-	EXCEPTION(UD_EXCEPTION, 0);
-}
-
-void SSE4_1_PINSRB(void)
-{
-	EXCEPTION(UD_EXCEPTION, 0);
-}
-
-void SSE4_1_PINSRW(void)
-{
-	EXCEPTION(UD_EXCEPTION, 0);
-}
-
-void SSE4_1_PINSRD(void)
-{
-	EXCEPTION(UD_EXCEPTION, 0);
-}
-
-void SSE4_1_PEXTRACTPS(void)
-{
-	EXCEPTION(UD_EXCEPTION, 0);
-}
-
-void SSE4_1_INSERTPS(void)
-{
-	EXCEPTION(UD_EXCEPTION, 0);
-}
-
-void SSE4_1_DPPS(void)
-{
-	EXCEPTION(UD_EXCEPTION, 0);
-}
-
-void SSE4_1_DPPD(void)
-{
-	EXCEPTION(UD_EXCEPTION, 0);
-}
-
-void SSE4_1_MPSADBW(void)
-{
-	EXCEPTION(UD_EXCEPTION, 0);
-}
-
-void SSE4_1_ROUNDPS(void)
-{
-	EXCEPTION(UD_EXCEPTION, 0);
-}
-
-void SSE4_1_ROUNDPD(void)
-{
-	EXCEPTION(UD_EXCEPTION, 0);
-}
-
-void SSE4_1_ROUNDSS(void)
-{
-	EXCEPTION(UD_EXCEPTION, 0);
-}
-
-void SSE4_1_ROUNDSD(void)
-{
-	EXCEPTION(UD_EXCEPTION, 0);
-}
-
-void SSE4_1_PBLENDPS(void)
-{
-	EXCEPTION(UD_EXCEPTION, 0);
-}
-
-void SSE4_1_PBLENDPD(void)
-{
-	EXCEPTION(UD_EXCEPTION, 0);
-}
-
-void SSE4_1_PBLENDW(void)
-{
-	EXCEPTION(UD_EXCEPTION, 0);
-}
-
-
-#endif
\ No newline at end of file
diff -ruN source/src/vm/np21/i386c/ia32/instructions/sse4/sse4_1.h src/vm/np21/i386c/ia32/instructions/sse4/sse4_1.h
--- source/src/vm/np21/i386c/ia32/instructions/sse4/sse4_1.h	2025-04-28 16:00:00
+++ src/vm/np21/i386c/ia32/instructions/sse4/sse4_1.h	1970-01-01 09:00:00
@@ -1,86 +0,0 @@
-/*
- * Copyright (c) 2024 Gocaine Project
- * All rights reserved.
- *
- * Redistribution and use in source and binary forms, with or without
- * modification, are permitted provided that the following conditions
- * are met:
- * 1. Redistributions of source code must retain the above copyright
- *    notice, this list of conditions and the following disclaimer.
- * 2. Redistributions in binary form must reproduce the above copyright
- *    notice, this list of conditions and the following disclaimer in the
- *    documentation and/or other materials provided with the distribution.
- *
- * THIS SOFTWARE IS PROVIDED BY THE AUTHOR ``AS IS'' AND ANY EXPRESS OR
- * IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES
- * OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED.
- * IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY DIRECT, INDIRECT,
- * INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT
- * NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,
- * DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY
- * THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
- * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF
- * THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
- */
-
-#ifndef	IA32_CPU_INSTRUCTION_SSE4_SSE4_1_H__
-#define	IA32_CPU_INSTRUCTION_SSE4_SSE4_1_H__
-
-//#ifdef __cplusplus
-//extern "C" {
-//#endif
-
-void SSE4_1_PBLENDVB(void);
-void SSE4_1_BLENDVPS(void);
-void SSE4_1_BLENDVPD(void);
-void SSE4_1_VPTEST(void);
-void SSE4_1_PMOVSXBW(void);
-void SSE4_1_PMOVSXBD(void);
-void SSE4_1_PMOVSXBQ(void);
-void SSE4_1_PMOVSXWD(void);
-void SSE4_1_PMOVSXWQ(void);
-void SSE4_1_PMOVSXDQ(void);
-void SSE4_1_PMOVZXBW(void);
-void SSE4_1_PMOVZXBD(void);
-void SSE4_1_PMOVZXBQ(void);
-void SSE4_1_PMOVZXWD(void);
-void SSE4_1_PMOVZXWQ(void);
-void SSE4_1_PMOVZXDQ(void);
-void SSE4_1_PMULLD(void);
-void SSE4_1_PHMINPOSUW(void);
-void SSE4_1_PMULDQ(void);
-void SSE4_1_PCMPEQQ(void);
-void SSE4_1_MOVNTDQA(void);
-void SSE4_1_PACKUSDW(void);
-void SSE4_1_PMINSB(void);
-void SSE4_1_PMINSD(void);
-void SSE4_1_PMINUW(void);
-void SSE4_1_PMINUD(void);
-void SSE4_1_PMAXSB(void);
-void SSE4_1_PMAXSD(void);
-void SSE4_1_PMAXUW(void);
-void SSE4_1_PMAXUD(void);
-void SSE4_1_PEXTRB(void);
-void SSE4_1_PEXTRW(void);
-void SSE4_1_PEXTRD(void);
-void SSE4_1_PINSRB(void);
-void SSE4_1_PINSRW(void);
-void SSE4_1_PINSRD(void);
-void SSE4_1_PEXTRACTPS(void);
-void SSE4_1_INSERTPS(void);
-void SSE4_1_DPPS(void);
-void SSE4_1_DPPD(void);
-void SSE4_1_MPSADBW(void);
-void SSE4_1_ROUNDPS(void);
-void SSE4_1_ROUNDPD(void);
-void SSE4_1_ROUNDSS(void);
-void SSE4_1_ROUNDSD(void);
-void SSE4_1_PBLENDPS(void);
-void SSE4_1_PBLENDPD(void);
-void SSE4_1_PBLENDW(void);
-
-//#ifdef __cplusplus
-//}
-//#endif
-
-#endif	/* IA32_CPU_INSTRUCTION_SSE4_SSE4_1_H__ */
diff -ruN source/src/vm/np21/i386c/ia32/instructions/sse4/sse4_2.cpp src/vm/np21/i386c/ia32/instructions/sse4/sse4_2.cpp
--- source/src/vm/np21/i386c/ia32/instructions/sse4/sse4_2.cpp	2025-04-28 16:00:00
+++ src/vm/np21/i386c/ia32/instructions/sse4/sse4_2.cpp	1970-01-01 09:00:00
@@ -1,706 +0,0 @@
-/*
- * Copyright (c) 2024 Gocaine Project
- * All rights reserved.
- *
- * Redistribution and use in source and binary forms, with or without
- * modification, are permitted provided that the following conditions
- * are met:
- * 1. Redistributions of source code must retain the above copyright
- *    notice, this list of conditions and the following disclaimer.
- * 2. Redistributions in binary form must reproduce the above copyright
- *    notice, this list of conditions and the following disclaimer in the
- *    documentation and/or other materials provided with the distribution.
- *
- * THIS SOFTWARE IS PROVIDED BY THE AUTHOR ``AS IS'' AND ANY EXPRESS OR
- * IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES
- * OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED.
- * IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY DIRECT, INDIRECT,
- * INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT
- * NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,
- * DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY
- * THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
- * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF
- * THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
- */
-
-//#include "compiler.h"
-
-#include <math.h>
-#include <float.h>
-
-#define isnan(x) (_isnan(x))
-
-#include "../../cpu.h"
-#include "../../ia32.mcr"
-
-#include "../sse/sse.h"
-#include "../sse2/sse2.h"
-#include "../sse3/sse3.h"
-#include "../ssse3/ssse3.h"
-#include "sse4_1.h"
-#include "sse4_2.h"
-
-#if defined(USE_SSE4_2) && defined(USE_SSE4_1) && defined(USE_SSSE3) && defined(USE_SSE3) && defined(USE_SSE2) && defined(USE_SSE) && defined(USE_FPU)
-
-#define CPU_SSSE3WORKCLOCK	CPU_WORKCLOCK(2)
-
-static INLINE void
-SSE4_2_check_NM_EXCEPTION(){
-	// SSE4.2Ç»ÇµÇ»ÇÁUD(ñ≥å¯ÉIÉyÉRÅ[Éhó·äO)Çî≠ê∂Ç≥ÇπÇÈ
-	if(!(i386cpuid.cpu_feature_ecx & CPU_FEATURE_ECX_SSE4_2)){
-		EXCEPTION(UD_EXCEPTION, 0);
-	}
-	// ÉGÉ~ÉÖÉåÅ[ÉVÉáÉìÇ»ÇÁUD(ñ≥å¯ÉIÉyÉRÅ[Éhó·äO)Çî≠ê∂Ç≥ÇπÇÈ
-	if(CPU_CR0 & CPU_CR0_EM){
-		EXCEPTION(UD_EXCEPTION, 0);
-	}
-	// É^ÉXÉNÉXÉCÉbÉ`éûÇ…NM(ÉfÉoÉCÉXégópïsâ¬ó·äO)Çî≠ê∂Ç≥ÇπÇÈ
-	if (CPU_CR0 & CPU_CR0_TS) {
-		EXCEPTION(NM_EXCEPTION, 0);
-	}
-}
-
-static INLINE void
-SSE4_2_setTag(void)
-{
-}
-
-// mmx.cÇÃÇ‡ÇÃÇ∆ìØÇ∂
-static INLINE void
-MMX_setTag(void)
-{
-	int i;
-	
-	if(!FPU_STAT.mmxenable){
-		FPU_STAT.mmxenable = 1;
-		//FPU_CTRLWORD = 0x27F;
-		for (i = 0; i < FPU_REG_NUM; i++) {
-			FPU_STAT.tag[i] = TAG_Valid;
-#ifdef SUPPORT_FPU_DOSBOX2
-			FPU_STAT.int_regvalid[i] = 0;
-#endif
-			FPU_STAT.reg[i].ul.ext = 0xffff;
-		}
-	}
-	FPU_STAT_TOP = 0;
-	FPU_STATUSWORD &= ~0x3800;
-	FPU_STATUSWORD |= (FPU_STAT_TOP&7)<<11;
-}
-
-/*
- * SSE4.2 interface
- */
-
-// ÉRÅ[ÉhÇ™í∑Ç≠Ç»ÇÈÇÃÇ≈Ç‚Ç‚ã≠à¯Ç…ã§í âª
-// xmm/m128 -> xmm
-static INLINE void SSE_PART_GETDATA1DATA2_PD(double **data1, double **data2, double *data2buf){
-	UINT32 op;
-	UINT idx, sub;
-	
-	SSE4_2_check_NM_EXCEPTION();
-	SSE4_2_setTag();
-	CPU_SSSE3WORKCLOCK;
-	GET_PCBYTE((op));
-	idx = (op >> 3) & 7;
-	sub = (op & 7);
-	*data1 = (double*)(&(FPU_STAT.xmm_reg[idx]));
-	if ((op) >= 0xc0) {
-		*data2 = (double*)(&(FPU_STAT.xmm_reg[sub]));
-	} else {
-		UINT32 maddr;
-		maddr = calc_ea_dst((op));
-		*((UINT64*)(data2buf+ 0)) = cpu_vmemoryread_q(CPU_INST_SEGREG_INDEX, maddr+ 0);
-		*((UINT64*)(data2buf+ 1)) = cpu_vmemoryread_q(CPU_INST_SEGREG_INDEX, maddr+ 8);
-		*data2 = data2buf;
-	}
-}
-
-static INLINE void SSE_PART_GETDATA1DATA2_P_UINT32(UINT32 **data1, UINT32 **data2, UINT32 *data2buf){
-	SSE_PART_GETDATA1DATA2_PD((double**)data1, (double**)data2, (double*)data2buf);
-}
-static INLINE void SSE_PART_GETDATA1DATA2_PD_UINT64(UINT64 **data1, UINT64 **data2, UINT64 *data2buf){
-	SSE_PART_GETDATA1DATA2_PD((double**)data1, (double**)data2, (double*)data2buf);
-}
-
-static INLINE void MMX_PART_GETDATA1DATA2_PD(float **data1, float **data2, float *data2buf){
-	UINT32 op;
-	UINT idx, sub;
-	
-	SSE4_2_check_NM_EXCEPTION();
-	SSE4_2_setTag();
-	CPU_SSSE3WORKCLOCK;
-	GET_PCBYTE((op));
-	idx = (op >> 3) & 7;
-	sub = (op & 7);
-	*data1 = (float*)(&(FPU_STAT.reg[idx]));
-	if ((op) >= 0xc0) {
-		*data2 = (float*)(&(FPU_STAT.reg[sub]));
-	} else {
-		UINT32 maddr;
-		maddr = calc_ea_dst((op));
-		*((UINT32*)(data2buf+ 0)) = cpu_vmemoryread_d(CPU_INST_SEGREG_INDEX, maddr);
-		*((UINT32*)(data2buf+ 1)) = cpu_vmemoryread_d(CPU_INST_SEGREG_INDEX, maddr + 4);
-		*data2 = data2buf;
-	}
-}
-
-// Referenced code at box86/64 for string simd implementation, thanks ptitSeb!
-
-static INLINE int overrideIfDataInvalid(UINT8 **data1, UINT8 **data2, UINT8 *data2buf, int cmpmode, int lmem, int lreg, int iii0, int iii1){
-	int valid1 = (iii1 < lreg);
-	int valid2 = (iii0 < lmem);
-	if(!valid1 && !valid2)
-	{
-		switch((cmpmode>>2)&3) {
-			case 0:
-			case 1:
-			return 0;
-			case 2:
-			case 3:
-			return 1;
-		}
-	}
-	if(!valid1 && valid2)
-	{
-		switch((cmpmode>>2)&3) {
-			case 0:
-			case 1:
-			case 2:
-			return 0;
-			case 3:
-			return 1;
-		}
-	}
-	if(valid1 && !valid2)
-	{
-		if (((cmpmode>>2)&3) == 1){
-			switch((cmpmode>>2)&3) {
-				case 0:
-				return (iii1&1)?(( *((UINT8*)(data2 + (iii1 * 1))) >= *((UINT8*)(data1 + (iii0 * 1))) )):(( *((UINT8*)(data2 + (iii1 * 1))) <= *((UINT8*)(data1 + (iii0 * 1))) ));
-				case 1:
-				return (iii1&1)?(( *((UINT16*)(data2 + (iii1 * 2))) >= *((UINT16*)(data1 + (iii0 * 2))) )):(( *((UINT16*)(data2 + (iii1 * 2))) <= *((UINT16*)(data1 + (iii0 * 2))) ));
-				case 2:
-				return (iii1&1)?(( *((SINT8*)(data2 + (iii1 * 1))) >= *((SINT8*)(data1 + (iii0 * 1))) )):(( *((SINT8*)(data2 + (iii1 * 1))) <= *((SINT8*)(data1 + (iii0 * 1))) ));
-				case 3:
-				return (iii1&1)?(( *((SINT16*)(data2 + (iii1 * 2))) >= *((SINT16*)(data1 + (iii0 * 2))) )):(( *((SINT16*)(data2 + (iii1 * 2))) <= *((SINT16*)(data1 + (iii0 * 2))) ));
-			}
-		} else {
-			switch (cmpmode & 1){
-				case 0:
-				return (( *((UINT8*)(data2 + (iii1 * 1))) == *((UINT8*)(data1 + (iii0 * 1))) ));
-				case 1:
-				return (( *((UINT16*)(data2 + (iii1 * 2))) >= *((UINT16*)(data1 + (iii0 * 2))) ));
-			}
-		}
-	}
-	return 0; // ÉRÉìÉpÉCÉãÉGÉâÅ[âÒîâº
-}
-
-static INLINE UINT32 sse42_compare_string_explicit_len(UINT8 **data1, UINT8 **data2, UINT8 *data2buf, int cmpmode, int lmem, int lreg){
-	UINT32 IntRes1 = 0;
-	UINT32 IntRes2 = 0;
-	int n_packed = (cmpmode&1)?8:16;
-	int iii0, iii1;
-	if (lreg<0) { lreg = -lreg; }
-	if (lmem<0) { lmem = -lmem; }
-	if (lreg>n_packed) { lreg = n_packed; }
-	if (lmem>n_packed) { lmem = n_packed; }
-	switch((cmpmode >> 2) & 3){
-		case 0:
-		for(iii0=0;iii0<n_packed;iii0++){
-			for(iii1=0;iii1<n_packed;iii1++){
-				IntRes1 |= overrideIfDataInvalid(data1,data2,data2buf,cmpmode,lmem,lreg,iii0,iii1) << iii0;
-			}
-		}
-		break;
-		case 1:
-		for(iii0=0;iii0<n_packed;iii0++){
-			for(iii1=0;iii1<n_packed;iii1++){
-				IntRes1 |= (overrideIfDataInvalid(data1,data2,data2buf,cmpmode,lmem,lreg,iii0,iii1) & overrideIfDataInvalid(data1,data2,data2buf,cmpmode,lmem,lreg,iii0,iii1+1)) << iii0;
-			}
-		}
-		break;
-		case 2:
-		for(iii0=0;iii0<n_packed;iii0++){
-			IntRes1 |= overrideIfDataInvalid(data1,data2,data2buf,cmpmode,lmem,lreg,iii0,iii0) << iii0;
-		}
-		break;
-		case 3:
-		IntRes1 = (1<<n_packed)-1;
-		for(iii0=0;iii0<n_packed;iii0++){
-			for(iii1=0;iii1<n_packed;iii1++){
-				int iii2 = iii0 + iii1;
-				IntRes1 &= (((1 << n_packed)-1) ^ (1 << iii0)) | overrideIfDataInvalid(data1,data2,data2buf,cmpmode,lmem,lreg,iii2,iii1) << iii0;
-			}
-		}
-		break;
-	}
-	IntRes2 = IntRes1;
-	switch((cmpmode>>4)&3){
-		case 1:
-		IntRes2 ^= ((1<<n_packed)-1);
-		break;
-		case 3:
-		IntRes2 ^= ((1<<lmem)-1);
-		break;
-	}
-		if (IntRes2){CPU_FLAG |=  C_FLAG;}else{CPU_FLAG &=  ~C_FLAG;}
-		if (lmem<n_packed){CPU_FLAG |=  Z_FLAG;}else{CPU_FLAG &=  ~Z_FLAG;}
-		if (lreg<n_packed){CPU_FLAG |=  S_FLAG;}else{CPU_FLAG &=  ~S_FLAG;}
-		if (IntRes2&1){CPU_FLAG |=  O_FLAG;}else{CPU_FLAG &=  ~O_FLAG;}
-		CPU_FLAG &=  ~A_FLAG;
-		CPU_FLAG &=  ~P_FLAG;
-		return IntRes2;
-}
-
-static INLINE UINT32 sse42_compare_string_inplicit_len(UINT8 **data1, UINT8 **data2, UINT8 *data2buf, int cmpmode){
-	int lmem = 0;
-	int lreg = 0;
-	if (cmpmode&1){
-		while(lmem<8 && *((UINT16*)(data1+(lmem * 2))) ){ ++lmem; }
-		while(lreg<8 && *((UINT16*)(data2+(lreg * 2))) ){ ++lreg; }
-	}else{
-		while(lmem<16 && *((UINT8*)(data1+(lmem * 1))) ){ ++lmem; }
-		while(lreg<16 && *((UINT8*)(data2+(lreg * 1))) ){ ++lreg; }
-	}
-	return sse42_compare_string_explicit_len(data1, data2, data2buf, cmpmode, lmem, lreg);
-}
-
-void SSE4_2_PCMPGTQ(void)
-{
-	int i;
-
-	SINT64 data2buf[2];
-	SINT64 *data1, *data2;
-	SSE_PART_GETDATA1DATA2_PD((double**)(&data1), (double**)(&data2), (double*)data2buf);
-	for(i=0;i<2;i++){
-		if (data1[i] > data2[i]){
-			data1[i] = 0xFFFFFFFFFFFFFFFF;
-		} else {
-			data1[i] = 0;
-		}
-	}
-	TRACEOUT(("SSE4_2_PCMPGTQ"));
-}
-
-void SSE4_2_PCMPESTRM(void)
-{
-	int i;
-	UINT32 tmp;
-
-	UINT32 op;
-
-	UINT8 data2buf[16];
-	UINT8 *data1, *data2;
-	SSE_PART_GETDATA1DATA2_PD((double**)(&data1), (double**)(&data2), (double*)data2buf);
-	GET_PCBYTE((op));
-	tmp = sse42_compare_string_explicit_len((UINT8**)(&data1), (UINT8**)(&data2), (UINT8*)data2buf,op,CPU_EDX,CPU_EAX);
-	if (op & 64){
-		switch (op & 1){
-			case 0:
-			for(i=0;i<16;++i){*((UINT8*)(data1 + (i * 1)))=((tmp>>i)&1)?0xff:0x00;}
-			break;
-			case 1:
-			for(i=0;i<8;++i){*((UINT16*)(data1 + (i * 2)))=((tmp>>i)&1)?0xffff:0x0000;}
-			break;
-		}
-	} else {
-		for(i=0;i<16;++i){data1[i] = 0;}
-		*((UINT16*)(data1 + (i * 2))) = tmp;
-	}
-	TRACEOUT(("SSE4_2_PCMPESTRM"));
-}
-
-void SSE4_2_PCMPESTRI(void)
-{
-	int i;
-	UINT32 tmp;
-
-	UINT32 op;
-
-	UINT8 data2buf[16];
-	UINT8 *data1, *data2;
-	SSE_PART_GETDATA1DATA2_PD((double**)(&data1), (double**)(&data2), (double*)data2buf);
-	GET_PCBYTE((op));
-	tmp = sse42_compare_string_explicit_len((UINT8**)(&data1), (UINT8**)(&data2), (UINT8*)data2buf,op,CPU_EDX,CPU_EAX);
-	if (!tmp){
-		CPU_ECX = (op&1)?8:16;
-	} else if (op & 64) {
-		CPU_ECX = 31;
-		for(i=0;i<32;i++){ CPU_ECX -= ((tmp>>i)&1)?0:1; }
-	}else{
-		CPU_ECX = 0;
-		for(i=0;i<32;i++){ if (((tmp>>i)&1)){ break; } CPU_ECX++; }
-	}
-	TRACEOUT(("SSE4_2_PCMPESTRI"));
-}
-
-void SSE4_2_PCMPISTRM(void)
-{
-	int i;
-	UINT32 tmp;
-
-	UINT32 op;
-
-	UINT8 data2buf[16];
-	UINT8 *data1, *data2;
-	SSE_PART_GETDATA1DATA2_PD((double**)(&data1), (double**)(&data2), (double*)data2buf);
-	GET_PCBYTE((op));
-	tmp = sse42_compare_string_inplicit_len((UINT8**)(&data1), (UINT8**)(&data2), (UINT8*)data2buf,op);
-	if (op & 64){
-		switch (op & 1){
-			case 0:
-			for(i=0;i<16;++i){*((UINT8*)(data1 + (i * 1)))=((tmp>>i)&1)?0xff:0x00;}
-			break;
-			case 1:
-			for(i=0;i<8;++i){*((UINT16*)(data1 + (i * 2)))=((tmp>>i)&1)?0xffff:0x0000;}
-			break;
-		}
-	} else {
-		for(i=0;i<16;++i){data1[i] = 0;}
-		*((UINT16*)(data1 + (i * 2))) = tmp;
-	}
-	TRACEOUT(("SSE4_2_PCMPISTRM"));
-}
-
-void SSE4_2_PCMPISTRI(void)
-{
-	int i;
-	UINT32 tmp;
-
-	UINT32 op;
-
-	UINT8 data2buf[16];
-	UINT8 *data1, *data2;
-	SSE_PART_GETDATA1DATA2_PD((double**)(&data1), (double**)(&data2), (double*)data2buf);
-	GET_PCBYTE((op));
-	tmp = sse42_compare_string_inplicit_len((UINT8**)(&data1), (UINT8**)(&data2), (UINT8*)data2buf,op);
-	if (!tmp){
-		CPU_ECX = (op&1)?8:16;
-	} else if (op & 64) {
-		CPU_ECX = 31;
-		for(i=0;i<32;i++){ CPU_ECX -= ((tmp>>i)&1)?0:1; }
-	}else{
-		CPU_ECX = 0;
-		for(i=0;i<32;i++){ if (((tmp>>i)&1)){ break; } CPU_ECX++; }
-	}
-	TRACEOUT(("SSE4_2_PCMPISTRI"));
-}
-
-void SSE4_2_CRC32_Gy_Eb(void)
-{
-	int i;
-
-	UINT32 op;
-
-	UINT32* out;
-	UINT32 madr, tmp, src;
-
-	tmp = 0;
-
-	GET_PCBYTE((op));
-
-	if (op >= 0xc0)
-	{
-		CPU_WORKCLOCK(21);
-		src = *(reg8_b20[op]);
-	}
-	else
-	{
-		CPU_WORKCLOCK(24);
-		madr = calc_ea_dst(op);
-		src = cpu_vmemoryread_b(CPU_INST_SEGREG_INDEX, madr);
-	}
-	out = reg32_b53[op];
-	tmp = *out;
-
-	tmp ^= src;
-	for(i=0;i<8;i++){
-		if (tmp & 1)
-		{
-			tmp = (tmp >> 1) ^ 0x82f63b78;
-		}else{
-			tmp = (tmp >> 1);
-		}
-	}
-	*out = (UINT32)tmp;
-	TRACEOUT(("SSE4_2_CRC32_Gy_Eb"));
-}
-
-void SSE4_2_CRC32_Gy_Eb_16(void)
-{
-	int i;
-
-	UINT32 op;
-
-	UINT32* out;
-	UINT32 madr, tmp, src;
-
-	tmp = 0;
-
-	GET_PCBYTE((op));
-
-	if (op >= 0xc0)
-	{
-		CPU_WORKCLOCK(21);
-		src = *(reg8_b20[op]);
-	}
-	else
-	{
-		CPU_WORKCLOCK(24);
-		madr = calc_ea_dst(op);
-		src = cpu_vmemoryread_b(CPU_INST_SEGREG_INDEX, madr);
-	}
-	out = (UINT32*)reg16_b53[op];
-	tmp = *out;
-
-	tmp ^= src;
-	for (i = 0; i < 8; i++)
-	{
-		if (tmp & 1)
-		{
-			tmp = (tmp >> 1) ^ 0x82f63b78;
-		}
-		else
-		{
-			tmp = (tmp >> 1);
-		}
-	}
-	*out = (UINT32)tmp;
-	TRACEOUT(("SSE4_2_CRC32_Gy_Eb"));
-}
-
-void SSE4_2_CRC32_Gy_Ev(void)
-{
-	int i, j;
-
-	UINT32 op;
-
-	UINT32* out;
-	UINT32 madr, tmp, src;
-
-	tmp = 0;
-
-	GET_PCBYTE((op));
-
-	if (op >= 0xc0)
-	{
-		CPU_WORKCLOCK(21);
-		src = *(reg32_b20[op]);
-	}
-	else
-	{
-		CPU_WORKCLOCK(24);
-		madr = calc_ea_dst(op);
-		src = cpu_vmemoryread_d(CPU_INST_SEGREG_INDEX, madr);
-	}
-	out = reg32_b53[op];
-	tmp = *out;
-
-	for(j=0;j<4;j++){
-		tmp ^= ((src >> (j * 8)) & 0xFF);
-		for(i=0;i<8;i++){
-			if (tmp & 1)
-			{
-				tmp = (tmp >> 1) ^ 0x82f63b78;
-			}else{
-				tmp = (tmp >> 1);
-			}
-		}
-	}
-	*out = (UINT32)tmp;
-	TRACEOUT(("SSE4_2_CRC32_Gy_Ev"));
-}
-
-void SSE4_2_CRC32_Gy_Ev_16(void)
-{
-	int i, j;
-
-	UINT32 op;
-
-	UINT32* out;
-	UINT32 madr, tmp, src;
-
-	tmp = 0;
-
-	GET_PCBYTE((op));
-
-	if (op >= 0xc0)
-	{
-		CPU_WORKCLOCK(21);
-		src = *(reg16_b20[op]);
-	}
-	else
-	{
-		CPU_WORKCLOCK(24);
-		madr = calc_ea_dst(op);
-		src = cpu_vmemoryread_d(CPU_INST_SEGREG_INDEX, madr);
-	}
-	out = (UINT32*)reg16_b53[op];
-	tmp = *out;
-
-	for (j = 0; j < 2; j++)
-	{
-		tmp ^= ((src >> (j * 8)) & 0xFF);
-		for (i = 0; i < 8; i++)
-		{
-			if (tmp & 1)
-			{
-				tmp = (tmp >> 1) ^ 0x82f63b78;
-			}
-			else
-			{
-				tmp = (tmp >> 1);
-			}
-		}
-	}
-	*out = (UINT32)tmp;
-	TRACEOUT(("SSE4_2_CRC32_Gy_Ev"));
-}
-
-void SSE4_2_POPCNT_16(void)
-{
-	int i;
-
-	UINT32 op;
-
-	UINT16 *out;
-	UINT32 madr,tmp,src;
-
-	if (!(i386cpuid.cpu_feature_ecx & CPU_FEATURE_ECX_POPCNT)) {
-		EXCEPTION(UD_EXCEPTION, 0);
-		return;
-	}
-
-	tmp = 0;
-
-	GET_PCBYTE((op));
-
-	if (op >= 0xc0) {
-		CPU_WORKCLOCK(21);
-		src = *(reg16_b20[op]);
-	} else {
-		CPU_WORKCLOCK(24);
-		madr = calc_ea_dst(op);
-		src = cpu_vmemoryread_w(CPU_INST_SEGREG_INDEX, madr);
-	}
-
-	for(i=0;i<16;i++){
-		tmp += ((src>>i)&1);
-	}
-
-	CPU_WORKCLOCK(2);
-	out = reg16_b53[op];
-	*out = (UINT16)tmp;
-
-	CPU_FLAG &=  ~C_FLAG;
-	CPU_FLAG &=  ~Z_FLAG;
-	CPU_FLAG &=  ~S_FLAG;
-	CPU_FLAG &=  ~O_FLAG;
-	CPU_FLAG &=  ~A_FLAG;
-	CPU_FLAG &=  ~P_FLAG;
-	if (tmp == 0){CPU_FLAG |=  Z_FLAG;}
-}
-
-void SSE4_2_POPCNT_32(void)
-{
-	int i;
-
-	UINT32 op;
-
-	UINT32 *out;
-	UINT32 madr,tmp,src;
-	
-	if(!(i386cpuid.cpu_feature_ecx & CPU_FEATURE_ECX_POPCNT)){
-		EXCEPTION(UD_EXCEPTION, 0);
-		return;
-	}
-
-	tmp = 0;
-
-	GET_PCBYTE((op));
-
-	if (op >= 0xc0) {
-		CPU_WORKCLOCK(21);
-		src = *(reg32_b20[op]);
-	} else {
-		CPU_WORKCLOCK(24);
-		madr = calc_ea_dst(op);
-		src = cpu_vmemoryread_d(CPU_INST_SEGREG_INDEX, madr);
-	}
-
-	for(i=0;i<32;i++){
-		tmp += ((src>>i)&1);
-	}
-
-	CPU_WORKCLOCK(2);
-	out = reg32_b53[op];
-	*out = (UINT32)tmp;
-
-	CPU_FLAG &=  ~C_FLAG;
-	CPU_FLAG &=  ~Z_FLAG;
-	CPU_FLAG &=  ~S_FLAG;
-	CPU_FLAG &=  ~O_FLAG;
-	CPU_FLAG &=  ~A_FLAG;
-	CPU_FLAG &=  ~P_FLAG;
-	if (tmp == 0){CPU_FLAG |=  Z_FLAG;}
-}
-
-#else
-
-void SSE4_2_PCMPGTQ(void)
-{
-	EXCEPTION(UD_EXCEPTION, 0);
-}
-
-void SSE4_2_PCMPESTRM(void)
-{
-	EXCEPTION(UD_EXCEPTION, 0);
-}
-
-void SSE4_2_PCMPESTRI(void)
-{
-	EXCEPTION(UD_EXCEPTION, 0);
-}
-
-void SSE4_2_PCMPISTRM(void)
-{
-	EXCEPTION(UD_EXCEPTION, 0);
-}
-
-void SSE4_2_PCMPISTRI(void)
-{
-	EXCEPTION(UD_EXCEPTION, 0);
-}
-
-void SSE4_2_CRC32_Gy_Eb(void)
-{
-	EXCEPTION(UD_EXCEPTION, 0);
-}
-
-void SSE4_2_CRC32_Gy_Ev(void)
-{
-	EXCEPTION(UD_EXCEPTION, 0);
-}
-
-void SSE4_2_CRC32_Gy_Eb_16(void)
-{
-	EXCEPTION(UD_EXCEPTION, 0);
-}
-
-void SSE4_2_CRC32_Gy_Ev_16(void)
-{
-	EXCEPTION(UD_EXCEPTION, 0);
-}
-
-void SSE4_2_POPCNT_16(void)
-{
-	EXCEPTION(UD_EXCEPTION, 0);
-}
-
-void SSE4_2_POPCNT_32(void)
-{
-	EXCEPTION(UD_EXCEPTION, 0);
-}
-
-#endif
\ No newline at end of file
diff -ruN source/src/vm/np21/i386c/ia32/instructions/sse4/sse4_2.h src/vm/np21/i386c/ia32/instructions/sse4/sse4_2.h
--- source/src/vm/np21/i386c/ia32/instructions/sse4/sse4_2.h	2025-04-28 16:00:00
+++ src/vm/np21/i386c/ia32/instructions/sse4/sse4_2.h	1970-01-01 09:00:00
@@ -1,49 +0,0 @@
-/*
- * Copyright (c) 2024 Gocaine Project
- * All rights reserved.
- *
- * Redistribution and use in source and binary forms, with or without
- * modification, are permitted provided that the following conditions
- * are met:
- * 1. Redistributions of source code must retain the above copyright
- *    notice, this list of conditions and the following disclaimer.
- * 2. Redistributions in binary form must reproduce the above copyright
- *    notice, this list of conditions and the following disclaimer in the
- *    documentation and/or other materials provided with the distribution.
- *
- * THIS SOFTWARE IS PROVIDED BY THE AUTHOR ``AS IS'' AND ANY EXPRESS OR
- * IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES
- * OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED.
- * IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY DIRECT, INDIRECT,
- * INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT
- * NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,
- * DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY
- * THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
- * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF
- * THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
- */
-
-#ifndef	IA32_CPU_INSTRUCTION_SSE4_SSE4_2_H__
-#define	IA32_CPU_INSTRUCTION_SSE4_SSE4_2_H__
-
-//#ifdef __cplusplus
-//extern "C" {
-//#endif
-
-void SSE4_2_PCMPGTQ(void);
-void SSE4_2_PCMPESTRM(void);
-void SSE4_2_PCMPESTRI(void);
-void SSE4_2_PCMPISTRM(void);
-void SSE4_2_PCMPISTRI(void);
-void SSE4_2_CRC32_Gy_Eb(void);
-void SSE4_2_CRC32_Gy_Ev(void);
-void SSE4_2_CRC32_Gy_Eb_16(void);
-void SSE4_2_CRC32_Gy_Ev_16(void);
-void SSE4_2_POPCNT_16(void);
-void SSE4_2_POPCNT_32(void);
-
-//#ifdef __cplusplus
-//}
-//#endif
-
-#endif	/* IA32_CPU_INSTRUCTION_SSE4_SSE4_2_H__ */
diff -ruN source/src/vm/np21/i386c/ia32/instructions/sse4a/sse4a.cpp src/vm/np21/i386c/ia32/instructions/sse4a/sse4a.cpp
--- source/src/vm/np21/i386c/ia32/instructions/sse4a/sse4a.cpp	2025-04-28 16:00:00
+++ src/vm/np21/i386c/ia32/instructions/sse4a/sse4a.cpp	1970-01-01 09:00:00
@@ -1,288 +0,0 @@
-/*
- * Copyright (c) 2024 SimK
- * All rights reserved.
- *
- * Redistribution and use in source and binary forms, with or without
- * modification, are permitted provided that the following conditions
- * are met:
- * 1. Redistributions of source code must retain the above copyright
- *    notice, this list of conditions and the following disclaimer.
- * 2. Redistributions in binary form must reproduce the above copyright
- *    notice, this list of conditions and the following disclaimer in the
- *    documentation and/or other materials provided with the distribution.
- *
- * THIS SOFTWARE IS PROVIDED BY THE AUTHOR ``AS IS'' AND ANY EXPRESS OR
- * IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES
- * OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED.
- * IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY DIRECT, INDIRECT,
- * INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT
- * NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,
- * DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY
- * THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
- * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF
- * THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
- */
-
-// AMD64 Architecture ProgrammerÅfs Manual Volume 4 ÇÃê‡ñæÇå©Çƒé¿ëï
-	
-//#include "compiler.h"
-
-#include <math.h>
-#include <float.h>
-
-#define isnan(x) (_isnan(x))
-
-#include "../../cpu.h"
-#include "../../ia32.mcr"
-
-#include "../sse/sse.h"
-#include "../sse2/sse2.h"
-#include "../sse3/sse3.h"
-#include "sse4a.h"
-
-#if defined(USE_SSE4A) && defined(USE_SSE3) && defined(USE_SSE2) && defined(USE_SSE) && defined(USE_FPU)
-
-#define CPU_SSE4AWORKCLOCK	CPU_WORKCLOCK(2)
-
-static INLINE void
-SSE4a_check_NM_EXCEPTION(){
-	if(!(i386cpuid.cpu_feature_ex_ecx & CPU_FEATURE_EX_ECX_SSE4A)){
-		EXCEPTION(UD_EXCEPTION, 0);
-	}
-	if(CPU_CR0 & CPU_CR0_EM){
-		EXCEPTION(UD_EXCEPTION, 0);
-	}
-	if (CPU_CR0 & CPU_CR0_TS) {
-		EXCEPTION(NM_EXCEPTION, 0);
-	}
-}
-
-static INLINE void
-SSE4a_setTag(void)
-{
-}
-
-static INLINE void
-MMX_setTag(void)
-{
-	int i;
-	
-	if(!FPU_STAT.mmxenable){
-		FPU_STAT.mmxenable = 1;
-		//FPU_CTRLWORD = 0x27F;
-		for (i = 0; i < FPU_REG_NUM; i++) {
-			FPU_STAT.tag[i] = TAG_Valid;
-#ifdef SUPPORT_FPU_DOSBOX2
-			FPU_STAT.int_regvalid[i] = 0;
-#endif
-			FPU_STAT.reg[i].ul.ext = 0xffff;
-		}
-	}
-	FPU_STAT_TOP = 0;
-	FPU_STATUSWORD &= ~0x3800;
-	FPU_STATUSWORD |= (FPU_STAT_TOP&7)<<11;
-}
-
-/*
- * SSE4a interface
- */
-
-// xmm/m128 -> xmm
-static INLINE void SSE_PART_GETDATA1DATA2_PD(double **data1, double **data2, double *data2buf){
-	UINT32 op;
-	UINT idx, sub;
-	
-	SSE4a_check_NM_EXCEPTION();
-	SSE4a_setTag();
-	CPU_SSE4AWORKCLOCK;
-	GET_PCBYTE((op));
-	idx = (op >> 3) & 7;
-	sub = (op & 7);
-	*data1 = (double*)(&(FPU_STAT.xmm_reg[idx]));
-	if ((op) >= 0xc0) {
-		*data2 = (double*)(&(FPU_STAT.xmm_reg[sub]));
-	} else {
-		UINT32 maddr;
-		maddr = calc_ea_dst((op));
-		*((UINT64*)(data2buf+ 0)) = cpu_vmemoryread_q(CPU_INST_SEGREG_INDEX, maddr+ 0);
-		*((UINT64*)(data2buf+ 1)) = cpu_vmemoryread_q(CPU_INST_SEGREG_INDEX, maddr+ 8);
-		*data2 = data2buf;
-	}
-}
-
-static INLINE void MMX_PART_GETDATA1DATA2_PD(float **data1, float **data2, float *data2buf){
-	UINT32 op;
-	UINT idx, sub;
-	
-	SSE4a_check_NM_EXCEPTION();
-	SSE4a_setTag();
-	CPU_SSE4AWORKCLOCK;
-	GET_PCBYTE((op));
-	idx = (op >> 3) & 7;
-	sub = (op & 7);
-	*data1 = (float*)(&(FPU_STAT.reg[idx]));
-	if ((op) >= 0xc0) {
-		*data2 = (float*)(&(FPU_STAT.reg[sub]));
-	} else {
-		UINT32 maddr;
-		maddr = calc_ea_dst((op));
-		*((UINT32*)(data2buf+ 0)) = cpu_vmemoryread_d(CPU_INST_SEGREG_INDEX, maddr);
-		*((UINT32*)(data2buf+ 1)) = cpu_vmemoryread_d(CPU_INST_SEGREG_INDEX, maddr + 4);
-		*data2 = data2buf;
-	}
-}
-
-void SSE4a_MOVNTSD(void)
-{
-	UINT32 op;
-	UINT idx, sub;
-	float* data1;
-
-	// 00001111:00101011 mod xmmreg r/m
-
-	SSE4a_check_NM_EXCEPTION();
-	SSE4a_setTag();
-	CPU_SSE4AWORKCLOCK;
-	GET_PCBYTE((op));
-	idx = (op >> 3) & 7;
-	sub = (op & 7);
-	data1 = (float*)(&(FPU_STAT.xmm_reg[idx]));
-	if ((op) >= 0xc0)
-	{
-		// XXX: Ç±Ç±ÇÕÇ«Ç§àµÇ§?
-		EXCEPTION(UD_EXCEPTION, 0);
-		//data2 = (float*)(&(FPU_STAT.xmm_reg[sub]));
-		//for(i=0;i<4;i++){
-		//	data2[i] = data1[i];
-		//}
-	}
-	else
-	{
-		UINT32 madr;
-		madr = calc_ea_dst(op);
-		cpu_vmemorywrite_d(CPU_INST_SEGREG_INDEX, madr + 0, *((UINT32*)(data1 + 0)));
-		cpu_vmemorywrite_d(CPU_INST_SEGREG_INDEX, madr + 4, *((UINT32*)(data1 + 1)));
-	}
-	TRACEOUT(("SSE4a_MOVNTSD"));
-}
-void SSE4a_MOVNTSS(void)
-{
-	UINT32 op;
-	UINT idx, sub;
-	float* data1;
-
-	// 00001111:00101011 mod xmmreg r/m
-
-	SSE4a_check_NM_EXCEPTION();
-	SSE4a_setTag();
-	CPU_SSE4AWORKCLOCK;
-	GET_PCBYTE((op));
-	idx = (op >> 3) & 7;
-	sub = (op & 7);
-	data1 = (float*)(&(FPU_STAT.xmm_reg[idx]));
-	if ((op) >= 0xc0)
-	{
-		// XXX: Ç±Ç±ÇÕÇ«Ç§àµÇ§?
-		EXCEPTION(UD_EXCEPTION, 0);
-		//data2 = (float*)(&(FPU_STAT.xmm_reg[sub]));
-		//for(i=0;i<4;i++){
-		//	data2[i] = data1[i];
-		//}
-}
-	else
-	{
-		UINT32 madr;
-		madr = calc_ea_dst(op);
-		cpu_vmemorywrite_d(CPU_INST_SEGREG_INDEX, madr + 0, *((UINT32*)(data1 + 0)));
-	}
-	TRACEOUT(("SSE4a_MOVNTSS"));
-}
-void SSE4a_INSERTQimm(void)
-{
-	UINT32 op2, op3;
-	UINT64 data2buf[2];
-	UINT64* data1, * data2;
-	UINT64 bitrangedx;
-
-	SSE_PART_GETDATA1DATA2_PD((double**)(&data1), (double**)(&data2), (double*)data2buf);
-	GET_PCBYTE((op2));
-	GET_PCBYTE((op3));
-	bitrangedx = ((op2 & 63) == 0) ? ((UINT64)0xffffffffffffffff) : ((UINT64)((((SINT64)1) << (op2 & 63)) - ((SINT64)1)));
-	data1[0] = (data1[0] & (~(bitrangedx << (op3 & 63)))) | ((data2buf[0] & bitrangedx) << (op3 & 63));
-
-	TRACEOUT(("SSE4a_INSERTQimm"));
-}
-void SSE4a_INSERTQxmm(void)
-{
-	UINT32 op2, op3;
-	UINT64 data2buf[2];
-	UINT64* data1, * data2;
-	UINT64 bitrangedx;
-
-	SSE_PART_GETDATA1DATA2_PD((double**)(&data1), (double**)(&data2), (double*)data2buf);
-	op2 = ((data2buf[1] >> (8 * 0)) & 63);
-	op3 = ((data2buf[1] >> (8 * 1)) & 63);
-	bitrangedx = ((op2 & 63) == 0) ? ((UINT64)0xffffffffffffffff) : ((UINT64)((((SINT64)1) << (op2 & 63)) - ((SINT64)1)));
-	data1[0] = (data1[0] & (~(bitrangedx << (op3 & 63)))) | ((data2buf[0] & bitrangedx) << (op3 & 63));
-
-	TRACEOUT(("SSE4a_INSERTQxmm"));
-}
-void SSE4a_EXTRQimm(void)
-{
-	UINT32 op2, op3;
-	UINT64 data2buf[2];
-	UINT64* data1, * data2;
-	UINT64 bitrangedx;
-
-	SSE_PART_GETDATA1DATA2_PD((double**)(&data1), (double**)(&data2), (double*)data2buf);
-	GET_PCBYTE((op2));
-	GET_PCBYTE((op3));
-	bitrangedx = ((op2 & 63) == 0) ? ((UINT64)0xffffffffffffffff) : ((UINT64)((((SINT64)1) << (op2 & 63)) - ((SINT64)1)));
-	data1[0] = (data1[0] & (~(bitrangedx))) | ((data1[0] >> (op3 & 63)) & bitrangedx);
-
-	TRACEOUT(("SSE4a_EXTRQimm"));
-}
-void SSE4a_EXTRQxmm(void)
-{
-	UINT32 op2, op3;
-	UINT64 data2buf[2];
-	UINT64* data1, * data2;
-	UINT64 bitrangedx;
-
-	SSE_PART_GETDATA1DATA2_PD((double**)(&data1), (double**)(&data2), (double*)data2buf);
-	op2 = ((data2buf[0] >> (8 * 0)) & 63);
-	op3 = ((data2buf[0] >> (8 * 1)) & 63);
-	bitrangedx = ((op2 & 63) == 0) ? ((UINT64)0xffffffffffffffff) : ((UINT64)((((SINT64)1) << (op2 & 63)) - ((SINT64)1)));
-	data1[0] = (data1[0] & (~(bitrangedx))) | ((data1[0] >> (op3 & 63)) & bitrangedx);
-
-	TRACEOUT(("SSE4a_EXTRQxmm"));
-}
-
-#else
-
-void SSE4a_MOVNTSD(void)
-{
-	EXCEPTION(UD_EXCEPTION, 0);
-}
-void SSE4a_MOVNTSS(void)
-{
-	EXCEPTION(UD_EXCEPTION, 0);
-}
-void SSE4a_INSERTQimm(void)
-{
-	EXCEPTION(UD_EXCEPTION, 0);
-}
-void SSE4a_INSERTQxmm(void)
-{
-	EXCEPTION(UD_EXCEPTION, 0);
-}
-void SSE4a_EXTRQimm(void)
-{
-	EXCEPTION(UD_EXCEPTION, 0);
-}
-void SSE4a_EXTRQxmm(void)
-{
-	EXCEPTION(UD_EXCEPTION, 0);
-}
-
-#endif
\ No newline at end of file
diff -ruN source/src/vm/np21/i386c/ia32/instructions/sse4a/sse4a.h src/vm/np21/i386c/ia32/instructions/sse4a/sse4a.h
--- source/src/vm/np21/i386c/ia32/instructions/sse4a/sse4a.h	2025-04-28 16:00:00
+++ src/vm/np21/i386c/ia32/instructions/sse4a/sse4a.h	1970-01-01 09:00:00
@@ -1,44 +0,0 @@
-/*
- * Copyright (c) 2024 SimK
- * All rights reserved.
- *
- * Redistribution and use in source and binary forms, with or without
- * modification, are permitted provided that the following conditions
- * are met:
- * 1. Redistributions of source code must retain the above copyright
- *    notice, this list of conditions and the following disclaimer.
- * 2. Redistributions in binary form must reproduce the above copyright
- *    notice, this list of conditions and the following disclaimer in the
- *    documentation and/or other materials provided with the distribution.
- *
- * THIS SOFTWARE IS PROVIDED BY THE AUTHOR ``AS IS'' AND ANY EXPRESS OR
- * IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES
- * OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED.
- * IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY DIRECT, INDIRECT,
- * INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT
- * NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,
- * DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY
- * THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
- * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF
- * THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
- */
-
-#ifndef	IA32_CPU_INSTRUCTION_SSE4A_SSE4A_H__
-#define	IA32_CPU_INSTRUCTION_SSE4A_SSE4A_H__
-
-//#ifdef __cplusplus
-//extern "C" {
-//#endif
-
-void SSE4a_MOVNTSD(void);
-void SSE4a_MOVNTSS(void);
-void SSE4a_EXTRQimm(void);
-void SSE4a_EXTRQxmm(void);
-void SSE4a_INSERTQimm(void);
-void SSE4a_INSERTQxmm(void);
-
-//#ifdef __cplusplus
-//}
-//#endif
-
-#endif	/* IA32_CPU_INSTRUCTION_SSE4A_SSE4A_H__ */
diff -ruN source/src/vm/np21/i386c/ia32/instructions/ssse3/ssse3.cpp src/vm/np21/i386c/ia32/instructions/ssse3/ssse3.cpp
--- source/src/vm/np21/i386c/ia32/instructions/ssse3/ssse3.cpp	2025-04-28 16:00:00
+++ src/vm/np21/i386c/ia32/instructions/ssse3/ssse3.cpp	1970-01-01 09:00:00
@@ -1,804 +0,0 @@
-/*
- * Copyright (c) 2024 Gocaine Project
- * All rights reserved.
- *
- * Redistribution and use in source and binary forms, with or without
- * modification, are permitted provided that the following conditions
- * are met:
- * 1. Redistributions of source code must retain the above copyright
- *    notice, this list of conditions and the following disclaimer.
- * 2. Redistributions in binary form must reproduce the above copyright
- *    notice, this list of conditions and the following disclaimer in the
- *    documentation and/or other materials provided with the distribution.
- *
- * THIS SOFTWARE IS PROVIDED BY THE AUTHOR ``AS IS'' AND ANY EXPRESS OR
- * IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES
- * OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED.
- * IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY DIRECT, INDIRECT,
- * INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT
- * NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,
- * DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY
- * THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
- * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF
- * THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
- */
-
-//#include "compiler.h"
-
-#include <math.h>
-#include <float.h>
-
-#define isnan(x) (_isnan(x))
-
-#include "../../cpu.h"
-#include "../../ia32.mcr"
-
-#include "../sse/sse.h"
-#include "../sse2/sse2.h"
-#include "../sse3/sse3.h"
-#include "ssse3.h"
-
-#if defined(USE_SSSE3) && defined(USE_SSE3) && defined(USE_SSE2) && defined(USE_SSE) && defined(USE_FPU)
-
-#define CPU_SSSE3WORKCLOCK	CPU_WORKCLOCK(2)
-
-static INLINE void
-SSSE3_check_NM_EXCEPTION(){
-	// SSSE3Ç»ÇµÇ»ÇÁUD(ñ≥å¯ÉIÉyÉRÅ[Éhó·äO)Çî≠ê∂Ç≥ÇπÇÈ
-	if(!(i386cpuid.cpu_feature_ecx & CPU_FEATURE_ECX_SSSE3)){
-		EXCEPTION(UD_EXCEPTION, 0);
-	}
-	// ÉGÉ~ÉÖÉåÅ[ÉVÉáÉìÇ»ÇÁUD(ñ≥å¯ÉIÉyÉRÅ[Éhó·äO)Çî≠ê∂Ç≥ÇπÇÈ
-	if(CPU_CR0 & CPU_CR0_EM){
-		EXCEPTION(UD_EXCEPTION, 0);
-	}
-	// É^ÉXÉNÉXÉCÉbÉ`éûÇ…NM(ÉfÉoÉCÉXégópïsâ¬ó·äO)Çî≠ê∂Ç≥ÇπÇÈ
-	if (CPU_CR0 & CPU_CR0_TS) {
-		EXCEPTION(NM_EXCEPTION, 0);
-	}
-}
-
-static INLINE void
-SSSE3_setTag(void)
-{
-}
-
-// mmx.cÇÃÇ‡ÇÃÇ∆ìØÇ∂
-static INLINE void
-MMX_setTag(void)
-{
-	int i;
-	
-	if(!FPU_STAT.mmxenable){
-		FPU_STAT.mmxenable = 1;
-		//FPU_CTRLWORD = 0x27F;
-		for (i = 0; i < FPU_REG_NUM; i++) {
-			FPU_STAT.tag[i] = TAG_Valid;
-#ifdef SUPPORT_FPU_DOSBOX2
-			FPU_STAT.int_regvalid[i] = 0;
-#endif
-			FPU_STAT.reg[i].ul.ext = 0xffff;
-		}
-	}
-	FPU_STAT_TOP = 0;
-	FPU_STATUSWORD &= ~0x3800;
-	FPU_STATUSWORD |= (FPU_STAT_TOP&7)<<11;
-}
-
-/*
- * SSE3 interface
- */
-
-// ÉRÅ[ÉhÇ™í∑Ç≠Ç»ÇÈÇÃÇ≈Ç‚Ç‚ã≠à¯Ç…ã§í âª
-// xmm/m128 -> xmm
-static INLINE void SSE_PART_GETDATA1DATA2_PD(double **data1, double **data2, double *data2buf){
-	UINT32 op;
-	UINT idx, sub;
-	
-	SSSE3_check_NM_EXCEPTION();
-	SSSE3_setTag();
-	CPU_SSSE3WORKCLOCK;
-	GET_PCBYTE((op));
-	idx = (op >> 3) & 7;
-	sub = (op & 7);
-	*data1 = (double*)(&(FPU_STAT.xmm_reg[idx]));
-	if ((op) >= 0xc0) {
-		*data2 = (double*)(&(FPU_STAT.xmm_reg[sub]));
-	} else {
-		UINT32 maddr;
-		maddr = calc_ea_dst((op));
-		*((UINT64*)(data2buf+ 0)) = cpu_vmemoryread_q(CPU_INST_SEGREG_INDEX, maddr+ 0);
-		*((UINT64*)(data2buf+ 1)) = cpu_vmemoryread_q(CPU_INST_SEGREG_INDEX, maddr+ 8);
-		*data2 = data2buf;
-	}
-}
-
-static INLINE void MMX_PART_GETDATA1DATA2_PD(float **data1, float **data2, float *data2buf){
-	UINT32 op;
-	UINT idx, sub;
-	
-	SSSE3_check_NM_EXCEPTION();
-	SSSE3_setTag();
-	CPU_SSSE3WORKCLOCK;
-	GET_PCBYTE((op));
-	idx = (op >> 3) & 7;
-	sub = (op & 7);
-	*data1 = (float*)(&(FPU_STAT.reg[idx]));
-	if ((op) >= 0xc0) {
-		*data2 = (float*)(&(FPU_STAT.reg[sub]));
-	} else {
-		UINT32 maddr;
-		maddr = calc_ea_dst((op));
-		*((UINT32*)(data2buf+ 0)) = cpu_vmemoryread_d(CPU_INST_SEGREG_INDEX, maddr);
-		*((UINT32*)(data2buf+ 1)) = cpu_vmemoryread_d(CPU_INST_SEGREG_INDEX, maddr + 4);
-		*data2 = data2buf;
-	}
-}
-
-void SSSE3_PSHUFB(void)
-{
-	int i;
-
-	UINT8 data2buf[16];
-	UINT8 *data1, *data2;
-	SSE_PART_GETDATA1DATA2_PD((double**)(&data1), (double**)(&data2), (double*)data2buf);
-	for(i=0;i<16;i++){
-		if (data2[i]&128){
-			data1[i] = 0;
-		} else {
-			data1[i] = data2buf[data2[i]&7];
-		}
-	}
-	TRACEOUT(("SSSE3_PSHUFB"));
-}
-
-void SSSE3_PSHUFB_MM(void)
-{
-	int i;
-
-	UINT8 data2buf[8];
-	UINT8 *data1, *data2;
-	MMX_PART_GETDATA1DATA2_PD((float**)(&data1), (float**)(&data2), (float*)data2buf);
-	for(i=0;i<8;i++){
-		if (data2[i]&128){
-			data1[i] = 0;
-		} else {
-			data1[i] = data2buf[data2[i]&7];
-		}
-	}
-	TRACEOUT(("SSSE3_PSHUFB"));
-}
-
-void SSSE3_PHADDW(void)
-{
-	UINT16 data2buf[8];
-	UINT16 *data1, *data2;
-	SSE_PART_GETDATA1DATA2_PD((double**)(&data1), (double**)(&data2), (double*)data2buf);
-	data1[0] = data1[1] + data1[0];
-	data1[1] = data1[3] + data1[2];
-	data1[2] = data1[5] + data1[4];
-	data1[3] = data1[7] + data1[6];
-	data1[4] = data2[1] + data2[0];
-	data1[5] = data2[3] + data2[2];
-	data1[6] = data2[5] + data2[4];
-	data1[7] = data2[7] + data2[6];
-	TRACEOUT(("SSSE3_PHADDW"));
-}
-
-void SSSE3_PHADDW_MM(void)
-{
-	UINT16 data2buf[4];
-	UINT16 *data1, *data2;
-	MMX_PART_GETDATA1DATA2_PD((float**)(&data1), (float**)(&data2), (float*)data2buf);
-	data1[0] = data1[1] + data1[0];
-	data1[1] = data1[3] + data1[2];
-	data1[2] = data2[1] + data2[0];
-	data1[3] = data2[3] + data2[2];
-	TRACEOUT(("SSSE3_PHADDW"));
-}
-
-void SSSE3_PHADDD(void)
-{
-	UINT32 data2buf[4];
-	UINT32 *data1, *data2;
-	SSE_PART_GETDATA1DATA2_PD((double**)(&data1), (double**)(&data2), (double*)data2buf);
-	data1[0] = data1[1] + data1[0];
-	data1[1] = data1[3] + data1[2];
-	data1[2] = data2[1] + data2[0];
-	data1[3] = data2[3] + data2[2];
-	TRACEOUT(("SSSE3_PHADDD"));
-}
-
-void SSSE3_PHADDD_MM(void)
-{
-	UINT32 data2buf[2];
-	UINT32 *data1, *data2;
-	MMX_PART_GETDATA1DATA2_PD((float**)(&data1), (float**)(&data2), (float*)data2buf);
-	data1[0] = data1[1] + data1[0];
-	data1[1] = data2[1] + data2[0];
-	TRACEOUT(("SSSE3_PHADDD"));
-}
-
-void SSSE3_PHADDSW(void)
-{
-	int i;
-
-	SINT16 data2buf[8];
-	SINT16 *data1, *data2;
-	SINT32 tmpsinedcalc;
-	SSE_PART_GETDATA1DATA2_PD((double**)(&data1), (double**)(&data2), (double*)data2buf);
-	for(i=0;i<4;i++){
-		tmpsinedcalc = data1[i * 2 + 0] + data1[i * 2 + 1]; data1[i + 0] = (tmpsinedcalc>32767)?32767:(((tmpsinedcalc)<-32768)?-32768:tmpsinedcalc);
-		tmpsinedcalc = data2[i * 2 + 0] + data2[i * 2 + 1]; data1[i + 4] = (tmpsinedcalc>32767)?32767:(((tmpsinedcalc)<-32768)?-32768:tmpsinedcalc);
-	}
-	TRACEOUT(("SSSE3_PHADDSW"));
-}
-
-void SSSE3_PHADDSW_MM(void)
-{
-	int i;
-
-	SINT16 data2buf[4];
-	SINT16 *data1, *data2;
-	SINT32 tmpsinedcalc;
-	MMX_PART_GETDATA1DATA2_PD((float**)(&data1), (float**)(&data2), (float*)data2buf);
-	for(i=0;i<2;i++){
-		tmpsinedcalc = data1[i * 2 + 0] + data1[i * 2 + 1]; data1[i + 0] = (tmpsinedcalc>32767)?32767:(((tmpsinedcalc)<-32768)?-32768:tmpsinedcalc);
-		tmpsinedcalc = data2[i * 2 + 0] + data2[i * 2 + 1]; data1[i + 2] = (tmpsinedcalc>32767)?32767:(((tmpsinedcalc)<-32768)?-32768:tmpsinedcalc);
-	}
-	TRACEOUT(("SSSE3_PHADDSW"));
-}
-
-void SSSE3_PMADDUBSW(void)
-{
-	int i;
-
-	SINT16 data2buf[8];
-	SINT16 *data1, *data2;
-	SINT32 tmpsinedcalc;
-	SSE_PART_GETDATA1DATA2_PD((double**)(&data1), (double**)(&data2), (double*)data2buf);
-	for(i=0;i<8;i++){
-		tmpsinedcalc = (INT32)(data1[i * 2 + 0]) * data2[i * 2 + 0] + (INT32)(data1[i * 2 + 1]) * data2[i * 2 + 1];
-		data1[i] = (tmpsinedcalc>32767)?32767:(((tmpsinedcalc)<-32768)?-32768:tmpsinedcalc);
-	}
-	TRACEOUT(("SSSE3_PMADDUBSW"));
-}
-
-void SSSE3_PMADDUBSW_MM(void)
-{
-	int i;
-
-	SINT16 data2buf[4];
-	SINT16 *data1, *data2;
-	SINT32 tmpsinedcalc;
-	MMX_PART_GETDATA1DATA2_PD((float**)(&data1), (float**)(&data2), (float*)data2buf);
-	for(i=0;i<4;i++){
-		tmpsinedcalc = (INT32)(data1[i * 2 + 0]) * data2[i * 2 + 0] + (INT32)(data1[i * 2 + 1]) * data2[i * 2 + 1];
-		data1[i] = (tmpsinedcalc>32767)?32767:(((tmpsinedcalc)<-32768)?-32768:tmpsinedcalc);
-	}
-	TRACEOUT(("SSSE3_PMADDUBSW"));
-}
-
-void SSSE3_PHSUBW(void)
-{
-	UINT16 data2buf[8];
-	UINT16 *data1, *data2;
-	SSE_PART_GETDATA1DATA2_PD((double**)(&data1), (double**)(&data2), (double*)data2buf);
-	data1[0] = data1[0] - data1[1];
-	data1[1] = data1[2] - data1[3];
-	data1[2] = data1[4] - data1[5];
-	data1[3] = data1[6] - data1[7];
-	data1[4] = data2[0] - data2[1];
-	data1[5] = data2[2] - data2[3];
-	data1[6] = data2[4] - data2[5];
-	data1[7] = data2[6] - data2[7];
-	TRACEOUT(("SSSE3_PHSUBW"));
-}
-
-void SSSE3_PHSUBW_MM(void)
-{
-	UINT16 data2buf[4];
-	UINT16 *data1, *data2;
-	MMX_PART_GETDATA1DATA2_PD((float**)(&data1), (float**)(&data2), (float*)data2buf);
-	data1[0] = data1[0] - data1[1];
-	data1[1] = data1[2] - data1[3];
-	data1[2] = data2[0] - data2[1];
-	data1[3] = data2[2] - data2[3];
-	TRACEOUT(("SSSE3_PHSUBW"));
-}
-
-void SSSE3_PHSUBD(void)
-{
-	UINT32 data2buf[4];
-	UINT32 *data1, *data2;
-	SSE_PART_GETDATA1DATA2_PD((double**)(&data1), (double**)(&data2), (double*)data2buf);
-	data1[0] = data1[0] - data1[1];
-	data1[1] = data1[2] - data1[3];
-	data1[2] = data2[0] - data2[1];
-	data1[3] = data2[2] - data2[3];
-	TRACEOUT(("SSSE3_PHSUBD"));
-}
-
-void SSSE3_PHSUBD_MM(void)
-{
-	UINT32 data2buf[2];
-	UINT32 *data1, *data2;
-	MMX_PART_GETDATA1DATA2_PD((float**)(&data1), (float**)(&data2), (float*)data2buf);
-	data1[0] = data1[0] - data1[1];
-	data1[1] = data2[0] - data2[1];
-	TRACEOUT(("SSSE3_PHSUBD"));
-}
-
-void SSSE3_PHSUBSW(void)
-{
-	UINT16 data2buf[8];
-	UINT16 *data1, *data2;
-	INT32 tmpsinedcalc;
-	SSE_PART_GETDATA1DATA2_PD((double**)(&data1), (double**)(&data2), (double*)data2buf);
-	tmpsinedcalc = data1[0] - data1[1]; data1[0] = (tmpsinedcalc>32767)?32767:(((tmpsinedcalc)<-32768)?-32768:tmpsinedcalc);
-	tmpsinedcalc = data1[2] - data1[3]; data1[1] = (tmpsinedcalc>32767)?32767:(((tmpsinedcalc)<-32768)?-32768:tmpsinedcalc);
-	tmpsinedcalc = data1[4] - data1[5]; data1[2] = (tmpsinedcalc>32767)?32767:(((tmpsinedcalc)<-32768)?-32768:tmpsinedcalc);
-	tmpsinedcalc = data1[6] - data1[7]; data1[3] = (tmpsinedcalc>32767)?32767:(((tmpsinedcalc)<-32768)?-32768:tmpsinedcalc);
-	tmpsinedcalc = data2[0] - data2[1]; data1[4] = (tmpsinedcalc>32767)?32767:(((tmpsinedcalc)<-32768)?-32768:tmpsinedcalc);
-	tmpsinedcalc = data2[2] - data2[3]; data1[5] = (tmpsinedcalc>32767)?32767:(((tmpsinedcalc)<-32768)?-32768:tmpsinedcalc);
-	tmpsinedcalc = data2[4] - data2[5]; data1[6] = (tmpsinedcalc>32767)?32767:(((tmpsinedcalc)<-32768)?-32768:tmpsinedcalc);
-	tmpsinedcalc = data2[6] - data2[7]; data1[7] = (tmpsinedcalc>32767)?32767:(((tmpsinedcalc)<-32768)?-32768:tmpsinedcalc);
-	TRACEOUT(("SSSE3_PHSUBSW"));
-}
-
-void SSSE3_PHSUBSW_MM(void)
-{
-	UINT16 data2buf[4];
-	UINT16 *data1, *data2;
-	INT32 tmpsinedcalc;
-	MMX_PART_GETDATA1DATA2_PD((float**)(&data1), (float**)(&data2), (float*)data2buf);
-	tmpsinedcalc = data1[0] - data1[1]; data1[0] = (tmpsinedcalc>32767)?32767:(((tmpsinedcalc)<-32768)?-32768:tmpsinedcalc);
-	tmpsinedcalc = data1[2] - data1[3]; data1[1] = (tmpsinedcalc>32767)?32767:(((tmpsinedcalc)<-32768)?-32768:tmpsinedcalc);
-	tmpsinedcalc = data2[0] - data2[1]; data1[2] = (tmpsinedcalc>32767)?32767:(((tmpsinedcalc)<-32768)?-32768:tmpsinedcalc);
-	tmpsinedcalc = data2[2] - data2[3]; data1[3] = (tmpsinedcalc>32767)?32767:(((tmpsinedcalc)<-32768)?-32768:tmpsinedcalc);
-	TRACEOUT(("SSSE3_PHSUBSW"));
-}
-
-void SSSE3_PSIGNB(void)
-{
-	int i;
-
-	SINT8 data2buf[16];
-	SINT8 *data1, *data2;
-	SSE_PART_GETDATA1DATA2_PD((double**)(&data1), (double**)(&data2), (double*)data2buf);
-	for(i=0;i<16;i++){
-		data1[i] = (data2[i]<0)?-1:((data2[i]>0)?1:0);
-	}
-	TRACEOUT(("SSSE3_PSIGNB"));
-}
-
-void SSSE3_PSIGNB_MM(void)
-{
-	int i;
-
-	SINT8 data2buf[8];
-	SINT8 *data1, *data2;
-	MMX_PART_GETDATA1DATA2_PD((float**)(&data1), (float**)(&data2), (float*)data2buf);
-	for(i=0;i<8;i++){
-		if (data2[i] < 0){
-			data1[i] = -data1[i];
-		} else if (data2[i] == 0){
-			data1[i] = 0;
-		}
-	}
-	TRACEOUT(("SSSE3_PSIGNB"));
-}
-
-void SSSE3_PSIGNW(void)
-{
-	int i;
-
-	SINT16 data2buf[8];
-	SINT16 *data1, *data2;
-	SSE_PART_GETDATA1DATA2_PD((double**)(&data1), (double**)(&data2), (double*)data2buf);
-	for(i=0;i<8;i++){
-		data1[i] = (data2[i]<0)?-1:((data2[i]>0)?1:0);
-	}
-	TRACEOUT(("SSSE3_PSIGNW"));
-}
-
-void SSSE3_PSIGNW_MM(void)
-{
-	int i;
-
-	SINT16 data2buf[4];
-	SINT16 *data1, *data2;
-	MMX_PART_GETDATA1DATA2_PD((float**)(&data1), (float**)(&data2), (float*)data2buf);
-	for(i=0;i<4;i++){
-		if (data2[i] < 0){
-			data1[i] = -data1[i];
-		} else if (data2[i] == 0){
-			data1[i] = 0;
-		}
-	}
-	TRACEOUT(("SSSE3_PSIGNW"));
-}
-
-void SSSE3_PSIGND(void)
-{
-	int i;
-
-	SINT32 data2buf[4];
-	SINT32 *data1, *data2;
-	SSE_PART_GETDATA1DATA2_PD((double**)(&data1), (double**)(&data2), (double*)data2buf);
-	for(i=0;i<4;i++){
-		data1[i] = (data2[i]<0)?-1:((data2[i]>0)?1:0);
-	}
-	TRACEOUT(("SSSE3_PSIGND"));
-}
-
-void SSSE3_PSIGND_MM(void)
-{
-	int i;
-
-	SINT32 data2buf[2];
-	SINT32 *data1, *data2;
-	MMX_PART_GETDATA1DATA2_PD((float**)(&data1), (float**)(&data2), (float*)data2buf);
-	for(i=0;i<2;i++){
-		if (data2[i] < 0){
-			data1[i] = -data1[i];
-		} else if (data2[i] == 0){
-			data1[i] = 0;
-		}
-	}
-	TRACEOUT(("SSSE3_PSIGND"));
-}
-
-void SSSE3_PMULHRSW(void)
-{
-	int i;
-
-	SINT16 data2buf[8];
-	SINT16 *data1, *data2;
-	SINT32 tmpsinedcalc;
-	SSE_PART_GETDATA1DATA2_PD((double**)(&data1), (double**)(&data2), (double*)data2buf);
-	for(i=0;i<8;i++){
-		tmpsinedcalc = ((((INT32)(data1[i])*(INT32)(data2[i]))>>14) + 1)>>1;
-		data1[i] = tmpsinedcalc&0xffff;
-	}
-	TRACEOUT(("SSSE3_PMULHRSW"));
-}
-
-void SSSE3_PMULHRSW_MM(void)
-{
-	int i;
-
-	SINT16 data2buf[4];
-	SINT16 *data1, *data2;
-	SINT32 tmpsinedcalc;
-	MMX_PART_GETDATA1DATA2_PD((float**)(&data1), (float**)(&data2), (float*)data2buf);
-	for(i=0;i<4;i++){
-		tmpsinedcalc = ((((INT32)(data1[i])*(INT32)(data2[i]))>>14) + 1)>>1;
-		data1[i] = tmpsinedcalc&0xffff;
-	}
-	TRACEOUT(("SSSE3_PMULHRSW"));
-}
-
-void SSSE3_PABSB(void)
-{
-	int i;
-
-	SINT8 data2buf[16];
-	SINT8 *data1, *data2;
-	SSE_PART_GETDATA1DATA2_PD((double**)(&data1), (double**)(&data2), (double*)data2buf);
-	for(i=0;i<16;i++){
-		data1[i] = abs(data2[i]);
-	}
-	TRACEOUT(("SSSE3_PABSB"));
-}
-
-void SSSE3_PABSB_MM(void)
-{
-	int i;
-
-	SINT8 data2buf[8];
-	SINT8 *data1, *data2;
-	MMX_PART_GETDATA1DATA2_PD((float**)(&data1), (float**)(&data2), (float*)data2buf);
-	for(i=0;i<8;i++){
-		data1[i] = abs(data2[i]);
-	}
-	TRACEOUT(("SSSE3_PABSB"));
-}
-
-void SSSE3_PABSW(void)
-{
-	int i;
-
-	SINT16 data2buf[8];
-	SINT16 *data1, *data2;
-	SSE_PART_GETDATA1DATA2_PD((double**)(&data1), (double**)(&data2), (double*)data2buf);
-	for(i=0;i<8;i++){
-		data1[i] = abs(data2[i]);
-	}
-	TRACEOUT(("SSSE3_PABSW"));
-}
-
-void SSSE3_PABSW_MM(void)
-{
-	int i;
-
-	SINT16 data2buf[4];
-	SINT16 *data1, *data2;
-	MMX_PART_GETDATA1DATA2_PD((float**)(&data1), (float**)(&data2), (float*)data2buf);
-	for(i=0;i<4;i++){
-		data1[i] = abs(data2[i]);
-	}
-	TRACEOUT(("SSSE3_PABSW"));
-}
-
-void SSSE3_PABSD(void)
-{
-	int i;
-
-	SINT32 data2buf[4];
-	SINT32 *data1, *data2;
-	SSE_PART_GETDATA1DATA2_PD((double**)(&data1), (double**)(&data2), (double*)data2buf);
-	for(i=0;i<4;i++){
-		data1[i] = abs(data2[i]);
-	}
-	TRACEOUT(("SSSE3_PABSD"));
-}
-
-void SSSE3_PABSD_MM(void)
-{
-	int i;
-
-	SINT32 data2buf[2];
-	SINT32 *data1, *data2;
-	MMX_PART_GETDATA1DATA2_PD((float**)(&data1), (float**)(&data2), (float*)data2buf);
-	for(i=0;i<2;i++){
-		data1[i] = abs(data2[i]);
-	}
-	TRACEOUT(("SSSE3_PABSD"));
-}
-
-void SSSE3_PALIGNR(void)
-{
-	UINT32 op;
-	UINT64 data2buf[2];
-	UINT64 *data1, *data2;
-	SSE_PART_GETDATA1DATA2_PD((double**)(&data1), (double**)(&data2), (double*)data2buf);
-	GET_PCBYTE((op));
-	if (op > 15) {
-		op -= 16;
-		if (op > 15){
-			data1[0] = 0;
-			data1[1] = 0;
-		} else {
-			if (op > 7){
-				data1[0] = data1[1];
-				op -= 8;
-			}
-			op <<= 3;
-			if (op != 0){
-				data1[1] = (data1[1] << op)|(data1[0] >> (64 - op));
-				data1[0] = (data1[0] << op);
-			}
-		}
-	} else {
-		op <<= 3;
-		if (op > 64){
-			op -= 64;
-			data1[0] = (data2[1] >> op)|(data1[0] << (64 - op));
-			data1[1] = (data1[0] >> op)|(data1[1] << (64 - op));
-		} else if (op == 64){
-			data1[0] = data1[1];
-			data1[1] = data2[1];
-		} else if (op != 0){
-			op -= 64;
-			data1[0] = (data2[0] >> op)|(data2[1] << (64 - op));
-			data1[1] = (data2[1] >> op)|(data1[0] << (64 - op));
-		}
-	}
-	TRACEOUT(("SSSE3_PALIGNR"));
-}
-
-void SSSE3_PALIGNR_MM(void)
-{
-	UINT32 op;
-	UINT32 data2buf[2];
-	UINT32 *data1, *data2;
-	MMX_PART_GETDATA1DATA2_PD((float**)(&data1), (float**)(&data2), (float*)data2buf);
-	GET_PCBYTE((op));
-	if (op > 7) {
-		op -= 8;
-		if (op > 7){
-			data1[0] = 0;
-			data1[1] = 0;
-		} else {
-			if (op > 3){
-				data1[0] = data1[1];
-				op -= 4;
-			}
-			op <<= 3;
-			if (op != 0){
-				data1[1] = (data1[1] << op)|(data1[0] >> (32 - op));
-				data1[0] = (data1[0] << op);
-			}
-		}
-	} else {
-		op <<= 3;
-		if (op > 32){
-			op -= 32;
-			data1[0] = (data2[1] >> op)|(data1[0] << (32 - op));
-			data1[1] = (data1[0] >> op)|(data1[1] << (32 - op));
-		} else if (op == 32){
-			data1[0] = data1[1];
-			data1[1] = data2[1];
-		} else if (op != 0){
-			op -= 32;
-			data1[0] = (data2[0] >> op)|(data2[1] << (32 - op));
-			data1[1] = (data2[1] >> op)|(data1[0] << (32 - op));
-		}
-	}
-	TRACEOUT(("SSSE3_PALIGNR"));
-}
-
-#else
-
-void SSSE3_PSHUFB(void)
-{
-	EXCEPTION(UD_EXCEPTION, 0);
-}
-
-void SSSE3_PSHUFB_MM(void)
-{
-	EXCEPTION(UD_EXCEPTION, 0);
-}
-
-void SSSE3_PHADDW(void)
-{
-	EXCEPTION(UD_EXCEPTION, 0);
-}
-
-void SSSE3_PHADDW_MM(void)
-{
-	EXCEPTION(UD_EXCEPTION, 0);
-}
-
-void SSSE3_PHADDD(void)
-{
-	EXCEPTION(UD_EXCEPTION, 0);
-}
-
-void SSSE3_PHADDD_MM(void)
-{
-	EXCEPTION(UD_EXCEPTION, 0);
-}
-
-void SSSE3_PHADDSW(void)
-{
-	EXCEPTION(UD_EXCEPTION, 0);
-}
-
-void SSSE3_PHADDSW_MM(void)
-{
-	EXCEPTION(UD_EXCEPTION, 0);
-}
-
-void SSSE3_PMADDUBSW(void)
-{
-	EXCEPTION(UD_EXCEPTION, 0);
-}
-
-void SSSE3_PMADDUBSW_MM(void)
-{
-	EXCEPTION(UD_EXCEPTION, 0);
-}
-
-void SSSE3_PHSUBW(void)
-{
-	EXCEPTION(UD_EXCEPTION, 0);
-}
-
-void SSSE3_PHSUBW_MM(void)
-{
-	EXCEPTION(UD_EXCEPTION, 0);
-}
-
-void SSSE3_PHSUBD(void)
-{
-	EXCEPTION(UD_EXCEPTION, 0);
-}
-
-void SSSE3_PHSUBD_MM(void)
-{
-	EXCEPTION(UD_EXCEPTION, 0);
-}
-
-void SSSE3_PHSUBSW(void)
-{
-	EXCEPTION(UD_EXCEPTION, 0);
-}
-
-void SSSE3_PHSUBSW_MM(void)
-{
-	EXCEPTION(UD_EXCEPTION, 0);
-}
-
-void SSSE3_PSIGNB(void)
-{
-	EXCEPTION(UD_EXCEPTION, 0);
-}
-
-void SSSE3_PSIGNB_MM(void)
-{
-	EXCEPTION(UD_EXCEPTION, 0);
-}
-
-void SSSE3_PSIGNW(void)
-{
-	EXCEPTION(UD_EXCEPTION, 0);
-}
-
-void SSSE3_PSIGNW_MM(void)
-{
-	EXCEPTION(UD_EXCEPTION, 0);
-}
-
-void SSSE3_PSIGND(void)
-{
-	EXCEPTION(UD_EXCEPTION, 0);
-}
-
-void SSSE3_PSIGND_MM(void)
-{
-	EXCEPTION(UD_EXCEPTION, 0);
-}
-
-void SSSE3_PMULHRSW(void)
-{
-	EXCEPTION(UD_EXCEPTION, 0);
-}
-
-void SSSE3_PMULHRSW_MM(void)
-{
-	EXCEPTION(UD_EXCEPTION, 0);
-}
-
-void SSSE3_PABSB(void)
-{
-	EXCEPTION(UD_EXCEPTION, 0);
-}
-
-void SSSE3_PABSB_MM(void)
-{
-	EXCEPTION(UD_EXCEPTION, 0);
-}
-
-void SSSE3_PABSW(void)
-{
-	EXCEPTION(UD_EXCEPTION, 0);
-}
-
-void SSSE3_PABSW_MM(void)
-{
-	EXCEPTION(UD_EXCEPTION, 0);
-}
-
-void SSSE3_PABSD(void)
-{
-	EXCEPTION(UD_EXCEPTION, 0);
-}
-
-void SSSE3_PABSD_MM(void)
-{
-	EXCEPTION(UD_EXCEPTION, 0);
-}
-
-void SSSE3_PALIGNR(void)
-{
-	EXCEPTION(UD_EXCEPTION, 0);
-}
-
-void SSSE3_PALIGNR_MM(void)
-{
-	EXCEPTION(UD_EXCEPTION, 0);
-}
-
-#endif
\ No newline at end of file
diff -ruN source/src/vm/np21/i386c/ia32/instructions/ssse3/ssse3.h src/vm/np21/i386c/ia32/instructions/ssse3/ssse3.h
--- source/src/vm/np21/i386c/ia32/instructions/ssse3/ssse3.h	2025-04-28 16:00:00
+++ src/vm/np21/i386c/ia32/instructions/ssse3/ssse3.h	1970-01-01 09:00:00
@@ -1,70 +0,0 @@
-/*
- * Copyright (c) 2024 Gocaine Project
- * All rights reserved.
- *
- * Redistribution and use in source and binary forms, with or without
- * modification, are permitted provided that the following conditions
- * are met:
- * 1. Redistributions of source code must retain the above copyright
- *    notice, this list of conditions and the following disclaimer.
- * 2. Redistributions in binary form must reproduce the above copyright
- *    notice, this list of conditions and the following disclaimer in the
- *    documentation and/or other materials provided with the distribution.
- *
- * THIS SOFTWARE IS PROVIDED BY THE AUTHOR ``AS IS'' AND ANY EXPRESS OR
- * IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES
- * OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED.
- * IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY DIRECT, INDIRECT,
- * INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT
- * NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,
- * DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY
- * THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
- * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF
- * THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
- */
-
-#ifndef	IA32_CPU_INSTRUCTION_SSSE3_SSSE3_H__
-#define	IA32_CPU_INSTRUCTION_SSSE3_SSSE3_H__
-
-//#ifdef __cplusplus
-//extern "C" {
-//#endif
-
-void SSSE3_PSHUFB(void);
-void SSSE3_PSHUFB_MM(void);
-void SSSE3_PHADDW(void);
-void SSSE3_PHADDW_MM(void);
-void SSSE3_PHADDD(void);
-void SSSE3_PHADDD_MM(void);
-void SSSE3_PHADDSW(void);
-void SSSE3_PHADDSW_MM(void);
-void SSSE3_PMADDUBSW(void);
-void SSSE3_PMADDUBSW_MM(void);
-void SSSE3_PHSUBW(void);
-void SSSE3_PHSUBW_MM(void);
-void SSSE3_PHSUBD(void);
-void SSSE3_PHSUBD_MM(void);
-void SSSE3_PHSUBSW(void);
-void SSSE3_PHSUBSW_MM(void);
-void SSSE3_PSIGNB(void);
-void SSSE3_PSIGNB_MM(void);
-void SSSE3_PSIGNW(void);
-void SSSE3_PSIGNW_MM(void);
-void SSSE3_PSIGND(void);
-void SSSE3_PSIGND_MM(void);
-void SSSE3_PMULHRSW(void);
-void SSSE3_PMULHRSW_MM(void);
-void SSSE3_PABSB(void);
-void SSSE3_PABSB_MM(void);
-void SSSE3_PABSW(void);
-void SSSE3_PABSW_MM(void);
-void SSSE3_PABSD(void);
-void SSSE3_PABSD_MM(void);
-void SSSE3_PALIGNR(void);
-void SSSE3_PALIGNR_MM(void);
-
-//#ifdef __cplusplus
-//}
-//#endif
-
-#endif	/* IA32_CPU_INSTRUCTION_SSSE3_SSSE3_H__ */
diff -ruN source/src/vm/np21/i386c/ia32/instructions/string_inst.cpp src/vm/np21/i386c/ia32/instructions/string_inst.cpp
--- source/src/vm/np21/i386c/ia32/instructions/string_inst.cpp	2025-04-28 16:00:00
+++ src/vm/np21/i386c/ia32/instructions/string_inst.cpp	2025-04-28 22:36:36
@@ -162,7 +162,7 @@
 				MOVSB_XbYb_rep16_part;
 				if (--CPU_CX == 0) {
 	#if defined(DEBUG)
-					cpu_debug_rep_cont = 0;
+				cpu_debug_rep_cont = 0;
 	#endif
 					break;
 				}
@@ -210,7 +210,7 @@
 				MOVSB_XbYb_rep32_part;
 				if (--CPU_ECX == 0) {
 	#if defined(DEBUG)
-					cpu_debug_rep_cont = 0;
+				cpu_debug_rep_cont = 0;
 	#endif
 					break;
 				}
@@ -267,7 +267,7 @@
 				MOVSW_XwYw_rep16_part;
 				if (--CPU_CX == 0) {
 	#if defined(DEBUG)
-					cpu_debug_rep_cont = 0;
+				cpu_debug_rep_cont = 0;
 	#endif
 					break;
 				}
@@ -315,7 +315,7 @@
 				MOVSW_XwYw_rep32_part;
 				if (--CPU_ECX == 0) {
 	#if defined(DEBUG)
-					cpu_debug_rep_cont = 0;
+				cpu_debug_rep_cont = 0;
 	#endif
 					break;
 				}
@@ -372,7 +372,7 @@
 				MOVSD_XdYd_rep16_part;
 				if (--CPU_CX == 0) {
 	#if defined(DEBUG)
-					cpu_debug_rep_cont = 0;
+				cpu_debug_rep_cont = 0;
 	#endif
 					break;
 				}
@@ -420,7 +420,7 @@
 				MOVSD_XdYd_rep32_part;
 				if (--CPU_ECX == 0) {
 	#if defined(DEBUG)
-					cpu_debug_rep_cont = 0;
+				cpu_debug_rep_cont = 0;
 	#endif
 					break;
 				}
@@ -604,7 +604,7 @@
 				CMPSB_XbYb_rep16_part;
 				if (--CPU_CX == 0) {
 	#if defined(DEBUG)
-					cpu_debug_rep_cont = 0;
+				cpu_debug_rep_cont = 0;
 	#endif
 					break;
 				}
@@ -652,7 +652,7 @@
 				CMPSB_XbYb_rep32_part;
 				if (--CPU_ECX == 0) {
 	#if defined(DEBUG)
-					cpu_debug_rep_cont = 0;
+				cpu_debug_rep_cont = 0;
 	#endif
 					break;
 				}
@@ -709,7 +709,7 @@
 				CMPSW_XwYw_rep16_part;
 				if (--CPU_CX == 0) {
 	#if defined(DEBUG)
-					cpu_debug_rep_cont = 0;
+				cpu_debug_rep_cont = 0;
 	#endif
 					break;
 				}
@@ -757,7 +757,7 @@
 				CMPSW_XwYw_rep32_part;
 				if (--CPU_ECX == 0) {
 	#if defined(DEBUG)
-					cpu_debug_rep_cont = 0;
+				cpu_debug_rep_cont = 0;
 	#endif
 					break;
 				}
@@ -814,7 +814,7 @@
 				CMPSD_XdYd_rep16_part;
 				if (--CPU_CX == 0) {
 	#if defined(DEBUG)
-					cpu_debug_rep_cont = 0;
+				cpu_debug_rep_cont = 0;
 	#endif
 					break;
 				}
@@ -862,7 +862,7 @@
 				CMPSD_XdYd_rep32_part;
 				if (--CPU_ECX == 0) {
 	#if defined(DEBUG)
-					cpu_debug_rep_cont = 0;
+				cpu_debug_rep_cont = 0;
 	#endif
 					break;
 				}
@@ -1064,7 +1064,7 @@
 			CPU_DI += STRING_DIR;
 			if (--CPU_CX == 0) {
 #if defined(DEBUG)
-				cpu_debug_rep_cont = 0;
+			cpu_debug_rep_cont = 0;
 #endif
 				break;
 			}
@@ -1080,7 +1080,7 @@
 			CPU_EDI += STRING_DIR;
 			if (--CPU_ECX == 0) {
 #if defined(DEBUG)
-				cpu_debug_rep_cont = 0;
+			cpu_debug_rep_cont = 0;
 #endif
 				break;
 			}
@@ -1103,7 +1103,7 @@
 			CPU_DI += STRING_DIRx2;
 			if (--CPU_CX == 0) {
 #if defined(DEBUG)
-				cpu_debug_rep_cont = 0;
+			cpu_debug_rep_cont = 0;
 #endif
 				break;
 			}
@@ -1119,7 +1119,7 @@
 			CPU_EDI += STRING_DIRx2;
 			if (--CPU_ECX == 0) {
 #if defined(DEBUG)
-				cpu_debug_rep_cont = 0;
+			cpu_debug_rep_cont = 0;
 #endif
 				break;
 			}
@@ -1142,7 +1142,7 @@
 			CPU_DI += STRING_DIRx4;
 			if (--CPU_CX == 0) {
 #if defined(DEBUG)
-				cpu_debug_rep_cont = 0;
+			cpu_debug_rep_cont = 0;
 #endif
 				break;
 			}
@@ -1158,7 +1158,7 @@
 			CPU_EDI += STRING_DIRx4;
 			if (--CPU_ECX == 0) {
 #if defined(DEBUG)
-				cpu_debug_rep_cont = 0;
+			cpu_debug_rep_cont = 0;
 #endif
 				break;
 			}
diff -ruN source/src/vm/np21/i386c/ia32/instructions/system_inst.cpp src/vm/np21/i386c/ia32/instructions/system_inst.cpp
--- source/src/vm/np21/i386c/ia32/instructions/system_inst.cpp	2025-04-28 16:00:00
+++ src/vm/np21/i386c/ia32/instructions/system_inst.cpp	2025-04-28 22:36:36
@@ -355,19 +355,21 @@
 			 * 1 = PVI (protected mode virtual interrupt)
 			 * 0 = VME (VM8086 mode extention)
 			 */
-			reg = CPU_CR4_PCE;		/* allow bit */
-			if (i386cpuid.cpu_feature & CPU_FEATURE_PGE) {
-				reg |= CPU_CR4_PGE;
-			}
-			if (i386cpuid.cpu_feature & CPU_FEATURE_VME) {
-				reg |= CPU_CR4_PVI | CPU_CR4_VME;
-			}
-			if (i386cpuid.cpu_feature & CPU_FEATURE_FXSR) {
-				reg |= CPU_CR4_OSFXSR;
-			}
-			if (i386cpuid.cpu_feature & CPU_FEATURE_SSE) {
-				reg |= CPU_CR4_OSXMMEXCPT;
-			}
+			reg = 0		/* allow bit */
+#if (CPU_FEATURES & CPU_FEATURE_PGE) == CPU_FEATURE_PGE
+			    | CPU_CR4_PGE
+#endif
+#if (CPU_FEATURES & CPU_FEATURE_VME) == CPU_FEATURE_VME
+			    | CPU_CR4_PVI | CPU_CR4_VME
+#endif
+#if (CPU_FEATURES & CPU_FEATURE_FXSR) == CPU_FEATURE_FXSR
+			    | CPU_CR4_OSFXSR
+#endif
+#if (CPU_FEATURES & CPU_FEATURE_SSE) == CPU_FEATURE_SSE
+			    | CPU_CR4_OSXMMEXCPT
+#endif
+			    | CPU_CR4_PCE
+			;
 			if (src & ~reg) {
 				//if (src & 0xfffffc00) {
 				if (src & 0xfffff800) {
diff -ruN source/src/vm/np21/i386c/ia32/paging.cpp src/vm/np21/i386c/ia32/paging.cpp
--- source/src/vm/np21/i386c/ia32/paging.cpp	2025-04-28 16:00:00
+++ src/vm/np21/i386c/ia32/paging.cpp	2025-04-28 22:36:36
@@ -799,7 +799,7 @@
 #define	TLB_IS_WRITABLE(ep)	((ep)->tag & CPU_PTE_WRITABLE)
 #define	TLB_IS_USERMODE(ep)	((ep)->tag & CPU_PTE_USER_MODE)
 #define	TLB_IS_DIRTY(ep)	((ep)->tag & TLB_ENTRY_TAG_DIRTY)
-#if (CPU_FEATURES_ALL & CPU_FEATURE_PGE) == CPU_FEATURE_PGE
+#if (CPU_FEATURES & CPU_FEATURE_PGE) == CPU_FEATURE_PGE
 #define	TLB_IS_GLOBAL(ep)	((ep)->tag & TLB_ENTRY_TAG_GLOBAL)
 #else
 #define	TLB_IS_GLOBAL(ep)	0
diff -ruN source/src/vm/pc8801/diskio.cpp src/vm/pc8801/diskio.cpp
--- source/src/vm/pc8801/diskio.cpp	2020-12-16 00:00:00
+++ src/vm/pc8801/diskio.cpp	2025-04-28 22:36:36
@@ -20,6 +20,7 @@
 //	$Id: diskio.cpp,v 1.2 1999/09/25 03:13:51 cisc Exp $
 
 #include "diskio.h"
+#include "../../common.h"
 
 // ---------------------------------------------------------------------------
 //	Init
@@ -33,7 +34,7 @@
 }
 
 // ---------------------------------------------------------------------------
-//	ÉRÉ}ÉìÉh
+//	ÔøΩRÔøΩ}ÔøΩÔøΩÔøΩh
 //
 void DiskIO::SetCommand(uint32_t a, uint32_t d)
 {
@@ -47,7 +48,7 @@
 }
 
 // ---------------------------------------------------------------------------
-//	ÉXÉeÅ[É^ÉX
+//	ÔøΩXÔøΩeÔøΩ[ÔøΩ^ÔøΩX
 //
 uint32_t DiskIO::GetStatus(uint32_t a)
 {
@@ -55,7 +56,7 @@
 }
 
 // ---------------------------------------------------------------------------
-//	ÉfÅ[É^ÉZÉbÉg
+//	ÔøΩfÔøΩ[ÔøΩ^ÔøΩZÔøΩbÔøΩg
 //
 void DiskIO::SetData(uint32_t a, uint32_t d)
 {
@@ -71,7 +72,7 @@
 }
 
 // ---------------------------------------------------------------------------
-//	ÉfÅ[É^Ç∞Ç¡Ç∆
+//	ÔøΩfÔøΩ[ÔøΩ^ÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩ
 //
 uint32_t DiskIO::GetData(uint32_t a)
 {
@@ -179,7 +180,7 @@
 		if (file->Fopen(create_absolute_path(char_to_tchar((char*) filename)), FILEIO_READ_BINARY))
 		{
 			file->Fseek(0, FILEIO_SEEK_END);
-			size = min(0xffff, file->Ftell());
+			size = (int)min(0xffff, (int)file->Ftell());
 			file->Fseek(0, FILEIO_SEEK_SET);
 			buf[0] = size & 0xff;
 			buf[1] = (size >> 8) & 0xff;
@@ -197,7 +198,7 @@
 	case sendphase:
 		if (size > 0)
 		{
-			int b = min(1024, size);
+			int b = (int)min(1024, size);
 			size -= b;
 			if (file->Fread(buf, b, 1))
 			{
@@ -237,7 +238,7 @@
 		if (size > 0)
 		{
 //			LOG0("%d bytes ");
-			length = min(1024, size);
+			length = (int)min(1024, size);
 			size -= length;
 			RecvPhase(buf, length);
 		}
@@ -256,7 +257,7 @@
 		}
 		if (size > 0)
 		{
-			length = min(1024, size);
+			length = (int)min(1024, size);
 			size -= length;
 			RecvPhase(buf, length);
 		}
diff -ruN source/src/vm/pc8801/diskio.h src/vm/pc8801/diskio.h
--- source/src/vm/pc8801/diskio.h	2020-12-18 00:00:00
+++ src/vm/pc8801/diskio.h	2025-04-28 22:36:36
@@ -83,6 +83,6 @@
 	uint8_t cmd;
 	uint8_t err;
 	uint8_t arg[5];
-	uint8_t filename[MAX_PATH];
+	uint8_t filename[_MAX_PATH]; // MAX_PATH„Çí_MAX_PATH„Å´‰øÆÊ≠£
 	uint8_t buf[1024];
 };
diff -ruN source/src/vm/pc8801/pc88.cpp src/vm/pc8801/pc88.cpp
--- source/src/vm/pc8801/pc88.cpp	2023-06-11 22:00:00
+++ src/vm/pc8801/pc88.cpp	2025-04-28 22:36:36
@@ -259,12 +259,13 @@
 	{0x79, 0x74, 1}, // F10	-> SHIFT + F5
 //	{0x08, 0x2e, 0}, // BS	-> DEL
 	{0x2e, 0x08, 0}, // DEL	-> BS
-	{0x1c, 0x20, 0}, // ïœä∑-> SPACE
-	{0x1d, 0x20, 0}, // åàíË-> SPACE
+	{0x1c, 0x20, 0}, // Â§âÊèõ-> SPACE
+	{0x1d, 0x20, 0}, // ÁÑ°Â§â-> SPACE
 };
 
 static const uint8_t intr_mask2_table[8] = {
-	~7, ~3, ~5, ~1, ~6, ~2, ~4, ~0
+	static_cast<uint8_t>(~7), static_cast<uint8_t>(~3), static_cast<uint8_t>(~5), static_cast<uint8_t>(~1), 
+	static_cast<uint8_t>(~6), static_cast<uint8_t>(~2), static_cast<uint8_t>(~4), static_cast<uint8_t>(~0)
 };
 
 void PC88::initialize()
@@ -1779,7 +1780,7 @@
 			val |= d_scsi_host->read_signal(SIG_SCSI_MSG) ? 0x20 : 0;
 			val |= d_scsi_host->read_signal(SIG_SCSI_CD ) ? 0x10 : 0;
 			val |= d_scsi_host->read_signal(SIG_SCSI_IO ) ? 0x08 : 0;
-			// do not show BSY,MSG,CxD,IxD when SEL=1 (êMí∑ÇÃñÏñ] ïêè´ïóâ_ò^)
+			// do not show BSY,MSG,CxD,IxD when SEL=1 (ÔøΩMÔøΩÔøΩÔøΩÃñÔøΩ] ÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩ_ÔøΩ^)
 			if(port[0x90] & 0x01) {
 				val &= ~(0x80 | 0x20 | 0x10 | 0x08);
 				val |= (port[0x9f] & 0x01); // correct ???
@@ -3094,7 +3095,7 @@
 					for(int i = 2 * (crtc.attrib.num - 1); i >= 0; i -= 2) {
 						flags[buffer[ofs + i + 80] & 0x7f] = 1;
 					}
-					crtc.attrib.data &= 0xf3; // for PC-8801mkIIFR ïtëÆÉfÉÇ
+					crtc.attrib.data &= 0xf3; // for PC-8801mkIIFR ÔøΩtÔøΩÔøΩÔøΩfÔøΩÔøΩ
 					
 					for(int cx = 0, pos = 0; cx < crtc.width; cx++) {
 						if(flags[cx]) {
@@ -3196,7 +3197,7 @@
 			uint8_t color_tmp = color;
 			bool reverse_tmp = reverse;
 			
-			// from ePC-8801MAâ¸
+			// from ePC-8801MAÔøΩÔøΩ
 //			if(Port31_GRAPH && !Port31_HCOLOR) {
 			if(attrib_graph) {
 				if(reverse) {
@@ -3217,7 +3218,7 @@
 				uint8_t pat = (l < 8) ? pattern[l] : 0;
 				
 				if(Port30_40) {
-					// from ePC-8801MAâ¸
+					// from ePC-8801MAÔøΩÔøΩ
 					static const uint8_t wct[16] = {
 						0x00, 0x03, 0x0c, 0x0f, 0x30, 0x33, 0x3c, 0x3f, 0xc0, 0xc3, 0xcc, 0xcf, 0xf0, 0xf3, 0xfc, 0xff
 					};
@@ -3939,7 +3940,7 @@
 				for(int i = 2 * (attrib.num - 1); i >= 0; i -= 2) {
 					flags[read_buffer(ofs + i + 80) & 0x7f] = 1;
 				}
-				attrib.data &= 0xf3; // for PC-8801mkIIFR ïtëÆÉfÉÇ
+				attrib.data &= 0xf3; // for PC-8801mkIIFR ÔøΩtÔøΩÔøΩÔøΩfÔøΩÔøΩ
 				
 				for(int cx = 0, pos = 0; cx < width; cx++) {
 					if(flags[cx]) {
@@ -3972,7 +3973,7 @@
 			// SORCERIAN Music Library ver-2.1
 			memset(&attrib.expand[cy][0], 0xe0, width); // color=7
 #else
-			// from ePC-8801MAâ¸
+			// from ePC-8801MAÔøΩÔøΩ
 			memset(&attrib.expand[cy][0], 0x00, width);
 #endif
 		}
diff -ruN source/src/vm/t250/membus.cpp src/vm/t250/membus.cpp
--- source/src/vm/t250/membus.cpp	2025-04-28 16:00:00
+++ src/vm/t250/membus.cpp	2025-04-28 22:36:36
@@ -26,10 +26,20 @@
 		fio->Fread(rom, sizeof(rom), 1);
 		fio->Fclose();
 	}
+#ifdef _T200
+	if(fio->Fopen(create_local_path(_T("T200BOOT.BIN")), FILEIO_READ_BINARY)) {
+		fio->Fread(rom, sizeof(rom), 1);
+		fio->Fclose();
+	}
+#else
+	if(fio->Fopen(create_local_path(_T("T250BOOT.BIN")), FILEIO_READ_BINARY)) {
+		fio->Fread(rom, sizeof(rom), 1);
+		fio->Fclose();
+	}
+#endif
 	delete fio;
 	
 	set_memory_rw(0x0000, 0xffff, ram);
-	set_wait_rw(0xf800, 0xffff, 2);
 	
 	mode_reg = data_reg = cmd_reg = fdd_reg = 0;
 	key_repeat = key_ctrl = key_shift = key_irq = false;
diff -ruN source/src/vm/v30_dasm.cpp src/vm/v30_dasm.cpp
--- source/src/vm/v30_dasm.cpp	1970-01-01 09:00:00
+++ src/vm/v30_dasm.cpp	2025-04-28 22:36:36
@@ -0,0 +1,327 @@
+/*
+	Skelton for retropc emulator
+
+	Origin : MAME V30 core
+	Author : Takeda.Toshiya
+	Date   : 2020.02.02-
+
+	[ V30 disassembler ]
+*/
+
+#include "i386_dasm.h"
+#include "debugger.h"
+
+#if defined(_MSC_VER) && (_MSC_VER >= 1400)
+#pragma warning( disable : 4146 )
+#endif
+
+/*****************************************************************************/
+/* src/emu/devcpu.h */
+
+// CPU interface functions
+#define CPU_DISASSEMBLE_NAME(name)		cpu_disassemble_##name
+#define CPU_DISASSEMBLE(name)			int CPU_DISASSEMBLE_NAME(name)(_TCHAR *buffer, offs_t eip, const UINT8 *oprom)
+#define CPU_DISASSEMBLE_CALL(name)		CPU_DISASSEMBLE_NAME(name)(buffer, eip, oprom)
+
+/*****************************************************************************/
+/* src/emu/didisasm.h */
+
+// Disassembler constants
+const UINT32 DASMFLAG_SUPPORTED     = 0x80000000;   // are disassembly flags supported?
+const UINT32 DASMFLAG_STEP_OUT      = 0x40000000;   // this instruction should be the end of a step out sequence
+const UINT32 DASMFLAG_STEP_OVER     = 0x20000000;   // this instruction should be stepped over by setting a breakpoint afterwards
+const UINT32 DASMFLAG_OVERINSTMASK  = 0x18000000;   // number of extra instructions to skip when stepping over
+const UINT32 DASMFLAG_OVERINSTSHIFT = 27;           // bits to shift after masking to get the value
+const UINT32 DASMFLAG_LENGTHMASK    = 0x0000ffff;   // the low 16-bits contain the actual length
+
+// offsets and addresses are 32-bit (for now...)
+typedef UINT32	offs_t;
+
+/*****************************************************************************/
+/* src/osd/osdcomm.h */
+
+/* Highly useful macro for compile-time knowledge of an array size */
+#define ARRAY_LENGTH(x)     (sizeof(x) / sizeof(x[0]))
+
+#ifndef INLINE
+#define INLINE inline
+#endif
+
+#include "mame/emu/cpu/nec/necdasm.c"
+
+int v30_dasm(DEBUGGER *debugger, uint8_t *oprom, uint32_t eip, bool emulation_mode, _TCHAR *buffer, size_t buffer_len)
+{
+	if(!emulation_mode) {
+		return CPU_DISASSEMBLE_CALL(nec_generic) & DASMFLAG_LENGTHMASK;
+	}
+	int ptr = 0;
+	
+	switch(oprom[ptr++]) {
+		case 0x00: my_stprintf_s(buffer, buffer_len, _T("nop")); break;
+		case 0x01: my_stprintf_s(buffer, buffer_len, _T("lxi  b,%s"), get_value_or_symbol(debugger->first_symbol, _T("$%04x"), oprom[ptr] | (oprom[ptr + 1] << 8))); ptr += 2; break;
+		case 0x02: my_stprintf_s(buffer, buffer_len, _T("stax b")); break;
+		case 0x03: my_stprintf_s(buffer, buffer_len, _T("inx  b")); break;
+		case 0x04: my_stprintf_s(buffer, buffer_len, _T("inr  b")); break;
+		case 0x05: my_stprintf_s(buffer, buffer_len, _T("dcr  b")); break;
+		case 0x06: my_stprintf_s(buffer, buffer_len, _T("mvi  b,$%02x"), oprom[ptr++]); break;
+		case 0x07: my_stprintf_s(buffer, buffer_len, _T("rlc")); break;
+		case 0x08: my_stprintf_s(buffer, buffer_len, _T("nop")); break;
+		case 0x09: my_stprintf_s(buffer, buffer_len, _T("dad  b")); break;
+		case 0x0a: my_stprintf_s(buffer, buffer_len, _T("ldax b")); break;
+		case 0x0b: my_stprintf_s(buffer, buffer_len, _T("dcx  b")); break;
+		case 0x0c: my_stprintf_s(buffer, buffer_len, _T("inr  c")); break;
+		case 0x0d: my_stprintf_s(buffer, buffer_len, _T("dcr  c")); break;
+		case 0x0e: my_stprintf_s(buffer, buffer_len, _T("mvi  c,$%02x"), oprom[ptr++]); break;
+		case 0x0f: my_stprintf_s(buffer, buffer_len, _T("rrc")); break;
+		case 0x10: my_stprintf_s(buffer, buffer_len, _T("nop")); break;
+		case 0x11: my_stprintf_s(buffer, buffer_len, _T("lxi  d,%s"), get_value_or_symbol(debugger->first_symbol, _T("$%04x"), oprom[ptr] | (oprom[ptr + 1] << 8))); ptr += 2; break;
+		case 0x12: my_stprintf_s(buffer, buffer_len, _T("stax d")); break;
+		case 0x13: my_stprintf_s(buffer, buffer_len, _T("inx  d")); break;
+		case 0x14: my_stprintf_s(buffer, buffer_len, _T("inr  d")); break;
+		case 0x15: my_stprintf_s(buffer, buffer_len, _T("dcr  d")); break;
+		case 0x16: my_stprintf_s(buffer, buffer_len, _T("mvi  d,$%02x"), oprom[ptr++]); break;
+		case 0x17: my_stprintf_s(buffer, buffer_len, _T("ral")); break;
+		case 0x18: my_stprintf_s(buffer, buffer_len, _T("nop")); break;
+		case 0x19: my_stprintf_s(buffer, buffer_len, _T("dad  d")); break;
+		case 0x1a: my_stprintf_s(buffer, buffer_len, _T("ldax d")); break;
+		case 0x1b: my_stprintf_s(buffer, buffer_len, _T("dcx  d")); break;
+		case 0x1c: my_stprintf_s(buffer, buffer_len, _T("inr  e")); break;
+		case 0x1d: my_stprintf_s(buffer, buffer_len, _T("dcr  e")); break;
+		case 0x1e: my_stprintf_s(buffer, buffer_len, _T("mvi  e,$%02x"), oprom[ptr++]); break;
+		case 0x1f: my_stprintf_s(buffer, buffer_len, _T("rar")); break;
+		case 0x20: my_stprintf_s(buffer, buffer_len, _T("rim")); break;
+		case 0x21: my_stprintf_s(buffer, buffer_len, _T("lxi  h,%s"), get_value_or_symbol(debugger->first_symbol, _T("$%04x"), oprom[ptr] | (oprom[ptr + 1] << 8))); ptr += 2; break;
+		case 0x22: my_stprintf_s(buffer, buffer_len, _T("shld %s"), get_value_or_symbol(debugger->first_symbol, _T("$%04x"), oprom[ptr] | (oprom[ptr + 1] << 8))); ptr += 2; break;
+		case 0x23: my_stprintf_s(buffer, buffer_len, _T("inx  h")); break;
+		case 0x24: my_stprintf_s(buffer, buffer_len, _T("inr  h")); break;
+		case 0x25: my_stprintf_s(buffer, buffer_len, _T("dcr  h")); break;
+		case 0x26: my_stprintf_s(buffer, buffer_len, _T("mvi  h,$%02x"), oprom[ptr++]); break;
+		case 0x27: my_stprintf_s(buffer, buffer_len, _T("daa")); break;
+		case 0x28: my_stprintf_s(buffer, buffer_len, _T("nop")); break;
+		case 0x29: my_stprintf_s(buffer, buffer_len, _T("dad  h")); break;
+		case 0x2a: my_stprintf_s(buffer, buffer_len, _T("lhld %s"), get_value_or_symbol(debugger->first_symbol, _T("$%04x"), oprom[ptr] | (oprom[ptr + 1] << 8))); ptr += 2; break;
+		case 0x2b: my_stprintf_s(buffer, buffer_len, _T("dcx  h")); break;
+		case 0x2c: my_stprintf_s(buffer, buffer_len, _T("inr  l")); break;
+		case 0x2d: my_stprintf_s(buffer, buffer_len, _T("dcr  l")); break;
+		case 0x2e: my_stprintf_s(buffer, buffer_len, _T("mvi  l,$%02x"), oprom[ptr++]); break;
+		case 0x2f: my_stprintf_s(buffer, buffer_len, _T("cma")); break;
+		case 0x30: my_stprintf_s(buffer, buffer_len, _T("sim")); break;
+		case 0x31: my_stprintf_s(buffer, buffer_len, _T("lxi  sp,%s"), get_value_or_symbol(debugger->first_symbol, _T("$%04x"), oprom[ptr] | (oprom[ptr + 1] << 8))); ptr += 2; break;
+		case 0x32: my_stprintf_s(buffer, buffer_len, _T("stax %s"), get_value_or_symbol(debugger->first_symbol, _T("$%04x"), oprom[ptr] | (oprom[ptr + 1] << 8))); ptr += 2; break;
+		case 0x33: my_stprintf_s(buffer, buffer_len, _T("inx  sp")); break;
+		case 0x34: my_stprintf_s(buffer, buffer_len, _T("inr  m")); break;
+		case 0x35: my_stprintf_s(buffer, buffer_len, _T("dcr  m")); break;
+		case 0x36: my_stprintf_s(buffer, buffer_len, _T("mvi  m,$%02x"), oprom[ptr++]); break;
+		case 0x37: my_stprintf_s(buffer, buffer_len, _T("stc")); break;
+		case 0x38: my_stprintf_s(buffer, buffer_len, _T("ldes $%02x"), oprom[ptr++]); break;
+		case 0x39: my_stprintf_s(buffer, buffer_len, _T("dad sp")); break;
+		case 0x3a: my_stprintf_s(buffer, buffer_len, _T("ldax %s"), get_value_or_symbol(debugger->first_symbol, _T("$%04x"), oprom[ptr] | (oprom[ptr + 1] << 8))); ptr += 2; break;
+		case 0x3b: my_stprintf_s(buffer, buffer_len, _T("dcx  sp")); break;
+		case 0x3c: my_stprintf_s(buffer, buffer_len, _T("inr  a")); break;
+		case 0x3d: my_stprintf_s(buffer, buffer_len, _T("dcr  a")); break;
+		case 0x3e: my_stprintf_s(buffer, buffer_len, _T("mvi  a,$%02x"), oprom[ptr++]); break;
+		case 0x3f: my_stprintf_s(buffer, buffer_len, _T("cmf")); break;
+		case 0x40: my_stprintf_s(buffer, buffer_len, _T("mov  b,b")); break;
+		case 0x41: my_stprintf_s(buffer, buffer_len, _T("mov  b,c")); break;
+		case 0x42: my_stprintf_s(buffer, buffer_len, _T("mov  b,d")); break;
+		case 0x43: my_stprintf_s(buffer, buffer_len, _T("mov  b,e")); break;
+		case 0x44: my_stprintf_s(buffer, buffer_len, _T("mov  b,h")); break;
+		case 0x45: my_stprintf_s(buffer, buffer_len, _T("mov  b,l")); break;
+		case 0x46: my_stprintf_s(buffer, buffer_len, _T("mov  b,m")); break;
+		case 0x47: my_stprintf_s(buffer, buffer_len, _T("mov  b,a")); break;
+		case 0x48: my_stprintf_s(buffer, buffer_len, _T("mov  c,b")); break;
+		case 0x49: my_stprintf_s(buffer, buffer_len, _T("mov  c,c")); break;
+		case 0x4a: my_stprintf_s(buffer, buffer_len, _T("mov  c,d")); break;
+		case 0x4b: my_stprintf_s(buffer, buffer_len, _T("mov  c,e")); break;
+		case 0x4c: my_stprintf_s(buffer, buffer_len, _T("mov  c,h")); break;
+		case 0x4d: my_stprintf_s(buffer, buffer_len, _T("mov  c,l")); break;
+		case 0x4e: my_stprintf_s(buffer, buffer_len, _T("mov  c,m")); break;
+		case 0x4f: my_stprintf_s(buffer, buffer_len, _T("mov  c,a")); break;
+		case 0x50: my_stprintf_s(buffer, buffer_len, _T("mov  d,b")); break;
+		case 0x51: my_stprintf_s(buffer, buffer_len, _T("mov  d,c")); break;
+		case 0x52: my_stprintf_s(buffer, buffer_len, _T("mov  d,d")); break;
+		case 0x53: my_stprintf_s(buffer, buffer_len, _T("mov  d,e")); break;
+		case 0x54: my_stprintf_s(buffer, buffer_len, _T("mov  d,h")); break;
+		case 0x55: my_stprintf_s(buffer, buffer_len, _T("mov  d,l")); break;
+		case 0x56: my_stprintf_s(buffer, buffer_len, _T("mov  d,m")); break;
+		case 0x57: my_stprintf_s(buffer, buffer_len, _T("mov  d,a")); break;
+		case 0x58: my_stprintf_s(buffer, buffer_len, _T("mov  e,b")); break;
+		case 0x59: my_stprintf_s(buffer, buffer_len, _T("mov  e,c")); break;
+		case 0x5a: my_stprintf_s(buffer, buffer_len, _T("mov  e,d")); break;
+		case 0x5b: my_stprintf_s(buffer, buffer_len, _T("mov  e,e")); break;
+		case 0x5c: my_stprintf_s(buffer, buffer_len, _T("mov  e,h")); break;
+		case 0x5d: my_stprintf_s(buffer, buffer_len, _T("mov  e,l")); break;
+		case 0x5e: my_stprintf_s(buffer, buffer_len, _T("mov  e,m")); break;
+		case 0x5f: my_stprintf_s(buffer, buffer_len, _T("mov  e,a")); break;
+		case 0x60: my_stprintf_s(buffer, buffer_len, _T("mov  h,b")); break;
+		case 0x61: my_stprintf_s(buffer, buffer_len, _T("mov  h,c")); break;
+		case 0x62: my_stprintf_s(buffer, buffer_len, _T("mov  h,d")); break;
+		case 0x63: my_stprintf_s(buffer, buffer_len, _T("mov  h,e")); break;
+		case 0x64: my_stprintf_s(buffer, buffer_len, _T("mov  h,h")); break;
+		case 0x65: my_stprintf_s(buffer, buffer_len, _T("mov  h,l")); break;
+		case 0x66: my_stprintf_s(buffer, buffer_len, _T("mov  h,m")); break;
+		case 0x67: my_stprintf_s(buffer, buffer_len, _T("mov  h,a")); break;
+		case 0x68: my_stprintf_s(buffer, buffer_len, _T("mov  l,b")); break;
+		case 0x69: my_stprintf_s(buffer, buffer_len, _T("mov  l,c")); break;
+		case 0x6a: my_stprintf_s(buffer, buffer_len, _T("mov  l,d")); break;
+		case 0x6b: my_stprintf_s(buffer, buffer_len, _T("mov  l,e")); break;
+		case 0x6c: my_stprintf_s(buffer, buffer_len, _T("mov  l,h")); break;
+		case 0x6d: my_stprintf_s(buffer, buffer_len, _T("mov  l,l")); break;
+		case 0x6e: my_stprintf_s(buffer, buffer_len, _T("mov  l,m")); break;
+		case 0x6f: my_stprintf_s(buffer, buffer_len, _T("mov  l,a")); break;
+		case 0x70: my_stprintf_s(buffer, buffer_len, _T("mov  m,b")); break;
+		case 0x71: my_stprintf_s(buffer, buffer_len, _T("mov  m,c")); break;
+		case 0x72: my_stprintf_s(buffer, buffer_len, _T("mov  m,d")); break;
+		case 0x73: my_stprintf_s(buffer, buffer_len, _T("mov  m,e")); break;
+		case 0x74: my_stprintf_s(buffer, buffer_len, _T("mov  m,h")); break;
+		case 0x75: my_stprintf_s(buffer, buffer_len, _T("mov  m,l")); break;
+		case 0x76: my_stprintf_s(buffer, buffer_len, _T("hlt")); break;
+		case 0x77: my_stprintf_s(buffer, buffer_len, _T("mov  m,a")); break;
+		case 0x78: my_stprintf_s(buffer, buffer_len, _T("mov  a,b")); break;
+		case 0x79: my_stprintf_s(buffer, buffer_len, _T("mov  a,c")); break;
+		case 0x7a: my_stprintf_s(buffer, buffer_len, _T("mov  a,d")); break;
+		case 0x7b: my_stprintf_s(buffer, buffer_len, _T("mov  a,e")); break;
+		case 0x7c: my_stprintf_s(buffer, buffer_len, _T("mov  a,h")); break;
+		case 0x7d: my_stprintf_s(buffer, buffer_len, _T("mov  a,l")); break;
+		case 0x7e: my_stprintf_s(buffer, buffer_len, _T("mov  a,m")); break;
+		case 0x7f: my_stprintf_s(buffer, buffer_len, _T("mov  a,a")); break;
+		case 0x80: my_stprintf_s(buffer, buffer_len, _T("add  b")); break;
+		case 0x81: my_stprintf_s(buffer, buffer_len, _T("add  c")); break;
+		case 0x82: my_stprintf_s(buffer, buffer_len, _T("add  d")); break;
+		case 0x83: my_stprintf_s(buffer, buffer_len, _T("add  e")); break;
+		case 0x84: my_stprintf_s(buffer, buffer_len, _T("add  h")); break;
+		case 0x85: my_stprintf_s(buffer, buffer_len, _T("add  l")); break;
+		case 0x86: my_stprintf_s(buffer, buffer_len, _T("add  m")); break;
+		case 0x87: my_stprintf_s(buffer, buffer_len, _T("add  a")); break;
+		case 0x88: my_stprintf_s(buffer, buffer_len, _T("adc  b")); break;
+		case 0x89: my_stprintf_s(buffer, buffer_len, _T("adc  c")); break;
+		case 0x8a: my_stprintf_s(buffer, buffer_len, _T("adc  d")); break;
+		case 0x8b: my_stprintf_s(buffer, buffer_len, _T("adc  e")); break;
+		case 0x8c: my_stprintf_s(buffer, buffer_len, _T("adc  h")); break;
+		case 0x8d: my_stprintf_s(buffer, buffer_len, _T("adc  l")); break;
+		case 0x8e: my_stprintf_s(buffer, buffer_len, _T("adc  m")); break;
+		case 0x8f: my_stprintf_s(buffer, buffer_len, _T("adc  a")); break;
+		case 0x90: my_stprintf_s(buffer, buffer_len, _T("sub  b")); break;
+		case 0x91: my_stprintf_s(buffer, buffer_len, _T("sub  c")); break;
+		case 0x92: my_stprintf_s(buffer, buffer_len, _T("sub  d")); break;
+		case 0x93: my_stprintf_s(buffer, buffer_len, _T("sub  e")); break;
+		case 0x94: my_stprintf_s(buffer, buffer_len, _T("sub  h")); break;
+		case 0x95: my_stprintf_s(buffer, buffer_len, _T("sub  l")); break;
+		case 0x96: my_stprintf_s(buffer, buffer_len, _T("sub  m")); break;
+		case 0x97: my_stprintf_s(buffer, buffer_len, _T("sub  a")); break;
+		case 0x98: my_stprintf_s(buffer, buffer_len, _T("sbb  b")); break;
+		case 0x99: my_stprintf_s(buffer, buffer_len, _T("sbb  c")); break;
+		case 0x9a: my_stprintf_s(buffer, buffer_len, _T("sbb  d")); break;
+		case 0x9b: my_stprintf_s(buffer, buffer_len, _T("sbb  e")); break;
+		case 0x9c: my_stprintf_s(buffer, buffer_len, _T("sbb  h")); break;
+		case 0x9d: my_stprintf_s(buffer, buffer_len, _T("sbb  l")); break;
+		case 0x9e: my_stprintf_s(buffer, buffer_len, _T("sbb  m")); break;
+		case 0x9f: my_stprintf_s(buffer, buffer_len, _T("sbb  a")); break;
+		case 0xa0: my_stprintf_s(buffer, buffer_len, _T("ana  b")); break;
+		case 0xa1: my_stprintf_s(buffer, buffer_len, _T("ana  c")); break;
+		case 0xa2: my_stprintf_s(buffer, buffer_len, _T("ana  d")); break;
+		case 0xa3: my_stprintf_s(buffer, buffer_len, _T("ana  e")); break;
+		case 0xa4: my_stprintf_s(buffer, buffer_len, _T("ana  h")); break;
+		case 0xa5: my_stprintf_s(buffer, buffer_len, _T("ana  l")); break;
+		case 0xa6: my_stprintf_s(buffer, buffer_len, _T("ana  m")); break;
+		case 0xa7: my_stprintf_s(buffer, buffer_len, _T("ana  a")); break;
+		case 0xa8: my_stprintf_s(buffer, buffer_len, _T("xra  b")); break;
+		case 0xa9: my_stprintf_s(buffer, buffer_len, _T("xra  c")); break;
+		case 0xaa: my_stprintf_s(buffer, buffer_len, _T("xra  d")); break;
+		case 0xab: my_stprintf_s(buffer, buffer_len, _T("xra  e")); break;
+		case 0xac: my_stprintf_s(buffer, buffer_len, _T("xra  h")); break;
+		case 0xad: my_stprintf_s(buffer, buffer_len, _T("xra  l")); break;
+		case 0xae: my_stprintf_s(buffer, buffer_len, _T("xra  m")); break;
+		case 0xaf: my_stprintf_s(buffer, buffer_len, _T("xra  a")); break;
+		case 0xb0: my_stprintf_s(buffer, buffer_len, _T("ora  b")); break;
+		case 0xb1: my_stprintf_s(buffer, buffer_len, _T("ora  c")); break;
+		case 0xb2: my_stprintf_s(buffer, buffer_len, _T("ora  d")); break;
+		case 0xb3: my_stprintf_s(buffer, buffer_len, _T("ora  e")); break;
+		case 0xb4: my_stprintf_s(buffer, buffer_len, _T("ora  h")); break;
+		case 0xb5: my_stprintf_s(buffer, buffer_len, _T("ora  l")); break;
+		case 0xb6: my_stprintf_s(buffer, buffer_len, _T("ora  m")); break;
+		case 0xb7: my_stprintf_s(buffer, buffer_len, _T("ora  a")); break;
+		case 0xb8: my_stprintf_s(buffer, buffer_len, _T("cmp  b")); break;
+		case 0xb9: my_stprintf_s(buffer, buffer_len, _T("cmp  c")); break;
+		case 0xba: my_stprintf_s(buffer, buffer_len, _T("cmp  d")); break;
+		case 0xbb: my_stprintf_s(buffer, buffer_len, _T("cmp  e")); break;
+		case 0xbc: my_stprintf_s(buffer, buffer_len, _T("cmp  h")); break;
+		case 0xbd: my_stprintf_s(buffer, buffer_len, _T("cmp  l")); break;
+		case 0xbe: my_stprintf_s(buffer, buffer_len, _T("cmp  m")); break;
+		case 0xbf: my_stprintf_s(buffer, buffer_len, _T("cmp  a")); break;
+		case 0xc0: my_stprintf_s(buffer, buffer_len, _T("rnz")); break;
+		case 0xc1: my_stprintf_s(buffer, buffer_len, _T("pop  b")); break;
+		case 0xc2: my_stprintf_s(buffer, buffer_len, _T("jnz  %s"), get_value_or_symbol(debugger->first_symbol, _T("$%04x"), oprom[ptr] | (oprom[ptr + 1] << 8))); ptr += 2; break;
+		case 0xc3: my_stprintf_s(buffer, buffer_len, _T("jmp  %s"), get_value_or_symbol(debugger->first_symbol, _T("$%04x"), oprom[ptr] | (oprom[ptr + 1] << 8))); ptr += 2; break;
+		case 0xc4: my_stprintf_s(buffer, buffer_len, _T("cnz  %s"), get_value_or_symbol(debugger->first_symbol, _T("$%04x"), oprom[ptr] | (oprom[ptr + 1] << 8))); ptr += 2; break;
+		case 0xc5: my_stprintf_s(buffer, buffer_len, _T("push b")); break;
+		case 0xc6: my_stprintf_s(buffer, buffer_len, _T("adi  $%02x"), oprom[ptr++]); break;
+		case 0xc7: my_stprintf_s(buffer, buffer_len, _T("rst  0")); break;
+		case 0xc8: my_stprintf_s(buffer, buffer_len, _T("rz")); break;
+		case 0xc9: my_stprintf_s(buffer, buffer_len, _T("ret")); break;
+		case 0xca: my_stprintf_s(buffer, buffer_len, _T("jz   %s"), get_value_or_symbol(debugger->first_symbol, _T("$%04x"), oprom[ptr] | (oprom[ptr + 1] << 8))); ptr += 2; break;
+		case 0xcb: my_stprintf_s(buffer, buffer_len, _T("jmp  %s"), get_value_or_symbol(debugger->first_symbol, _T("$%04x"), oprom[ptr] | (oprom[ptr + 1] << 8))); ptr += 2; break;
+		case 0xcc: my_stprintf_s(buffer, buffer_len, _T("cz   %s"), get_value_or_symbol(debugger->first_symbol, _T("$%04x"), oprom[ptr] | (oprom[ptr + 1] << 8))); ptr += 2; break;
+		case 0xcd: my_stprintf_s(buffer, buffer_len, _T("call %s"), get_value_or_symbol(debugger->first_symbol, _T("$%04x"), oprom[ptr] | (oprom[ptr + 1] << 8))); ptr += 2; break;
+		case 0xce: my_stprintf_s(buffer, buffer_len, _T("aci  $%02x"), oprom[ptr++]); break;
+		case 0xcf: my_stprintf_s(buffer, buffer_len, _T("rst  1")); break;
+		case 0xd0: my_stprintf_s(buffer, buffer_len, _T("rnc")); break;
+		case 0xd1: my_stprintf_s(buffer, buffer_len, _T("pop  d")); break;
+		case 0xd2: my_stprintf_s(buffer, buffer_len, _T("jnc  %s"), get_value_or_symbol(debugger->first_symbol, _T("$%04x"), oprom[ptr] | (oprom[ptr + 1] << 8))); ptr += 2; break;
+		case 0xd3: my_stprintf_s(buffer, buffer_len, _T("out  $%02x"), oprom[ptr++]); break;
+		case 0xd4: my_stprintf_s(buffer, buffer_len, _T("cnc  %s"), get_value_or_symbol(debugger->first_symbol, _T("$%04x"), oprom[ptr] | (oprom[ptr + 1] << 8))); ptr += 2; break;
+		case 0xd5: my_stprintf_s(buffer, buffer_len, _T("push d")); break;
+		case 0xd6: my_stprintf_s(buffer, buffer_len, _T("sui  $%02x"), oprom[ptr++]); break;
+		case 0xd7: my_stprintf_s(buffer, buffer_len, _T("rst  2")); break;
+		case 0xd8: my_stprintf_s(buffer, buffer_len, _T("rc")); break;
+		case 0xd9: my_stprintf_s(buffer, buffer_len, _T("ret")); break;
+		case 0xda: my_stprintf_s(buffer, buffer_len, _T("jc   %s"), get_value_or_symbol(debugger->first_symbol, _T("$%04x"), oprom[ptr] | (oprom[ptr + 1] << 8))); ptr += 2; break;
+		case 0xdb: my_stprintf_s(buffer, buffer_len, _T("in   $%02x"), oprom[ptr++]); break;
+		case 0xdc: my_stprintf_s(buffer, buffer_len, _T("cc   %s"), get_value_or_symbol(debugger->first_symbol, _T("$%04x"), oprom[ptr] | (oprom[ptr + 1] << 8))); ptr += 2; break;
+		case 0xdd: my_stprintf_s(buffer, buffer_len, _T("call %s"), get_value_or_symbol(debugger->first_symbol, _T("$%04x"), oprom[ptr] | (oprom[ptr + 1] << 8))); ptr += 2; break;
+		case 0xde: my_stprintf_s(buffer, buffer_len, _T("sbi  $%02x"), oprom[ptr++]); break;
+		case 0xdf: my_stprintf_s(buffer, buffer_len, _T("rst  3")); break;
+		case 0xe0: my_stprintf_s(buffer, buffer_len, _T("rpo")); break;
+		case 0xe1: my_stprintf_s(buffer, buffer_len, _T("pop  h")); break;
+		case 0xe2: my_stprintf_s(buffer, buffer_len, _T("jpo  %s"), get_value_or_symbol(debugger->first_symbol, _T("$%04x"), oprom[ptr] | (oprom[ptr + 1] << 8))); ptr += 2; break;
+		case 0xe3: my_stprintf_s(buffer, buffer_len, _T("xthl")); break;
+		case 0xe4: my_stprintf_s(buffer, buffer_len, _T("cpo  %s"), get_value_or_symbol(debugger->first_symbol, _T("$%04x"), oprom[ptr] | (oprom[ptr + 1] << 8))); ptr += 2; break;
+		case 0xe5: my_stprintf_s(buffer, buffer_len, _T("push h")); break;
+		case 0xe6: my_stprintf_s(buffer, buffer_len, _T("ani  $%02x"), oprom[ptr++]); break;
+		case 0xe7: my_stprintf_s(buffer, buffer_len, _T("rst  4")); break;
+		case 0xe8: my_stprintf_s(buffer, buffer_len, _T("rpe")); break;
+		case 0xe9: my_stprintf_s(buffer, buffer_len, _T("PChl")); break;
+		case 0xea: my_stprintf_s(buffer, buffer_len, _T("jpe  %s"), get_value_or_symbol(debugger->first_symbol, _T("$%04x"), oprom[ptr] | (oprom[ptr + 1] << 8))); ptr += 2; break;
+		case 0xeb: my_stprintf_s(buffer, buffer_len, _T("xchg")); break;
+		case 0xec: my_stprintf_s(buffer, buffer_len, _T("cpe  %s"), get_value_or_symbol(debugger->first_symbol, _T("$%04x"), oprom[ptr] | (oprom[ptr + 1] << 8))); ptr += 2; break;
+		case 0xed: 
+			if(oprom[ptr] == 0xed) {
+				my_stprintf_s(buffer, buffer_len, _T("calln $%02x"), oprom[ptr + 1]);
+			} else if(oprom[ptr] == 0xfd) {
+				my_stprintf_s(buffer, buffer_len, _T("retem"));
+			} else {
+				my_stprintf_s(buffer, buffer_len, _T("call %s"), get_value_or_symbol(debugger->first_symbol, _T("$%04x"), oprom[ptr] | (oprom[ptr + 1] << 8)));
+			}
+			 ptr += 2;
+			 break;
+		case 0xee: my_stprintf_s(buffer, buffer_len, _T("xri  $%02x"), oprom[ptr++]); break;
+		case 0xef: my_stprintf_s(buffer, buffer_len, _T("rst  5")); break;
+		case 0xf0: my_stprintf_s(buffer, buffer_len, _T("rp")); break;
+		case 0xf1: my_stprintf_s(buffer, buffer_len, _T("pop  a")); break;
+		case 0xf2: my_stprintf_s(buffer, buffer_len, _T("jp   %s"), get_value_or_symbol(debugger->first_symbol, _T("$%04x"), oprom[ptr] | (oprom[ptr + 1] << 8))); ptr += 2; break;
+		case 0xf3: my_stprintf_s(buffer, buffer_len, _T("di")); break;
+		case 0xf4: my_stprintf_s(buffer, buffer_len, _T("cp   %s"), get_value_or_symbol(debugger->first_symbol, _T("$%04x"), oprom[ptr] | (oprom[ptr + 1] << 8))); ptr += 2; break;
+		case 0xf5: my_stprintf_s(buffer, buffer_len, _T("push a")); break;
+		case 0xf6: my_stprintf_s(buffer, buffer_len, _T("ori  $%02x"), oprom[ptr++]); break;
+		case 0xf7: my_stprintf_s(buffer, buffer_len, _T("rst  6")); break;
+		case 0xf8: my_stprintf_s(buffer, buffer_len, _T("rm")); break;
+		case 0xf9: my_stprintf_s(buffer, buffer_len, _T("sphl")); break;
+		case 0xfa: my_stprintf_s(buffer, buffer_len, _T("jm   %s"), get_value_or_symbol(debugger->first_symbol, _T("$%04x"), oprom[ptr] | (oprom[ptr + 1] << 8))); ptr += 2; break;
+		case 0xfb: my_stprintf_s(buffer, buffer_len, _T("ei")); break;
+		case 0xfc: my_stprintf_s(buffer, buffer_len, _T("cm   %s"), get_value_or_symbol(debugger->first_symbol, _T("$%04x"), oprom[ptr] | (oprom[ptr + 1] << 8))); ptr += 2; break;
+		case 0xfd: my_stprintf_s(buffer, buffer_len, _T("cm   %s"), get_value_or_symbol(debugger->first_symbol, _T("$%04x"), oprom[ptr] | (oprom[ptr + 1] << 8))); ptr += 2; break;
+		case 0xfe: my_stprintf_s(buffer, buffer_len, _T("cpi  $%02x"), oprom[ptr++]); break;
+		case 0xff: my_stprintf_s(buffer, buffer_len, _T("rst  7")); break;
+	}
+	return ptr;
+}
diff -ruN source/src/vm/v30_dasm.h src/vm/v30_dasm.h
--- source/src/vm/v30_dasm.h	1970-01-01 09:00:00
+++ src/vm/v30_dasm.h	2025-04-28 22:36:36
@@ -0,0 +1,20 @@
+/*
+	Skelton for retropc emulator
+
+	Origin : MAME V30 core
+	Author : Takeda.Toshiya
+	Date   : 2020.02.02-
+
+	[ V30 disassembler ]
+*/
+
+#ifndef _V30_DASM_H_
+#define _V30_DASM_H_
+
+#include "../common.h"
+
+class DEBUGGER;
+
+int v30_dasm(DEBUGGER *debugger, uint8_t *oprom, uint32_t eip, bool emulation_mode, _TCHAR *buffer, size_t buffer_len);
+
+#endif
Binary files source/src/vm/wd2793/wd2793.o and src/vm/wd2793/wd2793.o differ
Binary files source/src/vm/wd2793.o and src/vm/wd2793.o differ
diff -ruN source/src/vm/x1/display.cpp src/vm/x1/display.cpp
--- source/src/vm/x1/display.cpp	2023-12-16 01:15:00
+++ src/vm/x1/display.cpp	2025-04-28 22:36:36
@@ -33,11 +33,13 @@
 	FILEIO* fio = new FILEIO();
 	
 	// ank8 (8x8)
+	printf("Load Font...\n");
 	if(fio->Fopen(create_local_path(_T("ANK8.ROM")), FILEIO_READ_BINARY)) {
 		fio->Fread(font, sizeof(font), 1);
 		fio->Fclose();
 	} else if(fio->Fopen(create_local_path(_T("FNT0808.X1")), FILEIO_READ_BINARY)) {
 		// xmillenium rom
+		printf("Font load %s\n", create_local_path(_T("FNT0808.X1")));
 		fio->Fread(font, sizeof(font), 1);
 		fio->Fclose();
 	}
@@ -777,7 +779,17 @@
 	for(int y = 0; y < vt_ofs * 2; y++) {
 #endif
 		scrntype_t* dest = emu->get_screen_buffer(y);
+		static int print_count = 0;
+		if(print_count < 1) {
+			printf("[display.cpp] before memset: y=%d, dest=%p, first4=[%08x %08x %08x %08x]\n",
+				y, dest, dest[0], dest[1], dest[2], dest[3]);
+		}
 		memset(dest, 0, 640 * sizeof(scrntype_t));
+		if(print_count < 1) {
+			printf("[display.cpp] after memset: y=%d, dest=%p, first4=[%08x %08x %08x %08x]\n",
+				y, dest, dest[0], dest[1], dest[2], dest[3]);
+			print_count++;
+		}
 	}
 	
 	// copy to real screen
@@ -1172,8 +1184,8 @@
 			d[7] = ((b0 & 0x01) << 3) | ((b1 & 0x01) << 2) | ((r0 & 0x01) << 7) | ((r1 & 0x01) << 6) | ((g0 & 0x01) << 11) | ((g1 & 0x01) << 10);
 		}
 #if 1
-		// zpriorityÇ≈èàóùÇ∑ÇÈÇ∆ÅAÉvÉåÅ[ÉìÇÃéÊìæÇ…íxâÑÇ™Ç≈ÇÈÇÃÇ≈
-		// Ç±Ç±Ç≈ÇQÉrÉbÉgâ∫Ç÷à⁄ìÆÇµÇƒÇµÇ‹Ç®Ç§
+		// zpriorityÔøΩ≈èÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩ∆ÅAÔøΩvÔøΩÔøΩÔøΩ[ÔøΩÔøΩÔøΩÃéÊìæÔøΩ…íxÔøΩÔøΩÔøΩÔøΩÔøΩ≈ÇÔøΩÃÇÔøΩ
+		// ÔøΩÔøΩÔøΩÔøΩÔøΩ≈ÇQÔøΩrÔøΩbÔøΩgÔøΩÔøΩÔøΩ÷à⁄ìÔøΩÔøΩÔøΩÔøΩƒÇÔøΩÔøΩ‹ÇÔøΩÔøΩÔøΩ
 		if(!hireso && column40 && C64 && page) {
 			for(int x = 0; x < hz_disp && x < width; x++) {
 				uint16_t* d = &zcg[plane][line][x << 3];
diff -ruN source/src/vm/x1/keyboard.cpp src/vm/x1/keyboard.cpp
--- source/src/vm/x1/keyboard.cpp	2018-10-14 22:30:00
+++ src/vm/x1/keyboard.cpp	2025-04-28 22:36:36
@@ -14,6 +14,28 @@
 #include "sub.h"
 #include "../mcs48.h"
 
+#if !defined(_WIN32)
+#ifndef VK_INSERT
+#define VK_INSERT   0x2D
+#endif
+#ifndef VK_SHIFT
+#define VK_SHIFT    0x10
+#endif
+#ifndef VK_DELETE
+#define VK_DELETE   0x2E
+#endif
+#ifndef VK_BACK
+#define VK_BACK     0x08
+#endif
+#ifndef VK_CAPITAL
+#define VK_CAPITAL  0x14
+#endif
+#ifndef VK_KANA
+#define VK_KANA     0x15
+#endif
+#endif
+
+
 #define CAPS	0xfe
 #define KANA	0xff
 
diff -ruN source/src/vm/x1/memory.cpp src/vm/x1/memory.cpp
--- source/src/vm/x1/memory.cpp	2018-10-14 22:30:00
+++ src/vm/x1/memory.cpp	2025-04-28 22:36:36
@@ -31,13 +31,17 @@
 	memset(rom, 0xff, sizeof(rom));
 	memset(ram, 0, sizeof(ram));
 	
+	printf("IPL ROM load");
+	printf("  %s\n",create_local_path(IPL_ROM_FILE_NAME));
 	// load ipl
 	FILEIO* fio = new FILEIO();
 	if(fio->Fopen(create_local_path(IPL_ROM_FILE_NAME), FILEIO_READ_BINARY)) {
+		printf("IPL ROM: %s\n", create_local_path(IPL_ROM_FILE_NAME));
 		// xmillenium rom
 		fio->Fread(rom, IPL_ROM_FILE_SIZE, 1);
 		fio->Fclose();
 	} else if(fio->Fopen(create_local_path(_T("IPL.ROM")), FILEIO_READ_BINARY)) {
+		printf("IPL ROM: %s\n", create_local_path(_T("IPL.ROM")));
 		fio->Fread(rom, IPL_ROM_FILE_SIZE, 1);
 		fio->Fclose();
 	}
diff -ruN source/src/vm/x1/x1.cpp src/vm/x1/x1.cpp
--- source/src/vm/x1/x1.cpp	2023-05-29 00:00:00
+++ src/vm/x1/x1.cpp	2025-05-01 10:06:08
@@ -71,6 +71,11 @@
 VM::VM(EMU* parent_emu) : VM_TEMPLATE(parent_emu)
 {
 	pseudo_sub_cpu = !(FILEIO::IsFileExisting(create_local_path(SUB_ROM_FILE_NAME)) && FILEIO::IsFileExisting(create_local_path(KBD_ROM_FILE_NAME)));
+	printf("[X1 VM] pseudo_sub_cpu=%d (SUB_ROM_FILE_NAME exists=%d, KBD_ROM_FILE_NAME exists=%d)\n",
+		pseudo_sub_cpu,
+		FILEIO::IsFileExisting(create_local_path(SUB_ROM_FILE_NAME)),
+		FILEIO::IsFileExisting(create_local_path(KBD_ROM_FILE_NAME))
+	);
 	
 	sound_type = config.sound_type;
 	
@@ -547,6 +552,11 @@
 
 void VM::run()
 {
+    // „Éá„Éê„ÉÉ„Ç∞„É≠„Ç∞: VM„É°„Ç§„É≥„É´„Éº„ÉóÂëº„Å≥Âá∫„ÅóÊôÇ„Å´tickÊï∞„ÇíÂá∫ÂäõÔºà1000Âõû„Åî„Å®„Å´ÈñìÂºï„ÅçÔºâ
+//    static int vm_run_log_counter = 0;
+//    if ((vm_run_log_counter++ % 1000) == 0) {
+//        printf("[X1 VM] run() event_clocks=%llu\n", event->get_event_clocks());
+//    }
 	event->drive();
 #ifdef _X1TWIN
 	if(pce->is_cart_inserted()) {
diff -ruN source/src/vm/x1/x1.h src/vm/x1/x1.h
--- source/src/vm/x1/x1.h	2022-12-04 15:00:00
+++ src/vm/x1/x1.h	2025-04-28 22:36:36
@@ -121,7 +121,7 @@
 #define USE_MOUSE
 #define USE_PRINTER
 #define USE_PRINTER_TYPE	5
-#define USE_DEBUGGER
+// #define USE_DEBUGGER
 #define USE_STATE
 
 #include "../../common.h"
diff -ruN source/src/vm/ym2151.cpp src/vm/ym2151.cpp
--- source/src/vm/ym2151.cpp	2019-02-16 00:30:00
+++ src/vm/ym2151.cpp	2025-04-28 22:36:36
@@ -15,7 +15,7 @@
 #define EVENT_FM_TIMER	0
 
 #ifdef SUPPORT_MAME_FM_DLL
-// thanks PC8801MAâ¸
+// thanks PC8801MAÔøΩÔøΩ
 #include "fmdll/fmdll.h"
 static CFMDLL* fmdll = NULL;
 static int chip_reference_counter = 0;
@@ -188,7 +188,7 @@
 void YM2151::mix(int32_t* buffer, int cnt)
 {
 	if(cnt > 0 && !mute) {
-		opm->Mix(buffer, cnt);
+		opm->Mix((FM::Sample*)buffer, cnt);
 #ifdef SUPPORT_MAME_FM_DLL
 		if(dllchip) {
 			fmdll->Mix(dllchip, buffer, cnt);
diff -ruN source/src/vm/z80.cpp src/vm/z80.cpp
--- source/src/vm/z80.cpp	2023-06-04 20:00:00
+++ src/vm/z80.cpp	2025-04-28 22:36:36
@@ -92,9 +92,12 @@
 static uint8_t SZHV_inc[256];	/* zero, sign, half carry and overflow flags INC r8 */
 static uint8_t SZHV_dec[256];	/* zero, sign, half carry and overflow flags DEC r8 */
 
-static uint8_t SZHVC_add[2 * 256 * 256];
-static uint8_t SZHVC_sub[2 * 256 * 256];
+// static uint8_t SZHVC_add[2 * 256 * 256];
+// static uint8_t SZHVC_sub[2 * 256 * 256];
 
+uint8_t* Z80::SZHVC_add = nullptr;
+uint8_t* Z80::SZHVC_sub = nullptr;
+
 static bool flags_initialized = false;
 
 static const uint8_t cc_op[0x100] = {
@@ -2145,9 +2148,15 @@
 
 int Z80::run(int clock)
 {
+    // „Éá„Éê„ÉÉ„Ç∞„É≠„Ç∞: Z80ÂÆüË°åÈñãÂßãÊôÇ„Å´PC„Å®tick„ÇíÂá∫ÂäõÔºà1000„ÇØ„É≠„ÉÉ„ÇØ„Åî„Å®„Å´ÈñìÂºï„ÅçÔºâ
+    // static int z80_run_log_counter = 0;
+    // if ((z80_run_log_counter++ % 1000) == 0) {
+    //     printf("[Z80] run() PC=%04X, tick=%d\n", pc.w.l, icount);
+    // }
 	if(clock == -1) {
 		// this is primary cpu
 		if(wait) {
+			// printf("[Z80] waitÁä∂ÊÖã„Åßrun(-1)„ÇíÊäú„Åë„Åæ„Åô (PC=%04x)\n", pc.w.l);
 			// don't run cpu!
 			#ifdef USE_DEBUGGER
 				total_icount += 1;
@@ -2266,6 +2275,10 @@
 
 void Z80::run_one_opecode()
 {
+    // „Éá„Éê„ÉÉ„Ç∞„É≠„Ç∞: Z80ÂëΩ‰ª§ÂÆüË°åÊôÇ„Å´PC„ÇíÂá∫ÂäõÔºàPC„Åå0x0000ÔΩû0x00FF„ÅÆÁØÑÂõ≤„ÅÆ„ÅøÔºâ
+    // if ((pc.w.l & 0xFF00) == 0x0000) {
+    //     printf("[Z80] run_one_opecode() PC=%04X\n", pc.w.l);
+    // }
 	if(!after_ei) {
 #ifdef USE_DEBUGGER
 		if(d_debugger->now_debugging) {
diff -ruN source/src/vm/z80.h src/vm/z80.h
--- source/src/vm/z80.h	2023-06-04 20:00:00
+++ src/vm/z80.h	2025-04-28 22:36:36
@@ -71,6 +71,9 @@
 	bool after_ldair;
 	uint32_t intr_req_bit, intr_pend_bit;
 	bool intr_enb;
+
+	static uint8_t* SZHVC_add;
+	static uint8_t* SZHVC_sub;
 	
 	inline uint8_t RM8(uint32_t addr);
 	inline void WM8(uint32_t addr, uint8_t val);
@@ -123,11 +126,25 @@
 #ifdef SINGLE_MODE_DMA
 		d_dma = NULL;
 #endif
+// static uint8_t SZHVC_add[2 * 256 * 256];
+// static uint8_t SZHVC_sub[2 * 256 * 256];
+		SZHVC_add = new uint8_t[2 * 256 * 256];
+		SZHVC_sub = new uint8_t[2 * 256 * 256];
+
 		initialize_output_signals(&outputs_busack);
 		is_primary = false;
 		set_device_name(_T("Z80 CPU"));
 	}
-	~Z80() {}
+	~Z80() {
+		if (SZHVC_add) {
+			delete[] SZHVC_add;
+			SZHVC_add = nullptr;
+		}
+		if (SZHVC_sub) {
+			delete[] SZHVC_sub;
+			SZHVC_sub = nullptr;
+		}
+	}
 	
 	// common functions
 	void initialize();
diff -ruN source/src/win32/osd.cpp src/win32/osd.cpp
--- source/src/win32/osd.cpp	2022-07-03 21:40:00
+++ src/win32/osd.cpp	1970-01-01 09:00:00
@@ -1,180 +0,0 @@
-/*
-	Skelton for retropc emulator
-
-	Author : Takeda.Toshiya
-	Date   : 2015.11.20-
-
-	[ win32 dependent ]
-*/
-
-#include "osd.h"
-
-void OSD::initialize(int rate, int samples)
-{
-	// check os version
-	OSVERSIONINFO os_info;
-	os_info.dwOSVersionInfoSize = sizeof(OSVERSIONINFO);
-	GetVersionEx(&os_info);
-	vista_or_later = (os_info.dwPlatformId == 2 && (os_info.dwMajorVersion > 6 || (os_info.dwMajorVersion == 6 && os_info.dwMinorVersion >= 0)));
-	
-	GdiplusStartup(&gdiToken, &gdiSI, NULL);
-	initialize_console();
-	initialize_input();
-	initialize_screen();
-	initialize_sound(rate, samples);
-#if defined(USE_MOVIE_PLAYER) || defined(USE_VIDEO_CAPTURE)
-	CoInitialize(NULL);
-	initialize_video();
-#endif
-#ifdef USE_SOCKET
-	initialize_socket();
-#endif
-#ifdef USE_MIDI
-	initialize_midi();
-#endif
-}
-
-void OSD::release()
-{
-	release_console();
-	release_input();
-	release_screen();
-	release_sound();
-#if defined(USE_MOVIE_PLAYER) || defined(USE_VIDEO_CAPTURE)
-	release_video();
-	CoUninitialize();
-#endif
-#ifdef USE_SOCKET
-	release_socket();
-#endif
-#ifdef USE_MIDI
-	release_midi();
-#endif
-	GdiplusShutdown(gdiToken);
-}
-
-void OSD::power_off()
-{
-	PostMessage(main_window_handle, WM_CLOSE, 0, 0L);
-}
-
-void OSD::suspend()
-{
-#ifdef USE_MOVIE_PLAYER
-	if(now_movie_play && !now_movie_pause) {
-		pause_movie();
-		now_movie_pause = false;
-	}
-#endif
-	mute_sound();
-}
-
-void OSD::restore()
-{
-#ifdef USE_MOVIE_PLAYER
-	if(now_movie_play && !now_movie_pause) {
-		play_movie();
-	}
-#endif
-}
-
-void OSD::lock_vm()
-{
-	lock_count++;
-}
-
-void OSD::unlock_vm()
-{
-	if(--lock_count <= 0) {
-		force_unlock_vm();
-	}
-}
-
-void OSD::force_unlock_vm()
-{
-	lock_count = 0;
-}
-
-void OSD::sleep(uint32_t ms)
-{
-	Sleep(ms);
-}
-
-#ifdef USE_DEBUGGER
-FARPROC hWndProc = NULL;
-OSD *my_osd = NULL;
-
-LRESULT CALLBACK MyWndProc(HWND hWnd, UINT iMsg, WPARAM wParam, LPARAM lParam)
-{
-	switch(iMsg) {
-	case WM_CLOSE:
-		return 0;
-	case WM_PAINT:
-		if(my_osd) {
-			PAINTSTRUCT ps;
-			HDC hdc = BeginPaint(hWnd, &ps);
-#ifdef ONE_BOARD_MICRO_COMPUTER
-			my_osd->reload_bitmap();
-#endif
-			my_osd->update_screen(hdc);
-			EndPaint(hWnd, &ps);
-		}
-		return 0;
-	}
-	return DefWindowProc(hWnd, iMsg, wParam, lParam);
-}
-
-void OSD::start_waiting_in_debugger()
-{
-	HMENU hMenu = GetMenu(main_window_handle);
-	
-	if(hMenu != NULL) {
-		for(int i = 0;; i++) {
-			if(EnableMenuItem(hMenu, i, MF_BYPOSITION | MF_GRAYED) == -1) {
-				break;
-			}
-		}
-	}
-#ifdef _M_AMD64
-	// thanks Marukun (64bit)
-	hWndProc = (FARPROC)GetWindowLongPtr(main_window_handle, GWLP_WNDPROC);
-	SetWindowLongPtr(main_window_handle, GWLP_WNDPROC, (LONG_PTR)MyWndProc);
-#else
-	hWndProc = (FARPROC)GetWindowLong(main_window_handle, GWL_WNDPROC);
-	SetWindowLong(main_window_handle, GWL_WNDPROC, (LONG)MyWndProc);
-#endif
-	my_osd = this;
-}
-
-void OSD::finish_waiting_in_debugger()
-{
-	HMENU hMenu = GetMenu(main_window_handle);
-	
-	if(hMenu != NULL) {
-		for(int i = 0;; i++) {
-			if(EnableMenuItem(hMenu, i, MF_BYPOSITION | MF_ENABLED) == -1) {
-				break;
-			}
-		}
-	}
-#ifdef _M_AMD64
-	// thanks Marukun (64bit)
-	SetWindowLongPtr(main_window_handle, GWLP_WNDPROC, (LONG_PTR)hWndProc);
-#else
-	SetWindowLong(main_window_handle, GWL_WNDPROC, (LONG)hWndProc);
-#endif
-	my_osd = NULL;
-}
-
-void OSD::process_waiting_in_debugger()
-{
-	MSG msg;
-	
-	while(PeekMessage(&msg, NULL, 0, 0, PM_NOREMOVE)) {
-		if(GetMessage(&msg, NULL, 0, 0)) {
-			TranslateMessage(&msg);
-			DispatchMessage(&msg);
-		}
-	}
-}
-#endif
diff -ruN source/src/win32/osd.h src/win32/osd.h
--- source/src/win32/osd.h	2025-04-28 16:00:00
+++ src/win32/osd.h	1970-01-01 09:00:00
@@ -1,740 +0,0 @@
-/*
-	Skelton for retropc emulator
-
-	Author : Takeda.Toshiya
-	Date   : 2015.11.20-
-
-	[ win32 dependent ]
-*/
-
-#ifndef _WIN32_OSD_H_
-#define _WIN32_OSD_H_
-
-#ifndef _WIN32_WINNT
-#define _WIN32_WINNT		0x500
-#endif
-#define DIRECTSOUND_VERSION	0x900
-#define DIRECT3D_VERSION	0x900
-// XXX: if your DirectX 9.0 SDK is newer and does not contain dinput.lib,
-// please change the definition of DIRECTINPUT_VERSION from 0x500 to 0x800
-//#define DIRECTINPUT_VERSION	0x500
-#define DIRECTINPUT_VERSION	0x800
-
-#if defined(_MSC_VER) && (_MSC_VER >= 1910)
-#define SUPPORT_D2D1
-#endif
-
-#ifndef _UNITY			// MARU
-#define SUPPORT_D3D9
-#endif
-
-#include <windows.h>
-#include <windowsx.h>
-#include <mmsystem.h>
-#include <process.h>
-#include <commctrl.h>
-#include <wingdi.h>
-#include <gdiplus.h>
-#ifdef SUPPORT_D2D1
-#include <d2d1.h>
-#endif
-#ifdef SUPPORT_D3D9
-#include <d3d9.h>
-//#include <d3dx9.h>
-#include <d3d9types.h>
-#endif
-#include <vfw.h>
-#include <dsound.h>
-#include <dinput.h>
-#include <winsock.h>
-#include "../vm/vm.h"
-//#include "../emu.h"
-#include "../common.h"
-#include "../config.h"
-
-#if defined(USE_ZLIB) && !defined(USE_VCPKG)				// zlib not installed by vcpkg
-	// relative path from *.vcproj/*.vcxproj, not from this directory :-(
-	#ifdef _M_AMD64
-		// these zlibstat.lib were built with VC++2017 (thanks Marukun)
-		#ifdef _DEBUG
-			#pragma comment(lib, "../src/zlib-1.2.11/debug/x64/zlibstat.lib")
-		#else
-			#pragma comment(lib, "../src/zlib-1.2.11/release/x64/zlibstat.lib")
-		#endif
-	#else
-		// these zlibstat.lib were built with VC++2008
-		#ifdef _DEBUG
-			#pragma comment(lib, "../src/zlib-1.2.11/debug/zlibstat.lib")
-		#else
-			#pragma comment(lib, "../src/zlib-1.2.11/release/zlibstat.lib")
-		#endif
-		// for vsnprintf() and snprintf() in zlibstat.lib
-		#if defined(_MSC_VER) && (_MSC_VER >= 1900)
-			#pragma comment(lib, "legacy_stdio_definitions.lib")
-		#endif
-	#endif
-#endif
-
-#pragma comment(lib, "wsock32.lib")
-#pragma comment(lib, "comctl32.lib")
-#pragma comment(lib, "msimg32.lib")
-#pragma comment(lib, "gdiplus.lib")
-using namespace Gdiplus;
-#ifdef SUPPORT_D2D1
-#pragma comment(lib, "d2d1.lib")
-#endif
-#ifdef SUPPORT_D3D9
-#pragma comment(lib, "d3d9.lib")
-//#pragma comment(lib, "d3dx9.lib")
-#endif
-#pragma comment(lib, "vfw32.lib")
-#pragma comment(lib, "dsound.lib")
-#if DIRECTINPUT_VERSION >= 0x0800
-#pragma comment(lib, "dinput8.lib")
-#else
-#pragma comment(lib, "dinput.lib")
-#endif
-#pragma comment(lib, "dxguid.lib")
-
-#if defined(USE_MOVIE_PLAYER) || defined(USE_VIDEO_CAPTURE)
-#pragma comment(lib, "strmiids.lib")
-#include <dshow.h>
-//#include <qedit.h>
-EXTERN_C const CLSID CLSID_SampleGrabber;
-EXTERN_C const CLSID CLSID_NullRenderer;
-EXTERN_C const IID IID_ISampleGrabberCB;
-MIDL_INTERFACE("0579154A-2B53-4994-B0D0-E773148EFF85")
-ISampleGrabberCB : public IUnknown {
-public:
-	virtual HRESULT STDMETHODCALLTYPE SampleCB( double SampleTime,IMediaSample *pSample) = 0;
-	virtual HRESULT STDMETHODCALLTYPE BufferCB( double SampleTime,BYTE *pBuffer,long BufferLen) = 0;
-};
-EXTERN_C const IID IID_ISampleGrabber;
-MIDL_INTERFACE("6B652FFF-11FE-4fce-92AD-0266B5D7C78F")
-ISampleGrabber : public IUnknown {
-public:
-	virtual HRESULT STDMETHODCALLTYPE SetOneShot( BOOL OneShot) = 0;
-	virtual HRESULT STDMETHODCALLTYPE SetMediaType( const AM_MEDIA_TYPE *pType) = 0;
-	virtual HRESULT STDMETHODCALLTYPE GetConnectedMediaType( AM_MEDIA_TYPE *pType) = 0;
-	virtual HRESULT STDMETHODCALLTYPE SetBufferSamples( BOOL BufferThem) = 0;
-	virtual HRESULT STDMETHODCALLTYPE GetCurrentBuffer( /* [out][in] */ long *pBufferSize,/* [out] */ long *pBuffer) = 0;
-	virtual HRESULT STDMETHODCALLTYPE GetCurrentSample( /* [retval][out] */ IMediaSample **ppSample) = 0;
-	virtual HRESULT STDMETHODCALLTYPE SetCallback( ISampleGrabberCB *pCallback,long WhichMethodToCallback) = 0;
-};
-#endif
-#ifdef USE_MOVIE_PLAYER
-class CMySampleGrabberCB : public ISampleGrabberCB {
-private:
-	VM_TEMPLATE *vm;
-public:
-	CMySampleGrabberCB(VM_TEMPLATE *vm_ptr)
-	{
-		vm = vm_ptr;
-	}
-	STDMETHODIMP_(ULONG) AddRef()
-	{
-		return 2;
-	}
-	STDMETHODIMP_(ULONG) Release()
-	{
-		return 1;
-	}
-	STDMETHODIMP QueryInterface(REFIID riid, void **ppv)
-	{
-		if(riid == IID_ISampleGrabberCB || riid == IID_IUnknown) {
-			*ppv = (void *) static_cast<ISampleGrabberCB*>(this);
-			return NOERROR;
-		}
-		return E_NOINTERFACE;
-	}
-	STDMETHODIMP SampleCB(double SampleTime, IMediaSample *pSample)
-	{
-		return S_OK;
-	}
-	STDMETHODIMP BufferCB(double dblSampleTime, BYTE *pBuffer, long lBufferSize)
-	{
-		vm->movie_sound_callback(pBuffer, lBufferSize);
-		return S_OK;
-	}
-};
-#endif
-
-#define WM_RESIZE  (WM_USER + 1)
-#define WM_SOCKET0 (WM_USER + 2)
-#define WM_SOCKET1 (WM_USER + 3)
-#define WM_SOCKET2 (WM_USER + 4)
-#define WM_SOCKET3 (WM_USER + 5)
-
-#ifdef USE_SOCKET
-#define SOCKET_MAX 4
-#define SOCKET_BUFFER_MAX 0x100000
-#endif
-
-#ifdef USE_VIDEO_CAPTURE
-#define MAX_CAPTURE_DEVS 8
-#endif
-
-#ifndef _M_AMD64
-#define SUPPORT_WIN32_DLL
-#endif
-
-#define SCREEN_FILTER_NONE	0
-#define SCREEN_FILTER_RGB	1
-#define SCREEN_FILTER_RF	2
-
-// check memory leaks
-#ifdef _DEBUG
-// _malloca is defined in typeinfo.h
-#ifdef _malloca
-#undef _malloca
-#endif
-#define _CRTDBG_MAP_ALLOC
-#include <crtdbg.h>
-#define malloc(s) _malloc_dbg(s, _NORMAL_BLOCK, __FILE__, __LINE__)
-#define new new(_NORMAL_BLOCK, __FILE__, __LINE__)
-#endif
-
-// osd common
-
-class FIFO;
-class FILEIO;
-
-#define OSD_CONSOLE_BLUE	1 // text color contains blue
-#define OSD_CONSOLE_GREEN	2 // text color contains green
-#define OSD_CONSOLE_RED		4 // text color contains red
-#define OSD_CONSOLE_INTENSITY	8 // text color is intensified
-
-typedef struct bitmap_s {
-	// common
-	inline bool initialized()
-	{
-		return (hdcDib != NULL);
-	}
-	inline scrntype_t* get_buffer(int y)
-	{
-		return lpBmp + width * (height - y - 1);
-	}
-	int width, height;
-	// win32 dependent
-	HDC hdcDib;
-	HBITMAP hBmp, hOldBmp;
-	LPBYTE lpBuf;
-	scrntype_t* lpBmp;
-	LPBITMAPINFO lpDib;
-} bitmap_t;
-
-typedef struct font_s {
-	// common
-	inline bool initialized()
-	{
-		return (hFont != NULL);
-	}
-	_TCHAR family[64];
-	int width, height, rotate;
-	bool bold, italic;
-	// win32 dependent
-	HFONT hFont;
-} font_t;
-
-typedef struct pen_s {
-	// common
-	inline bool initialized()
-	{
-		return (hPen != NULL);
-	}
-	int width;
-	uint8_t r, g, b;
-	// win32 dependent
-	HPEN hPen;
-} pen_t;
-
-typedef struct {
-	PAVISTREAM pAVICompressed;
-	scrntype_t* lpBmp;
-	LPBITMAPINFOHEADER pbmInfoHeader;
-	DWORD dwAVIFileSize;
-	LONG lAVIFrames;
-	int frames;
-	int result;
-} rec_video_thread_param_t;
-
-#ifdef USE_MIDI
-typedef struct midi_thread_params_s {
-	FIFO *send_buffer;
-	FIFO *recv_buffer;
-	bool terminate;
-} midi_thread_params_t;
-#endif
-
-class OSD
-{
-private:
-	int lock_count;
-	
-	// console
-	void initialize_console();
-	void release_console();
-	
-	HANDLE hStdIn, hStdOut;
-	int console_count;
-	
-	void open_telnet(const _TCHAR* title);
-	void close_telnet();
-	void send_telnet(const char* buffer);
-	
-	bool use_telnet, telnet_closed;
-	UINT_PTR svr_socket, cli_socket;
-	
-	// input
-	void initialize_input();
-	void release_input();
-	
-#if DIRECTINPUT_VERSION >= 0x0800
-	LPDIRECTINPUT8 lpdi;
-	LPDIRECTINPUTDEVICE8 lpdikey;
-//	LPDIRECTINPUTDEVICE8 lpdijoy;
-#else
-	LPDIRECTINPUT lpdi;
-	LPDIRECTINPUTDEVICE lpdikey;
-//	LPDIRECTINPUTDEVICE lpdijoy;
-#endif
-	bool dinput_key_available;
-//	bool dinput_joy_available;
-	
-	uint8_t keycode_conv[256];
-	uint8_t key_status[256];	// windows key code mapping
-	uint8_t key_dik[256];
-	uint8_t key_dik_prev[256];
-	bool key_shift_pressed, key_shift_released;
-	bool key_caps_locked;
-	bool lost_focus;
-	
-#ifdef USE_JOYSTICK
-	// bit0-3	up,down,left,right
-	// bit4-19	button #1-#16
-	// bit20-21	z-axis pos
-	// bit22-23	r-axis pos
-	// bit24-25	u-axis pos
-	// bit26-27	v-axis pos
-	// bit28-31	pov pos
-	uint32_t joy_status[4];
-	int joy_num;
-	struct {
-		UINT wNumAxes;
-		DWORD dwXposLo, dwXposHi;
-		DWORD dwYposLo, dwYposHi;
-		DWORD dwZposLo, dwZposHi;
-		DWORD dwRposLo, dwRposHi;
-		DWORD dwUposLo, dwUposHi;
-		DWORD dwVposLo, dwVposHi;
-		DWORD dwButtonsMask;
-	} joy_caps[4];
-	bool joy_to_key_status[256];
-#endif
-	
-#ifdef USE_MOUSE
-	int32_t mouse_status[3];	// x, y, button (b0 = left, b1 = right)
-	bool mouse_enabled;
-#endif
-	
-	// screen
-	void initialize_screen();
-	void release_screen();
-	void initialize_screen_buffer(bitmap_t *buffer, int width, int height, int mode);
-	void release_screen_buffer(bitmap_t *buffer);
-#ifdef USE_SCREEN_FILTER
-	void apply_rgb_filter_to_screen_buffer(bitmap_t *source, bitmap_t *dest);
-	void apply_rgb_filter_x3_y3(bitmap_t *source, bitmap_t *dest);
-	void apply_rgb_filter_x3_y2(bitmap_t *source, bitmap_t *dest);
-	void apply_rgb_filter_x2_y3(bitmap_t *source, bitmap_t *dest);
-	void apply_rgb_filter_x2_y2(bitmap_t *source, bitmap_t *dest);
-	void apply_rgb_filter_x1_y1(bitmap_t *source, bitmap_t *dest);
-#endif
-//#ifdef USE_SCREEN_ROTATE
-	void rotate_screen_buffer(bitmap_t *source, bitmap_t *dest);
-//#endif
-	void stretch_screen_buffer(bitmap_t *source, bitmap_t *dest);
-#ifdef SUPPORT_D2D1
-	bool initialize_d2d1();
-	bool initialize_d2d1_surface(bitmap_t *buffer);
-	void release_d2d1();
-	void release_d2d1_surface();
-	void copy_to_d2d1_surface(bitmap_t *buffer);
-	void update_d2d1_screen(int dest_x, int dest_y);
-#endif
-#ifdef SUPPORT_D3D9
-	bool initialize_d3d9();
-	bool initialize_d3d9_surface(bitmap_t *buffer);
-	void release_d3d9();
-	void release_d3d9_surface();
-	void copy_to_d3d9_surface(bitmap_t *buffer);
-	void update_d3d9_screen(int dest_x, int dest_y);
-#endif
-	int add_video_frames();
-	
-	bitmap_t vm_screen_buffer;
-#ifdef USE_SCREEN_FILTER
-	bitmap_t filtered_screen_buffer;
-	bitmap_t tmp_filtered_screen_buffer;
-#endif
-//#ifdef USE_SCREEN_ROTATE
-	bitmap_t rotated_screen_buffer;
-//#endif
-	bitmap_t stretched_screen_buffer;
-	bitmap_t shrinked_screen_buffer;
-	bitmap_t reversed_screen_buffer;
-	bitmap_t video_screen_buffer;
-	
-	bitmap_t* draw_screen_buffer;
-	
-	int host_window_width, host_window_height;
-	bool host_window_mode;
-	int vm_screen_width, vm_screen_height;
-	int vm_window_width, vm_window_height;
-	int vm_window_width_aspect, vm_window_height_aspect;
-	int draw_screen_width, draw_screen_height;
-	
-	Gdiplus::GdiplusStartupInput gdiSI;
-	ULONG_PTR gdiToken;
-	
-#ifdef SUPPORT_D2D1
-	ID2D1Factory* pD2d1Factory;
-	ID2D1DCRenderTarget *pD2d1DCRenderTarget;
-	ID2D1HwndRenderTarget* pD2d1HwndRenderTarget;
-	ID2D1Bitmap* pD2d1Bitmap;
-#endif
-#ifdef SUPPORT_D3D9
-	LPDIRECT3D9 lpd3d9;
-	LPDIRECT3DDEVICE9 lpd3d9Device;
-	LPDIRECT3DSURFACE9 lpd3d9Surface;
-	LPDIRECT3DSURFACE9 lpd3d9OffscreenSurface;
-	bool d3d9_device_lost;
-#endif
-	
-	_TCHAR video_file_path[_MAX_PATH];
-	int rec_video_fps;
-	double rec_video_run_frames;
-	double rec_video_frames;
-	
-	LPBITMAPINFO lpDibRec;
-	PAVIFILE pAVIFile;
-	PAVISTREAM pAVIStream;
-	PAVISTREAM pAVICompressed;
-	AVICOMPRESSOPTIONS AVIOpts;
-	DWORD dwAVIFileSize;
-	LONG lAVIFrames;
-	HANDLE hVideoThread;
-	rec_video_thread_param_t rec_video_thread_param;
-	
-	bool first_draw_screen;
-	bool first_invalidate;
-	bool self_invalidate;
-	
-	// sound
-	void initialize_sound(int rate, int samples);
-	void release_sound();
-	
-	int sound_rate, sound_samples;
-	bool sound_available, sound_started, sound_muted;
-	
-	LPDIRECTSOUND lpds;
-	LPDIRECTSOUNDBUFFER lpdsPrimaryBuffer, lpdsSecondaryBuffer;
-	bool sound_first_half;
-	
-	_TCHAR sound_file_path[_MAX_PATH];
-	FILEIO* rec_sound_fio;
-	int rec_sound_bytes;
-	int rec_sound_buffer_ptr;
-	
-	// video device
-#if defined(USE_MOVIE_PLAYER) || defined(USE_VIDEO_CAPTURE)
-	void initialize_video();
-	void release_video();
-	
-	IGraphBuilder *pGraphBuilder;
-	IBaseFilter *pVideoBaseFilter;
-	IBaseFilter *pCaptureBaseFilter;
-	ICaptureGraphBuilder2 *pCaptureGraphBuilder2;
-	ISampleGrabber *pVideoSampleGrabber;
-	IBaseFilter *pSoundBaseFilter;
-	ISampleGrabber *pSoundSampleGrabber;
-	CMySampleGrabberCB *pSoundCallBack;
-	IMediaControl *pMediaControl;
-	IMediaSeeking *pMediaSeeking;
-	IMediaPosition *pMediaPosition;
-	IVideoWindow *pVideoWindow;
-	IBasicVideo *pBasicVideo;
-	IBasicAudio *pBasicAudio;
-	bool bTimeFormatFrame;
-	bool bVerticalReversed;
-	
-	bitmap_t direct_show_screen_buffer;
-	bitmap_t direct_show_stretch_buffer;
-	int direct_show_width, direct_show_height;
-	bool direct_show_mute[2];
-#endif
-#ifdef USE_MOVIE_PLAYER
-	double movie_frame_rate;
-	int movie_sound_rate;
-#endif
-#ifdef USE_VIDEO_CAPTURE
-	void enum_capture_devs();
-	bool connect_capture_dev(int index, bool pin);
-	int cur_capture_dev_index;
-	int num_capture_devs;
-	_TCHAR capture_dev_name[MAX_CAPTURE_DEVS][256];
-#endif
-	
-	// socket
-#ifdef USE_SOCKET
-	void initialize_socket();
-	void release_socket();
-	
-	SOCKET soc[SOCKET_MAX];
-	bool is_tcp[SOCKET_MAX];
-	struct sockaddr_in udpaddr[SOCKET_MAX];
-	int socket_delay[SOCKET_MAX];
-	char recv_buffer[SOCKET_MAX][SOCKET_BUFFER_MAX];
-	int recv_r_ptr[SOCKET_MAX], recv_w_ptr[SOCKET_MAX];
-#endif
-	
-	//midi
-#ifdef USE_MIDI
-	void initialize_midi();
-	void release_midi();
-	
-	HANDLE hMidiThread;
-	midi_thread_params_t midi_thread_params;
-#endif
-	
-public:
-	OSD()
-	{
-		lock_count = 0;
-	}
-	~OSD() {}
-	
-	// common
-	VM_TEMPLATE* vm;
-	
-	void initialize(int rate, int samples);
-	void release();
-	void power_off();
-	void suspend();
-	void restore();
-	void lock_vm();
-	void unlock_vm();
-	bool is_vm_locked()
-	{
-		return (lock_count != 0);
-	}
-	void force_unlock_vm();
-	void sleep(uint32_t ms);
-	
-	// common debugger
-#ifdef USE_DEBUGGER
-	void start_waiting_in_debugger();
-	void finish_waiting_in_debugger();
-	void process_waiting_in_debugger();
-#endif
-	
-	// common console
-	void open_console(int width, int height, const _TCHAR* title);
-	void close_console();
-	unsigned int get_console_code_page();
-	void set_console_text_attribute(unsigned short attr);
-	void write_console(const _TCHAR* buffer, unsigned int length);
-	int read_console_input(_TCHAR* buffer, unsigned int length);
-	bool is_console_key_pressed(int vk);
-	bool is_console_closed();
-	void close_debugger_console();
-	
-	// common input
-	void update_input();
-	void key_down(int code, bool extended, bool repeat);
-	void key_up(int code, bool extended);
-	void key_down_native(int code, bool repeat);
-	void key_up_native(int code);
-	void key_lost_focus()
-	{
-		lost_focus = true;
-	}
-#ifdef USE_MOUSE
-	void enable_mouse();
-	void disable_mouse();
-	void toggle_mouse();
-	bool is_mouse_enabled()
-	{
-		return mouse_enabled;
-	}
-#endif
-	uint8_t* get_key_buffer()
-	{
-		return key_status;
-	}
-#ifdef USE_JOYSTICK
-	uint32_t* get_joy_buffer()
-	{
-		return joy_status;
-	}
-#endif
-#ifdef USE_MOUSE
-	int32_t* get_mouse_buffer()
-	{
-		return mouse_status;
-	}
-#endif
-#ifdef USE_AUTO_KEY
-	bool now_auto_key;
-#endif
-	
-	// common screen
-	double get_window_mode_power(int mode);
-	int get_window_mode_width(int mode);
-	int get_window_mode_height(int mode);
-	void set_host_window_size(int window_width, int window_height, bool window_mode);
-	void set_vm_screen_size(int screen_width, int screen_height, int window_width, int window_height, int window_width_aspect, int window_height_aspect);
-	void set_vm_screen_lines(int lines);
-	int get_vm_window_width()
-	{
-		return vm_window_width;
-	}
-	int get_vm_window_height()
-	{
-		return vm_window_height;
-	}
-	int get_vm_window_width_aspect()
-	{
-		return vm_window_width_aspect;
-	}
-	int get_vm_window_height_aspect()
-	{
-		return vm_window_height_aspect;
-	}
-	scrntype_t* get_vm_screen_buffer(int y);
-	int draw_screen();
-#ifdef ONE_BOARD_MICRO_COMPUTER
-	void reload_bitmap()
-	{
-		first_invalidate = true;
-	}
-#endif
-	void capture_screen();
-	bool start_record_video(int fps);
-	void stop_record_video();
-	void restart_record_video();
-	void add_extra_frames(int extra_frames);
-	bool now_record_video;
-#ifdef USE_SCREEN_FILTER
-	bool screen_skip_line;
-#endif
-	
-	// common sound
-	void update_sound(int* extra_frames);
-	void mute_sound();
-	void stop_sound();
-	void start_record_sound();
-	void stop_record_sound();
-	void restart_record_sound();
-	bool now_record_sound;
-#ifdef _UNITY	// MARU
-	int16_t	* get_sound_buffer();
-#endif // !_UNITY
-	
-	// common video device
-#if defined(USE_MOVIE_PLAYER) || defined(USE_VIDEO_CAPTURE)
-	void get_video_buffer();
-	void mute_video_dev(bool l, bool r);
-#endif
-#ifdef USE_MOVIE_PLAYER
-	bool open_movie_file(const _TCHAR* file_path);
-	void close_movie_file();
-	void play_movie();
-	void stop_movie();
-	void pause_movie();
-	double get_movie_frame_rate()
-	{
-		return movie_frame_rate;
-	}
-	int get_movie_sound_rate()
-	{
-		return movie_sound_rate;
-	}
-	void set_cur_movie_frame(int frame, bool relative);
-	uint32_t get_cur_movie_frame();
-	bool now_movie_play, now_movie_pause;
-#endif
-#ifdef USE_VIDEO_CAPTURE
-	int get_cur_capture_dev_index()
-	{
-		return cur_capture_dev_index;
-	}
-	int get_num_capture_devs()
-	{
-		return num_capture_devs;
-	}
-	_TCHAR* get_capture_dev_name(int index)
-	{
-		return capture_dev_name[index];
-	}
-	void open_capture_dev(int index, bool pin);
-	void close_capture_dev();
-	void show_capture_dev_filter();
-	void show_capture_dev_pin();
-	void show_capture_dev_source();
-	void set_capture_dev_channel(int ch);
-#endif
-	
-	// common printer
-#ifdef USE_PRINTER
-	void create_bitmap(bitmap_t *bitmap, int width, int height);
-	void release_bitmap(bitmap_t *bitmap);
-	void create_font(font_t *font, const _TCHAR *family, int width, int height, int rotate, bool bold, bool italic);
-	void release_font(font_t *font);
-	void create_pen(pen_t *pen, int width, uint8_t r, uint8_t g, uint8_t b);
-	void release_pen(pen_t *pen);
-	void clear_bitmap(bitmap_t *bitmap, uint8_t r, uint8_t g, uint8_t b);
-	int get_text_width(bitmap_t *bitmap, font_t *font, const char *text);
-	void draw_text_to_bitmap(bitmap_t *bitmap, font_t *font, int x, int y, const char *text, uint8_t r, uint8_t g, uint8_t b);
-	void draw_line_to_bitmap(bitmap_t *bitmap, pen_t *pen, int sx, int sy, int ex, int ey);
-	void draw_rectangle_to_bitmap(bitmap_t *bitmap, int x, int y, int width, int height, uint8_t r, uint8_t g, uint8_t b);
-	void draw_point_to_bitmap(bitmap_t *bitmap, int x, int y, uint8_t r, uint8_t g, uint8_t b);
-	void stretch_bitmap(bitmap_t *dest, int dest_x, int dest_y, int dest_width, int dest_height, bitmap_t *source, int source_x, int source_y, int source_width, int source_height);
-#endif
-	void write_bitmap_to_file(bitmap_t *bitmap, const _TCHAR *file_path);
-	
-	// common socket
-#ifdef USE_SOCKET
-	SOCKET get_socket(int ch)
-	{
-		return soc[ch];
-	}
-	void notify_socket_connected(int ch);
-	void notify_socket_disconnected(int ch);
-	void update_socket();
-	bool initialize_socket_tcp(int ch);
-	bool initialize_socket_udp(int ch);
-	bool connect_socket(int ch, uint32_t ipaddr, int port);
-	void disconnect_socket(int ch);
-	bool listen_socket(int ch);
-	void send_socket_data_tcp(int ch);
-	void send_socket_data_udp(int ch, uint32_t ipaddr, int port);
-	void send_socket_data(int ch);
-	void recv_socket_data(int ch);
-#endif
-	
-	// common midi
-#ifdef USE_MIDI
-	void send_to_midi(uint8_t data);
-	bool recv_from_midi(uint8_t *data);
-#endif
-	
-	// win32 dependent
-	void invalidate_screen();
-	void update_screen(HDC hdc);
-	HWND main_window_handle;
-	HINSTANCE instance_handle;
-	bool vista_or_later;
-};
-
-#endif
diff -ruN source/src/win32/osd_console.cpp src/win32/osd_console.cpp
--- source/src/win32/osd_console.cpp	2022-04-09 10:35:00
+++ src/win32/osd_console.cpp	1970-01-01 09:00:00
@@ -1,388 +0,0 @@
-/*
-	Skelton for retropc emulator
-
-	Author : Takeda.Toshiya
-	Date   : 2015.11.26-
-
-	[ win32 console ]
-*/
-
-#include "osd.h"
-#include "../res/resource.h"
-
-void OSD::initialize_console()
-{
-	console_count = 0;
-	use_telnet = config.use_telnet;
-	telnet_closed = true;
-	svr_socket = cli_socket = INVALID_SOCKET;
-}
-
-void OSD::release_console()
-{
-	close_console();
-}
-
-BOOL WINAPI ctrl_c_handler(DWORD type)
-{
-	return TRUE;
-}
-
-void OSD::open_console(int width, int height, const _TCHAR* title)
-{
-	int console_width = (width > 0) ? width : 120;
-	int console_height = (height > 0) ? height : 30;
-	int buffer_height = 9001;
-	
-	if(console_count++ == 0) {
-		if(use_telnet) {
-			open_telnet(title);
-			return;
-		}
-		#define SET_RECT(rect, l, t, r, b) { \
-			rect.Left = l; \
-			rect.Top = t; \
-			rect.Right = r; \
-			rect.Bottom = b; \
-		}
-		CONSOLE_SCREEN_BUFFER_INFO csbi;
-		SMALL_RECT rect;
-		COORD coord;
-		
-		AllocConsole();
-		SetConsoleTitle(title);
-		SetConsoleCtrlHandler(ctrl_c_handler, TRUE);
-		RemoveMenu(GetSystemMenu(GetConsoleWindow(), FALSE), SC_CLOSE, MF_BYCOMMAND);
-		
-		hStdIn = GetStdHandle(STD_INPUT_HANDLE);
-		hStdOut = GetStdHandle(STD_OUTPUT_HANDLE);
-		GetConsoleScreenBufferInfo(hStdOut, &csbi);
-		
-		// window can't be bigger than buffer,
-		// buffer can't be smaller than window,
-		// so make a tiny window,
-		// set the required buffer,
-		// then set the required window
-		int min_width  = min(csbi.srWindow.Right - csbi.srWindow.Left + 1, console_width);
-		int min_height = min(csbi.srWindow.Bottom - csbi.srWindow.Top + 1, console_height);
-		
-		SET_RECT(rect, 0, csbi.srWindow.Top, min_width - 1, csbi.srWindow.Top + min_height - 1);
-		SetConsoleWindowInfo(hStdOut, TRUE, &rect);
-		
-		coord.X = console_width;
-		coord.Y = buffer_height;
-		SetConsoleScreenBufferSize(hStdOut, coord);
-		
-		SET_RECT(rect, 0, 0, console_width - 1, console_height - 1);
-		if(!SetConsoleWindowInfo(hStdOut, TRUE, &rect)) {
-			SetWindowPos(GetConsoleWindow(), NULL, 0, 0, 0, 0, SWP_NOSIZE | SWP_NOZORDER);
-			SetConsoleWindowInfo(hStdOut, TRUE, &rect);
-		}
-		SetConsoleTextAttribute(hStdOut, FOREGROUND_RED | FOREGROUND_GREEN | FOREGROUND_BLUE | FOREGROUND_INTENSITY);
-	}
-}
-
-void OSD::close_console()
-{
-	if(console_count > 0 && --console_count == 0) {
-		if(use_telnet) {
-			close_telnet();
-			return;
-		}
-		SetConsoleCtrlHandler(ctrl_c_handler, FALSE);
-		FreeConsole();
-	}
-}
-
-unsigned int OSD::get_console_code_page()
-{
-	return GetConsoleCP();
-}
-
-void OSD::set_console_text_attribute(unsigned short attr)
-{
-	unsigned short new_attr = 0;
-	
-	if(use_telnet) {
-		char buffer[32];
-		
-		if(attr & OSD_CONSOLE_BLUE     ) new_attr |= 4;
-		if(attr & OSD_CONSOLE_GREEN    ) new_attr |= 2;
-		if(attr & OSD_CONSOLE_RED      ) new_attr |= 1;
-		if(attr & OSD_CONSOLE_INTENSITY) new_attr |= 8;
-		
-		sprintf_s(buffer, 32, "\033[%dm\033[3%dm", (new_attr >> 3) & 1, (new_attr & 7));
-		send_telnet(buffer);
-		return;
-	}
-	if(attr & OSD_CONSOLE_BLUE     ) new_attr |= FOREGROUND_BLUE;
-	if(attr & OSD_CONSOLE_GREEN    ) new_attr |= FOREGROUND_GREEN;
-	if(attr & OSD_CONSOLE_RED      ) new_attr |= FOREGROUND_RED;
-	if(attr & OSD_CONSOLE_INTENSITY) new_attr |= FOREGROUND_INTENSITY;
-	
-	SetConsoleTextAttribute(hStdOut, attr);
-}
-
-void OSD::write_console(const _TCHAR* buffer, unsigned int length)
-{
-	if(use_telnet) {
-		send_telnet(tchar_to_char(buffer));
-		return;
-	}
-	DWORD dwWritten;
-	WriteConsole(hStdOut, buffer, length, &dwWritten, NULL);
-}
-
-int OSD::read_console_input(_TCHAR* buffer, unsigned int length)
-{
-	if(use_telnet) {
-		char temp[256];
-		int len = 0;
-		if(cli_socket != INVALID_SOCKET && (len = recv(cli_socket, temp, length, 0)) > 0) {
-			temp[len] = '\0';
-			const _TCHAR *temp_t = char_to_tchar(temp);
-			for(int i = 0; i < len; i++) {
-				buffer[i] = temp_t[i];
-			}
-			return len;
-		}
-		if(len == 0) {
-			telnet_closed = true;
-		}
-		return 0;
-	}
-	INPUT_RECORD ir[16];
-	DWORD dwRead;
-	unsigned int count = 0;
-	
-	if(ReadConsoleInput(hStdIn, ir, min(16, length), &dwRead)) {
-		for(unsigned int i = 0; i < dwRead; i++) {
-			if((ir[i].EventType & KEY_EVENT) && ir[i].Event.KeyEvent.bKeyDown) {
-#ifdef _UNICODE
-				if(ir[i].Event.KeyEvent.uChar.UnicodeChar) {
-					if(count < length) {
-						buffer[count++] = ir[i].Event.KeyEvent.uChar.UnicodeChar;
-					}
-#else
-				if(ir[i].Event.KeyEvent.uChar.AsciiChar) {
-					if(count < length) {
-						buffer[count++] = ir[i].Event.KeyEvent.uChar.AsciiChar;
-					}
-#endif
-				} else if(ir[i].Event.KeyEvent.wVirtualKeyCode >= 0x25 && ir[i].Event.KeyEvent.wVirtualKeyCode <= 0x28) {
-					static const _TCHAR cursor[] = {_T('D'), _T('A'), _T('C'), _T('B')}; // left, up, right, down
-					if(count + 2 < length) {
-						buffer[count++] = 0x1b;
-						buffer[count++] = 0x5b;
-						buffer[count++] = cursor[ir[i].Event.KeyEvent.wVirtualKeyCode - 0x25];
-					}
-				}
-			}
-		}
-	}
-	return count;
-}
-
-bool OSD::is_console_key_pressed(int vk)
-{
-	if(use_telnet) {
-		char temp[256];
-		int len = 0;
-		if(cli_socket != INVALID_SOCKET && (len = recv(cli_socket, temp, sizeof(temp), 0)) > 0) {
-			for(int i = 0; i < len; i++) {
-				if(temp[i] == vk) {
-					return true;
-				}
-			}
-		}
-		if(len == 0) {
-			telnet_closed = true;
-			return true;
-		}
-		return false;
-	}
-	HWND hWnd = GetForegroundWindow();
-	if(hWnd != NULL && hWnd == FindWindow(_T("ConsoleWindowClass"), NULL)) {
-		return ((GetAsyncKeyState(vk) & 0x8000) != 0);
-	}
-	return false;
-}
-
-bool OSD::is_console_closed()
-{
-	if(use_telnet) {
-		return telnet_closed;
-	}
-	return false;
-}
-
-void OSD::close_debugger_console()
-{
-	PostMessage(main_window_handle, WM_COMMAND, ID_CLOSE_DEBUGGER, 0L);
-}
-
-const _TCHAR *get_ttermpro_path()
-{
-	static _TCHAR path[MAX_PATH] = {0};
-	
-	if(_tgetenv(_T("ProgramFiles"))) {
-		my_stprintf_s(path, MAX_PATH, _T("%s\\teraterm\\ttermpro.exe"), _tgetenv(_T("ProgramFiles")));
-	}
-	return(path);
-}
-
-const _TCHAR *get_ttermpro_x86_path()
-{
-	static _TCHAR path[MAX_PATH] = {0};
-	
-	if(_tgetenv(_T("ProgramFiles(x86)"))) {
-		my_stprintf_s(path, MAX_PATH, _T("%s\\teraterm\\ttermpro.exe"), _tgetenv(_T("ProgramFiles(x86)")));
-	}
-	return(path);
-}
-
-const _TCHAR *get_putty_path()
-{
-	static _TCHAR path[MAX_PATH] = {0};
-	
-	if(_tgetenv(_T("ProgramFiles"))) {
-		my_stprintf_s(path, MAX_PATH, _T("%s\\PuTTY\\putty.exe"), _tgetenv(_T("ProgramFiles")));
-	}
-	return(path);
-}
-
-const _TCHAR *get_putty_x86_path()
-{
-	static _TCHAR path[MAX_PATH] = {0};
-	
-	if(_tgetenv(_T("ProgramFiles(x86)"))) {
-		my_stprintf_s(path, MAX_PATH, _T("%s\\PuTTY\\putty.exe"), _tgetenv(_T("ProgramFiles(x86)")));
-	}
-	return(path);
-}
-
-const _TCHAR *get_telnet_path()
-{
-	static _TCHAR path[MAX_PATH] = {0};
-	
-	if(_tgetenv(_T("windir")) != NULL) {
-#ifdef _WIN64
-		my_stprintf_s(path, MAX_PATH, _T("%s\\System32\\telnet.exe"), _tgetenv(_T("windir")));
-#else
-		// prevent System32 is redirected to SysWOW64 in 32bit process on Windows x64
-		my_stprintf_s(path, MAX_PATH, _T("%s\\Sysnative\\telnet.exe"), _tgetenv(_T("windir")));
-#endif
-	}
-	return(path);
-}
-
-const _TCHAR *get_telnet_x86_path()
-{
-	static _TCHAR path[MAX_PATH] = {0};
-	
-	if(_tgetenv(_T("windir")) != NULL) {
-#ifdef _WIN64
-		my_stprintf_s(path, MAX_PATH, _T("%s\\SysWOW64\\telnet.exe"), _tgetenv(_T("windir")));
-#else
-		// System32 will be redirected to SysWOW64 in 32bit process on Windows x64
-		my_stprintf_s(path, MAX_PATH, _T("%s\\System32\\telnet.exe"), _tgetenv(_T("windir")));
-#endif
-	}
-	return(path);
-}
-
-void OSD::open_telnet(const _TCHAR* title)
-{
-	WSADATA was_data;
-	struct sockaddr_in svr_addr;
-	struct sockaddr_in cli_addr;
-	int cli_addr_len = sizeof(cli_addr);
-	int port = 23;
-	int bind_stat = SOCKET_ERROR;
-	struct timeval timeout;
-	
-	WSAStartup(MAKEWORD(2,0), &was_data);
-	
-	if((svr_socket = socket(AF_INET, SOCK_STREAM, 0)) != INVALID_SOCKET) {
-		memset(&svr_addr, 0, sizeof(svr_addr));
-		svr_addr.sin_family = AF_INET;
-		svr_addr.sin_addr.s_addr = htonl(INADDR_ANY);
-		
-		while(port < 65536) {
-			svr_addr.sin_port = htons(port);
-			if((bind_stat = bind(svr_socket, (struct sockaddr *)&svr_addr, sizeof(svr_addr))) == 0) {
-				break;
-			} else {
-				port = (port == 23) ? 49152 : (port + 1);
-			}
-		}
-		if(bind_stat == 0) {
-			timeout.tv_sec = 1;
-			timeout.tv_usec = 0;
-			setsockopt(svr_socket, SOL_SOCKET, SO_RCVTIMEO, (char *)&timeout, sizeof(timeout));
-			
-			listen(svr_socket, 1);
-			
-			_TCHAR command[MAX_PATH] = {0};
-			STARTUPINFO si;
-			PROCESS_INFORMATION pi;
-			
-			if(_taccess(get_ttermpro_path(), 0) == 0) {
-				my_stprintf_s(command, MAX_PATH, _T("%s localhost:%d /T=1"), get_ttermpro_path(), port);
-			} else if(_taccess(get_ttermpro_x86_path(), 0) == 0) {
-				my_stprintf_s(command, MAX_PATH, _T("%s localhost:%d /T=1"), get_ttermpro_x86_path(), port);
-			} else if(_taccess(get_putty_path(), 0) == 0) {
-				my_stprintf_s(command, MAX_PATH, _T("%s -telnet localhost %d"), get_putty_path(), port);
-			} else if(_taccess(get_putty_x86_path(), 0) == 0) {
-				my_stprintf_s(command, MAX_PATH, _T("%s -telnet localhost %d"), get_putty_x86_path(), port);
-			} else if(_taccess(get_telnet_path(), 0) == 0) {
-				my_stprintf_s(command, MAX_PATH, _T("%s -t vt100 localhost %d"), get_telnet_path(), port);
-			} else if(_taccess(get_telnet_x86_path(), 0) == 0) {
-				my_stprintf_s(command, MAX_PATH, _T("%s -t vt100 localhost %d"), get_telnet_x86_path(), port);
-			}
-			if(command[0] != _T('\0')) {
-				memset(&si, 0, sizeof(STARTUPINFO));
-				memset(&pi, 0, sizeof(PROCESS_INFORMATION));
-				CreateProcess(NULL, command, NULL, NULL, FALSE, CREATE_NEW_CONSOLE, NULL, NULL, &si, &pi);
-			}
-			if((cli_socket = accept(svr_socket, (struct sockaddr *) &cli_addr, &cli_addr_len)) != INVALID_SOCKET) {
-				u_long val = 1;
-				ioctlsocket(cli_socket, FIONBIO, &val);
-				telnet_closed = false;
-#if 0
-				sprintf_s(command, MAX_PATH, "\033]0;%s\007", tchar_to_char(title));
-				send_telnet(command);
-#endif
-				uint8_t will_echo[] = {0xff, 0xfb, 0x01};
-				send(cli_socket, (char *)will_echo, 3, 0);
-				send_telnet("\033[2l");  // key unlock
-				send_telnet("\033[12h"); // local echo off
-			}
-		}
-	}
-}
-
-void OSD::close_telnet()
-{
-	if(svr_socket != INVALID_SOCKET) {
-		shutdown(svr_socket, /*SD_BOTH*/2);
-		closesocket(svr_socket);
-		svr_socket = cli_socket = INVALID_SOCKET;
-	}
-	WSACleanup();
-}
-
-void OSD::send_telnet(const char* string)
-{
-	if(cli_socket != INVALID_SOCKET) {
-		for(unsigned int i = 0; i < strlen(string); i++) {
-			if(string[i] == 0x0d || string[i] == 0x0a) {
-				send_telnet("\033E");
-			} else if(string[i] == 0x08) {
-				send_telnet("\033[1D");
-			} else {
-				send(cli_socket, &string[i], 1, 0);
-			}
-		}
-	}
-}
diff -ruN source/src/win32/osd_input.cpp src/win32/osd_input.cpp
--- source/src/win32/osd_input.cpp	2019-02-16 00:30:00
+++ src/win32/osd_input.cpp	1970-01-01 09:00:00
@@ -1,760 +0,0 @@
-/*
-	Skelton for retropc emulator
-
-	Author : Takeda.Toshiya
-	Date   : 2015.11.26-
-
-	[ win32 input ]
-*/
-
-#include "osd.h"
-#include "../fifo.h"
-
-static const uint8_t vk_dik[256] = {
-	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x0e, 0x0f, 0x00, 0x00, 0x00, 0x1c, 0x00, 0x00,
-	0x00, 0x00, 0x00, 0xc5, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x79, 0x7b, 0x00, 0x00,
-	0x39, 0xc9, 0xd1, 0xcf, 0xc7, 0xcb, 0xc8, 0xcd, 0xd0, 0x00, 0x00, 0x00, 0x00, 0xd2, 0xd3, 0x00,
-	0x0b, 0x02, 0x03, 0x04, 0x05, 0x06, 0x07, 0x08, 0x09, 0x0a, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
-	0x00, 0x1e, 0x30, 0x2e, 0x20, 0x12, 0x21, 0x22, 0x23, 0x17, 0x24, 0x25, 0x26, 0x32, 0x31, 0x18,
-	0x19, 0x10, 0x13, 0x1f, 0x14, 0x16, 0x2f, 0x11, 0x2d, 0x15, 0x2c, 0x00, 0x00, 0x00, 0x00, 0x00,
-#ifdef USE_NUMPAD_ENTER
-	0x52, 0x4f, 0x50, 0x51, 0x4b, 0x4c, 0x4d, 0x47, 0x48, 0x49, 0x37, 0x4e, 0x9c, 0x4a, 0x53, 0xb5,
-#else
-	0x52, 0x4f, 0x50, 0x51, 0x4b, 0x4c, 0x4d, 0x47, 0x48, 0x49, 0x37, 0x4e, 0x00, 0x4a, 0x53, 0xb5,
-#endif
-	0x3b, 0x3c, 0x3d, 0x3e, 0x3f, 0x40, 0x41, 0x42, 0x43, 0x44, 0x57, 0x58, 0x00, 0x00, 0x00, 0x00,
-	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
-	0x00, 0x46, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
-	DIK_LSHIFT, DIK_RSHIFT, DIK_LCONTROL, DIK_RCONTROL, DIK_LMENU, DIK_RMENU,
-	                                    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
-	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x92, 0x27, 0x33, 0x0c, 0x34, 0x35,
-	0x91, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
-	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x1a, 0x7d, 0x1b, 0x90, 0x00,
-	0x00, 0x00, 0x2b, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
-//	0x3a, 0x00, 0x70, 0x00, 0x94, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00	// caps, kana, kanji
-	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
-};
-
-#define get_joy_range(min_value, max_value, lo_value, hi_value) \
-{ \
-	uint64_t center = ((uint64_t)min_value + (uint64_t)max_value) / 2; \
-	lo_value = (DWORD)((center + (uint64_t)min_value) / 2); \
-	hi_value = (DWORD)((center + (uint64_t)max_value) / 2); \
-}
-
-void OSD::initialize_input()
-{
-	// initialize status
-	memset(key_status, 0, sizeof(key_status));
-#ifdef USE_JOYSTICK
-	memset(joy_status, 0, sizeof(joy_status));
-	memset(joy_to_key_status, 0, sizeof(joy_to_key_status));
-#endif
-#ifdef USE_MOUSE
-	memset(mouse_status, 0, sizeof(mouse_status));
-#endif
-	
-	// initialize direct input
-	dinput_key_available = false;
-	lpdi = NULL;
-	lpdikey = NULL;
-	
-	if(config.use_dinput) {
-#if DIRECTINPUT_VERSION >= 0x0800
-		if(SUCCEEDED(DirectInput8Create(instance_handle, DIRECTINPUT_VERSION, IID_IDirectInput8, (void**)&lpdi, NULL))) {
-#else
-		if(SUCCEEDED(DirectInputCreate(instance_handle, DIRECTINPUT_VERSION, &lpdi, NULL))) {
-#endif
-			if(SUCCEEDED(lpdi->CreateDevice(GUID_SysKeyboard, &lpdikey, NULL))) {
-				if(SUCCEEDED(lpdikey->SetDataFormat(&c_dfDIKeyboard))) {
-					if(SUCCEEDED(lpdikey->SetCooperativeLevel(main_window_handle, DISCL_FOREGROUND | DISCL_NONEXCLUSIVE))) {
-						lpdikey->Acquire();
-						dinput_key_available = true;
-						memset(key_dik_prev, 0, sizeof(key_dik_prev));
-					}
-				}
-			}
-		}
-	}
-	
-#ifdef USE_JOYSTICK
-	// initialize joysticks
-	joy_num = joyGetNumDevs();
-	for(int i = 0; i < joy_num && i < 4; i++) {
-		JOYCAPS joycaps;
-		if(joyGetDevCaps(i, &joycaps, sizeof(joycaps)) == JOYERR_NOERROR) {
-			joy_caps[i].wNumAxes = joycaps.wNumAxes;
-			if(joycaps.wNumAxes >= 1) {
-				get_joy_range(joycaps.wXmin, joycaps.wXmax, joy_caps[i].dwXposLo, joy_caps[i].dwXposHi);
-			}
-			if(joycaps.wNumAxes >= 1) {
-				get_joy_range(joycaps.wYmin, joycaps.wYmax, joy_caps[i].dwYposLo, joy_caps[i].dwYposHi);
-			}
-			if(joycaps.wNumAxes >= 1) {
-				get_joy_range(joycaps.wZmin, joycaps.wZmax, joy_caps[i].dwZposLo, joy_caps[i].dwZposHi);
-			}
-			if(joycaps.wNumAxes >= 1) {
-				get_joy_range(joycaps.wRmin, joycaps.wRmax, joy_caps[i].dwRposLo, joy_caps[i].dwRposHi);
-			}
-			if(joycaps.wNumAxes >= 1) {
-				get_joy_range(joycaps.wUmin, joycaps.wUmax, joy_caps[i].dwUposLo, joy_caps[i].dwUposHi);
-			}
-			if(joycaps.wNumAxes >= 1) {
-				get_joy_range(joycaps.wVmin, joycaps.wVmax, joy_caps[i].dwVposLo, joy_caps[i].dwVposHi);
-			}
-			joy_caps[i].dwButtonsMask = (1 << min(16, joycaps.wNumButtons)) - 1;
-		} else {
-			joy_caps[i].wNumAxes = 2; // 2axes
-			joy_caps[i].dwXposLo = joy_caps[i].dwYposLo = 0x3fff;
-			joy_caps[i].dwXposHi = joy_caps[i].dwYposHi = 0xbfff;
-			joy_caps[i].dwButtonsMask = 0x0f; // 4buttons
-		}
-	}
-#endif
-	
-#ifdef USE_MOUSE
-	// mouse emulation is disabled
-	mouse_enabled = false;
-#endif
-	
-	// initialize keycode convert table
-	FILEIO* fio = new FILEIO();
-	if(fio->Fopen(create_local_path(_T("keycode.cfg")), FILEIO_READ_BINARY)) {
-		fio->Fread(keycode_conv, sizeof(keycode_conv), 1);
-		fio->Fclose();
-	} else {
-		for(int i = 0; i < 256; i++) {
-			keycode_conv[i] = i;
-		}
-	}
-	delete fio;
-	
-	key_shift_pressed = key_shift_released = false;
-	key_caps_locked = ((GetAsyncKeyState(VK_CAPITAL) & 0x0001) != 0);
-	
-	lost_focus = false;
-}
-
-void OSD::release_input()
-{
-#ifdef USE_MOUSE
-	// release mouse
-	if(mouse_enabled) {
-		disable_mouse();
-	}
-#endif
-	
-	// release direct input
-	if(lpdi) {
-		if(lpdikey) {
-			lpdikey->Unacquire();
-			lpdikey->Release();
-			lpdikey = NULL;
-		}
-		lpdi->Release();
-		lpdi = NULL;
-	}
-}
-
-void OSD::update_input()
-{
-#ifdef USE_AUTO_KEY
-	if(!now_auto_key && !config.romaji_to_kana) {
-#endif
-		if(dinput_key_available) {
-			// direct input
-			memset(key_dik, 0, sizeof(key_dik));
-//			lpdikey->Acquire();
-			if(FAILED(lpdikey->GetDeviceState(256, key_dik))) {
-				lpdikey->Acquire();
-				lpdikey->GetDeviceState(256, key_dik);
-			}
-#if DIRECTINPUT_VERSION < 0x0800
-			// DIK_RSHIFT is not detected on Vista or later
-			if(vista_or_later) {
-				key_dik[DIK_RSHIFT] = (GetAsyncKeyState(VK_RSHIFT) & 0x8000) ? 0x80 : 0;
-			}
-#endif
-			// XXX: don't release shift key while numpad key is pressed
-			uint8_t numpad_keys;
-			numpad_keys  = key_dik[DIK_NUMPAD0];
-			numpad_keys |= key_dik[DIK_NUMPAD1];
-			numpad_keys |= key_dik[DIK_NUMPAD2];
-			numpad_keys |= key_dik[DIK_NUMPAD3];
-			numpad_keys |= key_dik[DIK_NUMPAD4];
-			numpad_keys |= key_dik[DIK_NUMPAD5];
-			numpad_keys |= key_dik[DIK_NUMPAD6];
-			numpad_keys |= key_dik[DIK_NUMPAD7];
-			numpad_keys |= key_dik[DIK_NUMPAD8];
-			numpad_keys |= key_dik[DIK_NUMPAD9];
-			if(numpad_keys & 0x80) {
-				key_dik[DIK_LSHIFT] |= key_dik_prev[DIK_LSHIFT];
-				key_dik[DIK_RSHIFT] |= key_dik_prev[DIK_RSHIFT];
-			}
-			key_dik[DIK_CIRCUMFLEX] |= key_dik[DIK_EQUALS     ];
-			key_dik[DIK_COLON     ] |= key_dik[DIK_APOSTROPHE ];
-			key_dik[DIK_YEN       ] |= key_dik[DIK_GRAVE      ];
-#ifndef USE_NUMPAD_ENTER
-			key_dik[DIK_RETURN    ] |= key_dik[DIK_NUMPADENTER];
-#endif
-			
-			for(int vk = 0; vk < 256; vk++) {
-				int dik = vk_dik[vk];
-				if(dik) {
-					if(key_dik[dik] & 0x80) {
-						if(!(key_dik_prev[dik] & 0x80)) {
-							key_down_native(vk, false);
-						}
-					} else {
-//						if(key_dik_prev[dik] & 0x80) {
-#ifdef USE_JOYSTICK
-						if(!joy_to_key_status[vk])
-#endif
-							key_up_native(vk);
-//						}
-					}
-				}
-			}
-			memcpy(key_dik_prev, key_dik, sizeof(key_dik_prev));
-		} else {
-			// update numpad key status
-			if(key_shift_pressed && !key_shift_released) {
-				if(key_status[VK_LSHIFT] == 0) {
-					// shift key is newly pressed
-					if(!key_status[VK_RSHIFT]) {
-						vm->key_down(VK_SHIFT, false);
-					}
-					vm->key_down(VK_LSHIFT, false);
-					key_status[VK_LSHIFT] = key_status[VK_SHIFT] = 0x80;
-				}
-			} else if(!key_shift_pressed && key_shift_released) {
-				if(key_status[VK_LSHIFT] != 0) {
-					// shift key is newly released
-					vm->key_up(VK_LSHIFT);
-					if(!key_status[VK_RSHIFT]) {
-						vm->key_up(VK_SHIFT);
-					}
-					key_status[VK_LSHIFT] = key_status[VK_SHIFT] = 0;
-				}
-			}
-			key_shift_pressed = key_shift_released = false;
-		}
-		
-		// update shift + caps lock
-		bool caps_locked = ((GetAsyncKeyState(VK_CAPITAL) & 0x0001) != 0);
-		if(key_caps_locked != caps_locked) {
-			key_down_native(0xf0, false);
-			key_caps_locked = caps_locked;
-		}
-#ifdef USE_AUTO_KEY
-	}
-#endif
-	
-	// release keys
-#ifdef USE_AUTO_KEY
-	if(lost_focus && !now_auto_key) {
-#else
-	if(lost_focus) {
-#endif
-		// we lost key focus so release all pressed keys
-		for(int i = 0; i < 256; i++) {
-			if(key_status[i] & 0x80) {
-				key_status[i] &= 0x7f;
-				if(!key_status[i]) {
-					vm->key_up(i);
-				}
-			}
-		}
-	} else {
-		for(int i = 0; i < 256; i++) {
-			if(key_status[i] & 0x7f) {
-				key_status[i] = (key_status[i] & 0x80) | ((key_status[i] & 0x7f) - 1);
-				if(!key_status[i]) {
-					vm->key_up(i);
-				}
-			}
-		}
-	}
-	lost_focus = false;
-	
-	// VK_$00 should be 0
-	key_status[0] = 0;
-	
-#ifdef USE_JOYSTICK
-	// update joystick status
-	memset(joy_status, 0, sizeof(joy_status));
-	
-	for(int i = 0; i < joy_num && i < 4; i++) {
-		JOYINFOEX joyinfo;
-		joyinfo.dwSize = sizeof(JOYINFOEX);
-		joyinfo.dwFlags = JOY_RETURNALL;
-		joy_status[i] = 0;
-		if(joyGetPosEx(i, &joyinfo) == JOYERR_NOERROR) {
-			if(joy_caps[i].wNumAxes >= 2) {
-				if(joyinfo.dwYpos < joy_caps[i].dwYposLo) joy_status[i] |= 0x00000001;	// up
-				if(joyinfo.dwYpos > joy_caps[i].dwYposHi) joy_status[i] |= 0x00000002;	// down
-			}
-			if(joy_caps[i].wNumAxes >= 1) {
-				if(joyinfo.dwXpos < joy_caps[i].dwXposLo) joy_status[i] |= 0x00000004;	// left
-				if(joyinfo.dwXpos > joy_caps[i].dwXposHi) joy_status[i] |= 0x00000008;	// right
-			}
-			if(joy_caps[i].wNumAxes >= 3) {
-				if(joyinfo.dwZpos < joy_caps[i].dwZposLo) joy_status[i] |= 0x00100000;
-				if(joyinfo.dwZpos > joy_caps[i].dwZposHi) joy_status[i] |= 0x00200000;
-			}
-			if(joy_caps[i].wNumAxes >= 4) {
-				if(joyinfo.dwRpos < joy_caps[i].dwRposLo) joy_status[i] |= 0x00400000;
-				if(joyinfo.dwRpos > joy_caps[i].dwRposHi) joy_status[i] |= 0x00800000;
-			}
-			if(joy_caps[i].wNumAxes >= 5) {
-				if(joyinfo.dwUpos < joy_caps[i].dwUposLo) joy_status[i] |= 0x01000000;
-				if(joyinfo.dwUpos > joy_caps[i].dwUposHi) joy_status[i] |= 0x02000000;
-			}
-			if(joy_caps[i].wNumAxes >= 6) {
-				if(joyinfo.dwVpos < joy_caps[i].dwVposLo) joy_status[i] |= 0x04000000;
-				if(joyinfo.dwVpos > joy_caps[i].dwVposHi) joy_status[i] |= 0x08000000;
-			}
-			if(joyinfo.dwPOV != 0xffff) {
-				static const uint32_t dir[8] = {
-					0x10000000 + 0x00000000,
-					0x10000000 + 0x20000000,
-					0x00000000 + 0x20000000,
-					0x40000000 + 0x20000000,
-					0x40000000 + 0x00000000,
-					0x40000000 + 0x80000000,
-					0x00000000 + 0x80000000,
-					0x10000000 + 0x80000000,
-				};
-				for(int j = 0; j < 9; j++) {
-					if(joyinfo.dwPOV < (DWORD)(2250 + 4500 * j)) {
-						joy_status[i] |= dir[j & 7];
-						break;
-					}
-				}
-			}
-			joy_status[i] |= ((joyinfo.dwButtons & joy_caps[i].dwButtonsMask) << 4);
-		}
-	}
-	if(config.use_joy_to_key) {
-		int status[256] = {0};
-		if(config.joy_to_key_type == 0) {
-			// cursor key
-			static const int vk[] = {VK_UP, VK_DOWN, VK_LEFT, VK_RIGHT};
-			for(int i = 0; i < 4; i++) {
-				if(joy_status[0] & (1 << i)) {
-					status[vk[i]] = 1;
-				}
-			}
-		} else if(config.joy_to_key_type == 1) {
-			// numpad key (4-directions)
-			static const int vk[] = {VK_NUMPAD8, VK_NUMPAD2, VK_NUMPAD4, VK_NUMPAD6};
-			for(int i = 0; i < 4; i++) {
-				if(joy_status[0] & (1 << i)) {
-					status[vk[i]] = 1;
-				}
-			}
-		} else if(config.joy_to_key_type == 2) {
-			// numpad key (8-directions)
-			switch(joy_status[0] & 0x0f) {
-			case 0x02 + 0x04: status[VK_NUMPAD1] = 1; break; // down-left
-			case 0x02       : status[VK_NUMPAD2] = 1; break; // down
-			case 0x02 + 0x08: status[VK_NUMPAD3] = 1; break; // down-right
-			case 0x00 + 0x04: status[VK_NUMPAD4] = 1; break; // left
-//			case 0x00       : status[VK_NUMPAD5] = 1; break;
-			case 0x00 + 0x08: status[VK_NUMPAD6] = 1; break; // right
-			case 0x01 + 0x04: status[VK_NUMPAD7] = 1; break; // up-left
-			case 0x01       : status[VK_NUMPAD8] = 1; break; // up
-			case 0x01 + 0x08: status[VK_NUMPAD9] = 1; break; // up-right
-			}
-		}
-		if(config.joy_to_key_type == 1 || config.joy_to_key_type == 2) {
-			// numpad key
-			if(config.joy_to_key_numpad5 && !(joy_status[0] & 0x0f)) {
-				status[VK_NUMPAD5] = 1;
-			}
-		}
-		for(int i = 0; i < 16; i++) {
-			if(joy_status[0] & (1 << (i + 4))) {
-				if(config.joy_to_key_buttons[i] < 0 && -config.joy_to_key_buttons[i] < 256) {
-					status[-config.joy_to_key_buttons[i]] = 1;
-				}
-			}
-		}
-		for(int i = 0; i < 256; i++) {
-			if(status[i]) {
-				if(!joy_to_key_status[i]) {
-					if(!(key_status[i] & 0x80)) {
-						key_down_native(i, false);
-						// do not keep key pressed
-						if(config.joy_to_key_numpad5 && (i >= VK_NUMPAD1 && i <= VK_NUMPAD9)) {
-							key_status[i] = KEY_KEEP_FRAMES;
-						}
-					}
-					joy_to_key_status[i] = true;
-				}
-			} else {
-				if(joy_to_key_status[i]) {
-					if(key_status[i]) {
-						key_up_native(i);
-					}
-					joy_to_key_status[i] = false;
-				}
-			}
-		}
-	}
-#endif
-	
-#ifdef USE_MOUSE
-	// update mouse status
-	memset(mouse_status, 0, sizeof(mouse_status));
-	
-	if(mouse_enabled) {
-		// get current status
-		POINT pt;
-		GetCursorPos(&pt);
-		ScreenToClient(main_window_handle, &pt);
-		mouse_status[0]  = pt.x - host_window_width / 2;
-		mouse_status[1]  = pt.y - host_window_height / 2;
-		mouse_status[2]  = (GetAsyncKeyState(VK_LBUTTON) & 0x8000) ? 1 : 0;
-		mouse_status[2] |= (GetAsyncKeyState(VK_RBUTTON) & 0x8000) ? 2 : 0;
-		mouse_status[2] |= (GetAsyncKeyState(VK_MBUTTON) & 0x8000) ? 4 : 0;
-		// move mouse cursor to the center of window
-		if(!(mouse_status[0] == 0 && mouse_status[1] == 0)) {
-			pt.x = host_window_width / 2;
-			pt.y = host_window_height / 2;
-			ClientToScreen(main_window_handle, &pt);
-			SetCursorPos(pt.x, pt.y);
-		}
-	}
-#endif
-}
-
-void OSD::key_down(int code, bool extended, bool repeat)
-{
-#ifdef USE_AUTO_KEY
-	if(!now_auto_key && !config.romaji_to_kana) {
-#endif
-		if(!dinput_key_available) {
-			if(code == VK_SHIFT) {
-				if(!(key_status[VK_RSHIFT] & 0x80) && (GetAsyncKeyState(VK_RSHIFT) & 0x8000)) {
-					key_down_native(VK_RSHIFT, repeat);
-				}
-				if(!(key_status[VK_LSHIFT] & 0x80) && (GetAsyncKeyState(VK_LSHIFT) & 0x8000)) {
-					code = VK_LSHIFT;
-				} else {
-					return;
-				}
-			} else if(code == VK_CONTROL) {
-				if(!(key_status[VK_RCONTROL] & 0x80) && (GetAsyncKeyState(VK_RCONTROL) & 0x8000)) {
-					key_down_native(VK_RCONTROL, repeat);
-				}
-				if(!(key_status[VK_LCONTROL] & 0x80) && (GetAsyncKeyState(VK_LCONTROL) & 0x8000)) {
-					code = VK_LCONTROL;
-				} else {
-					return;
-				}
-			} else if(code == VK_MENU) {
-				if(!(key_status[VK_RMENU] & 0x80) && (GetAsyncKeyState(VK_RMENU) & 0x8000)) {
-					key_down_native(VK_RMENU, repeat);
-				}
-				if(!(key_status[VK_LMENU] & 0x80) && (GetAsyncKeyState(VK_LMENU) & 0x8000)) {
-					code = VK_LMENU;
-				} else {
-					return;
-				}
-			}
-//			if(code == VK_LSHIFT || code == VK_RSHIFT) {
-			if(code == VK_LSHIFT) {
-				key_shift_pressed = true;
-				return;
-			}
-			if(!extended) {
-				switch(code) {
-				case VK_INSERT:
-					if(key_shift_pressed || key_shift_released || key_status[VK_NUMPAD0]) {
-						code = VK_NUMPAD0;
-						key_shift_pressed = true;
-					}
-					break;
-				case VK_END:
-					if(key_shift_pressed || key_shift_released || key_status[VK_NUMPAD1]) {
-						code = VK_NUMPAD1;
-						key_shift_pressed = true;
-					}
-					break;
-				case VK_DOWN:
-					if(key_shift_pressed || key_shift_released || key_status[VK_NUMPAD2]) {
-						code = VK_NUMPAD2;
-						key_shift_pressed = true;
-					}
-					break;
-				case VK_NEXT:
-					if(key_shift_pressed || key_shift_released || key_status[VK_NUMPAD3]) {
-						code = VK_NUMPAD3;
-						key_shift_pressed = true;
-					}
-					break;
-				case VK_LEFT:
-					if(key_shift_pressed || key_shift_released || key_status[VK_NUMPAD4]) {
-						code = VK_NUMPAD4;
-						key_shift_pressed = true;
-					}
-					break;
-				case VK_CLEAR:
-					if(key_shift_pressed || key_shift_released || key_status[VK_NUMPAD5]) {
-						code = VK_NUMPAD5;
-						key_shift_pressed = true;
-					}
-					break;
-				case VK_RIGHT:
-					if(key_shift_pressed || key_shift_released || key_status[VK_NUMPAD6]) {
-						code = VK_NUMPAD6;
-						key_shift_pressed = true;
-					}
-					break;
-				case VK_HOME:
-					if(key_shift_pressed || key_shift_released || key_status[VK_NUMPAD7]) {
-						code = VK_NUMPAD7;
-						key_shift_pressed = true;
-					}
-					break;
-				case VK_UP:
-					if(key_shift_pressed || key_shift_released || key_status[VK_NUMPAD8]) {
-						code = VK_NUMPAD8;
-						key_shift_pressed = true;
-					}
-					break;
-				case VK_PRIOR:
-					if(key_shift_pressed || key_shift_released || key_status[VK_NUMPAD9]) {
-						code = VK_NUMPAD9;
-						key_shift_pressed = true;
-					}
-					break;
-				}
-			}
-			key_down_native(code, repeat);
-		} else {
-			if(repeat || code == 0xf0 || code == 0xf1 || code == 0xf2 || code == 0xf3 || code == 0xf4) {
-				key_down_native(code, repeat);
-			}
-		}
-#ifdef USE_AUTO_KEY
-	}
-#endif
-}
-
-void OSD::key_up(int code, bool extended)
-{
-#ifdef USE_AUTO_KEY
-	if(!now_auto_key && !config.romaji_to_kana) {
-#endif
-		if(!dinput_key_available) {
-			if(code == VK_SHIFT) {
-				if((key_status[VK_RSHIFT] & 0x80) && !(GetAsyncKeyState(VK_RSHIFT) & 0x8000)) {
-					key_up_native(VK_RSHIFT);
-				}
-				if((key_status[VK_LSHIFT] & 0x80) && !(GetAsyncKeyState(VK_LSHIFT) & 0x8000)) {
-					code = VK_LSHIFT;
-				} else {
-					return;
-				}
-			} else if(code == VK_CONTROL) {
-				if((key_status[VK_RCONTROL] & 0x80) && !(GetAsyncKeyState(VK_RCONTROL) & 0x8000)) {
-					key_up_native(VK_RCONTROL);
-				}
-				if((key_status[VK_LCONTROL] & 0x80) && !(GetAsyncKeyState(VK_LCONTROL) & 0x8000)) {
-					code = VK_LCONTROL;
-				} else {
-					return;
-				}
-			} else if(code == VK_MENU) {
-				if((key_status[VK_RMENU] & 0x80) && !(GetAsyncKeyState(VK_RMENU) & 0x8000)) {
-					key_up_native(VK_RMENU);
-				}
-				if((key_status[VK_LMENU] & 0x80) && !(GetAsyncKeyState(VK_LMENU) & 0x8000)) {
-					code = VK_LMENU;
-				} else {
-					return;
-				}
-			}
-//			if(code == VK_LSHIFT || code == VK_RSHIFT) {
-			if(code == VK_LSHIFT) {
-				key_shift_pressed = false;
-				key_shift_released = true;
-				return;
-			}
-			if(!extended) {
-				switch(code) {
-				case VK_NUMPAD0: case VK_INSERT:
-					key_up_native(VK_NUMPAD0);
-					key_up_native(VK_INSERT);
-					return;
-				case VK_NUMPAD1: case VK_END:
-					key_up_native(VK_NUMPAD1);
-					key_up_native(VK_END);
-					return;
-				case VK_NUMPAD2: case VK_DOWN:
-					key_up_native(VK_NUMPAD2);
-					key_up_native(VK_DOWN);
-					return;
-				case VK_NUMPAD3: case VK_NEXT:
-					key_up_native(VK_NUMPAD3);
-					key_up_native(VK_NEXT);
-					return;
-				case VK_NUMPAD4: case VK_LEFT:
-					key_up_native(VK_NUMPAD4);
-					key_up_native(VK_LEFT);
-					return;
-				case VK_NUMPAD5: case VK_CLEAR:
-					key_up_native(VK_NUMPAD5);
-					key_up_native(VK_CLEAR);
-					return;
-				case VK_NUMPAD6: case VK_RIGHT:
-					key_up_native(VK_NUMPAD6);
-					key_up_native(VK_RIGHT);
-					return;
-				case VK_NUMPAD7: case VK_HOME:
-					key_up_native(VK_NUMPAD7);
-					key_up_native(VK_HOME);
-					return;
-				case VK_NUMPAD8: case VK_UP:
-					key_up_native(VK_NUMPAD8);
-					key_up_native(VK_UP);
-					return;
-				case VK_NUMPAD9: case VK_PRIOR:
-					key_up_native(VK_NUMPAD9);
-					key_up_native(VK_PRIOR);
-					return;
-				}
-			}
-			key_up_native(code);
-		}
-#ifdef USE_AUTO_KEY
-	}
-#endif
-}
-
-void OSD::key_down_native(int code, bool repeat)
-{
-	bool keep_frames = false;
-	
-	if(code == 0xf0) {
-		code = VK_CAPITAL;
-		keep_frames = true;
-	} else if(code == 0xf1 || code == 0xf2) {
-		code = VK_KANA;
-		keep_frames = true;
-	} else if(code == 0xf3 || code == 0xf4) {
-		code = VK_KANJI;
-		keep_frames = true;
-	}
-	if(!(code == VK_LSHIFT || code == VK_RSHIFT || code == VK_LCONTROL || code == VK_RCONTROL || code == VK_LMENU || code == VK_RMENU)) {
-		code = keycode_conv[code];
-	}
-	if(key_status[code] == 0 || keep_frames) {
-		repeat = false;
-	}
-#ifdef DONT_KEEEP_KEY_PRESSED
-	if(!(code == VK_LSHIFT || code == VK_RSHIFT || code == VK_LCONTROL || code == VK_RCONTROL || code == VK_LMENU || code == VK_RMENU)) {
-		key_status[code] = KEY_KEEP_FRAMES;
-	} else
-#endif
-	key_status[code] = keep_frames ? KEY_KEEP_FRAMES : 0x80;
-	
-	uint8_t prev_shift = key_status[VK_SHIFT];
-	uint8_t prev_control = key_status[VK_CONTROL];
-	uint8_t prev_menu = key_status[VK_MENU];
-	
-	key_status[VK_SHIFT] = key_status[VK_LSHIFT] | key_status[VK_RSHIFT];
-	key_status[VK_CONTROL] = key_status[VK_LCONTROL] | key_status[VK_RCONTROL];
-	key_status[VK_MENU] = key_status[VK_LMENU] | key_status[VK_RMENU];
-	
-	if(code == VK_LSHIFT || code == VK_RSHIFT) {
-		if(prev_shift == 0 && key_status[VK_SHIFT] != 0) {
-			vm->key_down(VK_SHIFT, repeat);
-		}
-	} else if(code == VK_LCONTROL|| code == VK_RCONTROL) {
-		if(prev_control == 0 && key_status[VK_CONTROL] != 0) {
-			vm->key_down(VK_CONTROL, repeat);
-		}
-	} else if(code == VK_LMENU|| code == VK_RMENU) {
-		if(prev_menu == 0 && key_status[VK_MENU] != 0) {
-			vm->key_down(VK_MENU, repeat);
-		}
-	}
-	vm->key_down(code, repeat);
-}
-
-void OSD::key_up_native(int code)
-{
-	if(!(code == VK_LSHIFT || code == VK_RSHIFT || code == VK_LCONTROL || code == VK_RCONTROL || code == VK_LMENU || code == VK_RMENU)) {
-		code = keycode_conv[code];
-	}
-	if(key_status[code] == 0) {
-		return;
-	}
-	if((key_status[code] &= 0x7f) != 0) {
-		return;
-	}
-	vm->key_up(code);
-	
-	uint8_t prev_shift = key_status[VK_SHIFT];
-	uint8_t prev_control = key_status[VK_CONTROL];
-	uint8_t prev_menu = key_status[VK_MENU];
-	
-	key_status[VK_SHIFT] = key_status[VK_LSHIFT] | key_status[VK_RSHIFT];
-	key_status[VK_CONTROL] = key_status[VK_LCONTROL] | key_status[VK_RCONTROL];
-	key_status[VK_MENU] = key_status[VK_LMENU] | key_status[VK_RMENU];
-	
-	if(code == VK_LSHIFT || code == VK_RSHIFT) {
-		if(prev_shift != 0 && key_status[VK_SHIFT] == 0) {
-			vm->key_up(VK_SHIFT);
-		}
-	} else if(code == VK_LCONTROL|| code == VK_RCONTROL) {
-		if(prev_control != 0 && key_status[VK_CONTROL] == 0) {
-			vm->key_up(VK_CONTROL);
-		}
-	} else if(code == VK_LMENU || code == VK_RMENU) {
-		if(prev_menu != 0 && key_status[VK_MENU] == 0) {
-			vm->key_up(VK_MENU);
-		}
-	}
-}
-
-#ifdef USE_MOUSE
-void OSD::enable_mouse()
-{
-	// enable mouse emulation
-	if(!mouse_enabled) {
-		// hide mouse cursor
-		ShowCursor(FALSE);
-		// move mouse cursor to the center of window
-		POINT pt;
-		pt.x = host_window_width / 2;
-		pt.y = host_window_height / 2;
-		ClientToScreen(main_window_handle, &pt);
-		SetCursorPos(pt.x, pt.y);
-	}
-	mouse_enabled = true;
-}
-
-void OSD::disable_mouse()
-{
-	// disable mouse emulation
-	if(mouse_enabled) {
-		ShowCursor(TRUE);
-	}
-	mouse_enabled = false;
-}
-
-void OSD::toggle_mouse()
-{
-	// toggle mouse enable / disable
-	if(mouse_enabled) {
-		disable_mouse();
-	} else {
-		enable_mouse();
-	}
-}
-#endif
-
diff -ruN source/src/win32/osd_midi.cpp src/win32/osd_midi.cpp
--- source/src/win32/osd_midi.cpp	2022-07-08 00:00:00
+++ src/win32/osd_midi.cpp	1970-01-01 09:00:00
@@ -1,175 +0,0 @@
-/*
-	Skelton for retropc emulator
-
-	Author : Takeda.Toshiya
-	Date   : 2022.07.03-
-
-	[ win32 midi ]
-*/
-
-#include "osd.h"
-#include "../fifo.h"
-
-CRITICAL_SECTION send_cs;
-CRITICAL_SECTION recv_cs;
-
-unsigned __stdcall midi_thread(void *lpx)
-{
-	volatile midi_thread_params_t *p = (midi_thread_params_t *)lpx;
-	int midi_out_initialized = -1;
-	HMIDIOUT hMidi = NULL;
-	
-	while(!p->terminate) {
-		while(true) {
-			uint8_t buffer[128];
-			int length = 0;
-			
-			EnterCriticalSection(&send_cs);
-			if(!p->send_buffer->empty()) {
-				uint8_t msg = p->send_buffer->read_not_remove(0);
-				
-				switch(msg & 0xf0) {
-				case 0x80: case 0x90: case 0xa0: case 0xb0: case 0xe0:
-					length = 3;
-					break;
-				case 0xc0:
-				case 0xd0:
-					length = 2;
-					break;
-				case 0xf0:
-					switch(msg) {
-					case 0xf0:
-						// system exclusive
-						for(int i = 1; i < p->send_buffer->count(); i++) {
-							if(p->send_buffer->read_not_remove(i) == 0xf7) {
-								length = i + 1;
-								break;
-							}
-						}
-						break;
-					case 0xf1: case 0xf3:
-						length = 2;
-						break;
-					case 0xf2:
-						length = 3;
-						break;
-					case 0xf6: case 0xf8: case 0xfa: case 0xfb: case 0xfc: case 0xfe: case 0xff:
-						length = 1;
-						break;
-					default:
-						// undefined msg
-						p->send_buffer->read();
-						break;
-					}
-					break;
-				default:
-					// invalid msg
-					p->send_buffer->read();
-					break;
-				}
-				if(p->send_buffer->count() >= length) {
-					for(int i = 0; i < length; i++) {
-						buffer[i] = p->send_buffer->read();
-					}
-				} else {
-					length = 0;
-				}
-			}
-			LeaveCriticalSection(&send_cs);
-			
-			if(length > 0) {
-				if(midi_out_initialized == -1) {
-					if(midiOutOpen(&hMidi, MIDI_MAPPER, NULL, NULL, CALLBACK_NULL) == MMSYSERR_NOERROR) {
-						midi_out_initialized = 1;
-					} else {
-						midi_out_initialized = 0;
-					}
-				}
-				if(midi_out_initialized == 1) {
-					if(buffer[0] == 0xf0) {
-						// system exclusive
-						MIDIHDR mhMidi;
-						
-						ZeroMemory(&mhMidi, sizeof(mhMidi));
-						mhMidi.lpData = (LPSTR)buffer;
-						mhMidi.dwBufferLength = length;
-						mhMidi.dwBytesRecorded = length;
-						midiOutPrepareHeader(hMidi, &mhMidi, sizeof(mhMidi));
-						midiOutLongMsg(hMidi, &mhMidi, sizeof(mhMidi));
-						while(!(mhMidi.dwFlags & MHDR_DONE)) {
-							Sleep(10);
-						}
-						midiOutUnprepareHeader(hMidi, &mhMidi, sizeof(mhMidi));
-					} else {
-						union UNION_MIDI_DATA {
-							DWORD msg;
-							BYTE data[4];
-						};
-						UNION_MIDI_DATA out;
-						
-						for(int i = 0; i < 4; i++) {
-							out.data[i] = (i < length) ? buffer[i] : 0;
-						}
-						midiOutShortMsg(hMidi,out.msg);
-					}
-				}
-			} else {
-				break;
-			}
-		}
-		Sleep(0);
-	}
-	if(midi_out_initialized == 1) {
-		midiOutClose(hMidi);
-	}
-	_endthreadex(0);
-	return 0;
-}
-
-void OSD::initialize_midi()
-{
-	midi_thread_params.send_buffer = new FIFO(1024);
-	midi_thread_params.recv_buffer = new FIFO(1024);
-	midi_thread_params.terminate = false;
-	
-	InitializeCriticalSection(&send_cs);
-	InitializeCriticalSection(&recv_cs);
-	hMidiThread = (HANDLE)_beginthreadex(NULL, 0, midi_thread, &midi_thread_params, 0, NULL);
-}
-
-void OSD::release_midi()
-{
-	if(hMidiThread) {
-		midi_thread_params.terminate = true;
-		WaitForSingleObject(hMidiThread, INFINITE);
-		hMidiThread = NULL;
-	}
-	DeleteCriticalSection(&send_cs);
-	DeleteCriticalSection(&recv_cs);
-	
-	midi_thread_params.send_buffer->release();
-	delete midi_thread_params.send_buffer;
-	midi_thread_params.send_buffer = NULL;
-	midi_thread_params.recv_buffer->release();
-	delete midi_thread_params.recv_buffer;
-	midi_thread_params.recv_buffer = NULL;
-}
-
-void OSD::send_to_midi(uint8_t data)
-{
-	EnterCriticalSection(&send_cs);
-	midi_thread_params.send_buffer->write(data);
-	LeaveCriticalSection(&send_cs);
-}
-
-bool OSD::recv_from_midi(uint8_t *data)
-{
-	bool result = false;
-	EnterCriticalSection(&recv_cs);
-	if(!midi_thread_params.recv_buffer->empty()) {
-		*data = (uint8_t)midi_thread_params.recv_buffer->read();
-		result = true;
-	}
-	LeaveCriticalSection(&recv_cs);
-	return result;
-}
diff -ruN source/src/win32/osd_screen.cpp src/win32/osd_screen.cpp
--- source/src/win32/osd_screen.cpp	2022-04-05 20:50:00
+++ src/win32/osd_screen.cpp	1970-01-01 09:00:00
@@ -1,1754 +0,0 @@
-/*
-	Skelton for retropc emulator
-
-	Author : Takeda.Toshiya
-	Date   : 2015.11.20-
-
-	[ win32 screen ]
-*/
-
-#include "osd.h"
-
-#ifdef _UNITY
-#include "..\winplugin\emuwrap.h"
-extern emuwrap g_emucore;
-#endif
-
-#define REC_VIDEO_SUCCESS	1
-#define REC_VIDEO_FULL		2
-#define REC_VIDEO_ERROR		3
-
-void OSD::initialize_screen()
-{
-	host_window_width = WINDOW_WIDTH;
-	host_window_height = WINDOW_HEIGHT;
-	host_window_mode = true;
-	
-	vm_screen_width = SCREEN_WIDTH;
-	vm_screen_height = SCREEN_HEIGHT;
-	vm_window_width = WINDOW_WIDTH;
-	vm_window_height = WINDOW_HEIGHT;
-	vm_window_width_aspect = WINDOW_WIDTH_ASPECT;
-	vm_window_height_aspect = WINDOW_HEIGHT_ASPECT;
-	
-	memset(&vm_screen_buffer, 0, sizeof(bitmap_t));
-#ifdef USE_SCREEN_FILTER
-	memset(&filtered_screen_buffer, 0, sizeof(bitmap_t));
-	memset(&tmp_filtered_screen_buffer, 0, sizeof(bitmap_t));
-#endif
-//#ifdef USE_SCREEN_ROTATE
-	memset(&rotated_screen_buffer, 0, sizeof(bitmap_t));
-//#endif
-	memset(&stretched_screen_buffer, 0, sizeof(bitmap_t));
-	memset(&shrinked_screen_buffer, 0, sizeof(bitmap_t));
-	memset(&reversed_screen_buffer, 0, sizeof(bitmap_t));
-	memset(&video_screen_buffer, 0, sizeof(bitmap_t));
-	
-#ifdef SUPPORT_D2D1
-	pD2d1Factory = NULL;
-	pD2d1DCRenderTarget = NULL;
-	pD2d1HwndRenderTarget = NULL;
-	pD2d1Bitmap = NULL;
-#endif
-#ifdef SUPPORT_D3D9
-	lpd3d9 = NULL;
-	lpd3d9Device = NULL;
-	lpd3d9Surface = NULL;
-	lpd3d9OffscreenSurface = NULL;
-	d3d9_device_lost = false;
-#endif
-	now_record_video = false;
-	pAVIStream = NULL;
-	pAVICompressed = NULL;
-	pAVIFile = NULL;
-	
-	first_draw_screen = false;
-	first_invalidate = true;
-	self_invalidate = false;
-}
-
-void OSD::release_screen()
-{
-	stop_record_video();
-	
-#ifdef SUPPORT_D2D1
-	release_d2d1();
-#endif
-#ifdef SUPPORT_D3D9
-	release_d3d9();
-#endif
-	release_screen_buffer(&vm_screen_buffer);
-#ifdef USE_SCREEN_FILTER
-	release_screen_buffer(&filtered_screen_buffer);
-	release_screen_buffer(&tmp_filtered_screen_buffer);
-#endif
-//#ifdef USE_SCREEN_ROTATE
-	release_screen_buffer(&rotated_screen_buffer);
-//#endif
-	release_screen_buffer(&stretched_screen_buffer);
-	release_screen_buffer(&shrinked_screen_buffer);
-	release_screen_buffer(&reversed_screen_buffer);
-	release_screen_buffer(&video_screen_buffer);
-}
-
-double OSD::get_window_mode_power(int mode)
-{
-	if(mode + WINDOW_MODE_BASE == 2) {
-		return 1.5;
-	} else if(mode + WINDOW_MODE_BASE > 2) {
-		return mode + WINDOW_MODE_BASE - 1;
-	}
-	return mode + WINDOW_MODE_BASE;
-}
-
-int OSD::get_window_mode_width(int mode)
-{
-//#ifdef USE_SCREEN_ROTATE
-	if(config.rotate_type == 1 || config.rotate_type == 3) {
-		return (int)((config.window_stretch_type == 0 ? vm_window_height : vm_window_height_aspect) * get_window_mode_power(mode));
-	}
-//#endif
-	return (int)((config.window_stretch_type == 0 ? vm_window_width : vm_window_width_aspect) * get_window_mode_power(mode));
-}
-
-int OSD::get_window_mode_height(int mode)
-{
-//#ifdef USE_SCREEN_ROTATE
-	if(config.rotate_type == 1 || config.rotate_type == 3) {
-		return (int)((config.window_stretch_type == 0 ? vm_window_width : vm_window_width_aspect) * get_window_mode_power(mode));
-	}
-//#endif
-	return (int)((config.window_stretch_type == 0 ? vm_window_height : vm_window_height_aspect) * get_window_mode_power(mode));
-}
-
-void OSD::set_host_window_size(int window_width, int window_height, bool window_mode)
-{
-	if(window_width != -1) {
-		host_window_width = window_width;
-	}
-	if(window_height != -1) {
-		host_window_height = window_height;
-	}
-	host_window_mode = window_mode;
-	
-	first_draw_screen = false;
-	first_invalidate = true;
-}
-
-void OSD::set_vm_screen_size(int screen_width, int screen_height, int window_width, int window_height, int window_width_aspect, int window_height_aspect)
-{
-	if(vm_screen_width != screen_width || vm_screen_height != screen_height) {
-		if(window_width == -1) {
-			window_width = screen_width;
-		}
-		if(window_height == -1) {
-			window_height = screen_height;
-		}
-		if(window_width_aspect == -1) {
-			window_width_aspect = window_width;
-		}
-		if(window_height_aspect == -1) {
-			window_height_aspect = window_height;
-		}
-		vm_screen_width = screen_width;
-		vm_screen_height = screen_height;
-		
-		if(vm_window_width != window_width || vm_window_height != window_height || vm_window_width_aspect != window_width_aspect || vm_window_height_aspect != window_height_aspect) {
-			vm_window_width = window_width;
-			vm_window_height = window_height;
-			vm_window_width_aspect = window_width_aspect;
-			vm_window_height_aspect = window_height_aspect;
-			
-#ifndef _UNITY		// MARU
-			// change the window size
-			PostMessage(main_window_handle, WM_RESIZE, 0L, 0L);
-#endif
-		} else {
-			// to make sure
-			set_host_window_size(-1, -1, host_window_mode);
-		}
-	}
-	if(vm_screen_buffer.width != vm_screen_width || vm_screen_buffer.height != vm_screen_height) {
-		if(now_record_video) {
-			stop_record_video();
-//			stop_record_sound();
-		}
-		initialize_screen_buffer(&vm_screen_buffer, vm_screen_width, vm_screen_height, COLORONCOLOR);
-	}
-}
-
-void OSD::set_vm_screen_lines(int lines)
-{
-//	set_vm_screen_size(vm_screen_width, lines, vm_window_width, vm_window_height, vm_window_width_aspect, vm_screen_height);
-}
-
-scrntype_t* OSD::get_vm_screen_buffer(int y)
-{
-	return vm_screen_buffer.get_buffer(y);
-}
-
-int OSD::draw_screen()
-{
-	// check avi file recording timing
-	if(now_record_video && rec_video_run_frames <= 0) {
-		return 0;
-	}
-	
-	// draw screen
-	if(vm_screen_buffer.width != vm_screen_width || vm_screen_buffer.height != vm_screen_height) {
-		if(now_record_video) {
-			stop_record_video();
-//			stop_record_sound();
-		}
-		initialize_screen_buffer(&vm_screen_buffer, vm_screen_width, vm_screen_height, COLORONCOLOR);
-	}
-#ifdef USE_SCREEN_FILTER
-	screen_skip_line = false;
-#endif
-	vm->draw_screen();
-	
-#ifndef ONE_BOARD_MICRO_COMPUTER
-	// screen size was changed in vm->draw_screen()
-	if(vm_screen_buffer.width != vm_screen_width || vm_screen_buffer.height != vm_screen_height) {
-		return 0;
-	}
-	draw_screen_buffer = &vm_screen_buffer;
-	
-	// calculate screen size
-//#ifdef USE_SCREEN_ROTATE
-	int tmp_width_aspect = (config.rotate_type == 1 || config.rotate_type == 3) ? vm_window_height_aspect : vm_window_width_aspect;
-	int tmp_height_aspect = (config.rotate_type == 1 || config.rotate_type == 3) ? vm_window_width_aspect : vm_window_height_aspect;
-	int tmp_width = (config.rotate_type == 1 || config.rotate_type == 3) ? vm_window_height : vm_window_width;
-	int tmp_height = (config.rotate_type == 1 || config.rotate_type == 3) ? vm_window_width : vm_window_height;
-//#else
-//	#define tmp_width_aspect vm_window_width_aspect
-//	#define tmp_height_aspect vm_window_height_aspect
-//	#define tmp_width vm_window_width
-//	#define tmp_height vm_window_height
-//#endif
-	
-	if(host_window_mode) {
-		// window mode
-		draw_screen_width = host_window_width;
-		draw_screen_height = host_window_height;
-	} else {
-		// fullscreen mode
-		if(config.fullscreen_stretch_type == 0) {
-			// dot by dot
-			int tmp_pow_x = host_window_width / tmp_width;
-			int tmp_pow_y = host_window_height / tmp_height;
-			int tmp_pow = 1;
-			if(tmp_pow_y >= tmp_pow_x && tmp_pow_x > 1) {
-				tmp_pow = tmp_pow_x;
-			} else if(tmp_pow_x >= tmp_pow_y && tmp_pow_y > 1) {
-				tmp_pow = tmp_pow_y;
-			}
-			draw_screen_width = tmp_width * tmp_pow;
-			draw_screen_height = tmp_height * tmp_pow;
-		} else if(config.fullscreen_stretch_type == 1) {
-			// stretch (no aspect)
-			draw_screen_width = (host_window_height * tmp_width) / tmp_height;
-			draw_screen_height = host_window_height;
-			if(draw_screen_width > host_window_width) {
-				draw_screen_width = host_window_width;
-				draw_screen_height = (host_window_width * tmp_height) / tmp_width;
-			}
-		} else if(config.fullscreen_stretch_type == 2) {
-			// stretch (aspect)
-			draw_screen_width = (host_window_height * tmp_width_aspect) / tmp_height_aspect;
-			draw_screen_height = host_window_height;
-			if(draw_screen_width > host_window_width) {
-				draw_screen_width = host_window_width;
-				draw_screen_height = (host_window_width * tmp_height_aspect) / tmp_width_aspect;
-			}
-		} else if(config.fullscreen_stretch_type == 3) {
-			// stretch (fill)
-			draw_screen_width = host_window_width;
-			draw_screen_height = host_window_height;
-		}
-	}
-	int dest_pow_x = (int)ceil((double)draw_screen_width / (double)tmp_width);
-	int dest_pow_y = (int)ceil((double)draw_screen_height / (double)tmp_height);
-//#ifdef USE_SCREEN_ROTATE
-	int tmp_pow_x = (config.rotate_type == 1 || config.rotate_type == 3) ? dest_pow_y : dest_pow_x;
-	int tmp_pow_y = (config.rotate_type == 1 || config.rotate_type == 3) ? dest_pow_x : dest_pow_y;
-//#else
-//	#define tmp_pow_x dest_pow_x
-//	#define tmp_pow_y dest_pow_y
-//#endif
-	
-#ifdef USE_SCREEN_FILTER
-	// apply crt filter
-	if(config.filter_type == SCREEN_FILTER_RGB) {
-		if(filtered_screen_buffer.width != vm_screen_width * tmp_pow_x || filtered_screen_buffer.height != vm_screen_height * tmp_pow_y) {
-			initialize_screen_buffer(&filtered_screen_buffer, vm_screen_width * tmp_pow_x, vm_screen_height * tmp_pow_y, COLORONCOLOR);
-		}
-		apply_rgb_filter_to_screen_buffer(draw_screen_buffer, &filtered_screen_buffer);
-		draw_screen_buffer = &filtered_screen_buffer;
-	} else if(config.filter_type == SCREEN_FILTER_RF) {
-		// FIXME
-	}
-#endif
-//#ifdef USE_SCREEN_ROTATE
-	// rotate screen
-	if(config.rotate_type == 1 || config.rotate_type == 3) {
-		if(rotated_screen_buffer.width != draw_screen_buffer->height || rotated_screen_buffer.height != draw_screen_buffer->width) {
-			initialize_screen_buffer(&rotated_screen_buffer, draw_screen_buffer->height, draw_screen_buffer->width, COLORONCOLOR);
-		}
-		rotate_screen_buffer(draw_screen_buffer, &rotated_screen_buffer);
-		draw_screen_buffer = &rotated_screen_buffer;
-	} else if(config.rotate_type == 2) {
-		if(rotated_screen_buffer.width != draw_screen_buffer->width || rotated_screen_buffer.height != draw_screen_buffer->height) {
-			initialize_screen_buffer(&rotated_screen_buffer, draw_screen_buffer->width, draw_screen_buffer->height, COLORONCOLOR);
-		}
-		rotate_screen_buffer(draw_screen_buffer, &rotated_screen_buffer);
-		draw_screen_buffer = &rotated_screen_buffer;
-	}
-//#endif
-	// stretch screen
-	if(draw_screen_buffer->width != tmp_width * dest_pow_x || draw_screen_buffer->height != tmp_height * dest_pow_y) {
-		if(stretched_screen_buffer.width != tmp_width * dest_pow_x || stretched_screen_buffer.height != tmp_height * dest_pow_y) {
-			initialize_screen_buffer(&stretched_screen_buffer, tmp_width * dest_pow_x, tmp_height * dest_pow_y, COLORONCOLOR);
-		}
-		stretch_screen_buffer(draw_screen_buffer, &stretched_screen_buffer);
-		draw_screen_buffer = &stretched_screen_buffer;
-	}
-	
-	// initialize d2d1/d3d9 surface
-#ifdef SUPPORT_D2D1
-	static bool prev_use_d2d1 = config.use_d2d1;
-	static bool prev_use_dcrender = (host_window_mode && config.show_status_bar);
-#endif
-#ifdef SUPPORT_D3D9
-	static bool prev_use_d3d9 = config.use_d3d9;
-	static bool prev_wait_vsync = config.wait_vsync;
-#endif
-	static int prev_window_width = 0, prev_window_height = 0;
-	static int prev_screen_width = 0, prev_screen_height = 0;
-	
-	if(
-#ifdef SUPPORT_D2D1
-		prev_use_d2d1 != config.use_d2d1 || prev_use_dcrender != (host_window_mode && config.show_status_bar) ||
-#endif
-#ifdef SUPPORT_D3D9
-		prev_use_d3d9 != config.use_d3d9 || prev_wait_vsync != config.wait_vsync || (prev_use_d3d9 && d3d9_device_lost) ||
-#endif
-		prev_window_width != host_window_width || prev_window_height != host_window_height
-	) {
-#ifdef SUPPORT_D2D1
-		if(config.use_d2d1) {
-			config.use_d2d1 = initialize_d2d1();
-		} else {
-			release_d2d1();
-		}
-		prev_use_d2d1 = config.use_d2d1;
-		prev_use_dcrender = (host_window_mode && config.show_status_bar);
-#endif
-#ifdef SUPPORT_D3D9
-		if(config.use_d3d9) {
-			config.use_d3d9 = initialize_d3d9();
-		} else {
-			release_d3d9();
-		}
-		d3d9_device_lost = false;
-		prev_use_d3d9 = config.use_d3d9;
-		prev_wait_vsync = config.wait_vsync;
-#endif
-		prev_window_width = host_window_width;
-		prev_window_height = host_window_height;
-		prev_screen_width = prev_screen_height = 0;
-	}
-	if(prev_screen_width != draw_screen_buffer->width || prev_screen_height != draw_screen_buffer->height) {
-#ifdef SUPPORT_D2D1
-		if(config.use_d2d1) {
-			config.use_d2d1 = initialize_d2d1_surface(draw_screen_buffer);
-		}
-#endif
-#ifdef SUPPORT_D3D9
-		if(config.use_d3d9) {
-			config.use_d3d9 = initialize_d3d9_surface(draw_screen_buffer);
-		}
-#endif
-		prev_screen_width = draw_screen_buffer->width;
-		prev_screen_height = draw_screen_buffer->height;
-	}
-	
-#ifdef SUPPORT_D2D1
-	if(config.use_d2d1) {
-		// copy screen to d2d1 offscreen surface
-		copy_to_d2d1_surface(draw_screen_buffer);
-	} else
-#endif
-#ifdef SUPPORT_D3D9
-	if(config.use_d3d9) {
-		// copy screen to d3d9 offscreen surface
-		copy_to_d3d9_surface(draw_screen_buffer);
-	} else
-#endif
-	{
-		if(draw_screen_buffer->width != draw_screen_width || draw_screen_buffer->height != draw_screen_height) {
-			if(shrinked_screen_buffer.width != draw_screen_width || shrinked_screen_buffer.height != draw_screen_height) {
-				initialize_screen_buffer(&shrinked_screen_buffer, draw_screen_width, draw_screen_height, HALFTONE);
-			}
-			stretch_screen_buffer(draw_screen_buffer, &shrinked_screen_buffer);
-			draw_screen_buffer = &shrinked_screen_buffer;
-		}
-	}
-#endif
-	
-#ifndef _UNITY
-	// MARU: Ç±Ç±Ç™é¿éøìIÇ»ÉEÉBÉìÉhÉEï`âÊÅH
-	// invalidate window
-#ifdef ONE_BOARD_MICRO_COMPUTER
-	if(first_invalidate) {
-//		InvalidateRect(main_window_handle, NULL, TRUE);
-		RECT rect = { 0, 0, host_window_width, host_window_height };
-		InvalidateRect(main_window_handle, &rect, TRUE);
-	} else {
-#ifdef MAX_DRAW_RANGES
-		for(int i = 0; i < MAX_DRAW_RANGES; i++) {
-#else
-		for(int i = 0; i < vm->max_draw_ranges(); i++) { // for TK-80BS
-#endif
-			int x = vm_ranges[i].x;
-			int y = vm_ranges[i].y;
-			int w = vm_ranges[i].width;
-			int h = vm_ranges[i].height;
-			RECT rect = { x, y, x + w, y + h };
-			InvalidateRect(main_window_handle, &rect, FALSE);
-		}
-	}
-#else
-//	InvalidateRect(main_window_handle, NULL, first_invalidate);
-	RECT rect = { 0, 0, host_window_width, host_window_height };
-	InvalidateRect(main_window_handle, &rect, first_invalidate);
-#endif
-	UpdateWindow(main_window_handle);
-#endif
-	first_draw_screen = self_invalidate = true;
-	
-	// record avi file
-	if(now_record_video) {
-		return add_video_frames();
-	} else {
-		return 1;
-	}
-}
-
-void OSD::invalidate_screen()
-{
-#ifndef _UNITY
-//	InvalidateRect(main_window_handle, NULL, TRUE);
-	RECT rect = { 0, 0, host_window_width, host_window_height };
-	InvalidateRect(main_window_handle, &rect, TRUE);
-#endif
-}
-
-void OSD::update_screen(HDC hdc)
-{
-#ifdef ONE_BOARD_MICRO_COMPUTER
-#ifndef BITMAP_OFFSET_X
-#define BITMAP_OFFSET_X 0
-#endif
-#ifndef BITMAP_OFFSET_Y
-#define BITMAP_OFFSET_Y 0
-#endif
-	if(first_invalidate || !self_invalidate) {
-#if 1
-		// load png from resource
-		HRSRC hResource = FindResource(instance_handle, _T("IDI_BITMAP_BOARD"), _T("IMAGE"));
-		if(hResource != NULL) {
-			const void* pResourceData = LockResource(LoadResource(instance_handle, hResource));
-			if(pResourceData != NULL) {
-				DWORD dwResourceSize = SizeofResource(instance_handle, hResource);
-				HGLOBAL hResourceBuffer = GlobalAlloc(GMEM_MOVEABLE, dwResourceSize);
-				if(hResourceBuffer != NULL) {
-					void* pResourceBuffer = GlobalLock(hResourceBuffer);
-					if(pResourceBuffer != NULL) {
-						CopyMemory(pResourceBuffer, pResourceData, dwResourceSize);
-						IStream* pIStream = NULL;
-						if(CreateStreamOnHGlobal(hResourceBuffer, FALSE, &pIStream) == S_OK) {
-							Gdiplus::Bitmap *pBitmap = Gdiplus::Bitmap::FromStream(pIStream);
-							if(pBitmap != NULL) {
-								Gdiplus::Graphics graphics(hdc);
-								graphics.DrawImage(pBitmap, BITMAP_OFFSET_X, BITMAP_OFFSET_Y);
-								delete pBitmap;
-							}
-						}
-					}
-					GlobalUnlock(hResourceBuffer);
-				}
-				GlobalFree(hResourceBuffer);
-			}
-		}
-#else
-		// load bitmap from resource
-		HDC hmdc = CreateCompatibleDC(hdc);
-		HBITMAP hBitmap = LoadBitmap(instance_handle, _T("IDI_BITMAP_BOARD"));
-		BITMAP bmp;
-		GetObject(hBitmap, sizeof(BITMAP), &bmp);
-		int w = (int)bmp.bmWidth;
-		int h = (int)bmp.bmHeight;
-		HBITMAP hOldBitmap = (HBITMAP)SelectObject(hmdc, hBitmap);
-		BitBlt(hdc, BITMAP_OFFSET_X, BITMAP_OFFSET_Y, w, h, hmdc, 0, 0, SRCCOPY);
-		SelectObject(hmdc, hOldBitmap);
-		DeleteObject(hBitmap);
-		DeleteDC(hmdc);
-#endif
-	}
-	if(first_draw_screen) {
-		// 7-seg LEDs
-#ifdef MAX_DRAW_RANGES
-		for(int i = 0; i < MAX_DRAW_RANGES; i++) {
-#else
-		for(int i = 0; i < vm->max_draw_ranges(); i++) { // for TK-80BS
-#endif
-			int x = vm_ranges[i].x;
-			int y = vm_ranges[i].y;
-			int w = vm_ranges[i].width;
-			int h = vm_ranges[i].height;
-			BitBlt(hdc, x, y, w, h, vm_screen_buffer.hdcDib, x, y, SRCCOPY);
-		}
-		first_invalidate = self_invalidate = false;
-	}
-#else
-	if(first_draw_screen) {
-#ifndef _UNITY			// MARU
-		int dest_x = (host_window_width - draw_screen_width) / 2;
-		int dest_y = (host_window_height - draw_screen_height) / 2;
-		
-#ifdef SUPPORT_D2D1
-		if(config.use_d2d1) {
-			update_d2d1_screen(dest_x, dest_y);
-		} else
-#endif
-#ifdef SUPPORT_D3D9
-		if(config.use_d3d9) {
-			update_d3d9_screen(dest_x, dest_y);
-		} else
-#endif
-		{
-			BitBlt(hdc, dest_x, dest_y, draw_screen_width, draw_screen_height, draw_screen_buffer->hdcDib, 0, 0, SRCCOPY);
-		}
-#endif				// _UNITY
-		first_invalidate = self_invalidate = false;
-	}
-#endif
-}
-
-void OSD::initialize_screen_buffer(bitmap_t *buffer, int width, int height, int mode)
-{
-	release_screen_buffer(buffer);
-	
-	HDC hdc = GetDC(main_window_handle);
-	buffer->hdcDib = CreateCompatibleDC(hdc);
-#if defined(_RGB565)
-	// thanks PC8801MAâ¸
-	buffer->lpBuf = (LPBYTE)GlobalAlloc(GPTR, sizeof(BITMAPINFOHEADER) + sizeof(DWORD) * 3);
-#else
-	buffer->lpBuf = (LPBYTE)GlobalAlloc(GPTR, sizeof(BITMAPINFO));
-#endif
-	buffer->lpDib = (LPBITMAPINFO)(buffer->lpBuf);
-	memset(&buffer->lpDib->bmiHeader, 0, sizeof(BITMAPINFOHEADER));
-	buffer->lpDib->bmiHeader.biSize = sizeof(BITMAPINFOHEADER);
-	buffer->lpDib->bmiHeader.biWidth = width;
-	buffer->lpDib->bmiHeader.biHeight = height;
-	buffer->lpDib->bmiHeader.biPlanes = 1;
-#if defined(_RGB555)
-	buffer->lpDib->bmiHeader.biBitCount = 16;
-	buffer->lpDib->bmiHeader.biCompression = BI_RGB;
-	buffer->lpDib->bmiHeader.biSizeImage = width * height * 2;
-#elif defined(_RGB565)
-	buffer->lpDib->bmiHeader.biBitCount = 16;
-	buffer->lpDib->bmiHeader.biCompression = BI_BITFIELDS;
-	LPDWORD lpBf = (LPDWORD)buffer->lpDib->bmiColors;
-	lpBf[0] = 0x1f << 11;
-	lpBf[1] = 0x3f << 5;
-	lpBf[2] = 0x1f << 0;
-	buffer->lpDib->bmiHeader.biSizeImage = width * height * 2;
-#elif defined(_RGB888)
-	buffer->lpDib->bmiHeader.biBitCount = 32;
-	buffer->lpDib->bmiHeader.biCompression = BI_RGB;
-	buffer->lpDib->bmiHeader.biSizeImage = width * height * 4;
-#endif
-	buffer->lpDib->bmiHeader.biXPelsPerMeter = 0;
-	buffer->lpDib->bmiHeader.biYPelsPerMeter = 0;
-	buffer->lpDib->bmiHeader.biClrUsed = 0;
-	buffer->lpDib->bmiHeader.biClrImportant = 0;
-	buffer->hBmp = CreateDIBSection(hdc, buffer->lpDib, DIB_RGB_COLORS, (PVOID*)&(buffer->lpBmp), NULL, 0);
-	buffer->hOldBmp = (HBITMAP)SelectObject(buffer->hdcDib, buffer->hBmp);
-	ReleaseDC(main_window_handle, hdc);
-	SetStretchBltMode(buffer->hdcDib, mode);
-	
-	buffer->width = width;
-	buffer->height = height;
-}
-
-void OSD::release_screen_buffer(bitmap_t *buffer)
-{
-	if(buffer->initialized()) {
-		if(buffer->hdcDib != NULL && buffer->hOldBmp != NULL) {
-			SelectObject(buffer->hdcDib, buffer->hOldBmp);
-		}
-		if(buffer->hBmp != NULL) {
-			DeleteObject(buffer->hBmp);
-			buffer->hBmp = NULL;
-		}
-		if(buffer->lpBuf != NULL) {
-			GlobalFree(buffer->lpBuf);
-			buffer->lpBuf = NULL;
-		}
-		if(buffer->hdcDib != NULL) {
-			DeleteDC(buffer->hdcDib);
-			buffer->hdcDib = NULL;
-		}
-	}
-	memset(buffer, 0, sizeof(bitmap_t));
-}
-
-#ifdef USE_SCREEN_FILTER
-#define _3_8(v) (((((v) * 3) >> 3) * 180) >> 8)
-#define _5_8(v) (((((v) * 3) >> 3) * 180) >> 8)
-#define _8_8(v) (((v) * 180) >> 8)
-
-static uint8_t r0[2048], g0[2048], b0[2048], t0[2048];
-static uint8_t r1[2048], g1[2048], b1[2048];
-
-void OSD::apply_rgb_filter_to_screen_buffer(bitmap_t *source, bitmap_t *dest)
-{
-	if(source->width * 6 == dest->width && source->height * 6 == dest->height) {
-		// FM-77AV: 320x200 -> 640x400 -> 1920x1200
-		if(tmp_filtered_screen_buffer.width != source->width * 2 || tmp_filtered_screen_buffer.height != source->height * 2) {
-			initialize_screen_buffer(&tmp_filtered_screen_buffer, source->width * 2, source->height * 2, COLORONCOLOR);
-		}
-		stretch_screen_buffer(source, &tmp_filtered_screen_buffer);
-		screen_skip_line = true;
-		apply_rgb_filter_x3_y3(&tmp_filtered_screen_buffer, dest);
-	} else if(source->width * 3 == dest->width && source->height * 6 == dest->height) {
-		// FM-77AV: 640x200 -> 640x400 -> 1920x1200
-		if(tmp_filtered_screen_buffer.width != source->width || tmp_filtered_screen_buffer.height != source->height * 2) {
-			initialize_screen_buffer(&tmp_filtered_screen_buffer, source->width, source->height * 2, COLORONCOLOR);
-		}
-		stretch_screen_buffer(source, &tmp_filtered_screen_buffer);
-		screen_skip_line = true;
-		apply_rgb_filter_x3_y3(&tmp_filtered_screen_buffer, dest);
-	} else if(source->width * 4 == dest->width && source->height * 4 == dest->height) {
-		// FM-77AV: 320x200 -> 640x400 -> 1280x800
-		if(tmp_filtered_screen_buffer.width != source->width * 2 || tmp_filtered_screen_buffer.height != source->height * 2) {
-			initialize_screen_buffer(&tmp_filtered_screen_buffer, source->width * 2, source->height * 2, COLORONCOLOR);
-		}
-		stretch_screen_buffer(source, &tmp_filtered_screen_buffer);
-		screen_skip_line = true;
-		apply_rgb_filter_x2_y2(&tmp_filtered_screen_buffer, dest);
-	} else if(source->width * 2 == dest->width && source->height * 4 == dest->height) {
-		// FM-77AV: 640x200 -> 640x400 -> 1280x800
-		if(tmp_filtered_screen_buffer.width != source->width || tmp_filtered_screen_buffer.height != source->height * 2) {
-			initialize_screen_buffer(&tmp_filtered_screen_buffer, source->width, source->height * 2, COLORONCOLOR);
-		}
-		stretch_screen_buffer(source, &tmp_filtered_screen_buffer);
-		screen_skip_line = true;
-		apply_rgb_filter_x2_y2(&tmp_filtered_screen_buffer, dest);
-	} else if(source->width * 3 == dest->width && source->height * 3 == dest->height) {
-		apply_rgb_filter_x3_y3(source, dest);
-	} else if(source->width * 3 == dest->width && source->height * 2 == dest->height) {
-		apply_rgb_filter_x3_y2(source, dest);
-	} else if(source->width * 2 == dest->width && source->height * 3 == dest->height) {
-		apply_rgb_filter_x2_y3(source, dest);
-	} else if(source->width * 2 == dest->width && source->height * 2 == dest->height) {
-		apply_rgb_filter_x2_y2(source, dest);
-	} else if(source->width != dest->width || source->height != dest->height) {
-		if(tmp_filtered_screen_buffer.width != source->width || tmp_filtered_screen_buffer.height != source->height) {
-			initialize_screen_buffer(&tmp_filtered_screen_buffer, source->width, source->height, COLORONCOLOR);
-		}
-		apply_rgb_filter_x1_y1(source, &tmp_filtered_screen_buffer);
-		stretch_screen_buffer(&tmp_filtered_screen_buffer, dest);
-	} else {
-		apply_rgb_filter_x1_y1(source, dest);
-	}
-}
-
-void OSD::apply_rgb_filter_x3_y3(bitmap_t *source, bitmap_t *dest)
-{
-	if(!screen_skip_line) {
-		for(int y = 0, yy = 0; y < source->height; y++, yy += 3) {
-			scrntype_t* src = source->get_buffer(y);
-			scrntype_t* out1 = dest->get_buffer(yy + 0);
-			scrntype_t* out2 = dest->get_buffer(yy + 1);
-			scrntype_t* out3 = dest->get_buffer(yy + 2);
-			
-			for(int x = 1; x <= source->width; x++) {
-				scrntype_t c = src[x - 1];
-				t0[x] = A_OF_COLOR(c);
-				r0[x] = R_OF_COLOR(c);
-				g0[x] = G_OF_COLOR(c);
-				b0[x] = B_OF_COLOR(c);
-				r1[x] = r0[x] >> 3;
-				g1[x] = g0[x] >> 3;
-				b1[x] = b0[x] >> 3;
-			}
-			for(int x = 1, xx = 0; x <= source->width; x++, xx += 3) {
-				uint32_t r = r1[x - 1] + r0[x] + r1[x + 1];
-				uint32_t g = g1[x - 1] + g0[x] + g1[x + 1];
-				uint32_t b = b1[x - 1] + b0[x] + b1[x + 1];
-				out1[xx    ] = out2[xx    ] = (32 + _8_8(r)) << 16;
-				out1[xx + 1] = out2[xx + 1] = (32 + _8_8(g)) << 8;
-				out1[xx + 2] = out2[xx + 2] = (32 + _8_8(b));
-				if(t0[x]) {
-					out3[xx    ] = (32 + _8_8(r)) << 16;
-					out3[xx + 1] = (32 + _8_8(g)) << 8;
-					out3[xx + 2] = (32 + _8_8(b));
-				} else {
-					out3[xx    ] = (32 + _5_8(r)) << 16;
-					out3[xx + 1] = (32 + _5_8(g)) << 8;
-					out3[xx + 2] = (32 + _5_8(b));
-				}
-			}
-		}
-	} else {
-		for(int y = 0, yy = 0; y < source->height; y += 2, yy += 6) {
-			scrntype_t* src = source->get_buffer(y);
-			scrntype_t* out1 = dest->get_buffer(yy + 0);
-			scrntype_t* out2 = dest->get_buffer(yy + 1);
-			scrntype_t* out3 = dest->get_buffer(yy + 2);
-			scrntype_t* out4 = dest->get_buffer(yy + 3);
-			scrntype_t* out5 = dest->get_buffer(yy + 4);
-			scrntype_t* out6 = dest->get_buffer(yy + 5);
-			
-			for(int x = 1; x <= source->width; x++) {
-				scrntype_t c = src[x - 1];
-				t0[x] = A_OF_COLOR(c);
-				r0[x] = R_OF_COLOR(c);
-				g0[x] = G_OF_COLOR(c);
-				b0[x] = B_OF_COLOR(c);
-				r1[x] = r0[x] >> 3;
-				g1[x] = g0[x] >> 3;
-				b1[x] = b0[x] >> 3;
-			}
-			for(int x = 1, xx = 0; x <= source->width; x++, xx += 3) {
-				uint32_t r = r1[x - 1] + r0[x] + r1[x + 1];
-				uint32_t g = g1[x - 1] + g0[x] + g1[x + 1];
-				uint32_t b = b1[x - 1] + b0[x] + b1[x + 1];
-				out1[xx    ] = out2[xx    ] = out3[xx    ] = out4[xx    ] = (32 + _8_8(r)) << 16;
-				out1[xx + 1] = out2[xx + 1] = out3[xx + 1] = out4[xx + 1] = (32 + _8_8(g)) << 8;
-				out1[xx + 2] = out2[xx + 2] = out3[xx + 2] = out4[xx + 2] = (32 + _8_8(b));
-				if(t0[x]) {
-					out5[xx    ] = out6[xx    ] = (32 + _8_8(r)) << 16;
-					out5[xx + 1] = out6[xx + 1] = (32 + _8_8(g)) << 8;
-					out5[xx + 2] = out6[xx + 2] = (32 + _8_8(b));
-				} else {
-					out5[xx    ] = out6[xx    ] = (32 + _5_8(r)) << 16;
-					out5[xx + 1] = out6[xx + 1] = (32 + _5_8(g)) << 8;
-					out5[xx + 2] = out6[xx + 2] = (32 + _5_8(b));
-				}
-			}
-		}
-	}
-}
-
-void OSD::apply_rgb_filter_x3_y2(bitmap_t *source, bitmap_t *dest)
-{
-	if(!screen_skip_line) {
-		for(int y = 0, yy = 0; y < source->height; y++, yy += 2) {
-			scrntype_t* src = source->get_buffer(y);
-			scrntype_t* out1 = dest->get_buffer(yy + 0);
-			scrntype_t* out2 = dest->get_buffer(yy + 1);
-			
-			for(int x = 1; x <= source->width; x++) {
-				scrntype_t c = src[x - 1];
-				t0[x] = A_OF_COLOR(c);
-				r0[x] = R_OF_COLOR(c);
-				g0[x] = G_OF_COLOR(c);
-				b0[x] = B_OF_COLOR(c);
-				r1[x] = r0[x] >> 3;
-				g1[x] = g0[x] >> 3;
-				b1[x] = b0[x] >> 3;
-			}
-			for(int x = 1, xx = 0; x <= source->width; x++, xx += 3) {
-				uint32_t r = r1[x - 1] + r0[x] + r1[x + 1];
-				uint32_t g = g1[x - 1] + g0[x] + g1[x + 1];
-				uint32_t b = b1[x - 1] + b0[x] + b1[x + 1];
-				out1[xx    ] = (32 + _8_8(r)) << 16;
-				out1[xx + 1] = (32 + _8_8(g)) << 8;
-				out1[xx + 2] = (32 + _8_8(b));
-				if(t0[x]) {
-					out2[xx    ] = (32 + _8_8(r)) << 16;
-					out2[xx + 1] = (32 + _8_8(g)) << 8;
-					out2[xx + 2] = (32 + _8_8(b));
-				} else {
-					out2[xx    ] = (32 + _5_8(r)) << 16;
-					out2[xx + 1] = (32 + _5_8(g)) << 8;
-					out2[xx + 2] = (32 + _5_8(b));
-				}
-			}
-		}
-	} else {
-		for(int y = 0, yy = 0; y < source->height; y += 2, yy += 4) {
-			scrntype_t* src = source->get_buffer(y);
-			scrntype_t* out1 = dest->get_buffer(yy + 0);
-			scrntype_t* out2 = dest->get_buffer(yy + 1);
-			scrntype_t* out3 = dest->get_buffer(yy + 2);
-			scrntype_t* out4 = dest->get_buffer(yy + 3);
-			
-			for(int x = 1; x <= source->width; x++) {
-				scrntype_t c = src[x - 1];
-				t0[x] = A_OF_COLOR(c);
-				r0[x] = R_OF_COLOR(c);
-				g0[x] = G_OF_COLOR(c);
-				b0[x] = B_OF_COLOR(c);
-				r1[x] = r0[x] >> 3;
-				g1[x] = g0[x] >> 3;
-				b1[x] = b0[x] >> 3;
-			}
-			for(int x = 1, xx = 0; x <= source->width; x++, xx += 3) {
-				uint32_t r = r1[x - 1] + r0[x] + r1[x + 1];
-				uint32_t g = g1[x - 1] + g0[x] + g1[x + 1];
-				uint32_t b = b1[x - 1] + b0[x] + b1[x + 1];
-				out1[xx    ] = out2[xx    ] = out3[xx    ] = (32 + _8_8(r)) << 16;
-				out1[xx + 1] = out2[xx + 1] = out3[xx + 1] = (32 + _8_8(g)) << 8;
-				out1[xx + 2] = out2[xx + 2] = out3[xx + 2] = (32 + _8_8(b));
-				if(t0[x]) {
-					out4[xx    ] = (32 + _8_8(r)) << 16;
-					out4[xx + 1] = (32 + _8_8(g)) << 8;
-					out4[xx + 2] = (32 + _8_8(b));
-				} else {
-					out4[xx    ] = (32 + _5_8(r)) << 16;
-					out4[xx + 1] = (32 + _5_8(g)) << 8;
-					out4[xx + 2] = (32 + _5_8(b));
-				}
-			}
-		}
-	}
-}
-
-void OSD::apply_rgb_filter_x2_y3(bitmap_t *source, bitmap_t *dest)
-{
-	if(!screen_skip_line) {
-		for(int y = 0, yy = 0; y < source->height; y++, yy += 3) {
-			scrntype_t* src = source->get_buffer(y);
-			scrntype_t* out1 = dest->get_buffer(yy + 0);
-			scrntype_t* out2 = dest->get_buffer(yy + 1);
-			scrntype_t* out3 = dest->get_buffer(yy + 2);
-			
-			for(int x = 1; x <= source->width; x++) {
-				scrntype_t c = src[x - 1];
-				t0[x] = A_OF_COLOR(c);
-				r0[x] = R_OF_COLOR(c);
-				g0[x] = G_OF_COLOR(c);
-				b0[x] = B_OF_COLOR(c);
-				r1[x] = r0[x] >> 3;
-				g1[x] = g0[x] >> 3;
-				b1[x] = b0[x] >> 3;
-			}
-			for(int x = 1, xx = 0; x <= source->width; x++, xx += 2) {
-				uint32_t r = r1[x - 1] + r0[x] + r1[x + 1];
-				uint32_t g = g1[x - 1] + g0[x] + g1[x + 1];
-				uint32_t b = b1[x - 1] + b0[x] + b1[x + 1];
-				out1[xx    ] = out2[xx    ] = RGB_COLOR(32 + _8_8(r), 32 + _8_8(g), 32 + _8_8(b));
-				out1[xx + 1] = out2[xx + 1] = RGB_COLOR(16 + _5_8(r), 16 + _5_8(g), 16 + _5_8(b));
-				if(t0[x]) {
-					out3[xx    ] = RGB_COLOR(32 + _8_8(r), 32 + _8_8(g), 32 + _8_8(b));
-					out3[xx + 1] = RGB_COLOR(16 + _5_8(r), 16 + _5_8(g), 16 + _5_8(b));
-				} else {
-					out3[xx    ] = RGB_COLOR(32 + _3_8(r), 32 + _3_8(g), 32 + _3_8(b));
-					out3[xx + 1] = RGB_COLOR(16 + _3_8(r), 16 + _3_8(g), 16 + _3_8(b));
-				}
-			}
-		}
-	} else {
-		for(int y = 0, yy = 0; y < source->height; y += 2, yy += 6) {
-			scrntype_t* src = source->get_buffer(y);
-			scrntype_t* out1 = dest->get_buffer(yy + 0);
-			scrntype_t* out2 = dest->get_buffer(yy + 1);
-			scrntype_t* out3 = dest->get_buffer(yy + 2);
-			scrntype_t* out4 = dest->get_buffer(yy + 3);
-			scrntype_t* out5 = dest->get_buffer(yy + 4);
-			scrntype_t* out6 = dest->get_buffer(yy + 5);
-			
-			for(int x = 1; x <= source->width; x++) {
-				scrntype_t c = src[x - 1];
-				t0[x] = A_OF_COLOR(c);
-				r0[x] = R_OF_COLOR(c);
-				g0[x] = G_OF_COLOR(c);
-				b0[x] = B_OF_COLOR(c);
-				r1[x] = r0[x] >> 3;
-				g1[x] = g0[x] >> 3;
-				b1[x] = b0[x] >> 3;
-			}
-			for(int x = 1, xx = 0; x <= source->width; x++, xx += 2) {
-				uint32_t r = r1[x - 1] + r0[x] + r1[x + 1];
-				uint32_t g = g1[x - 1] + g0[x] + g1[x + 1];
-				uint32_t b = b1[x - 1] + b0[x] + b1[x + 1];
-				out1[xx    ] = out2[xx    ] = out3[xx    ] = out4[xx    ] = RGB_COLOR(32 + _8_8(r), 32 + _8_8(g), 32 + _8_8(b));
-				out1[xx + 1] = out2[xx + 1] = out3[xx + 1] = out4[xx + 1] = RGB_COLOR(16 + _5_8(r), 16 + _5_8(g), 16 + _5_8(b));
-				if(t0[x]) {
-					out5[xx    ] = out6[xx    ] = RGB_COLOR(32 + _8_8(r), 32 + _8_8(g), 32 + _8_8(b));
-					out5[xx + 1] = out6[xx + 1] = RGB_COLOR(16 + _5_8(r), 16 + _5_8(g), 16 + _5_8(b));
-				} else {
-					out5[xx    ] = out6[xx    ] = RGB_COLOR(32 + _3_8(r), 32 + _3_8(g), 32 + _3_8(b));
-					out5[xx + 1] = out6[xx + 1] = RGB_COLOR(16 + _3_8(r), 16 + _3_8(g), 16 + _3_8(b));
-				}
-			}
-		}
-	}
-}
-
-void OSD::apply_rgb_filter_x2_y2(bitmap_t *source, bitmap_t *dest)
-{
-	if(!screen_skip_line) {
-		for(int y = 0, yy = 0; y < source->height; y++, yy += 2) {
-			scrntype_t* src = source->get_buffer(y);
-			scrntype_t* out1 = dest->get_buffer(yy + 0);
-			scrntype_t* out2 = dest->get_buffer(yy + 1);
-			
-			for(int x = 1; x <= source->width; x++) {
-				scrntype_t c = src[x - 1];
-				t0[x] = A_OF_COLOR(c);
-				r0[x] = R_OF_COLOR(c);
-				g0[x] = G_OF_COLOR(c);
-				b0[x] = B_OF_COLOR(c);
-				r1[x] = r0[x] >> 3;
-				g1[x] = g0[x] >> 3;
-				b1[x] = b0[x] >> 3;
-			}
-			for(int x = 1, xx = 0; x <= source->width; x++, xx += 2) {
-				uint32_t r = r1[x - 1] + r0[x] + r1[x + 1];
-				uint32_t g = g1[x - 1] + g0[x] + g1[x + 1];
-				uint32_t b = b1[x - 1] + b0[x] + b1[x + 1];
-				out1[xx    ] = RGB_COLOR(32 + _8_8(r), 32 + _8_8(g), 32 + _8_8(b));
-				out1[xx + 1] = RGB_COLOR(16 + _5_8(r), 16 + _5_8(g), 16 + _5_8(b));
-				if(t0[x]) {
-					out2[xx    ] = RGB_COLOR(32 + _8_8(r), 32 + _8_8(g), 32 + _8_8(b));
-					out2[xx + 1] = RGB_COLOR(16 + _5_8(r), 16 + _5_8(g), 16 + _5_8(b));
-				} else {
-					out2[xx    ] = RGB_COLOR(32 + _3_8(r), 32 + _3_8(g), 32 + _3_8(b));
-					out2[xx + 1] = RGB_COLOR(16 + _3_8(r), 16 + _3_8(g), 16 + _3_8(b));
-				}
-			}
-		}
-	} else {
-		for(int y = 0, yy = 0; y < source->height; y += 2, yy += 4) {
-			scrntype_t* src = source->get_buffer(y);
-			scrntype_t* out1 = dest->get_buffer(yy + 0);
-			scrntype_t* out2 = dest->get_buffer(yy + 1);
-			scrntype_t* out3 = dest->get_buffer(yy + 2);
-			scrntype_t* out4 = dest->get_buffer(yy + 3);
-			
-			for(int x = 1; x <= source->width; x++) {
-				scrntype_t c = src[x - 1];
-				t0[x] = A_OF_COLOR(c);
-				r0[x] = R_OF_COLOR(c);
-				g0[x] = G_OF_COLOR(c);
-				b0[x] = B_OF_COLOR(c);
-				r1[x] = r0[x] >> 3;
-				g1[x] = g0[x] >> 3;
-				b1[x] = b0[x] >> 3;
-			}
-			for(int x = 1, xx = 0; x <= source->width; x++, xx += 2) {
-				uint32_t r = r1[x - 1] + r0[x] + r1[x + 1];
-				uint32_t g = g1[x - 1] + g0[x] + g1[x + 1];
-				uint32_t b = b1[x - 1] + b0[x] + b1[x + 1];
-				out1[xx    ] = out2[xx    ] = out3[xx    ] = RGB_COLOR(32 + _8_8(r), 32 + _8_8(g), 32 + _8_8(b));
-				out1[xx + 1] = out2[xx + 1] = out3[xx + 1] = RGB_COLOR(16 + _5_8(r), 16 + _5_8(g), 16 + _5_8(b));
-				if(t0[x]) {
-					out4[xx    ] = RGB_COLOR(32 + _8_8(r), 32 + _8_8(g), 32 + _8_8(b));
-					out4[xx + 1] = RGB_COLOR(16 + _5_8(r), 16 + _5_8(g), 16 + _5_8(b));
-				} else {
-					out4[xx    ] = RGB_COLOR(32 + _3_8(r), 32 + _3_8(g), 32 + _3_8(b));
-					out4[xx + 1] = RGB_COLOR(16 + _3_8(r), 16 + _3_8(g), 16 + _3_8(b));
-				}
-			}
-		}
-	}
-}
-
-void OSD::apply_rgb_filter_x1_y1(bitmap_t *source, bitmap_t *dest)
-{
-	if(!screen_skip_line) {
-		for(int y = 0; y < source->height; y++) {
-			scrntype_t* src = source->get_buffer(y);
-			scrntype_t* out1 = dest->get_buffer(y + 0);
-			
-			for(int x = 1; x <= source->width; x++) {
-				scrntype_t c = src[x - 1];
-				r0[x] = R_OF_COLOR(c);
-				g0[x] = G_OF_COLOR(c);
-				b0[x] = B_OF_COLOR(c);
-				r1[x] = r0[x] >> 3;
-				g1[x] = g0[x] >> 3;
-				b1[x] = b0[x] >> 3;
-			}
-			for(int x = 1; x <= source->width; x++) {
-				uint32_t r = r1[x - 1] + r0[x] + r1[x + 1];
-				uint32_t g = g1[x - 1] + g0[x] + g1[x + 1];
-				uint32_t b = b1[x - 1] + b0[x] + b1[x + 1];
-				out1[x - 1] = RGB_COLOR(32 + _8_8(r), 32 + _8_8(g), 32 + _8_8(b));
-			}
-		}
-	} else {
-		for(int y = 0; y < source->height; y += 2) {
-			scrntype_t* src = source->get_buffer(y);
-			scrntype_t* out1 = dest->get_buffer(y + 0);
-			scrntype_t* out2 = dest->get_buffer(y + 1);
-			
-			for(int x = 1; x <= source->width; x++) {
-				scrntype_t c = src[x - 1];
-				t0[x] = A_OF_COLOR(c);
-				r0[x] = R_OF_COLOR(c);
-				g0[x] = G_OF_COLOR(c);
-				b0[x] = B_OF_COLOR(c);
-				r1[x] = r0[x] >> 3;
-				g1[x] = g0[x] >> 3;
-				b1[x] = b0[x] >> 3;
-			}
-			for(int x = 1; x <= source->width; x++) {
-				uint32_t r = r1[x - 1] + r0[x] + r1[x + 1];
-				uint32_t g = g1[x - 1] + g0[x] + g1[x + 1];
-				uint32_t b = b1[x - 1] + b0[x] + b1[x + 1];
-				out1[x - 1] = RGB_COLOR(32 + _8_8(r), 32 + _8_8(g), 32 + _8_8(b));
-				if(t0[x]) {
-					out2[x - 1] = RGB_COLOR(32 + _8_8(r), 32 + _8_8(g), 32 + _8_8(b));
-				} else {
-					out2[x - 1] = RGB_COLOR(32 + _3_8(r), 32 + _3_8(g), 32 + _3_8(b));
-				}
-			}
-		}
-	}
-}
-#endif
-
-//#ifdef USE_SCREEN_ROTATE
-void OSD::rotate_screen_buffer(bitmap_t *source, bitmap_t *dest)
-{
-	if(config.rotate_type == 1) {
-		// turn right 90deg
-		if(source->width == dest->height && source->height == dest->width) {
-			for(int y = 0; y < source->height; y++) {
-				scrntype_t* source_buffer = source->get_buffer(y);
-				int offset = dest->width - y - 1;
-				
-				for(int x = 0; x < source->width; x++) {
-					dest->get_buffer(x)[offset] = source_buffer[x];
-				}
-			}
-		}
-	} else if(config.rotate_type == 2) {
-		// turn right 180deg
-		if(source->width == dest->width && source->height == dest->height) {
-			for(int y = 0; y < source->height; y++) {
-				scrntype_t* source_buffer = source->get_buffer(y);
-				scrntype_t* dest_buffer = dest->get_buffer(dest->height - y - 1);
-				int offset = dest->width - 1;
-				
-				for(int x = 0; x < source->width; x++) {
-					dest_buffer[offset - x] = source_buffer[x];
-				}
-			}
-		}
-	} else if(config.rotate_type == 3) {
-		// turn right 270deg
-		if(source->width == dest->height && source->height == dest->width) {
-			for(int y = 0; y < source->height; y++) {
-				scrntype_t* source_buffer = source->get_buffer(y);
-				int offset = dest->height - 1;
-				
-				for(int x = 0; x < source->width; x++) {
-					dest->get_buffer(offset - x)[y] = source_buffer[x];
-				}
-			}
-		}
-	}
-}
-//#endif
-
-void OSD::stretch_screen_buffer(bitmap_t *source, bitmap_t *dest)
-{
-	if((dest->width % source->width) == 0 && (dest->height % source->height) == 0) {
-		// faster than StretchBlt()
-		int pow_x = dest->width / source->width;
-		int pow_y = dest->height / source->height;
-		
-		for(int y = 0, yy = 0; y < source->height; y++, yy += pow_y) {
-			scrntype_t* source_buffer = source->get_buffer(y);
-			scrntype_t* dest_buffer = dest->get_buffer(yy);
-			
-			if(pow_x != 1) {
-				scrntype_t* tmp_buffer = dest_buffer;
-				for(int x = 0; x < source->width; x++) {
-					scrntype_t c = source_buffer[x];
-					for(int px = 0; px < pow_x; px++) {
-						tmp_buffer[px] = c;
-					}
-					tmp_buffer += pow_x;
-				}
-			} else {
-				// about 10% faster than memcpy()
-				for(int x = 0; x < source->width; x++) {
-					dest_buffer[x] = source_buffer[x];
-				}
-			}
-			if(pow_y != 1) {
-				for(int py = 1; py < pow_y; py++) {
-					// about 10% faster than memcpy()
-					scrntype_t* tmp_buffer = dest->get_buffer(yy + py);
-					for(int x = 0; x < dest->width; x++) {
-						tmp_buffer[x] = dest_buffer[x];
-					}
-				}
-			}
-		}
-	} else {
-		StretchBlt(dest->hdcDib, 0, 0, dest->width, dest->height, source->hdcDib, 0, 0, source->width, source->height, SRCCOPY);
-	}
-}
-
-#if defined(_RGB555)
-	#define DXGI_FORMAT_TMP DXGI_FORMAT_B5G5R5A1_UNORM
-	#define D3DFMT_TMP D3DFMT_X1R5G5B5
-#elif defined(_RGB565)
-	#define DXGI_FORMAT_TMP DXGI_FORMAT_B5G6R5_UNORM
-	#define D3DFMT_TMP D3DFMT_R5G6B5
-#elif defined(_RGB888)
-	#define DXGI_FORMAT_TMP DXGI_FORMAT_B8G8R8A8_UNORM
-	#define D3DFMT_TMP D3DFMT_X8R8G8B8
-#endif
-
-#ifdef SUPPORT_D2D1
-bool OSD::initialize_d2d1()
-{
-	release_d2d1();
-	
-	if(!FAILED(D2D1CreateFactory(D2D1_FACTORY_TYPE_MULTI_THREADED, &pD2d1Factory))) {
-		if(host_window_mode && config.show_status_bar) {
-			D2D1_RENDER_TARGET_PROPERTIES props = D2D1::RenderTargetProperties(
-				D2D1_RENDER_TARGET_TYPE_DEFAULT,
-				D2D1::PixelFormat(DXGI_FORMAT_TMP, D2D1_ALPHA_MODE_IGNORE),
-				0, 0,
-				D2D1_RENDER_TARGET_USAGE_NONE,
-				D2D1_FEATURE_LEVEL_DEFAULT
-			);
-			if(!FAILED(pD2d1Factory->CreateDCRenderTarget(&props, &pD2d1DCRenderTarget))) {
-				int dest_x = (host_window_width - draw_screen_width) / 2;
-				int dest_y = (host_window_height - draw_screen_height) / 2;
-				RECT rect = { dest_x, dest_y, dest_x + draw_screen_width, dest_y + draw_screen_height };
-				if(!FAILED(pD2d1DCRenderTarget->BindDC(GetDC(main_window_handle), &rect))) {
-					return true;
-				}
-			}
-		} else {
-			if(!FAILED(pD2d1Factory->CreateHwndRenderTarget(
-				D2D1::RenderTargetProperties(),
-				D2D1::HwndRenderTargetProperties(main_window_handle, D2D1::SizeU(host_window_width, host_window_height)),
-				&pD2d1HwndRenderTarget
-			))) {
-				return true;
-			}
-		}
-	}
-	return false;
-}
-
-bool OSD::initialize_d2d1_surface(bitmap_t *buffer)
-{
-	if(host_window_mode && config.show_status_bar) {
-		if(pD2d1DCRenderTarget != NULL) {
-			if(!FAILED(pD2d1DCRenderTarget->CreateBitmap(
-				D2D1::SizeU(buffer->width, buffer->height),
-				D2D1::BitmapProperties(D2D1::PixelFormat(DXGI_FORMAT_TMP, D2D1_ALPHA_MODE_IGNORE)),
-				&pD2d1Bitmap
-			))) {
-				return true;
-			}
-		}
-	} else {
-		if(pD2d1HwndRenderTarget != NULL) {
-			if(!FAILED(pD2d1HwndRenderTarget->CreateBitmap(
-				D2D1::SizeU(buffer->width, buffer->height),
-				D2D1::BitmapProperties(D2D1::PixelFormat(DXGI_FORMAT_TMP, D2D1_ALPHA_MODE_IGNORE)),
-				&pD2d1Bitmap
-			))) {
-				return true;
-			}
-		}
-	}
-	return false;
-}
-
-void OSD::release_d2d1()
-{
-	release_d2d1_surface();
-	
-	if(pD2d1DCRenderTarget != NULL) {
-		pD2d1DCRenderTarget->Release();
-		pD2d1DCRenderTarget = NULL;
-	}
-	if(pD2d1HwndRenderTarget != NULL) {
-		pD2d1HwndRenderTarget->Release();
-		pD2d1HwndRenderTarget = NULL;
-	}
-	if(pD2d1Factory != NULL) {
-		pD2d1Factory->Release();
-		pD2d1Factory = NULL;
-	}
-}
-
-void OSD::release_d2d1_surface()
-{
-	if(pD2d1Bitmap != NULL) {
-		pD2d1Bitmap->Release();
-		pD2d1Bitmap = NULL;
-	}
-}
-
-void OSD::copy_to_d2d1_surface(bitmap_t *buffer)
-{
-	if(reversed_screen_buffer.width != buffer->width || reversed_screen_buffer.height != buffer->height) {
-		initialize_screen_buffer(&reversed_screen_buffer, buffer->width, buffer->height, HALFTONE);
-	}
-	for(int y = 0; y < buffer->height; y++) {
-		scrntype_t* source_buffer = buffer->get_buffer(buffer->height - y - 1);
-		scrntype_t* dest_buffer = reversed_screen_buffer.get_buffer(y);
-		
-		for(int x = 0; x < buffer->width; x++) {
-			dest_buffer[x] = source_buffer[x];
-		}
-	}
-	pD2d1Bitmap->CopyFromMemory(nullptr, reinterpret_cast< const void* >(reversed_screen_buffer.lpBmp), sizeof(scrntype_t) * reversed_screen_buffer.width);
-}
-
-void OSD::update_d2d1_screen(int dest_x, int dest_y)
-{
-	D2D1_RECT_F rect = { (FLOAT)dest_x, (FLOAT)dest_y, (FLOAT)(dest_x + draw_screen_width), (FLOAT)(dest_y + draw_screen_height) };
-	HRESULT hr = 0;
-	
-	if(host_window_mode && config.show_status_bar) {
-		if(pD2d1DCRenderTarget != NULL) {
-			pD2d1DCRenderTarget->BeginDraw();
-			pD2d1DCRenderTarget->DrawBitmap(pD2d1Bitmap, &rect, 1.0f, D2D1_BITMAP_INTERPOLATION_MODE_LINEAR);
-			hr = pD2d1DCRenderTarget->EndDraw();
-		}
-	} else {
-		if(pD2d1HwndRenderTarget != NULL) {
-			pD2d1HwndRenderTarget->BeginDraw();
-			pD2d1HwndRenderTarget->DrawBitmap(pD2d1Bitmap, &rect, 1.0f, D2D1_BITMAP_INTERPOLATION_MODE_LINEAR);
-			hr = pD2d1HwndRenderTarget->EndDraw();
-		}
-	}
-	if(hr == D2DERR_RECREATE_TARGET) {
-		set_host_window_size(-1, -1, host_window_mode);
-	}
-}
-#endif
-
-#ifdef SUPPORT_D3D9
-bool OSD::initialize_d3d9()
-{
-	release_d3d9();
-	
-	if((lpd3d9 = Direct3DCreate9(D3D_SDK_VERSION)) != NULL) {
-		D3DPRESENT_PARAMETERS d3dpp;
-		ZeroMemory(&d3dpp, sizeof(d3dpp));
-		d3dpp.BackBufferWidth = host_window_width;
-		d3dpp.BackBufferHeight = host_window_height;
-		d3dpp.BackBufferFormat = D3DFMT_TMP;//D3DFMT_UNKNOWN;
-		d3dpp.SwapEffect = D3DSWAPEFFECT_DISCARD;
-		d3dpp.hDeviceWindow = main_window_handle;
-		d3dpp.Windowed = TRUE;
-		d3dpp.Flags = D3DPRESENTFLAG_LOCKABLE_BACKBUFFER;
-		d3dpp.PresentationInterval = config.wait_vsync ? D3DPRESENT_INTERVAL_ONE : D3DPRESENT_INTERVAL_IMMEDIATE;
-		
-		// create d3d9 device
-		HRESULT hr = lpd3d9->CreateDevice(D3DADAPTER_DEFAULT, D3DDEVTYPE_HAL, main_window_handle, D3DCREATE_HARDWARE_VERTEXPROCESSING, &d3dpp, &lpd3d9Device);
-		if(hr != D3D_OK) {
-			hr = lpd3d9->CreateDevice(D3DADAPTER_DEFAULT, D3DDEVTYPE_HAL, main_window_handle, D3DCREATE_SOFTWARE_VERTEXPROCESSING, &d3dpp, &lpd3d9Device);
-			if(hr != D3D_OK) {
-				hr = lpd3d9->CreateDevice(D3DADAPTER_DEFAULT, D3DDEVTYPE_REF, main_window_handle, D3DCREATE_SOFTWARE_VERTEXPROCESSING, &d3dpp, &lpd3d9Device);
-			}
-		}
-		if(hr == D3D_OK) {
-			return true;
-		}
-		MessageBox(main_window_handle, _T("Failed to create a Direct3D9 device"), _T(DEVICE_NAME), MB_OK | MB_ICONWARNING);
-		release_d3d9();
-	} else {
-		MessageBox(main_window_handle, _T("Failed to initialize Direct3D9"), _T(DEVICE_NAME), MB_OK | MB_ICONWARNING);
-	}
-	return false;
-}
-
-bool OSD::initialize_d3d9_surface(bitmap_t *buffer)
-{
-	release_d3d9_surface();
-	
-	if(lpd3d9Device != NULL) {
-		HRESULT hr = lpd3d9Device->CreateOffscreenPlainSurface(buffer->width, buffer->height, D3DFMT_TMP, D3DPOOL_DEFAULT, &lpd3d9Surface, NULL);
-		if(hr == D3D_OK) {
-			hr = lpd3d9Device->CreateOffscreenPlainSurface(buffer->width, buffer->height, D3DFMT_TMP, D3DPOOL_SYSTEMMEM, &lpd3d9OffscreenSurface, NULL);
-		}
-		if(hr == D3D_OK) {
-			lpd3d9Device->Clear(0, NULL, D3DCLEAR_TARGET, D3DCOLOR_XRGB(0, 0, 0), 0.0, 0);
-			return true;
-		}
-		MessageBox(main_window_handle, _T("Failed to create a Direct3D9 offscreen surface"), _T(DEVICE_NAME), MB_OK | MB_ICONWARNING);
-		release_d3d9();
-	}
-	return false;
-}
-
-void OSD::release_d3d9()
-{
-	release_d3d9_surface();
-	
-	if(lpd3d9Device != NULL) {
-		lpd3d9Device->Release();
-		lpd3d9Device = NULL;
-	}
-	if(lpd3d9 != NULL) {
-		lpd3d9->Release();
-		lpd3d9 = NULL;
-	}
-}
-
-void OSD::release_d3d9_surface()
-{
-	if(lpd3d9OffscreenSurface != NULL) {
-		lpd3d9OffscreenSurface->Release();
-		lpd3d9OffscreenSurface = NULL;
-	}
-	if(lpd3d9Surface != NULL) {
-		lpd3d9Surface->Release();
-		lpd3d9Surface = NULL;
-	}
-}
-
-void OSD::copy_to_d3d9_surface(bitmap_t *buffer)
-{
-	if(lpd3d9OffscreenSurface != NULL) {
-		// lock offscreen surface
-		D3DLOCKED_RECT pLockedRect;
-		if(lpd3d9OffscreenSurface->LockRect(&pLockedRect, NULL, 0) == D3D_OK) {
-			scrntype_t *lpd3d9Buffer = (scrntype_t *)pLockedRect.pBits;
-			scrntype_t *out = lpd3d9Buffer;
-			for(int y = 0; y < buffer->height; y++) {
-				scrntype_t* src = buffer->get_buffer(y);
-				for(int i = 0; i < buffer->width; i++) {
-					out[i] = src[i];
-				}
-				out += buffer->width;
-			}
-			
-			// unlock offscreen surface
-			lpd3d9Buffer = NULL;
-			lpd3d9OffscreenSurface->UnlockRect();
-		}
-	}
-	
-}
-
-void OSD::update_d3d9_screen(int dest_x, int dest_y)
-{
-	LPDIRECT3DSURFACE9 lpd3d9BackSurface = NULL;
-	
-	if(lpd3d9Device != NULL && lpd3d9Device->GetBackBuffer(0, 0, D3DBACKBUFFER_TYPE_MONO, &lpd3d9BackSurface) == D3D_OK && lpd3d9BackSurface != NULL) {
-		RECT rectSrc = { 0, 0, draw_screen_buffer->width, draw_screen_buffer->height };
-		RECT rectDst = { dest_x, dest_y, dest_x + draw_screen_width, dest_y + draw_screen_height };
-		RECT rectWin = { 0, 0, host_window_width, host_window_height };
-		bool stretch_screen = !(draw_screen_buffer->width == draw_screen_width && draw_screen_buffer->height == draw_screen_height);
-		
-		lpd3d9Device->UpdateSurface(lpd3d9OffscreenSurface, NULL, lpd3d9Surface, NULL);
-		lpd3d9Device->StretchRect(lpd3d9Surface, &rectSrc, lpd3d9BackSurface, &rectDst, stretch_screen ? D3DTEXF_LINEAR : D3DTEXF_POINT);
-		lpd3d9BackSurface->Release();
-		if(lpd3d9Device->Present(&rectWin, &rectWin, NULL, NULL) == D3DERR_DEVICELOST) d3d9_device_lost = true;
-	}
-}
-#endif
-
-void OSD::capture_screen()
-{
-//	write_bitmap_to_file(&vm_screen_buffer, create_date_file_path(_T("bmp")));
-	write_bitmap_to_file(&vm_screen_buffer, create_date_file_path(_T("png")));
-}
-
-bool OSD::start_record_video(int fps)
-{
-	if(fps > 0) {
-		rec_video_fps = fps;
-		rec_video_run_frames = rec_video_frames = 0;
-	}
-	bool show_dialog = (fps > 0);
-	
-	// initialize vfw
-	create_date_file_path(video_file_path, _MAX_PATH, _T("avi"));
-	AVIFileInit();
-	if(AVIFileOpen(&pAVIFile, video_file_path, OF_WRITE | OF_CREATE, NULL) != AVIERR_OK) {
-		return false;
-	}
-	if(video_screen_buffer.width != vm_screen_buffer.width || video_screen_buffer.height != vm_screen_buffer.height) {
-		initialize_screen_buffer(&video_screen_buffer, vm_screen_buffer.width, vm_screen_buffer.height, COLORONCOLOR);
-	}
-	
-	// stream header
-	AVISTREAMINFO strhdr;
-	memset(&strhdr, 0, sizeof(strhdr));
-	strhdr.fccType = streamtypeVIDEO;	// vids
-	strhdr.fccHandler = 0;
-	strhdr.dwScale = 1;
-	strhdr.dwRate = rec_video_fps;
-	strhdr.dwSuggestedBufferSize = video_screen_buffer.lpDib->bmiHeader.biSizeImage;
-	SetRect(&strhdr.rcFrame, 0, 0, video_screen_buffer.width, video_screen_buffer.height);
-	if(AVIFileCreateStream(pAVIFile, &pAVIStream, &strhdr) != AVIERR_OK) {
-		stop_record_video();
-		return false;
-	}
-	
-	// compression
-	AVICOMPRESSOPTIONS FAR * pOpts[1];
-	pOpts[0] = &AVIOpts;
-	if(show_dialog && !AVISaveOptions(main_window_handle, ICMF_CHOOSE_KEYFRAME | ICMF_CHOOSE_DATARATE, 1, &pAVIStream, (LPAVICOMPRESSOPTIONS FAR *)&pOpts)) {
-		AVISaveOptionsFree(1, (LPAVICOMPRESSOPTIONS FAR *)&pOpts);
-		stop_record_video();
-		return false;
-	}
-	if(AVIMakeCompressedStream(&pAVICompressed, pAVIStream, &AVIOpts, NULL) != AVIERR_OK) {
-		stop_record_video();
-		return false;
-	}
-	if(AVIStreamSetFormat(pAVICompressed, 0, &video_screen_buffer.lpDib->bmiHeader, video_screen_buffer.lpDib->bmiHeader.biSize + video_screen_buffer.lpDib->bmiHeader.biClrUsed * sizeof(RGBQUAD)) != AVIERR_OK) {
-		stop_record_video();
-		return false;
-	}
-	dwAVIFileSize = 0;
-	lAVIFrames = 0;
-	
-	hVideoThread = (HANDLE)0;
-	rec_video_thread_param.pAVICompressed = pAVICompressed;
-	rec_video_thread_param.lpBmp = video_screen_buffer.lpBmp;
-	rec_video_thread_param.pbmInfoHeader = &video_screen_buffer.lpDib->bmiHeader;
-	rec_video_thread_param.dwAVIFileSize = 0;
-	rec_video_thread_param.lAVIFrames = 0;
-	rec_video_thread_param.frames = 0;
-	rec_video_thread_param.result = 0;
-	
-	now_record_video = true;
-	return true;
-}
-
-void OSD::stop_record_video()
-{
-	// release thread
-	if(hVideoThread != (HANDLE)0) {
-		WaitForSingleObject(hVideoThread, INFINITE);
-		hVideoThread = (HANDLE)0;
-	}
-	
-	// release vfw
-	if(pAVIStream) {
-		AVIStreamClose(pAVIStream);
-	}
-	if(pAVICompressed) {
-		AVIStreamClose(pAVICompressed);
-	}
-	if(pAVIFile) {
-		AVIFileClose(pAVIFile);
-		AVIFileExit();
-	}
-	pAVIStream = NULL;
-	pAVICompressed = NULL;
-	pAVIFile = NULL;
-	
-	// repair header
-	if(now_record_video) {
-		FILE* fp = NULL;
-		if((fp = _tfopen(video_file_path, _T("r+b"))) != NULL) {
-			// copy fccHandler
-			uint8_t buf[4];
-			fseek(fp, 0xbc, SEEK_SET);
-			if(ftell(fp) == 0xbc) {
-				fread(buf, 4, 1, fp);
-				fseek(fp, 0x70, SEEK_SET);
-				fwrite(buf, 4, 1, fp);
-			}
-			fclose(fp);
-		}
-	}
-	now_record_video = false;
-}
-
-void OSD::restart_record_video()
-{
-	bool tmp = now_record_video;
-	stop_record_video();
-	if(tmp) {
-		start_record_video(-1);
-	}
-}
-
-void OSD::add_extra_frames(int extra_frames)
-{
-	rec_video_run_frames += extra_frames;
-}
-
-unsigned __stdcall rec_video_thread(void *lpx)
-{
-	volatile rec_video_thread_param_t *p = (rec_video_thread_param_t *)lpx;
-	LONG lBytesWritten;
-	int result = REC_VIDEO_SUCCESS;
-	
-	while(p->frames > 0) {
-		if(AVIStreamWrite(p->pAVICompressed, p->lAVIFrames++, 1, (LPBYTE)p->lpBmp, p->pbmInfoHeader->biSizeImage, AVIIF_KEYFRAME, NULL, &lBytesWritten) == AVIERR_OK) {
-			p->frames--;
-			// if avi file size > (2GB - 16MB), create new avi file
-			if((p->dwAVIFileSize += lBytesWritten) >= 2130706432) {
-				result = REC_VIDEO_FULL;
-				break;
-			}
-		} else {
-			result = REC_VIDEO_ERROR;
-			break;
-		}
-	}
-	p->result = result;
-	_endthreadex(0);
-	return 0;
-}
-
-int OSD::add_video_frames()
-{
-	static double frames = 0;
-	static int prev_video_fps = -1;
-	int counter = 0;
-	static double prev_vm_fps = -1;
-	double vm_fps = vm->get_frame_rate();
-	
-	if(prev_video_fps != rec_video_fps || prev_vm_fps != vm_fps) {
-		prev_video_fps = rec_video_fps;
-		prev_vm_fps = vm_fps;
-		frames = vm_fps / rec_video_fps;
-	}
-	while(rec_video_run_frames > 0) {
-		rec_video_run_frames -= frames;
-		rec_video_frames += frames;
-		counter++;
-	}
-	if(counter != 0) {
-		if(hVideoThread != (HANDLE)0) {
-			if(rec_video_thread_param.result == 0) {
-				WaitForSingleObject(hVideoThread, INFINITE);
-			}
-			hVideoThread = (HANDLE)0;
-			
-			if(rec_video_thread_param.result == REC_VIDEO_FULL) {
-				stop_record_video();
-				if(!start_record_video(-1)) {
-					return 0;
-				}
-			} else if(rec_video_thread_param.result == REC_VIDEO_ERROR) {
-				stop_record_video();
-				return 0;
-			}
-		}
-//		BitBlt(vm_screen_buffer.hdcDib, 0, 0, vm_screen_buffer.width, vm_screen_buffer.height, video_screen_buffer.hdcDib, 0, 0, SRCCOPY);
-		memcpy(video_screen_buffer.lpBmp, vm_screen_buffer.lpBmp, sizeof(scrntype_t) * vm_screen_buffer.width * vm_screen_buffer.height);
-		
-		rec_video_thread_param.frames += counter;
-		rec_video_thread_param.result = 0;
-		if((hVideoThread = (HANDLE)_beginthreadex(NULL, 0, rec_video_thread, &rec_video_thread_param, 0, NULL)) == (HANDLE)0) {
-			stop_record_video();
-			return 0;
-		}
-	}
-	return counter;
-}
-
-#ifdef USE_PRINTER
-void OSD::create_bitmap(bitmap_t *bitmap, int width, int height)
-{
-	initialize_screen_buffer(bitmap, width, height, HALFTONE);
-}
-
-void OSD::release_bitmap(bitmap_t *bitmap)
-{
-	release_screen_buffer(bitmap);
-}
-
-void OSD::create_font(font_t *font, const _TCHAR *family, int width, int height, int rotate, bool bold, bool italic)
-{
-	LOGFONT logfont;
-	memset(&logfont, 0, sizeof(logfont));
-	logfont.lfEscapement = font->rotate = rotate;
-	logfont.lfOrientation = 0;
-	logfont.lfWeight = (font->bold = bold) ? FW_BOLD : FW_NORMAL;
-	logfont.lfItalic = (font->italic = italic) ? TRUE : FALSE;
-	logfont.lfUnderline = FALSE;
-	logfont.lfStrikeOut = FALSE;
-	logfont.lfCharSet = SHIFTJIS_CHARSET;
-	logfont.lfOutPrecision = OUT_TT_PRECIS;
-	logfont.lfClipPrecision = CLIP_DEFAULT_PRECIS;
-	logfont.lfQuality = DEFAULT_QUALITY; 
-	logfont.lfPitchAndFamily = FIXED_PITCH | FF_DONTCARE;
-	if(_tcsicmp(family, _T("Gothic")) == 0) {
-		my_tcscpy_s(logfont.lfFaceName, LF_FACESIZE, _T("MS Gothic"));
-		my_tcscpy_s(font->family, 64, _T("Gothic"));
-	} if(_tcsicmp(family, _T("PGothic")) == 0) {
-		my_tcscpy_s(logfont.lfFaceName, LF_FACESIZE, _T("MS PGothic"));
-		my_tcscpy_s(font->family, 64, _T("Gothic"));
-	} else if(_tcsicmp(family, _T("Mincho")) == 0) {
-		my_tcscpy_s(logfont.lfFaceName, LF_FACESIZE, _T("MS Mincho"));
-		my_tcscpy_s(font->family, 64, _T("Mincho"));
-	} else if(_tcsicmp(family, _T("PMincho")) == 0) {
-		my_tcscpy_s(logfont.lfFaceName, LF_FACESIZE, _T("MS PMincho"));
-		my_tcscpy_s(font->family, 64, _T("Mincho"));
-	} else {
-		my_tcscpy_s(logfont.lfFaceName, LF_FACESIZE, _T("MS Gothic"));
-		my_tcscpy_s(font->family, 64, _T("Gothic"));
-	}
-	logfont.lfHeight = font->height = height;
-	logfont.lfWidth = font->width = width;
-	font->hFont = CreateFontIndirect(&logfont);
-}
-
-void OSD::release_font(font_t *font)
-{
-	if(font->initialized()) {
-		DeleteObject(font->hFont);
-		font->hFont = NULL;
-	}
-}
-
-void OSD::create_pen(pen_t *pen, int width, uint8_t r, uint8_t g, uint8_t b)
-{
-	pen->hPen = CreatePen(PS_SOLID, (pen->width = width), RGB((pen->r = r), (pen->g = g), (pen->b = b)));
-}
-
-void OSD::release_pen(pen_t *pen)
-{
-	if(pen->initialized()) {
-		DeleteObject(pen->hPen);
-		pen->hPen = NULL;
-	}
-}
-
-void OSD::clear_bitmap(bitmap_t *bitmap, uint8_t r, uint8_t g, uint8_t b)
-{
-	draw_rectangle_to_bitmap(bitmap, 0, 0, bitmap->width, bitmap->height, r, g, b);
-}
-
-int OSD::get_text_width(bitmap_t *bitmap, font_t *font, const char *text)
-{
-	HFONT hFontOld = (HFONT)SelectObject(bitmap->hdcDib, font->hFont);
-	SIZE size;
-#ifdef _UNICODE
-	_TCHAR unicode[1024];
-	MultiByteToWideChar(CP_ACP, 0, text, -1, unicode, 1024);
-	GetTextExtentPoint32(bitmap->hdcDib, unicode, (int)wcslen(unicode), &size);
-#else
-	GetTextExtentPoint32(bitmap->hdcDib, text, (int)strlen(text), &size);
-#endif
-	SelectObject(bitmap->hdcDib, hFontOld);
-	return (int)size.cx;
-}
-
-void OSD::draw_text_to_bitmap(bitmap_t *bitmap, font_t *font, int x, int y, const char *text, uint8_t r, uint8_t g, uint8_t b)
-{
-	HFONT hFontOld = (HFONT)SelectObject(bitmap->hdcDib, font->hFont);
-	SetBkMode(bitmap->hdcDib, TRANSPARENT);
-	SetTextColor(bitmap->hdcDib, RGB(r, g, b));
-#ifdef _UNICODE
-	_TCHAR unicode[1024];
-	MultiByteToWideChar(CP_ACP, 0, text, -1, unicode, 1024);
-	ExtTextOut(bitmap->hdcDib, x, y, NULL, NULL, unicode, (UINT)wcslen(unicode), NULL);
-#else
-	ExtTextOut(bitmap->hdcDib, x, y, NULL, NULL, text, (UINT)strlen(text), NULL);
-#endif
-	SelectObject(bitmap->hdcDib, hFontOld);
-}
-
-void OSD::draw_line_to_bitmap(bitmap_t *bitmap, pen_t *pen, int sx, int sy, int ex, int ey)
-{
-	HPEN hPenOld = (HPEN)SelectObject(bitmap->hdcDib, pen->hPen);
-	MoveToEx(bitmap->hdcDib, sx, sy, NULL);
-	LineTo(bitmap->hdcDib, ex, ey);
-	SelectObject(bitmap->hdcDib, hPenOld);
-}
-
-void OSD::draw_rectangle_to_bitmap(bitmap_t *bitmap, int x, int y, int width, int height, uint8_t r, uint8_t g, uint8_t b)
-{
-	for(int yy = 0; yy < height; yy++) {
-		for(int xx = 0; xx < width; xx++) {
-			draw_point_to_bitmap(bitmap, x + xx, y + yy, r, g, b);
-		}
-	}
-}
-
-void OSD::draw_point_to_bitmap(bitmap_t *bitmap, int x, int y, uint8_t r, uint8_t g, uint8_t b)
-{
-	if(x >= 0 && x < bitmap->width && y >= 0 && y < bitmap->height) {
-		scrntype_t *dest = bitmap->get_buffer(y);
-		dest[x] = RGB_COLOR(r, g, b);
-	}
-}
-
-void OSD::stretch_bitmap(bitmap_t *dest, int dest_x, int dest_y, int dest_width, int dest_height, bitmap_t *source, int source_x, int source_y, int source_width, int source_height)
-{
-	if(dest_width == source_width && dest_height == source_height) {
-		BitBlt(dest->hdcDib, dest_x, dest_y, dest_width, dest_height, source->hdcDib, source_x, source_y, SRCCOPY);
-	} else {
-		StretchBlt(dest->hdcDib, dest_x, dest_y, dest_width, dest_height, source->hdcDib, source_x, source_y, source_width, source_height, SRCCOPY);
-	}
-}
-#endif
-
-bool GetEncoderClsid(const WCHAR* format, CLSID* pClsid)
-{
-	UINT num = 0, size = 0;
-	
-	GetImageEncodersSize(&num, &size);
-	if(size == 0) {
-		return false;
-	}
-	ImageCodecInfo* pImageCodecInfo = (ImageCodecInfo*)malloc(size);
-	if(pImageCodecInfo == NULL) {
-		return false;
-	}
-	GetImageEncoders(num, size, pImageCodecInfo);
-	
-	for(UINT j = 0; j < num; ++j) {
-		if(wcscmp(pImageCodecInfo[j].MimeType, format) == 0) {
-			*pClsid = pImageCodecInfo[j].Clsid;
-			free(pImageCodecInfo);
-			return true;
-		}
-	}
-	free(pImageCodecInfo);
-	return false;
-}
-
-void OSD::write_bitmap_to_file(bitmap_t *bitmap, const _TCHAR *file_path)
-{
-	if(check_file_extension(file_path, _T(".bmp"))) {
-		// save as bmp file
-		BITMAPFILEHEADER bmFileHeader = { (WORD)(TEXT('B') | TEXT('M') << 8) };
-		bmFileHeader.bfOffBits = sizeof(BITMAPFILEHEADER) + sizeof(BITMAPINFOHEADER);
-		bmFileHeader.bfSize = bmFileHeader.bfOffBits + bitmap->lpDib->bmiHeader.biSizeImage;
-		
-		DWORD dwSize;
-		HANDLE hFile = CreateFile(file_path, GENERIC_WRITE, 0, NULL, CREATE_ALWAYS, FILE_ATTRIBUTE_NORMAL, NULL);
-		WriteFile(hFile, &bmFileHeader, sizeof(BITMAPFILEHEADER), &dwSize, NULL);
-		WriteFile(hFile, bitmap->lpDib, sizeof(BITMAPINFOHEADER), &dwSize, NULL);
-		WriteFile(hFile, bitmap->lpBmp, bitmap->lpDib->bmiHeader.biSizeImage, &dwSize, NULL);
-		CloseHandle(hFile);
-	} else if(check_file_extension(file_path, _T(".png"))) {
-		// save as png file
-		CLSID encoderClsid;
-		if(GetEncoderClsid(L"image/png", &encoderClsid)) {
-			Bitmap image(bitmap->hBmp, (HPALETTE)GetStockObject(DEFAULT_PALETTE));
-#ifdef _UNICODE
-			image.Save(file_path, &encoderClsid, NULL);
-#else
-			WCHAR wszFilePath[_MAX_PATH];
-			MultiByteToWideChar(CP_ACP, 0, file_path, -1, wszFilePath, _MAX_PATH);
-			image.Save(wszFilePath, &encoderClsid, NULL);
-#endif
-		}
-	}
-}
-
diff -ruN source/src/win32/osd_socket.cpp src/win32/osd_socket.cpp
--- source/src/win32/osd_socket.cpp	2016-03-01 00:00:00
+++ src/win32/osd_socket.cpp	1970-01-01 09:00:00
@@ -1,242 +0,0 @@
-/*
-	Skelton for retropc emulator
-
-	Author : Takeda.Toshiya
-	Date   : 2015.11.26-
-
-	[ win32 socket ]
-*/
-
-#include "osd.h"
-
-void OSD::initialize_socket()
-{
-	// init winsock
-	WSADATA wsaData;
-	WSAStartup(0x0101, &wsaData);
-	
-	// init sockets
-	for(int i = 0; i < SOCKET_MAX; i++) {
-		soc[i] = INVALID_SOCKET;
-		socket_delay[i] = 0;
-		recv_r_ptr[i] = recv_w_ptr[i] = 0;
-	}
-}
-
-void OSD::release_socket()
-{
-	// release sockets
-	for(int i = 0; i < SOCKET_MAX; i++) {
-		if(soc[i] != INVALID_SOCKET) {
-			shutdown(soc[i], 2);
-			closesocket(soc[i]);
-		}
-	}
-	
-	// release winsock
-	WSACleanup();
-}
-
-void OSD::notify_socket_connected(int ch)
-{
-	// winmain notify that network is connected
-	vm->notify_socket_connected(ch);
-}
-
-void OSD::notify_socket_disconnected(int ch)
-{
-	// winmain notify that network is disconnected
-	if(!socket_delay[ch]) {
-		socket_delay[ch] = 1;//56;
-	}
-}
-
-void OSD::update_socket()
-{
-	for(int i = 0; i < SOCKET_MAX; i++) {
-		if(recv_r_ptr[i] < recv_w_ptr[i]) {
-			// get buffer
-			int size0, size1;
-			uint8_t* buf0 = vm->get_socket_recv_buffer0(i, &size0, &size1);
-			uint8_t* buf1 = vm->get_socket_recv_buffer1(i);
-			
-			int size = recv_w_ptr[i] - recv_r_ptr[i];
-			if(size > size0 + size1) {
-				size = size0 + size1;
-			}
-			char* src = &recv_buffer[i][recv_r_ptr[i]];
-			recv_r_ptr[i] += size;
-			
-			if(size <= size0) {
-				memcpy(buf0, src, size);
-			} else {
-				memcpy(buf0, src, size0);
-				memcpy(buf1, src + size0, size - size0);
-			}
-			vm->inc_socket_recv_buffer_ptr(i, size);
-		} else if(socket_delay[i] != 0) {
-			if(--socket_delay[i] == 0) {
-				vm->notify_socket_disconnected(i);
-			}
-		}
-	}
-}
-
-bool OSD::initialize_socket_tcp(int ch)
-{
-	is_tcp[ch] = true;
-	
-	if(soc[ch] != INVALID_SOCKET) {
-		disconnect_socket(ch);
-	}
-	if((soc[ch] = socket(PF_INET, SOCK_STREAM, 0)) == INVALID_SOCKET) {
-		return false;
-	}
-	if(WSAAsyncSelect(soc[ch], main_window_handle, WM_SOCKET0 + ch, FD_CONNECT | FD_WRITE | FD_READ | FD_CLOSE) == SOCKET_ERROR) {
-		closesocket(soc[ch]);
-		soc[ch] = INVALID_SOCKET;
-		return false;
-	}
-	recv_r_ptr[ch] = recv_w_ptr[ch] = 0;
-	return true;
-}
-
-bool OSD::initialize_socket_udp(int ch)
-{
-	is_tcp[ch] = false;
-	
-	disconnect_socket(ch);
-	if((soc[ch] = socket(PF_INET, SOCK_DGRAM, 0)) == INVALID_SOCKET) {
-		return false;
-	}
-	if(WSAAsyncSelect(soc[ch], main_window_handle, WM_SOCKET0 + ch, FD_CONNECT | FD_WRITE | FD_READ | FD_CLOSE) == SOCKET_ERROR) {
-		closesocket(soc[ch]);
-		soc[ch] = INVALID_SOCKET;
-		return false;
-	}
-	recv_r_ptr[ch] = recv_w_ptr[ch] = 0;
-	return true;
-}
-
-bool OSD::connect_socket(int ch, uint32_t ipaddr, int port)
-{
-	struct sockaddr_in tcpaddr;
-	tcpaddr.sin_family = AF_INET;
-	tcpaddr.sin_addr.s_addr = ipaddr;
-	tcpaddr.sin_port = htons((unsigned short)port);
-	memset(tcpaddr.sin_zero, (int)0, sizeof(tcpaddr.sin_zero));
-	
-	if(connect(soc[ch], (struct sockaddr *)&tcpaddr, sizeof(tcpaddr)) == SOCKET_ERROR) {
-		if(WSAGetLastError() != WSAEWOULDBLOCK) {
-			return false;
-		}
-	}
-	return true;
-}
-
-void OSD::disconnect_socket(int ch)
-{
-	if(soc[ch] != INVALID_SOCKET) {
-		shutdown(soc[ch], 2);
-		closesocket(soc[ch]);
-		soc[ch] = INVALID_SOCKET;
-	}
-	vm->notify_socket_disconnected(ch);
-}
-
-bool OSD::listen_socket(int ch)
-{
-	return false;
-}
-
-void OSD::send_socket_data_tcp(int ch)
-{
-	if(is_tcp[ch]) {
-		send_socket_data(ch);
-	}
-}
-
-void OSD::send_socket_data_udp(int ch, uint32_t ipaddr, int port)
-{
-	if(!is_tcp[ch]) {
-		udpaddr[ch].sin_family = AF_INET;
-		udpaddr[ch].sin_addr.s_addr = ipaddr;
-		udpaddr[ch].sin_port = htons((unsigned short)port);
-		memset(udpaddr[ch].sin_zero, (int)0, sizeof(udpaddr[ch].sin_zero));
-		
-		send_socket_data(ch);
-	}
-}
-
-void OSD::send_socket_data(int ch)
-{
-	// loop while send buffer is not emupty or not WSAEWOULDBLOCK
-	while(1) {
-		// get send buffer and data size
-		int size;
-		uint8_t* buf = vm->get_socket_send_buffer(ch, &size);
-		
-		if(!size) {
-			return;
-		}
-		if(is_tcp[ch]) {
-			if((size = send(soc[ch], (char *)buf, size, 0)) == SOCKET_ERROR) {
-				// if WSAEWOULDBLOCK, WM_SOCKET* and FD_WRITE will come later
-				if(WSAGetLastError() != WSAEWOULDBLOCK) {
-					disconnect_socket(ch);
-					notify_socket_disconnected(ch);
-				}
-				return;
-			}
-		} else {
-			if((size = sendto(soc[ch], (char *)buf, size, 0, (struct sockaddr *)&udpaddr[ch], sizeof(udpaddr[ch]))) == SOCKET_ERROR) {
-				// if WSAEWOULDBLOCK, WM_SOCKET* and FD_WRITE will come later
-				if(WSAGetLastError() != WSAEWOULDBLOCK) {
-					disconnect_socket(ch);
-					notify_socket_disconnected(ch);
-				}
-				return;
-			}
-		}
-		vm->inc_socket_send_buffer_ptr(ch, size);
-	}
-}
-
-void OSD::recv_socket_data(int ch)
-{
-	if(is_tcp[ch]) {
-		int size = SOCKET_BUFFER_MAX - recv_w_ptr[ch];
-		char* buf = &recv_buffer[ch][recv_w_ptr[ch]];
-		if((size = recv(soc[ch], buf, size, 0)) == SOCKET_ERROR) {
-			disconnect_socket(ch);
-			notify_socket_disconnected(ch);
-			return;
-		}
-		recv_w_ptr[ch] += size;
-	} else {
-		SOCKADDR_IN addr;
-		int len = sizeof(addr);
-		int size = SOCKET_BUFFER_MAX - recv_w_ptr[ch];
-		char* buf = &recv_buffer[ch][recv_w_ptr[ch]];
-		
-		if(size < 8) {
-			return;
-		}
-		if((size = recvfrom(soc[ch], buf + 8, size - 8, 0, (struct sockaddr *)&addr, &len)) == SOCKET_ERROR) {
-			disconnect_socket(ch);
-			notify_socket_disconnected(ch);
-			return;
-		}
-		size += 8;
-		buf[0] = size >> 8;
-		buf[1] = size;
-		buf[2] = (char)addr.sin_addr.s_addr;
-		buf[3] = (char)(addr.sin_addr.s_addr >> 8);
-		buf[4] = (char)(addr.sin_addr.s_addr >> 16);
-		buf[5] = (char)(addr.sin_addr.s_addr >> 24);
-		buf[6] = (char)addr.sin_port;
-		buf[7] = (char)(addr.sin_port >> 8);
-		recv_w_ptr[ch] += size;
-	}
-}
-
diff -ruN source/src/win32/osd_sound.cpp src/win32/osd_sound.cpp
--- source/src/win32/osd_sound.cpp	2018-10-07 22:00:00
+++ src/win32/osd_sound.cpp	1970-01-01 09:00:00
@@ -1,275 +0,0 @@
-/*
-	Skelton for retropc emulator
-
-	Author : Takeda.Toshiya
-	Date   : 2015.11.26-
-
-	[ win32 sound ]
-*/
-
-#include "osd.h"
-#include "../fileio.h"
-
-#define DSOUND_BUFFER_SIZE (DWORD)(sound_samples * 8)
-#define DSOUND_BUFFER_HALF (DWORD)(sound_samples * 4)
-
-void OSD::initialize_sound(int rate, int samples)
-{
-	sound_rate = rate;
-	sound_samples = samples;
-	sound_available = sound_started = sound_muted = now_record_sound = false;
-	rec_sound_buffer_ptr = 0;
-	
-	// initialize direct sound
-	PCMWAVEFORMAT pcmwf;
-	DSBUFFERDESC dsbd;
-	WAVEFORMATEX wfex;
-	
-	if(FAILED(DirectSoundCreate(NULL, &lpds, NULL))) {
-		return;
-	}
-	if(FAILED(lpds->SetCooperativeLevel(main_window_handle, DSSCL_PRIORITY))) {
-		return;
-	}
-	
-	// primary buffer
-	ZeroMemory(&dsbd, sizeof(dsbd));
-	dsbd.dwSize = sizeof(dsbd);
-	dsbd.dwFlags = DSBCAPS_PRIMARYBUFFER;
-	if(FAILED(lpds->CreateSoundBuffer(&dsbd, &lpdsPrimaryBuffer, NULL))) {
-		return;
-	}
-	ZeroMemory(&wfex, sizeof(wfex));
-	wfex.wFormatTag = WAVE_FORMAT_PCM;
-	wfex.nChannels = 2;
-	wfex.wBitsPerSample = 16;
-	wfex.nSamplesPerSec = sound_rate;
-	wfex.nBlockAlign = wfex.nChannels * wfex.wBitsPerSample / 8;
-	wfex.nAvgBytesPerSec = wfex.nSamplesPerSec * wfex.nBlockAlign;
-	if(FAILED(lpdsPrimaryBuffer->SetFormat(&wfex))) {
-		return;
-	}
-	
-	// secondary buffer
-	ZeroMemory(&pcmwf, sizeof(pcmwf));
-	pcmwf.wf.wFormatTag = WAVE_FORMAT_PCM;
-	pcmwf.wf.nChannels = 2;
-	pcmwf.wBitsPerSample = 16;
-	pcmwf.wf.nSamplesPerSec = sound_rate;
-	pcmwf.wf.nBlockAlign = pcmwf.wf.nChannels * pcmwf.wBitsPerSample / 8;
-	pcmwf.wf.nAvgBytesPerSec = pcmwf.wf.nSamplesPerSec * pcmwf.wf.nBlockAlign;
-	ZeroMemory(&dsbd, sizeof(dsbd));
-	dsbd.dwSize = sizeof(dsbd);
-	dsbd.dwFlags = DSBCAPS_STICKYFOCUS | DSBCAPS_GETCURRENTPOSITION2 | DSBCAPS_LOCSOFTWARE;
-	dsbd.dwBufferBytes = DSOUND_BUFFER_SIZE;
-	dsbd.lpwfxFormat = (LPWAVEFORMATEX)&pcmwf;
-	if(FAILED(lpds->CreateSoundBuffer(&dsbd, &lpdsSecondaryBuffer, NULL))) {
-		return;
-	}
-	
-	sound_available = sound_first_half = true;
-}
-
-void OSD::release_sound()
-{
-	// release direct sound
-	if(lpdsPrimaryBuffer) {
-		lpdsPrimaryBuffer->Release();
-		lpdsPrimaryBuffer = NULL;
-	}
-	if(lpdsSecondaryBuffer) {
-		lpdsSecondaryBuffer->Release();
-		lpdsSecondaryBuffer = NULL;
-	}
-	if(lpds) {
-		lpds->Release();
-		lpds = NULL;
-	}
-	
-	// stop recording
-	stop_record_sound();
-}
-
-void OSD::update_sound(int* extra_frames)
-{
-	*extra_frames = 0;
-#ifdef USE_DEBUGGER
-//	if(now_debugging) {
-//		return;
-//	}
-#endif
-	sound_muted = false;
-	
-	if(sound_available) {
-		DWORD play_c, write_c, offset, size1, size2;
-		WORD *ptr1, *ptr2;
-		
-		// start play
-		if(!sound_started) {
-			lpdsSecondaryBuffer->Play(0, 0, DSBPLAY_LOOPING);
-			sound_started = true;
-			return;
-		}
-		
-		// check current position
-		if(FAILED(lpdsSecondaryBuffer->GetCurrentPosition(&play_c, &write_c))) {
-			return;
-		}
-		if(sound_first_half) {
-			if(play_c < DSOUND_BUFFER_HALF) {
-				return;
-			}
-			offset = 0;
-		} else {
-			if(play_c >= DSOUND_BUFFER_HALF) {
-				return;
-			}
-			offset = DSOUND_BUFFER_HALF;
-		}
-		
-		// sound buffer must be updated
-		uint16_t* sound_buffer = vm->create_sound(extra_frames);
-		if(now_record_sound) {
-			// record sound
-			if(sound_samples > rec_sound_buffer_ptr) {
-				int samples = sound_samples - rec_sound_buffer_ptr;
-				int length = samples * sizeof(uint16_t) * 2; // stereo
-				rec_sound_fio->Fwrite(sound_buffer + rec_sound_buffer_ptr * 2, length, 1);
-				rec_sound_bytes += length;
-				if(now_record_video) {
-					// sync video recording
-					static double frames = 0;
-					static int prev_samples = -1;
-					static double prev_fps = -1;
-					double fps = vm->get_frame_rate();
-					if(prev_samples != samples || prev_fps != fps) {
-						prev_samples = samples;
-						prev_fps = fps;
-						frames = fps * (double)samples / (double)sound_rate;
-					}
-					rec_video_frames -= frames;
-					if(rec_video_frames > 2) {
-						rec_video_run_frames -= (rec_video_frames - 2);
-					} else if(rec_video_frames < -2) {
-						rec_video_run_frames -= (rec_video_frames + 2);
-					}
-//					rec_video_run_frames -= rec_video_frames;
-				}
-			}
-			rec_sound_buffer_ptr = 0;
-		}
-		if(lpdsSecondaryBuffer->Lock(offset, DSOUND_BUFFER_HALF, (void **)&ptr1, &size1, (void**)&ptr2, &size2, 0) == DSERR_BUFFERLOST) {
-			lpdsSecondaryBuffer->Restore();
-		}
-		if(sound_buffer) {
-			if(ptr1) {
-				CopyMemory(ptr1, sound_buffer, size1);
-			}
-			if(ptr2) {
-				CopyMemory(ptr2, sound_buffer + size1, size2);
-			}
-		}
-		lpdsSecondaryBuffer->Unlock(ptr1, size1, ptr2, size2);
-		sound_first_half = !sound_first_half;
-	}
-}
-
-void OSD::mute_sound()
-{
-	if(sound_available && !sound_muted) {
-		// check current position
-		DWORD size1, size2;
-		WORD *ptr1, *ptr2;
-		
-		if(lpdsSecondaryBuffer->Lock(0, DSOUND_BUFFER_SIZE, (void **)&ptr1, &size1, (void**)&ptr2, &size2, 0) == DSERR_BUFFERLOST) {
-			lpdsSecondaryBuffer->Restore();
-		}
-		if(ptr1) {
-			ZeroMemory(ptr1, size1);
-		}
-		if(ptr2) {
-			ZeroMemory(ptr2, size2);
-		}
-		lpdsSecondaryBuffer->Unlock(ptr1, size1, ptr2, size2);
-	}
-	sound_muted = true;
-}
-
-void OSD::stop_sound()
-{
-	if(sound_available && sound_started) {
-		lpdsSecondaryBuffer->Stop();
-		sound_started = false;
-	}
-}
-
-void OSD::start_record_sound()
-{
-	if(!now_record_sound) {
-		// create wave file
-		create_date_file_path(sound_file_path, _MAX_PATH, _T("wav"));
-		rec_sound_fio = new FILEIO();
-		if(rec_sound_fio->Fopen(sound_file_path, FILEIO_WRITE_BINARY)) {
-			// write dummy wave header
-			wav_header_t wav_header;
-			wav_chunk_t wav_chunk;
-			memset(&wav_header, 0, sizeof(wav_header));
-			memset(&wav_chunk, 0, sizeof(wav_chunk));
-			rec_sound_fio->Fwrite(&wav_header, sizeof(wav_header), 1);
-			rec_sound_fio->Fwrite(&wav_chunk, sizeof(wav_chunk), 1);
-			
-			rec_sound_bytes = 0;
-			rec_sound_buffer_ptr = vm->get_sound_buffer_ptr();
-			now_record_sound = true;
-		} else {
-			// failed to open the wave file
-			delete rec_sound_fio;
-		}
-	}
-}
-
-void OSD::stop_record_sound()
-{
-	if(now_record_sound) {
-		if(rec_sound_bytes == 0) {
-			rec_sound_fio->Fclose();
-			FILEIO::RemoveFile(sound_file_path);
-		} else {
-			// update wave header
-			wav_header_t wav_header;
-			wav_chunk_t wav_chunk;
-			
-			memcpy(wav_header.riff_chunk.id, "RIFF", 4);
-			wav_header.riff_chunk.size = rec_sound_bytes + sizeof(wav_header) + sizeof(wav_chunk) - 8;
-			memcpy(wav_header.wave, "WAVE", 4);
-			memcpy(wav_header.fmt_chunk.id, "fmt ", 4);
-			wav_header.fmt_chunk.size = 16;
-			wav_header.format_id = 1;
-			wav_header.channels = 2;
-			wav_header.sample_bits = 16;
-			wav_header.sample_rate = sound_rate;
-			wav_header.block_size = wav_header.channels * wav_header.sample_bits / 8;
-			wav_header.data_speed = wav_header.sample_rate * wav_header.block_size;
-			
-			memcpy(wav_chunk.id, "data", 4);
-			wav_chunk.size = rec_sound_bytes;
-			
-			rec_sound_fio->Fseek(0, FILEIO_SEEK_SET);
-			rec_sound_fio->Fwrite(&wav_header, sizeof(wav_header), 1);
-			rec_sound_fio->Fwrite(&wav_chunk, sizeof(wav_chunk), 1);
-			rec_sound_fio->Fclose();
-		}
-		delete rec_sound_fio;
-		now_record_sound = false;
-	}
-}
-
-void OSD::restart_record_sound()
-{
-	bool tmp = now_record_sound;
-	stop_record_sound();
-	if(tmp) {
-		start_record_sound();
-	}
-}
-
diff -ruN source/src/win32/osd_video.cpp src/win32/osd_video.cpp
--- source/src/win32/osd_video.cpp	2016-03-01 00:00:00
+++ src/win32/osd_video.cpp	1970-01-01 09:00:00
@@ -1,612 +0,0 @@
-/*
-	Skelton for retropc emulator
-
-	Author : Takeda.Toshiya
-	Date   : 2015.11.26-
-
-	[ win32 DirectShow ]
-*/
-
-#include "osd.h"
-
-void OSD::initialize_video()
-{
-	pBasicAudio = NULL;
-	pBasicVideo = NULL;
-	pVideoWindow = NULL;
-	pMediaPosition = NULL;
-	pMediaSeeking = NULL;
-	pMediaControl = NULL;
-	pSoundCallBack = NULL;
-	pSoundSampleGrabber = NULL;
-	pSoundBaseFilter = NULL;
-	pVideoSampleGrabber = NULL;
-	pCaptureGraphBuilder2 = NULL;
-	pCaptureBaseFilter = NULL;
-	pVideoBaseFilter = NULL;
-	pGraphBuilder = NULL;
-	
-	memset(&direct_show_screen_buffer, 0, sizeof(bitmap_t));
-	memset(&direct_show_stretch_buffer, 0, sizeof(bitmap_t));
-	
-	direct_show_mute[0] = direct_show_mute[1] = true;
-#ifdef USE_MOVIE_PLAYER
-	now_movie_play = now_movie_pause = false;
-#endif
-#ifdef USE_VIDEO_CAPTURE
-	enum_capture_devs();
-	cur_capture_dev_index = -1;
-#endif
-}
-
-#define SAFE_RELEASE(x) { \
-	if(x != NULL) { \
-		(x)->Release(); \
-		(x) = NULL; \
-	} \
-}
-
-void OSD::release_video()
-{
-	if(pMediaControl != NULL) {
-		pMediaControl->Stop();
-	}
-	SAFE_RELEASE(pBasicAudio);
-	SAFE_RELEASE(pBasicVideo);
-	SAFE_RELEASE(pVideoWindow);
-	SAFE_RELEASE(pMediaPosition);
-	SAFE_RELEASE(pMediaSeeking);
-	SAFE_RELEASE(pMediaControl);
-	SAFE_RELEASE(pSoundCallBack);
-	SAFE_RELEASE(pSoundSampleGrabber);
-	SAFE_RELEASE(pSoundBaseFilter);
-	SAFE_RELEASE(pVideoSampleGrabber);
-	SAFE_RELEASE(pCaptureGraphBuilder2);
-	SAFE_RELEASE(pCaptureBaseFilter);
-	SAFE_RELEASE(pVideoBaseFilter);
-	SAFE_RELEASE(pGraphBuilder);
-	
-	release_screen_buffer(&direct_show_screen_buffer);
-	release_screen_buffer(&direct_show_stretch_buffer);
-}
-
-void OSD::get_video_buffer()
-{
-	if(pVideoSampleGrabber != NULL) {
-#if defined(_RGB555) || defined(_RGB565)
-		long buffer_size = direct_show_width * direct_show_height * 2;
-#elif defined(_RGB888)
-		long buffer_size = direct_show_width * direct_show_height * 4;
-#endif
-		pVideoSampleGrabber->GetCurrentBuffer(&buffer_size, (long *)direct_show_screen_buffer.lpBmp);
-		if(vm_screen_width == direct_show_width && vm_screen_height == direct_show_height) {
-			if(bVerticalReversed) {
-				BitBlt(vm_screen_buffer.hdcDib, 0, vm_screen_height, vm_screen_width, -vm_screen_height, direct_show_screen_buffer.hdcDib, 0, 0, SRCCOPY);
-			} else {
-				BitBlt(vm_screen_buffer.hdcDib, 0, 0, vm_screen_width, vm_screen_height, direct_show_screen_buffer.hdcDib, 0, 0, SRCCOPY);
-			}
-		} else if(vm_screen_width <= direct_show_width && vm_screen_height <= direct_show_height) {
-			if(bVerticalReversed) {
-				StretchBlt(vm_screen_buffer.hdcDib, 0, vm_screen_height, vm_screen_width, -vm_screen_height, direct_show_screen_buffer.hdcDib, 0, 0, direct_show_width, direct_show_height, SRCCOPY);
-			} else {
-				StretchBlt(vm_screen_buffer.hdcDib, 0, 0, vm_screen_width, vm_screen_height, direct_show_screen_buffer.hdcDib, 0, 0, direct_show_width, direct_show_height, SRCCOPY);
-			}
-		} else {
-			int stretch_width = 0, stretch_height = 0;
-			while(stretch_width < vm_screen_width) {
-				stretch_width += direct_show_width;
-			}
-			while(stretch_height < vm_screen_height) {
-				stretch_height += direct_show_height;
-			}
-			if(direct_show_stretch_buffer.width != stretch_width || direct_show_stretch_buffer.height != stretch_height) {
-				initialize_screen_buffer(&direct_show_stretch_buffer, stretch_width, stretch_height, HALFTONE);
-			}
-			stretch_screen_buffer(&direct_show_screen_buffer, &direct_show_stretch_buffer);
-			if(bVerticalReversed) {
-				StretchBlt(vm_screen_buffer.hdcDib, 0, vm_screen_height, vm_screen_width, -vm_screen_height, direct_show_stretch_buffer.hdcDib, 0, 0, stretch_width, stretch_height, SRCCOPY);
-			} else {
-				StretchBlt(vm_screen_buffer.hdcDib, 0, 0, vm_screen_width, vm_screen_height, direct_show_stretch_buffer.hdcDib, 0, 0, stretch_width, stretch_height, SRCCOPY);
-			}
-		}
-	} else {
-		memset(vm_screen_buffer.lpBmp, 0, vm_screen_width * vm_screen_height * sizeof(scrntype_t));
-	}
-}
-
-void OSD::mute_video_dev(bool l, bool r)
-{
-	if(pBasicAudio != NULL) {
-		if(l && r) {
-			pBasicAudio->put_Volume(-10000L);
-		} else {
-			pBasicAudio->put_Volume(0L);
-		}
-		if(l && !r) {
-			pBasicAudio->put_Balance(1000L);
-		} else if(!l && r) {
-			pBasicAudio->put_Balance(-1000L);
-		} else {
-			pBasicAudio->put_Balance(0L);
-		}
-		direct_show_mute[0] = l;
-		direct_show_mute[1] = r;
-	}
-}
-
-#ifdef USE_MOVIE_PLAYER
-bool OSD::open_movie_file(const _TCHAR* file_path)
-{
-#ifdef _UNICODE
-	#define wFile file_path
-#else
-	WCHAR wFile[_MAX_PATH];
-	MultiByteToWideChar(CP_ACP, 0, file_path, -1, wFile, _MAX_PATH);
-#endif
-	
-	AM_MEDIA_TYPE video_mt;
-	ZeroMemory(&video_mt, sizeof(AM_MEDIA_TYPE));
-	video_mt.majortype = MEDIATYPE_Video;
-#if defined(_RGB555)
-	video_mt.subtype = MEDIASUBTYPE_RGB555;
-#elif defined(_RGB565)
-	video_mt.subtype = MEDIASUBTYPE_RGB565;
-#elif defined(_RGB888)
-	video_mt.subtype = MEDIASUBTYPE_RGB32;
-#endif
-	video_mt.formattype = FORMAT_VideoInfo;
-	
-	AM_MEDIA_TYPE sound_mt;
-	ZeroMemory(&sound_mt, sizeof(AM_MEDIA_TYPE));
-	sound_mt.majortype = MEDIATYPE_Audio;
-	sound_mt.subtype = MEDIASUBTYPE_PCM;
-	
-	if(FAILED(CoCreateInstance(CLSID_FilterGraph, NULL, CLSCTX_INPROC, IID_IGraphBuilder, (void **)&pGraphBuilder))) {
-		return false;
-	}
-	if(FAILED(CoCreateInstance(CLSID_SampleGrabber, NULL, CLSCTX_INPROC, IID_IBaseFilter, (void **)&pVideoBaseFilter))) {
-		return false;
-	}
-	if(FAILED(pVideoBaseFilter->QueryInterface(IID_ISampleGrabber, (void **)&pVideoSampleGrabber))) {
-		return false;
-	}
-	if(FAILED(pVideoSampleGrabber->SetMediaType(&video_mt))) {
-		return false;
-	}
-	if(FAILED(pGraphBuilder->AddFilter(pVideoBaseFilter, L"Video Sample Grabber"))) {
-		return false;
-	}
-	if(FAILED(CoCreateInstance(CLSID_SampleGrabber, NULL, CLSCTX_INPROC, IID_IBaseFilter, (void **)&pSoundBaseFilter))) {
-		return false;
-	}
-	if(FAILED(pSoundBaseFilter->QueryInterface(IID_ISampleGrabber, (void **)&pSoundSampleGrabber))) {
-		return false;
-	}
-	if(FAILED(pSoundSampleGrabber->SetMediaType(&sound_mt))) {
-		return false;
-	}
-	if((pSoundCallBack = new CMySampleGrabberCB(vm)) == NULL) {
-		return false;
-	}
-	if(FAILED(pSoundSampleGrabber->SetCallback(pSoundCallBack, 1))) {
-		return false;
-	}
-	if(FAILED(pGraphBuilder->AddFilter(pSoundBaseFilter, L"Sound Sample Grabber"))) {
-		return false;
-	}
-	if(FAILED(pGraphBuilder->RenderFile(wFile, NULL))) {
-		return false;
-	}
-	if(FAILED(pVideoSampleGrabber->SetBufferSamples(TRUE))) {
-		return false;
-	}
-	if(FAILED(pVideoSampleGrabber->SetOneShot(FALSE))) {
-		return false;
-	}
-	if(FAILED(pSoundSampleGrabber->SetBufferSamples(FALSE))) {
-		return false;
-	}
-	if(FAILED(pSoundSampleGrabber->SetOneShot(FALSE))) {
-		return false;
-	}
-	if(FAILED(pGraphBuilder->QueryInterface(IID_IMediaControl, (void **)&pMediaControl))) {
-		return false;
-	}
-	if(FAILED(pGraphBuilder->QueryInterface(IID_IMediaSeeking, (void **)&pMediaSeeking))) {
-		return false;
-	}
-	if(FAILED(pGraphBuilder->QueryInterface(IID_IMediaPosition, (void **)&pMediaPosition))) {
-		return false;
-	}
-	if(FAILED(pGraphBuilder->QueryInterface(IID_IVideoWindow, (void **)&pVideoWindow))) {
-		return false;
-	}
-	if(FAILED(pGraphBuilder->QueryInterface(IID_IBasicVideo, (void **)&pBasicVideo))) {
-		return false;
-	}
-	if(FAILED(pGraphBuilder->QueryInterface(IID_IBasicAudio, (void **)&pBasicAudio))) {
-		return false;
-	}
-	if(FAILED(pVideoWindow->put_Owner((OAHWND)main_window_handle))) {
-		return false;
-	}
-	if(FAILED(pVideoWindow->put_WindowStyle(WS_CHILD | WS_CLIPSIBLINGS | WS_CLIPCHILDREN))) {
-		return false;
-	}
-	if(FAILED(pVideoWindow->SetWindowPosition(0, 0, 0, 0))) {
-		return false;
-	}
-	if(FAILED(pVideoWindow->SetWindowForeground(FALSE))) {
-		return false;
-	}
-	if(pMediaSeeking->IsFormatSupported(&TIME_FORMAT_FRAME) == S_OK) {
-		if(FAILED(pMediaSeeking->SetTimeFormat(&TIME_FORMAT_FRAME))) {
-			return false;
-		}
-		bTimeFormatFrame = true;
-	} else {
-		if(FAILED(pMediaSeeking->SetTimeFormat(&TIME_FORMAT_MEDIA_TIME))) {
-			return false;
-		}
-		bTimeFormatFrame = false;
-	}
-	
-	// get the movie frame rate
-	if(FAILED(pBasicVideo->get_AvgTimePerFrame(&movie_frame_rate))) {
-		return false;
-	}
-	movie_frame_rate = 1 / movie_frame_rate;
-	
-	// get the movie sound rate
-	pSoundSampleGrabber->GetConnectedMediaType(&sound_mt);
-	WAVEFORMATEX *wf = (WAVEFORMATEX *)sound_mt.pbFormat;
-	WAVEFORMATEXTENSIBLE *wfe = (WAVEFORMATEXTENSIBLE *)sound_mt.pbFormat;
-	if(!((wf->wFormatTag == WAVE_FORMAT_PCM || (wf->wFormatTag == WAVE_FORMAT_EXTENSIBLE && wfe->SubFormat == MEDIASUBTYPE_PCM)) && wf->nChannels == 2 && wf->wBitsPerSample == 16)) {
-		return false;
-	}
-	movie_sound_rate = wf->nSamplesPerSec;
-	
-	// get the movie picture size
-	pVideoSampleGrabber->GetConnectedMediaType(&video_mt);
-	VIDEOINFOHEADER *pVideoHeader = (VIDEOINFOHEADER*)video_mt.pbFormat;
-	direct_show_width = pVideoHeader->bmiHeader.biWidth;
-	direct_show_height = pVideoHeader->bmiHeader.biHeight;
-	
-	bVerticalReversed = check_file_extension(file_path, _T(".ogv"));
-	
-	if(direct_show_screen_buffer.width != direct_show_width || direct_show_screen_buffer.height != direct_show_height) {
-		initialize_screen_buffer(&direct_show_screen_buffer, direct_show_width, direct_show_height, COLORONCOLOR);
-	}
-	return true;
-}
-
-void OSD::close_movie_file()
-{
-	release_video();
-	now_movie_play = false;
-	now_movie_pause = false;
-}
-
-void OSD::play_movie()
-{
-	if(pMediaControl != NULL) {
-		pMediaControl->Run();
-		mute_video_dev(direct_show_mute[0], direct_show_mute[1]);
-		now_movie_play = true;
-		now_movie_pause = false;
-	}
-}
-
-void OSD::stop_movie()
-{
-	if(pMediaControl != NULL) {
-		pMediaControl->Stop();
-	}
-	now_movie_play = false;
-	now_movie_pause = false;
-}
-
-void OSD::pause_movie()
-{
-	if(pMediaControl != NULL) {
-		pMediaControl->Pause();
-		now_movie_pause = true;
-	}
-}
-
-void OSD::set_cur_movie_frame(int frame, bool relative)
-{
-	if(pMediaSeeking != NULL) {
-		LONGLONG now = bTimeFormatFrame ? frame : (LONGLONG)(frame / movie_frame_rate * 10000000.0 + 0.5);
-		pMediaSeeking->SetPositions(&now, AM_SEEKING_AbsolutePositioning, NULL, AM_SEEKING_NoPositioning);
-	}
-}
-
-uint32_t OSD::get_cur_movie_frame()
-{
-	if(pMediaSeeking != NULL) {
-		LONGLONG now, stop;
-		if(SUCCEEDED(pMediaSeeking->GetPositions(&now, &stop))) {
-			if(bTimeFormatFrame) {
-				return (uint32_t)(now & 0xffffffff);
-			} else {
-				return (uint32_t)(now * movie_frame_rate / 10000000.0 + 0.5);
-			}
-		}
-	}
-	return 0;
-}
-#endif
-
-#ifdef USE_VIDEO_CAPTURE
-static LPSTR MyAtlW2AHelper(LPSTR lpa, LPCWSTR lpw, int nChars)
-{
-	lpa[0] = '\0';
-	WideCharToMultiByte(CP_ACP, 0, lpw, -1, lpa, nChars, NULL, NULL);
-	return lpa;
-}
-
-#include <malloc.h>
-
-#define MyW2T(lpw) (((_lpw = lpw) == NULL) ? NULL : (_convert = (lstrlenW(_lpw) + 1) * 2, MyAtlW2AHelper((LPSTR)_alloca(_convert), _lpw, _convert)))
-
-static IPin* get_pin(IBaseFilter *pFilter, PIN_DIRECTION PinDir)
-{
-	IEnumPins *pEnum;
-	IPin *pPin;
-	bool found = false;
-	
-	pFilter->EnumPins(&pEnum);
-	while(SUCCEEDED(pEnum->Next(1, &pPin, 0))) {
-		PIN_DIRECTION PinDirThis;
-		pPin->QueryDirection(&PinDirThis);
-		if(found = (PinDir == PinDirThis)) {
-			break;
-		}
-		SAFE_RELEASE(pPin);
-	}
-	SAFE_RELEASE(pEnum);
-	return found ? pPin : NULL;
-}
-
-void OSD::enum_capture_devs()
-{
-	ICreateDevEnum *pDevEnum = NULL;
-	IEnumMoniker *pClassEnum = NULL;
-	
-	num_capture_devs = 0;
-	
-	// create the system device enum
-	if(SUCCEEDED(CoCreateInstance(CLSID_SystemDeviceEnum, NULL, CLSCTX_INPROC, IID_ICreateDevEnum, (void **)&pDevEnum))) {
-		// create the video input device enu,
-		if(SUCCEEDED(pDevEnum->CreateClassEnumerator(CLSID_VideoInputDeviceCategory, &pClassEnum, 0)) && pClassEnum != NULL) {
-			ULONG cFetched;
-			IMoniker *pMoniker = NULL;
-			
-			while(num_capture_devs < MAX_CAPTURE_DEVS && SUCCEEDED(pClassEnum->Next(1, &pMoniker, &cFetched)) && pMoniker != NULL) {
-				IPropertyBag *pBag = NULL;
-				if(SUCCEEDED(pMoniker->BindToStorage(0, 0, IID_IPropertyBag, (void **)&pBag))) {
-					VARIANT var;
-					var.vt = VT_BSTR;
-					if(pBag->Read(L"FriendlyName", &var, NULL) == NOERROR) {
-						LPCWSTR _lpw = NULL;
-						int _convert = 0;
-						my_tcscpy_s(capture_dev_name[num_capture_devs++], 256, MyW2T(var.bstrVal));
-						SysFreeString(var.bstrVal);
-						pMoniker->AddRef();
-					}
-					SAFE_RELEASE(pBag);
-				}
-				SAFE_RELEASE(pMoniker);
-			}
-		}
-	}
-	SAFE_RELEASE(pClassEnum);
-	SAFE_RELEASE(pDevEnum);
-}
-
-bool OSD::connect_capture_dev(int index, bool pin)
-{
-	if(cur_capture_dev_index == index && !pin) {
-		return true;
-	}
-	if(cur_capture_dev_index != -1) {
-		release_video();
-		cur_capture_dev_index = -1;
-	}
-	
-	AM_MEDIA_TYPE mt;
-	ZeroMemory(&mt, sizeof(AM_MEDIA_TYPE));
-	mt.majortype = MEDIATYPE_Video;
-#if defined(_RGB555)
-	mt.subtype = MEDIASUBTYPE_RGB555;
-#elif defined(_RGB565)
-	mt.subtype = MEDIASUBTYPE_RGB565;
-#elif defined(_RGB888)
-	mt.subtype = MEDIASUBTYPE_RGB32;
-#endif
-	mt.formattype = FORMAT_VideoInfo;
-	
-	if(FAILED(CoCreateInstance(CLSID_FilterGraph, NULL, CLSCTX_INPROC, IID_IGraphBuilder, (void **)&pGraphBuilder))) {
-		return false;
-	}
-	
-	ICreateDevEnum *pDevEnum = NULL;
-	IEnumMoniker *pClassEnum = NULL;
-	
-	if(SUCCEEDED(CoCreateInstance(CLSID_SystemDeviceEnum, NULL, CLSCTX_INPROC, IID_ICreateDevEnum, (void **)&pDevEnum))) {
-		if(SUCCEEDED(pDevEnum->CreateClassEnumerator(CLSID_VideoInputDeviceCategory, &pClassEnum, 0)) && pClassEnum != NULL) {
-			for(int i = 0; i <= index; i++) {
-				IMoniker *pMoniker = NULL;
-				ULONG cFetched;
-				
-				if(SUCCEEDED(pClassEnum->Next(1, &pMoniker, &cFetched)) && pMoniker != NULL) {
-					if(i == index) {
-						pMoniker->BindToObject(0, 0, IID_IBaseFilter, (void **)&pCaptureBaseFilter);
-					}
-					SAFE_RELEASE(pMoniker);
-				} else {
-					break;
-				}
-			}
-		}
-	}
-	SAFE_RELEASE(pClassEnum);
-	SAFE_RELEASE(pDevEnum);
-	
-	if(&pCaptureBaseFilter == NULL) {
-		return false;
-	}
-	if(FAILED(pGraphBuilder->AddFilter(pCaptureBaseFilter, L"Video Capture"))) {
-		return false;
-	}
-	if(FAILED(CoCreateInstance(CLSID_CaptureGraphBuilder2, NULL, CLSCTX_INPROC, IID_ICaptureGraphBuilder2, (void **)&pCaptureGraphBuilder2))) {
-		return false;
-	}
-	if(FAILED(pCaptureGraphBuilder2->SetFiltergraph(pGraphBuilder))) {
-		return false;
-	}
-	
-	IAMStreamConfig *pSC = NULL;
-	ISpecifyPropertyPages *pSpec = NULL;
-	
-	if(FAILED(pCaptureGraphBuilder2->FindInterface(&PIN_CATEGORY_CAPTURE, &MEDIATYPE_Interleaved, pCaptureBaseFilter, IID_IAMStreamConfig, (void **)&pSC))) {
-		if(FAILED(pCaptureGraphBuilder2->FindInterface(&PIN_CATEGORY_CAPTURE, &MEDIATYPE_Video, pCaptureBaseFilter, IID_IAMStreamConfig, (void **)&pSC))) {
-			return false;
-		}
-	}
-	if(SUCCEEDED(pSC->QueryInterface(IID_ISpecifyPropertyPages, (void **)&pSpec))) {
-		CAUUID cauuid;
-		pSpec->GetPages(&cauuid);
-		if(pin) {
-			OleCreatePropertyFrame(NULL, 30, 30, NULL, 1, (IUnknown **)&pSC, cauuid.cElems, (GUID *)cauuid.pElems, 0, 0, NULL);
-			CoTaskMemFree(cauuid.pElems);
-		}
-		SAFE_RELEASE(pSpec);
-	}
-	SAFE_RELEASE(pSC);
-	
-	if(FAILED(CoCreateInstance(CLSID_SampleGrabber, NULL, CLSCTX_INPROC, IID_IBaseFilter, (void **)&pVideoBaseFilter))) {
-		return false;
-	}
-	if(FAILED(pVideoBaseFilter->QueryInterface(IID_ISampleGrabber, (void **)&pVideoSampleGrabber))) {
-		return false;
-	}
-	if(FAILED(pVideoSampleGrabber->SetMediaType(&mt))) {
-		return false;
-	}
-	if(FAILED(pGraphBuilder->AddFilter(pVideoBaseFilter, L"Video Sample Grabber"))) {
-		return false;
-	}
-	if(FAILED(pGraphBuilder->Connect(get_pin(pCaptureBaseFilter, PINDIR_OUTPUT), get_pin(pVideoBaseFilter, PINDIR_INPUT)))) {
-		return false;
-	}
-	if(FAILED(pVideoSampleGrabber->SetBufferSamples(TRUE))) {
-		return false;
-	}
-	if(FAILED(pVideoSampleGrabber->SetOneShot(FALSE))) {
-		return false;
-	}
-	if(FAILED(pGraphBuilder->QueryInterface(IID_IMediaControl, (void **)&pMediaControl))) {
-		return false;
-	}
-	if(FAILED(pGraphBuilder->QueryInterface(IID_IBasicAudio, (void **)&pBasicAudio))) {
-		//return false;
-	}
-	if(FAILED(pMediaControl->Run())) {
-		return false;
-	}
-	
-	// get the capture size
-	pVideoSampleGrabber->GetConnectedMediaType(&mt);
-	VIDEOINFOHEADER *pVideoHeader = (VIDEOINFOHEADER*)mt.pbFormat;
-	direct_show_width = pVideoHeader->bmiHeader.biWidth;
-	direct_show_height = pVideoHeader->bmiHeader.biHeight;
-	
-	if(direct_show_screen_buffer.width != direct_show_width || direct_show_screen_buffer.height != direct_show_height) {
-		initialize_screen_buffer(&direct_show_screen_buffer, direct_show_width, direct_show_height, COLORONCOLOR);
-	}
-	cur_capture_dev_index = index;
-	return true;
-}
-
-void OSD::open_capture_dev(int index, bool pin)
-{
-	if(!connect_capture_dev(index, pin)) {
-		release_video();
-	}
-}
-
-void OSD::close_capture_dev()
-{
-	release_video();
-	cur_capture_dev_index = -1;
-}
-
-void OSD::show_capture_dev_filter()
-{
-	if(pCaptureBaseFilter != NULL) {
-		ISpecifyPropertyPages *pSpec = NULL;
-		CAUUID cauuid;
-		if(SUCCEEDED(pCaptureBaseFilter->QueryInterface(IID_ISpecifyPropertyPages, (void **)&pSpec))) {
-			pSpec->GetPages(&cauuid);
-			OleCreatePropertyFrame(NULL, 30, 30, NULL, 1, (IUnknown **)&pCaptureBaseFilter, cauuid.cElems, (GUID *)cauuid.pElems, 0, 0, NULL);
-			CoTaskMemFree(cauuid.pElems);
-			SAFE_RELEASE(pSpec);
-		}
-	}
-}
-
-void OSD::show_capture_dev_pin()
-{
-	if(cur_capture_dev_index != -1) {
-		if(!connect_capture_dev(cur_capture_dev_index, true)) {
-			release_video();
-		}
-	}
-}
-
-void OSD::show_capture_dev_source()
-{
-	if(pCaptureGraphBuilder2 != NULL) {
-		IAMCrossbar *pCrs = NULL;
-		ISpecifyPropertyPages *pSpec = NULL;
-		CAUUID cauuid;
-		
-		if(FAILED(pCaptureGraphBuilder2->FindInterface(&PIN_CATEGORY_CAPTURE, &MEDIATYPE_Interleaved, pCaptureBaseFilter, IID_IAMCrossbar, (void **)&pCrs))) {
-			if(FAILED(pCaptureGraphBuilder2->FindInterface(&PIN_CATEGORY_CAPTURE, &MEDIATYPE_Video, pCaptureBaseFilter, IID_IAMCrossbar, (void **)&pCrs))) {
-				return;
-			}
-		}
-		if(SUCCEEDED(pCrs->QueryInterface(IID_ISpecifyPropertyPages, (void **)&pSpec))) {
-			pSpec->GetPages(&cauuid);
-			OleCreatePropertyFrame(NULL, 30, 30, NULL, 1, (IUnknown **)&pCrs, cauuid.cElems, (GUID *)cauuid.pElems, 0, 0, NULL);
-			CoTaskMemFree(cauuid.pElems);
-			SAFE_RELEASE(pSpec);
-			
-			AM_MEDIA_TYPE mt;
-			pVideoSampleGrabber->GetConnectedMediaType(&mt);
-			VIDEOINFOHEADER *pVideoHeader = (VIDEOINFOHEADER*)mt.pbFormat;
-			direct_show_width = pVideoHeader->bmiHeader.biWidth;
-			direct_show_height = pVideoHeader->bmiHeader.biHeight;
-			
-			if(direct_show_screen_buffer.width != direct_show_width || direct_show_screen_buffer.height != direct_show_height) {
-				initialize_screen_buffer(&direct_show_screen_buffer, direct_show_width, direct_show_height, COLORONCOLOR);
-			}
-		}
-		SAFE_RELEASE(pCrs);
-	}
-}
-
-void OSD::set_capture_dev_channel(int ch)
-{
-	IAMTVTuner *pTuner = NULL;
-	
-	if(pCaptureGraphBuilder2 != NULL) {
-		if(SUCCEEDED(pCaptureGraphBuilder2->FindInterface(&LOOK_UPSTREAM_ONLY, NULL, pCaptureBaseFilter, IID_IAMTVTuner, (void **)&pTuner))) {
-			pTuner->put_Channel(ch, AMTUNER_SUBCHAN_DEFAULT, AMTUNER_SUBCHAN_DEFAULT);
-			SAFE_RELEASE(pTuner);
-		}
-	}
-}
-#endif
diff -ruN source/src/win32/winmain.cpp src/win32/winmain.cpp
--- source/src/win32/winmain.cpp	2022-12-22 16:30:00
+++ src/win32/winmain.cpp	1970-01-01 09:00:00
@@ -1,4082 +0,0 @@
-/*
-	Skelton for retropc emulator
-
-	Author : Takeda.Toshiya
-	Date   : 2006.08.18 -
-
-	[ win32 main ]
-*/
-
-#include <windows.h>
-#include <windowsx.h>
-#include <winsock.h>
-#include <commdlg.h>
-#include <commctrl.h>
-#include <mmsystem.h>
-#include <stdio.h>
-#include <dwmapi.h>
-#include "../res/resource.h"
-#include "../emu.h"
-#include "../fifo.h"
-#include "../fileio.h"
-
-// emulation core
-EMU* emu;
-
-// menu
-HMENU hMenu = NULL;
-bool now_menuloop = false;
-
-void update_toplevel_menu(HWND hWnd, HMENU hMenu);
-void update_popup_menu(HWND hWnd, HMENU hMenu);
-void show_menu_bar(HWND hWnd);
-void hide_menu_bar(HWND hWnd);
-
-// status bar
-HWND hStatus = NULL;
-bool status_bar_visible = false;
-
-#ifdef USE_FLOPPY_DISK
-uint32_t fd_status = 0x80000000;
-uint32_t fd_indicator_color = 0x80000000;
-#endif
-#ifdef USE_QUICK_DISK
-uint32_t qd_status = 0x80000000;
-#endif
-#ifdef USE_HARD_DISK
-uint32_t hd_status = 0x80000000;
-#endif
-#ifdef USE_COMPACT_DISC
-uint32_t cd_status = 0x80000000;
-#endif
-#ifdef USE_LASER_DISC
-uint32_t ld_status = 0x80000000;
-#endif
-#if defined(USE_TAPE) && !defined(TAPE_BINARY_ONLY)
-_TCHAR tape_status[1024] = _T("uninitialized");
-#endif
-
-void show_status_bar(HWND hWnd);
-void hide_status_bar(HWND hWnd);
-int get_status_bar_height();
-bool get_status_bar_updated();
-void update_status_bar(HINSTANCE hInstance, LPDRAWITEMSTRUCT lpDrawItem);
-
-// file
-#ifdef USE_CART
-void open_cart_dialog(HWND hWnd, int drv);
-void open_recent_cart(int drv, int index);
-#endif
-#ifdef USE_FLOPPY_DISK
-void open_floppy_disk_dialog(HWND hWnd, int drv);
-void open_blank_floppy_disk_dialog(HWND hWnd, int drv, uint8_t type);
-void open_recent_floppy_disk(int drv, int index);
-void select_d88_bank(int drv, int index);
-#endif
-#ifdef USE_QUICK_DISK
-void open_quick_disk_dialog(HWND hWnd, int drv);
-void open_recent_quick_disk(int drv, int index);
-#endif
-#ifdef USE_HARD_DISK
-void open_hard_disk_dialog(HWND hWnd, int drv);
-void open_recent_hard_disk(int drv, int index);
-void open_blank_hard_disk_dialog(HWND hWnd, int drv, int sector_size, int sectors, int surfaces, int cylinders);
-#endif
-#ifdef USE_TAPE
-void open_tape_dialog(HWND hWnd, int drv, bool play);
-void open_recent_tape(int drv, int index);
-#endif
-#ifdef USE_COMPACT_DISC
-void open_compact_disc_dialog(HWND hWnd, int drv);
-void open_recent_compact_disc(int drv, int index);
-#endif
-#ifdef USE_LASER_DISC
-void open_laser_disc_dialog(HWND hWnd, int drv);
-void open_recent_laser_disc(int drv, int index);
-#endif
-#ifdef USE_BINARY_FILE
-void open_binary_dialog(HWND hWnd, int drv, bool load);
-void open_recent_binary(int drv, int index);
-#endif
-#ifdef USE_BUBBLE
-void open_bubble_casette_dialog(HWND hWnd, int drv);
-void open_recent_bubble_casette(int drv, int index);
-#endif
-#if defined(USE_CART) || defined(USE_FLOPPY_DISK) || defined(USE_HARD_DISK) || defined(USE_TAPE) || defined(USE_COMPACT_DISC) || defined(USE_LASER_DISC) || defined(USE_BINARY_FILE) || defined(USE_BUBBLE)
-#define SUPPORT_DRAG_DROP
-#endif
-#ifdef SUPPORT_DRAG_DROP
-void open_dropped_file(HDROP hDrop);
-void open_any_file(const _TCHAR* path);
-#endif
-
-_TCHAR* get_open_file_name(HWND hWnd, const _TCHAR* filter, const _TCHAR* title, const _TCHAR* new_file, _TCHAR* dir, size_t dir_len);
-
-// screen
-int desktop_width;
-int desktop_height;
-int desktop_bpp;
-int prev_window_mode = 0;
-bool now_fullscreen = false;
-
-#define MAX_WINDOW	10
-#define MAX_FULLSCREEN	50
-
-int screen_mode_count;
-int screen_mode_width[MAX_FULLSCREEN];
-int screen_mode_height[MAX_FULLSCREEN];
-
-void enum_screen_mode();
-void set_window(HWND hWnd, int mode);
-
-// input
-#ifdef USE_AUTO_KEY
-void start_auto_key();
-#endif
-
-// dialog
-// thanks Marukun (64bit)
-#ifdef USE_SOUND_VOLUME
-INT_PTR CALLBACK VolumeWndProc(HWND hDlg, UINT iMsg, WPARAM wParam, LPARAM lParam);
-#endif
-#ifdef USE_JOYSTICK
-INT_PTR CALLBACK JoyWndProc(HWND hDlg, UINT iMsg, WPARAM wParam, LPARAM lParam);
-INT_PTR CALLBACK JoyToKeyWndProc(HWND hDlg, UINT iMsg, WPARAM wParam, LPARAM lParam);
-#endif
-
-// buttons
-#ifdef ONE_BOARD_MICRO_COMPUTER
-void create_buttons(HWND hWnd);
-void draw_button(HDC hDC, UINT index, UINT pressed);
-#endif
-
-// misc
-bool win8_or_later = false;
-
-void disable_dwm()
-{
-	HMODULE hLibrary = LoadLibrary(_T("dwmapi.dll"));
-	if(hLibrary) {
-		typedef HRESULT (WINAPI *DwmEnableCompositionFunction)(__in UINT uCompositionAction);
-		DwmEnableCompositionFunction lpfnDwmEnableComposition;
-		lpfnDwmEnableComposition = reinterpret_cast<DwmEnableCompositionFunction>(::GetProcAddress(hLibrary, "DwmEnableComposition"));
-		if(lpfnDwmEnableComposition) {
-			lpfnDwmEnableComposition(DWM_EC_DISABLECOMPOSITION);
-		}
-		FreeLibrary(hLibrary);
-	}
-}
-
-#ifdef USE_SOCKET
-void update_socket(int ch, WPARAM wParam, LPARAM lParam)
-{
-	if(WSAGETSELECTERROR(lParam) != 0) {
-		emu->disconnect_socket(ch);
-		emu->notify_socket_disconnected(ch);
-		return;
-	}
-	if(emu->get_socket(ch) != (int)wParam) {
-		return;
-	}
-	switch(WSAGETSELECTEVENT(lParam)) {
-	case FD_CONNECT:
-		emu->notify_socket_connected(ch);
-		break;
-	case FD_CLOSE:
-		emu->notify_socket_disconnected(ch);
-		break;
-	case FD_WRITE:
-		emu->send_socket_data(ch);
-		break;
-	case FD_READ:
-		emu->recv_socket_data(ch);
-		break;
-	}
-}
-#endif
-
-// ----------------------------------------------------------------------------
-// window main
-// ----------------------------------------------------------------------------
-
-LRESULT CALLBACK WndProc(HWND hWnd, UINT iMsg, WPARAM wParam, LPARAM lParam);
-
-int WINAPI _tWinMain(HINSTANCE hInstance, HINSTANCE hPrevInstance, LPTSTR szCmdLine, int iCmdShow)
-{
-	// get os version
-	OSVERSIONINFO osvi;
-	ZeroMemory(&osvi, sizeof(OSVERSIONINFO));
-	osvi.dwOSVersionInfoSize = sizeof(OSVERSIONINFO);
-	GetVersionEx((OSVERSIONINFO*)&osvi);
-	win8_or_later = (osvi.dwPlatformId == 2 && (osvi.dwMajorVersion > 6 || (osvi.dwMajorVersion == 6 && osvi.dwMinorVersion >= 2)));
-	
-	// load config
-	load_config(create_local_path(_T("%s.ini"), _T(CONFIG_NAME)));
-	
-	// create window
-	WNDCLASS wndclass;
-	wndclass.style = CS_HREDRAW | CS_VREDRAW;
-	wndclass.lpfnWndProc = (WNDPROC)WndProc;
-	wndclass.cbClsExtra = 0;
-	wndclass.cbWndExtra = 0;
-	wndclass.hInstance = hInstance;
-	wndclass.hIcon = LoadIcon(hInstance, MAKEINTRESOURCE(IDI_ICON1));
-//	wndclass.hCursor = 0;
-	wndclass.hCursor = LoadCursor(NULL, IDC_ARROW);
-	wndclass.hbrBackground = (HBRUSH)GetStockObject(BLACK_BRUSH);
-	wndclass.lpszMenuName = MAKEINTRESOURCE(IDR_MENU1);
-	wndclass.lpszClassName = _T("CWINDOW");
-	RegisterClass(&wndclass);
-	
-	// get window position
-	RECT rect = {0, 0, WINDOW_WIDTH, WINDOW_HEIGHT};
-	AdjustWindowRect(&rect, WS_OVERLAPPED | WS_CAPTION | WS_SYSMENU | WS_MINIMIZEBOX | WS_VISIBLE, TRUE);
-	HDC hdcScr = GetDC(NULL);
-	desktop_width = GetDeviceCaps(hdcScr, HORZRES);
-	desktop_height = GetDeviceCaps(hdcScr, VERTRES);
-	desktop_bpp = GetDeviceCaps(hdcScr, BITSPIXEL);
-	ReleaseDC(NULL, hdcScr);
-	int dest_x = (int)((desktop_width - (rect.right - rect.left)) / 2);
-	int dest_y = (int)((desktop_height - (rect.bottom - rect.top)) / 2);
-	//dest_x = (dest_x < 0) ? 0 : dest_x;
-	dest_y = (dest_y < 0) ? 0 : dest_y;
-	
-	// show window
-	HWND hWnd = CreateWindow(_T("CWINDOW"), _T(DEVICE_NAME), WS_OVERLAPPED | WS_CAPTION | WS_SYSMENU | WS_MINIMIZEBOX | WS_VISIBLE,
-	                         dest_x, dest_y, rect.right - rect.left, rect.bottom - rect.top, NULL, NULL, hInstance, NULL);
-	ShowWindow(hWnd, iCmdShow);
-	UpdateWindow(hWnd);
-	
-	// show menu bar
-	show_menu_bar(hWnd);
-	
-	// show status bar
-	if(config.show_status_bar) {
-		show_status_bar(hWnd);
-	}
-	
-	int status_bar_height = get_status_bar_height();
-	RECT rect_tmp;
-	GetClientRect(hWnd, &rect_tmp);
-	if(rect_tmp.bottom != WINDOW_HEIGHT + status_bar_height) {
-		rect.bottom += WINDOW_HEIGHT + status_bar_height - rect_tmp.bottom;
-		dest_y = (int)((desktop_height - (rect.bottom - rect.top)) / 2);
-		dest_y = (dest_y < 0) ? 0 : dest_y;
-		SetWindowPos(hWnd, NULL, dest_x, dest_y, rect.right - rect.left, rect.bottom - rect.top, SWP_NOZORDER);
-	}
-	
-	// enumerate screen mode
-	enum_screen_mode();
-	
-	// restore screen mode
-	if(config.window_mode >= 0 && config.window_mode < MAX_WINDOW) {
-		PostMessage(hWnd, WM_COMMAND, ID_SCREEN_WINDOW + config.window_mode, 0L);
-	} else if(config.window_mode >= MAX_WINDOW && config.window_mode < screen_mode_count + MAX_WINDOW) {
-		PostMessage(hWnd, WM_COMMAND, ID_SCREEN_FULLSCREEN + config.window_mode - MAX_WINDOW, 0L);
-	} else {
-		config.window_mode = 0;
-		PostMessage(hWnd, WM_COMMAND, ID_SCREEN_WINDOW, 0L);
-	}
-	
-	// accelerator
-	HACCEL hAccel = LoadAccelerators(hInstance, MAKEINTRESOURCE(IDR_ACCELERATOR1));
-	
-	// initialize emulation core
-	emu = new EMU(hWnd, hInstance);
-	emu->set_host_window_size(WINDOW_WIDTH, WINDOW_HEIGHT, true);
-	
-	// update top-level menu for emulator settings
-	update_toplevel_menu(hWnd, hMenu);
-	
-#ifdef SUPPORT_DRAG_DROP
-	// open command line path
-	if(szCmdLine[0]) {
-		if(szCmdLine[0] == _T('"')) {
-			int len = (int)_tcslen(szCmdLine);
-			szCmdLine[len - 1] = _T('\0');
-			szCmdLine++;
-		}
-		_TCHAR path[_MAX_PATH];
-		get_long_full_path_name(szCmdLine, path, _MAX_PATH);
-		open_any_file(path);
-	}
-#endif
-	
-	// set priority
-	SetPriorityClass(GetCurrentProcess(), ABOVE_NORMAL_PRIORITY_CLASS);
-	
-	// main loop
-	int total_frames = 0, draw_frames = 0, skip_frames = 0;
-	DWORD next_time = 0;
-	bool prev_skip = false;
-	DWORD update_fps_time = 0;
-	DWORD update_status_bar_time = 0;
-	DWORD disable_screen_saver_time = 0;
-	MSG msg;
-	
-	while(1) {
-		// check window message
-		DWORD start_time = timeGetTime();
-		DWORD end_time = start_time;
-		
-		while(1) {
-			if(PeekMessage(&msg, NULL, 0, 0, PM_NOREMOVE)) {
-				if(!GetMessage(&msg, NULL, 0, 0)) {
-#ifdef _DEBUG
-					_CrtDumpMemoryLeaks();
-#endif
-					ExitProcess(0);	// trick
-					return (int)msg.wParam;
-				}
-				if(msg.message == WM_KEYUP) {
-					if(LOBYTE(msg.wParam) == 0x10) {
-						end_time = start_time + 10;
-					}
-				} else if(msg.message == WM_KEYDOWN) {
-					if(LOBYTE(msg.wParam) != 0x10) {
-						end_time = start_time;
-					}
-				}
-				if(!TranslateAccelerator(hWnd, hAccel, &msg)) {
-					TranslateMessage(&msg);
-					DispatchMessage(&msg);
-				}
-			} else if(end_time == start_time || end_time <= timeGetTime()) {
-				break;
-			}
-		}
-		if(emu) {
-			// drive machine
-			int run_frames = emu->run();
-			total_frames += run_frames;
-			
-			// timing controls
-			int sleep_period = 0;
-			bool now_skip = (config.full_speed || emu->is_frame_skippable()) && !emu->is_video_recording() && !emu->is_sound_recording();
-			
-			if((prev_skip && !now_skip) || next_time == 0) {
-				next_time = timeGetTime();
-			}
-			if(!now_skip) {
-				static int accum = 0;
-				accum += emu->get_frame_interval();
-				int interval = accum >> 10;
-				accum -= interval << 10;
-				next_time += interval;
-			}
-			prev_skip = now_skip;
-			
-			if(next_time > timeGetTime()) {
-				// update window if enough time
-				draw_frames += emu->draw_screen();
-				skip_frames = 0;
-				
-				// sleep 1 frame priod if need
-				DWORD current_time = timeGetTime();
-				if((int)(next_time - current_time) >= 10) {
-					sleep_period = next_time - current_time;
-				}
-			} else if(++skip_frames > (int)emu->get_frame_rate()) {
-				// update window at least once per 1 sec in virtual machine time
-				draw_frames += emu->draw_screen();
-				skip_frames = 0;
-				next_time = timeGetTime();
-			}
-			Sleep(sleep_period);
-			
-			// calc frame rate
-			DWORD current_time = timeGetTime();
-			if(update_fps_time <= current_time) {
-				if(update_fps_time != 0) {
-					if(emu->message_count > 0) {
-						SetWindowText(hWnd, create_string(_T("%s - %s"), _T(DEVICE_NAME), emu->message));
-						emu->message_count--;
-					} else if(now_skip) {
-						int ratio = (int)(100.0 * (double)total_frames / emu->get_frame_rate() + 0.5);
-						SetWindowText(hWnd, create_string(_T("%s - Skip Frames (%d %%)"), _T(DEVICE_NAME), ratio));
-					} else {
-						int ratio = (int)(100.0 * (double)draw_frames / (double)total_frames + 0.5);
-						SetWindowText(hWnd, create_string(_T("%s - %d fps (%d %%)"), _T(DEVICE_NAME), draw_frames, ratio));
-					}
-					update_fps_time += 1000;
-					total_frames = draw_frames = 0;
-				}
-				update_fps_time = current_time + 1000;
-			}
-			
-			// update status bar
-			if(update_status_bar_time <= current_time) {
-				if(hStatus != NULL && status_bar_visible) {
-					if(get_status_bar_updated()) {
-						SendMessage(hStatus, SB_SETTEXT, (WPARAM)0 | SBT_OWNERDRAW, (LPARAM)NULL);
-//						InvalidateRect(hStatus, NULL, FALSE);
-					}
-				}
-				update_status_bar_time = current_time + 200;
-			}
-			
-			// disable screen saver
-			if(disable_screen_saver_time <= current_time) {
-				SetThreadExecutionState(ES_DISPLAY_REQUIRED);
-				INPUT input[1];
-				ZeroMemory(input, sizeof(INPUT));
-				input[0].type = INPUT_MOUSE;
-				input[0].mi.dwFlags = MOUSEEVENTF_MOVE;
-				input[0].mi.dx = 0;
-				input[0].mi.dy = 0;
-				SendInput(1, input, sizeof(INPUT)); 
-				disable_screen_saver_time = current_time + 30000;
-			}
-		}
-	}
-#ifdef _DEBUG
-	_CrtDumpMemoryLeaks();
-#endif
-	return 0;
-}
-
-// ----------------------------------------------------------------------------
-// window procedure
-// ----------------------------------------------------------------------------
-
-LRESULT CALLBACK WndProc(HWND hWnd, UINT iMsg, WPARAM wParam, LPARAM lParam)
-{
-	static HINSTANCE hInstance;
-	static HIMC himcPrev = 0;
-	static bool notified = false;
-	
-	switch(iMsg) {
-	case WM_CREATE:
-		if(config.disable_dwm && win8_or_later) {
-			disable_dwm();
-		}
-#ifdef ONE_BOARD_MICRO_COMPUTER
-		create_buttons(hWnd);
-#endif
-#ifdef SUPPORT_DRAG_DROP
-		DragAcceptFiles(hWnd, TRUE);
-#endif
-#ifdef _M_AMD64
-		// thanks Marukun (64bit)
-		hInstance = (HINSTANCE)GetWindowLongPtr(hWnd, GWLP_HINSTANCE);
-#else
-		hInstance = (HINSTANCE)GetWindowLong(hWnd, GWL_HINSTANCE);
-#endif
-		timeBeginPeriod(1);
-		break;
-	case WM_CLOSE:
-#ifdef USE_NOTIFY_POWER_OFF
-		// notify power off
-		if(emu && !notified) {
-			emu->notify_power_off();
-			notified = true;
-			return 0;
-		}
-#endif
-		// release window
-		if(now_fullscreen) {
-			ChangeDisplaySettings(NULL, 0);
-			now_fullscreen = false;
-		}
-		if(hMenu != NULL) {
-			if(IsMenu(hMenu)) {
-				DestroyMenu(hMenu);
-			}
-			hMenu = NULL;
-		}
-		if(hStatus != NULL) {
-			DestroyWindow(hStatus);
-			hStatus = NULL;
-		}
-		DestroyWindow(hWnd);
-		timeEndPeriod(1);
-	case WM_ENDSESSION:
-		// release emulation core
-		if(emu) {
-			delete emu;
-			emu = NULL;
-			save_config(create_local_path(_T("%s.ini"), _T(CONFIG_NAME)));
-		}
-		return 0;
-	case WM_DESTROY:
-		PostQuitMessage(0);
-		return 0;
-	case WM_QUERYENDSESSION:
-#ifdef USE_NOTIFY_POWER_OFF
-		// notify power off and drive machine
-		if(emu && !notified) {
-			emu->notify_power_off();
-			emu->run();
-			notified = true;
-		}
-#endif
-		return TRUE;
-	case WM_ACTIVATE:
-		// thanks PC8801MAâ¸
-		if(LOWORD(wParam) != WA_INACTIVE) {
-			himcPrev = ImmAssociateContext(hWnd, 0);
-		} else {
-			ImmAssociateContext(hWnd, himcPrev);
-		}
-		break;
-	case WM_SIZE:
-		if(hStatus != NULL) {
-			SendMessage(hStatus, WM_SIZE, wParam, lParam);
-		}
-#ifdef ONE_BOARD_MICRO_COMPUTER
-		if(emu) {
-			emu->reload_bitmap();
-		}
-#endif
-		break;
-	case WM_KILLFOCUS:
-		if(emu) {
-			emu->key_lost_focus();
-		}
-		break;
-	case WM_PAINT:
-		if(emu) {
-			PAINTSTRUCT ps;
-			HDC hdc = BeginPaint(hWnd, &ps);
-#ifdef ONE_BOARD_MICRO_COMPUTER
-			// check if self invalidate or not
-			int left = 0, top = 0, right = 0, bottom = 0;
-			emu->get_invalidated_rect(&left, &top, &right, &bottom);
-			if(ps.rcPaint.left != left || ps.rcPaint.top != top || ps.rcPaint.right != right || ps.rcPaint.bottom != bottom) {
-				emu->reload_bitmap();
-			}
-#endif
-			emu->update_screen(hdc);
-			EndPaint(hWnd, &ps);
-		}
-		return 0;
-	case WM_DRAWITEM:
-		{
-			LPDRAWITEMSTRUCT lpDrawItem = (LPDRAWITEMSTRUCT)lParam;
-			if(lpDrawItem->CtlID == ID_STATUS) {
-				if(emu) {
-					update_status_bar(hInstance, lpDrawItem);
-				}
-			} else {
-				#ifdef ONE_BOARD_MICRO_COMPUTER
-//					if(lpDrawItem->itemAction & (ODA_DRAWENTIRE | ODA_SELECT)) {
-						draw_button(lpDrawItem->hDC, (UINT)wParam - ID_BUTTON, lpDrawItem->itemState & ODS_SELECTED);
-//					}
-				#endif
-			}
-		}
-		return TRUE;
-	case WM_MOVING:
-		if(emu) {
-			emu->suspend();
-		}
-		break;
-	case WM_KEYDOWN:
-		if(emu) {
-			bool extended = ((HIWORD(lParam) & 0x100) != 0);
-			bool repeat = ((HIWORD(lParam) & 0x4000) != 0);
-			int code = LOBYTE(wParam);
-			if(code == VK_PROCESSKEY) {
-				code = MapVirtualKey(HIWORD(lParam) & 0xff, 3);
-			}
-			emu->key_down(code, extended, repeat);
-		}
-		break;
-	case WM_KEYUP:
-		if(emu) {
-			bool extended = ((HIWORD(lParam) & 0x100) != 0);
-			int code = LOBYTE(wParam);
-			if(code == VK_PROCESSKEY) {
-				code = MapVirtualKey(HIWORD(lParam) & 0xff, 3);
-			}
-			emu->key_up(code, extended);
-		}
-		break;
-	case WM_SYSKEYDOWN:
-		if(emu) {
-			bool extended = ((HIWORD(lParam) & 0x100) != 0);
-			bool repeat = ((HIWORD(lParam) & 0x4000) != 0);
-			int code = LOBYTE(wParam);
-			if(code == VK_PROCESSKEY) {
-				code = MapVirtualKey(HIWORD(lParam) & 0xff, 3);
-			}
-			emu->key_down(code, extended, repeat);
-		}
-		return 0;	// not activate menu when hit ALT/F10
-	case WM_SYSKEYUP:
-		if(emu) {
-			bool extended = ((HIWORD(lParam) & 0x100) != 0);
-			int code = LOBYTE(wParam);
-			if(code == VK_PROCESSKEY) {
-				code = MapVirtualKey(HIWORD(lParam) & 0xff, 3);
-			}
-			emu->key_up(code, extended);
-		}
-		return 0;	// not activate menu when hit ALT/F10
-	case WM_CHAR:
-		if(emu) {
-			emu->key_char(LOBYTE(wParam));
-		}
-		break;
-	case WM_SYSCHAR:
-		return 0;	// not activate menu when hit ALT/F10
-	case WM_INITMENUPOPUP:
-		if(emu) {
-			emu->suspend();
-		}
-		update_popup_menu(hWnd, (HMENU)wParam);
-		break;
-	case WM_ENTERMENULOOP:
-		now_menuloop = true;
-		break;
-	case WM_EXITMENULOOP:
-		if(now_fullscreen && now_menuloop) {
-			hide_menu_bar(hWnd);
-		}
-		now_menuloop = false;
-		break;
-	case WM_MOUSEMOVE:
-		if(now_fullscreen && !now_menuloop) {
-			POINTS p = MAKEPOINTS(lParam);
-			if(p.y == 0) {
-				show_menu_bar(hWnd);
-			} else if(p.y > 32) {
-				hide_menu_bar(hWnd);
-			}
-		}
-		break;
-	case WM_RESIZE:
-		if(emu) {
-			if(now_fullscreen) {
-				emu->set_host_window_size(-1, -1, false);
-			} else {
-				set_window(hWnd, config.window_mode);
-			}
-		}
-		break;
-#ifdef SUPPORT_DRAG_DROP
-	case WM_DROPFILES:
-		if(emu) {
-			open_dropped_file((HDROP)wParam);
-		}
-		break;
-#endif
-#ifdef USE_SOCKET
-	case WM_SOCKET0: case WM_SOCKET1: case WM_SOCKET2: case WM_SOCKET3:
-		if(emu) {
-			update_socket(iMsg - WM_SOCKET0, wParam, lParam);
-		}
-		break;
-#endif
-	case WM_COMMAND:
-		switch(LOWORD(wParam)) {
-		case ID_RESET:
-			if(emu) {
-				emu->reset();
-				update_toplevel_menu(hWnd, hMenu);
-			}
-			break;
-#ifdef USE_SPECIAL_RESET
-		case ID_SPECIAL_RESET:
-			if(emu) {
-				emu->special_reset();
-				update_toplevel_menu(hWnd, hMenu);
-			}
-			break;
-#endif
-		case ID_CPU_POWER0: case ID_CPU_POWER1: case ID_CPU_POWER2: case ID_CPU_POWER3: case ID_CPU_POWER4:
-			config.cpu_power = LOWORD(wParam) - ID_CPU_POWER0;
-			if(emu) {
-				emu->update_config();
-			}
-			break;
-		case ID_FULL_SPEED:
-			config.full_speed = !config.full_speed;
-			break;
-		case ID_DRIVE_VM_IN_OPECODE:
-			config.drive_vm_in_opecode = !config.drive_vm_in_opecode;
-			break;
-#ifdef USE_AUTO_KEY
-		case ID_AUTOKEY_START:
-			if(emu) {
-				start_auto_key();
-			}
-			break;
-		case ID_AUTOKEY_STOP:
-			if(emu) {
-				emu->stop_auto_key();
-			}
-			break;
-		case ID_ROMAJI_TO_KANA:
-			if(emu) {
-				if(!config.romaji_to_kana) {
-					emu->set_auto_key_char(1); // start
-					config.romaji_to_kana = true;
-				} else {
-					emu->set_auto_key_char(0); // end
-					config.romaji_to_kana = false;
-				}
-			}
-			break;
-#endif
-#ifdef USE_DEBUGGER
-		case ID_OPEN_DEBUGGER0: case ID_OPEN_DEBUGGER1: case ID_OPEN_DEBUGGER2: case ID_OPEN_DEBUGGER3:
-		case ID_OPEN_DEBUGGER4: case ID_OPEN_DEBUGGER5: case ID_OPEN_DEBUGGER6: case ID_OPEN_DEBUGGER7:
-			if(emu) {
-				emu->open_debugger(LOWORD(wParam) - ID_OPEN_DEBUGGER0);
-			}
-			break;
-		case ID_CLOSE_DEBUGGER:
-			if(emu) {
-				emu->close_debugger();
-			}
-			break;
-#endif
-#ifdef USE_STATE
-		case ID_SAVE_STATE0: case ID_SAVE_STATE1: case ID_SAVE_STATE2: case ID_SAVE_STATE3: case ID_SAVE_STATE4:
-		case ID_SAVE_STATE5: case ID_SAVE_STATE6: case ID_SAVE_STATE7: case ID_SAVE_STATE8: case ID_SAVE_STATE9:
-			if(emu) {
-				emu->save_state(emu->state_file_path(LOWORD(wParam) - ID_SAVE_STATE0));
-			}
-			break;
-		case ID_LOAD_STATE0: case ID_LOAD_STATE1: case ID_LOAD_STATE2: case ID_LOAD_STATE3: case ID_LOAD_STATE4:
-		case ID_LOAD_STATE5: case ID_LOAD_STATE6: case ID_LOAD_STATE7: case ID_LOAD_STATE8: case ID_LOAD_STATE9:
-			if(emu) {
-				emu->load_state(emu->state_file_path(LOWORD(wParam) - ID_LOAD_STATE0));
-			}
-			break;
-#endif
-		case ID_EXIT:
-			SendMessage(hWnd, WM_CLOSE, 0, 0L);
-			break;
-#ifdef USE_BOOT_MODE
-		case ID_VM_BOOT_MODE0: case ID_VM_BOOT_MODE1: case ID_VM_BOOT_MODE2: case ID_VM_BOOT_MODE3:
-		case ID_VM_BOOT_MODE4: case ID_VM_BOOT_MODE5: case ID_VM_BOOT_MODE6: case ID_VM_BOOT_MODE7:
-			config.boot_mode = LOWORD(wParam) - ID_VM_BOOT_MODE0;
-			if(emu) {
-				emu->update_config();
-			}
-			break;
-#endif
-#ifdef USE_CPU_TYPE
-		case ID_VM_CPU_TYPE0: case ID_VM_CPU_TYPE1: case ID_VM_CPU_TYPE2: case ID_VM_CPU_TYPE3:
-		case ID_VM_CPU_TYPE4: case ID_VM_CPU_TYPE5: case ID_VM_CPU_TYPE6: case ID_VM_CPU_TYPE7:
-			config.cpu_type = LOWORD(wParam) - ID_VM_CPU_TYPE0;
-			// need to recreate vm class instance
-//			if(emu) {
-//				emu->update_config();
-//			}
-			break;
-#endif
-#ifdef USE_DIPSWITCH
-		case ID_VM_DIPSWITCH0:  case ID_VM_DIPSWITCH1:  case ID_VM_DIPSWITCH2:  case ID_VM_DIPSWITCH3: 
-		case ID_VM_DIPSWITCH4:  case ID_VM_DIPSWITCH5:  case ID_VM_DIPSWITCH6:  case ID_VM_DIPSWITCH7: 
-		case ID_VM_DIPSWITCH8:  case ID_VM_DIPSWITCH9:  case ID_VM_DIPSWITCH10: case ID_VM_DIPSWITCH11:
-		case ID_VM_DIPSWITCH12: case ID_VM_DIPSWITCH13: case ID_VM_DIPSWITCH14: case ID_VM_DIPSWITCH15:
-		case ID_VM_DIPSWITCH16: case ID_VM_DIPSWITCH17: case ID_VM_DIPSWITCH18: case ID_VM_DIPSWITCH19:
-		case ID_VM_DIPSWITCH20: case ID_VM_DIPSWITCH21: case ID_VM_DIPSWITCH22: case ID_VM_DIPSWITCH23:
-		case ID_VM_DIPSWITCH24: case ID_VM_DIPSWITCH25: case ID_VM_DIPSWITCH26: case ID_VM_DIPSWITCH27:
-		case ID_VM_DIPSWITCH28: case ID_VM_DIPSWITCH29: case ID_VM_DIPSWITCH30: case ID_VM_DIPSWITCH31:
-			config.dipswitch ^= (1 << (LOWORD(wParam) - ID_VM_DIPSWITCH0));
-			if(emu) {
-				emu->update_config();
-			}
-			break;
-#endif
-#ifdef USE_DEVICE_TYPE
-		case ID_VM_DEVICE_TYPE0: case ID_VM_DEVICE_TYPE1: case ID_VM_DEVICE_TYPE2: case ID_VM_DEVICE_TYPE3:
-		case ID_VM_DEVICE_TYPE4: case ID_VM_DEVICE_TYPE5: case ID_VM_DEVICE_TYPE6: case ID_VM_DEVICE_TYPE7:
-			config.device_type = LOWORD(wParam) - ID_VM_DEVICE_TYPE0;
-			break;
-#endif
-#ifdef USE_DRIVE_TYPE
-		case ID_VM_DRIVE_TYPE0: case ID_VM_DRIVE_TYPE1: case ID_VM_DRIVE_TYPE2: case ID_VM_DRIVE_TYPE3:
-		case ID_VM_DRIVE_TYPE4: case ID_VM_DRIVE_TYPE5: case ID_VM_DRIVE_TYPE6: case ID_VM_DRIVE_TYPE7:
-			config.drive_type = LOWORD(wParam) - ID_VM_DRIVE_TYPE0;
-			if(emu) {
-				emu->update_config();
-			}
-			break;
-#endif
-#ifdef USE_KEYBOARD_TYPE
-		case ID_VM_KEYBOARD_TYPE0: case ID_VM_KEYBOARD_TYPE1: case ID_VM_KEYBOARD_TYPE2: case ID_VM_KEYBOARD_TYPE3:
-		case ID_VM_KEYBOARD_TYPE4: case ID_VM_KEYBOARD_TYPE5: case ID_VM_KEYBOARD_TYPE6: case ID_VM_KEYBOARD_TYPE7:
-			config.keyboard_type = LOWORD(wParam) - ID_VM_KEYBOARD_TYPE0;
-			if(emu) {
-				emu->update_config();
-			}
-			break;
-#endif
-#ifdef USE_MOUSE_TYPE
-		case ID_VM_MOUSE_TYPE0: case ID_VM_MOUSE_TYPE1: case ID_VM_MOUSE_TYPE2: case ID_VM_MOUSE_TYPE3:
-		case ID_VM_MOUSE_TYPE4: case ID_VM_MOUSE_TYPE5: case ID_VM_MOUSE_TYPE6: case ID_VM_MOUSE_TYPE7:
-			config.mouse_type = LOWORD(wParam) - ID_VM_MOUSE_TYPE0;
-			if(emu) {
-				emu->update_config();
-			}
-			break;
-#endif
-#ifdef USE_JOYSTICK_TYPE
-		case ID_VM_JOYSTICK_TYPE0: case ID_VM_JOYSTICK_TYPE1: case ID_VM_JOYSTICK_TYPE2: case ID_VM_JOYSTICK_TYPE3:
-		case ID_VM_JOYSTICK_TYPE4: case ID_VM_JOYSTICK_TYPE5: case ID_VM_JOYSTICK_TYPE6: case ID_VM_JOYSTICK_TYPE7:
-			config.joystick_type = LOWORD(wParam) - ID_VM_JOYSTICK_TYPE0;
-			if(emu) {
-				emu->update_config();
-			}
-			break;
-#endif
-#ifdef USE_SOUND_TYPE
-		case ID_VM_SOUND_TYPE0: case ID_VM_SOUND_TYPE1: case ID_VM_SOUND_TYPE2: case ID_VM_SOUND_TYPE3:
-		case ID_VM_SOUND_TYPE4: case ID_VM_SOUND_TYPE5: case ID_VM_SOUND_TYPE6: case ID_VM_SOUND_TYPE7:
-			config.sound_type = LOWORD(wParam) - ID_VM_SOUND_TYPE0;
-			//if(emu) {
-			//	emu->update_config();
-			//}
-			break;
-#endif
-#ifdef USE_FLOPPY_DISK
-		case ID_VM_SOUND_NOISE_FDD:
-			config.sound_noise_fdd = !config.sound_noise_fdd;
-			if(emu) {
-				emu->update_config();
-			}
-			break;
-#endif
-#ifdef USE_TAPE
-		case ID_VM_SOUND_NOISE_CMT:
-			config.sound_noise_cmt = !config.sound_noise_cmt;
-			if(emu) {
-				emu->update_config();
-			}
-			break;
-		case ID_VM_SOUND_TAPE_SIGNAL:
-			config.sound_tape_signal = !config.sound_tape_signal;
-			break;
-		case ID_VM_SOUND_TAPE_VOICE:
-			config.sound_tape_voice = !config.sound_tape_voice;
-			break;
-#endif
-#ifdef USE_MONITOR_TYPE
-		case ID_VM_MONITOR_TYPE0: case ID_VM_MONITOR_TYPE1: case ID_VM_MONITOR_TYPE2: case ID_VM_MONITOR_TYPE3:
-		case ID_VM_MONITOR_TYPE4: case ID_VM_MONITOR_TYPE5: case ID_VM_MONITOR_TYPE6: case ID_VM_MONITOR_TYPE7:
-			config.monitor_type = LOWORD(wParam) - ID_VM_MONITOR_TYPE0;
-			if(emu) {
-#ifdef ONE_BOARD_MICRO_COMPUTER
-				emu->reload_bitmap();
-				emu->invalidate_screen();
-#endif
-				emu->update_config();
-			}
-			break;
-#endif
-#ifdef USE_SCANLINE
-		case ID_VM_MONITOR_SCANLINE:
-			config.scan_line = !config.scan_line;
-			if(emu) {
-				emu->update_config();
-			}
-			break;
-		case ID_VM_MONITOR_SCANLINE_AUTO:
-			config.scan_line_auto = !config.scan_line_auto;
-			break;
-#endif
-#ifdef USE_PRINTER_TYPE
-		case ID_VM_PRINTER_TYPE0: case ID_VM_PRINTER_TYPE1: case ID_VM_PRINTER_TYPE2: case ID_VM_PRINTER_TYPE3:
-		case ID_VM_PRINTER_TYPE4: case ID_VM_PRINTER_TYPE5: case ID_VM_PRINTER_TYPE6: case ID_VM_PRINTER_TYPE7:
-			config.printer_type = LOWORD(wParam) - ID_VM_PRINTER_TYPE0;
-			break;
-#endif
-#ifdef USE_SERIAL_TYPE
-		case ID_VM_SERIAL_TYPE0: case ID_VM_SERIAL_TYPE1: case ID_VM_SERIAL_TYPE2: case ID_VM_SERIAL_TYPE3:
-		case ID_VM_SERIAL_TYPE4: case ID_VM_SERIAL_TYPE5: case ID_VM_SERIAL_TYPE6: case ID_VM_SERIAL_TYPE7:
-			config.serial_type = LOWORD(wParam) - ID_VM_SERIAL_TYPE0;
-			break;
-#endif
-		case ID_HOST_REC_MOVIE_60FPS: case ID_HOST_REC_MOVIE_30FPS: case ID_HOST_REC_MOVIE_15FPS:
-			if(emu) {
-				static const int fps[3] = {60, 30, 15};
-				emu->start_record_sound();
-				if(!emu->start_record_video(fps[LOWORD(wParam) - ID_HOST_REC_MOVIE_60FPS])) {
-					emu->stop_record_sound();
-				}
-			}
-			break;
-		case ID_HOST_REC_SOUND:
-			if(emu) {
-				emu->start_record_sound();
-			}
-			break;
-		case ID_HOST_REC_STOP:
-			if(emu) {
-				emu->stop_record_video();
-				emu->stop_record_sound();
-			}
-			break;
-		case ID_HOST_CAPTURE_SCREEN:
-			if(emu) {
-				emu->capture_screen();
-			}
-			break;
-#ifdef SUPPORT_D2D1
-		case ID_HOST_USE_D2D1:
-			config.use_d2d1 = !config.use_d2d1;
-			#ifdef SUPPORT_D3D9
-				config.use_d3d9 = 0;
-			#endif
-			if(emu) {
-				emu->set_host_window_size(-1, -1, !now_fullscreen);
-			}
-			break;
-#endif
-#ifdef SUPPORT_D3D9
-		case ID_HOST_USE_D3D9:
-			#ifdef SUPPORT_D2D1
-				config.use_d2d1 = 0;
-			#endif
-			config.use_d3d9 = !config.use_d3d9;
-			if(emu) {
-				emu->set_host_window_size(-1, -1, !now_fullscreen);
-			}
-			break;
-		case ID_HOST_WAIT_VSYNC:
-			config.wait_vsync = !config.wait_vsync;
-			if(emu) {
-				emu->set_host_window_size(-1, -1, !now_fullscreen);
-			}
-			break;
-#endif
-		case ID_HOST_USE_DINPUT:
-			config.use_dinput = !config.use_dinput;
-			break;
-		case ID_HOST_DISABLE_DWM:
-			config.disable_dwm = !config.disable_dwm;
-			break;
-		case ID_HOST_SHOW_STATUS_BAR:
-			config.show_status_bar = !config.show_status_bar;
-			if(emu) {
-				if(!now_fullscreen) {
-					set_window(hWnd, prev_window_mode);
-				}
-				#ifdef SUPPORT_D2D1
-					emu->set_host_window_size(-1, -1, !now_fullscreen);
-				#endif
-			}
-			break;
-		case ID_SCREEN_WINDOW + 0: case ID_SCREEN_WINDOW + 1: case ID_SCREEN_WINDOW + 2: case ID_SCREEN_WINDOW + 3: case ID_SCREEN_WINDOW + 4:
-		case ID_SCREEN_WINDOW + 5: case ID_SCREEN_WINDOW + 6: case ID_SCREEN_WINDOW + 7: case ID_SCREEN_WINDOW + 8: case ID_SCREEN_WINDOW + 9:
-			if(emu) {
-				set_window(hWnd, LOWORD(wParam) - ID_SCREEN_WINDOW);
-			}
-			break;
-		case ID_SCREEN_FULLSCREEN +  0: case ID_SCREEN_FULLSCREEN +  1: case ID_SCREEN_FULLSCREEN +  2: case ID_SCREEN_FULLSCREEN +  3: case ID_SCREEN_FULLSCREEN +  4:
-		case ID_SCREEN_FULLSCREEN +  5: case ID_SCREEN_FULLSCREEN +  6: case ID_SCREEN_FULLSCREEN +  7: case ID_SCREEN_FULLSCREEN +  8: case ID_SCREEN_FULLSCREEN +  9:
-		case ID_SCREEN_FULLSCREEN + 10: case ID_SCREEN_FULLSCREEN + 11: case ID_SCREEN_FULLSCREEN + 12: case ID_SCREEN_FULLSCREEN + 13: case ID_SCREEN_FULLSCREEN + 14:
-		case ID_SCREEN_FULLSCREEN + 15: case ID_SCREEN_FULLSCREEN + 16: case ID_SCREEN_FULLSCREEN + 17: case ID_SCREEN_FULLSCREEN + 18: case ID_SCREEN_FULLSCREEN + 19:
-		case ID_SCREEN_FULLSCREEN + 20: case ID_SCREEN_FULLSCREEN + 21: case ID_SCREEN_FULLSCREEN + 22: case ID_SCREEN_FULLSCREEN + 23: case ID_SCREEN_FULLSCREEN + 24:
-		case ID_SCREEN_FULLSCREEN + 25: case ID_SCREEN_FULLSCREEN + 26: case ID_SCREEN_FULLSCREEN + 27: case ID_SCREEN_FULLSCREEN + 28: case ID_SCREEN_FULLSCREEN + 29:
-		case ID_SCREEN_FULLSCREEN + 30: case ID_SCREEN_FULLSCREEN + 31: case ID_SCREEN_FULLSCREEN + 32: case ID_SCREEN_FULLSCREEN + 33: case ID_SCREEN_FULLSCREEN + 34:
-		case ID_SCREEN_FULLSCREEN + 35: case ID_SCREEN_FULLSCREEN + 36: case ID_SCREEN_FULLSCREEN + 37: case ID_SCREEN_FULLSCREEN + 38: case ID_SCREEN_FULLSCREEN + 39:
-		case ID_SCREEN_FULLSCREEN + 40: case ID_SCREEN_FULLSCREEN + 41: case ID_SCREEN_FULLSCREEN + 42: case ID_SCREEN_FULLSCREEN + 43: case ID_SCREEN_FULLSCREEN + 44:
-		case ID_SCREEN_FULLSCREEN + 45: case ID_SCREEN_FULLSCREEN + 46: case ID_SCREEN_FULLSCREEN + 47: case ID_SCREEN_FULLSCREEN + 48: case ID_SCREEN_FULLSCREEN + 49:
-			if(emu && !now_fullscreen) {
-				set_window(hWnd, LOWORD(wParam) - ID_SCREEN_FULLSCREEN + MAX_WINDOW);
-			}
-			break;
-		case ID_SCREEN_WINDOW_STRETCH:
-		case ID_SCREEN_WINDOW_ASPECT:
-			config.window_stretch_type = LOWORD(wParam) - ID_SCREEN_WINDOW_STRETCH;
-			if(emu) {
-				if(!now_fullscreen) {
-					set_window(hWnd, prev_window_mode);
-				}
-			}
-			break;
-		case ID_SCREEN_FULLSCREEN_DOTBYDOT:
-		case ID_SCREEN_FULLSCREEN_STRETCH:
-		case ID_SCREEN_FULLSCREEN_ASPECT:
-		case ID_SCREEN_FULLSCREEN_FILL:
-			config.fullscreen_stretch_type = LOWORD(wParam) - ID_SCREEN_FULLSCREEN_DOTBYDOT;
-			if(emu) {
-				if(now_fullscreen) {
-					emu->set_host_window_size(-1, -1, false);
-				}
-			}
-			break;
-//#ifdef USE_SCREEN_ROTATE
-		case ID_SCREEN_ROTATE_0: case ID_SCREEN_ROTATE_90: case ID_SCREEN_ROTATE_180: case ID_SCREEN_ROTATE_270:
-			config.rotate_type = LOWORD(wParam) - ID_SCREEN_ROTATE_0;
-			if(emu) {
-				if(now_fullscreen) {
-					emu->set_host_window_size(-1, -1, false);
-				} else {
-					set_window(hWnd, prev_window_mode);
-				}
-			}
-			break;
-//#endif
-#ifdef USE_SCREEN_FILTER
-		case ID_FILTER_RGB:
-			config.filter_type = SCREEN_FILTER_RGB;
-			break;
-		case ID_FILTER_RF:
-			config.filter_type = SCREEN_FILTER_RF;
-			break;
-		case ID_FILTER_NONE:
-			config.filter_type = SCREEN_FILTER_NONE;
-			break;
-#endif
-		case ID_SOUND_FREQ0: case ID_SOUND_FREQ1: case ID_SOUND_FREQ2: case ID_SOUND_FREQ3:
-		case ID_SOUND_FREQ4: case ID_SOUND_FREQ5: case ID_SOUND_FREQ6: case ID_SOUND_FREQ7:
-			config.sound_frequency = LOWORD(wParam) - ID_SOUND_FREQ0;
-			if(emu) {
-				emu->update_config();
-			}
-			break;
-		case ID_SOUND_LATE0: case ID_SOUND_LATE1: case ID_SOUND_LATE2: case ID_SOUND_LATE3: case ID_SOUND_LATE4:
-			config.sound_latency = LOWORD(wParam) - ID_SOUND_LATE0;
-			if(emu) {
-				emu->update_config();
-			}
-			break;
-		case ID_SOUND_STRICT_RENDER: case ID_SOUND_LIGHT_RENDER:
-			config.sound_strict_rendering = (LOWORD(wParam) == ID_SOUND_STRICT_RENDER);
-			if(emu) {
-				emu->update_config();
-			}
-			break;
-#ifdef USE_SOUND_VOLUME
-		case ID_SOUND_VOLUME:
-			// thanks Marukun (64bit)
-			DialogBoxParam((HINSTANCE)GetModuleHandle(0), MAKEINTRESOURCE(IDD_VOLUME), hWnd, reinterpret_cast<DLGPROC>(VolumeWndProc), 0);
-			break;
-#endif
-#ifdef USE_JOYSTICK
-		case ID_INPUT_JOYSTICK0: case ID_INPUT_JOYSTICK1: case ID_INPUT_JOYSTICK2: case ID_INPUT_JOYSTICK3:
-		case ID_INPUT_JOYSTICK4: case ID_INPUT_JOYSTICK5: case ID_INPUT_JOYSTICK6: case ID_INPUT_JOYSTICK7:
-			{
-				// thanks Marukun (64bit)
-				LONG index = LOWORD(wParam) - ID_INPUT_JOYSTICK0;
-				DialogBoxParam((HINSTANCE)GetModuleHandle(0), MAKEINTRESOURCE(IDD_JOYSTICK), hWnd, reinterpret_cast<DLGPROC>(JoyWndProc), (LPARAM)&index);
-			}
-			break;
-		case ID_INPUT_JOYTOKEY:
-			{
-				// thanks Marukun (64bit)
-				LONG index = 0;
-				DialogBoxParam((HINSTANCE)GetModuleHandle(0), MAKEINTRESOURCE(IDD_JOYTOKEY), hWnd, reinterpret_cast<DLGPROC>(JoyToKeyWndProc), (LPARAM)&index);
-			}
-			break;
-#endif
-#ifdef USE_VIDEO_CAPTURE
-		case ID_CAPTURE_FILTER:
-			if(emu) {
-				emu->show_capture_dev_filter();
-			}
-			break;
-		case ID_CAPTURE_PIN:
-			if(emu) {
-				emu->show_capture_dev_pin();
-			}
-			break;
-		case ID_CAPTURE_SOURCE:
-			if(emu) {
-				emu->show_capture_dev_source();
-			}
-			break;
-		case ID_CAPTURE_CLOSE:
-			if(emu) {
-				emu->close_capture_dev();
-			}
-			break;
-		case ID_CAPTURE_DEVICE + 0: case ID_CAPTURE_DEVICE + 1: case ID_CAPTURE_DEVICE + 2: case ID_CAPTURE_DEVICE + 3:
-		case ID_CAPTURE_DEVICE + 4: case ID_CAPTURE_DEVICE + 5: case ID_CAPTURE_DEVICE + 6: case ID_CAPTURE_DEVICE + 7:
-			if(emu) {
-				emu->open_capture_dev(LOWORD(wParam) - ID_CAPTURE_DEVICE, false);
-			}
-			break;
-#endif
-#ifdef USE_CART
-	#if USE_CART >= 1
-		#define CART_MENU_ITEMS(drv, ID_OPEN_CART, ID_CLOSE_CART, ID_RECENT_CART) \
-		case ID_OPEN_CART: \
-			if(emu) { \
-				open_cart_dialog(hWnd, drv); \
-			} \
-			break; \
-		case ID_CLOSE_CART: \
-			if(emu) { \
-				emu->close_cart(drv); \
-			} \
-			break; \
-		case ID_RECENT_CART + 0: case ID_RECENT_CART + 1: case ID_RECENT_CART + 2: case ID_RECENT_CART + 3: \
-		case ID_RECENT_CART + 4: case ID_RECENT_CART + 5: case ID_RECENT_CART + 6: case ID_RECENT_CART + 7: \
-			if(emu) { \
-				open_recent_cart(drv, LOWORD(wParam) - ID_RECENT_CART); \
-			} \
-			break;
-		CART_MENU_ITEMS(0, ID_OPEN_CART1, ID_CLOSE_CART1, ID_RECENT_CART1)
-	#endif
-	#if USE_CART >= 2
-		CART_MENU_ITEMS(1, ID_OPEN_CART2, ID_CLOSE_CART2, ID_RECENT_CART2)
-	#endif
-#endif
-#ifdef USE_FLOPPY_DISK
-	#if USE_FLOPPY_DISK >= 1
-		#define FD_MENU_ITEMS(drv, ID_OPEN_FD, ID_CLOSE_FD, ID_OPEN_BLANK_2D_FD, ID_OPEN_BLANK_2DD_FD, ID_OPEN_BLANK_2HD_FD, ID_WRITE_PROTECT_FD, ID_CORRECT_TIMING_FD, ID_IGNORE_CRC_FD, ID_RECENT_FD, ID_SELECT_D88_BANK, ID_EJECT_D88_BANK) \
-		case ID_OPEN_FD: \
-			if(emu) { \
-				open_floppy_disk_dialog(hWnd, drv); \
-			} \
-			break; \
-		case ID_CLOSE_FD: \
-			if(emu) { \
-				emu->close_floppy_disk(drv); \
-			} \
-			break; \
-		case ID_OPEN_BLANK_2D_FD: \
-			if(emu) { \
-				open_blank_floppy_disk_dialog(hWnd, drv, 0x00); \
-			} \
-			break; \
-		case ID_OPEN_BLANK_2DD_FD: \
-			if(emu) { \
-				open_blank_floppy_disk_dialog(hWnd, drv, 0x10); \
-			} \
-			break; \
-		case ID_OPEN_BLANK_2HD_FD: \
-			if(emu) { \
-				open_blank_floppy_disk_dialog(hWnd, drv, 0x20); \
-			} \
-			break; \
-		case ID_WRITE_PROTECT_FD: \
-			if(emu) { \
-				emu->is_floppy_disk_protected(drv, !emu->is_floppy_disk_protected(drv)); \
-			} \
-			break; \
-		case ID_CORRECT_TIMING_FD: \
-			config.correct_disk_timing[drv] = !config.correct_disk_timing[drv]; \
-			break; \
-		case ID_IGNORE_CRC_FD: \
-			config.ignore_disk_crc[drv] = !config.ignore_disk_crc[drv]; \
-			break; \
-		case ID_RECENT_FD + 0: case ID_RECENT_FD + 1: case ID_RECENT_FD + 2: case ID_RECENT_FD + 3: \
-		case ID_RECENT_FD + 4: case ID_RECENT_FD + 5: case ID_RECENT_FD + 6: case ID_RECENT_FD + 7: \
-			if(emu) { \
-				open_recent_floppy_disk(drv, LOWORD(wParam) - ID_RECENT_FD); \
-			} \
-			break; \
-		case ID_SELECT_D88_BANK +  0: case ID_SELECT_D88_BANK +  1: case ID_SELECT_D88_BANK +  2: case ID_SELECT_D88_BANK +  3: \
-		case ID_SELECT_D88_BANK +  4: case ID_SELECT_D88_BANK +  5: case ID_SELECT_D88_BANK +  6: case ID_SELECT_D88_BANK +  7: \
-		case ID_SELECT_D88_BANK +  8: case ID_SELECT_D88_BANK +  9: case ID_SELECT_D88_BANK + 10: case ID_SELECT_D88_BANK + 11: \
-		case ID_SELECT_D88_BANK + 12: case ID_SELECT_D88_BANK + 13: case ID_SELECT_D88_BANK + 14: case ID_SELECT_D88_BANK + 15: \
-		case ID_SELECT_D88_BANK + 16: case ID_SELECT_D88_BANK + 17: case ID_SELECT_D88_BANK + 18: case ID_SELECT_D88_BANK + 19: \
-		case ID_SELECT_D88_BANK + 20: case ID_SELECT_D88_BANK + 21: case ID_SELECT_D88_BANK + 22: case ID_SELECT_D88_BANK + 23: \
-		case ID_SELECT_D88_BANK + 24: case ID_SELECT_D88_BANK + 25: case ID_SELECT_D88_BANK + 26: case ID_SELECT_D88_BANK + 27: \
-		case ID_SELECT_D88_BANK + 28: case ID_SELECT_D88_BANK + 29: case ID_SELECT_D88_BANK + 30: case ID_SELECT_D88_BANK + 31: \
-		case ID_SELECT_D88_BANK + 32: case ID_SELECT_D88_BANK + 33: case ID_SELECT_D88_BANK + 34: case ID_SELECT_D88_BANK + 35: \
-		case ID_SELECT_D88_BANK + 36: case ID_SELECT_D88_BANK + 37: case ID_SELECT_D88_BANK + 38: case ID_SELECT_D88_BANK + 39: \
-		case ID_SELECT_D88_BANK + 40: case ID_SELECT_D88_BANK + 41: case ID_SELECT_D88_BANK + 42: case ID_SELECT_D88_BANK + 43: \
-		case ID_SELECT_D88_BANK + 44: case ID_SELECT_D88_BANK + 45: case ID_SELECT_D88_BANK + 46: case ID_SELECT_D88_BANK + 47: \
-		case ID_SELECT_D88_BANK + 48: case ID_SELECT_D88_BANK + 49: case ID_SELECT_D88_BANK + 50: case ID_SELECT_D88_BANK + 51: \
-		case ID_SELECT_D88_BANK + 52: case ID_SELECT_D88_BANK + 53: case ID_SELECT_D88_BANK + 54: case ID_SELECT_D88_BANK + 55: \
-		case ID_SELECT_D88_BANK + 56: case ID_SELECT_D88_BANK + 57: case ID_SELECT_D88_BANK + 58: case ID_SELECT_D88_BANK + 59: \
-		case ID_SELECT_D88_BANK + 60: case ID_SELECT_D88_BANK + 61: case ID_SELECT_D88_BANK + 62: case ID_SELECT_D88_BANK + 63: \
-			if(emu) { \
-				select_d88_bank(drv, LOWORD(wParam) - ID_SELECT_D88_BANK); \
-			} \
-			break; \
-		case ID_EJECT_D88_BANK: \
-			if(emu) { \
-				select_d88_bank(drv, -1); \
-			} \
-			break;
-		FD_MENU_ITEMS(0, ID_OPEN_FD1, ID_CLOSE_FD1, ID_OPEN_BLANK_2D_FD1, ID_OPEN_BLANK_2DD_FD1, ID_OPEN_BLANK_2HD_FD1, ID_WRITE_PROTECT_FD1, ID_CORRECT_TIMING_FD1, ID_IGNORE_CRC_FD1, ID_RECENT_FD1, ID_SELECT_D88_BANK1, ID_EJECT_D88_BANK1)
-	#endif
-	#if USE_FLOPPY_DISK >= 2
-		FD_MENU_ITEMS(1, ID_OPEN_FD2, ID_CLOSE_FD2, ID_OPEN_BLANK_2D_FD2, ID_OPEN_BLANK_2DD_FD2, ID_OPEN_BLANK_2HD_FD2, ID_WRITE_PROTECT_FD2, ID_CORRECT_TIMING_FD2, ID_IGNORE_CRC_FD2, ID_RECENT_FD2, ID_SELECT_D88_BANK2, ID_EJECT_D88_BANK2)
-	#endif
-	#if USE_FLOPPY_DISK >= 3
-		FD_MENU_ITEMS(2, ID_OPEN_FD3, ID_CLOSE_FD3, ID_OPEN_BLANK_2D_FD3, ID_OPEN_BLANK_2DD_FD3, ID_OPEN_BLANK_2HD_FD3, ID_WRITE_PROTECT_FD3, ID_CORRECT_TIMING_FD3, ID_IGNORE_CRC_FD3, ID_RECENT_FD3, ID_SELECT_D88_BANK3, ID_EJECT_D88_BANK3)
-	#endif
-	#if USE_FLOPPY_DISK >= 4
-		FD_MENU_ITEMS(3, ID_OPEN_FD4, ID_CLOSE_FD4, ID_OPEN_BLANK_2D_FD4, ID_OPEN_BLANK_2DD_FD4, ID_OPEN_BLANK_2HD_FD4, ID_WRITE_PROTECT_FD4, ID_CORRECT_TIMING_FD4, ID_IGNORE_CRC_FD4, ID_RECENT_FD4, ID_SELECT_D88_BANK4, ID_EJECT_D88_BANK4)
-	#endif
-	#if USE_FLOPPY_DISK >= 5
-		FD_MENU_ITEMS(4, ID_OPEN_FD5, ID_CLOSE_FD5, ID_OPEN_BLANK_2D_FD5, ID_OPEN_BLANK_2DD_FD5, ID_OPEN_BLANK_2HD_FD5, ID_WRITE_PROTECT_FD5, ID_CORRECT_TIMING_FD5, ID_IGNORE_CRC_FD5, ID_RECENT_FD5, ID_SELECT_D88_BANK5, ID_EJECT_D88_BANK5)
-	#endif
-	#if USE_FLOPPY_DISK >= 6
-		FD_MENU_ITEMS(5, ID_OPEN_FD6, ID_CLOSE_FD6, ID_OPEN_BLANK_2D_FD6, ID_OPEN_BLANK_2DD_FD6, ID_OPEN_BLANK_2HD_FD6, ID_WRITE_PROTECT_FD6, ID_CORRECT_TIMING_FD6, ID_IGNORE_CRC_FD6, ID_RECENT_FD6, ID_SELECT_D88_BANK6, ID_EJECT_D88_BANK6)
-	#endif
-	#if USE_FLOPPY_DISK >= 7
-		FD_MENU_ITEMS(6, ID_OPEN_FD7, ID_CLOSE_FD7, ID_OPEN_BLANK_2D_FD7, ID_OPEN_BLANK_2DD_FD7, ID_OPEN_BLANK_2HD_FD7, ID_WRITE_PROTECT_FD7, ID_CORRECT_TIMING_FD7, ID_IGNORE_CRC_FD7, ID_RECENT_FD7, ID_SELECT_D88_BANK7, ID_EJECT_D88_BANK7)
-	#endif
-	#if USE_FLOPPY_DISK >= 8
-		FD_MENU_ITEMS(7, ID_OPEN_FD8, ID_CLOSE_FD8, ID_OPEN_BLANK_2D_FD8, ID_OPEN_BLANK_2DD_FD8, ID_OPEN_BLANK_2HD_FD8, ID_WRITE_PROTECT_FD8, ID_CORRECT_TIMING_FD8, ID_IGNORE_CRC_FD8, ID_RECENT_FD8, ID_SELECT_D88_BANK8, ID_EJECT_D88_BANK8)
-	#endif
-#endif
-#ifdef USE_QUICK_DISK
-	#if USE_QUICK_DISK >= 1
-		#define QD_MENU_ITEMS(drv, ID_OPEN_QD, ID_CLOSE_QD, ID_RECENT_QD) \
-		case ID_OPEN_QD: \
-			if(emu) { \
-				open_quick_disk_dialog(hWnd, drv); \
-			} \
-			break; \
-		case ID_CLOSE_QD: \
-			if(emu) { \
-				emu->close_quick_disk(drv); \
-			} \
-			break; \
-		case ID_RECENT_QD + 0: case ID_RECENT_QD + 1: case ID_RECENT_QD + 2: case ID_RECENT_QD + 3: \
-		case ID_RECENT_QD + 4: case ID_RECENT_QD + 5: case ID_RECENT_QD + 6: case ID_RECENT_QD + 7: \
-			if(emu) { \
-				open_recent_quick_disk(drv, LOWORD(wParam) - ID_RECENT_QD); \
-			} \
-			break;
-		QD_MENU_ITEMS(0, ID_OPEN_QD1, ID_CLOSE_QD1, ID_RECENT_QD1)
-	#endif
-	#if USE_QUICK_DISK >= 2
-		QD_MENU_ITEMS(1, ID_OPEN_QD2, ID_CLOSE_QD2, ID_RECENT_QD2)
-	#endif
-#endif
-#ifdef USE_HARD_DISK
-	#if USE_HARD_DISK >= 1
-		#define HD_MENU_ITEMS(drv, ID_OPEN_HD, ID_CLOSE_HD, ID_OPEN_BLANK_20MB_HD, ID_OPEN_BLANK_20MB_1024_HD, ID_OPEN_BLANK_40MB_HD, ID_RECENT_HD) \
-		case ID_OPEN_HD: \
-			if(emu) { \
-				open_hard_disk_dialog(hWnd, drv); \
-			} \
-			break; \
-		case ID_CLOSE_HD: \
-			if(emu) { \
-				emu->close_hard_disk(drv); \
-			} \
-			break; \
-		case ID_OPEN_BLANK_20MB_HD: \
-			if(emu) { \
-				open_blank_hard_disk_dialog(hWnd, drv, 256, 33, 4, 615); \
-			} \
-			break; \
-		case ID_OPEN_BLANK_20MB_1024_HD: \
-			if(emu) { \
-				open_blank_hard_disk_dialog(hWnd, drv, 1024, 8, 4, 615); \
-			} \
-			break; \
-		case ID_OPEN_BLANK_40MB_HD: \
-			if(emu) { \
-				open_blank_hard_disk_dialog(hWnd, drv, 256, 33, 8, 615); \
-			} \
-			break; \
-		case ID_RECENT_HD + 0: case ID_RECENT_HD + 1: case ID_RECENT_HD + 2: case ID_RECENT_HD + 3: \
-		case ID_RECENT_HD + 4: case ID_RECENT_HD + 5: case ID_RECENT_HD + 6: case ID_RECENT_HD + 7: \
-			if(emu) { \
-				open_recent_hard_disk(drv, LOWORD(wParam) - ID_RECENT_HD); \
-			} \
-			break;
-		HD_MENU_ITEMS(0, ID_OPEN_HD1, ID_CLOSE_HD1, ID_OPEN_BLANK_20MB_HD1, ID_OPEN_BLANK_20MB_1024_HD1, ID_OPEN_BLANK_40MB_HD1, ID_RECENT_HD1)
-	#endif
-	#if USE_HARD_DISK >= 2
-		HD_MENU_ITEMS(1, ID_OPEN_HD2, ID_CLOSE_HD2, ID_OPEN_BLANK_20MB_HD2, ID_OPEN_BLANK_20MB_1024_HD2, ID_OPEN_BLANK_40MB_HD2, ID_RECENT_HD2)
-	#endif
-	#if USE_HARD_DISK >= 3
-		HD_MENU_ITEMS(2, ID_OPEN_HD3, ID_CLOSE_HD3, ID_OPEN_BLANK_20MB_HD3, ID_OPEN_BLANK_20MB_1024_HD3, ID_OPEN_BLANK_40MB_HD3, ID_RECENT_HD3)
-	#endif
-	#if USE_HARD_DISK >= 4
-		HD_MENU_ITEMS(3, ID_OPEN_HD4, ID_CLOSE_HD4, ID_OPEN_BLANK_20MB_HD4, ID_OPEN_BLANK_20MB_1024_HD4, ID_OPEN_BLANK_40MB_HD4, ID_RECENT_HD4)
-	#endif
-	#if USE_HARD_DISK >= 5
-		HD_MENU_ITEMS(4, ID_OPEN_HD5, ID_CLOSE_HD5, ID_OPEN_BLANK_20MB_HD5, ID_OPEN_BLANK_20MB_1024_HD5, ID_OPEN_BLANK_40MB_HD5, ID_RECENT_HD5)
-	#endif
-	#if USE_HARD_DISK >= 6
-		HD_MENU_ITEMS(5, ID_OPEN_HD6, ID_CLOSE_HD6, ID_OPEN_BLANK_20MB_HD6, ID_OPEN_BLANK_20MB_1024_HD6, ID_OPEN_BLANK_40MB_HD6, ID_RECENT_HD6)
-	#endif
-	#if USE_HARD_DISK >= 7
-		HD_MENU_ITEMS(6, ID_OPEN_HD7, ID_CLOSE_HD7, ID_OPEN_BLANK_20MB_HD7, ID_OPEN_BLANK_20MB_1024_HD7, ID_OPEN_BLANK_40MB_HD7, ID_RECENT_HD7)
-	#endif
-	#if USE_HARD_DISK >= 8
-		HD_MENU_ITEMS(7, ID_OPEN_HD8, ID_CLOSE_HD8, ID_OPEN_BLANK_20MB_HD8, ID_OPEN_BLANK_20MB_1024_HD8, ID_OPEN_BLANK_40MB_HD8, ID_RECENT_HD8)
-	#endif
-#endif
-#ifdef USE_TAPE
-	#if USE_TAPE >= 1
-		#define TAPE_MENU_ITEMS(drv, ID_PLAY_TAPE, ID_REC_TAPE, ID_CLOSE_TAPE, ID_PLAY_BUTTON, ID_STOP_BUTTON, ID_FAST_FORWARD, ID_FAST_REWIND, ID_APSS_FORWARD, ID_APSS_REWIND, ID_USE_WAVE_SHAPER, ID_DIRECT_LOAD_MZT, ID_TAPE_BAUD_LOW, ID_TAPE_BAUD_HIGH, ID_RECENT_TAPE) \
-		case ID_PLAY_TAPE: \
-			if(emu) { \
-				open_tape_dialog(hWnd, drv, true); \
-			} \
-			break; \
-		case ID_REC_TAPE: \
-			if(emu) { \
-				open_tape_dialog(hWnd, drv, false); \
-			} \
-			break; \
-		case ID_CLOSE_TAPE: \
-			if(emu) { \
-				emu->close_tape(drv); \
-			} \
-			break; \
-		case ID_PLAY_BUTTON: \
-			if(emu) { \
-				emu->push_play(drv); \
-			} \
-			break; \
-		case ID_STOP_BUTTON: \
-			if(emu) { \
-				emu->push_stop(drv); \
-			} \
-			break; \
-		case ID_FAST_FORWARD: \
-			if(emu) { \
-				emu->push_fast_forward(drv); \
-			} \
-			break; \
-		case ID_FAST_REWIND: \
-			if(emu) { \
-				emu->push_fast_rewind(drv); \
-			} \
-			break; \
-		case ID_APSS_FORWARD: \
-			if(emu) { \
-				emu->push_apss_forward(drv); \
-			} \
-			break; \
-		case ID_APSS_REWIND: \
-			if(emu) { \
-				emu->push_apss_rewind(drv); \
-			} \
-			break; \
-		case ID_USE_WAVE_SHAPER: \
-			config.wave_shaper[drv] = !config.wave_shaper[drv]; \
-			break; \
-		case ID_DIRECT_LOAD_MZT: \
-			config.direct_load_mzt[drv] = !config.direct_load_mzt[drv]; \
-			break; \
-		case ID_TAPE_BAUD_LOW: \
-			config.baud_high[drv] = false; \
-			break; \
-		case ID_TAPE_BAUD_HIGH: \
-			config.baud_high[drv] = true; \
-			break; \
-		case ID_RECENT_TAPE + 0: case ID_RECENT_TAPE + 1: case ID_RECENT_TAPE + 2: case ID_RECENT_TAPE + 3: \
-		case ID_RECENT_TAPE + 4: case ID_RECENT_TAPE + 5: case ID_RECENT_TAPE + 6: case ID_RECENT_TAPE + 7: \
-			if(emu) { \
-				open_recent_tape(drv, LOWORD(wParam) - ID_RECENT_TAPE); \
-			} \
-			break;
-		TAPE_MENU_ITEMS(0, ID_PLAY_TAPE1, ID_REC_TAPE1, ID_CLOSE_TAPE1, ID_PLAY_BUTTON1, ID_STOP_BUTTON1, ID_FAST_FORWARD1, ID_FAST_REWIND1, ID_APSS_FORWARD1, ID_APSS_REWIND1, ID_USE_WAVE_SHAPER1, ID_DIRECT_LOAD_MZT1, ID_TAPE_BAUD_LOW1, ID_TAPE_BAUD_HIGH1, ID_RECENT_TAPE1)
-	#endif
-	#if USE_TAPE >= 2
-		TAPE_MENU_ITEMS(1, ID_PLAY_TAPE2, ID_REC_TAPE2, ID_CLOSE_TAPE2, ID_PLAY_BUTTON2, ID_STOP_BUTTON2, ID_FAST_FORWARD2, ID_FAST_REWIND2, ID_APSS_FORWARD2, ID_APSS_REWIND2, ID_USE_WAVE_SHAPER2, ID_DIRECT_LOAD_MZT2, ID_TAPE_BAUD_LOW2, ID_TAPE_BAUD_HIGH2, ID_RECENT_TAPE2)
-	#endif
-#endif
-#ifdef USE_COMPACT_DISC
-	#if USE_COMPACT_DISC >= 1
-		#define COMPACT_DISC_MENU_ITEMS(drv, ID_OPEN_COMPACT_DISC, ID_CLOSE_COMPACT_DISC, ID_RECENT_COMPACT_DISC) \
-		case ID_OPEN_COMPACT_DISC: \
-			if(emu) { \
-				open_compact_disc_dialog(hWnd, drv); \
-			} \
-			break; \
-		case ID_CLOSE_COMPACT_DISC: \
-			if(emu) { \
-				emu->close_compact_disc(drv); \
-			} \
-			break; \
-		case ID_RECENT_COMPACT_DISC + 0: case ID_RECENT_COMPACT_DISC + 1: case ID_RECENT_COMPACT_DISC + 2: case ID_RECENT_COMPACT_DISC + 3: \
-		case ID_RECENT_COMPACT_DISC + 4: case ID_RECENT_COMPACT_DISC + 5: case ID_RECENT_COMPACT_DISC + 6: case ID_RECENT_COMPACT_DISC + 7: \
-			if(emu) { \
-				open_recent_compact_disc(drv, LOWORD(wParam) - ID_RECENT_COMPACT_DISC); \
-			} \
-			break;
-		COMPACT_DISC_MENU_ITEMS(0, ID_OPEN_COMPACT_DISC1, ID_CLOSE_COMPACT_DISC1, ID_RECENT_COMPACT_DISC1)
-	#endif
-	#if USE_COMPACT_DISC >= 2
-		COMPACT_DISC_MENU_ITEMS(1, ID_OPEN_COMPACT_DISC2, ID_CLOSE_COMPACT_DISC2, ID_RECENT_COMPACT_DISC2)
-	#endif
-#endif
-#ifdef USE_LASER_DISC
-	#if USE_LASER_DISC >= 1
-		#define LASER_DISC_MENU_ITEMS(drv, ID_OPEN_LASER_DISC, ID_CLOSE_LASER_DISC, ID_RECENT_LASER_DISC) \
-		case ID_OPEN_LASER_DISC: \
-			if(emu) { \
-				open_laser_disc_dialog(hWnd, drv); \
-			} \
-			break; \
-		case ID_CLOSE_LASER_DISC: \
-			if(emu) { \
-				emu->close_laser_disc(drv); \
-			} \
-			break; \
-		case ID_RECENT_LASER_DISC + 0: case ID_RECENT_LASER_DISC + 1: case ID_RECENT_LASER_DISC + 2: case ID_RECENT_LASER_DISC + 3: \
-		case ID_RECENT_LASER_DISC + 4: case ID_RECENT_LASER_DISC + 5: case ID_RECENT_LASER_DISC + 6: case ID_RECENT_LASER_DISC + 7: \
-			if(emu) { \
-				open_recent_laser_disc(drv, LOWORD(wParam) - ID_RECENT_LASER_DISC); \
-			} \
-			break;
-		LASER_DISC_MENU_ITEMS(0, ID_OPEN_LASER_DISC1, ID_CLOSE_LASER_DISC1, ID_RECENT_LASER_DISC1)
-	#endif
-	#if USE_LASER_DISC >= 2
-		LASER_DISC_MENU_ITEMS(1, ID_OPEN_LASER_DISC2, ID_CLOSE_LASER_DISC2, ID_RECENT_LASER_DISC2)
-	#endif
-#endif
-#ifdef USE_BINARY_FILE
-	#if USE_BINARY_FILE >= 1
-		#define BINARY_MENU_ITEMS(drv, ID_LOAD_BINARY, ID_SAVE_BINARY, ID_RECENT_BINARY) \
-		case ID_LOAD_BINARY: \
-			if(emu) { \
-				open_binary_dialog(hWnd, drv, true); \
-			} \
-			break; \
-		case ID_SAVE_BINARY: \
-			if(emu) { \
-				open_binary_dialog(hWnd, drv, false); \
-			} \
-			break; \
-		case ID_RECENT_BINARY + 0: case ID_RECENT_BINARY + 1: case ID_RECENT_BINARY + 2: case ID_RECENT_BINARY + 3: \
-		case ID_RECENT_BINARY + 4: case ID_RECENT_BINARY + 5: case ID_RECENT_BINARY + 6: case ID_RECENT_BINARY + 7: \
-			if(emu) { \
-				open_recent_binary(drv, LOWORD(wParam) - ID_RECENT_BINARY); \
-			} \
-			break;
-		BINARY_MENU_ITEMS(0, ID_LOAD_BINARY1, ID_SAVE_BINARY1, ID_RECENT_BINARY1)
-	#endif
-	#if USE_BINARY_FILE >= 2
-		BINARY_MENU_ITEMS(1, ID_LOAD_BINARY2, ID_SAVE_BINARY2, ID_RECENT_BINARY2)
-	#endif
-#endif
-#ifdef USE_BUBBLE
-	#if USE_BUBBLE >= 1
-		#define BUBBLE_CASETTE_MENU_ITEMS(drv, ID_OPEN_BUBBLE, ID_CLOSE_BUBBLE, ID_RECENT_BUBBLE) \
-		case ID_OPEN_BUBBLE: \
-			if(emu) { \
-				open_bubble_casette_dialog(hWnd, drv); \
-			} \
-			break; \
-		case ID_CLOSE_BUBBLE: \
-			if(emu) { \
-				emu->close_bubble_casette(drv); \
-			} \
-			break; \
-		case ID_RECENT_BUBBLE + 0: case ID_RECENT_BUBBLE + 1: case ID_RECENT_BUBBLE + 2: case ID_RECENT_BUBBLE + 3: \
-		case ID_RECENT_BUBBLE + 4: case ID_RECENT_BUBBLE + 5: case ID_RECENT_BUBBLE + 6: case ID_RECENT_BUBBLE + 7: \
-			if(emu) { \
-				open_recent_bubble_casette(drv, LOWORD(wParam) - ID_RECENT_BUBBLE); \
-			} \
-			break;
-		BUBBLE_CASETTE_MENU_ITEMS(0, ID_OPEN_BUBBLE1, ID_CLOSE_BUBBLE1, ID_RECENT_BUBBLE1)
-	#endif
-	#if USE_BUBBLE >= 2
-		BUBBLE_CASETTE_MENU_ITEMS(1, ID_OPEN_BUBBLE2, ID_CLOSE_BUBBLE2, ID_RECENT_BUBBLE2)
-	#endif
-#endif
-		case ID_ACCEL_SCREEN:
-			if(emu) {
-				emu->suspend();
-				set_window(hWnd, now_fullscreen ? prev_window_mode : -1);
-			}
-			break;
-#ifdef USE_MOUSE
-		case ID_ACCEL_MOUSE:
-			if(emu) {
-				emu->toggle_mouse();
-			}
-			break;
-#endif
-		case ID_ACCEL_SPEED:
-			config.full_speed = !config.full_speed;
-			break;
-#ifdef USE_AUTO_KEY
-		case ID_ACCEL_ROMAJI:
-			if(emu) {
-				if(!config.romaji_to_kana) {
-					emu->set_auto_key_char(1); // start
-					config.romaji_to_kana = true;
-				} else {
-					emu->set_auto_key_char(0); // end
-					config.romaji_to_kana = false;
-				}
-			}
-			break;
-#endif
-#ifdef ONE_BOARD_MICRO_COMPUTER
-		case ID_BUTTON +  0: case ID_BUTTON +  1: case ID_BUTTON +  2: case ID_BUTTON +  3: case ID_BUTTON +  4:
-		case ID_BUTTON +  5: case ID_BUTTON +  6: case ID_BUTTON +  7: case ID_BUTTON +  8: case ID_BUTTON +  9:
-		case ID_BUTTON + 10: case ID_BUTTON + 11: case ID_BUTTON + 12: case ID_BUTTON + 13: case ID_BUTTON + 14:
-		case ID_BUTTON + 15: case ID_BUTTON + 16: case ID_BUTTON + 17: case ID_BUTTON + 18: case ID_BUTTON + 19:
-		case ID_BUTTON + 20: case ID_BUTTON + 21: case ID_BUTTON + 22: case ID_BUTTON + 23: case ID_BUTTON + 24:
-		case ID_BUTTON + 25: case ID_BUTTON + 26: case ID_BUTTON + 27: case ID_BUTTON + 28: case ID_BUTTON + 29:
-		case ID_BUTTON + 30: case ID_BUTTON + 31: case ID_BUTTON + 32: case ID_BUTTON + 33: case ID_BUTTON + 34:
-		case ID_BUTTON + 35: case ID_BUTTON + 36: case ID_BUTTON + 37: case ID_BUTTON + 38: case ID_BUTTON + 39:
-		case ID_BUTTON + 40: case ID_BUTTON + 41: case ID_BUTTON + 42: case ID_BUTTON + 43: case ID_BUTTON + 44:
-		case ID_BUTTON + 45: case ID_BUTTON + 46: case ID_BUTTON + 47: case ID_BUTTON + 48: case ID_BUTTON + 49:
-		case ID_BUTTON + 50: case ID_BUTTON + 51: case ID_BUTTON + 52: case ID_BUTTON + 53: case ID_BUTTON + 54:
-		case ID_BUTTON + 55: case ID_BUTTON + 56: case ID_BUTTON + 57: case ID_BUTTON + 58: case ID_BUTTON + 59:
-		case ID_BUTTON + 60: case ID_BUTTON + 61: case ID_BUTTON + 62: case ID_BUTTON + 63: case ID_BUTTON + 64:
-		case ID_BUTTON + 65: case ID_BUTTON + 66: case ID_BUTTON + 67: case ID_BUTTON + 68: case ID_BUTTON + 69:
-		case ID_BUTTON + 70: case ID_BUTTON + 71: case ID_BUTTON + 72: case ID_BUTTON + 73: case ID_BUTTON + 74:
-		case ID_BUTTON + 75: case ID_BUTTON + 76: case ID_BUTTON + 77: case ID_BUTTON + 78: case ID_BUTTON + 79:
-		case ID_BUTTON + 80: case ID_BUTTON + 81: case ID_BUTTON + 82: case ID_BUTTON + 83: case ID_BUTTON + 84:
-		case ID_BUTTON + 85: case ID_BUTTON + 86: case ID_BUTTON + 87: case ID_BUTTON + 88: case ID_BUTTON + 89:
-		case ID_BUTTON + 90: case ID_BUTTON + 91: case ID_BUTTON + 92: case ID_BUTTON + 93: case ID_BUTTON + 94:
-		case ID_BUTTON + 95: case ID_BUTTON + 96: case ID_BUTTON + 97: case ID_BUTTON + 98: case ID_BUTTON + 99:
-			if(emu) {
-				emu->press_button(LOWORD(wParam) - ID_BUTTON);
-			}
-			break;
-#endif
-		}
-		break;
-	}
-	return DefWindowProc(hWnd, iMsg, wParam, lParam);
-}
-
-// ----------------------------------------------------------------------------
-// menu
-// ----------------------------------------------------------------------------
-
-void update_control_menu(HMENU hMenu)
-{
-	if(config.cpu_power >= 0 && config.cpu_power < 5) {
-		CheckMenuRadioItem(hMenu, ID_CPU_POWER0, ID_CPU_POWER4, ID_CPU_POWER0 + config.cpu_power, MF_BYCOMMAND);
-	}
-	CheckMenuItem(hMenu, ID_FULL_SPEED, config.full_speed ? MF_CHECKED : MF_UNCHECKED);
-	CheckMenuItem(hMenu, ID_DRIVE_VM_IN_OPECODE, config.drive_vm_in_opecode ? MF_CHECKED : MF_UNCHECKED);
-#ifdef USE_AUTO_KEY
-	bool now_paste = true, now_stop = true;
-	if(emu) {
-		now_paste = emu->is_auto_key_running();
-		now_stop = !now_paste;
-	}
-	EnableMenuItem(hMenu, ID_AUTOKEY_START, now_paste ? MF_GRAYED : MF_ENABLED);
-	EnableMenuItem(hMenu, ID_AUTOKEY_STOP, now_stop ? MF_GRAYED : MF_ENABLED);
-	CheckMenuItem(hMenu, ID_ROMAJI_TO_KANA, config.romaji_to_kana ? MF_CHECKED : MF_UNCHECKED);
-#endif
-#ifdef USE_DEBUGGER
-	for(int i = 0; i < 8; i++) {
-		EnableMenuItem(hMenu, ID_OPEN_DEBUGGER0 + i, emu && !emu->now_debugging && emu->is_debugger_enabled(i) ? MF_ENABLED : MF_GRAYED);
-	}
-	EnableMenuItem(hMenu, ID_CLOSE_DEBUGGER, emu && emu->now_debugging ? MF_ENABLED : MF_GRAYED);
-#endif
-}
-
-#ifdef USE_STATE
-void update_save_state_menu(HMENU hMenu)
-{
-	HANDLE hFile;
-	FILETIME ftWrite;
-	FILETIME ftLocal;
-	SYSTEMTIME st;
-	_TCHAR buf[64];
-	MENUITEMINFO info;
-	
-	ZeroMemory(&info, sizeof(info));
-	info.cbSize = sizeof(info);
-	info.fMask = MIIM_TYPE;
-	info.fType = MFT_STRING;
-	info.dwTypeData = buf;
-	
-	for(int i = 0; i < 10; i++) {
-		if((hFile = CreateFile(emu->state_file_path(i), GENERIC_READ, 0, NULL, OPEN_EXISTING, FILE_ATTRIBUTE_NORMAL, 0)) != INVALID_HANDLE_VALUE){
-			GetFileTime(hFile, NULL, NULL, &ftWrite);
-			FileTimeToLocalFileTime(&ftWrite, &ftLocal);
-			FileTimeToSystemTime(&ftLocal, &st);
-//			if(st.wHour < 12) {
-//				my_stprintf_s(buf, 64, _T("%d:  %04d-%02d-%02d  %02d:%02d:%02d AM"), i, st.wYear, st.wMonth, st.wDay, st.wHour % 12, st.wMinute, st.wSecond);
-//			} else {
-//				my_stprintf_s(buf, 64, _T("%d:  %04d-%02d-%02d  %02d:%02d:%02d PM"), i, st.wYear, st.wMonth, st.wDay, st.wHour % 12, st.wMinute, st.wSecond);
-//			}
-			my_stprintf_s(buf, 64, _T("%d:  %04d-%02d-%02d  %02d:%02d:%02d"), i, st.wYear, st.wMonth, st.wDay, st.wHour, st.wMinute, st.wSecond);
-			CloseHandle(hFile);
-		} else {
-//			my_stprintf_s(buf, 64, _T("%d: ----/--/-- --:--:--"), i);
-			my_stprintf_s(buf, 64, _T("%d: (No Data)"), i);
-		}
-		SetMenuItemInfo(hMenu, ID_SAVE_STATE0 + i, FALSE, &info);
-	}
-}
-
-void update_load_state_menu(HMENU hMenu)
-{
-	HANDLE hFile;
-	FILETIME ftWrite;
-	FILETIME ftLocal;
-	SYSTEMTIME st;
-	_TCHAR buf[64];
-	MENUITEMINFO info;
-	
-	ZeroMemory(&info, sizeof(info));
-	info.cbSize = sizeof(info);
-	info.fMask = MIIM_TYPE;
-	info.fType = MFT_STRING;
-	info.dwTypeData = buf;
-	
-	for(int i = 0; i < 10; i++) {
-		if((hFile = CreateFile(emu->state_file_path(i), GENERIC_READ, 0, NULL, OPEN_EXISTING, FILE_ATTRIBUTE_NORMAL, 0)) != INVALID_HANDLE_VALUE){
-			GetFileTime(hFile, NULL, NULL, &ftWrite);
-			FileTimeToLocalFileTime(&ftWrite, &ftLocal);
-			FileTimeToSystemTime(&ftLocal, &st);
-//			if(st.wHour < 12) {
-//				my_stprintf_s(buf, 64, _T("%d:  %04d-%02d-%02d  %02d:%02d:%02d AM"), i, st.wYear, st.wMonth, st.wDay, st.wHour % 12, st.wMinute, st.wSecond);
-//			} else {
-//				my_stprintf_s(buf, 64, _T("%d:  %04d-%02d-%02d  %02d:%02d:%02d PM"), i, st.wYear, st.wMonth, st.wDay, st.wHour % 12, st.wMinute, st.wSecond);
-//			}
-			my_stprintf_s(buf, 64, _T("%d:  %04d-%02d-%02d  %02d:%02d:%02d"), i, st.wYear, st.wMonth, st.wDay, st.wHour, st.wMinute, st.wSecond);
-			EnableMenuItem(hMenu, ID_LOAD_STATE0 + i, MF_ENABLED);
-			CloseHandle(hFile);
-		} else {
-//			my_stprintf_s(buf, 64, _T("%d: ----/--/-- --:--:--"), i);
-			my_stprintf_s(buf, 64, _T("%d: (No Data)"), i);
-			EnableMenuItem(hMenu, ID_LOAD_STATE0 + i, MF_GRAYED);
-		}
-		SetMenuItemInfo(hMenu, ID_LOAD_STATE0 + i, FALSE, &info);
-	}
-}
-#endif
-
-#ifdef USE_CART
-void update_cart_menu(HMENU hMenu, int drv, UINT ID_RECENT_CART, UINT ID_CLOSE_CART)
-{
-	bool flag = false;
-	for(int i = 0; i < MAX_HISTORY; i++) {
-		DeleteMenu(hMenu, ID_RECENT_CART + i, MF_BYCOMMAND);
-	}
-	for(int i = 0; i < MAX_HISTORY; i++) {
-		if(_tcsicmp(config.recent_cart_path[drv][i], _T(""))) {
-			AppendMenu(hMenu, MF_STRING, ID_RECENT_CART + i, config.recent_cart_path[drv][i]);
-			flag = true;
-		}
-	}
-	if(!flag) {
-		AppendMenu(hMenu, MF_GRAYED | MF_STRING, ID_RECENT_CART, _T("None"));
-	}
-	EnableMenuItem(hMenu, ID_CLOSE_CART, emu->is_cart_inserted(drv) ? MF_ENABLED : MF_GRAYED);
-}
-#endif
-
-#ifdef USE_FLOPPY_DISK
-void update_floppy_disk_menu(HMENU hMenu, int drv, UINT ID_RECENT_FD, UINT ID_D88_FILE_PATH, UINT ID_SELECT_D88_BANK, UINT ID_EJECT_D88_BANK, UINT ID_CLOSE_FD, UINT ID_WRITE_PROTECT_FD, UINT ID_CORRECT_TIMING_FD, UINT ID_IGNORE_CRC_FD)
-{
-	static int recent_menu_pos[] = {-1, -1, -1, -1, -1, -1, -1, -1};
-	if(recent_menu_pos[drv] == -1) {
-		int count = GetMenuItemCount(hMenu);
-		for(int i = 0; i < count; i++) {
-			if(GetMenuItemID(hMenu, i) == ID_RECENT_FD) {
-				recent_menu_pos[drv] = i;
-				break;
-			}
-		}
-	}
-	bool flag = false;
-	
-	while(DeleteMenu(hMenu, recent_menu_pos[drv], MF_BYPOSITION) != 0) {}
-	if(emu->d88_file[drv].bank_num > 1) {
-		AppendMenu(hMenu, MF_STRING | MF_DISABLED, ID_D88_FILE_PATH, emu->d88_file[drv].path);
-		for(int i = 0; i < emu->d88_file[drv].bank_num; i++) {
-			AppendMenu(hMenu, MF_STRING | (emu->d88_file[drv].cur_bank == i ? MF_CHECKED : 0), ID_SELECT_D88_BANK + i, create_string(_T("%d: %s"), i + 1, emu->d88_file[drv].disk_name[i]));
-		}
-		AppendMenu(hMenu, MF_STRING | (emu->d88_file[drv].cur_bank == -1 ? MF_CHECKED : 0), ID_EJECT_D88_BANK, _T("0: (Disk Ejected)"));
-		AppendMenu(hMenu, MF_SEPARATOR, 0, NULL);
-	}
-	for(int i = 0; i < MAX_HISTORY; i++) {
-		if(_tcsicmp(config.recent_floppy_disk_path[drv][i], _T(""))) {
-			AppendMenu(hMenu, MF_STRING, ID_RECENT_FD + i, config.recent_floppy_disk_path[drv][i]);
-			flag = true;
-		}
-	}
-	if(!flag) {
-		AppendMenu(hMenu, MF_GRAYED | MF_STRING, ID_RECENT_FD, _T("None"));
-	}
-	EnableMenuItem(hMenu, ID_CLOSE_FD, emu->is_floppy_disk_inserted(drv) || (emu->d88_file[drv].bank_num > 1 && emu->d88_file[drv].cur_bank == -1) ? MF_ENABLED : MF_GRAYED);
-	EnableMenuItem(hMenu, ID_WRITE_PROTECT_FD, emu->is_floppy_disk_inserted(drv) ? MF_ENABLED : MF_GRAYED);
-	CheckMenuItem(hMenu, ID_WRITE_PROTECT_FD, emu->is_floppy_disk_protected(drv) ? MF_CHECKED : MF_UNCHECKED);
-	CheckMenuItem(hMenu, ID_CORRECT_TIMING_FD, config.correct_disk_timing[drv] ? MF_CHECKED : MF_UNCHECKED);
-	CheckMenuItem(hMenu, ID_IGNORE_CRC_FD, config.ignore_disk_crc[drv] ? MF_CHECKED : MF_UNCHECKED);
-}
-#endif
-
-#ifdef USE_QUICK_DISK
-void update_quick_disk_menu(HMENU hMenu, int drv, UINT ID_RECENT_QD, UINT ID_CLOSE_QD)
-{
-	bool flag = false;
-	for(int i = 0; i < MAX_HISTORY; i++) {
-		DeleteMenu(hMenu, ID_RECENT_QD + i, MF_BYCOMMAND);
-	}
-	for(int i = 0; i < MAX_HISTORY; i++) {
-		if(_tcsicmp(config.recent_quick_disk_path[drv][i], _T(""))) {
-			AppendMenu(hMenu, MF_STRING, ID_RECENT_QD + i, config.recent_quick_disk_path[drv][i]);
-			flag = true;
-		}
-	}
-	if(!flag) {
-		AppendMenu(hMenu, MF_GRAYED | MF_STRING, ID_RECENT_QD, _T("None"));
-	}
-	EnableMenuItem(hMenu, ID_CLOSE_QD, emu->is_quick_disk_inserted(drv) ? MF_ENABLED : MF_GRAYED);
-}
-#endif
-
-#ifdef USE_HARD_DISK
-void update_hard_disk_menu(HMENU hMenu, int drv, UINT ID_RECENT_HD, UINT ID_CLOSE_HD)
-{
-	bool flag = false;
-	for(int i = 0; i < MAX_HISTORY; i++) {
-		DeleteMenu(hMenu, ID_RECENT_HD + i, MF_BYCOMMAND);
-	}
-	for(int i = 0; i < MAX_HISTORY; i++) {
-		if(_tcsicmp(config.recent_hard_disk_path[drv][i], _T(""))) {
-			AppendMenu(hMenu, MF_STRING, ID_RECENT_HD + i, config.recent_hard_disk_path[drv][i]);
-			flag = true;
-		}
-	}
-	if(!flag) {
-		AppendMenu(hMenu, MF_GRAYED | MF_STRING, ID_RECENT_HD, _T("None"));
-	}
-	EnableMenuItem(hMenu, ID_CLOSE_HD, emu->is_hard_disk_inserted(drv) ? MF_ENABLED : MF_GRAYED);
-}
-#endif
-
-#ifdef USE_TAPE
-void update_tape_menu(HMENU hMenu, int drv, UINT ID_RECENT_TAPE, UINT ID_CLOSE_TAPE, UINT ID_PLAY_BUTTON, UINT ID_STOP_BUTTON, UINT ID_FAST_FORWARD, UINT ID_FAST_REWIND, UINT ID_APSS_FORWARD, UINT ID_APSS_REWIND, UINT ID_USE_WAVE_SHAPER, UINT ID_DIRECT_LOAD_MZT, UINT ID_TAPE_BAUD_LOW, UINT ID_TAPE_BAUD_HIGH)
-{
-	bool flag = false;
-	for(int i = 0; i < MAX_HISTORY; i++) {
-		DeleteMenu(hMenu, ID_RECENT_TAPE + i, MF_BYCOMMAND);
-	}
-	for(int i = 0; i < MAX_HISTORY; i++) {
-		if(_tcsicmp(config.recent_tape_path[drv][i], _T(""))) {
-			AppendMenu(hMenu, MF_STRING, ID_RECENT_TAPE + i, config.recent_tape_path[drv][i]);
-			flag = true;
-		}
-	}
-	if(!flag) {
-		AppendMenu(hMenu, MF_GRAYED | MF_STRING, ID_RECENT_TAPE, _T("None"));
-	}
-	EnableMenuItem(hMenu, ID_CLOSE_TAPE, emu->is_tape_inserted(drv) ? MF_ENABLED : MF_GRAYED);
-	EnableMenuItem(hMenu, ID_PLAY_BUTTON, emu->is_tape_inserted(drv) ? MF_ENABLED : MF_GRAYED);
-	EnableMenuItem(hMenu, ID_STOP_BUTTON, emu->is_tape_inserted(drv) ? MF_ENABLED : MF_GRAYED);
-	EnableMenuItem(hMenu, ID_FAST_FORWARD, emu->is_tape_inserted(drv) ? MF_ENABLED : MF_GRAYED);
-	EnableMenuItem(hMenu, ID_FAST_REWIND, emu->is_tape_inserted(drv) ? MF_ENABLED : MF_GRAYED);
-	EnableMenuItem(hMenu, ID_APSS_FORWARD, emu->is_tape_inserted(drv) ? MF_ENABLED : MF_GRAYED);
-	EnableMenuItem(hMenu, ID_APSS_REWIND, emu->is_tape_inserted(drv) ? MF_ENABLED : MF_GRAYED);
-	CheckMenuItem(hMenu, ID_USE_WAVE_SHAPER, config.wave_shaper[drv] ? MF_CHECKED : MF_UNCHECKED);
-	CheckMenuItem(hMenu, ID_DIRECT_LOAD_MZT, config.direct_load_mzt[drv] ? MF_CHECKED : MF_UNCHECKED);
-	CheckMenuRadioItem(hMenu, ID_TAPE_BAUD_LOW, ID_TAPE_BAUD_HIGH, !config.baud_high[drv] ? ID_TAPE_BAUD_LOW : ID_TAPE_BAUD_HIGH, MF_BYCOMMAND);
-}
-#endif
-
-#ifdef USE_COMPACT_DISC
-void update_compact_disc_menu(HMENU hMenu, int drv, UINT ID_RECENT_COMPACT_DISC, UINT ID_CLOSE_COMPACT_DISC)
-{
-	bool flag = false;
-	for(int i = 0; i < MAX_HISTORY; i++) {
-		DeleteMenu(hMenu, ID_RECENT_COMPACT_DISC + i, MF_BYCOMMAND);
-	}
-	for(int i = 0; i < MAX_HISTORY; i++) {
-		if(_tcsicmp(config.recent_compact_disc_path[drv][i], _T(""))) {
-			AppendMenu(hMenu, MF_STRING, ID_RECENT_COMPACT_DISC + i, config.recent_compact_disc_path[drv][i]);
-			flag = true;
-		}
-	}
-	if(!flag) {
-		AppendMenu(hMenu, MF_GRAYED | MF_STRING, ID_RECENT_COMPACT_DISC, _T("None"));
-	}
-	EnableMenuItem(hMenu, ID_CLOSE_COMPACT_DISC, emu->is_compact_disc_inserted(drv) ? MF_ENABLED : MF_GRAYED);
-}
-#endif
-
-#ifdef USE_LASER_DISC
-void update_laser_disc_menu(HMENU hMenu, int drv, UINT ID_RECENT_LASER_DISC, UINT ID_CLOSE_LASER_DISC)
-{
-	bool flag = false;
-	for(int i = 0; i < MAX_HISTORY; i++) {
-		DeleteMenu(hMenu, ID_RECENT_LASER_DISC + i, MF_BYCOMMAND);
-	}
-	for(int i = 0; i < MAX_HISTORY; i++) {
-		if(_tcsicmp(config.recent_laser_disc_path[drv][i], _T(""))) {
-			AppendMenu(hMenu, MF_STRING, ID_RECENT_LASER_DISC + i, config.recent_laser_disc_path[drv][i]);
-			flag = true;
-		}
-	}
-	if(!flag) {
-		AppendMenu(hMenu, MF_GRAYED | MF_STRING, ID_RECENT_LASER_DISC, _T("None"));
-	}
-	EnableMenuItem(hMenu, ID_CLOSE_LASER_DISC, emu->is_laser_disc_inserted(drv) ? MF_ENABLED : MF_GRAYED);
-}
-#endif
-
-#ifdef USE_BINARY_FILE
-void update_binary_menu(HMENU hMenu, int drv, UINT ID_RECENT_BINARY)
-{
-	bool flag = false;
-	for(int i = 0; i < MAX_HISTORY; i++) {
-		DeleteMenu(hMenu, ID_RECENT_BINARY + i, MF_BYCOMMAND);
-	}
-	for(int i = 0; i < MAX_HISTORY; i++) {
-		if(_tcsicmp(config.recent_binary_path[drv][i], _T(""))) {
-			AppendMenu(hMenu, MF_STRING, ID_RECENT_BINARY + i, config.recent_binary_path[drv][i]);
-			flag = true;
-		}
-	}
-	if(!flag) {
-		AppendMenu(hMenu, MF_GRAYED | MF_STRING, ID_RECENT_BINARY, _T("None"));
-	}
-}
-#endif
-
-#ifdef USE_BUBBLE
-void update_bubble_casette_menu(HMENU hMenu, int drv, UINT ID_RECENT_BUBBLE)
-{
-	bool flag = false;
-	for(int i = 0; i < MAX_HISTORY; i++) {
-		DeleteMenu(hMenu, ID_RECENT_BUBBLE + i, MF_BYCOMMAND);
-	}
-	for(int i = 0; i < MAX_HISTORY; i++) {
-		if(_tcsicmp(config.recent_bubble_casette_path[drv][i], _T(""))) {
-			AppendMenu(hMenu, MF_STRING, ID_RECENT_BUBBLE + i, config.recent_bubble_casette_path[drv][i]);
-			flag = true;
-		}
-	}
-	if(!flag) {
-		AppendMenu(hMenu, MF_GRAYED | MF_STRING, ID_RECENT_BUBBLE, _T("None"));
-	}
-}
-#endif
-
-#ifdef USE_BOOT_MODE
-void update_vm_boot_menu(HMENU hMenu)
-{
-	if(config.boot_mode >= 0 && config.boot_mode < USE_BOOT_MODE) {
-		CheckMenuRadioItem(hMenu, ID_VM_BOOT_MODE0, ID_VM_BOOT_MODE0 + USE_BOOT_MODE - 1, ID_VM_BOOT_MODE0 + config.boot_mode, MF_BYCOMMAND);
-	}
-}
-#endif
-
-#ifdef USE_CPU_TYPE
-void update_vm_cpu_menu(HMENU hMenu)
-{
-	if(config.cpu_type >= 0 && config.cpu_type < USE_CPU_TYPE) {
-		CheckMenuRadioItem(hMenu, ID_VM_CPU_TYPE0, ID_VM_CPU_TYPE0 + USE_CPU_TYPE - 1, ID_VM_CPU_TYPE0 + config.cpu_type, MF_BYCOMMAND);
-	}
-}
-#endif
-
-#ifdef USE_DIPSWITCH
-void update_vm_dipswitch_menu(HMENU hMenu)
-{
-	for(int i = 0; i < 32; i++) {
-		CheckMenuItem(hMenu, ID_VM_DIPSWITCH0 + i, (config.dipswitch & (1 << i)) ? MF_CHECKED : MF_UNCHECKED);
-	}
-}
-#endif
-
-#ifdef USE_DEVICE_TYPE
-void update_vm_device_menu(HMENU hMenu)
-{
-	if(config.device_type >= 0 && config.device_type < USE_DEVICE_TYPE) {
-		CheckMenuRadioItem(hMenu, ID_VM_DEVICE_TYPE0, ID_VM_DEVICE_TYPE0 + USE_DEVICE_TYPE - 1, ID_VM_DEVICE_TYPE0 + config.device_type, MF_BYCOMMAND);
-	}
-}
-#endif
-
-#ifdef USE_DRIVE_TYPE
-void update_vm_drive_menu(HMENU hMenu)
-{
-	if(config.drive_type >= 0 && config.drive_type < USE_DRIVE_TYPE) {
-		CheckMenuRadioItem(hMenu, ID_VM_DRIVE_TYPE0, ID_VM_DRIVE_TYPE0 + USE_DRIVE_TYPE - 1, ID_VM_DRIVE_TYPE0 + config.drive_type, MF_BYCOMMAND);
-	}
-}
-#endif
-
-#ifdef USE_KEYBOARD_TYPE
-void update_vm_keyboard_menu(HMENU hMenu)
-{
-	if(config.keyboard_type >= 0 && config.keyboard_type < USE_KEYBOARD_TYPE) {
-		CheckMenuRadioItem(hMenu, ID_VM_KEYBOARD_TYPE0, ID_VM_KEYBOARD_TYPE0 + USE_KEYBOARD_TYPE - 1, ID_VM_KEYBOARD_TYPE0 + config.keyboard_type, MF_BYCOMMAND);
-	}
-}
-#endif
-
-#ifdef USE_MOUSE_TYPE
-void update_vm_mouse_menu(HMENU hMenu)
-{
-	if(config.mouse_type >= 0 && config.mouse_type < USE_MOUSE_TYPE) {
-		CheckMenuRadioItem(hMenu, ID_VM_MOUSE_TYPE0, ID_VM_MOUSE_TYPE0 + USE_MOUSE_TYPE - 1, ID_VM_MOUSE_TYPE0 + config.mouse_type, MF_BYCOMMAND);
-	}
-}
-#endif
-
-#ifdef USE_JOYSTICK_TYPE
-void update_vm_joystick_menu(HMENU hMenu)
-{
-	if(config.joystick_type >= 0 && config.joystick_type < USE_JOYSTICK_TYPE) {
-		CheckMenuRadioItem(hMenu, ID_VM_JOYSTICK_TYPE0, ID_VM_JOYSTICK_TYPE0 + USE_JOYSTICK_TYPE - 1, ID_VM_JOYSTICK_TYPE0 + config.joystick_type, MF_BYCOMMAND);
-	}
-}
-#endif
-
-#if defined(USE_SOUND_TYPE) || defined(USE_FLOPPY_DISK) || defined(USE_TAPE)
-void update_vm_sound_menu(HMENU hMenu)
-{
-#ifdef USE_SOUND_TYPE
-	if(config.sound_type >= 0 && config.sound_type < USE_SOUND_TYPE) {
-		CheckMenuRadioItem(hMenu, ID_VM_SOUND_TYPE0, ID_VM_SOUND_TYPE0 + USE_SOUND_TYPE - 1, ID_VM_SOUND_TYPE0 + config.sound_type, MF_BYCOMMAND);
-	}
-#endif
-#ifdef USE_FLOPPY_DISK
-	CheckMenuItem(hMenu, ID_VM_SOUND_NOISE_FDD, config.sound_noise_fdd ? MF_CHECKED : MF_UNCHECKED);
-#endif
-#ifdef USE_TAPE
-	CheckMenuItem(hMenu, ID_VM_SOUND_NOISE_CMT, config.sound_noise_cmt ? MF_CHECKED : MF_UNCHECKED);
-	CheckMenuItem(hMenu, ID_VM_SOUND_TAPE_SIGNAL, config.sound_tape_signal ? MF_CHECKED : MF_UNCHECKED);
-	CheckMenuItem(hMenu, ID_VM_SOUND_TAPE_VOICE, config.sound_tape_voice ? MF_CHECKED : MF_UNCHECKED);
-#endif
-}
-#endif
-
-#if defined(USE_MONITOR_TYPE) || defined(USE_SCANLINE)
-void update_vm_monitor_menu(HMENU hMenu)
-{
-#ifdef USE_MONITOR_TYPE
-	if(config.monitor_type >= 0 && config.monitor_type < USE_MONITOR_TYPE) {
-		CheckMenuRadioItem(hMenu, ID_VM_MONITOR_TYPE0, ID_VM_MONITOR_TYPE0 + USE_MONITOR_TYPE - 1, ID_VM_MONITOR_TYPE0 + config.monitor_type, MF_BYCOMMAND);
-	}
-#endif
-#ifdef USE_SCANLINE
-	CheckMenuItem(hMenu, ID_VM_MONITOR_SCANLINE, config.scan_line ? MF_CHECKED : MF_UNCHECKED);
-	CheckMenuItem(hMenu, ID_VM_MONITOR_SCANLINE_AUTO, config.scan_line_auto ? MF_CHECKED : MF_UNCHECKED);
-#endif
-}
-#endif
-
-#ifdef USE_PRINTER_TYPE
-void update_vm_printer_menu(HMENU hMenu)
-{
-	if(config.printer_type >= 0 && config.printer_type < USE_PRINTER_TYPE) {
-		CheckMenuRadioItem(hMenu, ID_VM_PRINTER_TYPE0, ID_VM_PRINTER_TYPE0 + USE_PRINTER_TYPE - 1, ID_VM_PRINTER_TYPE0 + config.printer_type, MF_BYCOMMAND);
-	}
-}
-#endif
-
-#ifdef USE_SERIAL_TYPE
-void update_vm_serial_menu(HMENU hMenu)
-{
-	if(config.serial_type >= 0 && config.serial_type < USE_SERIAL_TYPE) {
-		CheckMenuRadioItem(hMenu, ID_VM_SERIAL_TYPE0, ID_VM_SERIAL_TYPE0 + USE_SERIAL_TYPE - 1, ID_VM_SERIAL_TYPE0 + config.serial_type, MF_BYCOMMAND);
-	}
-}
-#endif
-
-void update_host_menu(HMENU hMenu)
-{
-	bool now_rec = true, now_stop = true;
-	if(emu) {
-		now_rec = emu->is_video_recording() || emu->is_sound_recording();
-		now_stop = !now_rec;
-	}
-	EnableMenuItem(hMenu, ID_HOST_REC_MOVIE_60FPS, now_rec ? MF_GRAYED : MF_ENABLED);
-	EnableMenuItem(hMenu, ID_HOST_REC_MOVIE_30FPS, now_rec ? MF_GRAYED : MF_ENABLED);
-	EnableMenuItem(hMenu, ID_HOST_REC_MOVIE_15FPS, now_rec ? MF_GRAYED : MF_ENABLED);
-	EnableMenuItem(hMenu, ID_HOST_REC_SOUND, now_rec ? MF_GRAYED : MF_ENABLED);
-	EnableMenuItem(hMenu, ID_HOST_REC_STOP, now_stop ? MF_GRAYED : MF_ENABLED);
-	
-#ifdef SUPPORT_D2D1
-	CheckMenuItem(hMenu, ID_HOST_USE_D2D1, config.use_d2d1 ? MF_CHECKED : MF_UNCHECKED);
-#else
-	EnableMenuItem(hMenu, ID_HOST_USE_D2D1, MF_GRAYED);
-#endif
-#ifdef SUPPORT_D3D9
-	CheckMenuItem(hMenu, ID_HOST_USE_D3D9, config.use_d3d9 ? MF_CHECKED : MF_UNCHECKED);
-	CheckMenuItem(hMenu, ID_HOST_WAIT_VSYNC, config.wait_vsync ? MF_CHECKED : MF_UNCHECKED);
-	EnableMenuItem(hMenu, ID_HOST_WAIT_VSYNC, config.use_d3d9 ? MF_ENABLED : MF_GRAYED);
-#else
-	EnableMenuItem(hMenu, ID_HOST_USE_D3D9, MF_GRAYED);
-	EnableMenuItem(hMenu, ID_HOST_WAIT_VSYNC, MF_GRAYED);
-#endif
-	
-	CheckMenuItem(hMenu, ID_HOST_USE_DINPUT, config.use_dinput ? MF_CHECKED : MF_UNCHECKED);
-	
-	CheckMenuItem(hMenu, ID_HOST_DISABLE_DWM, config.disable_dwm ? MF_CHECKED : MF_UNCHECKED);
-	EnableMenuItem(hMenu, ID_HOST_DISABLE_DWM, win8_or_later ? MF_ENABLED : MF_GRAYED);
-	
-	CheckMenuItem(hMenu, ID_HOST_SHOW_STATUS_BAR, config.show_status_bar ? MF_CHECKED : MF_UNCHECKED);
-}
-
-#ifndef ONE_BOARD_MICRO_COMPUTER
-void update_host_screen_menu(HMENU hMenu)
-{
-	UINT position = 0;
-	UINT last = ID_SCREEN_WINDOW;
-	_TCHAR buf[64];
-	MENUITEMINFO info;
-	
-	ZeroMemory(&info, sizeof(info));
-	info.cbSize = sizeof(info);
-	info.fMask = MIIM_TYPE;
-	info.fType = MFT_STRING;
-	info.dwTypeData = buf;
-	
-	for(int i = 0; i < MAX_WINDOW; i++) {
-		DeleteMenu(hMenu, ID_SCREEN_WINDOW + i, MF_BYCOMMAND);
-	}
-	for(int i = 0; i < MAX_FULLSCREEN; i++) {
-		DeleteMenu(hMenu, ID_SCREEN_FULLSCREEN + i, MF_BYCOMMAND);
-	}
-	for(int i = 0; i < MAX_WINDOW; i++) {
-		if(i == 0 || (emu && emu->get_window_mode_width(i) <= desktop_width && emu->get_window_mode_height(i) <= desktop_height)) {
-			double power = emu->get_window_mode_power(i);
-			if(power == (double)(int)power) {
-				my_stprintf_s(buf, 64, _T("Window x%d"), (int)power);
-			} else {
-				my_stprintf_s(buf, 64, _T("Window x%.1f"), power); // x1.5
-			}
-			InsertMenu(hMenu, position++, MF_BYPOSITION | MF_STRING, ID_SCREEN_WINDOW + i, buf);
-			last = ID_SCREEN_WINDOW + i;
-		}
-	}
-	for(int i = 0; i < MAX_FULLSCREEN; i++) {
-		if(i < screen_mode_count) {
-			my_stprintf_s(buf, 64, _T("Fullscreen %dx%d"), screen_mode_width[i], screen_mode_height[i]);
-			InsertMenu(hMenu, position++, MF_BYPOSITION | MF_STRING, ID_SCREEN_FULLSCREEN + i, buf);
-			EnableMenuItem(hMenu, ID_SCREEN_FULLSCREEN + i, now_fullscreen ? MF_GRAYED : MF_ENABLED);
-			last = ID_SCREEN_FULLSCREEN + i;
-		}
-	}
-	if(config.window_mode >= 0 && config.window_mode < MAX_WINDOW) {
-		CheckMenuRadioItem(hMenu, ID_SCREEN_WINDOW, last, ID_SCREEN_WINDOW + config.window_mode, MF_BYCOMMAND);
-	} else if(config.window_mode >= MAX_WINDOW && config.window_mode < screen_mode_count + MAX_WINDOW) {
-		CheckMenuRadioItem(hMenu, ID_SCREEN_WINDOW, last, ID_SCREEN_FULLSCREEN + config.window_mode - MAX_WINDOW, MF_BYCOMMAND);
-	}
-	
-	my_stprintf_s(buf, 64, _T("Window: Aspect Ratio %d:%d"), emu->get_vm_window_width(), emu->get_vm_window_height());
-	SetMenuItemInfo(hMenu, ID_SCREEN_WINDOW_STRETCH, FALSE, &info);
-	my_stprintf_s(buf, 64, _T("Window: Aspect Ratio %d:%d"), emu->get_vm_window_width_aspect(), emu->get_vm_window_height_aspect());
-	SetMenuItemInfo(hMenu, ID_SCREEN_WINDOW_ASPECT, FALSE, &info);
-	CheckMenuRadioItem(hMenu, ID_SCREEN_WINDOW_STRETCH, ID_SCREEN_WINDOW_ASPECT, ID_SCREEN_WINDOW_STRETCH + config.window_stretch_type, MF_BYCOMMAND);
-	
-	my_stprintf_s(buf, 64, _T("Fullscreen: Dot By Dot"));
-	SetMenuItemInfo(hMenu, ID_SCREEN_FULLSCREEN_DOTBYDOT, FALSE, &info);
-	my_stprintf_s(buf, 64, _T("Fullscreen: Stretch (Aspect Ratio %d:%d)"), emu->get_vm_window_width(), emu->get_vm_window_height());
-	SetMenuItemInfo(hMenu, ID_SCREEN_FULLSCREEN_STRETCH, FALSE, &info);
-	my_stprintf_s(buf, 64, _T("Fullscreen: Stretch (Aspect Ratio %d:%d)"), emu->get_vm_window_width_aspect(), emu->get_vm_window_height_aspect());
-	SetMenuItemInfo(hMenu, ID_SCREEN_FULLSCREEN_ASPECT, FALSE, &info);
-	my_stprintf_s(buf, 64, _T("Fullscreen: Stretch (Fill)"));
-	SetMenuItemInfo(hMenu, ID_SCREEN_FULLSCREEN_FILL, FALSE, &info);
-	CheckMenuRadioItem(hMenu, ID_SCREEN_FULLSCREEN_DOTBYDOT, ID_SCREEN_FULLSCREEN_FILL, ID_SCREEN_FULLSCREEN_DOTBYDOT + config.fullscreen_stretch_type, MF_BYCOMMAND);
-	
-//#ifdef USE_SCREEN_ROTATE
-	CheckMenuRadioItem(hMenu, ID_SCREEN_ROTATE_0, ID_SCREEN_ROTATE_270, ID_SCREEN_ROTATE_0 + config.rotate_type, MF_BYCOMMAND);
-//#endif
-}
-#endif
-
-#ifdef USE_SCREEN_FILTER
-void update_host_filter_menu(HMENU hMenu)
-{
-	switch(config.filter_type) {
-	case SCREEN_FILTER_RGB:
-		CheckMenuRadioItem(hMenu, ID_FILTER_RGB, ID_FILTER_NONE, ID_FILTER_RGB,  MF_BYCOMMAND);
-		break;
-	case SCREEN_FILTER_RF:
-		CheckMenuRadioItem(hMenu, ID_FILTER_RGB, ID_FILTER_NONE, ID_FILTER_RF,   MF_BYCOMMAND);
-		break;
-	default:
-		CheckMenuRadioItem(hMenu, ID_FILTER_RGB, ID_FILTER_NONE, ID_FILTER_NONE, MF_BYCOMMAND);
-		break;
-	}
-}
-#endif
-
-void update_host_sound_menu(HMENU hMenu)
-{
-	if(config.sound_frequency >= 0 && config.sound_frequency < 8) {
-		CheckMenuRadioItem(hMenu, ID_SOUND_FREQ0, ID_SOUND_FREQ7, ID_SOUND_FREQ0 + config.sound_frequency, MF_BYCOMMAND);
-	}
-	if(config.sound_latency >= 0 && config.sound_latency < 5) {
-		CheckMenuRadioItem(hMenu, ID_SOUND_LATE0, ID_SOUND_LATE4, ID_SOUND_LATE0 + config.sound_latency, MF_BYCOMMAND);
-	}
-	CheckMenuRadioItem(hMenu, ID_SOUND_STRICT_RENDER, ID_SOUND_LIGHT_RENDER, config.sound_strict_rendering ? ID_SOUND_STRICT_RENDER : ID_SOUND_LIGHT_RENDER, MF_BYCOMMAND);
-}
-
-void update_host_input_menu(HMENU hMenu)
-{
-}
-
-#ifdef USE_VIDEO_CAPTURE
-void update_host_capture_menu(HMENU hMenu)
-{
-	int num_devs = emu->get_num_capture_devs();
-	int cur_index = emu->get_cur_capture_dev_index();
-	
-	for(int i = 0; i < 8; i++) {
-		DeleteMenu(hMenu, ID_CAPTURE_DEVICE + i, MF_BYCOMMAND);
-	}
-	for(int i = 0; i < 8; i++) {
-		if(num_devs >= i + 1) {
-			AppendMenu(hMenu, MF_STRING, ID_CAPTURE_DEVICE + i, emu->get_capture_dev_name(i));
-		}
-	}
-	if(num_devs == 0) {
-		AppendMenu(hMenu, MF_GRAYED | MF_STRING, ID_CAPTURE_DEVICE, _T("None"));
-	}
-	if(cur_index != -1) {
-		CheckMenuRadioItem(hMenu, ID_CAPTURE_DEVICE, ID_CAPTURE_DEVICE + num_devs - 1, ID_CAPTURE_DEVICE + cur_index, MF_BYCOMMAND);
-	}
-	EnableMenuItem(hMenu, ID_CAPTURE_FILTER, (cur_index != -1) ? MF_ENABLED : MF_GRAYED);
-	EnableMenuItem(hMenu, ID_CAPTURE_PIN, (cur_index != -1) ? MF_ENABLED : MF_GRAYED);
-	EnableMenuItem(hMenu, ID_CAPTURE_SOURCE, (cur_index != -1) ? MF_ENABLED : MF_GRAYED);
-	EnableMenuItem(hMenu, ID_CAPTURE_CLOSE, (cur_index != -1) ? MF_ENABLED : MF_GRAYED);
-}
-#endif
-
-void update_toplevel_menu(HWND hWnd, HMENU hMenu)
-{
-	int count = GetMenuItemCount(hMenu);
-	for(int pos = 0; pos < count; pos++) {
-		HMENU hMenuSub = GetSubMenu(hMenu, pos);
-		if(hMenuSub) {
-			int count_sub = GetMenuItemCount(hMenuSub);
-			UINT id = -1;
-			for(int pos_sub = 0; pos_sub < count_sub; pos_sub++) {
-				if((id = GetMenuItemID(hMenuSub, pos_sub)) != -1) {
-					break;
-				}
-			}
-			if(id >= ID_CONTROL_MENU_START && id <= ID_CONTROL_MENU_END) {
-				
-			}
-#ifdef USE_FLOPPY_DISK
-#if USE_FLOPPY_DISK >= 1
-			else if(id >= ID_FD1_MENU_START && id <= ID_FD1_MENU_END) {
-				EnableMenuItem(hMenu, pos, (emu->is_floppy_disk_connected(0) ? MF_ENABLED : MF_GRAYED) | MF_BYPOSITION);
-			}
-#endif
-#if USE_FLOPPY_DISK >= 2
-			else if(id >= ID_FD2_MENU_START && id <= ID_FD2_MENU_END) {
-				EnableMenuItem(hMenu, pos, (emu->is_floppy_disk_connected(1) ? MF_ENABLED : MF_GRAYED) | MF_BYPOSITION);
-			}
-#endif
-#if USE_FLOPPY_DISK >= 3
-			else if(id >= ID_FD3_MENU_START && id <= ID_FD3_MENU_END) {
-				EnableMenuItem(hMenu, pos, (emu->is_floppy_disk_connected(2) ? MF_ENABLED : MF_GRAYED) | MF_BYPOSITION);
-			}
-#endif
-#if USE_FLOPPY_DISK >= 4
-			else if(id >= ID_FD4_MENU_START && id <= ID_FD4_MENU_END) {
-				EnableMenuItem(hMenu, pos, (emu->is_floppy_disk_connected(3) ? MF_ENABLED : MF_GRAYED) | MF_BYPOSITION);
-			}
-#endif
-#if USE_FLOPPY_DISK >= 5
-			else if(id >= ID_FD5_MENU_START && id <= ID_FD5_MENU_END) {
-				EnableMenuItem(hMenu, pos, (emu->is_floppy_disk_connected(4) ? MF_ENABLED : MF_GRAYED) | MF_BYPOSITION);
-			}
-#endif
-#if USE_FLOPPY_DISK >= 6
-			else if(id >= ID_FD6_MENU_START && id <= ID_FD6_MENU_END) {
-				EnableMenuItem(hMenu, pos, (emu->is_floppy_disk_connected(5) ? MF_ENABLED : MF_GRAYED) | MF_BYPOSITION);
-			}
-#endif
-#if USE_FLOPPY_DISK >= 7
-			else if(id >= ID_FD7_MENU_START && id <= ID_FD7_MENU_END) {
-				EnableMenuItem(hMenu, pos, (emu->is_floppy_disk_connected(6) ? MF_ENABLED : MF_GRAYED) | MF_BYPOSITION);
-			}
-#endif
-#if USE_FLOPPY_DISK >= 8
-			else if(id >= ID_FD8_MENU_START && id <= ID_FD8_MENU_END) {
-				EnableMenuItem(hMenu, pos, (emu->is_floppy_disk_connected(7) ? MF_ENABLED : MF_GRAYED) | MF_BYPOSITION);
-			}
-#endif
-#endif
-#ifdef USE_QUICK_DISK
-#if USE_QUICK_DISK >= 1
-			else if(id >= ID_QD1_MENU_START && id <= ID_QD1_MENU_END) {
-				EnableMenuItem(hMenu, pos, (emu->is_quick_disk_connected(0) ? MF_ENABLED : MF_GRAYED) | MF_BYPOSITION);
-			}
-#endif
-#if USE_QUICK_DISK >= 2
-			else if(id >= ID_QD2_MENU_START && id <= ID_QD2_MENU_END) {
-				EnableMenuItem(hMenu, pos, (emu->is_quick_disk_connected(1) ? MF_ENABLED : MF_GRAYED) | MF_BYPOSITION);
-			}
-#endif
-#endif
-		}
-	}
-	// redraw menu bar
-	DrawMenuBar(hWnd);
-}
-
-void update_popup_menu(HWND hWnd, HMENU hMenu)
-{
-	int count = GetMenuItemCount(hMenu);
-	UINT id = -1;
-	for(int pos = 0; pos < count; pos++) {
-		if((id = GetMenuItemID(hMenu, pos)) != -1) {
-			break;
-		}
-	}
-	if(id >= ID_CONTROL_MENU_START && id <= ID_CONTROL_MENU_END) {
-		update_control_menu(hMenu);
-	}
-#ifdef USE_STATE
-	else if(id >= ID_SAVE_MENU_START && id <= ID_SAVE_MENU_END) {
-		update_save_state_menu(hMenu);
-	}
-	else if(id >= ID_LOAD_MENU_START && id <= ID_LOAD_MENU_END) {
-		update_load_state_menu(hMenu);
-	}
-#endif
-#ifdef USE_CART
-#if USE_CART >= 1
-	else if(id >= ID_CART1_MENU_START && id <= ID_CART1_MENU_END) {
-		update_cart_menu(hMenu, 0, ID_RECENT_CART1, ID_CLOSE_CART1);
-	}
-#endif
-#if USE_CART >= 2
-	else if(id >= ID_CART2_MENU_START && id <= ID_CART2_MENU_END) {
-		update_cart_menu(hMenu, 1, ID_RECENT_CART2, ID_CLOSE_CART2);
-	}
-#endif
-#endif
-#ifdef USE_FLOPPY_DISK
-#if USE_FLOPPY_DISK >= 1
-	else if(id >= ID_FD1_MENU_START && id <= ID_FD1_MENU_END) {
-		update_floppy_disk_menu(hMenu, 0, ID_RECENT_FD1, ID_D88_FILE_PATH1, ID_SELECT_D88_BANK1, ID_EJECT_D88_BANK1, ID_CLOSE_FD1, ID_WRITE_PROTECT_FD1, ID_CORRECT_TIMING_FD1, ID_IGNORE_CRC_FD1);
-	}
-#endif
-#if USE_FLOPPY_DISK >= 2
-	else if(id >= ID_FD2_MENU_START && id <= ID_FD2_MENU_END) {
-		update_floppy_disk_menu(hMenu, 1, ID_RECENT_FD2, ID_D88_FILE_PATH2, ID_SELECT_D88_BANK2, ID_EJECT_D88_BANK2, ID_CLOSE_FD2, ID_WRITE_PROTECT_FD2, ID_CORRECT_TIMING_FD2, ID_IGNORE_CRC_FD2);
-	}
-#endif
-#if USE_FLOPPY_DISK >= 3
-	else if(id >= ID_FD3_MENU_START && id <= ID_FD3_MENU_END) {
-		update_floppy_disk_menu(hMenu, 2, ID_RECENT_FD3, ID_D88_FILE_PATH3, ID_SELECT_D88_BANK3, ID_EJECT_D88_BANK3, ID_CLOSE_FD3, ID_WRITE_PROTECT_FD3, ID_CORRECT_TIMING_FD3, ID_IGNORE_CRC_FD3);
-	}
-#endif
-#if USE_FLOPPY_DISK >= 4
-	else if(id >= ID_FD4_MENU_START && id <= ID_FD4_MENU_END) {
-		update_floppy_disk_menu(hMenu, 3, ID_RECENT_FD4, ID_D88_FILE_PATH4, ID_SELECT_D88_BANK4, ID_EJECT_D88_BANK4, ID_CLOSE_FD4, ID_WRITE_PROTECT_FD4, ID_CORRECT_TIMING_FD4, ID_IGNORE_CRC_FD4);
-	}
-#endif
-#if USE_FLOPPY_DISK >= 5
-	else if(id >= ID_FD5_MENU_START && id <= ID_FD5_MENU_END) {
-		update_floppy_disk_menu(hMenu, 4, ID_RECENT_FD5, ID_D88_FILE_PATH5, ID_SELECT_D88_BANK5, ID_EJECT_D88_BANK5, ID_CLOSE_FD5, ID_WRITE_PROTECT_FD5, ID_CORRECT_TIMING_FD5, ID_IGNORE_CRC_FD5);
-	}
-#endif
-#if USE_FLOPPY_DISK >= 6
-	else if(id >= ID_FD6_MENU_START && id <= ID_FD6_MENU_END) {
-		update_floppy_disk_menu(hMenu, 5, ID_RECENT_FD6, ID_D88_FILE_PATH6, ID_SELECT_D88_BANK6, ID_EJECT_D88_BANK6, ID_CLOSE_FD6, ID_WRITE_PROTECT_FD6, ID_CORRECT_TIMING_FD6, ID_IGNORE_CRC_FD6);
-	}
-#endif
-#if USE_FLOPPY_DISK >= 7
-	else if(id >= ID_FD7_MENU_START && id <= ID_FD7_MENU_END) {
-		update_floppy_disk_menu(hMenu, 6, ID_RECENT_FD7, ID_D88_FILE_PATH7, ID_SELECT_D88_BANK7, ID_EJECT_D88_BANK7, ID_CLOSE_FD7, ID_WRITE_PROTECT_FD7, ID_CORRECT_TIMING_FD7, ID_IGNORE_CRC_FD7);
-	}
-#endif
-#if USE_FLOPPY_DISK >= 8
-	else if(id >= ID_FD8_MENU_START && id <= ID_FD8_MENU_END) {
-		update_floppy_disk_menu(hMenu, 7, ID_RECENT_FD8, ID_D88_FILE_PATH8, ID_SELECT_D88_BANK8, ID_EJECT_D88_BANK8, ID_CLOSE_FD8, ID_WRITE_PROTECT_FD8, ID_CORRECT_TIMING_FD8, ID_IGNORE_CRC_FD8);
-	}
-#endif
-#endif
-#ifdef USE_QUICK_DISK
-#if USE_QUICK_DISK >= 1
-	else if(id >= ID_QD1_MENU_START && id <= ID_QD1_MENU_END) {
-		update_quick_disk_menu(hMenu, 0, ID_RECENT_QD1, ID_CLOSE_QD1);
-	}
-#endif
-#if USE_QUICK_DISK >= 2
-	else if(id >= ID_QD2_MENU_START && id <= ID_QD2_MENU_END) {
-		update_quick_disk_menu(hMenu, 1, ID_RECENT_QD2, ID_CLOSE_QD2);
-	}
-#endif
-#endif
-#ifdef USE_HARD_DISK
-#if USE_HARD_DISK >= 1
-	else if(id >= ID_HD1_MENU_START && id <= ID_HD1_MENU_END) {
-		update_hard_disk_menu(hMenu, 0, ID_RECENT_HD1, ID_CLOSE_HD1);
-	}
-#endif
-#if USE_HARD_DISK >= 2
-	else if(id >= ID_HD2_MENU_START && id <= ID_HD2_MENU_END) {
-		update_hard_disk_menu(hMenu, 1, ID_RECENT_HD2, ID_CLOSE_HD2);
-	}
-#endif
-#if USE_HARD_DISK >= 3
-	else if(id >= ID_HD3_MENU_START && id <= ID_HD3_MENU_END) {
-		update_hard_disk_menu(hMenu, 2, ID_RECENT_HD3, ID_CLOSE_HD3);
-	}
-#endif
-#if USE_HARD_DISK >= 4
-	else if(id >= ID_HD4_MENU_START && id <= ID_HD4_MENU_END) {
-		update_hard_disk_menu(hMenu, 3, ID_RECENT_HD4, ID_CLOSE_HD4);
-	}
-#endif
-#if USE_HARD_DISK >= 5
-	else if(id >= ID_HD5_MENU_START && id <= ID_HD5_MENU_END) {
-		update_hard_disk_menu(hMenu, 4, ID_RECENT_HD5, ID_CLOSE_HD5);
-	}
-#endif
-#if USE_HARD_DISK >= 6
-	else if(id >= ID_HD6_MENU_START && id <= ID_HD6_MENU_END) {
-		update_hard_disk_menu(hMenu, 5, ID_RECENT_HD6, ID_CLOSE_HD6);
-	}
-#endif
-#if USE_HARD_DISK >= 7
-	else if(id >= ID_HD7_MENU_START && id <= ID_HD7_MENU_END) {
-		update_hard_disk_menu(hMenu, 6, ID_RECENT_HD7, ID_CLOSE_HD7);
-	}
-#endif
-#if USE_HARD_DISK >= 8
-	else if(id >= ID_HD8_MENU_START && id <= ID_HD8_MENU_END) {
-		update_hard_disk_menu(hMenu, 7, ID_RECENT_HD8, ID_CLOSE_HD8);
-	}
-#endif
-#endif
-#ifdef USE_TAPE
-#if USE_TAPE >= 1
-	else if(id >= ID_TAPE1_MENU_START && id <= ID_TAPE1_MENU_END) {
-		update_tape_menu(hMenu, 0, ID_RECENT_TAPE1, ID_CLOSE_TAPE1, ID_PLAY_BUTTON1, ID_STOP_BUTTON1, ID_FAST_FORWARD1, ID_FAST_REWIND1, ID_APSS_FORWARD1, ID_APSS_REWIND1, ID_USE_WAVE_SHAPER1, ID_DIRECT_LOAD_MZT1, ID_TAPE_BAUD_LOW1, ID_TAPE_BAUD_HIGH1);
-	}
-#endif
-#if USE_TAPE >= 2
-	else if(id >= ID_TAPE2_MENU_START && id <= ID_TAPE2_MENU_END) {
-		update_tape_menu(hMenu, 1, ID_RECENT_TAPE2, ID_CLOSE_TAPE2, ID_PLAY_BUTTON2, ID_STOP_BUTTON2, ID_FAST_FORWARD2, ID_FAST_REWIND2, ID_APSS_FORWARD2, ID_APSS_REWIND2, ID_USE_WAVE_SHAPER2, ID_DIRECT_LOAD_MZT2, ID_TAPE_BAUD_LOW2, ID_TAPE_BAUD_HIGH2);
-	}
-#endif
-#endif
-#ifdef USE_COMPACT_DISC
-#if USE_COMPACT_DISC >= 1
-	else if(id >= ID_COMPACT_DISC1_MENU_START && id <= ID_COMPACT_DISC1_MENU_END) {
-		update_compact_disc_menu(hMenu, 0, ID_RECENT_COMPACT_DISC1, ID_CLOSE_COMPACT_DISC1);
-	}
-#endif
-#if USE_COMPACT_DISC >= 2
-	else if(id >= ID_COMPACT_DISC2_MENU_START && id <= ID_COMPACT_DISC2_MENU_END) {
-		update_compact_disc_menu(hMenu, 1, ID_RECENT_COMPACT_DISC2, ID_CLOSE_COMPACT_DISC2);
-	}
-#endif
-#endif
-#ifdef USE_LASER_DISC
-#if USE_LASER_DISC >= 1
-	else if(id >= ID_LASER_DISC1_MENU_START && id <= ID_LASER_DISC1_MENU_END) {
-		update_laser_disc_menu(hMenu, 0, ID_RECENT_LASER_DISC1, ID_CLOSE_LASER_DISC1);
-	}
-#endif
-#if USE_LASER_DISC >= 2
-	else if(id >= ID_LASER_DISC2_MENU_START && id <= ID_LASER_DISC2_MENU_END) {
-		update_laser_disc_menu(hMenu, 1, ID_RECENT_LASER_DISC2, ID_CLOSE_LASER_DISC2);
-	}
-#endif
-#endif
-#ifdef USE_BINARY_FILE
-#if USE_BINARY_FILE >= 1
-	else if(id >= ID_BINARY1_MENU_START && id <= ID_BINARY1_MENU_END) {
-		update_binary_menu(hMenu, 0, ID_RECENT_BINARY1);
-	}
-#endif
-#if USE_BINARY_FILE >= 2
-	else if(id >= ID_BINARY2_MENU_START && id <= ID_BINARY2_MENU_END) {
-		update_binary_menu(hMenu, 1, ID_RECENT_BINARY2);
-	}
-#endif
-#endif
-#ifdef USE_BUBBLE
-#if USE_BUBBLE >= 1
-	else if(id >= ID_BUBBLE1_MENU_START && id <= ID_BUBBLE1_MENU_END) {
-		update_bubble_casette_menu(hMenu, 0, ID_RECENT_BUBBLE1);
-	}
-#endif
-#if USE_BUBBLE >= 2
-	else if(id >= ID_BUBBLE2_MENU_START && id <= ID_BUBBLE2_MENU_END) {
-		update_bubble_casette_menu(hMenu, 1, ID_RECENT_BUBBLE2);
-	}
-#endif
-#endif
-#if defined(USE_BOOT_MODE) || defined(USE_DIPSWITCH)
-	else if(id >= ID_VM_BOOT_MENU_START && id <= ID_VM_BOOT_MENU_END) {
-		#ifdef USE_BOOT_MODE
-			update_vm_boot_menu(hMenu);
-		#endif
-		#ifdef USE_DIPSWITCH
-			// dipswitch may be in sound menu
-			update_vm_dipswitch_menu(hMenu);
-		#endif
-	}
-#endif
-#ifdef USE_CPU_TYPE
-	else if(id >= ID_VM_CPU_MENU_START && id <= ID_VM_CPU_MENU_END) {
-		update_vm_cpu_menu(hMenu);
-	}
-#endif
-#ifdef USE_DIPSWITCH
-	else if(id >= ID_VM_DIPSWITCH_MENU_START && id <= ID_VM_DIPSWITCH_MENU_END) {
-		update_vm_dipswitch_menu(hMenu);
-	}
-#endif
-#ifdef USE_DEVICE_TYPE
-	else if(id >= ID_VM_DEVICE_MENU_START && id <= ID_VM_DEVICE_MENU_END) {
-		update_vm_device_menu(hMenu);
-	}
-#endif
-#ifdef USE_DRIVE_TYPE
-	else if(id >= ID_VM_DRIVE_MENU_START && id <= ID_VM_DRIVE_MENU_END) {
-		update_vm_drive_menu(hMenu);
-	}
-#endif
-#ifdef USE_KEYBOARD_TYPE
-	else if(id >= ID_VM_KEYBOARD_MENU_START && id <= ID_VM_KEYBOARD_MENU_END) {
-		update_vm_keyboard_menu(hMenu);
-	}
-#endif
-#ifdef USE_MOUSE_TYPE
-	else if(id >= ID_VM_MOUSE_MENU_START && id <= ID_VM_MOUSE_MENU_END) {
-		update_vm_mouse_menu(hMenu);
-	}
-#endif
-#ifdef USE_JOYSTICK_TYPE
-	else if(id >= ID_VM_JOYSTICK_MENU_START && id <= ID_VM_JOYSTICK_MENU_END) {
-		update_vm_joystick_menu(hMenu);
-	}
-#endif
-#if defined(USE_SOUND_TYPE) || defined(USE_FLOPPY_DISK) || defined(USE_TAPE) || defined(USE_DIPSWITCH)
-	else if(id >= ID_VM_SOUND_MENU_START && id <= ID_VM_SOUND_MENU_END) {
-		#if defined(USE_SOUND_TYPE) || defined(USE_FLOPPY_DISK) || defined(USE_TAPE)
-			update_vm_sound_menu(hMenu);
-		#endif
-		#ifdef USE_DIPSWITCH
-			// dipswitch may be in sound menu
-			update_vm_dipswitch_menu(hMenu);
-		#endif
-	}
-#endif
-#if defined(USE_MONITOR_TYPE) || defined(USE_SCANLINE) || defined(USE_DIPSWITCH)
-	else if(id >= ID_VM_MONITOR_MENU_START && id <= ID_VM_MONITOR_MENU_END) {
-		#if defined(USE_MONITOR_TYPE) || defined(USE_SCANLINE)
-			update_vm_monitor_menu(hMenu);
-		#endif
-		#ifdef USE_DIPSWITCH
-			// dipswitch may be in monitor menu
-			update_vm_dipswitch_menu(hMenu);
-		#endif
-	}
-#endif
-#ifdef USE_PRINTER_TYPE
-	else if(id >= ID_VM_PRINTER_MENU_START && id <= ID_VM_PRINTER_MENU_END) {
-		update_vm_printer_menu(hMenu);
-	}
-#endif
-#ifdef USE_SERIAL_TYPE
-	else if(id >= ID_VM_SERIAL_MENU_START && id <= ID_VM_SERIAL_MENU_END) {
-		update_vm_serial_menu(hMenu);
-	}
-#endif
-	else if(id >= ID_HOST_MENU_START && id <= ID_HOST_MENU_END) {
-		update_host_menu(hMenu);
-	}
-#ifndef ONE_BOARD_MICRO_COMPUTER
-	else if(id >= ID_SCREEN_MENU_START && id <= ID_SCREEN_MENU_END) {
-		update_host_screen_menu(hMenu);
-	}
-#endif
-#ifdef USE_SCREEN_FILTER
-	else if(id >= ID_FILTER_MENU_START && id <= ID_FILTER_MENU_END) {
-		update_host_filter_menu(hMenu);
-	}
-#endif
-	else if(id >= ID_SOUND_MENU_START && id <= ID_SOUND_MENU_END) {
-		update_host_sound_menu(hMenu);
-	}
-	else if(id >= ID_INPUT_MENU_START && id <= ID_INPUT_MENU_END) {
-		update_host_input_menu(hMenu);
-	}
-#ifdef USE_VIDEO_CAPTURE
-	else if(id >= ID_CAPTURE_MENU_START && id <= ID_CAPTURE_MENU_END) {
-		update_host_capture_menu(hMenu);
-	}
-#endif
-	DrawMenuBar(hWnd);
-}
-
-void show_menu_bar(HWND hWnd)
-{
-	if(!(hMenu != NULL && IsMenu(hMenu))) {
-		hMenu = LoadMenu((HINSTANCE)GetModuleHandle(0), MAKEINTRESOURCE(IDR_MENU1));
-		SetMenu(hWnd, hMenu);
-	}
-}
-
-void hide_menu_bar(HWND hWnd)
-{
-	if(hMenu != NULL && IsMenu(hMenu)) {
-		SetMenu(hWnd, NULL);
-		DestroyMenu(hMenu);
-		hMenu = NULL;
-	}
-}
-
-// ----------------------------------------------------------------------------
-// status bar
-// ----------------------------------------------------------------------------
-
-void show_status_bar(HWND hWnd)
-{
-//#if defined(USE_FLOPPY_DISK) || defined(USE_QUICK_DISK) || defined(USE_HARD_DISK) || defined(USE_COMPACT_DISC) || defined(USE_LASER_DISC) || (defined(USE_TAPE) && !defined(TAPE_BINARY_ONLY))
-	if(hStatus == NULL) {
-		InitCommonControls();
-		hStatus = CreateStatusWindow(WS_CHILD | WS_VISIBLE | CCS_BOTTOM, NULL, hWnd, ID_STATUS);
-		SendMessage(hStatus, SB_SETTEXT, (WPARAM)0 | SBT_OWNERDRAW, (LPARAM)NULL);
-	}
-	ShowWindow(hStatus, SW_SHOW);
-//#endif
-	status_bar_visible = true;
-}
-
-void hide_status_bar(HWND hWnd)
-{
-	if(hStatus != NULL) {
-		ShowWindow(hStatus, SW_HIDE);
-	}
-	status_bar_visible = false;
-}
-
-int get_status_bar_height()
-{
-	if(hStatus != NULL && status_bar_visible) {
-		RECT rect;
-		GetWindowRect(hStatus, &rect);
-		return rect.bottom - rect.top;
-	}
-	return 0;
-}
-
-bool get_status_bar_updated()
-{
-	bool updated = false;
-	
-#ifdef USE_FLOPPY_DISK
-	uint32_t new_fd_status = emu->is_floppy_disk_accessed();
-	uint32_t new_fd_indicator_color = emu->floppy_disk_indicator_color();
-	if(fd_status != new_fd_status || fd_indicator_color != new_fd_indicator_color) {
-		updated = true;
-		fd_status = new_fd_status;
-		fd_indicator_color = new_fd_indicator_color;
-	}
-#endif
-#ifdef USE_QUICK_DISK
-	uint32_t new_qd_status = emu->is_quick_disk_accessed();
-	if(qd_status != new_qd_status) {
-		updated = true;
-		qd_status = new_qd_status;
-	}
-#endif
-#ifdef USE_HARD_DISK
-	uint32_t new_hd_status = emu->is_hard_disk_accessed();
-	if(hd_status != new_hd_status) {
-		updated = true;
-		hd_status = new_hd_status;
-	}
-#endif
-#ifdef USE_COMPACT_DISC
-	uint32_t new_cd_status = emu->is_compact_disc_accessed();
-	if(cd_status != new_cd_status) {
-		updated = true;
-		cd_status = new_cd_status;
-	}
-#endif
-#ifdef USE_LASER_DISC
-	uint32_t new_ld_status = emu->is_laser_disc_accessed();
-	if(ld_status != new_ld_status) {
-		updated = true;
-		ld_status = new_ld_status;
-	}
-#endif
-#if defined(USE_TAPE) && !defined(TAPE_BINARY_ONLY)
-	_TCHAR new_tape_status[array_length(tape_status)] = {0};
-	for(int drv = 0; drv < USE_TAPE; drv++) {
-		const _TCHAR* message = emu->get_tape_message(drv);
-		if(message != NULL) {
-			my_tcscpy_s(new_tape_status, array_length(new_tape_status), message);
-			break;
-		}
-	}
-	if(_tcsicmp(tape_status, new_tape_status) != 0) {
-		updated = true;
-		my_tcscpy_s(tape_status, array_length(tape_status), new_tape_status);
-	}
-#endif
-	return updated;
-}
-
-void update_status_bar(HINSTANCE hInstance, LPDRAWITEMSTRUCT lpDrawItem)
-{
-	TEXTMETRIC tm;
-	GetTextMetrics(lpDrawItem->hDC, &tm);
-	int text_top = (lpDrawItem->rcItem.top + lpDrawItem->rcItem.bottom) / 2 - tm.tmHeight / 2;
-	int draw_left = lpDrawItem->rcItem.left;
-	
-	SetTextColor(lpDrawItem->hDC, RGB(0, 0, 0));
-	SetBkMode(lpDrawItem->hDC, TRANSPARENT);
-	
-	#if defined(USE_FLOPPY_DISK) || defined(USE_QUICK_DISK) || defined(USE_HARD_DISK) || defined(USE_COMPACT_DISC) || defined(USE_LASER_DISC) || defined(USE_LED_DEVICE)
-	{
-		HDC hdcMem = CreateCompatibleDC(lpDrawItem->hDC);
-		HBITMAP hBitmap[3];
-		BITMAP bmp[3];
-		hBitmap[0] = LoadBitmap(hInstance, _T("IDI_BITMAP_ACCESS_OFF"));
-		hBitmap[1] = LoadBitmap(hInstance, _T("IDI_BITMAP_ACCESS_ON" ));
-		hBitmap[2] = LoadBitmap(hInstance, _T("IDI_BITMAP_ACCESS_ON2"));
-		
-		if(hBitmap[0] != NULL && hBitmap[1] != NULL && hBitmap[2] != NULL) {
-			for(int i = 0; i < 3; i++) {
-				GetObject(hBitmap[i], sizeof(BITMAP), &bmp[i]);
-			}
-			int bmp_width = bmp[0].bmWidth;
-			int bmp_height = bmp[0].bmHeight;
-			int bmp_top = (lpDrawItem->rcItem.top + lpDrawItem->rcItem.bottom) / 2 - bmp_height / 2;
-			SIZE size;
-			
-			#ifdef USE_FLOPPY_DISK
-				TextOut(lpDrawItem->hDC, draw_left, text_top, _T("FD:"), 3);
-				GetTextExtentPoint32(lpDrawItem->hDC, _T("FD:"), 3, &size);
-				draw_left += size.cx + 4;
-				
-				for(int i = 0; i < USE_FLOPPY_DISK; i++) {
-					int idx = !((fd_status >> i) & 1) ? 0 : !((fd_indicator_color >> i) & 1) ? 1 : 2;
-					SelectObject(hdcMem, hBitmap[idx]);
-					TransparentBlt(lpDrawItem->hDC, draw_left, bmp_top, bmp_width, bmp_height, hdcMem, 0, 0, bmp_width, bmp_height, 0);
-					draw_left += bmp_width + 2;
-				}
-				draw_left += 8;
-			#endif
-			#ifdef USE_QUICK_DISK
-				TextOut(lpDrawItem->hDC, draw_left, text_top, _T("QD:"), 3);
-				GetTextExtentPoint32(lpDrawItem->hDC, _T("QD:"), 3, &size);
-				draw_left += size.cx + 4;
-				
-				for(int i = 0; i < USE_QUICK_DISK; i++) {
-					int idx = (qd_status >> i) & 1;
-					SelectObject(hdcMem, hBitmap[idx]);
-					TransparentBlt(lpDrawItem->hDC, draw_left, bmp_top, bmp_width, bmp_height, hdcMem, 0, 0, bmp_width, bmp_height, 0);
-					draw_left += bmp_width + 2;
-				}
-				draw_left += 8;
-			#endif
-			#ifdef USE_HARD_DISK
-				TextOut(lpDrawItem->hDC, draw_left, text_top, _T("HD:"), 3);
-				GetTextExtentPoint32(lpDrawItem->hDC, _T("HD:"), 3, &size);
-				draw_left += size.cx + 4;
-				
-				for(int i = 0; i < USE_HARD_DISK; i++) {
-					int idx = (hd_status >> i) & 1;
-					SelectObject(hdcMem, hBitmap[idx]);
-					TransparentBlt(lpDrawItem->hDC, draw_left, bmp_top, bmp_width, bmp_height, hdcMem, 0, 0, bmp_width, bmp_height, 0);
-					draw_left += bmp_width + 2;
-				}
-				draw_left += 8;
-			#endif
-			#ifdef USE_COMPACT_DISC
-				TextOut(lpDrawItem->hDC, draw_left, text_top, _T("CD:"), 3);
-				GetTextExtentPoint32(lpDrawItem->hDC, _T("CD:"), 3, &size);
-				draw_left += size.cx + 4;
-				
-				for(int i = 0; i < USE_COMPACT_DISC; i++) {
-					int idx = (cd_status >> i) & 1;
-					SelectObject(hdcMem, hBitmap[idx]);
-					TransparentBlt(lpDrawItem->hDC, draw_left, bmp_top, bmp_width, bmp_height, hdcMem, 0, 0, bmp_width, bmp_height, 0);
-					draw_left += bmp_width + 2;
-				}
-				draw_left += 8;
-			#endif
-			#ifdef USE_LASER_DISC
-				TextOut(lpDrawItem->hDC, draw_left, text_top, _T("LD:"), 3);
-				GetTextExtentPoint32(lpDrawItem->hDC, _T("LD:"), 3, &size);
-				draw_left += size.cx + 4;
-				
-				for(int i = 0; i < USE_LASER_DISC; i++) {
-					int idx = (ld_status >> i) & 1;
-					SelectObject(hdcMem, hBitmap[idx]);
-					TransparentBlt(lpDrawItem->hDC, draw_left, bmp_top, bmp_width, bmp_height, hdcMem, 0, 0, bmp_width, bmp_height, 0);
-					draw_left += bmp_width + 2;
-				}
-				draw_left += 8;
-			#endif
-			#ifdef USE_LED_DEVICE
-				for(int i = 0; i < USE_LED_DEVICE; i++) {
-					TextOut(lpDrawItem->hDC, draw_left, text_top, led_device_caption[i], _tcslen(led_device_caption[i]));
-					GetTextExtentPoint32(lpDrawItem->hDC, led_device_caption[i], _tcslen(led_device_caption[i]), &size);
-					draw_left += size.cx + 4;
-					int idx = (emu->get_led_status() >> i) & 1;
-					SelectObject(hdcMem, hBitmap[idx]);
-					TransparentBlt(lpDrawItem->hDC, draw_left, bmp_top, bmp_width, bmp_height, hdcMem, 0, 0, bmp_width, bmp_height, 0);
-					draw_left += bmp_width + 2;
-					draw_left += 4;
-				}
-				draw_left += 4;
-			#endif
-		}
-		for(int i = 0; i < 3; i++) {
-			if(hBitmap[i] != NULL) {
-				DeleteObject(hBitmap[i]);
-			}
-		}
-		DeleteDC(hdcMem);
-	}
-	#endif
-	#if defined(USE_TAPE) && !defined(TAPE_BINARY_ONLY)
-	{
-		SIZE size;
-		
-		TextOut(lpDrawItem->hDC, draw_left, text_top, _T("CMT:"), 4);
-		GetTextExtentPoint32(lpDrawItem->hDC, _T("CMT:"), 4, &size);
-		draw_left += size.cx + 4;
-		TextOut(lpDrawItem->hDC, draw_left, text_top, tape_status, (int)_tcslen(tape_status));
-	}
-	#endif
-}
-
-// ----------------------------------------------------------------------------
-// file
-// ----------------------------------------------------------------------------
-
-#define UPDATE_HISTORY(path, recent) { \
-	int index = MAX_HISTORY - 1; \
-	for(int i = 0; i < MAX_HISTORY; i++) { \
-		if(_tcsicmp(recent[i], path) == 0) { \
-			index = i; \
-			break; \
-		} \
-	} \
-	for(int i = index; i > 0; i--) { \
-		my_tcscpy_s(recent[i], _MAX_PATH, recent[i - 1]); \
-	} \
-	my_tcscpy_s(recent[0], _MAX_PATH, path); \
-}
-
-#ifdef USE_CART
-void open_cart_dialog(HWND hWnd, int drv)
-{
-	_TCHAR* path = get_open_file_name(
-		hWnd,
-#if defined(_COLECOVISION)
-		_T("Supported Files (*.rom;*.bin;*.hex;*.col)\0*.rom;*.bin;*.hex;*.col\0All Files (*.*)\0*.*\0\0"),
-		_T("Game Cartridge"),
-#elif defined(_GAMEGEAR)
-		_T("Supported Files (*.rom;*.bin;*.hex;*.gg;*.col)\0*.rom;*.bin;*.hex;*.gg;*.col\0All Files (*.*)\0*.*\0\0"),
-		_T("Game Cartridge"),
-#elif defined(_MASTERSYSTEM)
-		_T("Supported Files (*.rom;*.bin;*.hex;*.sms)\0*.rom;*.bin;*.hex;*.sms\0All Files (*.*)\0*.*\0\0"),
-		_T("Game Cartridge"),
-#elif defined(_PC6001) || defined(_PC6001MK2) || defined(_PC6001MK2SR) || defined(_PC6601) || defined(_PC6601SR)
-		_T("Supported Files (*.rom;*.bin;*.hex;*.60)\0*.rom;*.bin;*.hex;*.60\0All Files (*.*)\0*.*\0\0"),
-		_T("Game Cartridge"),
-#elif defined(_PCENGINE) || defined(_X1TWIN)
-		_T("Supported Files (*.rom;*.bin;*.hex;*.pce)\0*.rom;*.bin;*.hex;*.pce\0All Files (*.*)\0*.*\0\0"),
-		_T("HuCARD"),
-#elif defined(_SC3000)
-		_T("Supported Files (*.rom;*.bin;*.hex;*.sc;*.sg)\0*.rom;*.bin;*.hex;*.sc;*.sg\0All Files (*.*)\0*.*\0\0"),
-		_T("Game Cartridge"),
-#else
-		_T("Supported Files (*.rom;*.bin;*.hex)\0*.rom;*.bin;*.hex\0All Files (*.*)\0*.*\0\0"), 
-		_T("Game Cartridge"),
-#endif
-		NULL,
-		config.initial_cart_dir, _MAX_PATH
-	);
-	if(path) {
-		UPDATE_HISTORY(path, config.recent_cart_path[drv]);
-		my_tcscpy_s(config.initial_cart_dir, _MAX_PATH, get_parent_dir(path));
-		emu->open_cart(drv, path);
-	}
-}
-
-void open_recent_cart(int drv, int index)
-{
-	_TCHAR path[_MAX_PATH];
-	my_tcscpy_s(path, _MAX_PATH, config.recent_cart_path[drv][index]);
-	for(int i = index; i > 0; i--) {
-		my_tcscpy_s(config.recent_cart_path[drv][i], _MAX_PATH, config.recent_cart_path[drv][i - 1]);
-	}
-	my_tcscpy_s(config.recent_cart_path[drv][0], _MAX_PATH, path);
-	emu->open_cart(drv, path);
-}
-#endif
-
-#ifdef USE_FLOPPY_DISK
-void open_floppy_disk_dialog(HWND hWnd, int drv)
-{
-	_TCHAR* path = get_open_file_name(
-		hWnd,
-		_T("Supported Files (*.d88;*.d8e;*.d77;*.1dd;*.td0;*.imd;*.dsk;*.nfd;*.fdi;*.hdm;*.hd5;*.hd4;*.hdb;*.dd9;*.dd6;*.tfd;*.xdf;*.2d;*.sf7;*.img;*.ima;*.vfd)\0*.d88;*.d8e;*.d77;*.1dd;*.td0;*.imd;*.dsk;*.nfd;*.fdi;*.hdm;*.hd5;*.hd4;*.hdb;*.dd9;*.dd6;*.tfd;*.xdf;*.2d;*.sf7;*.img;*.ima;*.vfd\0All Files (*.*)\0*.*\0\0"),
-		_T("Floppy Disk"),
-		NULL,
-		config.initial_floppy_disk_dir, _MAX_PATH
-	);
-	if(path) {
-		UPDATE_HISTORY(path, config.recent_floppy_disk_path[drv]);
-		my_tcscpy_s(config.initial_floppy_disk_dir, _MAX_PATH, get_parent_dir(path));
-		emu->open_floppy_disk(drv, path, 0);
-#if USE_FLOPPY_DISK >= 2
-		if((drv & 1) == 0 && drv + 1 < USE_FLOPPY_DISK && emu->d88_file[drv].bank_num > 1) {
-			emu->open_floppy_disk(drv + 1, path, 1);
-		}
-#endif
-	}
-}
-
-void open_blank_floppy_disk_dialog(HWND hWnd, int drv, uint8_t type)
-{
-	_TCHAR* path = get_open_file_name(
-		hWnd,
-		_T("Supported Files (*.d88;*.d77)\0*.d88;*.d77\0All Files (*.*)\0*.*\0\0"),
-		_T("Floppy Disk"),
-		create_date_file_name(_T("d88")),
-		config.initial_floppy_disk_dir, _MAX_PATH
-	);
-	if(path) {
-		if(!check_file_extension(path, _T(".d88")) && !check_file_extension(path, _T(".d77"))) {
-			my_tcscat_s(path, _MAX_PATH, _T(".d88"));
-		}
-		if(emu->create_blank_floppy_disk(path, type)) {
-			UPDATE_HISTORY(path, config.recent_floppy_disk_path[drv]);
-			my_tcscpy_s(config.initial_floppy_disk_dir, _MAX_PATH, get_parent_dir(path));
-			emu->open_floppy_disk(drv, path, 0);
-		}
-	}
-}
-
-void open_recent_floppy_disk(int drv, int index)
-{
-	_TCHAR path[_MAX_PATH];
-	my_tcscpy_s(path, _MAX_PATH, config.recent_floppy_disk_path[drv][index]);
-	for(int i = index; i > 0; i--) {
-		my_tcscpy_s(config.recent_floppy_disk_path[drv][i], _MAX_PATH, config.recent_floppy_disk_path[drv][i - 1]);
-	}
-	my_tcscpy_s(config.recent_floppy_disk_path[drv][0], _MAX_PATH, path);
-	emu->open_floppy_disk(drv, path, 0);
-#if USE_FLOPPY_DISK >= 2
-	if((drv & 1) == 0 && drv + 1 < USE_FLOPPY_DISK && emu->d88_file[drv].bank_num > 1) {
-		emu->open_floppy_disk(drv + 1, path, 1);
-	}
-#endif
-}
-
-void select_d88_bank(int drv, int index)
-{
-	if(emu->d88_file[drv].cur_bank != index) {
-		emu->open_floppy_disk(drv, emu->d88_file[drv].path, index);
-	}
-}
-#endif
-
-#ifdef USE_QUICK_DISK
-void open_quick_disk_dialog(HWND hWnd, int drv)
-{
-	_TCHAR* path = get_open_file_name(
-		hWnd,
-		_T("Supported Files (*.mzt;*.q20;*.qdf)\0*.mzt;*.q20;*.qdf\0All Files (*.*)\0*.*\0\0"),
-		_T("Quick Disk"),
-		NULL,
-		config.initial_quick_disk_dir, _MAX_PATH
-	);
-	if(path) {
-		UPDATE_HISTORY(path, config.recent_quick_disk_path[drv]);
-		my_tcscpy_s(config.initial_quick_disk_dir, _MAX_PATH, get_parent_dir(path));
-		emu->open_quick_disk(drv, path);
-	}
-}
-
-void open_recent_quick_disk(int drv, int index)
-{
-	_TCHAR path[_MAX_PATH];
-	my_tcscpy_s(path, _MAX_PATH, config.recent_quick_disk_path[drv][index]);
-	for(int i = index; i > 0; i--) {
-		my_tcscpy_s(config.recent_quick_disk_path[drv][i], _MAX_PATH, config.recent_quick_disk_path[drv][i - 1]);
-	}
-	my_tcscpy_s(config.recent_quick_disk_path[drv][0], _MAX_PATH, path);
-	emu->open_quick_disk(drv, path);
-}
-#endif
-
-#ifdef USE_HARD_DISK
-void open_hard_disk_dialog(HWND hWnd, int drv)
-{
-	_TCHAR* path = get_open_file_name(
-		hWnd,
-		_T("Supported Files (*.thd;*.nhd;*.hdi;*.hdd;*.dat)\0*.thd;*.nhd;*.hdi;*.hdd;*.dat\0All Files (*.*)\0*.*\0\0"),
-		_T("Hard Disk"),
-		NULL,
-		config.initial_hard_disk_dir, _MAX_PATH
-	);
-	if(path) {
-		UPDATE_HISTORY(path, config.recent_hard_disk_path[drv]);
-		my_tcscpy_s(config.initial_hard_disk_dir, _MAX_PATH, get_parent_dir(path));
-		emu->open_hard_disk(drv, path);
-	}
-}
-
-void open_recent_hard_disk(int drv, int index)
-{
-	_TCHAR path[_MAX_PATH];
-	my_tcscpy_s(path, _MAX_PATH, config.recent_hard_disk_path[drv][index]);
-	for(int i = index; i > 0; i--) {
-		my_tcscpy_s(config.recent_hard_disk_path[drv][i], _MAX_PATH, config.recent_hard_disk_path[drv][i - 1]);
-	}
-	my_tcscpy_s(config.recent_hard_disk_path[drv][0], _MAX_PATH, path);
-	emu->open_hard_disk(drv, path);
-}
-
-void open_blank_hard_disk_dialog(HWND hWnd, int drv, int sector_size, int sectors, int surfaces, int cylinders)
-{
-	_TCHAR* path = get_open_file_name(
-		hWnd,
-		_T("Supported Files (*.hdi;*.nhd)\0*.hdi;*.nhd\0All Files (*.*)\0*.*\0\0"),
-		_T("Hard Disk"),
-		create_date_file_name(_T("hdi")),
-		config.initial_hard_disk_dir, _MAX_PATH
-	);
-	if(path) {
-		if(!check_file_extension(path, _T(".hdi")) && !check_file_extension(path, _T(".nhd"))) {
-			my_tcscat_s(path, _MAX_PATH, _T(".hdi"));
-		}
-		if(emu->create_blank_hard_disk(path, sector_size, sectors, surfaces, cylinders)) {
-			UPDATE_HISTORY(path, config.recent_hard_disk_path[drv]);
-			my_tcscpy_s(config.initial_hard_disk_dir, _MAX_PATH, get_parent_dir(path));
-			emu->open_hard_disk(drv, path);
-		}
-	}
-}
-#endif
-
-#ifdef USE_TAPE
-void open_tape_dialog(HWND hWnd, int drv, bool play)
-{
-	_TCHAR* path = get_open_file_name(
-		hWnd,
-#if defined(_PC6001) || defined(_PC6001MK2) || defined(_PC6001MK2SR) || defined(_PC6601) || defined(_PC6601SR)
-		play ? _T("Supported Files (*.wav;*.cas;*.p6;*.p6t;*.gz)\0*.wav;*.cas;*.p6;*.p6t;*.gz\0All Files (*.*)\0*.*\0\0")
-		     : _T("Supported Files (*.wav;*.cas;*.p6;*.p6t)\0*.wav;*.cas;*.p6;*.p6t\0All Files (*.*)\0*.*\0\0"),
-#elif defined(_PC8001) || defined(_PC8001MK2) || defined(_PC8001SR) || defined(_PC8801) || defined(_PC8801MK2) || defined(_PC8801MA) || defined(_PC98DO)
-		play ? _T("Supported Files (*.cas;*.cmt;*.n80;*.t88)\0*.cas;*.cmt;*.n80;*.t88\0All Files (*.*)\0*.*\0\0")
-		     : _T("Supported Files (*.cas;*.cmt)\0*.cas;*.cmt\0All Files (*.*)\0*.*\0\0"),
-#elif defined(_MZ80A) || defined(_MZ80K) || defined(_MZ1200) || defined(_MZ700) || defined(_MZ800) || defined(_MZ1500)
-		play ? _T("Supported Files (*.wav;*.cas;*.mzt;*.mzf;*.m12;*.gz)\0*.wav;*.cas;*.mzt;*.mzf;*.m12;*.gz\0All Files (*.*)\0*.*\0\0")
-		     : _T("Supported Files (*.wav;*.cas)\0*.wav;*.cas\0All Files (*.*)\0*.*\0\0"),
-#elif defined(_MZ80B) || defined(_MZ2000) || defined(_MZ2200)
-		play ? _T("Supported Files (*.wav;*.cas;*.mzt;*.mzf;*.mti;*.mtw;*.dat;*.gz)\0*.wav;*.cas;*.mzt;*.mzf;*.mti;*.mtw;*.dat;*.gz\0All Files (*.*)\0*.*\0\0")
-		     : _T("Supported Files (*.wav;*.cas)\0*.wav;*.cas\0All Files (*.*)\0*.*\0\0"),
-#elif defined(_MZ2500)
-		play ? _T("Supported Files (*.wav;*.cas;*.mzt;*.mzf;*.mti;*.gz)\0*.wav;*.cas;*.mzt;*.mzf;*.mti;*.gz\0All Files (*.*)\0*.*\0\0")
-		     : _T("Supported Files (*.wav;*.cas)\0*.wav;*.cas\0All Files (*.*)\0*.*\0\0"),
-#elif defined(_X1) || defined(_X1TWIN) || defined(_X1TURBO) || defined(_X1TURBOZ)
-		play ? _T("Supported Files (*.wav;*.cas;*.tap;*.gz)\0*.wav;*.cas;*.tap;*.gz\0All Files (*.*)\0*.*\0\0")
-		     : _T("Supported Files (*.wav;*.cas;*.tap)\0*.wav;*.cas;*.tap\0All Files (*.*)\0*.*\0\0"),
-#elif defined(_FM8) || defined(_FM7) || defined(_FMNEW7) || defined(_FM77_VARIANTS) || defined(_FM77AV_VARIANTS)
-		play ? _T("Supported Files (*.wav;*.cas;*.t77;*.gz)\0*.wav;*.cas;*.t77;*.gz\0All Files (*.*)\0*.*\0\0")
-		     : _T("Supported Files (*.wav;*.cas;*.t77)\0*.wav;*.cas;*.t77\0All Files (*.*)\0*.*\0\0"),
-#elif defined(_BMJR)
-		play ? _T("Supported Files (*.wav;*.cas;*.bin;*.gz)\0*.wav;*.cas;*.bin;*.gz\0All Files (*.*)\0*.*\0\0")
-		     : _T("Supported Files (*.wav;*.cas)\0*.wav;*.cas\0All Files (*.*)\0*.*\0\0"),
-#elif defined(_TK80BS)
-		drv == 1 ? _T("Supported Files (*.cas;*.cmt)\0*.cas;*.cmt\0All Files (*.*)\0*.*\0\0")
-		: play   ? _T("Supported Files (*.wav;*.cas;*.gz)\0*.wav;*.cas;*.gz\0All Files (*.*)\0*.*\0\0")
-		         : _T("Supported Files (*.wav;*.cas)\0*.wav;*.cas\0All Files (*.*)\0*.*\0\0"),
-#elif !defined(TAPE_BINARY_ONLY)
-		play ? _T("Supported Files (*.wav;*.cas;*.gz)\0*.wav;*.cas;*.gz\0All Files (*.*)\0*.*\0\0")
-		     : _T("Supported Files (*.wav;*.cas)\0*.wav;*.cas\0All Files (*.*)\0*.*\0\0"),
-#else
-		_T("Supported Files (*.cas;*.cmt)\0*.cas;*.cmt\0All Files (*.*)\0*.*\0\0"),
-#endif
-		play ? _T("Data Recorder Tape [Play]") : _T("Data Recorder Tape [Rec]"),
-		NULL,
-		config.initial_tape_dir, _MAX_PATH
-	);
-	if(path) {
-		UPDATE_HISTORY(path, config.recent_tape_path[drv]);
-		my_tcscpy_s(config.initial_tape_dir, _MAX_PATH, get_parent_dir(path));
-		if(play) {
-			emu->play_tape(drv, path);
-		} else {
-			emu->rec_tape(drv, path);
-		}
-	}
-}
-
-void open_recent_tape(int drv, int index)
-{
-	_TCHAR path[_MAX_PATH];
-	my_tcscpy_s(path, _MAX_PATH, config.recent_tape_path[drv][index]);
-	for(int i = index; i > 0; i--) {
-		my_tcscpy_s(config.recent_tape_path[drv][i], _MAX_PATH, config.recent_tape_path[drv][i - 1]);
-	}
-	my_tcscpy_s(config.recent_tape_path[drv][0], _MAX_PATH, path);
-	emu->play_tape(drv, path);
-}
-#endif
-
-#ifdef USE_COMPACT_DISC
-void open_compact_disc_dialog(HWND hWnd, int drv)
-{
-	_TCHAR* path = get_open_file_name(
-		hWnd,
-		_T("Supported Files (*.ccd;*.cue)\0*.ccd;*.cue\0All Files (*.*)\0*.*\0\0"),
-		_T("Compact Disc"),
-		NULL,
-		config.initial_compact_disc_dir, _MAX_PATH
-	);
-	if(path) {
-		UPDATE_HISTORY(path, config.recent_compact_disc_path[drv]);
-		my_tcscpy_s(config.initial_compact_disc_dir, _MAX_PATH, get_parent_dir(path));
-		emu->open_compact_disc(drv, path);
-	}
-}
-
-void open_recent_compact_disc(int drv, int index)
-{
-	_TCHAR path[_MAX_PATH];
-	my_tcscpy_s(path, _MAX_PATH, config.recent_compact_disc_path[drv][index]);
-	for(int i = index; i > 0; i--) {
-		my_tcscpy_s(config.recent_compact_disc_path[drv][i], _MAX_PATH, config.recent_compact_disc_path[drv][i - 1]);
-	}
-	my_tcscpy_s(config.recent_compact_disc_path[drv][0], _MAX_PATH, path);
-	emu->open_compact_disc(drv, path);
-}
-#endif
-
-#ifdef USE_LASER_DISC
-void open_laser_disc_dialog(HWND hWnd, int drv)
-{
-	_TCHAR* path = get_open_file_name(
-		hWnd,
-		_T("Supported Files (*.avi;*.mpg;*.mpeg;*.mp4;*.wmv;*.ogv)\0*.avi;*.mpg;*.mpeg;*.mp4;*.wmv;*.ogv\0All Files (*.*)\0*.*\0\0"),
-		_T("Laser Disc"),
-		NULL,
-		config.initial_laser_disc_dir, _MAX_PATH
-	);
-	if(path) {
-		UPDATE_HISTORY(path, config.recent_laser_disc_path[drv]);
-		my_tcscpy_s(config.initial_laser_disc_dir, _MAX_PATH, get_parent_dir(path));
-		emu->open_laser_disc(drv, path);
-	}
-}
-
-void open_recent_laser_disc(int drv, int index)
-{
-	_TCHAR path[_MAX_PATH];
-	my_tcscpy_s(path, _MAX_PATH, config.recent_laser_disc_path[drv][index]);
-	for(int i = index; i > 0; i--) {
-		my_tcscpy_s(config.recent_laser_disc_path[drv][i], _MAX_PATH, config.recent_laser_disc_path[drv][i - 1]);
-	}
-	my_tcscpy_s(config.recent_laser_disc_path[drv][0], _MAX_PATH, path);
-	emu->open_laser_disc(drv, path);
-}
-#endif
-
-#ifdef USE_BINARY_FILE
-void open_binary_dialog(HWND hWnd, int drv, bool load)
-{
-	_TCHAR* path = get_open_file_name(
-		hWnd,
-		_T("Supported Files (*.ram;*.bin;*.hex)\0*.ram;*.bin;*.hex\0All Files (*.*)\0*.*\0\0"),
-#if defined(_PASOPIA) || defined(_PASOPIA7)
-		_T("RAM Pack Cartridge"),
-#else
-		_T("Memory Dump"),
-#endif
-		NULL,
-		config.initial_binary_dir, _MAX_PATH
-	);
-	if(path) {
-		UPDATE_HISTORY(path, config.recent_binary_path[drv]);
-		my_tcscpy_s(config.initial_binary_dir, _MAX_PATH, get_parent_dir(path));
-		if(load) {
-			emu->load_binary(drv, path);
-		} else {
-			emu->save_binary(drv, path);
-		}
-	}
-}
-
-void open_recent_binary(int drv, int index)
-{
-	_TCHAR path[_MAX_PATH];
-	my_tcscpy_s(path, _MAX_PATH, config.recent_binary_path[drv][index]);
-	for(int i = index; i > 0; i--) {
-		my_tcscpy_s(config.recent_binary_path[drv][i], _MAX_PATH, config.recent_binary_path[drv][i - 1]);
-	}
-	my_tcscpy_s(config.recent_binary_path[drv][0], _MAX_PATH, path);
-	emu->load_binary(drv, path);
-}
-#endif
-
-#ifdef USE_BUBBLE
-void open_bubble_casette_dialog(HWND hWnd, int drv)
-{
-	_TCHAR* path = get_open_file_name(
-		hWnd,
-		_T("Supported Files (*.b77;*.bbl)\0*.b77;*.bbl\0All Files (*.*)\0*.*\0\0"),
-		_T("Bubble Casette"),
-		NULL,
-		config.initial_bubble_casette_dir, _MAX_PATH
-	);
-	if(path) {
-		UPDATE_HISTORY(path, config.recent_bubble_casette_path[drv]);
-		my_tcscpy_s(config.initial_bubble_casette_dir, _MAX_PATH, get_parent_dir(path));
-		emu->open_bubble_casette(drv, path, 0);
-	}
-}
-
-void open_recent_bubble_casette(int drv, int index)
-{
-	_TCHAR path[_MAX_PATH];
-	my_tcscpy_s(path, _MAX_PATH, config.recent_bubble_casette_path[drv][index]);
-	for(int i = index; i > 0; i--) {
-		my_tcscpy_s(config.recent_bubble_casette_path[drv][i], _MAX_PATH, config.recent_bubble_casette_path[drv][i - 1]);
-	}
-	my_tcscpy_s(config.recent_bubble_casette_path[drv][0], _MAX_PATH, path);
-	emu->open_bubble_casette(drv, path, 0);
-}
-#endif
-
-#ifdef SUPPORT_DRAG_DROP
-void open_dropped_file(HDROP hDrop)
-{
-	if(DragQueryFile(hDrop, 0xFFFFFFFF, NULL, 0) == 1) {
-		_TCHAR path[_MAX_PATH];
-		DragQueryFile(hDrop, 0, path, _MAX_PATH);
-		open_any_file(path);
-	}
-	DragFinish(hDrop);
-}
-
-void open_any_file(const _TCHAR* path)
-{
-#if defined(USE_CART)
-	if(check_file_extension(path, _T(".rom")) || 
-	   check_file_extension(path, _T(".bin")) || 
-	   check_file_extension(path, _T(".hex")) || 
-	   check_file_extension(path, _T(".sc" )) || 
-	   check_file_extension(path, _T(".sg" )) || 
-	   check_file_extension(path, _T(".gg" )) || 
-	   check_file_extension(path, _T(".col")) || 
-	   check_file_extension(path, _T(".sms")) || 
-	   check_file_extension(path, _T(".60" )) || 
-	   check_file_extension(path, _T(".pce"))) {
-		UPDATE_HISTORY(path, config.recent_cart_path[0]);
-		my_tcscpy_s(config.initial_cart_dir, _MAX_PATH, get_parent_dir(path));
-		emu->open_cart(0, path);
-		return;
-	}
-#endif
-#if defined(USE_FLOPPY_DISK)
-	if(check_file_extension(path, _T(".d88")) || 
-	   check_file_extension(path, _T(".d8e")) || 
-	   check_file_extension(path, _T(".d77")) || 
-	   check_file_extension(path, _T(".1dd")) || 
-	   check_file_extension(path, _T(".td0")) || 
-	   check_file_extension(path, _T(".imd")) || 
-	   check_file_extension(path, _T(".dsk")) || 
-	   check_file_extension(path, _T(".nfd")) || 
-	   check_file_extension(path, _T(".fdi")) || 
-	   check_file_extension(path, _T(".hdm")) || 
-	   check_file_extension(path, _T(".hd5")) || 
-	   check_file_extension(path, _T(".hd4")) || 
-	   check_file_extension(path, _T(".hdb")) || 
-	   check_file_extension(path, _T(".dd9")) || 
-	   check_file_extension(path, _T(".dd6")) || 
-	   check_file_extension(path, _T(".tfd")) || 
-	   check_file_extension(path, _T(".xdf")) || 
-	   check_file_extension(path, _T(".2d" )) || 
-	   check_file_extension(path, _T(".sf7")) || 
-	   check_file_extension(path, _T(".img")) || 
-	   check_file_extension(path, _T(".ima")) || 
-	   check_file_extension(path, _T(".vfd"))) {
-		UPDATE_HISTORY(path, config.recent_floppy_disk_path[0]);
-		my_tcscpy_s(config.initial_floppy_disk_dir, _MAX_PATH, get_parent_dir(path));
-		emu->open_floppy_disk(0, path, 0);
-#if USE_FLOPPY_DISK >= 2
-		if(emu->d88_file[0].bank_num > 1) {
-			emu->open_floppy_disk(1, path, 1);
-		}
-#endif
-		return;
-	}
-#endif
-#if defined(USE_HARD_DISK)
-	if(check_file_extension(path, _T(".thd")) || 
-	   check_file_extension(path, _T(".nhd")) || 
-	   check_file_extension(path, _T(".hdi")) || 
-	   check_file_extension(path, _T(".hdd"))) {
-		UPDATE_HISTORY(path, config.recent_hard_disk_path[0]);
-		my_tcscpy_s(config.initial_hard_disk_dir, _MAX_PATH, get_parent_dir(path));
-		emu->open_hard_disk(0, path);
-		return;
-	}
-#endif
-#if defined(USE_TAPE)
-	if(check_file_extension(path, _T(".wav")) || 
-	   check_file_extension(path, _T(".cas")) || 
-	   check_file_extension(path, _T(".p6" )) || 
-	   check_file_extension(path, _T(".p6t")) || 
-	   check_file_extension(path, _T(".cmt")) || 
-	   check_file_extension(path, _T(".n80")) || 
-	   check_file_extension(path, _T(".t88")) || 
-	   check_file_extension(path, _T(".mzt")) || 
-	   check_file_extension(path, _T(".mzf")) || 
-	   check_file_extension(path, _T(".m12")) || 
-	   check_file_extension(path, _T(".mti")) || 
-	   check_file_extension(path, _T(".mtw")) || 
-	   check_file_extension(path, _T(".tap")) || 
-	   check_file_extension(path, _T(".t77"))) {
-		UPDATE_HISTORY(path, config.recent_tape_path[0]);
-		my_tcscpy_s(config.initial_tape_dir, _MAX_PATH, get_parent_dir(path));
-		emu->play_tape(0, path);
-		return;
-	}
-#endif
-#if defined(USE_COMPACT_DISC)
-	if(check_file_extension(path, _T(".ccd" )) || 
-	   check_file_extension(path, _T(".cue" ))) {
-		UPDATE_HISTORY(path, config.recent_compact_disc_path[0]);
-		my_tcscpy_s(config.initial_compact_disc_dir, _MAX_PATH, get_parent_dir(path));
-		emu->open_compact_disc(0, path);
-		return;
-	}
-#endif
-#if defined(USE_LASER_DISC)
-	if(check_file_extension(path, _T(".avi" )) || 
-	   check_file_extension(path, _T(".mpg" )) || 
-	   check_file_extension(path, _T(".mpeg")) || 
-	   check_file_extension(path, _T(".mp4" )) || 
-	   check_file_extension(path, _T(".wmv" )) || 
-	   check_file_extension(path, _T(".ogv" ))) {
-		UPDATE_HISTORY(path, config.recent_laser_disc_path[0]);
-		my_tcscpy_s(config.initial_laser_disc_dir, _MAX_PATH, get_parent_dir(path));
-		emu->open_laser_disc(0, path);
-		return;
-	}
-#endif
-#if defined(USE_BINARY_FILE)
-	if(check_file_extension(path, _T(".ram")) || 
-	   check_file_extension(path, _T(".bin")) || 
-	   check_file_extension(path, _T(".hex"))) {
-		UPDATE_HISTORY(path, config.recent_binary_path[0]);
-		my_tcscpy_s(config.initial_binary_dir, _MAX_PATH, get_parent_dir(path));
-		emu->load_binary(0, path);
-		return;
-	}
-#endif
-#if defined(USE_BUBBLE)
-	if(check_file_extension(path, _T(".b77")) || 
-	   check_file_extension(path, _T(".bbl"))) {
-		UPDATE_HISTORY(path, config.recent_bubble_casette_path[0]);
-		my_tcscpy_s(config.initial_bubble_casette_dir, _MAX_PATH, get_parent_dir(path));
-		emu->open_bubble_casette(0, path, 0);
-		return;
-	}
-#endif
-}
-#endif
-
-_TCHAR* get_open_file_name(HWND hWnd, const _TCHAR* filter, const _TCHAR* title, const _TCHAR* new_file, _TCHAR* dir, size_t dir_len)
-{
-	static _TCHAR path[_MAX_PATH];
-	_TCHAR tmp[_MAX_PATH] = _T("");
-	OPENFILENAME OpenFileName;
-	
-	if(new_file != NULL) {
-		my_tcscpy_s(tmp, _MAX_PATH, new_file);
-	}
-	memset(&OpenFileName, 0, sizeof(OpenFileName));
-	OpenFileName.lStructSize = sizeof(OPENFILENAME);
-	OpenFileName.hwndOwner = hWnd;
-	OpenFileName.lpstrFilter = filter;
-	OpenFileName.lpstrFile = tmp;
-	OpenFileName.nMaxFile = _MAX_PATH;
-	OpenFileName.lpstrTitle = title;
-	if(dir[0]) {
-		OpenFileName.lpstrInitialDir = dir;
-	} else {
-		_TCHAR app[_MAX_PATH];
-		GetModuleFileName(NULL, app, _MAX_PATH);
-		OpenFileName.lpstrInitialDir = get_parent_dir(app);
-	}
-	if(GetOpenFileName(&OpenFileName)) {
-		get_long_full_path_name(OpenFileName.lpstrFile, path, _MAX_PATH);
-		my_tcscpy_s(dir, dir_len, get_parent_dir(path));
-		return path;
-	}
-	return NULL;
-}
-
-// ----------------------------------------------------------------------------
-// screen
-// ----------------------------------------------------------------------------
-
-void enum_screen_mode()
-{
-	screen_mode_count = 0;
-	
-	if(WINDOW_WIDTH <= 320 && WINDOW_HEIGHT <= 240) {
-		// FIXME: need to check if your video card really supports 320x240 resolution
-		screen_mode_width[0] = 320;
-		screen_mode_height[0] = 240;
-		screen_mode_count = 1;
-	}
-	for(int i = 0;; i++) {
-		DEVMODE dev;
-		ZeroMemory(&dev, sizeof(dev));
-		dev.dmSize = sizeof(dev);
-		if(EnumDisplaySettings(NULL, i, &dev) == 0) {
-			break;
-		}
-		if(dev.dmPelsWidth >= WINDOW_WIDTH && dev.dmPelsHeight >= WINDOW_HEIGHT) {
-			if(dev.dmPelsWidth >= 640 && dev.dmPelsHeight >= 480) {
-				bool found = false;
-				for(int j = 0; j < screen_mode_count; j++) {
-					if(screen_mode_width[j] == dev.dmPelsWidth && screen_mode_height[j] == dev.dmPelsHeight) {
-						found = true;
-						break;
-					}
-				}
-				if(!found) {
-					screen_mode_width[screen_mode_count] = dev.dmPelsWidth;
-					screen_mode_height[screen_mode_count] = dev.dmPelsHeight;
-					if(++screen_mode_count == MAX_FULLSCREEN) {
-						break;
-					}
-				}
-			}
-		}
-	}
-	for(int i = 0; i < screen_mode_count - 1; i++) {
-		for(int j = i + 1; j < screen_mode_count; j++) {
-			if(screen_mode_width[i] > screen_mode_width[j] || (screen_mode_width[i] == screen_mode_width[j] && screen_mode_height[i] > screen_mode_height[j])) {
-				int width = screen_mode_width[i];
-				screen_mode_width[i] = screen_mode_width[j];
-				screen_mode_width[j] = width;
-				int height = screen_mode_height[i];
-				screen_mode_height[i] = screen_mode_height[j];
-				screen_mode_height[j] = height;
-			}
-		}
-	}
-	if(screen_mode_count == 0) {
-		screen_mode_width[0] = desktop_width;
-		screen_mode_height[0] = desktop_height;
-		screen_mode_count = 1;
-	}
-}
-
-void set_window(HWND hWnd, int mode)
-{
-	static LONG style = WS_VISIBLE;
-//	WINDOWPLACEMENT place;
-//	place.length = sizeof(WINDOWPLACEMENT);
-	
-	if(mode >= 0 && mode < MAX_WINDOW) {
-		// window
-		int width = emu->get_window_mode_width(mode);
-		int height = emu->get_window_mode_height(mode);
-		RECT rect = {0, 0, width, height};
-		AdjustWindowRect(&rect, WS_OVERLAPPED | WS_CAPTION | WS_SYSMENU | WS_MINIMIZEBOX | WS_VISIBLE, TRUE);
-		int dest_x = (int)((desktop_width - (rect.right - rect.left)) / 2);
-		int dest_y = (int)((desktop_height - (rect.bottom - rect.top)) / 2);
-		//dest_x = (dest_x < 0) ? 0 : dest_x;
-		dest_y = (dest_y < 0) ? 0 : dest_y;
-		
-		if(now_fullscreen) {
-			ChangeDisplaySettings(NULL, 0);
-			SetWindowLong(hWnd, GWL_STYLE, style);
-			SetWindowPos(hWnd, HWND_TOP, dest_x, dest_y, rect.right - rect.left, rect.bottom - rect.top, SWP_SHOWWINDOW);
-			now_fullscreen = false;
-			
-			// show menu bar
-			show_menu_bar(hWnd);
-			
-		} else {
-			SetWindowPos(hWnd, NULL, dest_x, dest_y, rect.right - rect.left, rect.bottom - rect.top, SWP_NOZORDER);
-		}
-		if(config.show_status_bar) {
-			// show status bar
-			show_status_bar(hWnd);
-		} else {
-			// hide status bar
-			hide_status_bar(hWnd);
-		}
-		
-		int status_bar_height = get_status_bar_height();
-		RECT rect_tmp;
-		GetClientRect(hWnd, &rect_tmp);
-		if(rect_tmp.bottom != height + status_bar_height) {
-			rect.bottom += height + status_bar_height - rect_tmp.bottom;
-			dest_y = (int)((desktop_height - (rect.bottom - rect.top)) / 2);
-			dest_y = (dest_y < 0) ? 0 : dest_y;
-			SetWindowPos(hWnd, NULL, dest_x, dest_y, rect.right - rect.left, rect.bottom - rect.top, SWP_NOZORDER);
-		}
-		config.window_mode = prev_window_mode = mode;
-		
-		// set screen size to emu class
-		emu->set_host_window_size(width, height, true);
-	} else if(!now_fullscreen) {
-		// fullscreen
-		int width = (mode == -1) ? desktop_width : screen_mode_width[mode - MAX_WINDOW];
-		int height = (mode == -1) ? desktop_height : screen_mode_height[mode - MAX_WINDOW];
-		
-		DEVMODE dev;
-		ZeroMemory(&dev, sizeof(dev));
-		dev.dmSize = sizeof(dev);
-		dev.dmFields = DM_BITSPERPEL | DM_PELSWIDTH | DM_PELSHEIGHT;
-		dev.dmBitsPerPel = desktop_bpp;
-		dev.dmPelsWidth = width;
-		dev.dmPelsHeight = height;
-		
-		if(ChangeDisplaySettings(&dev, CDS_TEST) == DISP_CHANGE_SUCCESSFUL) {
-//			GetWindowPlacement(hWnd, &place);
-			ChangeDisplaySettings(&dev, CDS_FULLSCREEN);
-			style = GetWindowLong(hWnd, GWL_STYLE);
-			SetWindowLong(hWnd, GWL_STYLE, WS_VISIBLE);
-			SetWindowPos(hWnd, HWND_TOP, 0, 0, width, height, SWP_SHOWWINDOW);
-			SetCursorPos(width / 2, height / 2);
-			now_fullscreen = true;
-			if(mode == -1) {
-				for(int i = 0; i < screen_mode_count; i++) {
-					if(screen_mode_width[i] == desktop_width && screen_mode_height[i] == desktop_height) {
-						mode = i + MAX_WINDOW;
-						break;
-					}
-				}
-			}
-			config.window_mode = mode;
-			
-			// hide menu bar
-			hide_menu_bar(hWnd);
-			
-			// hide status bar
-			hide_status_bar(hWnd);
-			
-			// set screen size to emu class
-			emu->set_host_window_size(width, height, false);
-		}
-	}
-}
-
-// ----------------------------------------------------------------------------
-// input
-// ----------------------------------------------------------------------------
-
-#ifdef USE_AUTO_KEY
-void start_auto_key()
-{
-	if(OpenClipboard(NULL)) {
-		HANDLE hClip = GetClipboardData(CF_TEXT);
-		if(hClip) {
-			char* buf = (char*)GlobalLock(hClip);
-			int size = (int)strlen(buf);
-			
-			if(size > 0) {
-				emu->stop_auto_key();
-				emu->set_auto_key_list(buf, size);
-				emu->start_auto_key();
-			}
-			GlobalUnlock(hClip);
-		}
-		CloseClipboard();
-	}
-}
-#endif
-
-// ----------------------------------------------------------------------------
-// dialog
-// ----------------------------------------------------------------------------
-
-#ifdef USE_SOUND_VOLUME
-INT_PTR CALLBACK VolumeWndProc(HWND hDlg, UINT iMsg, WPARAM wParam, LPARAM lParam)
-{
-	switch(iMsg) {
-	case WM_CLOSE:
-		EndDialog(hDlg, IDCANCEL);
-		break;
-	case WM_INITDIALOG:
-		for(int i = 0; i < USE_SOUND_VOLUME; i++) {
-			SetDlgItemText(hDlg, IDC_VOLUME_CAPTION0 + i, sound_device_caption[i]);
-			SendDlgItemMessage(hDlg, IDC_VOLUME_PARAM_L0 + i, TBM_SETTICFREQ, 5, 0);
-			SendDlgItemMessage(hDlg, IDC_VOLUME_PARAM_R0 + i, TBM_SETTICFREQ, 5, 0);
-			SendDlgItemMessage(hDlg, IDC_VOLUME_PARAM_L0 + i, TBM_SETRANGE, TRUE, MAKELPARAM(-40, 0));
-			SendDlgItemMessage(hDlg, IDC_VOLUME_PARAM_R0 + i, TBM_SETRANGE, TRUE, MAKELPARAM(-40, 0));
-			SendDlgItemMessage(hDlg, IDC_VOLUME_PARAM_L0 + i, TBM_SETPOS, TRUE, max(-40, min(0, config.sound_volume_l[i])));
-			SendDlgItemMessage(hDlg, IDC_VOLUME_PARAM_R0 + i, TBM_SETPOS, TRUE, max(-40, min(0, config.sound_volume_r[i])));
-//			EnableWindow(GetDlgItem(hDlg, IDC_VOLUME_CAPTION0 + i), TRUE);
-//			EnableWindow(GetDlgItem(hDlg, IDC_VOLUME_PARAM_L0 + i), TRUE);
-//			EnableWindow(GetDlgItem(hDlg, IDC_VOLUME_PARAM_R0 + i), TRUE);
-		}
-		break;
-	case WM_COMMAND:
-		switch(LOWORD(wParam)) {
-		case IDOK:
-			for(int i = 0; i < USE_SOUND_VOLUME; i++) {
-				config.sound_volume_l[i] = (int)SendDlgItemMessage(hDlg, IDC_VOLUME_PARAM_L0 + i, TBM_GETPOS, 0, 0);
-				config.sound_volume_r[i] = (int)SendDlgItemMessage(hDlg, IDC_VOLUME_PARAM_R0 + i, TBM_GETPOS, 0, 0);
-				emu->set_sound_device_volume(i, config.sound_volume_l[i], config.sound_volume_r[i]);
-			}
-			EndDialog(hDlg, IDOK);
-			break;
-		case IDC_VOLUME_RESET:
-			for(int i = 0; i < USE_SOUND_VOLUME; i++) {
-				SendDlgItemMessage(hDlg, IDC_VOLUME_PARAM_L0 + i, TBM_SETPOS, TRUE, 0);
-				SendDlgItemMessage(hDlg, IDC_VOLUME_PARAM_R0 + i, TBM_SETPOS, TRUE, 0);
-			}
-			break;
-		default:
-			return FALSE;
-		}
-		break;
-	default:
-		return FALSE;
-	}
-	return TRUE;
-}
-#endif
-
-#ifdef USE_JOYSTICK
-// from http://homepage3.nifty.com/ic/help/rmfunc/vkey.htm
-static const _TCHAR *vk_names[] = {
-	_T("VK_$00"),			_T("VK_LBUTTON"),		_T("VK_RBUTTON"),		_T("VK_CANCEL"),		
-	_T("VK_MBUTTON"),		_T("VK_XBUTTON1"),		_T("VK_XBUTTON2"),		_T("VK_$07"),			
-	_T("VK_BACK"),			_T("VK_TAB"),			_T("VK_$0A"),			_T("VK_$0B"),			
-	_T("VK_CLEAR"),			_T("VK_RETURN"),		_T("VK_$0E"),			_T("VK_$0F"),			
-	_T("VK_SHIFT"),			_T("VK_CONTROL"),		_T("VK_MENU"),			_T("VK_PAUSE"),			
-	_T("VK_CAPITAL"),		_T("VK_KANA"),			_T("VK_$16"),			_T("VK_JUNJA"),			
-	_T("VK_FINAL"),			_T("VK_KANJI"),			_T("VK_$1A"),			_T("VK_ESCAPE"),		
-	_T("VK_CONVERT"),		_T("VK_NONCONVERT"),		_T("VK_ACCEPT"),		_T("VK_MODECHANGE"),		
-	_T("VK_SPACE"),			_T("VK_PRIOR"),			_T("VK_NEXT"),			_T("VK_END"),			
-	_T("VK_HOME"),			_T("VK_LEFT"),			_T("VK_UP"),			_T("VK_RIGHT"),			
-	_T("VK_DOWN"),			_T("VK_SELECT"),		_T("VK_PRINT"),			_T("VK_EXECUTE"),		
-	_T("VK_SNAPSHOT"),		_T("VK_INSERT"),		_T("VK_DELETE"),		_T("VK_HELP"),			
-	_T("VK_0"),			_T("VK_1"),			_T("VK_2"),			_T("VK_3"),			
-	_T("VK_4"),			_T("VK_5"),			_T("VK_6"),			_T("VK_7"),			
-	_T("VK_8"),			_T("VK_9"),			_T("VK_$3A"),			_T("VK_$3B"),			
-	_T("VK_$3C"),			_T("VK_$3D"),			_T("VK_$3E"),			_T("VK_$3F"),			
-	_T("VK_$40"),			_T("VK_A"),			_T("VK_B"),			_T("VK_C"),			
-	_T("VK_D"),			_T("VK_E"),			_T("VK_F"),			_T("VK_G"),			
-	_T("VK_H"),			_T("VK_I"),			_T("VK_J"),			_T("VK_K"),			
-	_T("VK_L"),			_T("VK_M"),			_T("VK_N"),			_T("VK_O"),			
-	_T("VK_P"),			_T("VK_Q"),			_T("VK_R"),			_T("VK_S"),			
-	_T("VK_T"),			_T("VK_U"),			_T("VK_V"),			_T("VK_W"),			
-	_T("VK_X"),			_T("VK_Y"),			_T("VK_Z"),			_T("VK_LWIN"),			
-	_T("VK_RWIN"),			_T("VK_APPS"),			_T("VK_$5E"),			_T("VK_SLEEP"),			
-	_T("VK_NUMPAD0"),		_T("VK_NUMPAD1"),		_T("VK_NUMPAD2"),		_T("VK_NUMPAD3"),		
-	_T("VK_NUMPAD4"),		_T("VK_NUMPAD5"),		_T("VK_NUMPAD6"),		_T("VK_NUMPAD7"),		
-	_T("VK_NUMPAD8"),		_T("VK_NUMPAD9"),		_T("VK_MULTIPLY"),		_T("VK_ADD"),			
-	_T("VK_SEPARATOR"),		_T("VK_SUBTRACT"),		_T("VK_DECIMAL"),		_T("VK_DIVIDE"),		
-	_T("VK_F1"),			_T("VK_F2"),			_T("VK_F3"),			_T("VK_F4"),			
-	_T("VK_F5"),			_T("VK_F6"),			_T("VK_F7"),			_T("VK_F8"),			
-	_T("VK_F9"),			_T("VK_F10"),			_T("VK_F11"),			_T("VK_F12"),			
-	_T("VK_F13"),			_T("VK_F14"),			_T("VK_F15"),			_T("VK_F16"),			
-	_T("VK_F17"),			_T("VK_F18"),			_T("VK_F19"),			_T("VK_F20"),			
-	_T("VK_F21"),			_T("VK_F22"),			_T("VK_F23"),			_T("VK_F24"),			
-	_T("VK_$88"),			_T("VK_$89"),			_T("VK_$8A"),			_T("VK_$8B"),			
-	_T("VK_$8C"),			_T("VK_$8D"),			_T("VK_$8E"),			_T("VK_$8F"),			
-	_T("VK_NUMLOCK"),		_T("VK_SCROLL"),		_T("VK_$92"),			_T("VK_$93"),			
-	_T("VK_$94"),			_T("VK_$95"),			_T("VK_$96"),			_T("VK_$97"),			
-	_T("VK_$98"),			_T("VK_$99"),			_T("VK_$9A"),			_T("VK_$9B"),			
-	_T("VK_$9C"),			_T("VK_$9D"),			_T("VK_$9E"),			_T("VK_$9F"),			
-	_T("VK_LSHIFT"),		_T("VK_RSHIFT"),		_T("VK_LCONTROL"),		_T("VK_RCONTROL"),		
-	_T("VK_LMENU"),			_T("VK_RMENU"),			_T("VK_BROWSER_BACK"),		_T("VK_BROWSER_FORWARD"),	
-	_T("VK_BROWSER_REFRESH"),	_T("VK_BROWSER_STOP"),		_T("VK_BROWSER_SEARCH"),	_T("VK_BROWSER_FAVORITES"),	
-	_T("VK_BROWSER_HOME"),		_T("VK_VOLUME_MUTE"),		_T("VK_VOLUME_DOWN"),		_T("VK_VOLUME_UP"),		
-	_T("VK_MEDIA_NEXT_TRACK"),	_T("VK_MEDIA_PREV_TRACK"),	_T("VK_MEDIA_STOP"),		_T("VK_MEDIA_PLAY_PAUSE"),	
-	_T("VK_LAUNCH_MAIL"),		_T("VK_LAUNCH_MEDIA_SELECT"),	_T("VK_LAUNCH_APP1"),		_T("VK_LAUNCH_APP2"),		
-	_T("VK_$B8"),			_T("VK_$B9"),			_T("VK_OEM_1"),			_T("VK_OEM_PLUS"),		
-	_T("VK_OEM_COMMA"),		_T("VK_OEM_MINUS"),		_T("VK_OEM_PERIOD"),		_T("VK_OEM_2"),			
-	_T("VK_OEM_3"),			_T("VK_$C1"),			_T("VK_$C2"),			_T("VK_$C3"),			
-	_T("VK_$C4"),			_T("VK_$C5"),			_T("VK_$C6"),			_T("VK_$C7"),			
-	_T("VK_$C8"),			_T("VK_$C9"),			_T("VK_$CA"),			_T("VK_$CB"),			
-	_T("VK_$CC"),			_T("VK_$CD"),			_T("VK_$CE"),			_T("VK_$CF"),			
-	_T("VK_$D0"),			_T("VK_$D1"),			_T("VK_$D2"),			_T("VK_$D3"),			
-	_T("VK_$D4"),			_T("VK_$D5"),			_T("VK_$D6"),			_T("VK_$D7"),			
-	_T("VK_$D8"),			_T("VK_$D9"),			_T("VK_$DA"),			_T("VK_OEM_4"),			
-	_T("VK_OEM_5"),			_T("VK_OEM_6"),			_T("VK_OEM_7"),			_T("VK_OEM_8"),			
-	_T("VK_$E0"),			_T("VK_OEM_AX"),		_T("VK_OEM_102"),		_T("VK_ICO_HELP"),		
-	_T("VK_ICO_00"),		_T("VK_PROCESSKEY"),		_T("VK_ICO_CLEAR"),		_T("VK_PACKET"),		
-	_T("VK_$E8"),			_T("VK_OEM_RESET"),		_T("VK_OEM_JUMP"),		_T("VK_OEM_PA1"),		
-	_T("VK_OEM_PA2"),		_T("VK_OEM_PA3"),		_T("VK_OEM_WSCTRL"),		_T("VK_OEM_CUSEL"),		
-	_T("VK_OEM_ATTN"),		_T("VK_OEM_FINISH"),		_T("VK_OEM_COPY"),		_T("VK_OEM_AUTO"),		
-	_T("VK_OEM_ENLW"),		_T("VK_OEM_BACKTAB"),		_T("VK_ATTN"),			_T("VK_CRSEL"),			
-	_T("VK_EXSEL"),			_T("VK_EREOF"),			_T("VK_PLAY"),			_T("VK_ZOOM"),			
-	_T("VK_NONAME"),		_T("VK_PA1"),			_T("VK_OEM_CLEAR"),		_T("VK_$FF"),			
-};
-
-static const _TCHAR *joy_button_names[32] = {
-	_T("Up"),
-	_T("Down"),
-	_T("Left"),
-	_T("Right"),
-	_T("Button #1"),
-	_T("Button #2"),
-	_T("Button #3"),
-	_T("Button #4"),
-	_T("Button #5"),
-	_T("Button #6"),
-	_T("Button #7"),
-	_T("Button #8"),
-	_T("Button #9"),
-	_T("Button #10"),
-	_T("Button #11"),
-	_T("Button #12"),
-	_T("Button #13"),
-	_T("Button #14"),
-	_T("Button #15"),
-	_T("Button #16"),
-	_T("Z-Axis Low"),
-	_T("Z-Axis High"),
-	_T("R-Axis Low"),
-	_T("R-Axis High"),
-	_T("U-Axis Low"),
-	_T("U-Axis High"),
-	_T("V-Axis Low"),
-	_T("V-Axis High"),
-	_T("POV 0deg"),
-	_T("POV 90deg"),
-	_T("POV 180deg"),
-	_T("POV 270deg"),
-};
-
-HWND hJoyDlg;
-HWND hJoyEdit[16];
-WNDPROC JoyOldProc[16];
-int joy_stick_index;
-int joy_button_index;
-int joy_button_params[16];
-uint32_t joy_status[4];
-
-#define get_joy_range(min_value, max_value, lo_value, hi_value) \
-{ \
-	uint64_t center = ((uint64_t)min_value + (uint64_t)max_value) / 2; \
-	lo_value = (DWORD)((center + (uint64_t)min_value) / 2); \
-	hi_value = (DWORD)((center + (uint64_t)max_value) / 2); \
-}
-
-uint32_t get_joy_status(int index)
-{
-	JOYCAPS joycaps;
-	JOYINFOEX joyinfo;
-	uint32_t status = 0;
-	
-	if(joyGetDevCaps(index, &joycaps, sizeof(JOYCAPS)) == JOYERR_NOERROR) {
-		joyinfo.dwSize = sizeof(JOYINFOEX);
-		joyinfo.dwFlags = JOY_RETURNALL;
-		if(joyGetPosEx(index, &joyinfo) == JOYERR_NOERROR) {
-			if(joycaps.wNumAxes >= 2) {
-				DWORD dwYposLo, dwYposHi;
-				get_joy_range(joycaps.wYmin, joycaps.wYmax, dwYposLo, dwYposHi);
-				if(joyinfo.dwYpos < dwYposLo) status |= 0x00000001;	// up
-				if(joyinfo.dwYpos > dwYposHi) status |= 0x00000002;	// down
-			}
-			if(joycaps.wNumAxes >= 1) {
-				DWORD dwXposLo, dwXposHi;
-				get_joy_range(joycaps.wXmin, joycaps.wXmax, dwXposLo, dwXposHi);
-				if(joyinfo.dwXpos < dwXposLo) status |= 0x00000004;	// left
-				if(joyinfo.dwXpos > dwXposHi) status |= 0x00000008;	// right
-			}
-			if(joycaps.wNumAxes >= 3) {
-				DWORD dwZposLo, dwZposHi;
-				get_joy_range(joycaps.wZmin, joycaps.wZmax, dwZposLo, dwZposHi);
-				if(joyinfo.dwZpos < dwZposLo) status |= 0x00100000;
-				if(joyinfo.dwZpos > dwZposHi) status |= 0x00200000;
-			}
-			if(joycaps.wNumAxes >= 4) {
-				DWORD dwRposLo, dwRposHi;
-				get_joy_range(joycaps.wRmin, joycaps.wRmax, dwRposLo, dwRposHi);
-				if(joyinfo.dwRpos < dwRposLo) status |= 0x00400000;
-				if(joyinfo.dwRpos > dwRposHi) status |= 0x00800000;
-			}
-			if(joycaps.wNumAxes >= 5) {
-				DWORD dwUposLo, dwUposHi;
-				get_joy_range(joycaps.wUmin, joycaps.wUmax, dwUposLo, dwUposHi);
-				if(joyinfo.dwUpos < dwUposLo) status |= 0x01000000;
-				if(joyinfo.dwUpos > dwUposHi) status |= 0x02000000;
-			}
-			if(joycaps.wNumAxes >= 6) {
-				DWORD dwVposLo, dwVposHi;
-				get_joy_range(joycaps.wVmin, joycaps.wVmax, dwVposLo, dwVposHi);
-				if(joyinfo.dwVpos < dwVposLo) status |= 0x04000000;
-				if(joyinfo.dwVpos > dwVposHi) status |= 0x08000000;
-			}
-			if(joyinfo.dwPOV != 0xffff) {
-				static const uint32_t dir[8] = {
-					0x10000000 + 0x00000000,
-					0x10000000 + 0x20000000,
-					0x00000000 + 0x20000000,
-					0x40000000 + 0x20000000,
-					0x40000000 + 0x00000000,
-					0x40000000 + 0x80000000,
-					0x00000000 + 0x80000000,
-					0x10000000 + 0x80000000,
-				};
-				for(int i = 0; i < 9; i++) {
-					if(joyinfo.dwPOV < (DWORD)(2250 + 4500 * i)) {
-						status |= dir[i & 7];
-						break;
-					}
-				}
-			}
-			DWORD dwButtonsMask = (1 << min(16, joycaps.wNumButtons)) - 1;
-			status |= ((joyinfo.dwButtons & dwButtonsMask) << 4);
-		}
-	}
-	return status;
-}
-
-void set_joy_button_text(int index)
-{
-	if(joy_button_params[index] < 0) {
-		SetDlgItemText(hJoyDlg, IDC_JOYSTICK_PARAM0 + index, vk_names[-joy_button_params[index]]);
-	} else if(joy_stick_index == -1) {
-			SetDlgItemText(hJoyDlg, IDC_JOYSTICK_PARAM0 + index, _T("(None)"));
-	} else {
-		SetDlgItemText(hJoyDlg, IDC_JOYSTICK_PARAM0 + index, create_string(_T("Joystick #%d - %s"), (joy_button_params[index] >> 5) + 1, joy_button_names[joy_button_params[index] & 0x1f]));
-	}
-}
-
-LRESULT CALLBACK JoySubProc(HWND hWnd, UINT iMsg, WPARAM wParam, LPARAM lParam)
-{
-	int index = -1;
-	for(int i = 0; i < 16; i++) {
-		if(hWnd == hJoyEdit[i]) {
-			index = i;
-			break;
-		}
-	}
-	if(index == -1) {
-		return 0L;
-	}
-	switch(iMsg) {
-	case WM_CHAR:
-		return 0L;
-	case WM_KEYDOWN:
-	case WM_SYSKEYDOWN:
-		if(joy_stick_index == -1 && LOBYTE(wParam) == VK_BACK) {
-			joy_button_params[index] = 0;
-		} else {
-			joy_button_params[index] = -(int)LOBYTE(wParam);
-		}
-		set_joy_button_text(index);
-		if(hJoyEdit[++index] == NULL) {
-			index = 0;
-		}
-		SetFocus(hJoyEdit[index]);
-		return 0L;
-	case WM_SETFOCUS:
-		joy_button_index = index;
-		break;
-	default:
-		break;
-	}
-	return CallWindowProc(JoyOldProc[index], hWnd, iMsg, wParam, lParam);
-}
-
-INT_PTR CALLBACK JoyWndProc(HWND hDlg, UINT iMsg, WPARAM wParam, LPARAM lParam)
-{
-	switch(iMsg) {
-	case WM_CLOSE:
-		EndDialog(hDlg, IDCANCEL);
-		break;
-	case WM_INITDIALOG:
-		hJoyDlg = hDlg;
-		joy_stick_index = (int)(*(LONG*)lParam);
-		SetWindowText(hDlg, create_string(_T("Joystick #%d"), joy_stick_index + 1));
-		for(int i = 0; i < 16; i++) {
-			joy_button_params[i] = config.joy_buttons[joy_stick_index][i];
-			if((hJoyEdit[i] = GetDlgItem(hDlg, IDC_JOYSTICK_PARAM0 + i)) != NULL) {
-#ifdef USE_JOY_BUTTON_CAPTIONS
-				if(i < array_length(joy_button_captions)) {
-					SetDlgItemText(hDlg, IDC_JOYSTICK_CAPTION0 + i, joy_button_captions[i]);
-				} else
-#endif
-				SetDlgItemText(hDlg, IDC_JOYSTICK_CAPTION0 + i, joy_button_names[i]);
-				set_joy_button_text(i);
-#ifdef _M_AMD64
-				// thanks Marukun (64bit)
-				JoyOldProc[i] = (WNDPROC)GetWindowLongPtr(hJoyEdit[i], GWLP_WNDPROC);
-				SetWindowLongPtr(hJoyEdit[i], GWLP_WNDPROC, (LONG_PTR)JoySubProc);
-#else
-				JoyOldProc[i] = (WNDPROC)GetWindowLong(hJoyEdit[i], GWL_WNDPROC);
-				SetWindowLong(hJoyEdit[i], GWL_WNDPROC, (LONG)JoySubProc);
-#endif
-			}
-		}
-		memset(joy_status, 0, sizeof(joy_status));
-		SetTimer(hDlg, 1, 100, NULL);
-		break;
-	case WM_COMMAND:
-		switch(LOWORD(wParam)) {
-		case IDOK:
-			for(int i = 0; i < 16; i++) {
-				config.joy_buttons[joy_stick_index][i] = joy_button_params[i];
-			}
-			EndDialog(hDlg, IDOK);
-			break;
-		case IDC_JOYSTICK_RESET:
-			for(int i = 0; i < 16; i++) {
-				joy_button_params[i] = (joy_stick_index << 5) | i;
-				set_joy_button_text(i);
-			}
-			break;
-		default:
-			return FALSE;
-		}
-		break;
-	case WM_TIMER:
-		for(int i = 0; i < 4; i++) {
-			uint32_t status = get_joy_status(i);
-			for(int j = 0; j < 32; j++) {
-				uint32_t bit = 1 << j;
-				if((joy_status[i] & bit) && !(status & bit)) {
-					joy_button_params[joy_button_index] = (i << 5) | j;
-					set_joy_button_text(joy_button_index);
-					if(hJoyEdit[++joy_button_index] == NULL) {
-						joy_button_index = 0;
-					}
-					SetFocus(hJoyEdit[joy_button_index]);
-					break;
-				}
-			}
-			joy_status[i] = status;
-		}
-		break;
-	default:
-		return (INT_PTR)FALSE;
-	}
-	return (INT_PTR)TRUE;
-}
-
-INT_PTR CALLBACK JoyToKeyWndProc(HWND hDlg, UINT iMsg, WPARAM wParam, LPARAM lParam)
-{
-	switch(iMsg) {
-	case WM_CLOSE:
-		EndDialog(hDlg, IDCANCEL);
-		break;
-	case WM_INITDIALOG:
-		hJoyDlg = hDlg;
-		joy_stick_index = -1;//(int)(*(LONG*)lParam);
-//		SetWindowText(hDlg, create_string(_T("Joystick To Keyboard #%d"), joy_stick_index + 1));
-		SendMessage(GetDlgItem(hDlg, IDC_JOYTOKEY_CHECK0), BM_SETCHECK, (WPARAM)config.use_joy_to_key, 0L);
-		SendMessage(GetDlgItem(hDlg, IDC_JOYTOKEY_RADIO0), BM_SETCHECK, (WPARAM)(config.joy_to_key_type == 0), 0L);
-		SendMessage(GetDlgItem(hDlg, IDC_JOYTOKEY_RADIO1), BM_SETCHECK, (WPARAM)(config.joy_to_key_type == 1), 0L);
-		SendMessage(GetDlgItem(hDlg, IDC_JOYTOKEY_RADIO2), BM_SETCHECK, (WPARAM)(config.joy_to_key_type == 2), 0L);
-		SendMessage(GetDlgItem(hDlg, IDC_JOYTOKEY_CHECK1), BM_SETCHECK, (WPARAM)config.joy_to_key_numpad5, 0L);
-		for(int i = 0; i < 16; i++) {
-			joy_button_params[i] = config.joy_to_key_buttons[i];
-			if((hJoyEdit[i] = GetDlgItem(hDlg, IDC_JOYSTICK_PARAM0 + i)) != NULL) {
-				set_joy_button_text(i);
-#ifdef _M_AMD64
-				// thanks Marukun (64bit)
-				JoyOldProc[i] = (WNDPROC)GetWindowLongPtr(hJoyEdit[i], GWLP_WNDPROC);
-				SetWindowLongPtr(hJoyEdit[i], GWLP_WNDPROC, (LONG_PTR)JoySubProc);
-#else
-				JoyOldProc[i] = (WNDPROC)GetWindowLong(hJoyEdit[i], GWL_WNDPROC);
-				SetWindowLong(hJoyEdit[i], GWL_WNDPROC, (LONG)JoySubProc);
-#endif
-			}
-		}
-		memset(joy_status, 0, sizeof(joy_status));
-		SetTimer(hDlg, 1, 100, NULL);
-		break;
-	case WM_COMMAND:
-		switch(LOWORD(wParam)) {
-		case IDOK:
-			config.use_joy_to_key = (IsDlgButtonChecked(hDlg, IDC_JOYTOKEY_CHECK0) == BST_CHECKED);
-			if(IsDlgButtonChecked(hDlg, IDC_JOYTOKEY_RADIO0) == BST_CHECKED) {
-				config.joy_to_key_type = 0;
-			} else if(IsDlgButtonChecked(hDlg, IDC_JOYTOKEY_RADIO1) == BST_CHECKED) {
-				config.joy_to_key_type = 1;
-			} else {
-				config.joy_to_key_type = 2;
-			}
-			config.joy_to_key_numpad5 = (IsDlgButtonChecked(hDlg, IDC_JOYTOKEY_CHECK1) == BST_CHECKED);
-			for(int i = 0; i < 16; i++) {
-				config.joy_to_key_buttons[i] = joy_button_params[i];
-			}
-			EndDialog(hDlg, IDOK);
-			break;
-		case IDC_JOYSTICK_RESET:
-			SendMessage(GetDlgItem(hDlg, IDC_JOYTOKEY_CHECK0), BM_SETCHECK, (WPARAM)false, 0L);
-			SendMessage(GetDlgItem(hDlg, IDC_JOYTOKEY_RADIO0), BM_SETCHECK, (WPARAM)false, 0L);
-			SendMessage(GetDlgItem(hDlg, IDC_JOYTOKEY_RADIO1), BM_SETCHECK, (WPARAM)false, 0L);
-			SendMessage(GetDlgItem(hDlg, IDC_JOYTOKEY_RADIO2), BM_SETCHECK, (WPARAM)true,  0L);
-			SendMessage(GetDlgItem(hDlg, IDC_JOYTOKEY_CHECK1), BM_SETCHECK, (WPARAM)false, 0L);
-			for(int i = 0; i < 16; i++) {
-				joy_button_params[i] = (i == 0) ? -('Z') : (i == 1) ? -('X') : 0;
-				set_joy_button_text(i);
-			}
-			break;
-		default:
-			return (INT_PTR)FALSE;
-		}
-		break;
-	case WM_TIMER:
-		for(int i = 0; i < 1; i++) {
-			uint32_t status = get_joy_status(i);
-			for(int j = 0; j < 16; j++) {
-				uint32_t bit = 1 << (j + 4);
-				if((joy_status[i] & bit) && !(status & bit)) {
-					if(hJoyEdit[j] != NULL) {
-						joy_button_index = j;
-						SetFocus(hJoyEdit[joy_button_index]);
-					}
-					break;
-				}
-			}
-			joy_status[i] = status;
-		}
-		break;
-	default:
-		return (INT_PTR)FALSE;
-	}
-	return (INT_PTR)TRUE;
-}
-#endif
-
-// ----------------------------------------------------------------------------
-// button
-// ----------------------------------------------------------------------------
-
-#ifdef ONE_BOARD_MICRO_COMPUTER
-#define MAX_FONT_SIZE 32
-HWND hButton[MAX_BUTTONS];
-WNDPROC ButtonOldProc[MAX_BUTTONS];
-
-LRESULT CALLBACK ButtonSubProc(HWND hWnd, UINT iMsg, WPARAM wParam, LPARAM lParam)
-{
-	for(int i = 0; i < MAX_BUTTONS; i++) {
-		if(hWnd == hButton[i]) {
-			switch(iMsg) {
-			case WM_KEYDOWN:
-				if(emu) {
-					bool extended = ((HIWORD(lParam) & 0x100) != 0);
-					bool repeat = ((HIWORD(lParam) & 0x4000) != 0);
-					int code = LOBYTE(wParam);
-					if(code == VK_PROCESSKEY) {
-						code = MapVirtualKey(HIWORD(lParam) & 0xff, 3);
-					}
-					emu->key_down(code, extended, repeat);
-				}
-				break;
-			case WM_SYSKEYDOWN:
-				if(emu) {
-					bool extended = ((HIWORD(lParam) & 0x100) != 0);
-					bool repeat = ((HIWORD(lParam) & 0x4000) != 0);
-					int code = LOBYTE(wParam);
-					if(code == VK_PROCESSKEY) {
-						code = MapVirtualKey(HIWORD(lParam) & 0xff, 3);
-					}
-					emu->key_down(code, extended, repeat);
-				}
-				return 0;	// not activate menu when hit ALT/F10
-			case WM_KEYUP:
-				if(emu) {
-					bool extended = ((HIWORD(lParam) & 0x100) != 0);
-					int code = LOBYTE(wParam);
-					if(code == VK_PROCESSKEY) {
-						code = MapVirtualKey(HIWORD(lParam) & 0xff, 3);
-					}
-					emu->key_up(code, extended);
-				}
-				break;
-			case WM_SYSKEYUP:
-				if(emu) {
-					bool extended = ((HIWORD(lParam) & 0x100) != 0);
-					int code = LOBYTE(wParam);
-					if(code == VK_PROCESSKEY) {
-						code = MapVirtualKey(HIWORD(lParam) & 0xff, 3);
-					}
-					emu->key_up(code, extended);
-				}
-				return 0;	// not activate menu when hit ALT/F10
-			case WM_CHAR:
-				if(emu) {
-					emu->key_char(LOBYTE(wParam));
-				}
-				break;
-			}
-			return CallWindowProc(ButtonOldProc[i], hWnd, iMsg, wParam, lParam);
-		}
-	}
-	return 0;
-}
-
-void create_buttons(HWND hWnd)
-{
-	for(int i = 0; i < MAX_BUTTONS; i++) {
-		hButton[i] = CreateWindow(_T("BUTTON"), NULL/*vm_buttons[i].caption*/,
-		                          WS_CHILD | WS_VISIBLE | BS_PUSHBUTTON | BS_OWNERDRAW/*(_tcsstr(vm_buttons[i].caption, _T("\n")) ? BS_MULTILINE : 0)*/,
-		                          vm_buttons[i].x, vm_buttons[i].y,
-		                          vm_buttons[i].width, vm_buttons[i].height,
-		                          hWnd, (HMENU)(ID_BUTTON + i), (HINSTANCE)GetModuleHandle(0), NULL);
-#ifdef _M_AMD64
-		ButtonOldProc[i] = (WNDPROC)GetWindowLongPtr(hButton[i], GWLP_WNDPROC);
-		SetWindowLongPtr(hButton[i], GWLP_WNDPROC, (LONG_PTR)ButtonSubProc);
-#else
-		ButtonOldProc[i] = (WNDPROC)(LONG_PTR)GetWindowLong(hButton[i], GWL_WNDPROC);
-		SetWindowLong(hButton[i], GWL_WNDPROC, (LONG)(LONG_PTR)ButtonSubProc);
-#endif
-	}
-}
-
-void draw_button(HDC hDC, UINT index, UINT pressed)
-{
-	HINSTANCE hInstance = (HINSTANCE)GetModuleHandle(0);
-	_TCHAR name[24];
-	
-	_stprintf(name, _T("IDI_BITMAP_BUTTON%02d"), index);
-#if 1
-	// load png from resource
-	HRSRC hResource = FindResource(hInstance, name, _T("IMAGE"));
-	if(hResource != NULL) {
-		const void* pResourceData = LockResource(LoadResource(hInstance, hResource));
-		if(pResourceData != NULL) {
-			DWORD dwResourceSize = SizeofResource(hInstance, hResource);
-			HGLOBAL hResourceBuffer = GlobalAlloc(GMEM_MOVEABLE, dwResourceSize);
-			if(hResourceBuffer != NULL) {
-				void* pResourceBuffer = GlobalLock(hResourceBuffer);
-				if(pResourceBuffer != NULL) {
-					CopyMemory(pResourceBuffer, pResourceData, dwResourceSize);
-					IStream* pIStream = NULL;
-					if(CreateStreamOnHGlobal(hResourceBuffer, FALSE, &pIStream) == S_OK) {
-						Gdiplus::Bitmap *pBitmap = Gdiplus::Bitmap::FromStream(pIStream);
-						if(pBitmap != NULL) {
-							Gdiplus::Graphics graphics(hDC);
-							if(pressed) {
-								graphics.DrawImage(pBitmap, 2,  2, pBitmap->GetWidth() - 2, pBitmap->GetHeight() - 2);
-							} else {
-								graphics.DrawImage(pBitmap, 1, 1);
-							}
-							delete pBitmap;
-						}
-					}
-				}
-				GlobalUnlock(hResourceBuffer);
-			}
-			GlobalFree(hResourceBuffer);
-		}
-	}
-#else
-	// load bitmap from resource
-	HDC hmdc = CreateCompatibleDC(hDC);
-	HBITMAP hBitmap = LoadBitmap(hInstance, name);
-	BITMAP bmp;
-	GetObject(hBitmap, sizeof(BITMAP), &bmp);
-	int w = (int)bmp.bmWidth;
-	int h = (int)bmp.bmHeight;
-	HBITMAP hOldBitmap = (HBITMAP)SelectObject(hmdc, hBitmap);
-	if(pressed) {
-		StretchBlt(hDC, 2, 2, w - 2, h - 2, hmdc, 0, 0, w, h, SRCCOPY);
-	} else {
-		BitBlt(hDC, 1, 1, w, h, hmdc, 0, 0, SRCCOPY);
-	}
-	SelectObject(hmdc, hOldBitmap);
-	DeleteObject(hBitmap);
-	DeleteDC(hmdc);
-#endif
-}
-#endif
-
Binary files source/src/zlib-1.2.11/debug/x64/zlibstat.lib and src/zlib-1.2.11/debug/x64/zlibstat.lib differ
Binary files source/src/zlib-1.2.11/debug/zlibstat.lib and src/zlib-1.2.11/debug/zlibstat.lib differ
Binary files source/src/zlib-1.2.11/release/x64/zlibstat.lib and src/zlib-1.2.11/release/x64/zlibstat.lib differ
Binary files source/src/zlib-1.2.11/release/zlibstat.lib and src/zlib-1.2.11/release/zlibstat.lib differ
